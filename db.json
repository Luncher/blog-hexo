{"meta":{"version":1,"warehouse":"2.2.0"},"models":{"Asset":[{"_id":"source/favicon.ico","path":"favicon.ico","modified":1,"renderable":0},{"_id":"themes/jacman/source/css/style.styl","path":"css/style.styl","modified":1,"renderable":1},{"_id":"themes/jacman/source/fancybox/fancybox_loading.gif","path":"fancybox/fancybox_loading.gif","modified":1,"renderable":1},{"_id":"themes/jacman/source/fancybox/blank.gif","path":"fancybox/blank.gif","modified":1,"renderable":1},{"_id":"themes/jacman/source/fancybox/fancybox_loading@2x.gif","path":"fancybox/fancybox_loading@2x.gif","modified":1,"renderable":1},{"_id":"themes/jacman/source/fancybox/fancybox_overlay.png","path":"fancybox/fancybox_overlay.png","modified":1,"renderable":1},{"_id":"themes/jacman/source/fancybox/fancybox_sprite.png","path":"fancybox/fancybox_sprite.png","modified":1,"renderable":1},{"_id":"themes/jacman/source/fancybox/fancybox_sprite@2x.png","path":"fancybox/fancybox_sprite@2x.png","modified":1,"renderable":1},{"_id":"themes/jacman/source/fancybox/jquery.fancybox.css","path":"fancybox/jquery.fancybox.css","modified":1,"renderable":1},{"_id":"themes/jacman/source/fancybox/jquery.fancybox.pack.js","path":"fancybox/jquery.fancybox.pack.js","modified":1,"renderable":1},{"_id":"themes/jacman/source/fancybox/jquery.fancybox.js","path":"fancybox/jquery.fancybox.js","modified":1,"renderable":1},{"_id":"themes/jacman/source/font/coveredbyyourgrace-webfont.eot","path":"font/coveredbyyourgrace-webfont.eot","modified":1,"renderable":1},{"_id":"themes/jacman/source/font/FontAwesome.otf","path":"font/FontAwesome.otf","modified":1,"renderable":1},{"_id":"themes/jacman/source/font/coveredbyyourgrace-webfont.ttf","path":"font/coveredbyyourgrace-webfont.ttf","modified":1,"renderable":1},{"_id":"themes/jacman/source/font/fontawesome-webfont.eot","path":"font/fontawesome-webfont.eot","modified":1,"renderable":1},{"_id":"themes/jacman/source/font/coveredbyyourgrace-webfont.woff","path":"font/coveredbyyourgrace-webfont.woff","modified":1,"renderable":1},{"_id":"themes/jacman/source/font/fontdiao.eot","path":"font/fontdiao.eot","modified":1,"renderable":1},{"_id":"themes/jacman/source/font/fontawesome-webfont.woff","path":"font/fontawesome-webfont.woff","modified":1,"renderable":1},{"_id":"themes/jacman/source/font/fontdiao.woff","path":"font/fontdiao.woff","modified":1,"renderable":1},{"_id":"themes/jacman/source/font/fontdiao.ttf","path":"font/fontdiao.ttf","modified":1,"renderable":1},{"_id":"themes/jacman/source/img/RBAC.png","path":"img/RBAC.png","modified":1,"renderable":1},{"_id":"themes/jacman/source/img/cc-by-nc-nd.svg","path":"img/cc-by-nc-nd.svg","modified":1,"renderable":1},{"_id":"themes/jacman/source/img/cc-by-nc-sa.svg","path":"img/cc-by-nc-sa.svg","modified":1,"renderable":1},{"_id":"themes/jacman/source/img/cc-by-nc.svg","path":"img/cc-by-nc.svg","modified":1,"renderable":1},{"_id":"themes/jacman/source/img/cc-by-sa.svg","path":"img/cc-by-sa.svg","modified":1,"renderable":1},{"_id":"themes/jacman/source/img/cc-by-nd.svg","path":"img/cc-by-nd.svg","modified":1,"renderable":1},{"_id":"themes/jacman/source/img/cc-zero.svg","path":"img/cc-zero.svg","modified":1,"renderable":1},{"_id":"themes/jacman/source/img/cc-by.svg","path":"img/cc-by.svg","modified":1,"renderable":1},{"_id":"themes/jacman/source/img/jacman.jpg","path":"img/jacman.jpg","modified":1,"renderable":1},{"_id":"themes/jacman/source/img/letEncrypt原理图.png","path":"img/letEncrypt原理图.png","modified":1,"renderable":1},{"_id":"themes/jacman/source/img/linux-mouse.png","path":"img/linux-mouse.png","modified":1,"renderable":1},{"_id":"themes/jacman/source/img/logo.svg","path":"img/logo.svg","modified":1,"renderable":1},{"_id":"themes/jacman/source/img/mixed-content-http2.jpg","path":"img/mixed-content-http2.jpg","modified":1,"renderable":1},{"_id":"themes/jacman/source/img/mixed-content-http1.jpg","path":"img/mixed-content-http1.jpg","modified":1,"renderable":1},{"_id":"themes/jacman/source/img/micro-vs-soa.jpeg","path":"img/micro-vs-soa.jpeg","modified":1,"renderable":1},{"_id":"themes/jacman/source/img/scrollup.png","path":"img/scrollup.png","modified":1,"renderable":1},{"_id":"themes/jacman/source/img/server-game.png","path":"img/server-game.png","modified":1,"renderable":1},{"_id":"themes/jacman/source/img/server-game2.png","path":"img/server-game2.png","modified":1,"renderable":1},{"_id":"themes/jacman/source/img/snowflake","path":"img/snowflake","modified":1,"renderable":1},{"_id":"themes/jacman/source/img/server-game3.png","path":"img/server-game3.png","modified":1,"renderable":1},{"_id":"themes/jacman/source/js/gallery.js","path":"js/gallery.js","modified":1,"renderable":1},{"_id":"themes/jacman/source/js/jquery.imagesloaded.min.js","path":"js/jquery.imagesloaded.min.js","modified":1,"renderable":1},{"_id":"themes/jacman/source/js/totop.js","path":"js/totop.js","modified":1,"renderable":1},{"_id":"themes/jacman/source/js/jquery.qrcode-0.12.0.min.js","path":"js/jquery.qrcode-0.12.0.min.js","modified":1,"renderable":1},{"_id":"themes/jacman/source/font/coveredbyyourgrace-webfont.svg","path":"font/coveredbyyourgrace-webfont.svg","modified":1,"renderable":1},{"_id":"themes/jacman/source/img/smzdw.png","path":"img/smzdw.png","modified":1,"renderable":1},{"_id":"themes/jacman/source/font/fontawesome-webfont.ttf","path":"font/fontawesome-webfont.ttf","modified":1,"renderable":1},{"_id":"themes/jacman/source/font/fontdiao.svg","path":"font/fontdiao.svg","modified":1,"renderable":1},{"_id":"themes/jacman/source/img/author.jpg","path":"img/author.jpg","modified":1,"renderable":1},{"_id":"themes/jacman/source/img/logo.png","path":"img/logo.png","modified":1,"renderable":1},{"_id":"themes/jacman/source/img/mixed-content-http8.jpg","path":"img/mixed-content-http8.jpg","modified":1,"renderable":1},{"_id":"themes/jacman/source/fancybox/helpers/fancybox_buttons.png","path":"fancybox/helpers/fancybox_buttons.png","modified":1,"renderable":1},{"_id":"themes/jacman/source/fancybox/helpers/jquery.fancybox-buttons.css","path":"fancybox/helpers/jquery.fancybox-buttons.css","modified":1,"renderable":1},{"_id":"themes/jacman/source/fancybox/helpers/jquery.fancybox-buttons.js","path":"fancybox/helpers/jquery.fancybox-buttons.js","modified":1,"renderable":1},{"_id":"themes/jacman/source/fancybox/helpers/jquery.fancybox-media.js","path":"fancybox/helpers/jquery.fancybox-media.js","modified":1,"renderable":1},{"_id":"themes/jacman/source/fancybox/helpers/jquery.fancybox-thumbs.css","path":"fancybox/helpers/jquery.fancybox-thumbs.css","modified":1,"renderable":1},{"_id":"themes/jacman/source/fancybox/helpers/jquery.fancybox-thumbs.js","path":"fancybox/helpers/jquery.fancybox-thumbs.js","modified":1,"renderable":1},{"_id":"themes/jacman/source/js/jquery-2.0.3.min.js","path":"js/jquery-2.0.3.min.js","modified":1,"renderable":1},{"_id":"themes/jacman/source/img/favicon.ico","path":"img/favicon.ico","modified":1,"renderable":1},{"_id":"themes/jacman/source/img/kong-plugin.jpg","path":"img/kong-plugin.jpg","modified":1,"renderable":1},{"_id":"themes/jacman/source/img/hls.jpg","path":"img/hls.jpg","modified":1,"renderable":1},{"_id":"themes/jacman/source/img/javascript-prop-iter.png","path":"img/javascript-prop-iter.png","modified":1,"renderable":1},{"_id":"themes/jacman/source/font/fontawesome-webfont.svg","path":"font/fontawesome-webfont.svg","modified":1,"renderable":1},{"_id":"themes/jacman/source/img/banner.jpg","path":"img/banner.jpg","modified":1,"renderable":1},{"_id":"themes/jacman/source/img/mixed-content-http4.jpg","path":"img/mixed-content-http4.jpg","modified":1,"renderable":1},{"_id":"themes/jacman/source/img/mixed-content-http5.jpg","path":"img/mixed-content-http5.jpg","modified":1,"renderable":1},{"_id":"themes/jacman/source/img/mixed-content-http7.jpg","path":"img/mixed-content-http7.jpg","modified":1,"renderable":1},{"_id":"themes/jacman/source/img/mixed-content-http6.jpg","path":"img/mixed-content-http6.jpg","modified":1,"renderable":1},{"_id":"themes/jacman/source/img/React-知识图谱.png","path":"img/React-知识图谱.png","modified":1,"renderable":1},{"_id":"themes/jacman/source/img/ES6-part-one.png","path":"img/ES6-part-one.png","modified":1,"renderable":1},{"_id":"themes/jacman/source/img/MobX-知识图谱.png","path":"img/MobX-知识图谱.png","modified":1,"renderable":1},{"_id":"themes/jacman/source/img/mixed-content-http3.jpg","path":"img/mixed-content-http3.jpg","modified":1,"renderable":1},{"_id":"themes/jacman/source/img/ES6-part-two.png","path":"img/ES6-part-two.png","modified":1,"renderable":1},{"_id":"themes/jacman/source/img/http-cheatsheet.png","path":"img/http-cheatsheet.png","modified":1,"renderable":1}],"Cache":[{"_id":"source/__Front-matter.js","hash":"14b45991bbf5866656cecb40a56d9fc434764c28","modified":1530441046491},{"_id":"themes/jacman/.DS_Store","hash":"6b83a943103f12e249a0acc34e1ffe79aced803e","modified":1550409624644},{"_id":"themes/jacman/LICENSE","hash":"931516aa36c53eb7843c83d82662eb50cc3c4367","modified":1531667287206},{"_id":"themes/jacman/.gitignore","hash":"7d65523f2a5afb69d76824dd1dfa62a34faa3197","modified":1531667287206},{"_id":"themes/jacman/README.md","hash":"098545637b0aeb27b14707c15e429470c603d78d","modified":1531667287207},{"_id":"themes/jacman/README_zh.md","hash":"9c73931bca4883de13eedd4be254da547d4ca52e","modified":1531667287207},{"_id":"themes/jacman/_config.yml","hash":"17f9682595a0b3cdbe64d97541cbc498e704971e","modified":1531669298873},{"_id":"source/_posts/Base64.md","hash":"e9f8eb2719454c47ad7d87a458a10a9a16e56156","modified":1530441046491},{"_id":"source/about/index.md","hash":"cb801d0c7a5b7b3c341ce97a97283e512de07843","modified":1530441046500},{"_id":"source/categories/index.md","hash":"c65b647a3de0cc10697d3f1cb2a44b38cf999ef0","modified":1530441046500},{"_id":"source/_posts/Blob.md","hash":"aa6fdbb42d4f32ba3f202896ccedc8cb27253ae3","modified":1530441046491},{"_id":"source/_posts/CSS-background.md","hash":"d292e8b8ba85e125633c2fa8a8adb6ce9ad1d9d8","modified":1530441046491},{"_id":"source/_posts/CSS-动画详解.md","hash":"485409788a46260be0718b2c48fb1582543e92ef","modified":1543144786041},{"_id":"source/_posts/CSSMastery读书笔记一-基础知识.md","hash":"737750f1903a68bfcbcbf562a57fba8313ead4d8","modified":1530441046492},{"_id":"source/_posts/CSSMastery读书笔记三-可视化格式模型.md","hash":"6ec9d2d1bc2c37cb71f1162ae469706d86b01546","modified":1530441046492},{"_id":"source/_posts/CSSMastery读书笔记二为-样式找到应用目标.md","hash":"cf2b4511f74091d61a36befb1f334d85baa30081","modified":1530441046492},{"_id":"source/_posts/ES6 CheatSheet(一).md","hash":"d32851c8604ead02e8225cb5c5c4b2a28560dfaf","modified":1530441046492},{"_id":"source/_posts/ES6 CheatSheet(二).md","hash":"ca1a71ef8cfa9c4f5bfe04f4ffd7ae7d1c8aecc2","modified":1530441046492},{"_id":"source/_posts/HTTP知识图谱.md","hash":"1ae26eb0ed12cb34b1af64acdb30b71e3b8e9be5","modified":1543145255879},{"_id":"source/_posts/LINUX输入设备抽象.md","hash":"74c9e993ec4f247f58a3755b8594a9d4e6a3480c","modified":1542813334226},{"_id":"source/_posts/MobX知识图谱.md","hash":"5fb309de810a08cbbb58624892de8a639f63e062","modified":1550912976132},{"_id":"source/_posts/ES6 属性遍历.md","hash":"31391b6fcd3bbc5cc63b4321bfd87786d00182f5","modified":1540535692365},{"_id":"source/_posts/React知识图谱.md","hash":"354023ee44156555309321b3d2027dc6df739bb4","modified":1551711990906},{"_id":"source/_posts/Linux下SSH操作解析.md","hash":"25f8f45c39e505ab08d868d6f0963a19e8499e72","modified":1542812411699},{"_id":"source/_posts/SVG学习笔记.md","hash":"500a85cdc104b8535efd532963acd3191533d5e8","modified":1530441046492},{"_id":"source/_posts/Sailsjs参数校验.md","hash":"129951eb52938ed9a67f9f448d222bf50fc4a68b","modified":1530441046493},{"_id":"source/_posts/Quill编辑器添加自定义插件.md","hash":"72e2ab1dd312a215b55ecef8ff02841ffd189a8f","modified":1530441046492},{"_id":"source/_posts/Sailsjs项目模板.md","hash":"e3a8bcd59bdebb75e37e4256def18cebadf6172d","modified":1530441046493},{"_id":"source/_posts/ScrollTo动画.md","hash":"7c51cd4ff11fa41fe451853027c364dac8a298b9","modified":1530441046493},{"_id":"source/_posts/TextMate snippet.md","hash":"4eabfc8cf18e750dc1f02a4f1e5351634c154741","modified":1530441046493},{"_id":"source/_posts/MobX-依赖注入.md","hash":"9700d60c5aa3b7471429551c88cb103983f1a4ec","modified":1551010738953},{"_id":"source/_posts/Session-&-Cookie.md","hash":"824420baf5410ef6f59026b097885709aa229658","modified":1530441046493},{"_id":"source/_posts/URL编解码.md","hash":"a486a819cfc1f679432df651a589741073eb3a0f","modified":1530441046494},{"_id":"source/_posts/css视觉格式化1.md","hash":"920c73d24c969624436219af1635ebd99244d1d5","modified":1530441046494},{"_id":"source/_posts/async-tutorial.md","hash":"316517c843e0da26502a07aec0df4f59f8e567bb","modified":1530441046494},{"_id":"source/_posts/create-react-app支持ts和decorator.md","hash":"c871cbd79f6b9210d7c04e1de2df40fd0a6a214e","modified":1550912442317},{"_id":"source/_posts/electron-打包web应用.md","hash":"be3b40258d36ba94d21abe4f86d073131c5cf2d9","modified":1530441046494},{"_id":"source/_posts/Vue数据绑定(一).md","hash":"297cf5dc46a0ee0cf9553c1570925a0a73eac479","modified":1531665859849},{"_id":"source/_posts/flex-box-xmind.md","hash":"71cfb14e6adf59aeb3ad70b79c407563c1cb104c","modified":1530441046495},{"_id":"source/_posts/electron-研究笔记.md","hash":"fae7245b716b9ffee6c1151638d1e5a6bd4cc296","modified":1530441046494},{"_id":"source/_posts/javascript模块管理.md","hash":"5347b095bdf6dd2dae640696aef4268a92a0f92b","modified":1530441046495},{"_id":"source/_posts/mixed-content.md","hash":"082669752a6a611979a528a085b420e75a050ff6","modified":1550410780162},{"_id":"source/_posts/iptables配置.md","hash":"643d43331b6d49bd8b313720da2207890842ec9d","modified":1530441046495},{"_id":"source/_posts/nginx反向代理配置.md","hash":"7c8d5afd0540c37e5a4d1c9d57adfcf266c7e5e9","modified":1541953069604},{"_id":"source/_posts/npm-的工作原理.md","hash":"4c8f35a0f74ea48c1c9958612e85e3cc4b182bb1","modified":1530441046496},{"_id":"source/_posts/position.md","hash":"1b31485e5cfde5191a2d54a4257f1725ff2c17d6","modified":1530441046496},{"_id":"source/_posts/nodejs-Modules-(一).md","hash":"9c7c7d29de16def3d81dc15d2ac62098b29c02a5","modified":1530441046496},{"_id":"source/_posts/refactoring.md","hash":"b41bb0084cbcf2b21df6de23574e8ee22a664eb2","modified":1530441046496},{"_id":"source/_posts/table.md","hash":"658c75714c8c6c5b841415c61dddf25ba06e194d","modified":1530441046496},{"_id":"source/_posts/vscode开发环境配置.md","hash":"7e91176a41334aebc4ddb213bf7e6f10a38a9cf9","modified":1544879804982},{"_id":"source/_posts/vscode编辑器进阶.md","hash":"350cd5822109c16ffc8f8af89b138f9d74c3d0f5","modified":1544879772503},{"_id":"source/_posts/从这个劫持页面我学到了什么.md","hash":"32671cc625f2709c30e82d0be8426e5464931f88","modified":1530441046497},{"_id":"source/_posts/一款在线秒杀游戏的设计.md","hash":"fa41af91ddd085d576712c43c88bd535572cb6e9","modified":1541070380438},{"_id":"source/_posts/你不知道的box-shadow.md","hash":"ad3cdf19debfd7b93dddc0b2004c2d8ca4e48707","modified":1530441046497},{"_id":"source/_posts/你不知道的Javascript上卷-阅读笔记.md","hash":"f7c3166fd0a1e51dca49c75cf298d278bf7846a9","modified":1530441046497},{"_id":"source/_posts/修复npm安装全局模块权限问题.md","hash":"d62ab23b92993e72d3daddef006945571545d450","modified":1530441046498},{"_id":"source/_posts/关于express下session的几个注意事项.md","hash":"a0ad526e423d75a93018da534f1b548c8f05fd56","modified":1530441046498},{"_id":"source/_posts/使用passport管理第三方授权认证.md","hash":"07d2f076157009083908cee3b3acc9556475c100","modified":1530441046498},{"_id":"source/_posts/分布式ID生成.md","hash":"0236613666e36c781ef35102f5946f1d704c8e0b","modified":1540536697129},{"_id":"source/_posts/利用prometheus监控Kong网关.md","hash":"6e165b7337729e7de27a1e2b9a3a01f8817b60c4","modified":1530441046498},{"_id":"source/_posts/压力测试.md","hash":"e0ca973b4666bcb4dfa651ebd7b288152542ef81","modified":1540368745344},{"_id":"source/_posts/块级元素于行内元素.md","hash":"14de6bbcc4e40a480f6314ff258d4a3674970b81","modified":1530441046498},{"_id":"source/_posts/基于Vuejs和Sailsjs的SSR实践.md","hash":"b5771ea9cdf50c40e4a9d2a82dfac8f9e79d128f","modified":1530441046498},{"_id":"source/_posts/如何学习.md","hash":"2e58afb08626afd66cac6d45924979834cb63101","modified":1539848669849},{"_id":"source/_posts/如何设计一个数据字典.md","hash":"1f68f75e33f9261abd19dbd85c3030d5d39abd5b","modified":1530441046499},{"_id":"source/_posts/微服务系统架构.md","hash":"36353b9f5cb2b9e6172086edb395e9969ee64c26","modified":1530441046499},{"_id":"source/_posts/数字货币-什么值得挖.md","hash":"b1c1c39801e89e73821e1c9c8fe208b8f3e1b852","modified":1541655540249},{"_id":"source/_posts/数据库设计.md","hash":"a2b741f2ae6256711c2c435b6ce7075abdc00b32","modified":1539945123859},{"_id":"source/_posts/浅析C语言数据内存布局.md","hash":"8ac9f677005f23075cf6c302950340a5147d0725","modified":1542813835023},{"_id":"source/_posts/浅析重载覆盖隐藏以及虚函数.md","hash":"476d7695b89c85216a798038c51ef6240273e4f3","modified":1542813315824},{"_id":"source/_posts/用户系统密码安全.md","hash":"7366af982d4bb38c4874ddf1b3cb8ab850cba69c","modified":1530441046499},{"_id":"source/_posts/译-视觉格式化模型的细节.md","hash":"85f6db8c334377f4cac95279da3b408715ca39b5","modified":1530441046499},{"_id":"source/_posts/资源下发服务.md","hash":"e27397da386b759a730a12b0c1d37b9fae3c1ee5","modified":1530441046500},{"_id":"source/_posts/通用日志模块设计.md","hash":"65fc9058b8f34dab62f3c5961001a6f51f13b694","modified":1542812707402},{"_id":"source/tags/index.md","hash":"99694da0d5a58ff84c32ae390eebd0b2062d6d9f","modified":1530441046501},{"_id":"themes/jacman/languages/zh-CN.yml","hash":"1f3b9d00dd4322352b0c9c82a76dc9865a616d41","modified":1531667287208},{"_id":"themes/jacman/languages/zh-TW.yml","hash":"61a02ba818d641579a86fcd7f5926ab1e6ab5f70","modified":1531667287208},{"_id":"themes/jacman/layout/archive.ejs","hash":"a18842e3d719fe3ca9b977a6995f8facc75c8673","modified":1531667287215},{"_id":"themes/jacman/layout/category.ejs","hash":"9b740fc33f6f028df60f0bc4312bf3ebd03aa8ea","modified":1531667287215},{"_id":"themes/jacman/languages/default.yml","hash":"eea72d6138497287c0b3f4bd93e4f6f62b7aff37","modified":1531667287207},{"_id":"themes/jacman/layout/index.ejs","hash":"75cef2172c286994af412e11ab7f4f5a0daaf1f5","modified":1531667287215},{"_id":"themes/jacman/layout/layout.ejs","hash":"5b4289a4526899809b9c2facea535367ff51ba2b","modified":1531667287215},{"_id":"themes/jacman/layout/page.ejs","hash":"bd6bbf2ea8e183bd835867ff617dc6366b56748c","modified":1531667287215},{"_id":"themes/jacman/layout/post.ejs","hash":"3114134775bdde5a83cf14feb019606fa2b2b2be","modified":1531667287216},{"_id":"themes/jacman/layout/tag.ejs","hash":"45150a2365768b6b67880193c9264ad2bb4814db","modified":1531667287216},{"_id":"themes/jacman/scripts/fancybox.js","hash":"aa411cd072399df1ddc8e2181a3204678a5177d9","modified":1531667287216},{"_id":"themes/jacman/source/.DS_Store","hash":"f9a6e223d76be591ae8622dd2d0efb663ad130a6","modified":1550410021030},{"_id":"source/_posts/nginx服务器完整配置.md","hash":"5a19cf9e2c6e50de4d24975cbaa1ea106bf00763","modified":1542624744745},{"_id":"source/_posts/jaeger.md","hash":"bd9fa52aefbc9e276a86c68906c3dd9b43c1de16","modified":1530441046495},{"_id":"source/favicon.ico","hash":"785e9066e2b823124818b2b0c14c73790c908de0","modified":1530441046501},{"_id":"themes/jacman/layout/_partial/archive.ejs","hash":"2c7395e7563fe016521712a645c28a13f952d52a","modified":1531667287208},{"_id":"themes/jacman/layout/_partial/after_footer.ejs","hash":"3e1f1d8dc38b1e17c523d1176f7ee503fc648045","modified":1531667287208},{"_id":"themes/jacman/layout/_partial/analytics.ejs","hash":"697601996220fe0a0f9cd628be67dec3c86ae2aa","modified":1531667287208},{"_id":"themes/jacman/layout/_partial/categories.ejs","hash":"8a52d0344d5bce1925cf586ed73c11192925209b","modified":1531667287209},{"_id":"themes/jacman/layout/_partial/footer.ejs","hash":"5f80bf6c6ddcf8c28c4599cd1540b14b25d54f18","modified":1531667287209},{"_id":"themes/jacman/layout/_partial/article.ejs","hash":"261ecacb8456f4cb972632b6a9103860fa63b9a3","modified":1531667287208},{"_id":"themes/jacman/layout/_partial/article_row.ejs","hash":"4cb855d91ece7f67b2ca0992fffa55472d0b9c93","modified":1531667287209},{"_id":"themes/jacman/layout/_partial/header.ejs","hash":"18515612344ff048b9372b91b7eef6f3b143801f","modified":1531667287209},{"_id":"themes/jacman/layout/_partial/head.ejs","hash":"761941be4922cd3c177c8130296b909bf7db5c09","modified":1531667287209},{"_id":"themes/jacman/layout/_partial/pagination.ejs","hash":"6146ac37dfb4f8613090bc52b3fc8cfa911a186a","modified":1531667287210},{"_id":"themes/jacman/layout/_partial/mathjax.ejs","hash":"d42994ac696f52ba99c1cbac382cd76d5b04a3e8","modified":1531667287209},{"_id":"themes/jacman/layout/_partial/search.ejs","hash":"1083824a6c6c3df02767f2f3b727aee78ebb76ec","modified":1531667287212},{"_id":"themes/jacman/layout/_partial/sidebar.ejs","hash":"c4f527fff0070fbe65919053a16224412317f40d","modified":1531667287212},{"_id":"themes/jacman/layout/_partial/tinysou_search.ejs","hash":"06ecddc8a9d40b480fe2e958af1dab857a9d5441","modified":1531667287212},{"_id":"themes/jacman/layout/_widget/archive.ejs","hash":"39ea6b7888406fbd1b4cf236ebd718e881493374","modified":1531667287213},{"_id":"themes/jacman/layout/_partial/tags.ejs","hash":"b33b2b5d08f1d53a8de25a95f660f7f1cea7b3cb","modified":1531667287212},{"_id":"themes/jacman/layout/_partial/totop.ejs","hash":"bea5bb7cb9350b8af7d97a8d223af63a5b30ab78","modified":1531667287212},{"_id":"themes/jacman/layout/_widget/category.ejs","hash":"c1fae96b5053da021bcc04ab2ce5c2c8d30de8a2","modified":1531667287213},{"_id":"themes/jacman/layout/_widget/douban.ejs","hash":"e3820c36169e88663e6c9177666b2904c1ce47e6","modified":1531667287213},{"_id":"themes/jacman/layout/_widget/github-card.ejs","hash":"d49a8d609c5fbafa9e7ad328163565af03306519","modified":1531672311258},{"_id":"themes/jacman/layout/_widget/links.ejs","hash":"e49868063439c2092cdf9a8ec82cc295b0e42f66","modified":1531667287214},{"_id":"themes/jacman/layout/_widget/rss.ejs","hash":"0a4b5f2a2e36a1d504fe2e7c6c8372cbb4628aab","modified":1531667287214},{"_id":"themes/jacman/layout/_widget/tagcloud.ejs","hash":"10a1001189d5c28ce6d42494563b9637c302b454","modified":1531667287214},{"_id":"themes/jacman/layout/_widget/tag.ejs","hash":"7e82ad9c916b9ce871b2f65ce8f283c5ba47947b","modified":1531667287214},{"_id":"themes/jacman/layout/_widget/weibo.ejs","hash":"a31c2b223d0feb2a227e203cac9e5d13b7d328a8","modified":1531667287214},{"_id":"themes/jacman/source/css/style.styl","hash":"a0a45af186a72ae68979bf26f2a5d0d2303189ca","modified":1531667287220},{"_id":"themes/jacman/source/fancybox/fancybox_loading.gif","hash":"1a755fb2599f3a313cc6cfdb14df043f8c14a99c","modified":1531667287221},{"_id":"themes/jacman/source/fancybox/blank.gif","hash":"2daeaa8b5f19f0bc209d976c02bd6acb51b00b0a","modified":1531667287220},{"_id":"themes/jacman/source/fancybox/fancybox_loading@2x.gif","hash":"273b123496a42ba45c3416adb027cd99745058b0","modified":1531667287221},{"_id":"themes/jacman/source/fancybox/fancybox_overlay.png","hash":"b3a4ee645ba494f52840ef8412015ba0f465dbe0","modified":1531667287221},{"_id":"themes/jacman/source/fancybox/fancybox_sprite.png","hash":"17df19f97628e77be09c352bf27425faea248251","modified":1531667287221},{"_id":"themes/jacman/source/fancybox/fancybox_sprite@2x.png","hash":"30c58913f327e28f466a00f4c1ac8001b560aed8","modified":1531667287222},{"_id":"themes/jacman/source/fancybox/jquery.fancybox.css","hash":"aaa582fb9eb4b7092dc69fcb2d5b1c20cca58ab6","modified":1531667287223},{"_id":"themes/jacman/source/fancybox/jquery.fancybox.pack.js","hash":"9e0d51ca1dbe66f6c0c7aefd552dc8122e694a6e","modified":1531667287224},{"_id":"themes/jacman/source/fancybox/jquery.fancybox.js","hash":"d08b03a42d5c4ba456ef8ba33116fdbb7a9cabed","modified":1531667287224},{"_id":"themes/jacman/source/font/coveredbyyourgrace-webfont.eot","hash":"a17d0f10534303e40f210c506ebb8703fa23b7de","modified":1531667287225},{"_id":"themes/jacman/source/font/FontAwesome.otf","hash":"b5b4f9be85f91f10799e87a083da1d050f842734","modified":1531667287225},{"_id":"themes/jacman/source/font/coveredbyyourgrace-webfont.ttf","hash":"194ccb4acf77a03dc25bcc174edb266143704fec","modified":1531667287227},{"_id":"themes/jacman/source/font/fontawesome-webfont.eot","hash":"7619748fe34c64fb157a57f6d4ef3678f63a8f5e","modified":1531667287228},{"_id":"themes/jacman/source/font/coveredbyyourgrace-webfont.woff","hash":"c6f8dc1a2f6ce914f120e80a876b8fd77b98888e","modified":1531667287227},{"_id":"themes/jacman/source/font/fontdiao.eot","hash":"9544a0d7ba208989302bc4da5a184faeb0e883c9","modified":1531667287231},{"_id":"themes/jacman/source/font/fontawesome-webfont.woff","hash":"04c3bf56d87a0828935bd6b4aee859995f321693","modified":1531667287231},{"_id":"themes/jacman/source/font/fontdiao.woff","hash":"71f54eb6e98aa28cafeb04aab71c0e5b349ea89f","modified":1531667287234},{"_id":"themes/jacman/source/font/fontdiao.ttf","hash":"ee9fd7be2493c9bf6d2841044e69a0830d9d3fab","modified":1531667287233},{"_id":"themes/jacman/source/img/RBAC.png","hash":"381fc121c8286ec3ec490f4da37d3b42c052fb44","modified":1531668045133},{"_id":"themes/jacman/source/img/cc-by-nc-nd.svg","hash":"c6524ece3f8039a5f612feaf865d21ec8a794564","modified":1531668045134},{"_id":"themes/jacman/source/img/cc-by-nc-sa.svg","hash":"3031be41e8753c70508aa88e84ed8f4f653f157e","modified":1531668045134},{"_id":"themes/jacman/source/img/cc-by-nc.svg","hash":"8d39b39d88f8501c0d27f8df9aae47136ebc59b7","modified":1531668045135},{"_id":"themes/jacman/source/img/cc-by-sa.svg","hash":"aa4742d733c8af8d38d4c183b8adbdcab045872e","modified":1531668045135},{"_id":"themes/jacman/source/img/cc-by-nd.svg","hash":"c563508ce9ced1e66948024ba1153400ac0e0621","modified":1531668045135},{"_id":"themes/jacman/source/img/cc-zero.svg","hash":"87669bf8ac268a91d027a0a4802c92a1473e9030","modified":1531668045136},{"_id":"themes/jacman/source/img/cc-by.svg","hash":"28a0a4fe355a974a5e42f68031652b76798d4f7e","modified":1531668045136},{"_id":"themes/jacman/source/img/jacman.jpg","hash":"0ba14a4a5e3be012826fc713c33479912126d34e","modified":1531668045137},{"_id":"themes/jacman/source/img/letEncrypt原理图.png","hash":"6c6542ef7e04023cf2fa210225c965943b9c1603","modified":1542622792025},{"_id":"themes/jacman/source/img/linux-mouse.png","hash":"6af045ee92dfa937983a049665ef56af7906acf1","modified":1542813211863},{"_id":"themes/jacman/source/img/logo.svg","hash":"9ae38f7225c38624faeb7b74996efa9de7bf065b","modified":1531668045140},{"_id":"themes/jacman/source/img/mixed-content-http2.jpg","hash":"d01a34206309f982ea2bc431c21e85a37e2f2836","modified":1550410131800},{"_id":"themes/jacman/source/img/mixed-content-http1.jpg","hash":"230abdb74aaaf94137ed95a2ddfe0f9ce0a92018","modified":1550410122986},{"_id":"themes/jacman/source/img/micro-vs-soa.jpeg","hash":"7c4a21bc6f68223300f95fc0f0f9a4611207c024","modified":1531668045140},{"_id":"themes/jacman/source/img/scrollup.png","hash":"2137d4f1739aa8aa3fcb0348c3ddf1e41d62f2e3","modified":1531668045141},{"_id":"themes/jacman/source/img/server-game.png","hash":"1e856437990c6383c5cc0dafb513986972bed227","modified":1541069217829},{"_id":"themes/jacman/source/img/server-game2.png","hash":"1603a3bde0b789fe6c447e008ad411558d5547c4","modified":1541069676545},{"_id":"themes/jacman/source/img/snowflake","hash":"43b8fa244227b1ec2144a5244042dded492728ff","modified":1540535597506},{"_id":"themes/jacman/source/img/server-game3.png","hash":"886f59888784d73273338584ab8dfd858ab900c3","modified":1541069887240},{"_id":"themes/jacman/source/js/gallery.js","hash":"f8a4ba7fb8349cca374a3c69fff9b2bf21f742ed","modified":1531667287239},{"_id":"themes/jacman/source/js/jquery.imagesloaded.min.js","hash":"4109837b1f6477bacc6b095a863b1b95b1b3693f","modified":1531667287240},{"_id":"themes/jacman/source/js/totop.js","hash":"cad23c5ea7163d1e5c05a0fd3ef9233469da10cb","modified":1531667287241},{"_id":"themes/jacman/source/js/jquery.qrcode-0.12.0.min.js","hash":"57c3987166a26415a71292162690e82c21e315ad","modified":1531667287241},{"_id":"themes/jacman/source/font/coveredbyyourgrace-webfont.svg","hash":"eabdb262d8e246865dfb56031f01ff6e8d2f9d53","modified":1531667287226},{"_id":"themes/jacman/source/img/smzdw.png","hash":"0098fddad39067a9b9af0531c4454ceb8ed57655","modified":1541649041092},{"_id":"themes/jacman/source/font/fontawesome-webfont.ttf","hash":"7f09c97f333917034ad08fa7295e916c9f72fd3f","modified":1531667287231},{"_id":"themes/jacman/source/font/fontdiao.svg","hash":"334a94e6a66a8b089be7315d876bec93efe38d2b","modified":1531667287233},{"_id":"themes/jacman/source/img/author.jpg","hash":"30c9c9d462bbed8206c865298e6ed8d411cde7b4","modified":1531668045133},{"_id":"themes/jacman/source/img/logo.png","hash":"30c9c9d462bbed8206c865298e6ed8d411cde7b4","modified":1531668045139},{"_id":"themes/jacman/source/img/mixed-content-http8.jpg","hash":"4ded09aa30f7ed6b32312057a79d0a5f2e45379c","modified":1550410156701},{"_id":"themes/jacman/layout/_partial/post/article.ejs","hash":"b09e3acea7076e1f01dfe0c2295e19951ea09437","modified":1531667287210},{"_id":"themes/jacman/layout/_partial/post/catetags.ejs","hash":"0e37bababc8f4659f5b59a552a946b46d89e4158","modified":1531667287210},{"_id":"themes/jacman/layout/_partial/post/comment.ejs","hash":"548c69c570d5aac567bc6f088e9ee0c02223b088","modified":1531667287210},{"_id":"themes/jacman/layout/_partial/post/footer.ejs","hash":"b12ec08a5845a3d8c01257614f1dfead879c87d2","modified":1531667287211},{"_id":"themes/jacman/layout/_partial/post/gallery.ejs","hash":"fafc2501d7e65983b0f5c2b58151ca12e57c0574","modified":1531667287211},{"_id":"themes/jacman/layout/_partial/post/header.ejs","hash":"36a705942b691abe0d643ea8afa339981b32f6f2","modified":1531667287211},{"_id":"themes/jacman/layout/_partial/post/jiathis.ejs","hash":"d7f5960039ac74924559ab6ba03c64457b8f0966","modified":1531667287211},{"_id":"themes/jacman/layout/_partial/post/pagination.ejs","hash":"7de9c07a4c968429a8088c31a28b7f3a993ded1b","modified":1531667287211},{"_id":"themes/jacman/source/css/_base/font.styl","hash":"c8a0faf43b08e37ad07a5669db76d595da966159","modified":1531667287217},{"_id":"themes/jacman/source/css/_base/public.styl","hash":"f016180726019927b9a835ed01e04d153f27a149","modified":1531667287217},{"_id":"themes/jacman/source/css/_base/variable.styl","hash":"cb652eb83c28a208743fabab92de896f8b7cbf7b","modified":1531667287218},{"_id":"themes/jacman/source/css/_partial/article.styl","hash":"c69641b4a34a8c62986b335414413dbde26de25e","modified":1531667287218},{"_id":"themes/jacman/source/css/_partial/aside.styl","hash":"506fde1d67ce750452cbe84bee01a19c7d027c5e","modified":1531667287218},{"_id":"themes/jacman/source/css/_partial/duoshuo.styl","hash":"e85f1192283f043115c272a9deb3cb6ced793990","modified":1531667287219},{"_id":"themes/jacman/source/css/_partial/footer.styl","hash":"1911613a19b605a58f801c21b03b5d4c83b90f9c","modified":1531667287219},{"_id":"themes/jacman/source/css/_partial/gallery.styl","hash":"7246809f4ce3166ec1b259bf475cae1a48e29aad","modified":1531667287219},{"_id":"themes/jacman/source/css/_partial/header.styl","hash":"5121ceb712be3f2dde98b8b6e589b546e19eab8f","modified":1531667287219},{"_id":"themes/jacman/source/css/_partial/helper.styl","hash":"1136600932b97534b88465bf05ef313630b2de3d","modified":1531667287219},{"_id":"themes/jacman/source/css/_partial/index.styl","hash":"a72ff14effd276015264f870f47ed8f8413bf5d3","modified":1531667287220},{"_id":"themes/jacman/source/css/_partial/totop.styl","hash":"96363d7c5aaed5f649667fc0752a62620a67e872","modified":1531667287220},{"_id":"themes/jacman/source/fancybox/helpers/fancybox_buttons.png","hash":"e385b139516c6813dcd64b8fc431c364ceafe5f3","modified":1531667287222},{"_id":"themes/jacman/source/fancybox/helpers/jquery.fancybox-buttons.css","hash":"1a9d8e5c22b371fcc69d4dbbb823d9c39f04c0c8","modified":1531667287222},{"_id":"themes/jacman/source/fancybox/helpers/jquery.fancybox-buttons.js","hash":"dc3645529a4bf72983a39fa34c1eb9146e082019","modified":1531667287222},{"_id":"themes/jacman/source/fancybox/helpers/jquery.fancybox-media.js","hash":"294420f9ff20f4e3584d212b0c262a00a96ecdb3","modified":1531667287222},{"_id":"themes/jacman/source/fancybox/helpers/jquery.fancybox-thumbs.css","hash":"4ac329c16a5277592fc12a37cca3d72ca4ec292f","modified":1531667287222},{"_id":"themes/jacman/source/fancybox/helpers/jquery.fancybox-thumbs.js","hash":"47da1ae5401c24b5c17cc18e2730780f5c1a7a0c","modified":1531667287223},{"_id":"themes/jacman/source/js/jquery-2.0.3.min.js","hash":"a0ae3697b0ab8c0e8bd3186c80db42abd6d97a8d","modified":1531667287240},{"_id":"themes/jacman/source/img/favicon.ico","hash":"785e9066e2b823124818b2b0c14c73790c908de0","modified":1531668045137},{"_id":"themes/jacman/source/img/kong-plugin.jpg","hash":"2ec6f350e38c733c191472547936c850f76d1382","modified":1531668045138},{"_id":"themes/jacman/source/img/hls.jpg","hash":"cee3ec58c183cef24e7396c30ff7af994d743bb9","modified":1550409237878},{"_id":"themes/jacman/source/img/javascript-prop-iter.png","hash":"0a0f95ad6c25ebe60c080f272f741dd17e34fd36","modified":1531668045137},{"_id":"themes/jacman/source/font/fontawesome-webfont.svg","hash":"46fcc0194d75a0ddac0a038aee41b23456784814","modified":1531667287229},{"_id":"themes/jacman/source/img/banner.jpg","hash":"5104860c4f8b2e84ef734ba6c37fe7a288bf0d74","modified":1531668045134},{"_id":"themes/jacman/source/img/mixed-content-http4.jpg","hash":"003e9ada7a74a0319bed00f4d9b34c7e973e28cd","modified":1550410138498},{"_id":"themes/jacman/source/img/mixed-content-http5.jpg","hash":"eb31d8806e7eb50edf0b6ef58ad0a6b801ad37be","modified":1550410142218},{"_id":"themes/jacman/source/img/mixed-content-http7.jpg","hash":"658c8754bbbe3d0cef78abd01af89ae4032745b6","modified":1550410151714},{"_id":"themes/jacman/source/css/_base/highlight/highlight.styl","hash":"91b62bfc58390b0d5db782a75be6965ee3665eb3","modified":1531667287217},{"_id":"themes/jacman/source/css/_base/highlight/theme.styl","hash":"e3a59bd427ba37a54ead9eeba9a5356b3f720a48","modified":1531667287217},{"_id":"themes/jacman/source/img/mixed-content-http6.jpg","hash":"0a7385d9d55182f52cbcc2caf0e361f04ade7242","modified":1550410148642},{"_id":"themes/jacman/source/img/React-知识图谱.png","hash":"979f986d9ef1620c04342b4a31fb55ed7c07dd1b","modified":1551711953097},{"_id":"themes/jacman/source/img/ES6-part-one.png","hash":"6e4662138ed95140c757b5dbabe8b6f91002e169","modified":1531668045130},{"_id":"themes/jacman/source/img/MobX-知识图谱.png","hash":"ebf03248a160a1ebe67159e41711d1cfe1a78c95","modified":1550912840478},{"_id":"themes/jacman/source/img/mixed-content-http3.jpg","hash":"d993f6c9f8ebffa040ff2387595c2a2e9ef04e99","modified":1550410135030},{"_id":"themes/jacman/source/img/ES6-part-two.png","hash":"950abf69908455b5c41c5cb2926bf44898af8f36","modified":1531668045132},{"_id":"themes/jacman/source/img/http-cheatsheet.png","hash":"3ed3fa6081fa5b751fc828db42c115df47123721","modified":1543144722819}],"Category":[{"name":"web","_id":"cjsuh9ccm0004y4zvmvaq323a"},{"name":"javascript","_id":"cjsuh9cd0000my4zv4wng83m6"},{"name":"server","_id":"cjsuh9cd50011y4zv0zonx4vr"},{"name":"vscode","_id":"cjsuh9cde001ry4zvoliq6j0w"},{"name":"Vue源码分析系列文章","_id":"cjsuh9cdn002gy4zvjhxo1h1j"},{"name":"软件开发","_id":"cjsuh9cdx0039y4zvmdvuo7kz"},{"name":"数据库","_id":"cjsuh9ce90047y4zvp76qp1hq"},{"name":"系统监控","_id":"cjsuh9ced004fy4zvzgl4ncje"},{"name":"lerning","_id":"cjsuh9cef004oy4zvhzt79ddi"}],"Data":[],"Page":[{"title":"about","date":"2016-06-29T10:18:17.000Z","_content":"\n## `Golang`  `Rust`  `Nodejs`  `GUI`\n","source":"about/index.md","raw":"---\ntitle: about\ndate: 2016-06-29 18:18:17\n---\n\n## `Golang`  `Rust`  `Nodejs`  `GUI`\n","updated":"2018-07-01T10:30:46.500Z","path":"about/index.html","comments":1,"layout":"page","_id":"cjsuh9ccj0001y4zv7oh6zq4f","content":"<h2 id=\"Golang-Rust-Nodejs-GUI\"><a href=\"#Golang-Rust-Nodejs-GUI\" class=\"headerlink\" title=\"Golang  Rust  Nodejs  GUI\"></a><code>Golang</code>  <code>Rust</code>  <code>Nodejs</code>  <code>GUI</code></h2>","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Golang-Rust-Nodejs-GUI\"><a href=\"#Golang-Rust-Nodejs-GUI\" class=\"headerlink\" title=\"Golang  Rust  Nodejs  GUI\"></a><code>Golang</code>  <code>Rust</code>  <code>Nodejs</code>  <code>GUI</code></h2>"},{"title":"categories","date":"2016-06-29T10:16:36.000Z","type":"categories","_content":"","source":"categories/index.md","raw":"---\ntitle: categories\ndate: 2016-06-29 18:16:36\ntype: \"categories\"\n---\n","updated":"2018-07-01T10:30:46.500Z","path":"categories/index.html","comments":1,"layout":"page","_id":"cjsuh9ccl0003y4zvz8aaeq13","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"tags","date":"2016-06-29T10:14:27.000Z","type":"tags","_content":"","source":"tags/index.md","raw":"---\ntitle: tags\ndate: 2016-06-29 18:14:27\ntype: \"tags\"\n---\n","updated":"2018-07-01T10:30:46.501Z","path":"tags/index.html","comments":1,"layout":"page","_id":"cjsuh9cco0006y4zv2z2pnaag","content":"","site":{"data":{}},"excerpt":"","more":""}],"Post":[{"title":"Base64","date":"2016-03-07T11:37:24.000Z","_content":"&nbsp;&nbsp;&nbsp;&nbsp;说到Base64相信大家都不陌生，在`web`开发过程中经常可以见到它的身影。Base64是一种编码方式，常用于表示、传输、与存储二进制数据。用64个可打印字符来表示二进制数据，从而解决一些二进制数据无法使用的场景。`Base64`最初主要用户多用途互联网邮件扩展(`MIME Email`), `MIME`规定了用于表示各式各样数据(非英文符号数据)的符号化方法，而`Base64`编码就作为内容传输编码方式之一(`charset`)。`http`协议就是采用了`MIME`的框架。\n\n&nbsp;&nbsp;&nbsp;&nbsp;由于`2^6=64`所以最经济的方式就是把`6bit`作为一个编码单元，对应一个可打印字符来完成编码工作。来看看`Base64`编码表：\n\n![Base64编码表](http://www.tangide.com/storage/read.php?path=qq/A/A84CE7A6466CC40FAC339261A8361B91/2015-12-19%2016:12:20%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE.png)\n\n`Base64`编码规则：\n\n> Base64编码的时候将三个byte的数据先后放入一个24bit的缓冲区中，先来的byte占高位。然后，每次取出6个bit参照编码码表得出编码。如果被编码字符的长度不能被3整除，那么就在编码输出的末尾补上`=`号。比如说，如果待编码的字符长度是4个字节，那么编码输出会有两个等号。如果待编码字符的长度是8个字节那么编码输出末尾会补上一个等号。如果待编码的比特位不足一个编码单元(`6bit`)的时候，则需要在低位补全。当最后剩余一个八位字节（一个byte）时，最后一个6位的base64字节块有四位是0值。\n\n说到这里你可能已经想到编码后的数据比原始数据略长，为原来的4/3。下面来看看`Base64`编码的应用。\n\n###Canvas\n\n&nbsp;&nbsp;&nbsp;&nbsp;`canvas`有一个toDataURL接口用于把当前的`canvas`转换为`data url`数据格式的图片。\n> canvas.toDataURL(type, encoderOptions);\n\n+ `type`属性设置转换的图片格式，默认为`image/png`。\n+ `encoderOptions`为一个数字范围从`0-1`，用于设置图片的质量。\n\n`dataURL`格式定义：\n>data:[mediatype][;base64],<data>\n\n+ mediatype 为一个`MIME`格式定义的字符串，如`image/jpeg`表示jpeg图片。\n+ base64字段表示后面的数据编码方式。\n\n举个例子：\n```javascript\n<script type=\"text/javascript\">\nwindow.onload = function() {\n\tvar canvas = document.getElementById('main-canvas');\n\tvar context = canvas.getContext('2d');\n\tcontext.fillRect(0, 0, canvas.width, canvas.height);\n\tvar dataURL = canvas.toDataURL();\n\tconsole.log(dataURL);\n}\n</script>\n```\n\n将会得到如下输出:\n``` javascript\ndata:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAeAAAALQCAYAAABIRqOlAAAc9UlEQ…AAgUBAgAN0kwQIECBAQID9AAECBAgQCAQEOEA3SYAAAQIELrSX0B9Umz4MAAAAAElFTkSuQmCC\n```\n\n此外，`linux/mac`系统有一个命令行工具: `uuencode`可以把文件转换成`Base64`格式输出, 先把当前的`canvas`另存为一个图片，然后运行命令行程序可以得到如下结论，与toDataURL结果一致：\n\n```\n[luncher@localhost ~]$ uuencode -m 123.png 123-base \nbegin-base64 640 123-base\niVBORw0KGgoAAAANSUhEUgAAAeAAAALQCAYAAABIRqOlAAAc9UlEQVR4Xu3V\nwQkAMAzEsGT/oVvoEPVHWeBABLwzc8YRIECAAAECXwVWgL96GyNAgAABAk9A\ngD0CAQIECBAIBAQ4QDdJgAABAgQE2A8QIECAAIFAQIADdJMECBAgQECA/QAB\nAgQIEAgEBDhAN0mAAAECBATYDxAgQIAAgUBAgAN0kwQIECBAQID9AAECBAgQ\nCAQEOEA3SYAAAQIEBNgPECBAgACBQECAA3STBAgQIEBAgP0AAQIECBAIBAQ4\nQDdJgAABAgQE2A8QIECAAIFAQIADdJMECBAgQECA/QABAgQIEAgEBDhAN0mA\n\n```\n\n\n\n","source":"_posts/Base64.md","raw":"---\ntitle: Base64\ncategories: web\ndate: 2016-03-07 19:37:24\n---\n&nbsp;&nbsp;&nbsp;&nbsp;说到Base64相信大家都不陌生，在`web`开发过程中经常可以见到它的身影。Base64是一种编码方式，常用于表示、传输、与存储二进制数据。用64个可打印字符来表示二进制数据，从而解决一些二进制数据无法使用的场景。`Base64`最初主要用户多用途互联网邮件扩展(`MIME Email`), `MIME`规定了用于表示各式各样数据(非英文符号数据)的符号化方法，而`Base64`编码就作为内容传输编码方式之一(`charset`)。`http`协议就是采用了`MIME`的框架。\n\n&nbsp;&nbsp;&nbsp;&nbsp;由于`2^6=64`所以最经济的方式就是把`6bit`作为一个编码单元，对应一个可打印字符来完成编码工作。来看看`Base64`编码表：\n\n![Base64编码表](http://www.tangide.com/storage/read.php?path=qq/A/A84CE7A6466CC40FAC339261A8361B91/2015-12-19%2016:12:20%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE.png)\n\n`Base64`编码规则：\n\n> Base64编码的时候将三个byte的数据先后放入一个24bit的缓冲区中，先来的byte占高位。然后，每次取出6个bit参照编码码表得出编码。如果被编码字符的长度不能被3整除，那么就在编码输出的末尾补上`=`号。比如说，如果待编码的字符长度是4个字节，那么编码输出会有两个等号。如果待编码字符的长度是8个字节那么编码输出末尾会补上一个等号。如果待编码的比特位不足一个编码单元(`6bit`)的时候，则需要在低位补全。当最后剩余一个八位字节（一个byte）时，最后一个6位的base64字节块有四位是0值。\n\n说到这里你可能已经想到编码后的数据比原始数据略长，为原来的4/3。下面来看看`Base64`编码的应用。\n\n###Canvas\n\n&nbsp;&nbsp;&nbsp;&nbsp;`canvas`有一个toDataURL接口用于把当前的`canvas`转换为`data url`数据格式的图片。\n> canvas.toDataURL(type, encoderOptions);\n\n+ `type`属性设置转换的图片格式，默认为`image/png`。\n+ `encoderOptions`为一个数字范围从`0-1`，用于设置图片的质量。\n\n`dataURL`格式定义：\n>data:[mediatype][;base64],<data>\n\n+ mediatype 为一个`MIME`格式定义的字符串，如`image/jpeg`表示jpeg图片。\n+ base64字段表示后面的数据编码方式。\n\n举个例子：\n```javascript\n<script type=\"text/javascript\">\nwindow.onload = function() {\n\tvar canvas = document.getElementById('main-canvas');\n\tvar context = canvas.getContext('2d');\n\tcontext.fillRect(0, 0, canvas.width, canvas.height);\n\tvar dataURL = canvas.toDataURL();\n\tconsole.log(dataURL);\n}\n</script>\n```\n\n将会得到如下输出:\n``` javascript\ndata:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAeAAAALQCAYAAABIRqOlAAAc9UlEQ…AAgUBAgAN0kwQIECBAQID9AAECBAgQCAQEOEA3SYAAAQIELrSX0B9Umz4MAAAAAElFTkSuQmCC\n```\n\n此外，`linux/mac`系统有一个命令行工具: `uuencode`可以把文件转换成`Base64`格式输出, 先把当前的`canvas`另存为一个图片，然后运行命令行程序可以得到如下结论，与toDataURL结果一致：\n\n```\n[luncher@localhost ~]$ uuencode -m 123.png 123-base \nbegin-base64 640 123-base\niVBORw0KGgoAAAANSUhEUgAAAeAAAALQCAYAAABIRqOlAAAc9UlEQVR4Xu3V\nwQkAMAzEsGT/oVvoEPVHWeBABLwzc8YRIECAAAECXwVWgL96GyNAgAABAk9A\ngD0CAQIECBAIBAQ4QDdJgAABAgQE2A8QIECAAIFAQIADdJMECBAgQECA/QAB\nAgQIEAgEBDhAN0mAAAECBATYDxAgQIAAgUBAgAN0kwQIECBAQID9AAECBAgQ\nCAQEOEA3SYAAAQIEBNgPECBAgACBQECAA3STBAgQIEBAgP0AAQIECBAIBAQ4\nQDdJgAABAgQE2A8QIECAAIFAQIADdJMECBAgQECA/QABAgQIEAgEBDhAN0mA\n\n```\n\n\n\n","slug":"Base64","published":1,"updated":"2018-07-01T10:30:46.491Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9ccg0000y4zvfyhtiihp","content":"<p>&nbsp;&nbsp;&nbsp;&nbsp;说到Base64相信大家都不陌生，在<code>web</code>开发过程中经常可以见到它的身影。Base64是一种编码方式，常用于表示、传输、与存储二进制数据。用64个可打印字符来表示二进制数据，从而解决一些二进制数据无法使用的场景。<code>Base64</code>最初主要用户多用途互联网邮件扩展(<code>MIME Email</code>), <code>MIME</code>规定了用于表示各式各样数据(非英文符号数据)的符号化方法，而<code>Base64</code>编码就作为内容传输编码方式之一(<code>charset</code>)。<code>http</code>协议就是采用了<code>MIME</code>的框架。</p>\n<p>&nbsp;&nbsp;&nbsp;&nbsp;由于<code>2^6=64</code>所以最经济的方式就是把<code>6bit</code>作为一个编码单元，对应一个可打印字符来完成编码工作。来看看<code>Base64</code>编码表：</p>\n<p><img src=\"http://www.tangide.com/storage/read.php?path=qq/A/A84CE7A6466CC40FAC339261A8361B91/2015-12-19%2016:12:20%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE.png\" alt=\"Base64编码表\"></p>\n<p><code>Base64</code>编码规则：</p>\n<blockquote>\n<p>Base64编码的时候将三个byte的数据先后放入一个24bit的缓冲区中，先来的byte占高位。然后，每次取出6个bit参照编码码表得出编码。如果被编码字符的长度不能被3整除，那么就在编码输出的末尾补上<code>=</code>号。比如说，如果待编码的字符长度是4个字节，那么编码输出会有两个等号。如果待编码字符的长度是8个字节那么编码输出末尾会补上一个等号。如果待编码的比特位不足一个编码单元(<code>6bit</code>)的时候，则需要在低位补全。当最后剩余一个八位字节（一个byte）时，最后一个6位的base64字节块有四位是0值。</p>\n</blockquote>\n<p>说到这里你可能已经想到编码后的数据比原始数据略长，为原来的4/3。下面来看看<code>Base64</code>编码的应用。</p>\n<p>###Canvas</p>\n<p>&nbsp;&nbsp;&nbsp;&nbsp;<code>canvas</code>有一个toDataURL接口用于把当前的<code>canvas</code>转换为<code>data url</code>数据格式的图片。</p>\n<blockquote>\n<p>canvas.toDataURL(type, encoderOptions);</p>\n</blockquote>\n<ul>\n<li><code>type</code>属性设置转换的图片格式，默认为<code>image/png</code>。</li>\n<li><code>encoderOptions</code>为一个数字范围从<code>0-1</code>，用于设置图片的质量。</li>\n</ul>\n<p><code>dataURL</code>格式定义：</p>\n<blockquote>\n<p>data:[mediatype][;base64],<data></data></p>\n</blockquote>\n<ul>\n<li>mediatype 为一个<code>MIME</code>格式定义的字符串，如<code>image/jpeg</code>表示jpeg图片。</li>\n<li>base64字段表示后面的数据编码方式。</li>\n</ul>\n<p>举个例子：<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script type=<span class=\"string\">\"text/javascript\"</span>&gt;</span><br><span class=\"line\"><span class=\"built_in\">window</span>.onload = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> canvas = <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">'main-canvas'</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> context = canvas.getContext(<span class=\"string\">'2d'</span>);</span><br><span class=\"line\">\tcontext.fillRect(<span class=\"number\">0</span>, <span class=\"number\">0</span>, canvas.width, canvas.height);</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> dataURL = canvas.toDataURL();</span><br><span class=\"line\">\t<span class=\"built_in\">console</span>.log(dataURL);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&lt;<span class=\"regexp\">/script&gt;</span></span><br></pre></td></tr></table></figure></p>\n<p>将会得到如下输出:<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAeAAAALQCAYAAABIRqOlAAAc9UlEQ…AAgUBAgAN0kwQIECBAQID9AAECBAgQCAQEOEA3SYAAAQIELrSX0B9Umz4MAAAAAElFTkSuQmCC</span><br></pre></td></tr></table></figure></p>\n<p>此外，<code>linux/mac</code>系统有一个命令行工具: <code>uuencode</code>可以把文件转换成<code>Base64</code>格式输出, 先把当前的<code>canvas</code>另存为一个图片，然后运行命令行程序可以得到如下结论，与toDataURL结果一致：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[luncher@localhost ~]$ uuencode -m 123.png 123-base </span><br><span class=\"line\">begin-base64 640 123-base</span><br><span class=\"line\">iVBORw0KGgoAAAANSUhEUgAAAeAAAALQCAYAAABIRqOlAAAc9UlEQVR4Xu3V</span><br><span class=\"line\">wQkAMAzEsGT/oVvoEPVHWeBABLwzc8YRIECAAAECXwVWgL96GyNAgAABAk9A</span><br><span class=\"line\">gD0CAQIECBAIBAQ4QDdJgAABAgQE2A8QIECAAIFAQIADdJMECBAgQECA/QAB</span><br><span class=\"line\">AgQIEAgEBDhAN0mAAAECBATYDxAgQIAAgUBAgAN0kwQIECBAQID9AAECBAgQ</span><br><span class=\"line\">CAQEOEA3SYAAAQIEBNgPECBAgACBQECAA3STBAgQIEBAgP0AAQIECBAIBAQ4</span><br><span class=\"line\">QDdJgAABAgQE2A8QIECAAIFAQIADdJMECBAgQECA/QABAgQIEAgEBDhAN0mA</span><br></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"","more":"<p>&nbsp;&nbsp;&nbsp;&nbsp;说到Base64相信大家都不陌生，在<code>web</code>开发过程中经常可以见到它的身影。Base64是一种编码方式，常用于表示、传输、与存储二进制数据。用64个可打印字符来表示二进制数据，从而解决一些二进制数据无法使用的场景。<code>Base64</code>最初主要用户多用途互联网邮件扩展(<code>MIME Email</code>), <code>MIME</code>规定了用于表示各式各样数据(非英文符号数据)的符号化方法，而<code>Base64</code>编码就作为内容传输编码方式之一(<code>charset</code>)。<code>http</code>协议就是采用了<code>MIME</code>的框架。</p>\n<p>&nbsp;&nbsp;&nbsp;&nbsp;由于<code>2^6=64</code>所以最经济的方式就是把<code>6bit</code>作为一个编码单元，对应一个可打印字符来完成编码工作。来看看<code>Base64</code>编码表：</p>\n<p><img src=\"http://www.tangide.com/storage/read.php?path=qq/A/A84CE7A6466CC40FAC339261A8361B91/2015-12-19%2016:12:20%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE.png\" alt=\"Base64编码表\"></p>\n<p><code>Base64</code>编码规则：</p>\n<blockquote>\n<p>Base64编码的时候将三个byte的数据先后放入一个24bit的缓冲区中，先来的byte占高位。然后，每次取出6个bit参照编码码表得出编码。如果被编码字符的长度不能被3整除，那么就在编码输出的末尾补上<code>=</code>号。比如说，如果待编码的字符长度是4个字节，那么编码输出会有两个等号。如果待编码字符的长度是8个字节那么编码输出末尾会补上一个等号。如果待编码的比特位不足一个编码单元(<code>6bit</code>)的时候，则需要在低位补全。当最后剩余一个八位字节（一个byte）时，最后一个6位的base64字节块有四位是0值。</p>\n</blockquote>\n<p>说到这里你可能已经想到编码后的数据比原始数据略长，为原来的4/3。下面来看看<code>Base64</code>编码的应用。</p>\n<p>###Canvas</p>\n<p>&nbsp;&nbsp;&nbsp;&nbsp;<code>canvas</code>有一个toDataURL接口用于把当前的<code>canvas</code>转换为<code>data url</code>数据格式的图片。</p>\n<blockquote>\n<p>canvas.toDataURL(type, encoderOptions);</p>\n</blockquote>\n<ul>\n<li><code>type</code>属性设置转换的图片格式，默认为<code>image/png</code>。</li>\n<li><code>encoderOptions</code>为一个数字范围从<code>0-1</code>，用于设置图片的质量。</li>\n</ul>\n<p><code>dataURL</code>格式定义：</p>\n<blockquote>\n<p>data:[mediatype][;base64],<data></data></p>\n</blockquote>\n<ul>\n<li>mediatype 为一个<code>MIME</code>格式定义的字符串，如<code>image/jpeg</code>表示jpeg图片。</li>\n<li>base64字段表示后面的数据编码方式。</li>\n</ul>\n<p>举个例子：<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script type=<span class=\"string\">\"text/javascript\"</span>&gt;</span><br><span class=\"line\"><span class=\"built_in\">window</span>.onload = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> canvas = <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">'main-canvas'</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> context = canvas.getContext(<span class=\"string\">'2d'</span>);</span><br><span class=\"line\">\tcontext.fillRect(<span class=\"number\">0</span>, <span class=\"number\">0</span>, canvas.width, canvas.height);</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> dataURL = canvas.toDataURL();</span><br><span class=\"line\">\t<span class=\"built_in\">console</span>.log(dataURL);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&lt;<span class=\"regexp\">/script&gt;</span></span><br></pre></td></tr></table></figure></p>\n<p>将会得到如下输出:<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAeAAAALQCAYAAABIRqOlAAAc9UlEQ…AAgUBAgAN0kwQIECBAQID9AAECBAgQCAQEOEA3SYAAAQIELrSX0B9Umz4MAAAAAElFTkSuQmCC</span><br></pre></td></tr></table></figure></p>\n<p>此外，<code>linux/mac</code>系统有一个命令行工具: <code>uuencode</code>可以把文件转换成<code>Base64</code>格式输出, 先把当前的<code>canvas</code>另存为一个图片，然后运行命令行程序可以得到如下结论，与toDataURL结果一致：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[luncher@localhost ~]$ uuencode -m 123.png 123-base </span><br><span class=\"line\">begin-base64 640 123-base</span><br><span class=\"line\">iVBORw0KGgoAAAANSUhEUgAAAeAAAALQCAYAAABIRqOlAAAc9UlEQVR4Xu3V</span><br><span class=\"line\">wQkAMAzEsGT/oVvoEPVHWeBABLwzc8YRIECAAAECXwVWgL96GyNAgAABAk9A</span><br><span class=\"line\">gD0CAQIECBAIBAQ4QDdJgAABAgQE2A8QIECAAIFAQIADdJMECBAgQECA/QAB</span><br><span class=\"line\">AgQIEAgEBDhAN0mAAAECBATYDxAgQIAAgUBAgAN0kwQIECBAQID9AAECBAgQ</span><br><span class=\"line\">CAQEOEA3SYAAAQIEBNgPECBAgACBQECAA3STBAgQIEBAgP0AAQIECBAIBAQ4</span><br><span class=\"line\">QDdJgAABAgQE2A8QIECAAIFAQIADdJMECBAgQECA/QABAgQIEAgEBDhAN0mA</span><br></pre></td></tr></table></figure>\n"},{"title":"Blob","date":"2016-10-02T02:30:03.000Z","_content":"&nbsp;&nbsp;&nbsp;&nbsp;`Blob`(Binary Large Object)术语最初来自数据库，早期数据库因为要存储声音、图片、以及可执行程序等二进制数据对象所以给该类对象取名为`Blob`。\n&nbsp;&nbsp;&nbsp;&nbsp;在`Web`领域，`Blob`被定义为包含只读数据的类文件对象。`Blob`中的数据不一定是`js`原生数据形式。常见的`File`接口就继承自`Blob`，并扩展它用于支持用户系统的本地文件。\n\n&nbsp;&nbsp;&nbsp;&nbsp;构建一个`Blob`对象通常有三种方式：1、通过`Blob`对象的构造函数来构建。2、从已有的`Blob`对象调用`slice`接口切出一个新的`Blob`对象。3、`canvas` API toBlob方法，把当前绘制信息转为一个`Blob`对象。下面分别看看3种方式的实现：\n\n--\n构造函数：\nvar blob = new Blob(array[optional], options[optional]);\n>\narray(可选): 一个数组。数组元素可以是：`ArrayBuffer`、`ArrayBufferView`、`Blob`、`DOMString`.或者他们的组合。\noptions(可选): 一个对象。用于指定`Blob`对象的属性，可选的参数有：\n+ type: Content-Type,用于指定将要放入`Blob`中的数据的类型(`MIME`)。\n\n<br>\n`Blob`对象的基本属性：\n>\nsize : `Blob`对象包含的字节数。(只读)<br>\ntype : `Blob`对象包含的数据类型`MIME`，如果类型未知则返回空字符串。\n\n<br>\n`Blob`对象的基本方法：\n`Blob.slice([start, [end, [content-type]]])`\n>\n`slice`方法与数组的`slice`类似。\n\n--\n\n**原生对象构建`Blob`**\n\n```javascript\n\n<script type=\"text/javascript\">\nwindow.onload = function() {\n    var blob = new Blob(1234);\n}\n</script>\n\n```\n**提示出错：**\n>Uncaught TypeError: Failed to construct 'Blob': The 1st argument is neither an array, nor does it have indexed properties.\n\n原因在于`Blob`构造函数要求第一个参数必须是数组，而这里第一个参数既不是一个数组，也没有可索引的属性。既然这里提到了对象的可索引属性，让我联想到了类数组的概念，而`Arguments`就是一个很好的例子。来试一试：\n``` javascript\n<script type=\"text/javascript\">\nfunction testArgumentsBlob() {\n    var blob = new Blob(arguments);\n    console.log(blob.size);//3\n    console.log(blob.type);//\"\"\n}\nwindow.onload = function() {\n    testArgumentsBlob(1, 2, 3);\n}\n</script>\n\n```\n可以看到即使是类数组对象，而数组元素类型是`Number`也能得出正确的结论，猜想大概是由于构造函数内部把`Number`转化为`String`的缘故吧！\n\n再来试一试其他的参数类型：\n```javascript\nwindow.onload = function() {\n  var arg = {hello: \"2016\"};\n  var blob = new Blob([JSON.stringify(arg, null, \"\\t\")], {type: \"application/json\"});\n  console.log(blob.type);//application/json\n  console.log(blob.size);//20\n}\n```\nblob.type等于application/json没问题。`arg`转为字符串后的长度为16加上制表符`\\t`的宽度4个字节等于20。\n\n--\n\n**用`slice`切出一个`Blob`对象**\n``` javascript\nwindow.onload = function() {\n    var arg = {hello: \"2016\"};\n    var str = JSON.stringify(arg, null, \"\\t\");\n    var blob = new Blob([str], {type: \"application/json\"});\n    var blob2 = blob.slice();\n            \n    console.log(blob2.size);//20\n    console.log(blob2.type);//\"\"\n}\n```\n可以看到，原始的`Blob`对象的`type`属性并不能传递给新的`Blob`对象，所以还是要自己指定。\n\n``` javascript\nwindow.onload = function() {\n    var arg = {hello: \"2016\"};\n    var str = JSON.stringify(arg, null, \"\\t\");\n    var blob = new Blob([str], {type: \"application/json\"});\n    var blob2 = blob.slice(0, blob.size, \"application/json\");\n    console.log(blob2.size);//20\n    console.log(blob2.type);//application/json\n}\n```\n--\n\n**`canvas` toBlob接口**\n\n函数原型：\n>void canvas.toBlob(callback, type, encoderOptions);\n\n+ callback: 一个回调函数，新建的`blob`对象是唯一的参数`\n+ type: 图片格式，默认为`image/png`，默认`dpi`: 96\n+ encoderOptions: 0~1之间的数值。当`type`为image/jpeg 或 image/webp的时候，用于指定图片质量\n\n来个`DEMO`:\n```javascript\nwindow.onload = function() {\n    var canvas = document.getElementById(\"main\");\n    canvas.toBlob(function(blob) {\n        var img = document.createElement(\"img\");         \n        var url = URL.createObjectURL(blob);\n        img.onload = function() {\n            URL.revokeObjectURL(url);\n        }\n        img.src = url;\n        document.body.appendChild(img);\n    });\n}\n</script>\n```\n得出错误：\n>Uncaught TypeError: canvas.toBlob is not a function.\n\n一开始觉得自己写错了，`Google`了下才发现`Chrome`居然不支持这个接口。给个`polyfill`[Canvas toBlob](https://github.com/X-Builder/JavaScript-Canvas-to-Blob/blob/master/js/canvas-to-blob.js)。\n\n--\n\n**Blob基本运用**\n\n知道了`Blob`对象的基本属性，以及构建的方法，来看几个具体的运用。\n\n--\n\n**利用`Blob`显示对象`**\n```javascript\n\nvar blob = new Blob([1, 2, 3]);\nvar src = URL.createObjectURL(blob);\nconsole.log(src);//blob:http%3A//localhost%3A8003/a47ea163-c253-471a-9d9e-877fe345b60f\nvar img = document.createElement('img');\nimg.onload = function() {\n    URL.invokeObjectURL(img.src);\n}\nimg.src = src;\ndocument.body.appendChild(img);\n\n```\n\n由于`blob`对象不是一个有效的文件，所以不能正常显示图片。上面的`demo`提到了一个`URL.createObjectURL`接口，顺便来学习以下：\n>objectURL = URL.createObjectURL(blob);\n\n主要用于根据一个`Blob`对象(或者`File`,因为`File`继承自`Blob`)，创建一个`URL`用于表示该对象。需要注意的是即使对同一个对象调用两次也会得到不同的`URL`。如果该`URL`不用了需要调用`URL.invokeObjectURL`来进行释放。浏览器会在当前`document unloaded`的时候自动把该`URL`释放。`URL`格式：\n> blob:http%3A//localhost%3A8003/a47ea163-c253-471a-9d9e-877fe345b60f\n\n\n最后来看一个正常点的`DEMO`，利用`URL.createObjectURL`读取本地图片文件，并创建缩略图。\n\n--\n\n**利用`Blob`显示缩略图`**\n\n``` javascript\n var input = document.createElement(\"input\");\n input.type = \"file\";\n input.accept = \"image/*\";\n input.multiple = true;\n input.style.display = \"none\";\n document.body.appendChild(input);\n\n var fileSelect = document.createElement(\"a\");\n fileSelect.href = \"#\";\n fileSelect.appendChild(document.createTextNode(\"Choose files\"));\n document.body.appendChild(fileSelect);\n\n var imgList = document.createElement(\"div\");\n imgList.innerHTML = \"<p>No file Selected!</p>\"\n document.body.appendChild(imgList);\n\n input.addEventListener(\"change\", function(e) {\n var files = this.files;\n if(!files.length) {\n    return;\n }\n imgList.innerHTML = \"\";\n var list = document.createElement(\"ul\");\n imgList.appendChild(list);\n for(var i = 0; i < files.length; i++) {\n     var li = document.createElement(\"li\"); \n     list.appendChild(li);\n\n     var img = document.createElement(\"img\");\n     img.src = window.URL.createObjectURL(files[i]);\n     img.height = 60;\n     img.width  = 60;\n     img.onload = function() {\n         window.URL.revokeObjectURL(this.src);\n     }\n     li.appendChild(img);\n     var info = document.createElement(\"span\");\n     info.innerHTML = files[i].name + \":\" + files[i].size + \" bytes\";\n     li.appendChild(info);\n  }\n}, false);\n\nfileSelect.addEventListener(\"click\", function(e) {\n  input.click();     \n       e.preventDefault();\n}, false);\n\n```\n\n由于`File`对象继承自`Blob`,所以我们可以很方便的利用`File`对象加载本地系统图片文件，并通过`createObjectURL`生成一个`URL`并加以显示。\n\n参考文献：\n+  [Blob](https://developer.mozilla.org/en-US/docs/Web/API/Blob)\n+  [Using_files_from_web](https://developer.mozilla.org/en-US/docs/Using_files_from_web_applications)\n\n","source":"_posts/Blob.md","raw":"---\ntitle: Blob\ncategories: web\ndate: 2016-10-02 10:30:03\n---\n&nbsp;&nbsp;&nbsp;&nbsp;`Blob`(Binary Large Object)术语最初来自数据库，早期数据库因为要存储声音、图片、以及可执行程序等二进制数据对象所以给该类对象取名为`Blob`。\n&nbsp;&nbsp;&nbsp;&nbsp;在`Web`领域，`Blob`被定义为包含只读数据的类文件对象。`Blob`中的数据不一定是`js`原生数据形式。常见的`File`接口就继承自`Blob`，并扩展它用于支持用户系统的本地文件。\n\n&nbsp;&nbsp;&nbsp;&nbsp;构建一个`Blob`对象通常有三种方式：1、通过`Blob`对象的构造函数来构建。2、从已有的`Blob`对象调用`slice`接口切出一个新的`Blob`对象。3、`canvas` API toBlob方法，把当前绘制信息转为一个`Blob`对象。下面分别看看3种方式的实现：\n\n--\n构造函数：\nvar blob = new Blob(array[optional], options[optional]);\n>\narray(可选): 一个数组。数组元素可以是：`ArrayBuffer`、`ArrayBufferView`、`Blob`、`DOMString`.或者他们的组合。\noptions(可选): 一个对象。用于指定`Blob`对象的属性，可选的参数有：\n+ type: Content-Type,用于指定将要放入`Blob`中的数据的类型(`MIME`)。\n\n<br>\n`Blob`对象的基本属性：\n>\nsize : `Blob`对象包含的字节数。(只读)<br>\ntype : `Blob`对象包含的数据类型`MIME`，如果类型未知则返回空字符串。\n\n<br>\n`Blob`对象的基本方法：\n`Blob.slice([start, [end, [content-type]]])`\n>\n`slice`方法与数组的`slice`类似。\n\n--\n\n**原生对象构建`Blob`**\n\n```javascript\n\n<script type=\"text/javascript\">\nwindow.onload = function() {\n    var blob = new Blob(1234);\n}\n</script>\n\n```\n**提示出错：**\n>Uncaught TypeError: Failed to construct 'Blob': The 1st argument is neither an array, nor does it have indexed properties.\n\n原因在于`Blob`构造函数要求第一个参数必须是数组，而这里第一个参数既不是一个数组，也没有可索引的属性。既然这里提到了对象的可索引属性，让我联想到了类数组的概念，而`Arguments`就是一个很好的例子。来试一试：\n``` javascript\n<script type=\"text/javascript\">\nfunction testArgumentsBlob() {\n    var blob = new Blob(arguments);\n    console.log(blob.size);//3\n    console.log(blob.type);//\"\"\n}\nwindow.onload = function() {\n    testArgumentsBlob(1, 2, 3);\n}\n</script>\n\n```\n可以看到即使是类数组对象，而数组元素类型是`Number`也能得出正确的结论，猜想大概是由于构造函数内部把`Number`转化为`String`的缘故吧！\n\n再来试一试其他的参数类型：\n```javascript\nwindow.onload = function() {\n  var arg = {hello: \"2016\"};\n  var blob = new Blob([JSON.stringify(arg, null, \"\\t\")], {type: \"application/json\"});\n  console.log(blob.type);//application/json\n  console.log(blob.size);//20\n}\n```\nblob.type等于application/json没问题。`arg`转为字符串后的长度为16加上制表符`\\t`的宽度4个字节等于20。\n\n--\n\n**用`slice`切出一个`Blob`对象**\n``` javascript\nwindow.onload = function() {\n    var arg = {hello: \"2016\"};\n    var str = JSON.stringify(arg, null, \"\\t\");\n    var blob = new Blob([str], {type: \"application/json\"});\n    var blob2 = blob.slice();\n            \n    console.log(blob2.size);//20\n    console.log(blob2.type);//\"\"\n}\n```\n可以看到，原始的`Blob`对象的`type`属性并不能传递给新的`Blob`对象，所以还是要自己指定。\n\n``` javascript\nwindow.onload = function() {\n    var arg = {hello: \"2016\"};\n    var str = JSON.stringify(arg, null, \"\\t\");\n    var blob = new Blob([str], {type: \"application/json\"});\n    var blob2 = blob.slice(0, blob.size, \"application/json\");\n    console.log(blob2.size);//20\n    console.log(blob2.type);//application/json\n}\n```\n--\n\n**`canvas` toBlob接口**\n\n函数原型：\n>void canvas.toBlob(callback, type, encoderOptions);\n\n+ callback: 一个回调函数，新建的`blob`对象是唯一的参数`\n+ type: 图片格式，默认为`image/png`，默认`dpi`: 96\n+ encoderOptions: 0~1之间的数值。当`type`为image/jpeg 或 image/webp的时候，用于指定图片质量\n\n来个`DEMO`:\n```javascript\nwindow.onload = function() {\n    var canvas = document.getElementById(\"main\");\n    canvas.toBlob(function(blob) {\n        var img = document.createElement(\"img\");         \n        var url = URL.createObjectURL(blob);\n        img.onload = function() {\n            URL.revokeObjectURL(url);\n        }\n        img.src = url;\n        document.body.appendChild(img);\n    });\n}\n</script>\n```\n得出错误：\n>Uncaught TypeError: canvas.toBlob is not a function.\n\n一开始觉得自己写错了，`Google`了下才发现`Chrome`居然不支持这个接口。给个`polyfill`[Canvas toBlob](https://github.com/X-Builder/JavaScript-Canvas-to-Blob/blob/master/js/canvas-to-blob.js)。\n\n--\n\n**Blob基本运用**\n\n知道了`Blob`对象的基本属性，以及构建的方法，来看几个具体的运用。\n\n--\n\n**利用`Blob`显示对象`**\n```javascript\n\nvar blob = new Blob([1, 2, 3]);\nvar src = URL.createObjectURL(blob);\nconsole.log(src);//blob:http%3A//localhost%3A8003/a47ea163-c253-471a-9d9e-877fe345b60f\nvar img = document.createElement('img');\nimg.onload = function() {\n    URL.invokeObjectURL(img.src);\n}\nimg.src = src;\ndocument.body.appendChild(img);\n\n```\n\n由于`blob`对象不是一个有效的文件，所以不能正常显示图片。上面的`demo`提到了一个`URL.createObjectURL`接口，顺便来学习以下：\n>objectURL = URL.createObjectURL(blob);\n\n主要用于根据一个`Blob`对象(或者`File`,因为`File`继承自`Blob`)，创建一个`URL`用于表示该对象。需要注意的是即使对同一个对象调用两次也会得到不同的`URL`。如果该`URL`不用了需要调用`URL.invokeObjectURL`来进行释放。浏览器会在当前`document unloaded`的时候自动把该`URL`释放。`URL`格式：\n> blob:http%3A//localhost%3A8003/a47ea163-c253-471a-9d9e-877fe345b60f\n\n\n最后来看一个正常点的`DEMO`，利用`URL.createObjectURL`读取本地图片文件，并创建缩略图。\n\n--\n\n**利用`Blob`显示缩略图`**\n\n``` javascript\n var input = document.createElement(\"input\");\n input.type = \"file\";\n input.accept = \"image/*\";\n input.multiple = true;\n input.style.display = \"none\";\n document.body.appendChild(input);\n\n var fileSelect = document.createElement(\"a\");\n fileSelect.href = \"#\";\n fileSelect.appendChild(document.createTextNode(\"Choose files\"));\n document.body.appendChild(fileSelect);\n\n var imgList = document.createElement(\"div\");\n imgList.innerHTML = \"<p>No file Selected!</p>\"\n document.body.appendChild(imgList);\n\n input.addEventListener(\"change\", function(e) {\n var files = this.files;\n if(!files.length) {\n    return;\n }\n imgList.innerHTML = \"\";\n var list = document.createElement(\"ul\");\n imgList.appendChild(list);\n for(var i = 0; i < files.length; i++) {\n     var li = document.createElement(\"li\"); \n     list.appendChild(li);\n\n     var img = document.createElement(\"img\");\n     img.src = window.URL.createObjectURL(files[i]);\n     img.height = 60;\n     img.width  = 60;\n     img.onload = function() {\n         window.URL.revokeObjectURL(this.src);\n     }\n     li.appendChild(img);\n     var info = document.createElement(\"span\");\n     info.innerHTML = files[i].name + \":\" + files[i].size + \" bytes\";\n     li.appendChild(info);\n  }\n}, false);\n\nfileSelect.addEventListener(\"click\", function(e) {\n  input.click();     \n       e.preventDefault();\n}, false);\n\n```\n\n由于`File`对象继承自`Blob`,所以我们可以很方便的利用`File`对象加载本地系统图片文件，并通过`createObjectURL`生成一个`URL`并加以显示。\n\n参考文献：\n+  [Blob](https://developer.mozilla.org/en-US/docs/Web/API/Blob)\n+  [Using_files_from_web](https://developer.mozilla.org/en-US/docs/Using_files_from_web_applications)\n\n","slug":"Blob","published":1,"updated":"2018-07-01T10:30:46.491Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9ccj0002y4zvwve3s0pr","content":"<p>&nbsp;&nbsp;&nbsp;&nbsp;<code>Blob</code>(Binary Large Object)术语最初来自数据库，早期数据库因为要存储声音、图片、以及可执行程序等二进制数据对象所以给该类对象取名为<code>Blob</code>。<br>&nbsp;&nbsp;&nbsp;&nbsp;在<code>Web</code>领域，<code>Blob</code>被定义为包含只读数据的类文件对象。<code>Blob</code>中的数据不一定是<code>js</code>原生数据形式。常见的<code>File</code>接口就继承自<code>Blob</code>，并扩展它用于支持用户系统的本地文件。</p>\n<p>&nbsp;&nbsp;&nbsp;&nbsp;构建一个<code>Blob</code>对象通常有三种方式：1、通过<code>Blob</code>对象的构造函数来构建。2、从已有的<code>Blob</code>对象调用<code>slice</code>接口切出一个新的<code>Blob</code>对象。3、<code>canvas</code> API toBlob方法，把当前绘制信息转为一个<code>Blob</code>对象。下面分别看看3种方式的实现：</p>\n<p>–<br>构造函数：<br>var blob = new Blob(array[optional], options[optional]);</p>\n<blockquote>\n</blockquote>\n<p>array(可选): 一个数组。数组元素可以是：<code>ArrayBuffer</code>、<code>ArrayBufferView</code>、<code>Blob</code>、<code>DOMString</code>.或者他们的组合。<br>options(可选): 一个对象。用于指定<code>Blob</code>对象的属性，可选的参数有：</p>\n<ul>\n<li>type: Content-Type,用于指定将要放入<code>Blob</code>中的数据的类型(<code>MIME</code>)。</li>\n</ul>\n<p><br><br><code>Blob</code>对象的基本属性：</p>\n<blockquote>\n</blockquote>\n<p>size : <code>Blob</code>对象包含的字节数。(只读)<br><br>type : <code>Blob</code>对象包含的数据类型<code>MIME</code>，如果类型未知则返回空字符串。</p>\n<p><br><br><code>Blob</code>对象的基本方法：<br><code>Blob.slice([start, [end, [content-type]]])</code></p>\n<blockquote>\n</blockquote>\n<p><code>slice</code>方法与数组的<code>slice</code>类似。</p>\n<p>–</p>\n<p><strong>原生对象构建<code>Blob</code></strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">&lt;script type=<span class=\"string\">\"text/javascript\"</span>&gt;</span><br><span class=\"line\"><span class=\"built_in\">window</span>.onload = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> blob = <span class=\"keyword\">new</span> Blob(<span class=\"number\">1234</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&lt;<span class=\"regexp\">/script&gt;</span></span><br></pre></td></tr></table></figure>\n<p><strong>提示出错：</strong></p>\n<blockquote>\n<p>Uncaught TypeError: Failed to construct ‘Blob’: The 1st argument is neither an array, nor does it have indexed properties.</p>\n</blockquote>\n<p>原因在于<code>Blob</code>构造函数要求第一个参数必须是数组，而这里第一个参数既不是一个数组，也没有可索引的属性。既然这里提到了对象的可索引属性，让我联想到了类数组的概念，而<code>Arguments</code>就是一个很好的例子。来试一试：<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script type=<span class=\"string\">\"text/javascript\"</span>&gt;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">testArgumentsBlob</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> blob = <span class=\"keyword\">new</span> Blob(<span class=\"built_in\">arguments</span>);</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(blob.size);<span class=\"comment\">//3</span></span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(blob.type);<span class=\"comment\">//\"\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"built_in\">window</span>.onload = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    testArgumentsBlob(<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&lt;<span class=\"regexp\">/script&gt;</span></span><br></pre></td></tr></table></figure></p>\n<p>可以看到即使是类数组对象，而数组元素类型是<code>Number</code>也能得出正确的结论，猜想大概是由于构造函数内部把<code>Number</code>转化为<code>String</code>的缘故吧！</p>\n<p>再来试一试其他的参数类型：<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">window</span>.onload = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> arg = &#123;<span class=\"attr\">hello</span>: <span class=\"string\">\"2016\"</span>&#125;;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> blob = <span class=\"keyword\">new</span> Blob([<span class=\"built_in\">JSON</span>.stringify(arg, <span class=\"literal\">null</span>, <span class=\"string\">\"\\t\"</span>)], &#123;<span class=\"attr\">type</span>: <span class=\"string\">\"application/json\"</span>&#125;);</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(blob.type);<span class=\"comment\">//application/json</span></span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(blob.size);<span class=\"comment\">//20</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>blob.type等于application/json没问题。<code>arg</code>转为字符串后的长度为16加上制表符<code>\\t</code>的宽度4个字节等于20。</p>\n<p>–</p>\n<p><strong>用<code>slice</code>切出一个<code>Blob</code>对象</strong><br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">window</span>.onload = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> arg = &#123;<span class=\"attr\">hello</span>: <span class=\"string\">\"2016\"</span>&#125;;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> str = <span class=\"built_in\">JSON</span>.stringify(arg, <span class=\"literal\">null</span>, <span class=\"string\">\"\\t\"</span>);</span><br><span class=\"line\">    <span class=\"keyword\">var</span> blob = <span class=\"keyword\">new</span> Blob([str], &#123;<span class=\"attr\">type</span>: <span class=\"string\">\"application/json\"</span>&#125;);</span><br><span class=\"line\">    <span class=\"keyword\">var</span> blob2 = blob.slice();</span><br><span class=\"line\">            </span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(blob2.size);<span class=\"comment\">//20</span></span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(blob2.type);<span class=\"comment\">//\"\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>可以看到，原始的<code>Blob</code>对象的<code>type</code>属性并不能传递给新的<code>Blob</code>对象，所以还是要自己指定。</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">window</span>.onload = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> arg = &#123;<span class=\"attr\">hello</span>: <span class=\"string\">\"2016\"</span>&#125;;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> str = <span class=\"built_in\">JSON</span>.stringify(arg, <span class=\"literal\">null</span>, <span class=\"string\">\"\\t\"</span>);</span><br><span class=\"line\">    <span class=\"keyword\">var</span> blob = <span class=\"keyword\">new</span> Blob([str], &#123;<span class=\"attr\">type</span>: <span class=\"string\">\"application/json\"</span>&#125;);</span><br><span class=\"line\">    <span class=\"keyword\">var</span> blob2 = blob.slice(<span class=\"number\">0</span>, blob.size, <span class=\"string\">\"application/json\"</span>);</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(blob2.size);<span class=\"comment\">//20</span></span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(blob2.type);<span class=\"comment\">//application/json</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>–</p>\n<p><strong><code>canvas</code> toBlob接口</strong></p>\n<p>函数原型：</p>\n<blockquote>\n<p>void canvas.toBlob(callback, type, encoderOptions);</p>\n</blockquote>\n<ul>\n<li>callback: 一个回调函数，新建的<code>blob</code>对象是唯一的参数`</li>\n<li>type: 图片格式，默认为<code>image/png</code>，默认<code>dpi</code>: 96</li>\n<li>encoderOptions: 0~1之间的数值。当<code>type</code>为image/jpeg 或 image/webp的时候，用于指定图片质量</li>\n</ul>\n<p>来个<code>DEMO</code>:<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">window</span>.onload = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> canvas = <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">\"main\"</span>);</span><br><span class=\"line\">    canvas.toBlob(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">blob</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> img = <span class=\"built_in\">document</span>.createElement(<span class=\"string\">\"img\"</span>);         </span><br><span class=\"line\">        <span class=\"keyword\">var</span> url = URL.createObjectURL(blob);</span><br><span class=\"line\">        img.onload = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">            URL.revokeObjectURL(url);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        img.src = url;</span><br><span class=\"line\">        <span class=\"built_in\">document</span>.body.appendChild(img);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&lt;<span class=\"regexp\">/script&gt;</span></span><br></pre></td></tr></table></figure></p>\n<p>得出错误：</p>\n<blockquote>\n<p>Uncaught TypeError: canvas.toBlob is not a function.</p>\n</blockquote>\n<p>一开始觉得自己写错了，<code>Google</code>了下才发现<code>Chrome</code>居然不支持这个接口。给个<code>polyfill</code><a href=\"https://github.com/X-Builder/JavaScript-Canvas-to-Blob/blob/master/js/canvas-to-blob.js\" target=\"_blank\" rel=\"noopener\">Canvas toBlob</a>。</p>\n<p>–</p>\n<p><strong>Blob基本运用</strong></p>\n<p>知道了<code>Blob</code>对象的基本属性，以及构建的方法，来看几个具体的运用。</p>\n<p>–</p>\n<p><strong>利用<code>Blob</code>显示对象`</strong><br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> blob = <span class=\"keyword\">new</span> Blob([<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>]);</span><br><span class=\"line\"><span class=\"keyword\">var</span> src = URL.createObjectURL(blob);</span><br><span class=\"line\"><span class=\"built_in\">console</span>.log(src);<span class=\"comment\">//blob:http%3A//localhost%3A8003/a47ea163-c253-471a-9d9e-877fe345b60f</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> img = <span class=\"built_in\">document</span>.createElement(<span class=\"string\">'img'</span>);</span><br><span class=\"line\">img.onload = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    URL.invokeObjectURL(img.src);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">img.src = src;</span><br><span class=\"line\"><span class=\"built_in\">document</span>.body.appendChild(img);</span><br></pre></td></tr></table></figure></p>\n<p>由于<code>blob</code>对象不是一个有效的文件，所以不能正常显示图片。上面的<code>demo</code>提到了一个<code>URL.createObjectURL</code>接口，顺便来学习以下：</p>\n<blockquote>\n<p>objectURL = URL.createObjectURL(blob);</p>\n</blockquote>\n<p>主要用于根据一个<code>Blob</code>对象(或者<code>File</code>,因为<code>File</code>继承自<code>Blob</code>)，创建一个<code>URL</code>用于表示该对象。需要注意的是即使对同一个对象调用两次也会得到不同的<code>URL</code>。如果该<code>URL</code>不用了需要调用<code>URL.invokeObjectURL</code>来进行释放。浏览器会在当前<code>document unloaded</code>的时候自动把该<code>URL</code>释放。<code>URL</code>格式：</p>\n<blockquote>\n<p>blob:http%3A//localhost%3A8003/a47ea163-c253-471a-9d9e-877fe345b60f</p>\n</blockquote>\n<p>最后来看一个正常点的<code>DEMO</code>，利用<code>URL.createObjectURL</code>读取本地图片文件，并创建缩略图。</p>\n<p>–</p>\n<p><strong>利用<code>Blob</code>显示缩略图`</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> <span class=\"keyword\">var</span> input = <span class=\"built_in\">document</span>.createElement(<span class=\"string\">\"input\"</span>);</span><br><span class=\"line\"> input.type = <span class=\"string\">\"file\"</span>;</span><br><span class=\"line\"> input.accept = <span class=\"string\">\"image/*\"</span>;</span><br><span class=\"line\"> input.multiple = <span class=\"literal\">true</span>;</span><br><span class=\"line\"> input.style.display = <span class=\"string\">\"none\"</span>;</span><br><span class=\"line\"> <span class=\"built_in\">document</span>.body.appendChild(input);</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"keyword\">var</span> fileSelect = <span class=\"built_in\">document</span>.createElement(<span class=\"string\">\"a\"</span>);</span><br><span class=\"line\"> fileSelect.href = <span class=\"string\">\"#\"</span>;</span><br><span class=\"line\"> fileSelect.appendChild(<span class=\"built_in\">document</span>.createTextNode(<span class=\"string\">\"Choose files\"</span>));</span><br><span class=\"line\"> <span class=\"built_in\">document</span>.body.appendChild(fileSelect);</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"keyword\">var</span> imgList = <span class=\"built_in\">document</span>.createElement(<span class=\"string\">\"div\"</span>);</span><br><span class=\"line\"> imgList.innerHTML = <span class=\"string\">\"&lt;p&gt;No file Selected!&lt;/p&gt;\"</span></span><br><span class=\"line\"> <span class=\"built_in\">document</span>.body.appendChild(imgList);</span><br><span class=\"line\"></span><br><span class=\"line\"> input.addEventListener(<span class=\"string\">\"change\"</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">e</span>) </span>&#123;</span><br><span class=\"line\"> <span class=\"keyword\">var</span> files = <span class=\"keyword\">this</span>.files;</span><br><span class=\"line\"> <span class=\"keyword\">if</span>(!files.length) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span>;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> imgList.innerHTML = <span class=\"string\">\"\"</span>;</span><br><span class=\"line\"> <span class=\"keyword\">var</span> list = <span class=\"built_in\">document</span>.createElement(<span class=\"string\">\"ul\"</span>);</span><br><span class=\"line\"> imgList.appendChild(list);</span><br><span class=\"line\"> <span class=\"keyword\">for</span>(<span class=\"keyword\">var</span> i = <span class=\"number\">0</span>; i &lt; files.length; i++) &#123;</span><br><span class=\"line\">     <span class=\"keyword\">var</span> li = <span class=\"built_in\">document</span>.createElement(<span class=\"string\">\"li\"</span>); </span><br><span class=\"line\">     list.appendChild(li);</span><br><span class=\"line\"></span><br><span class=\"line\">     <span class=\"keyword\">var</span> img = <span class=\"built_in\">document</span>.createElement(<span class=\"string\">\"img\"</span>);</span><br><span class=\"line\">     img.src = <span class=\"built_in\">window</span>.URL.createObjectURL(files[i]);</span><br><span class=\"line\">     img.height = <span class=\"number\">60</span>;</span><br><span class=\"line\">     img.width  = <span class=\"number\">60</span>;</span><br><span class=\"line\">     img.onload = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">         <span class=\"built_in\">window</span>.URL.revokeObjectURL(<span class=\"keyword\">this</span>.src);</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">     li.appendChild(img);</span><br><span class=\"line\">     <span class=\"keyword\">var</span> info = <span class=\"built_in\">document</span>.createElement(<span class=\"string\">\"span\"</span>);</span><br><span class=\"line\">     info.innerHTML = files[i].name + <span class=\"string\">\":\"</span> + files[i].size + <span class=\"string\">\" bytes\"</span>;</span><br><span class=\"line\">     li.appendChild(info);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;, <span class=\"literal\">false</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">fileSelect.addEventListener(<span class=\"string\">\"click\"</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">e</span>) </span>&#123;</span><br><span class=\"line\">  input.click();     </span><br><span class=\"line\">       e.preventDefault();</span><br><span class=\"line\">&#125;, <span class=\"literal\">false</span>);</span><br></pre></td></tr></table></figure>\n<p>由于<code>File</code>对象继承自<code>Blob</code>,所以我们可以很方便的利用<code>File</code>对象加载本地系统图片文件，并通过<code>createObjectURL</code>生成一个<code>URL</code>并加以显示。</p>\n<p>参考文献：</p>\n<ul>\n<li><a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Blob\" target=\"_blank\" rel=\"noopener\">Blob</a></li>\n<li><a href=\"https://developer.mozilla.org/en-US/docs/Using_files_from_web_applications\" target=\"_blank\" rel=\"noopener\">Using_files_from_web</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<p>&nbsp;&nbsp;&nbsp;&nbsp;<code>Blob</code>(Binary Large Object)术语最初来自数据库，早期数据库因为要存储声音、图片、以及可执行程序等二进制数据对象所以给该类对象取名为<code>Blob</code>。<br>&nbsp;&nbsp;&nbsp;&nbsp;在<code>Web</code>领域，<code>Blob</code>被定义为包含只读数据的类文件对象。<code>Blob</code>中的数据不一定是<code>js</code>原生数据形式。常见的<code>File</code>接口就继承自<code>Blob</code>，并扩展它用于支持用户系统的本地文件。</p>\n<p>&nbsp;&nbsp;&nbsp;&nbsp;构建一个<code>Blob</code>对象通常有三种方式：1、通过<code>Blob</code>对象的构造函数来构建。2、从已有的<code>Blob</code>对象调用<code>slice</code>接口切出一个新的<code>Blob</code>对象。3、<code>canvas</code> API toBlob方法，把当前绘制信息转为一个<code>Blob</code>对象。下面分别看看3种方式的实现：</p>\n<p>–<br>构造函数：<br>var blob = new Blob(array[optional], options[optional]);</p>\n<blockquote>\n</blockquote>\n<p>array(可选): 一个数组。数组元素可以是：<code>ArrayBuffer</code>、<code>ArrayBufferView</code>、<code>Blob</code>、<code>DOMString</code>.或者他们的组合。<br>options(可选): 一个对象。用于指定<code>Blob</code>对象的属性，可选的参数有：</p>\n<ul>\n<li>type: Content-Type,用于指定将要放入<code>Blob</code>中的数据的类型(<code>MIME</code>)。</li>\n</ul>\n<p><br><br><code>Blob</code>对象的基本属性：</p>\n<blockquote>\n</blockquote>\n<p>size : <code>Blob</code>对象包含的字节数。(只读)<br><br>type : <code>Blob</code>对象包含的数据类型<code>MIME</code>，如果类型未知则返回空字符串。</p>\n<p><br><br><code>Blob</code>对象的基本方法：<br><code>Blob.slice([start, [end, [content-type]]])</code></p>\n<blockquote>\n</blockquote>\n<p><code>slice</code>方法与数组的<code>slice</code>类似。</p>\n<p>–</p>\n<p><strong>原生对象构建<code>Blob</code></strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">&lt;script type=<span class=\"string\">\"text/javascript\"</span>&gt;</span><br><span class=\"line\"><span class=\"built_in\">window</span>.onload = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> blob = <span class=\"keyword\">new</span> Blob(<span class=\"number\">1234</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&lt;<span class=\"regexp\">/script&gt;</span></span><br></pre></td></tr></table></figure>\n<p><strong>提示出错：</strong></p>\n<blockquote>\n<p>Uncaught TypeError: Failed to construct ‘Blob’: The 1st argument is neither an array, nor does it have indexed properties.</p>\n</blockquote>\n<p>原因在于<code>Blob</code>构造函数要求第一个参数必须是数组，而这里第一个参数既不是一个数组，也没有可索引的属性。既然这里提到了对象的可索引属性，让我联想到了类数组的概念，而<code>Arguments</code>就是一个很好的例子。来试一试：<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script type=<span class=\"string\">\"text/javascript\"</span>&gt;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">testArgumentsBlob</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> blob = <span class=\"keyword\">new</span> Blob(<span class=\"built_in\">arguments</span>);</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(blob.size);<span class=\"comment\">//3</span></span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(blob.type);<span class=\"comment\">//\"\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"built_in\">window</span>.onload = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    testArgumentsBlob(<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&lt;<span class=\"regexp\">/script&gt;</span></span><br></pre></td></tr></table></figure></p>\n<p>可以看到即使是类数组对象，而数组元素类型是<code>Number</code>也能得出正确的结论，猜想大概是由于构造函数内部把<code>Number</code>转化为<code>String</code>的缘故吧！</p>\n<p>再来试一试其他的参数类型：<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">window</span>.onload = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> arg = &#123;<span class=\"attr\">hello</span>: <span class=\"string\">\"2016\"</span>&#125;;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> blob = <span class=\"keyword\">new</span> Blob([<span class=\"built_in\">JSON</span>.stringify(arg, <span class=\"literal\">null</span>, <span class=\"string\">\"\\t\"</span>)], &#123;<span class=\"attr\">type</span>: <span class=\"string\">\"application/json\"</span>&#125;);</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(blob.type);<span class=\"comment\">//application/json</span></span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(blob.size);<span class=\"comment\">//20</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>blob.type等于application/json没问题。<code>arg</code>转为字符串后的长度为16加上制表符<code>\\t</code>的宽度4个字节等于20。</p>\n<p>–</p>\n<p><strong>用<code>slice</code>切出一个<code>Blob</code>对象</strong><br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">window</span>.onload = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> arg = &#123;<span class=\"attr\">hello</span>: <span class=\"string\">\"2016\"</span>&#125;;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> str = <span class=\"built_in\">JSON</span>.stringify(arg, <span class=\"literal\">null</span>, <span class=\"string\">\"\\t\"</span>);</span><br><span class=\"line\">    <span class=\"keyword\">var</span> blob = <span class=\"keyword\">new</span> Blob([str], &#123;<span class=\"attr\">type</span>: <span class=\"string\">\"application/json\"</span>&#125;);</span><br><span class=\"line\">    <span class=\"keyword\">var</span> blob2 = blob.slice();</span><br><span class=\"line\">            </span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(blob2.size);<span class=\"comment\">//20</span></span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(blob2.type);<span class=\"comment\">//\"\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>可以看到，原始的<code>Blob</code>对象的<code>type</code>属性并不能传递给新的<code>Blob</code>对象，所以还是要自己指定。</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">window</span>.onload = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> arg = &#123;<span class=\"attr\">hello</span>: <span class=\"string\">\"2016\"</span>&#125;;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> str = <span class=\"built_in\">JSON</span>.stringify(arg, <span class=\"literal\">null</span>, <span class=\"string\">\"\\t\"</span>);</span><br><span class=\"line\">    <span class=\"keyword\">var</span> blob = <span class=\"keyword\">new</span> Blob([str], &#123;<span class=\"attr\">type</span>: <span class=\"string\">\"application/json\"</span>&#125;);</span><br><span class=\"line\">    <span class=\"keyword\">var</span> blob2 = blob.slice(<span class=\"number\">0</span>, blob.size, <span class=\"string\">\"application/json\"</span>);</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(blob2.size);<span class=\"comment\">//20</span></span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(blob2.type);<span class=\"comment\">//application/json</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>–</p>\n<p><strong><code>canvas</code> toBlob接口</strong></p>\n<p>函数原型：</p>\n<blockquote>\n<p>void canvas.toBlob(callback, type, encoderOptions);</p>\n</blockquote>\n<ul>\n<li>callback: 一个回调函数，新建的<code>blob</code>对象是唯一的参数`</li>\n<li>type: 图片格式，默认为<code>image/png</code>，默认<code>dpi</code>: 96</li>\n<li>encoderOptions: 0~1之间的数值。当<code>type</code>为image/jpeg 或 image/webp的时候，用于指定图片质量</li>\n</ul>\n<p>来个<code>DEMO</code>:<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">window</span>.onload = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> canvas = <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">\"main\"</span>);</span><br><span class=\"line\">    canvas.toBlob(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">blob</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> img = <span class=\"built_in\">document</span>.createElement(<span class=\"string\">\"img\"</span>);         </span><br><span class=\"line\">        <span class=\"keyword\">var</span> url = URL.createObjectURL(blob);</span><br><span class=\"line\">        img.onload = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">            URL.revokeObjectURL(url);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        img.src = url;</span><br><span class=\"line\">        <span class=\"built_in\">document</span>.body.appendChild(img);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&lt;<span class=\"regexp\">/script&gt;</span></span><br></pre></td></tr></table></figure></p>\n<p>得出错误：</p>\n<blockquote>\n<p>Uncaught TypeError: canvas.toBlob is not a function.</p>\n</blockquote>\n<p>一开始觉得自己写错了，<code>Google</code>了下才发现<code>Chrome</code>居然不支持这个接口。给个<code>polyfill</code><a href=\"https://github.com/X-Builder/JavaScript-Canvas-to-Blob/blob/master/js/canvas-to-blob.js\" target=\"_blank\" rel=\"noopener\">Canvas toBlob</a>。</p>\n<p>–</p>\n<p><strong>Blob基本运用</strong></p>\n<p>知道了<code>Blob</code>对象的基本属性，以及构建的方法，来看几个具体的运用。</p>\n<p>–</p>\n<p><strong>利用<code>Blob</code>显示对象`</strong><br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> blob = <span class=\"keyword\">new</span> Blob([<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>]);</span><br><span class=\"line\"><span class=\"keyword\">var</span> src = URL.createObjectURL(blob);</span><br><span class=\"line\"><span class=\"built_in\">console</span>.log(src);<span class=\"comment\">//blob:http%3A//localhost%3A8003/a47ea163-c253-471a-9d9e-877fe345b60f</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> img = <span class=\"built_in\">document</span>.createElement(<span class=\"string\">'img'</span>);</span><br><span class=\"line\">img.onload = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    URL.invokeObjectURL(img.src);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">img.src = src;</span><br><span class=\"line\"><span class=\"built_in\">document</span>.body.appendChild(img);</span><br></pre></td></tr></table></figure></p>\n<p>由于<code>blob</code>对象不是一个有效的文件，所以不能正常显示图片。上面的<code>demo</code>提到了一个<code>URL.createObjectURL</code>接口，顺便来学习以下：</p>\n<blockquote>\n<p>objectURL = URL.createObjectURL(blob);</p>\n</blockquote>\n<p>主要用于根据一个<code>Blob</code>对象(或者<code>File</code>,因为<code>File</code>继承自<code>Blob</code>)，创建一个<code>URL</code>用于表示该对象。需要注意的是即使对同一个对象调用两次也会得到不同的<code>URL</code>。如果该<code>URL</code>不用了需要调用<code>URL.invokeObjectURL</code>来进行释放。浏览器会在当前<code>document unloaded</code>的时候自动把该<code>URL</code>释放。<code>URL</code>格式：</p>\n<blockquote>\n<p>blob:http%3A//localhost%3A8003/a47ea163-c253-471a-9d9e-877fe345b60f</p>\n</blockquote>\n<p>最后来看一个正常点的<code>DEMO</code>，利用<code>URL.createObjectURL</code>读取本地图片文件，并创建缩略图。</p>\n<p>–</p>\n<p><strong>利用<code>Blob</code>显示缩略图`</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> <span class=\"keyword\">var</span> input = <span class=\"built_in\">document</span>.createElement(<span class=\"string\">\"input\"</span>);</span><br><span class=\"line\"> input.type = <span class=\"string\">\"file\"</span>;</span><br><span class=\"line\"> input.accept = <span class=\"string\">\"image/*\"</span>;</span><br><span class=\"line\"> input.multiple = <span class=\"literal\">true</span>;</span><br><span class=\"line\"> input.style.display = <span class=\"string\">\"none\"</span>;</span><br><span class=\"line\"> <span class=\"built_in\">document</span>.body.appendChild(input);</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"keyword\">var</span> fileSelect = <span class=\"built_in\">document</span>.createElement(<span class=\"string\">\"a\"</span>);</span><br><span class=\"line\"> fileSelect.href = <span class=\"string\">\"#\"</span>;</span><br><span class=\"line\"> fileSelect.appendChild(<span class=\"built_in\">document</span>.createTextNode(<span class=\"string\">\"Choose files\"</span>));</span><br><span class=\"line\"> <span class=\"built_in\">document</span>.body.appendChild(fileSelect);</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"keyword\">var</span> imgList = <span class=\"built_in\">document</span>.createElement(<span class=\"string\">\"div\"</span>);</span><br><span class=\"line\"> imgList.innerHTML = <span class=\"string\">\"&lt;p&gt;No file Selected!&lt;/p&gt;\"</span></span><br><span class=\"line\"> <span class=\"built_in\">document</span>.body.appendChild(imgList);</span><br><span class=\"line\"></span><br><span class=\"line\"> input.addEventListener(<span class=\"string\">\"change\"</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">e</span>) </span>&#123;</span><br><span class=\"line\"> <span class=\"keyword\">var</span> files = <span class=\"keyword\">this</span>.files;</span><br><span class=\"line\"> <span class=\"keyword\">if</span>(!files.length) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span>;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> imgList.innerHTML = <span class=\"string\">\"\"</span>;</span><br><span class=\"line\"> <span class=\"keyword\">var</span> list = <span class=\"built_in\">document</span>.createElement(<span class=\"string\">\"ul\"</span>);</span><br><span class=\"line\"> imgList.appendChild(list);</span><br><span class=\"line\"> <span class=\"keyword\">for</span>(<span class=\"keyword\">var</span> i = <span class=\"number\">0</span>; i &lt; files.length; i++) &#123;</span><br><span class=\"line\">     <span class=\"keyword\">var</span> li = <span class=\"built_in\">document</span>.createElement(<span class=\"string\">\"li\"</span>); </span><br><span class=\"line\">     list.appendChild(li);</span><br><span class=\"line\"></span><br><span class=\"line\">     <span class=\"keyword\">var</span> img = <span class=\"built_in\">document</span>.createElement(<span class=\"string\">\"img\"</span>);</span><br><span class=\"line\">     img.src = <span class=\"built_in\">window</span>.URL.createObjectURL(files[i]);</span><br><span class=\"line\">     img.height = <span class=\"number\">60</span>;</span><br><span class=\"line\">     img.width  = <span class=\"number\">60</span>;</span><br><span class=\"line\">     img.onload = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">         <span class=\"built_in\">window</span>.URL.revokeObjectURL(<span class=\"keyword\">this</span>.src);</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">     li.appendChild(img);</span><br><span class=\"line\">     <span class=\"keyword\">var</span> info = <span class=\"built_in\">document</span>.createElement(<span class=\"string\">\"span\"</span>);</span><br><span class=\"line\">     info.innerHTML = files[i].name + <span class=\"string\">\":\"</span> + files[i].size + <span class=\"string\">\" bytes\"</span>;</span><br><span class=\"line\">     li.appendChild(info);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;, <span class=\"literal\">false</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">fileSelect.addEventListener(<span class=\"string\">\"click\"</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">e</span>) </span>&#123;</span><br><span class=\"line\">  input.click();     </span><br><span class=\"line\">       e.preventDefault();</span><br><span class=\"line\">&#125;, <span class=\"literal\">false</span>);</span><br></pre></td></tr></table></figure>\n<p>由于<code>File</code>对象继承自<code>Blob</code>,所以我们可以很方便的利用<code>File</code>对象加载本地系统图片文件，并通过<code>createObjectURL</code>生成一个<code>URL</code>并加以显示。</p>\n<p>参考文献：</p>\n<ul>\n<li><a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Blob\" target=\"_blank\" rel=\"noopener\">Blob</a></li>\n<li><a href=\"https://developer.mozilla.org/en-US/docs/Using_files_from_web_applications\" target=\"_blank\" rel=\"noopener\">Using_files_from_web</a></li>\n</ul>\n"},{"title":"CSS-background","date":"2016-08-25T02:44:09.000Z","_content":"\n# CSS`background`属性总结\n\n## 基本属性\n\n- background-color\n- background-image\n- background-size\n- background-position\n- background-origin\n- background-attachment\n- background-clip\n\n---\n\n## `background-color`\n\n顾名思义`background-color`用于设置元素的背景颜色,这应该是最好理解的属性之一了。但是有几点需要注意：\n\n>- 1、背景颜色涵盖了边框、padding、以及`content`区域(通过-background-clip属性控制,后面会看到) \n>- 2、背景颜色、边框、背景图片的层次从下到上顺序为：背景颜色=》背景图片=》边框，所以如果把边框样式设置伪`dashed`可以看到透过的背景颜色与图片.\n\n---\n\n## `background-image`\n\n`image`属性用于指定元素背景图片，除了图片还可以用`radial-gradient`或者`linear-gradient`函数创建一个渐变的图像对象。还可以给一个元素设置多个图像，后设置的图像在上面一层。\n\n---\n\n## `background-position`\n\n`position`属性用于控制背景图片的位置，有三种类型的值可以设置：\n\n>- 1、直接设置关键字,水平方向：`left`、`center`、`right`,垂直方向：`top`、`center`、`bottom`.可以把背景图片看成相对于背景区域绝对定位，这样就比较好理解了。\n>- 2、使用像素值控制位置, 使用像素值的时候可以想像把背景图片相对定位，即：默认状态图片的位置为背景区域的左上角，这个时候修改背景图片的位置实际上是相对于背景区域的左上角做偏移。\n>- 3、使用百分比定位，这个属性不太好理解，简单说来一句话：`把背景图片百分比的位置放置到背景区域对应百分比的位置`.百分比定位的一个好处就在于，背景图片根据背景区域的放大而适配。\n\n注意：\n>如果只设置了一个值，另外一个值将会是`50%`。不管是何种方式都是如此。\n\n---\n\n## `background-origin`\n\n`origin`属性指定了背景图片属性的原点相对位置，默认值：`padding-box`,可选值有：\n\n- `content-box`,元素内容区域\n- `border-box`,元素边框以内区域\n- `padding-box`,元素内边距以内区域\n\n注意：\n>如果`background-attachment`设置为`fixed`则忽略该属性。\n\n---\n\n## `background-attachment`\n\n`attachment`属性决定背景图片滚动或者固定。可选属性：\n\n- `fixed`,固定，相对视口做定位，类似于position属性的`fixed`。\n- `scroll`,**相对元素自身的位置固定**，不根据元素内容滚动。\n- `local`,**相对元素内容的位置固定**，根据元素内容滚动。\n\n在线demo:[scroll local fixed](http://jsfiddle.net/n88cZ/1/)\n\n---\n\n## `background-size`\n\n`size`控制背景图片的显示区域大小，可以指定具体的宽高、也可以设置关键字、\n\n### `background-size`关键字\n\n- auto\n  默认值，背景图片大小等与图片本身的大小。\n\n- contain\n  包含，背景区域确保能放下整个图片，这样有可能造成背景图片没有涵盖整个背景区域的效果，但是图片能得到完整显示。\n\n- cover\n  覆盖，用背景图片覆盖背景区域，这样会造成背景图片显示不全的情况，但是整个背景区域能被背景图片覆盖。\n\n### `background-size`指定大小\n\n- 指定一个值\n  这个时候另外一个属性会按照元素宽高比例缩放\n\n- 指定两个值\n  这个时候背景图片会被缩放到指定大小。\n\n---\n\n## `background-clip`\n\n\n`clip`属性用于控制，**背景图片和颜色**延伸的区域，可选属性：\n\n- border-box\n  默认值，允许背景图片和颜色延伸到边框\n\n- padding-box\n  允许背景图片和颜色延伸到内边距\n\n- content-box\n  允许背景图片和颜色延伸到内容区\n\n- inherit\n  继承\n","source":"_posts/CSS-background.md","raw":"---\ntitle: CSS-background\ndate: 2016-08-25 10:44:09\ntags: css background\ncategories: web\n---\n\n# CSS`background`属性总结\n\n## 基本属性\n\n- background-color\n- background-image\n- background-size\n- background-position\n- background-origin\n- background-attachment\n- background-clip\n\n---\n\n## `background-color`\n\n顾名思义`background-color`用于设置元素的背景颜色,这应该是最好理解的属性之一了。但是有几点需要注意：\n\n>- 1、背景颜色涵盖了边框、padding、以及`content`区域(通过-background-clip属性控制,后面会看到) \n>- 2、背景颜色、边框、背景图片的层次从下到上顺序为：背景颜色=》背景图片=》边框，所以如果把边框样式设置伪`dashed`可以看到透过的背景颜色与图片.\n\n---\n\n## `background-image`\n\n`image`属性用于指定元素背景图片，除了图片还可以用`radial-gradient`或者`linear-gradient`函数创建一个渐变的图像对象。还可以给一个元素设置多个图像，后设置的图像在上面一层。\n\n---\n\n## `background-position`\n\n`position`属性用于控制背景图片的位置，有三种类型的值可以设置：\n\n>- 1、直接设置关键字,水平方向：`left`、`center`、`right`,垂直方向：`top`、`center`、`bottom`.可以把背景图片看成相对于背景区域绝对定位，这样就比较好理解了。\n>- 2、使用像素值控制位置, 使用像素值的时候可以想像把背景图片相对定位，即：默认状态图片的位置为背景区域的左上角，这个时候修改背景图片的位置实际上是相对于背景区域的左上角做偏移。\n>- 3、使用百分比定位，这个属性不太好理解，简单说来一句话：`把背景图片百分比的位置放置到背景区域对应百分比的位置`.百分比定位的一个好处就在于，背景图片根据背景区域的放大而适配。\n\n注意：\n>如果只设置了一个值，另外一个值将会是`50%`。不管是何种方式都是如此。\n\n---\n\n## `background-origin`\n\n`origin`属性指定了背景图片属性的原点相对位置，默认值：`padding-box`,可选值有：\n\n- `content-box`,元素内容区域\n- `border-box`,元素边框以内区域\n- `padding-box`,元素内边距以内区域\n\n注意：\n>如果`background-attachment`设置为`fixed`则忽略该属性。\n\n---\n\n## `background-attachment`\n\n`attachment`属性决定背景图片滚动或者固定。可选属性：\n\n- `fixed`,固定，相对视口做定位，类似于position属性的`fixed`。\n- `scroll`,**相对元素自身的位置固定**，不根据元素内容滚动。\n- `local`,**相对元素内容的位置固定**，根据元素内容滚动。\n\n在线demo:[scroll local fixed](http://jsfiddle.net/n88cZ/1/)\n\n---\n\n## `background-size`\n\n`size`控制背景图片的显示区域大小，可以指定具体的宽高、也可以设置关键字、\n\n### `background-size`关键字\n\n- auto\n  默认值，背景图片大小等与图片本身的大小。\n\n- contain\n  包含，背景区域确保能放下整个图片，这样有可能造成背景图片没有涵盖整个背景区域的效果，但是图片能得到完整显示。\n\n- cover\n  覆盖，用背景图片覆盖背景区域，这样会造成背景图片显示不全的情况，但是整个背景区域能被背景图片覆盖。\n\n### `background-size`指定大小\n\n- 指定一个值\n  这个时候另外一个属性会按照元素宽高比例缩放\n\n- 指定两个值\n  这个时候背景图片会被缩放到指定大小。\n\n---\n\n## `background-clip`\n\n\n`clip`属性用于控制，**背景图片和颜色**延伸的区域，可选属性：\n\n- border-box\n  默认值，允许背景图片和颜色延伸到边框\n\n- padding-box\n  允许背景图片和颜色延伸到内边距\n\n- content-box\n  允许背景图片和颜色延伸到内容区\n\n- inherit\n  继承\n","slug":"CSS-background","published":1,"updated":"2018-07-01T10:30:46.491Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9ccn0005y4zvga62blsu","content":"<h1 id=\"CSSbackground属性总结\"><a href=\"#CSSbackground属性总结\" class=\"headerlink\" title=\"CSSbackground属性总结\"></a>CSS<code>background</code>属性总结</h1><h2 id=\"基本属性\"><a href=\"#基本属性\" class=\"headerlink\" title=\"基本属性\"></a>基本属性</h2><ul>\n<li>background-color</li>\n<li>background-image</li>\n<li>background-size</li>\n<li>background-position</li>\n<li>background-origin</li>\n<li>background-attachment</li>\n<li>background-clip</li>\n</ul>\n<hr>\n<h2 id=\"background-color\"><a href=\"#background-color\" class=\"headerlink\" title=\"background-color\"></a><code>background-color</code></h2><p>顾名思义<code>background-color</code>用于设置元素的背景颜色,这应该是最好理解的属性之一了。但是有几点需要注意：</p>\n<blockquote>\n<ul>\n<li>1、背景颜色涵盖了边框、padding、以及<code>content</code>区域(通过-background-clip属性控制,后面会看到) </li>\n<li>2、背景颜色、边框、背景图片的层次从下到上顺序为：背景颜色=》背景图片=》边框，所以如果把边框样式设置伪<code>dashed</code>可以看到透过的背景颜色与图片.</li>\n</ul>\n</blockquote>\n<hr>\n<h2 id=\"background-image\"><a href=\"#background-image\" class=\"headerlink\" title=\"background-image\"></a><code>background-image</code></h2><p><code>image</code>属性用于指定元素背景图片，除了图片还可以用<code>radial-gradient</code>或者<code>linear-gradient</code>函数创建一个渐变的图像对象。还可以给一个元素设置多个图像，后设置的图像在上面一层。</p>\n<hr>\n<h2 id=\"background-position\"><a href=\"#background-position\" class=\"headerlink\" title=\"background-position\"></a><code>background-position</code></h2><p><code>position</code>属性用于控制背景图片的位置，有三种类型的值可以设置：</p>\n<blockquote>\n<ul>\n<li>1、直接设置关键字,水平方向：<code>left</code>、<code>center</code>、<code>right</code>,垂直方向：<code>top</code>、<code>center</code>、<code>bottom</code>.可以把背景图片看成相对于背景区域绝对定位，这样就比较好理解了。</li>\n<li>2、使用像素值控制位置, 使用像素值的时候可以想像把背景图片相对定位，即：默认状态图片的位置为背景区域的左上角，这个时候修改背景图片的位置实际上是相对于背景区域的左上角做偏移。</li>\n<li>3、使用百分比定位，这个属性不太好理解，简单说来一句话：<code>把背景图片百分比的位置放置到背景区域对应百分比的位置</code>.百分比定位的一个好处就在于，背景图片根据背景区域的放大而适配。</li>\n</ul>\n</blockquote>\n<p>注意：</p>\n<blockquote>\n<p>如果只设置了一个值，另外一个值将会是<code>50%</code>。不管是何种方式都是如此。</p>\n</blockquote>\n<hr>\n<h2 id=\"background-origin\"><a href=\"#background-origin\" class=\"headerlink\" title=\"background-origin\"></a><code>background-origin</code></h2><p><code>origin</code>属性指定了背景图片属性的原点相对位置，默认值：<code>padding-box</code>,可选值有：</p>\n<ul>\n<li><code>content-box</code>,元素内容区域</li>\n<li><code>border-box</code>,元素边框以内区域</li>\n<li><code>padding-box</code>,元素内边距以内区域</li>\n</ul>\n<p>注意：</p>\n<blockquote>\n<p>如果<code>background-attachment</code>设置为<code>fixed</code>则忽略该属性。</p>\n</blockquote>\n<hr>\n<h2 id=\"background-attachment\"><a href=\"#background-attachment\" class=\"headerlink\" title=\"background-attachment\"></a><code>background-attachment</code></h2><p><code>attachment</code>属性决定背景图片滚动或者固定。可选属性：</p>\n<ul>\n<li><code>fixed</code>,固定，相对视口做定位，类似于position属性的<code>fixed</code>。</li>\n<li><code>scroll</code>,<strong>相对元素自身的位置固定</strong>，不根据元素内容滚动。</li>\n<li><code>local</code>,<strong>相对元素内容的位置固定</strong>，根据元素内容滚动。</li>\n</ul>\n<p>在线demo:<a href=\"http://jsfiddle.net/n88cZ/1/\" target=\"_blank\" rel=\"noopener\">scroll local fixed</a></p>\n<hr>\n<h2 id=\"background-size\"><a href=\"#background-size\" class=\"headerlink\" title=\"background-size\"></a><code>background-size</code></h2><p><code>size</code>控制背景图片的显示区域大小，可以指定具体的宽高、也可以设置关键字、</p>\n<h3 id=\"background-size关键字\"><a href=\"#background-size关键字\" class=\"headerlink\" title=\"background-size关键字\"></a><code>background-size</code>关键字</h3><ul>\n<li><p>auto<br>默认值，背景图片大小等与图片本身的大小。</p>\n</li>\n<li><p>contain<br>包含，背景区域确保能放下整个图片，这样有可能造成背景图片没有涵盖整个背景区域的效果，但是图片能得到完整显示。</p>\n</li>\n<li><p>cover<br>覆盖，用背景图片覆盖背景区域，这样会造成背景图片显示不全的情况，但是整个背景区域能被背景图片覆盖。</p>\n</li>\n</ul>\n<h3 id=\"background-size指定大小\"><a href=\"#background-size指定大小\" class=\"headerlink\" title=\"background-size指定大小\"></a><code>background-size</code>指定大小</h3><ul>\n<li><p>指定一个值<br>这个时候另外一个属性会按照元素宽高比例缩放</p>\n</li>\n<li><p>指定两个值<br>这个时候背景图片会被缩放到指定大小。</p>\n</li>\n</ul>\n<hr>\n<h2 id=\"background-clip\"><a href=\"#background-clip\" class=\"headerlink\" title=\"background-clip\"></a><code>background-clip</code></h2><p><code>clip</code>属性用于控制，<strong>背景图片和颜色</strong>延伸的区域，可选属性：</p>\n<ul>\n<li><p>border-box<br>默认值，允许背景图片和颜色延伸到边框</p>\n</li>\n<li><p>padding-box<br>允许背景图片和颜色延伸到内边距</p>\n</li>\n<li><p>content-box<br>允许背景图片和颜色延伸到内容区</p>\n</li>\n<li><p>inherit<br>继承</p>\n</li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"CSSbackground属性总结\"><a href=\"#CSSbackground属性总结\" class=\"headerlink\" title=\"CSSbackground属性总结\"></a>CSS<code>background</code>属性总结</h1><h2 id=\"基本属性\"><a href=\"#基本属性\" class=\"headerlink\" title=\"基本属性\"></a>基本属性</h2><ul>\n<li>background-color</li>\n<li>background-image</li>\n<li>background-size</li>\n<li>background-position</li>\n<li>background-origin</li>\n<li>background-attachment</li>\n<li>background-clip</li>\n</ul>\n<hr>\n<h2 id=\"background-color\"><a href=\"#background-color\" class=\"headerlink\" title=\"background-color\"></a><code>background-color</code></h2><p>顾名思义<code>background-color</code>用于设置元素的背景颜色,这应该是最好理解的属性之一了。但是有几点需要注意：</p>\n<blockquote>\n<ul>\n<li>1、背景颜色涵盖了边框、padding、以及<code>content</code>区域(通过-background-clip属性控制,后面会看到) </li>\n<li>2、背景颜色、边框、背景图片的层次从下到上顺序为：背景颜色=》背景图片=》边框，所以如果把边框样式设置伪<code>dashed</code>可以看到透过的背景颜色与图片.</li>\n</ul>\n</blockquote>\n<hr>\n<h2 id=\"background-image\"><a href=\"#background-image\" class=\"headerlink\" title=\"background-image\"></a><code>background-image</code></h2><p><code>image</code>属性用于指定元素背景图片，除了图片还可以用<code>radial-gradient</code>或者<code>linear-gradient</code>函数创建一个渐变的图像对象。还可以给一个元素设置多个图像，后设置的图像在上面一层。</p>\n<hr>\n<h2 id=\"background-position\"><a href=\"#background-position\" class=\"headerlink\" title=\"background-position\"></a><code>background-position</code></h2><p><code>position</code>属性用于控制背景图片的位置，有三种类型的值可以设置：</p>\n<blockquote>\n<ul>\n<li>1、直接设置关键字,水平方向：<code>left</code>、<code>center</code>、<code>right</code>,垂直方向：<code>top</code>、<code>center</code>、<code>bottom</code>.可以把背景图片看成相对于背景区域绝对定位，这样就比较好理解了。</li>\n<li>2、使用像素值控制位置, 使用像素值的时候可以想像把背景图片相对定位，即：默认状态图片的位置为背景区域的左上角，这个时候修改背景图片的位置实际上是相对于背景区域的左上角做偏移。</li>\n<li>3、使用百分比定位，这个属性不太好理解，简单说来一句话：<code>把背景图片百分比的位置放置到背景区域对应百分比的位置</code>.百分比定位的一个好处就在于，背景图片根据背景区域的放大而适配。</li>\n</ul>\n</blockquote>\n<p>注意：</p>\n<blockquote>\n<p>如果只设置了一个值，另外一个值将会是<code>50%</code>。不管是何种方式都是如此。</p>\n</blockquote>\n<hr>\n<h2 id=\"background-origin\"><a href=\"#background-origin\" class=\"headerlink\" title=\"background-origin\"></a><code>background-origin</code></h2><p><code>origin</code>属性指定了背景图片属性的原点相对位置，默认值：<code>padding-box</code>,可选值有：</p>\n<ul>\n<li><code>content-box</code>,元素内容区域</li>\n<li><code>border-box</code>,元素边框以内区域</li>\n<li><code>padding-box</code>,元素内边距以内区域</li>\n</ul>\n<p>注意：</p>\n<blockquote>\n<p>如果<code>background-attachment</code>设置为<code>fixed</code>则忽略该属性。</p>\n</blockquote>\n<hr>\n<h2 id=\"background-attachment\"><a href=\"#background-attachment\" class=\"headerlink\" title=\"background-attachment\"></a><code>background-attachment</code></h2><p><code>attachment</code>属性决定背景图片滚动或者固定。可选属性：</p>\n<ul>\n<li><code>fixed</code>,固定，相对视口做定位，类似于position属性的<code>fixed</code>。</li>\n<li><code>scroll</code>,<strong>相对元素自身的位置固定</strong>，不根据元素内容滚动。</li>\n<li><code>local</code>,<strong>相对元素内容的位置固定</strong>，根据元素内容滚动。</li>\n</ul>\n<p>在线demo:<a href=\"http://jsfiddle.net/n88cZ/1/\" target=\"_blank\" rel=\"noopener\">scroll local fixed</a></p>\n<hr>\n<h2 id=\"background-size\"><a href=\"#background-size\" class=\"headerlink\" title=\"background-size\"></a><code>background-size</code></h2><p><code>size</code>控制背景图片的显示区域大小，可以指定具体的宽高、也可以设置关键字、</p>\n<h3 id=\"background-size关键字\"><a href=\"#background-size关键字\" class=\"headerlink\" title=\"background-size关键字\"></a><code>background-size</code>关键字</h3><ul>\n<li><p>auto<br>默认值，背景图片大小等与图片本身的大小。</p>\n</li>\n<li><p>contain<br>包含，背景区域确保能放下整个图片，这样有可能造成背景图片没有涵盖整个背景区域的效果，但是图片能得到完整显示。</p>\n</li>\n<li><p>cover<br>覆盖，用背景图片覆盖背景区域，这样会造成背景图片显示不全的情况，但是整个背景区域能被背景图片覆盖。</p>\n</li>\n</ul>\n<h3 id=\"background-size指定大小\"><a href=\"#background-size指定大小\" class=\"headerlink\" title=\"background-size指定大小\"></a><code>background-size</code>指定大小</h3><ul>\n<li><p>指定一个值<br>这个时候另外一个属性会按照元素宽高比例缩放</p>\n</li>\n<li><p>指定两个值<br>这个时候背景图片会被缩放到指定大小。</p>\n</li>\n</ul>\n<hr>\n<h2 id=\"background-clip\"><a href=\"#background-clip\" class=\"headerlink\" title=\"background-clip\"></a><code>background-clip</code></h2><p><code>clip</code>属性用于控制，<strong>背景图片和颜色</strong>延伸的区域，可选属性：</p>\n<ul>\n<li><p>border-box<br>默认值，允许背景图片和颜色延伸到边框</p>\n</li>\n<li><p>padding-box<br>允许背景图片和颜色延伸到内边距</p>\n</li>\n<li><p>content-box<br>允许背景图片和颜色延伸到内容区</p>\n</li>\n<li><p>inherit<br>继承</p>\n</li>\n</ul>\n"},{"title":"CSS-动画详解","date":"2016-09-30T02:16:04.000Z","_content":"\n\n# `CSS`动画详解\n\n`CSS animation`使用十分广泛，特此来做一个详细的总结。\n\n---\n\n## 通过`transiton`属性控制动画\n\n基本语法：\n\n`transition: width 2s 1s ease;` `width`属性受到动画影响，动画持续时间为`2s`，动画延迟`1s`播出，动画插值算法采用`ease`。多个属性可以用逗号分隔。例如：`transition: width 2s, height 1s;`。\n\n\n`transiton`控制动画应该是最简单的方式之一了，和其他属性类似`transiton`也是一个复合属性由以下几个属性组成：\n\n- transiton-delay: 动画延时播放，默认为0\n- transiton-timing-function: 动画插值函数,默认为`ease`\n- transiton-property: 指明要发生变化的属性\n- transiton-duration: 指明动画周期(持续时间),默认为0\n\n### 动画延时\n\n  看一个`demo`,子元素宽度从0到填充父控件，延时`1s`。\n{% jsfiddle fnao3q2t css,result light 100% 400px %}\n\n鼠标进入和离开控件的时候都有`1s`延迟,这就是`transiton-delay`的效果。\n\n### 动画速度变更函数(插值函数)\n\n  `transiton-timing-function`属性用于改变动画的速度曲线。可选值有：\n\n- ease：默认参数\n- linear\n- ease-in\n- ease-out\n- ease-in-out\n- cubic-bezier\n\n关于插值函数对应的效果可以[看这里](http://easings.net/zh-cn)。\n\n说说`cubic-bezier`,由于`css`内值动画曲线比较有限，所以可以根据`cubic-bezier`规划一条贝赛尔曲线。\n{% jsfiddle k3jtsn9v css,result light 100% 400px %}\n\n推荐一个贝塞尔曲线在线编辑器：[`cubic-bezier`](http://cubic-bezier.com)。\n\n### 动画属性\n\n顾名思义，设置受到动画影响的属性。如果所有属性都受到影响，可以指定一个`all`参数。需要注意的是，`css`规定一些属性不受`transiton`影响，例如：`display`等。具体看`W3C`上[一个对应表](https://www.w3.org/TR/css3-transitions/#animatable-properties)。值得一提的是，`display`属性虽然不受影响，但是`visibility`属性会受影响。\n\n\n### 动画持续时间\n\n设置动画延迟播放时间，*注意默认为0*，除了以`s`为单位，也可以以`ms`为单位。\n\n\n>`transition`属性虽然使用方便，但是也有它的局限性:\n\n- 动画需要事件触发，无法自动播放\n- 无法重复播放，除非一直触发\n- 无法为多个属性指定同样的变化规则(写起来比较麻烦)\n- 只能控制开始和结束状态、无法定义中间态\n\n---\n\n\n## 通过`animation`属性控制动画\n\n和`transition`类似，`animation`也是一个复合属性。它提供了比较多的属性来控制动画，从而实现更加细致的控制。\n\n基本格式：\n\n`@keyframes`关键字用于定义动画的细节，比例动画名称，动画在某一时刻的状态属性值等。\n\n```css\n@keyframes anim {\n  from: {background: red;}\n  to: {background: blue;}\n}\n```\n\n上面一段`css`定义了一个动画，名称为`anim`,动画从背景红色过渡到背景蓝色，`from`表示起始时刻动画状态，`to`表示结束时刻动画状态。还可以换成百分比的形式从`0%`到`100%`。\n从而实现了在不同时刻控制动画状态的目的。\n\n{% jsfiddle Lhpfxbrm css,result light 100% 400px %}\n\n---\n\n基本属性：\n\n- animation-duration\n- animation-direction\n- animation-delay\n- animation-name\n- animation-iteration-count\n- animation-timing-function\n- animation-play-state\n- animation-fill-mode\n\n### 动画时长\n\n`animation-duration`和`transition-duration`类似，不做过多介绍，用于控制动画的时间长度。\n\n### 动画播放延时\n\n`animation-delay`和`transition-delay`类似控制动画首次播放的延时。\n\n### 动画名称\n\n`animation-name`指定元素引用哪个动画，名称通过`@keyframes`指定。\n\n### 动画方向\n\n`animation-direction`控制动画循环播放的时候状态的变更次序。看个`demo`:\n\n{% jsfiddle Lhpfxbrm css,result light 100% 400px %}\n\n可选的属性：\n\n- normal: 每次都从起始状态变更到终止状态\n- reverse: 每次都从终止状态变更到起始状态\n- alternate: 奇数次从起始状态变更到结束状态、偶数次从结束状态变更到起始状态\n- alternate-reverse: 与`alternate`相反\n\n### 动画结束的状态\n\n`animation-fill-mode`属性控制动画结束播放时候的状态，看个`demo`：\n\n{% jsfiddle geLw2de5 css,result light 100% 400px %}\n\n- forwards: 让动画停留在最后一帧\n- backwards: 让动画停留在第一帧\n- both: 根据`animation-direction`控制使用`forwards`或者`backwards`。\n\n### 动画播放次数\n\n`animation-iteration-count`属性控制动画播放次数，默认为`1次`, 设置`infinite`表示无限循环播放。\n\n\n### 动画插值函数\n\n`animation-timing-function`控制动画插值函数，和`transition-timing-function`类似。\n\n### 控制动画状态\n\n`animation-play-state`属性用于控制动画播放的状态，默认情况，自动开始播放，通过设置该属性，可以控制动画播放。\n\n看一个`demo`\n\n{% jsfiddle 2Law411w css,result light 100% 400px %}\n\n只有鼠标移动到方块上的时候动画才会继续播放。\n\n---\n\n参考文献：\n\n- [CSS动画简介](http://www.ruanyifeng.com/blog/2014/02/css_transition_and_animation.html)\n- [W3C css animation](https://www.w3.org/TR/css3-animations/)","source":"_posts/CSS-动画详解.md","raw":"---\ntitle: CSS-动画详解\ndate: 2016-09-30 10:16:04\ntags: \n - transition \n - animation\ncategories: web\n---\n\n\n# `CSS`动画详解\n\n`CSS animation`使用十分广泛，特此来做一个详细的总结。\n\n---\n\n## 通过`transiton`属性控制动画\n\n基本语法：\n\n`transition: width 2s 1s ease;` `width`属性受到动画影响，动画持续时间为`2s`，动画延迟`1s`播出，动画插值算法采用`ease`。多个属性可以用逗号分隔。例如：`transition: width 2s, height 1s;`。\n\n\n`transiton`控制动画应该是最简单的方式之一了，和其他属性类似`transiton`也是一个复合属性由以下几个属性组成：\n\n- transiton-delay: 动画延时播放，默认为0\n- transiton-timing-function: 动画插值函数,默认为`ease`\n- transiton-property: 指明要发生变化的属性\n- transiton-duration: 指明动画周期(持续时间),默认为0\n\n### 动画延时\n\n  看一个`demo`,子元素宽度从0到填充父控件，延时`1s`。\n{% jsfiddle fnao3q2t css,result light 100% 400px %}\n\n鼠标进入和离开控件的时候都有`1s`延迟,这就是`transiton-delay`的效果。\n\n### 动画速度变更函数(插值函数)\n\n  `transiton-timing-function`属性用于改变动画的速度曲线。可选值有：\n\n- ease：默认参数\n- linear\n- ease-in\n- ease-out\n- ease-in-out\n- cubic-bezier\n\n关于插值函数对应的效果可以[看这里](http://easings.net/zh-cn)。\n\n说说`cubic-bezier`,由于`css`内值动画曲线比较有限，所以可以根据`cubic-bezier`规划一条贝赛尔曲线。\n{% jsfiddle k3jtsn9v css,result light 100% 400px %}\n\n推荐一个贝塞尔曲线在线编辑器：[`cubic-bezier`](http://cubic-bezier.com)。\n\n### 动画属性\n\n顾名思义，设置受到动画影响的属性。如果所有属性都受到影响，可以指定一个`all`参数。需要注意的是，`css`规定一些属性不受`transiton`影响，例如：`display`等。具体看`W3C`上[一个对应表](https://www.w3.org/TR/css3-transitions/#animatable-properties)。值得一提的是，`display`属性虽然不受影响，但是`visibility`属性会受影响。\n\n\n### 动画持续时间\n\n设置动画延迟播放时间，*注意默认为0*，除了以`s`为单位，也可以以`ms`为单位。\n\n\n>`transition`属性虽然使用方便，但是也有它的局限性:\n\n- 动画需要事件触发，无法自动播放\n- 无法重复播放，除非一直触发\n- 无法为多个属性指定同样的变化规则(写起来比较麻烦)\n- 只能控制开始和结束状态、无法定义中间态\n\n---\n\n\n## 通过`animation`属性控制动画\n\n和`transition`类似，`animation`也是一个复合属性。它提供了比较多的属性来控制动画，从而实现更加细致的控制。\n\n基本格式：\n\n`@keyframes`关键字用于定义动画的细节，比例动画名称，动画在某一时刻的状态属性值等。\n\n```css\n@keyframes anim {\n  from: {background: red;}\n  to: {background: blue;}\n}\n```\n\n上面一段`css`定义了一个动画，名称为`anim`,动画从背景红色过渡到背景蓝色，`from`表示起始时刻动画状态，`to`表示结束时刻动画状态。还可以换成百分比的形式从`0%`到`100%`。\n从而实现了在不同时刻控制动画状态的目的。\n\n{% jsfiddle Lhpfxbrm css,result light 100% 400px %}\n\n---\n\n基本属性：\n\n- animation-duration\n- animation-direction\n- animation-delay\n- animation-name\n- animation-iteration-count\n- animation-timing-function\n- animation-play-state\n- animation-fill-mode\n\n### 动画时长\n\n`animation-duration`和`transition-duration`类似，不做过多介绍，用于控制动画的时间长度。\n\n### 动画播放延时\n\n`animation-delay`和`transition-delay`类似控制动画首次播放的延时。\n\n### 动画名称\n\n`animation-name`指定元素引用哪个动画，名称通过`@keyframes`指定。\n\n### 动画方向\n\n`animation-direction`控制动画循环播放的时候状态的变更次序。看个`demo`:\n\n{% jsfiddle Lhpfxbrm css,result light 100% 400px %}\n\n可选的属性：\n\n- normal: 每次都从起始状态变更到终止状态\n- reverse: 每次都从终止状态变更到起始状态\n- alternate: 奇数次从起始状态变更到结束状态、偶数次从结束状态变更到起始状态\n- alternate-reverse: 与`alternate`相反\n\n### 动画结束的状态\n\n`animation-fill-mode`属性控制动画结束播放时候的状态，看个`demo`：\n\n{% jsfiddle geLw2de5 css,result light 100% 400px %}\n\n- forwards: 让动画停留在最后一帧\n- backwards: 让动画停留在第一帧\n- both: 根据`animation-direction`控制使用`forwards`或者`backwards`。\n\n### 动画播放次数\n\n`animation-iteration-count`属性控制动画播放次数，默认为`1次`, 设置`infinite`表示无限循环播放。\n\n\n### 动画插值函数\n\n`animation-timing-function`控制动画插值函数，和`transition-timing-function`类似。\n\n### 控制动画状态\n\n`animation-play-state`属性用于控制动画播放的状态，默认情况，自动开始播放，通过设置该属性，可以控制动画播放。\n\n看一个`demo`\n\n{% jsfiddle 2Law411w css,result light 100% 400px %}\n\n只有鼠标移动到方块上的时候动画才会继续播放。\n\n---\n\n参考文献：\n\n- [CSS动画简介](http://www.ruanyifeng.com/blog/2014/02/css_transition_and_animation.html)\n- [W3C css animation](https://www.w3.org/TR/css3-animations/)","slug":"CSS-动画详解","published":1,"updated":"2018-11-25T11:19:46.041Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9ccp0007y4zvccyc7k7e","content":"<h1 id=\"CSS动画详解\"><a href=\"#CSS动画详解\" class=\"headerlink\" title=\"CSS动画详解\"></a><code>CSS</code>动画详解</h1><p><code>CSS animation</code>使用十分广泛，特此来做一个详细的总结。</p>\n<hr>\n<h2 id=\"通过transiton属性控制动画\"><a href=\"#通过transiton属性控制动画\" class=\"headerlink\" title=\"通过transiton属性控制动画\"></a>通过<code>transiton</code>属性控制动画</h2><p>基本语法：</p>\n<p><code>transition: width 2s 1s ease;</code> <code>width</code>属性受到动画影响，动画持续时间为<code>2s</code>，动画延迟<code>1s</code>播出，动画插值算法采用<code>ease</code>。多个属性可以用逗号分隔。例如：<code>transition: width 2s, height 1s;</code>。</p>\n<p><code>transiton</code>控制动画应该是最简单的方式之一了，和其他属性类似<code>transiton</code>也是一个复合属性由以下几个属性组成：</p>\n<ul>\n<li>transiton-delay: 动画延时播放，默认为0</li>\n<li>transiton-timing-function: 动画插值函数,默认为<code>ease</code></li>\n<li>transiton-property: 指明要发生变化的属性</li>\n<li>transiton-duration: 指明动画周期(持续时间),默认为0</li>\n</ul>\n<h3 id=\"动画延时\"><a href=\"#动画延时\" class=\"headerlink\" title=\"动画延时\"></a>动画延时</h3><p>  看一个<code>demo</code>,子元素宽度从0到填充父控件，延时<code>1s</code>。<br><iframe scrolling=\"no\" width=\"100%\" height=\"400px\" src=\"//jsfiddle.net/fnao3q2t/embedded/css,result/light\" frameborder=\"0\" allowfullscreen></iframe></p>\n<p>鼠标进入和离开控件的时候都有<code>1s</code>延迟,这就是<code>transiton-delay</code>的效果。</p>\n<h3 id=\"动画速度变更函数-插值函数\"><a href=\"#动画速度变更函数-插值函数\" class=\"headerlink\" title=\"动画速度变更函数(插值函数)\"></a>动画速度变更函数(插值函数)</h3><p>  <code>transiton-timing-function</code>属性用于改变动画的速度曲线。可选值有：</p>\n<ul>\n<li>ease：默认参数</li>\n<li>linear</li>\n<li>ease-in</li>\n<li>ease-out</li>\n<li>ease-in-out</li>\n<li>cubic-bezier</li>\n</ul>\n<p>关于插值函数对应的效果可以<a href=\"http://easings.net/zh-cn\" target=\"_blank\" rel=\"noopener\">看这里</a>。</p>\n<p>说说<code>cubic-bezier</code>,由于<code>css</code>内值动画曲线比较有限，所以可以根据<code>cubic-bezier</code>规划一条贝赛尔曲线。<br><iframe scrolling=\"no\" width=\"100%\" height=\"400px\" src=\"//jsfiddle.net/k3jtsn9v/embedded/css,result/light\" frameborder=\"0\" allowfullscreen></iframe></p>\n<p>推荐一个贝塞尔曲线在线编辑器：<a href=\"http://cubic-bezier.com\" target=\"_blank\" rel=\"noopener\"><code>cubic-bezier</code></a>。</p>\n<h3 id=\"动画属性\"><a href=\"#动画属性\" class=\"headerlink\" title=\"动画属性\"></a>动画属性</h3><p>顾名思义，设置受到动画影响的属性。如果所有属性都受到影响，可以指定一个<code>all</code>参数。需要注意的是，<code>css</code>规定一些属性不受<code>transiton</code>影响，例如：<code>display</code>等。具体看<code>W3C</code>上<a href=\"https://www.w3.org/TR/css3-transitions/#animatable-properties\" target=\"_blank\" rel=\"noopener\">一个对应表</a>。值得一提的是，<code>display</code>属性虽然不受影响，但是<code>visibility</code>属性会受影响。</p>\n<h3 id=\"动画持续时间\"><a href=\"#动画持续时间\" class=\"headerlink\" title=\"动画持续时间\"></a>动画持续时间</h3><p>设置动画延迟播放时间，<em>注意默认为0</em>，除了以<code>s</code>为单位，也可以以<code>ms</code>为单位。</p>\n<blockquote>\n<p><code>transition</code>属性虽然使用方便，但是也有它的局限性:</p>\n</blockquote>\n<ul>\n<li>动画需要事件触发，无法自动播放</li>\n<li>无法重复播放，除非一直触发</li>\n<li>无法为多个属性指定同样的变化规则(写起来比较麻烦)</li>\n<li>只能控制开始和结束状态、无法定义中间态</li>\n</ul>\n<hr>\n<h2 id=\"通过animation属性控制动画\"><a href=\"#通过animation属性控制动画\" class=\"headerlink\" title=\"通过animation属性控制动画\"></a>通过<code>animation</code>属性控制动画</h2><p>和<code>transition</code>类似，<code>animation</code>也是一个复合属性。它提供了比较多的属性来控制动画，从而实现更加细致的控制。</p>\n<p>基本格式：</p>\n<p><code>@keyframes</code>关键字用于定义动画的细节，比例动画名称，动画在某一时刻的状态属性值等。</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@<span class=\"keyword\">keyframes</span> anim &#123;</span><br><span class=\"line\">  <span class=\"selector-tag\">from</span>: &#123;<span class=\"attribute\">background</span>: red;&#125;</span><br><span class=\"line\">  <span class=\"selector-tag\">to</span>: &#123;<span class=\"attribute\">background</span>: blue;&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>上面一段<code>css</code>定义了一个动画，名称为<code>anim</code>,动画从背景红色过渡到背景蓝色，<code>from</code>表示起始时刻动画状态，<code>to</code>表示结束时刻动画状态。还可以换成百分比的形式从<code>0%</code>到<code>100%</code>。<br>从而实现了在不同时刻控制动画状态的目的。</p>\n<iframe scrolling=\"no\" width=\"100%\" height=\"400px\" src=\"//jsfiddle.net/Lhpfxbrm/embedded/css,result/light\" frameborder=\"0\" allowfullscreen></iframe>\n<hr>\n<p>基本属性：</p>\n<ul>\n<li>animation-duration</li>\n<li>animation-direction</li>\n<li>animation-delay</li>\n<li>animation-name</li>\n<li>animation-iteration-count</li>\n<li>animation-timing-function</li>\n<li>animation-play-state</li>\n<li>animation-fill-mode</li>\n</ul>\n<h3 id=\"动画时长\"><a href=\"#动画时长\" class=\"headerlink\" title=\"动画时长\"></a>动画时长</h3><p><code>animation-duration</code>和<code>transition-duration</code>类似，不做过多介绍，用于控制动画的时间长度。</p>\n<h3 id=\"动画播放延时\"><a href=\"#动画播放延时\" class=\"headerlink\" title=\"动画播放延时\"></a>动画播放延时</h3><p><code>animation-delay</code>和<code>transition-delay</code>类似控制动画首次播放的延时。</p>\n<h3 id=\"动画名称\"><a href=\"#动画名称\" class=\"headerlink\" title=\"动画名称\"></a>动画名称</h3><p><code>animation-name</code>指定元素引用哪个动画，名称通过<code>@keyframes</code>指定。</p>\n<h3 id=\"动画方向\"><a href=\"#动画方向\" class=\"headerlink\" title=\"动画方向\"></a>动画方向</h3><p><code>animation-direction</code>控制动画循环播放的时候状态的变更次序。看个<code>demo</code>:</p>\n<iframe scrolling=\"no\" width=\"100%\" height=\"400px\" src=\"//jsfiddle.net/Lhpfxbrm/embedded/css,result/light\" frameborder=\"0\" allowfullscreen></iframe>\n<p>可选的属性：</p>\n<ul>\n<li>normal: 每次都从起始状态变更到终止状态</li>\n<li>reverse: 每次都从终止状态变更到起始状态</li>\n<li>alternate: 奇数次从起始状态变更到结束状态、偶数次从结束状态变更到起始状态</li>\n<li>alternate-reverse: 与<code>alternate</code>相反</li>\n</ul>\n<h3 id=\"动画结束的状态\"><a href=\"#动画结束的状态\" class=\"headerlink\" title=\"动画结束的状态\"></a>动画结束的状态</h3><p><code>animation-fill-mode</code>属性控制动画结束播放时候的状态，看个<code>demo</code>：</p>\n<iframe scrolling=\"no\" width=\"100%\" height=\"400px\" src=\"//jsfiddle.net/geLw2de5/embedded/css,result/light\" frameborder=\"0\" allowfullscreen></iframe>\n<ul>\n<li>forwards: 让动画停留在最后一帧</li>\n<li>backwards: 让动画停留在第一帧</li>\n<li>both: 根据<code>animation-direction</code>控制使用<code>forwards</code>或者<code>backwards</code>。</li>\n</ul>\n<h3 id=\"动画播放次数\"><a href=\"#动画播放次数\" class=\"headerlink\" title=\"动画播放次数\"></a>动画播放次数</h3><p><code>animation-iteration-count</code>属性控制动画播放次数，默认为<code>1次</code>, 设置<code>infinite</code>表示无限循环播放。</p>\n<h3 id=\"动画插值函数\"><a href=\"#动画插值函数\" class=\"headerlink\" title=\"动画插值函数\"></a>动画插值函数</h3><p><code>animation-timing-function</code>控制动画插值函数，和<code>transition-timing-function</code>类似。</p>\n<h3 id=\"控制动画状态\"><a href=\"#控制动画状态\" class=\"headerlink\" title=\"控制动画状态\"></a>控制动画状态</h3><p><code>animation-play-state</code>属性用于控制动画播放的状态，默认情况，自动开始播放，通过设置该属性，可以控制动画播放。</p>\n<p>看一个<code>demo</code></p>\n<iframe scrolling=\"no\" width=\"100%\" height=\"400px\" src=\"//jsfiddle.net/2Law411w/embedded/css,result/light\" frameborder=\"0\" allowfullscreen></iframe>\n<p>只有鼠标移动到方块上的时候动画才会继续播放。</p>\n<hr>\n<p>参考文献：</p>\n<ul>\n<li><a href=\"http://www.ruanyifeng.com/blog/2014/02/css_transition_and_animation.html\" target=\"_blank\" rel=\"noopener\">CSS动画简介</a></li>\n<li><a href=\"https://www.w3.org/TR/css3-animations/\" target=\"_blank\" rel=\"noopener\">W3C css animation</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"CSS动画详解\"><a href=\"#CSS动画详解\" class=\"headerlink\" title=\"CSS动画详解\"></a><code>CSS</code>动画详解</h1><p><code>CSS animation</code>使用十分广泛，特此来做一个详细的总结。</p>\n<hr>\n<h2 id=\"通过transiton属性控制动画\"><a href=\"#通过transiton属性控制动画\" class=\"headerlink\" title=\"通过transiton属性控制动画\"></a>通过<code>transiton</code>属性控制动画</h2><p>基本语法：</p>\n<p><code>transition: width 2s 1s ease;</code> <code>width</code>属性受到动画影响，动画持续时间为<code>2s</code>，动画延迟<code>1s</code>播出，动画插值算法采用<code>ease</code>。多个属性可以用逗号分隔。例如：<code>transition: width 2s, height 1s;</code>。</p>\n<p><code>transiton</code>控制动画应该是最简单的方式之一了，和其他属性类似<code>transiton</code>也是一个复合属性由以下几个属性组成：</p>\n<ul>\n<li>transiton-delay: 动画延时播放，默认为0</li>\n<li>transiton-timing-function: 动画插值函数,默认为<code>ease</code></li>\n<li>transiton-property: 指明要发生变化的属性</li>\n<li>transiton-duration: 指明动画周期(持续时间),默认为0</li>\n</ul>\n<h3 id=\"动画延时\"><a href=\"#动画延时\" class=\"headerlink\" title=\"动画延时\"></a>动画延时</h3><p>  看一个<code>demo</code>,子元素宽度从0到填充父控件，延时<code>1s</code>。<br><iframe scrolling=\"no\" width=\"100%\" height=\"400px\" src=\"//jsfiddle.net/fnao3q2t/embedded/css,result/light\" frameborder=\"0\" allowfullscreen></iframe></p>\n<p>鼠标进入和离开控件的时候都有<code>1s</code>延迟,这就是<code>transiton-delay</code>的效果。</p>\n<h3 id=\"动画速度变更函数-插值函数\"><a href=\"#动画速度变更函数-插值函数\" class=\"headerlink\" title=\"动画速度变更函数(插值函数)\"></a>动画速度变更函数(插值函数)</h3><p>  <code>transiton-timing-function</code>属性用于改变动画的速度曲线。可选值有：</p>\n<ul>\n<li>ease：默认参数</li>\n<li>linear</li>\n<li>ease-in</li>\n<li>ease-out</li>\n<li>ease-in-out</li>\n<li>cubic-bezier</li>\n</ul>\n<p>关于插值函数对应的效果可以<a href=\"http://easings.net/zh-cn\" target=\"_blank\" rel=\"noopener\">看这里</a>。</p>\n<p>说说<code>cubic-bezier</code>,由于<code>css</code>内值动画曲线比较有限，所以可以根据<code>cubic-bezier</code>规划一条贝赛尔曲线。<br><iframe scrolling=\"no\" width=\"100%\" height=\"400px\" src=\"//jsfiddle.net/k3jtsn9v/embedded/css,result/light\" frameborder=\"0\" allowfullscreen></iframe></p>\n<p>推荐一个贝塞尔曲线在线编辑器：<a href=\"http://cubic-bezier.com\" target=\"_blank\" rel=\"noopener\"><code>cubic-bezier</code></a>。</p>\n<h3 id=\"动画属性\"><a href=\"#动画属性\" class=\"headerlink\" title=\"动画属性\"></a>动画属性</h3><p>顾名思义，设置受到动画影响的属性。如果所有属性都受到影响，可以指定一个<code>all</code>参数。需要注意的是，<code>css</code>规定一些属性不受<code>transiton</code>影响，例如：<code>display</code>等。具体看<code>W3C</code>上<a href=\"https://www.w3.org/TR/css3-transitions/#animatable-properties\" target=\"_blank\" rel=\"noopener\">一个对应表</a>。值得一提的是，<code>display</code>属性虽然不受影响，但是<code>visibility</code>属性会受影响。</p>\n<h3 id=\"动画持续时间\"><a href=\"#动画持续时间\" class=\"headerlink\" title=\"动画持续时间\"></a>动画持续时间</h3><p>设置动画延迟播放时间，<em>注意默认为0</em>，除了以<code>s</code>为单位，也可以以<code>ms</code>为单位。</p>\n<blockquote>\n<p><code>transition</code>属性虽然使用方便，但是也有它的局限性:</p>\n</blockquote>\n<ul>\n<li>动画需要事件触发，无法自动播放</li>\n<li>无法重复播放，除非一直触发</li>\n<li>无法为多个属性指定同样的变化规则(写起来比较麻烦)</li>\n<li>只能控制开始和结束状态、无法定义中间态</li>\n</ul>\n<hr>\n<h2 id=\"通过animation属性控制动画\"><a href=\"#通过animation属性控制动画\" class=\"headerlink\" title=\"通过animation属性控制动画\"></a>通过<code>animation</code>属性控制动画</h2><p>和<code>transition</code>类似，<code>animation</code>也是一个复合属性。它提供了比较多的属性来控制动画，从而实现更加细致的控制。</p>\n<p>基本格式：</p>\n<p><code>@keyframes</code>关键字用于定义动画的细节，比例动画名称，动画在某一时刻的状态属性值等。</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@<span class=\"keyword\">keyframes</span> anim &#123;</span><br><span class=\"line\">  <span class=\"selector-tag\">from</span>: &#123;<span class=\"attribute\">background</span>: red;&#125;</span><br><span class=\"line\">  <span class=\"selector-tag\">to</span>: &#123;<span class=\"attribute\">background</span>: blue;&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>上面一段<code>css</code>定义了一个动画，名称为<code>anim</code>,动画从背景红色过渡到背景蓝色，<code>from</code>表示起始时刻动画状态，<code>to</code>表示结束时刻动画状态。还可以换成百分比的形式从<code>0%</code>到<code>100%</code>。<br>从而实现了在不同时刻控制动画状态的目的。</p>\n<iframe scrolling=\"no\" width=\"100%\" height=\"400px\" src=\"//jsfiddle.net/Lhpfxbrm/embedded/css,result/light\" frameborder=\"0\" allowfullscreen></iframe>\n<hr>\n<p>基本属性：</p>\n<ul>\n<li>animation-duration</li>\n<li>animation-direction</li>\n<li>animation-delay</li>\n<li>animation-name</li>\n<li>animation-iteration-count</li>\n<li>animation-timing-function</li>\n<li>animation-play-state</li>\n<li>animation-fill-mode</li>\n</ul>\n<h3 id=\"动画时长\"><a href=\"#动画时长\" class=\"headerlink\" title=\"动画时长\"></a>动画时长</h3><p><code>animation-duration</code>和<code>transition-duration</code>类似，不做过多介绍，用于控制动画的时间长度。</p>\n<h3 id=\"动画播放延时\"><a href=\"#动画播放延时\" class=\"headerlink\" title=\"动画播放延时\"></a>动画播放延时</h3><p><code>animation-delay</code>和<code>transition-delay</code>类似控制动画首次播放的延时。</p>\n<h3 id=\"动画名称\"><a href=\"#动画名称\" class=\"headerlink\" title=\"动画名称\"></a>动画名称</h3><p><code>animation-name</code>指定元素引用哪个动画，名称通过<code>@keyframes</code>指定。</p>\n<h3 id=\"动画方向\"><a href=\"#动画方向\" class=\"headerlink\" title=\"动画方向\"></a>动画方向</h3><p><code>animation-direction</code>控制动画循环播放的时候状态的变更次序。看个<code>demo</code>:</p>\n<iframe scrolling=\"no\" width=\"100%\" height=\"400px\" src=\"//jsfiddle.net/Lhpfxbrm/embedded/css,result/light\" frameborder=\"0\" allowfullscreen></iframe>\n<p>可选的属性：</p>\n<ul>\n<li>normal: 每次都从起始状态变更到终止状态</li>\n<li>reverse: 每次都从终止状态变更到起始状态</li>\n<li>alternate: 奇数次从起始状态变更到结束状态、偶数次从结束状态变更到起始状态</li>\n<li>alternate-reverse: 与<code>alternate</code>相反</li>\n</ul>\n<h3 id=\"动画结束的状态\"><a href=\"#动画结束的状态\" class=\"headerlink\" title=\"动画结束的状态\"></a>动画结束的状态</h3><p><code>animation-fill-mode</code>属性控制动画结束播放时候的状态，看个<code>demo</code>：</p>\n<iframe scrolling=\"no\" width=\"100%\" height=\"400px\" src=\"//jsfiddle.net/geLw2de5/embedded/css,result/light\" frameborder=\"0\" allowfullscreen></iframe>\n<ul>\n<li>forwards: 让动画停留在最后一帧</li>\n<li>backwards: 让动画停留在第一帧</li>\n<li>both: 根据<code>animation-direction</code>控制使用<code>forwards</code>或者<code>backwards</code>。</li>\n</ul>\n<h3 id=\"动画播放次数\"><a href=\"#动画播放次数\" class=\"headerlink\" title=\"动画播放次数\"></a>动画播放次数</h3><p><code>animation-iteration-count</code>属性控制动画播放次数，默认为<code>1次</code>, 设置<code>infinite</code>表示无限循环播放。</p>\n<h3 id=\"动画插值函数\"><a href=\"#动画插值函数\" class=\"headerlink\" title=\"动画插值函数\"></a>动画插值函数</h3><p><code>animation-timing-function</code>控制动画插值函数，和<code>transition-timing-function</code>类似。</p>\n<h3 id=\"控制动画状态\"><a href=\"#控制动画状态\" class=\"headerlink\" title=\"控制动画状态\"></a>控制动画状态</h3><p><code>animation-play-state</code>属性用于控制动画播放的状态，默认情况，自动开始播放，通过设置该属性，可以控制动画播放。</p>\n<p>看一个<code>demo</code></p>\n<iframe scrolling=\"no\" width=\"100%\" height=\"400px\" src=\"//jsfiddle.net/2Law411w/embedded/css,result/light\" frameborder=\"0\" allowfullscreen></iframe>\n<p>只有鼠标移动到方块上的时候动画才会继续播放。</p>\n<hr>\n<p>参考文献：</p>\n<ul>\n<li><a href=\"http://www.ruanyifeng.com/blog/2014/02/css_transition_and_animation.html\" target=\"_blank\" rel=\"noopener\">CSS动画简介</a></li>\n<li><a href=\"https://www.w3.org/TR/css3-animations/\" target=\"_blank\" rel=\"noopener\">W3C css animation</a></li>\n</ul>\n"},{"title":"CSSMastery读书笔记(一)","date":"2016-08-20T07:04:29.000Z","_content":"\n\n# 基础知识\n\n## 1、语义化编程\n\n>`html`每个标签都有特殊含义，不建议混乱使用标签，这样有利于搜索引擎抓取页面信息，以及更好的维护代码。\n\n## 2、HTML4和HTML5\n\n>`html4`提供了一些简单的文档标记元素，而`html5`在此基础之上提供更多的元素如：`header`、`nav`等，满足`web`页面的`UI`特性。\n\n## 3、元素类以及`id`\n\n>类命名应该根据元素`是什么`而不是元素的外观来命名、类名和`id`区分大小写，最好的方式是使用连接符号把单词分隔。\n\n## 4、多类症以及多`div`症\n\n> 应该谨慎的使用类名、例如一些元素的样式可以通过使用选择器来设置，而不用为每个元素都设置一个类。`div`元素的语义表示一个区域、一块。对于一些不需要`div`包装的元素则不应该使用`div`，\n譬如说：`nav`元素构建一个导航条，里面多个`li`元素构成的条目，此时不需要用`div`来把`nav`包装起来。\n\n## 5、微格式\n\n>微格式解决了`html`元素不能表示特定信息的缺点：如`日期`等。\n\n## 6、`html`与`xhtml`\n\n>1999发布了`html4.01`而对应的`xml`版本为`xhtml1.0`,两个差异在于\n- xml元素属性必须用引号包裹\n- xml元素必须封闭\n\n## 7、DOCTYPE的作用\n\n>web页面都会有一个`DOCTYPE`声明，浏览器根据其来了解使用哪个版本的`DTD`来解析页面，由此也知道使用的是哪个版本的`html`。\n`DTD`又分为严格模式和过渡模式，严格模式不允许使用已经废弃的元素如`font`等，而过渡模式有助于引导开发者过渡到新版本的`html`。\n总结一下`DOCTYPE`声明的作用：\n- 浏览器验证页面的有效性\n- 浏览器模式切换(标准/混杂)实现向后兼容","source":"_posts/CSSMastery读书笔记一-基础知识.md","raw":"---\ntitle: CSSMastery读书笔记(一)\ndate: 2016-08-20 15:04:29\ntags: css-mastery\ncategories: web\n---\n\n\n# 基础知识\n\n## 1、语义化编程\n\n>`html`每个标签都有特殊含义，不建议混乱使用标签，这样有利于搜索引擎抓取页面信息，以及更好的维护代码。\n\n## 2、HTML4和HTML5\n\n>`html4`提供了一些简单的文档标记元素，而`html5`在此基础之上提供更多的元素如：`header`、`nav`等，满足`web`页面的`UI`特性。\n\n## 3、元素类以及`id`\n\n>类命名应该根据元素`是什么`而不是元素的外观来命名、类名和`id`区分大小写，最好的方式是使用连接符号把单词分隔。\n\n## 4、多类症以及多`div`症\n\n> 应该谨慎的使用类名、例如一些元素的样式可以通过使用选择器来设置，而不用为每个元素都设置一个类。`div`元素的语义表示一个区域、一块。对于一些不需要`div`包装的元素则不应该使用`div`，\n譬如说：`nav`元素构建一个导航条，里面多个`li`元素构成的条目，此时不需要用`div`来把`nav`包装起来。\n\n## 5、微格式\n\n>微格式解决了`html`元素不能表示特定信息的缺点：如`日期`等。\n\n## 6、`html`与`xhtml`\n\n>1999发布了`html4.01`而对应的`xml`版本为`xhtml1.0`,两个差异在于\n- xml元素属性必须用引号包裹\n- xml元素必须封闭\n\n## 7、DOCTYPE的作用\n\n>web页面都会有一个`DOCTYPE`声明，浏览器根据其来了解使用哪个版本的`DTD`来解析页面，由此也知道使用的是哪个版本的`html`。\n`DTD`又分为严格模式和过渡模式，严格模式不允许使用已经废弃的元素如`font`等，而过渡模式有助于引导开发者过渡到新版本的`html`。\n总结一下`DOCTYPE`声明的作用：\n- 浏览器验证页面的有效性\n- 浏览器模式切换(标准/混杂)实现向后兼容","slug":"CSSMastery读书笔记一-基础知识","published":1,"updated":"2018-07-01T10:30:46.492Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9ccr0009y4zvz04m0dva","content":"<h1 id=\"基础知识\"><a href=\"#基础知识\" class=\"headerlink\" title=\"基础知识\"></a>基础知识</h1><h2 id=\"1、语义化编程\"><a href=\"#1、语义化编程\" class=\"headerlink\" title=\"1、语义化编程\"></a>1、语义化编程</h2><blockquote>\n<p><code>html</code>每个标签都有特殊含义，不建议混乱使用标签，这样有利于搜索引擎抓取页面信息，以及更好的维护代码。</p>\n</blockquote>\n<h2 id=\"2、HTML4和HTML5\"><a href=\"#2、HTML4和HTML5\" class=\"headerlink\" title=\"2、HTML4和HTML5\"></a>2、HTML4和HTML5</h2><blockquote>\n<p><code>html4</code>提供了一些简单的文档标记元素，而<code>html5</code>在此基础之上提供更多的元素如：<code>header</code>、<code>nav</code>等，满足<code>web</code>页面的<code>UI</code>特性。</p>\n</blockquote>\n<h2 id=\"3、元素类以及id\"><a href=\"#3、元素类以及id\" class=\"headerlink\" title=\"3、元素类以及id\"></a>3、元素类以及<code>id</code></h2><blockquote>\n<p>类命名应该根据元素<code>是什么</code>而不是元素的外观来命名、类名和<code>id</code>区分大小写，最好的方式是使用连接符号把单词分隔。</p>\n</blockquote>\n<h2 id=\"4、多类症以及多div症\"><a href=\"#4、多类症以及多div症\" class=\"headerlink\" title=\"4、多类症以及多div症\"></a>4、多类症以及多<code>div</code>症</h2><blockquote>\n<p>应该谨慎的使用类名、例如一些元素的样式可以通过使用选择器来设置，而不用为每个元素都设置一个类。<code>div</code>元素的语义表示一个区域、一块。对于一些不需要<code>div</code>包装的元素则不应该使用<code>div</code>，<br>譬如说：<code>nav</code>元素构建一个导航条，里面多个<code>li</code>元素构成的条目，此时不需要用<code>div</code>来把<code>nav</code>包装起来。</p>\n</blockquote>\n<h2 id=\"5、微格式\"><a href=\"#5、微格式\" class=\"headerlink\" title=\"5、微格式\"></a>5、微格式</h2><blockquote>\n<p>微格式解决了<code>html</code>元素不能表示特定信息的缺点：如<code>日期</code>等。</p>\n</blockquote>\n<h2 id=\"6、html与xhtml\"><a href=\"#6、html与xhtml\" class=\"headerlink\" title=\"6、html与xhtml\"></a>6、<code>html</code>与<code>xhtml</code></h2><blockquote>\n<p>1999发布了<code>html4.01</code>而对应的<code>xml</code>版本为<code>xhtml1.0</code>,两个差异在于</p>\n<ul>\n<li>xml元素属性必须用引号包裹</li>\n<li>xml元素必须封闭</li>\n</ul>\n</blockquote>\n<h2 id=\"7、DOCTYPE的作用\"><a href=\"#7、DOCTYPE的作用\" class=\"headerlink\" title=\"7、DOCTYPE的作用\"></a>7、DOCTYPE的作用</h2><blockquote>\n<p>web页面都会有一个<code>DOCTYPE</code>声明，浏览器根据其来了解使用哪个版本的<code>DTD</code>来解析页面，由此也知道使用的是哪个版本的<code>html</code>。<br><code>DTD</code>又分为严格模式和过渡模式，严格模式不允许使用已经废弃的元素如<code>font</code>等，而过渡模式有助于引导开发者过渡到新版本的<code>html</code>。<br>总结一下<code>DOCTYPE</code>声明的作用：</p>\n<ul>\n<li>浏览器验证页面的有效性</li>\n<li>浏览器模式切换(标准/混杂)实现向后兼容</li>\n</ul>\n</blockquote>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"基础知识\"><a href=\"#基础知识\" class=\"headerlink\" title=\"基础知识\"></a>基础知识</h1><h2 id=\"1、语义化编程\"><a href=\"#1、语义化编程\" class=\"headerlink\" title=\"1、语义化编程\"></a>1、语义化编程</h2><blockquote>\n<p><code>html</code>每个标签都有特殊含义，不建议混乱使用标签，这样有利于搜索引擎抓取页面信息，以及更好的维护代码。</p>\n</blockquote>\n<h2 id=\"2、HTML4和HTML5\"><a href=\"#2、HTML4和HTML5\" class=\"headerlink\" title=\"2、HTML4和HTML5\"></a>2、HTML4和HTML5</h2><blockquote>\n<p><code>html4</code>提供了一些简单的文档标记元素，而<code>html5</code>在此基础之上提供更多的元素如：<code>header</code>、<code>nav</code>等，满足<code>web</code>页面的<code>UI</code>特性。</p>\n</blockquote>\n<h2 id=\"3、元素类以及id\"><a href=\"#3、元素类以及id\" class=\"headerlink\" title=\"3、元素类以及id\"></a>3、元素类以及<code>id</code></h2><blockquote>\n<p>类命名应该根据元素<code>是什么</code>而不是元素的外观来命名、类名和<code>id</code>区分大小写，最好的方式是使用连接符号把单词分隔。</p>\n</blockquote>\n<h2 id=\"4、多类症以及多div症\"><a href=\"#4、多类症以及多div症\" class=\"headerlink\" title=\"4、多类症以及多div症\"></a>4、多类症以及多<code>div</code>症</h2><blockquote>\n<p>应该谨慎的使用类名、例如一些元素的样式可以通过使用选择器来设置，而不用为每个元素都设置一个类。<code>div</code>元素的语义表示一个区域、一块。对于一些不需要<code>div</code>包装的元素则不应该使用<code>div</code>，<br>譬如说：<code>nav</code>元素构建一个导航条，里面多个<code>li</code>元素构成的条目，此时不需要用<code>div</code>来把<code>nav</code>包装起来。</p>\n</blockquote>\n<h2 id=\"5、微格式\"><a href=\"#5、微格式\" class=\"headerlink\" title=\"5、微格式\"></a>5、微格式</h2><blockquote>\n<p>微格式解决了<code>html</code>元素不能表示特定信息的缺点：如<code>日期</code>等。</p>\n</blockquote>\n<h2 id=\"6、html与xhtml\"><a href=\"#6、html与xhtml\" class=\"headerlink\" title=\"6、html与xhtml\"></a>6、<code>html</code>与<code>xhtml</code></h2><blockquote>\n<p>1999发布了<code>html4.01</code>而对应的<code>xml</code>版本为<code>xhtml1.0</code>,两个差异在于</p>\n<ul>\n<li>xml元素属性必须用引号包裹</li>\n<li>xml元素必须封闭</li>\n</ul>\n</blockquote>\n<h2 id=\"7、DOCTYPE的作用\"><a href=\"#7、DOCTYPE的作用\" class=\"headerlink\" title=\"7、DOCTYPE的作用\"></a>7、DOCTYPE的作用</h2><blockquote>\n<p>web页面都会有一个<code>DOCTYPE</code>声明，浏览器根据其来了解使用哪个版本的<code>DTD</code>来解析页面，由此也知道使用的是哪个版本的<code>html</code>。<br><code>DTD</code>又分为严格模式和过渡模式，严格模式不允许使用已经废弃的元素如<code>font</code>等，而过渡模式有助于引导开发者过渡到新版本的<code>html</code>。<br>总结一下<code>DOCTYPE</code>声明的作用：</p>\n<ul>\n<li>浏览器验证页面的有效性</li>\n<li>浏览器模式切换(标准/混杂)实现向后兼容</li>\n</ul>\n</blockquote>\n"},{"title":"CSSMastery读书笔记三-可视化格式模型","date":"2016-08-22T07:28:32.000Z","_content":"\n# 可视化格式模型\n\n---\n\n## 盒模型概念\n\n>`内容区域`、`边框`、`内边距`、`外边距`\n\n*全局reset可能会造成一定的副作用(对`option`等元素).*\n\n\n## 外边距离叠加\n\n+ 外边距叠加一般指的是垂直外边距\n+ 一个元素出现在另一个元素上面时会发生叠加\n+ 一个元素包含在另一个元素中时会发生叠加\n+ 如果两个外边距都是负，浏览器取绝对值比较大的那个数\n+ 如果一正一负，浏览器会用正外边距减去负外边距的绝对值\n+ 行内框、浮动定位、和绝对定位元素之间的外边距不会叠加\n\n---\n\n## 定位概述\n\n### 可视化格式模型\n\n>见`css视觉格式化`\n\n### 相对定位\n\n  元素还处于文档流中，相对于元素本来位置定位。\n  **无论是否移动，元素仍然占据原来的框，这会导致覆盖其他元素。**\n\n### 绝对定位\n\n  元素不属于文档流，相对于父级已定位元素定位，如果没有就相对于包含块定位(`canvas`或者`html`元素)\n\n### 固定定位\n\n  是绝对定位的一种相对于`viewport`定位。\n\n### 浮动\n\n浮动元素不属于文档流，所以普通文档流的块框表现的好像浮动框不存在。\n\n+ 1、浮动框旁边的文档流元素会围绕浮动框\n+ 2、普通块框要包含浮动框，需要对浮动清理、或者把包含块也浮动\n+ 3、常见的清理浮动的方式：\n\n``` css\n  .clear:after {\n    content: '.';\n    height: 0;\n    visibility: none;\n    display: block;\n    clear: both;\n  }\n```","source":"_posts/CSSMastery读书笔记三-可视化格式模型.md","raw":"---\ntitle: CSSMastery读书笔记三-可视化格式模型\ndate: 2016-08-22 15:28:32\ntags: css CSSMastery \ncategories: web\n---\n\n# 可视化格式模型\n\n---\n\n## 盒模型概念\n\n>`内容区域`、`边框`、`内边距`、`外边距`\n\n*全局reset可能会造成一定的副作用(对`option`等元素).*\n\n\n## 外边距离叠加\n\n+ 外边距叠加一般指的是垂直外边距\n+ 一个元素出现在另一个元素上面时会发生叠加\n+ 一个元素包含在另一个元素中时会发生叠加\n+ 如果两个外边距都是负，浏览器取绝对值比较大的那个数\n+ 如果一正一负，浏览器会用正外边距减去负外边距的绝对值\n+ 行内框、浮动定位、和绝对定位元素之间的外边距不会叠加\n\n---\n\n## 定位概述\n\n### 可视化格式模型\n\n>见`css视觉格式化`\n\n### 相对定位\n\n  元素还处于文档流中，相对于元素本来位置定位。\n  **无论是否移动，元素仍然占据原来的框，这会导致覆盖其他元素。**\n\n### 绝对定位\n\n  元素不属于文档流，相对于父级已定位元素定位，如果没有就相对于包含块定位(`canvas`或者`html`元素)\n\n### 固定定位\n\n  是绝对定位的一种相对于`viewport`定位。\n\n### 浮动\n\n浮动元素不属于文档流，所以普通文档流的块框表现的好像浮动框不存在。\n\n+ 1、浮动框旁边的文档流元素会围绕浮动框\n+ 2、普通块框要包含浮动框，需要对浮动清理、或者把包含块也浮动\n+ 3、常见的清理浮动的方式：\n\n``` css\n  .clear:after {\n    content: '.';\n    height: 0;\n    visibility: none;\n    display: block;\n    clear: both;\n  }\n```","slug":"CSSMastery读书笔记三-可视化格式模型","published":1,"updated":"2018-07-01T10:30:46.492Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9ccu000by4zvpqs0k21v","content":"<h1 id=\"可视化格式模型\"><a href=\"#可视化格式模型\" class=\"headerlink\" title=\"可视化格式模型\"></a>可视化格式模型</h1><hr>\n<h2 id=\"盒模型概念\"><a href=\"#盒模型概念\" class=\"headerlink\" title=\"盒模型概念\"></a>盒模型概念</h2><blockquote>\n<p><code>内容区域</code>、<code>边框</code>、<code>内边距</code>、<code>外边距</code></p>\n</blockquote>\n<p><em>全局reset可能会造成一定的副作用(对<code>option</code>等元素).</em></p>\n<h2 id=\"外边距离叠加\"><a href=\"#外边距离叠加\" class=\"headerlink\" title=\"外边距离叠加\"></a>外边距离叠加</h2><ul>\n<li>外边距叠加一般指的是垂直外边距</li>\n<li>一个元素出现在另一个元素上面时会发生叠加</li>\n<li>一个元素包含在另一个元素中时会发生叠加</li>\n<li>如果两个外边距都是负，浏览器取绝对值比较大的那个数</li>\n<li>如果一正一负，浏览器会用正外边距减去负外边距的绝对值</li>\n<li>行内框、浮动定位、和绝对定位元素之间的外边距不会叠加</li>\n</ul>\n<hr>\n<h2 id=\"定位概述\"><a href=\"#定位概述\" class=\"headerlink\" title=\"定位概述\"></a>定位概述</h2><h3 id=\"可视化格式模型-1\"><a href=\"#可视化格式模型-1\" class=\"headerlink\" title=\"可视化格式模型\"></a>可视化格式模型</h3><blockquote>\n<p>见<code>css视觉格式化</code></p>\n</blockquote>\n<h3 id=\"相对定位\"><a href=\"#相对定位\" class=\"headerlink\" title=\"相对定位\"></a>相对定位</h3><p>  元素还处于文档流中，相对于元素本来位置定位。<br>  <strong>无论是否移动，元素仍然占据原来的框，这会导致覆盖其他元素。</strong></p>\n<h3 id=\"绝对定位\"><a href=\"#绝对定位\" class=\"headerlink\" title=\"绝对定位\"></a>绝对定位</h3><p>  元素不属于文档流，相对于父级已定位元素定位，如果没有就相对于包含块定位(<code>canvas</code>或者<code>html</code>元素)</p>\n<h3 id=\"固定定位\"><a href=\"#固定定位\" class=\"headerlink\" title=\"固定定位\"></a>固定定位</h3><p>  是绝对定位的一种相对于<code>viewport</code>定位。</p>\n<h3 id=\"浮动\"><a href=\"#浮动\" class=\"headerlink\" title=\"浮动\"></a>浮动</h3><p>浮动元素不属于文档流，所以普通文档流的块框表现的好像浮动框不存在。</p>\n<ul>\n<li>1、浮动框旁边的文档流元素会围绕浮动框</li>\n<li>2、普通块框要包含浮动框，需要对浮动清理、或者把包含块也浮动</li>\n<li>3、常见的清理浮动的方式：</li>\n</ul>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-class\">.clear</span><span class=\"selector-pseudo\">:after</span> &#123;</span><br><span class=\"line\">  <span class=\"attribute\">content</span>: <span class=\"string\">'.'</span>;</span><br><span class=\"line\">  <span class=\"attribute\">height</span>: <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"attribute\">visibility</span>: none;</span><br><span class=\"line\">  <span class=\"attribute\">display</span>: block;</span><br><span class=\"line\">  <span class=\"attribute\">clear</span>: both;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"","more":"<h1 id=\"可视化格式模型\"><a href=\"#可视化格式模型\" class=\"headerlink\" title=\"可视化格式模型\"></a>可视化格式模型</h1><hr>\n<h2 id=\"盒模型概念\"><a href=\"#盒模型概念\" class=\"headerlink\" title=\"盒模型概念\"></a>盒模型概念</h2><blockquote>\n<p><code>内容区域</code>、<code>边框</code>、<code>内边距</code>、<code>外边距</code></p>\n</blockquote>\n<p><em>全局reset可能会造成一定的副作用(对<code>option</code>等元素).</em></p>\n<h2 id=\"外边距离叠加\"><a href=\"#外边距离叠加\" class=\"headerlink\" title=\"外边距离叠加\"></a>外边距离叠加</h2><ul>\n<li>外边距叠加一般指的是垂直外边距</li>\n<li>一个元素出现在另一个元素上面时会发生叠加</li>\n<li>一个元素包含在另一个元素中时会发生叠加</li>\n<li>如果两个外边距都是负，浏览器取绝对值比较大的那个数</li>\n<li>如果一正一负，浏览器会用正外边距减去负外边距的绝对值</li>\n<li>行内框、浮动定位、和绝对定位元素之间的外边距不会叠加</li>\n</ul>\n<hr>\n<h2 id=\"定位概述\"><a href=\"#定位概述\" class=\"headerlink\" title=\"定位概述\"></a>定位概述</h2><h3 id=\"可视化格式模型-1\"><a href=\"#可视化格式模型-1\" class=\"headerlink\" title=\"可视化格式模型\"></a>可视化格式模型</h3><blockquote>\n<p>见<code>css视觉格式化</code></p>\n</blockquote>\n<h3 id=\"相对定位\"><a href=\"#相对定位\" class=\"headerlink\" title=\"相对定位\"></a>相对定位</h3><p>  元素还处于文档流中，相对于元素本来位置定位。<br>  <strong>无论是否移动，元素仍然占据原来的框，这会导致覆盖其他元素。</strong></p>\n<h3 id=\"绝对定位\"><a href=\"#绝对定位\" class=\"headerlink\" title=\"绝对定位\"></a>绝对定位</h3><p>  元素不属于文档流，相对于父级已定位元素定位，如果没有就相对于包含块定位(<code>canvas</code>或者<code>html</code>元素)</p>\n<h3 id=\"固定定位\"><a href=\"#固定定位\" class=\"headerlink\" title=\"固定定位\"></a>固定定位</h3><p>  是绝对定位的一种相对于<code>viewport</code>定位。</p>\n<h3 id=\"浮动\"><a href=\"#浮动\" class=\"headerlink\" title=\"浮动\"></a>浮动</h3><p>浮动元素不属于文档流，所以普通文档流的块框表现的好像浮动框不存在。</p>\n<ul>\n<li>1、浮动框旁边的文档流元素会围绕浮动框</li>\n<li>2、普通块框要包含浮动框，需要对浮动清理、或者把包含块也浮动</li>\n<li>3、常见的清理浮动的方式：</li>\n</ul>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-class\">.clear</span><span class=\"selector-pseudo\">:after</span> &#123;</span><br><span class=\"line\">  <span class=\"attribute\">content</span>: <span class=\"string\">'.'</span>;</span><br><span class=\"line\">  <span class=\"attribute\">height</span>: <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"attribute\">visibility</span>: none;</span><br><span class=\"line\">  <span class=\"attribute\">display</span>: block;</span><br><span class=\"line\">  <span class=\"attribute\">clear</span>: both;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>"},{"title":"CSSMastery读书笔记二-为样式找到应用目标","date":"2016-08-21T13:47:52.000Z","_content":"\n# 为样式找到应用目标\n\n---\n\n## 常用的选择器\n\n### 元素选择器\n\n  `body`\n\n### 后代选择器\n\n  `nav li`中间有空格\n\n### 伪类\n\n- 链接伪类：`link`、`visited`\n- 动态伪类：`hover`、`active`、`focus`、`first-child`、`lang`\n\n### 伪元素\n\n- before\n- after\n- first-letter\n- first-line\n\n>伪类与伪元素的区别\n伪类：对某些选择器添加特殊样式.\n伪元素：同于将特殊效果添加到某些选择器.\n伪类前面有一个冒号，伪元素前面有两个冒号.\n\n---\n\n## 通用选择器(`*`)\n\n- 通配符匹配所有元素\n- 对所有后代或者跳过某一级别设置样式\n\n---\n\n## 高级选择器\n\n### 子元素选择器\n\n  `nav>li`中间可以有空格\n\n### 兄弟选择器\n\n  `h2+p`中间可以有空格\n\n### 属性选择器\n\n- 根据属性是否存在\n  `span[title]`:对存在`title`属性的`span`元素设置属性\n\n- 根据属性值\n  - `span[title='foo']`: 完全等于\n  - `span[title~='foo']`:分词匹配\n  - `span[title^='foo']`:以`foo`开头\n  - `span[title$='foo']`:以`foo`结尾\n  - `span[title*='foo']`:通配存在字符`foo`\n\n---\n\n## 层叠和样式\n\n### 层叠的重要性排序\n\n- 持有`!important`的用户样式\n- 持有`!important`的作者样式\n- 作者样式\n- 用户样式\n- 浏览器默认样式\n\n### 样式特殊性规则\n\n`a、b、c、d`四个权重\n\n- 内联样式：             1 0 0 0\n- `id`选择器：           0 1 0 0\n- 类、伪类、属性选择器：   0 0 1 0\n- 类型选择器、元素选择器：  0 0 0 1\n\n>由于继承而来的样式的特殊性为0，所以直接应用于元素的任何样式都会覆盖继承而来的样式。\n\n#### **特殊性使用规则：**\n\n>一般样式非常一般、特殊样式尽可能特殊\n\n---\n\n## 规划组织可维护的样式表\n\n### 对文档应用样式的方式：\n\n- 导入样式(`import`)\n- 链接样式(`link`元素)\n\n### 一个好的样式文档结构：\n\n- 1、一般性样式\n  - 主体\n  - `reset`\n  - 链接\n  - 标题\n  - 其他元素\n\n- 2、辅助样式\n  - 表单\n  - 通知和错误\n  - 页面结构\n  - 一致的条目\n\n- 3、页面结构\n  - 标题、页脚和导航\n  - 布局\n  - 其他页面结构元素\n\n- 4、页面组件\n  - 各个页面\n\n- 5、覆盖\n\n---\n\n## 一些好的实践\n\n- 文件开头放置一些常用的预定义：如颜色值\n- 利用`cssDoc`注释`css`","source":"_posts/CSSMastery读书笔记二为-样式找到应用目标.md","raw":"---\ntitle: CSSMastery读书笔记二-为样式找到应用目标\ndate: 2016-08-21 21:47:52\ntags: css-mastery\ncategories: web\n---\n\n# 为样式找到应用目标\n\n---\n\n## 常用的选择器\n\n### 元素选择器\n\n  `body`\n\n### 后代选择器\n\n  `nav li`中间有空格\n\n### 伪类\n\n- 链接伪类：`link`、`visited`\n- 动态伪类：`hover`、`active`、`focus`、`first-child`、`lang`\n\n### 伪元素\n\n- before\n- after\n- first-letter\n- first-line\n\n>伪类与伪元素的区别\n伪类：对某些选择器添加特殊样式.\n伪元素：同于将特殊效果添加到某些选择器.\n伪类前面有一个冒号，伪元素前面有两个冒号.\n\n---\n\n## 通用选择器(`*`)\n\n- 通配符匹配所有元素\n- 对所有后代或者跳过某一级别设置样式\n\n---\n\n## 高级选择器\n\n### 子元素选择器\n\n  `nav>li`中间可以有空格\n\n### 兄弟选择器\n\n  `h2+p`中间可以有空格\n\n### 属性选择器\n\n- 根据属性是否存在\n  `span[title]`:对存在`title`属性的`span`元素设置属性\n\n- 根据属性值\n  - `span[title='foo']`: 完全等于\n  - `span[title~='foo']`:分词匹配\n  - `span[title^='foo']`:以`foo`开头\n  - `span[title$='foo']`:以`foo`结尾\n  - `span[title*='foo']`:通配存在字符`foo`\n\n---\n\n## 层叠和样式\n\n### 层叠的重要性排序\n\n- 持有`!important`的用户样式\n- 持有`!important`的作者样式\n- 作者样式\n- 用户样式\n- 浏览器默认样式\n\n### 样式特殊性规则\n\n`a、b、c、d`四个权重\n\n- 内联样式：             1 0 0 0\n- `id`选择器：           0 1 0 0\n- 类、伪类、属性选择器：   0 0 1 0\n- 类型选择器、元素选择器：  0 0 0 1\n\n>由于继承而来的样式的特殊性为0，所以直接应用于元素的任何样式都会覆盖继承而来的样式。\n\n#### **特殊性使用规则：**\n\n>一般样式非常一般、特殊样式尽可能特殊\n\n---\n\n## 规划组织可维护的样式表\n\n### 对文档应用样式的方式：\n\n- 导入样式(`import`)\n- 链接样式(`link`元素)\n\n### 一个好的样式文档结构：\n\n- 1、一般性样式\n  - 主体\n  - `reset`\n  - 链接\n  - 标题\n  - 其他元素\n\n- 2、辅助样式\n  - 表单\n  - 通知和错误\n  - 页面结构\n  - 一致的条目\n\n- 3、页面结构\n  - 标题、页脚和导航\n  - 布局\n  - 其他页面结构元素\n\n- 4、页面组件\n  - 各个页面\n\n- 5、覆盖\n\n---\n\n## 一些好的实践\n\n- 文件开头放置一些常用的预定义：如颜色值\n- 利用`cssDoc`注释`css`","slug":"CSSMastery读书笔记二为-样式找到应用目标","published":1,"updated":"2018-07-01T10:30:46.492Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9ccv000cy4zvbajz53gr","content":"<h1 id=\"为样式找到应用目标\"><a href=\"#为样式找到应用目标\" class=\"headerlink\" title=\"为样式找到应用目标\"></a>为样式找到应用目标</h1><hr>\n<h2 id=\"常用的选择器\"><a href=\"#常用的选择器\" class=\"headerlink\" title=\"常用的选择器\"></a>常用的选择器</h2><h3 id=\"元素选择器\"><a href=\"#元素选择器\" class=\"headerlink\" title=\"元素选择器\"></a>元素选择器</h3><p>  <code>body</code></p>\n<h3 id=\"后代选择器\"><a href=\"#后代选择器\" class=\"headerlink\" title=\"后代选择器\"></a>后代选择器</h3><p>  <code>nav li</code>中间有空格</p>\n<h3 id=\"伪类\"><a href=\"#伪类\" class=\"headerlink\" title=\"伪类\"></a>伪类</h3><ul>\n<li>链接伪类：<code>link</code>、<code>visited</code></li>\n<li>动态伪类：<code>hover</code>、<code>active</code>、<code>focus</code>、<code>first-child</code>、<code>lang</code></li>\n</ul>\n<h3 id=\"伪元素\"><a href=\"#伪元素\" class=\"headerlink\" title=\"伪元素\"></a>伪元素</h3><ul>\n<li>before</li>\n<li>after</li>\n<li>first-letter</li>\n<li>first-line</li>\n</ul>\n<blockquote>\n<p>伪类与伪元素的区别<br>伪类：对某些选择器添加特殊样式.<br>伪元素：同于将特殊效果添加到某些选择器.<br>伪类前面有一个冒号，伪元素前面有两个冒号.</p>\n</blockquote>\n<hr>\n<h2 id=\"通用选择器\"><a href=\"#通用选择器\" class=\"headerlink\" title=\"通用选择器(*)\"></a>通用选择器(<code>*</code>)</h2><ul>\n<li>通配符匹配所有元素</li>\n<li>对所有后代或者跳过某一级别设置样式</li>\n</ul>\n<hr>\n<h2 id=\"高级选择器\"><a href=\"#高级选择器\" class=\"headerlink\" title=\"高级选择器\"></a>高级选择器</h2><h3 id=\"子元素选择器\"><a href=\"#子元素选择器\" class=\"headerlink\" title=\"子元素选择器\"></a>子元素选择器</h3><p>  <code>nav&gt;li</code>中间可以有空格</p>\n<h3 id=\"兄弟选择器\"><a href=\"#兄弟选择器\" class=\"headerlink\" title=\"兄弟选择器\"></a>兄弟选择器</h3><p>  <code>h2+p</code>中间可以有空格</p>\n<h3 id=\"属性选择器\"><a href=\"#属性选择器\" class=\"headerlink\" title=\"属性选择器\"></a>属性选择器</h3><ul>\n<li><p>根据属性是否存在<br><code>span[title]</code>:对存在<code>title</code>属性的<code>span</code>元素设置属性</p>\n</li>\n<li><p>根据属性值</p>\n<ul>\n<li><code>span[title=&#39;foo&#39;]</code>: 完全等于</li>\n<li><code>span[title~=&#39;foo&#39;]</code>:分词匹配</li>\n<li><code>span[title^=&#39;foo&#39;]</code>:以<code>foo</code>开头</li>\n<li><code>span[title$=&#39;foo&#39;]</code>:以<code>foo</code>结尾</li>\n<li><code>span[title*=&#39;foo&#39;]</code>:通配存在字符<code>foo</code></li>\n</ul>\n</li>\n</ul>\n<hr>\n<h2 id=\"层叠和样式\"><a href=\"#层叠和样式\" class=\"headerlink\" title=\"层叠和样式\"></a>层叠和样式</h2><h3 id=\"层叠的重要性排序\"><a href=\"#层叠的重要性排序\" class=\"headerlink\" title=\"层叠的重要性排序\"></a>层叠的重要性排序</h3><ul>\n<li>持有<code>!important</code>的用户样式</li>\n<li>持有<code>!important</code>的作者样式</li>\n<li>作者样式</li>\n<li>用户样式</li>\n<li>浏览器默认样式</li>\n</ul>\n<h3 id=\"样式特殊性规则\"><a href=\"#样式特殊性规则\" class=\"headerlink\" title=\"样式特殊性规则\"></a>样式特殊性规则</h3><p><code>a、b、c、d</code>四个权重</p>\n<ul>\n<li>内联样式：             1 0 0 0</li>\n<li><code>id</code>选择器：           0 1 0 0</li>\n<li>类、伪类、属性选择器：   0 0 1 0</li>\n<li>类型选择器、元素选择器：  0 0 0 1</li>\n</ul>\n<blockquote>\n<p>由于继承而来的样式的特殊性为0，所以直接应用于元素的任何样式都会覆盖继承而来的样式。</p>\n</blockquote>\n<h4 id=\"特殊性使用规则：\"><a href=\"#特殊性使用规则：\" class=\"headerlink\" title=\"特殊性使用规则：\"></a><strong>特殊性使用规则：</strong></h4><blockquote>\n<p>一般样式非常一般、特殊样式尽可能特殊</p>\n</blockquote>\n<hr>\n<h2 id=\"规划组织可维护的样式表\"><a href=\"#规划组织可维护的样式表\" class=\"headerlink\" title=\"规划组织可维护的样式表\"></a>规划组织可维护的样式表</h2><h3 id=\"对文档应用样式的方式：\"><a href=\"#对文档应用样式的方式：\" class=\"headerlink\" title=\"对文档应用样式的方式：\"></a>对文档应用样式的方式：</h3><ul>\n<li>导入样式(<code>import</code>)</li>\n<li>链接样式(<code>link</code>元素)</li>\n</ul>\n<h3 id=\"一个好的样式文档结构：\"><a href=\"#一个好的样式文档结构：\" class=\"headerlink\" title=\"一个好的样式文档结构：\"></a>一个好的样式文档结构：</h3><ul>\n<li><p>1、一般性样式</p>\n<ul>\n<li>主体</li>\n<li><code>reset</code></li>\n<li>链接</li>\n<li>标题</li>\n<li>其他元素</li>\n</ul>\n</li>\n<li><p>2、辅助样式</p>\n<ul>\n<li>表单</li>\n<li>通知和错误</li>\n<li>页面结构</li>\n<li>一致的条目</li>\n</ul>\n</li>\n<li><p>3、页面结构</p>\n<ul>\n<li>标题、页脚和导航</li>\n<li>布局</li>\n<li>其他页面结构元素</li>\n</ul>\n</li>\n<li><p>4、页面组件</p>\n<ul>\n<li>各个页面</li>\n</ul>\n</li>\n<li><p>5、覆盖</p>\n</li>\n</ul>\n<hr>\n<h2 id=\"一些好的实践\"><a href=\"#一些好的实践\" class=\"headerlink\" title=\"一些好的实践\"></a>一些好的实践</h2><ul>\n<li>文件开头放置一些常用的预定义：如颜色值</li>\n<li>利用<code>cssDoc</code>注释<code>css</code></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"为样式找到应用目标\"><a href=\"#为样式找到应用目标\" class=\"headerlink\" title=\"为样式找到应用目标\"></a>为样式找到应用目标</h1><hr>\n<h2 id=\"常用的选择器\"><a href=\"#常用的选择器\" class=\"headerlink\" title=\"常用的选择器\"></a>常用的选择器</h2><h3 id=\"元素选择器\"><a href=\"#元素选择器\" class=\"headerlink\" title=\"元素选择器\"></a>元素选择器</h3><p>  <code>body</code></p>\n<h3 id=\"后代选择器\"><a href=\"#后代选择器\" class=\"headerlink\" title=\"后代选择器\"></a>后代选择器</h3><p>  <code>nav li</code>中间有空格</p>\n<h3 id=\"伪类\"><a href=\"#伪类\" class=\"headerlink\" title=\"伪类\"></a>伪类</h3><ul>\n<li>链接伪类：<code>link</code>、<code>visited</code></li>\n<li>动态伪类：<code>hover</code>、<code>active</code>、<code>focus</code>、<code>first-child</code>、<code>lang</code></li>\n</ul>\n<h3 id=\"伪元素\"><a href=\"#伪元素\" class=\"headerlink\" title=\"伪元素\"></a>伪元素</h3><ul>\n<li>before</li>\n<li>after</li>\n<li>first-letter</li>\n<li>first-line</li>\n</ul>\n<blockquote>\n<p>伪类与伪元素的区别<br>伪类：对某些选择器添加特殊样式.<br>伪元素：同于将特殊效果添加到某些选择器.<br>伪类前面有一个冒号，伪元素前面有两个冒号.</p>\n</blockquote>\n<hr>\n<h2 id=\"通用选择器\"><a href=\"#通用选择器\" class=\"headerlink\" title=\"通用选择器(*)\"></a>通用选择器(<code>*</code>)</h2><ul>\n<li>通配符匹配所有元素</li>\n<li>对所有后代或者跳过某一级别设置样式</li>\n</ul>\n<hr>\n<h2 id=\"高级选择器\"><a href=\"#高级选择器\" class=\"headerlink\" title=\"高级选择器\"></a>高级选择器</h2><h3 id=\"子元素选择器\"><a href=\"#子元素选择器\" class=\"headerlink\" title=\"子元素选择器\"></a>子元素选择器</h3><p>  <code>nav&gt;li</code>中间可以有空格</p>\n<h3 id=\"兄弟选择器\"><a href=\"#兄弟选择器\" class=\"headerlink\" title=\"兄弟选择器\"></a>兄弟选择器</h3><p>  <code>h2+p</code>中间可以有空格</p>\n<h3 id=\"属性选择器\"><a href=\"#属性选择器\" class=\"headerlink\" title=\"属性选择器\"></a>属性选择器</h3><ul>\n<li><p>根据属性是否存在<br><code>span[title]</code>:对存在<code>title</code>属性的<code>span</code>元素设置属性</p>\n</li>\n<li><p>根据属性值</p>\n<ul>\n<li><code>span[title=&#39;foo&#39;]</code>: 完全等于</li>\n<li><code>span[title~=&#39;foo&#39;]</code>:分词匹配</li>\n<li><code>span[title^=&#39;foo&#39;]</code>:以<code>foo</code>开头</li>\n<li><code>span[title$=&#39;foo&#39;]</code>:以<code>foo</code>结尾</li>\n<li><code>span[title*=&#39;foo&#39;]</code>:通配存在字符<code>foo</code></li>\n</ul>\n</li>\n</ul>\n<hr>\n<h2 id=\"层叠和样式\"><a href=\"#层叠和样式\" class=\"headerlink\" title=\"层叠和样式\"></a>层叠和样式</h2><h3 id=\"层叠的重要性排序\"><a href=\"#层叠的重要性排序\" class=\"headerlink\" title=\"层叠的重要性排序\"></a>层叠的重要性排序</h3><ul>\n<li>持有<code>!important</code>的用户样式</li>\n<li>持有<code>!important</code>的作者样式</li>\n<li>作者样式</li>\n<li>用户样式</li>\n<li>浏览器默认样式</li>\n</ul>\n<h3 id=\"样式特殊性规则\"><a href=\"#样式特殊性规则\" class=\"headerlink\" title=\"样式特殊性规则\"></a>样式特殊性规则</h3><p><code>a、b、c、d</code>四个权重</p>\n<ul>\n<li>内联样式：             1 0 0 0</li>\n<li><code>id</code>选择器：           0 1 0 0</li>\n<li>类、伪类、属性选择器：   0 0 1 0</li>\n<li>类型选择器、元素选择器：  0 0 0 1</li>\n</ul>\n<blockquote>\n<p>由于继承而来的样式的特殊性为0，所以直接应用于元素的任何样式都会覆盖继承而来的样式。</p>\n</blockquote>\n<h4 id=\"特殊性使用规则：\"><a href=\"#特殊性使用规则：\" class=\"headerlink\" title=\"特殊性使用规则：\"></a><strong>特殊性使用规则：</strong></h4><blockquote>\n<p>一般样式非常一般、特殊样式尽可能特殊</p>\n</blockquote>\n<hr>\n<h2 id=\"规划组织可维护的样式表\"><a href=\"#规划组织可维护的样式表\" class=\"headerlink\" title=\"规划组织可维护的样式表\"></a>规划组织可维护的样式表</h2><h3 id=\"对文档应用样式的方式：\"><a href=\"#对文档应用样式的方式：\" class=\"headerlink\" title=\"对文档应用样式的方式：\"></a>对文档应用样式的方式：</h3><ul>\n<li>导入样式(<code>import</code>)</li>\n<li>链接样式(<code>link</code>元素)</li>\n</ul>\n<h3 id=\"一个好的样式文档结构：\"><a href=\"#一个好的样式文档结构：\" class=\"headerlink\" title=\"一个好的样式文档结构：\"></a>一个好的样式文档结构：</h3><ul>\n<li><p>1、一般性样式</p>\n<ul>\n<li>主体</li>\n<li><code>reset</code></li>\n<li>链接</li>\n<li>标题</li>\n<li>其他元素</li>\n</ul>\n</li>\n<li><p>2、辅助样式</p>\n<ul>\n<li>表单</li>\n<li>通知和错误</li>\n<li>页面结构</li>\n<li>一致的条目</li>\n</ul>\n</li>\n<li><p>3、页面结构</p>\n<ul>\n<li>标题、页脚和导航</li>\n<li>布局</li>\n<li>其他页面结构元素</li>\n</ul>\n</li>\n<li><p>4、页面组件</p>\n<ul>\n<li>各个页面</li>\n</ul>\n</li>\n<li><p>5、覆盖</p>\n</li>\n</ul>\n<hr>\n<h2 id=\"一些好的实践\"><a href=\"#一些好的实践\" class=\"headerlink\" title=\"一些好的实践\"></a>一些好的实践</h2><ul>\n<li>文件开头放置一些常用的预定义：如颜色值</li>\n<li>利用<code>cssDoc</code>注释<code>css</code></li>\n</ul>\n"},{"title":"ES6 CheatSheet(一)","date":"2017-05-03T13:18:42.000Z","_content":"\n![ES6 CheatSheet](/img/ES6-part-one.png)\n\n在线连接: [ES6 CheatSheet](https://www.processon.com/mindmap/5ad33dffe4b02dfcf9a52ca3)\n","source":"_posts/ES6 CheatSheet(一).md","raw":"---\ntitle: ES6 CheatSheet(一)\ndate: 2017-05-03 21:18:42\ntags: \n  - es6\n  - cheatsheet\ncategories: javascript\n---\n\n![ES6 CheatSheet](/img/ES6-part-one.png)\n\n在线连接: [ES6 CheatSheet](https://www.processon.com/mindmap/5ad33dffe4b02dfcf9a52ca3)\n","slug":"ES6 CheatSheet(一)","published":1,"updated":"2018-07-01T10:30:46.492Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9ccx000hy4zvo3l2mbf1","content":"<p><img src=\"/img/ES6-part-one.png\" alt=\"ES6 CheatSheet\"></p>\n<p>在线连接: <a href=\"https://www.processon.com/mindmap/5ad33dffe4b02dfcf9a52ca3\" target=\"_blank\" rel=\"noopener\">ES6 CheatSheet</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p><img src=\"/img/ES6-part-one.png\" alt=\"ES6 CheatSheet\"></p>\n<p>在线连接: <a href=\"https://www.processon.com/mindmap/5ad33dffe4b02dfcf9a52ca3\" target=\"_blank\" rel=\"noopener\">ES6 CheatSheet</a></p>\n"},{"title":"ES6 CheatSheet(二)","date":"2017-07-10T12:08:42.000Z","_content":"\n![ES6 CheatSheet](/img/ES6-part-two.png)\n\n在线连接: [ES6 CheatSheet](https://www.processon.com/mindmap/5ac2bf03e4b0cf24e965710c)\n","source":"_posts/ES6 CheatSheet(二).md","raw":"---\ntitle: ES6 CheatSheet(二)\ndate: 2017-07-10 20:08:42\ntags: \n  - es6\n  - cheatsheet\ncategories: javascript\n---\n\n![ES6 CheatSheet](/img/ES6-part-two.png)\n\n在线连接: [ES6 CheatSheet](https://www.processon.com/mindmap/5ac2bf03e4b0cf24e965710c)\n","slug":"ES6 CheatSheet(二)","published":1,"updated":"2018-07-01T10:30:46.492Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9ccz000jy4zve0ytc02d","content":"<p><img src=\"/img/ES6-part-two.png\" alt=\"ES6 CheatSheet\"></p>\n<p>在线连接: <a href=\"https://www.processon.com/mindmap/5ac2bf03e4b0cf24e965710c\" target=\"_blank\" rel=\"noopener\">ES6 CheatSheet</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p><img src=\"/img/ES6-part-two.png\" alt=\"ES6 CheatSheet\"></p>\n<p>在线连接: <a href=\"https://www.processon.com/mindmap/5ac2bf03e4b0cf24e965710c\" target=\"_blank\" rel=\"noopener\">ES6 CheatSheet</a></p>\n"},{"title":"HTTP知识图谱","date":"2018-06-15T10:17:32.000Z","_content":"\n![http-cheatsheet](/img/http-cheatsheet.png)\n\n在线文档链接：[http-cheatsheet](https://www.processon.com/mindmap/5bf9300ae4b04dd279934191)\n\n参考文档：\n\n[MDN HTTP](https://developer.mozilla.org/zh-CN/docs/Web/HTTP)\n\n[Caching Tutorial ](https://www.mnot.net/cache_docs/)\n\n[HTTP缓存控制小结](http://imweb.io/topic/5795dcb6fb312541492eda8c)\n\n[HTTP协议之响应头Date与Age](https://blog.csdn.net/xifeijian/article/details/46460631)","source":"_posts/HTTP知识图谱.md","raw":"---\ntitle: HTTP知识图谱\ndate: 2018-06-15 18:17:32\ntags: http, cheatsheet\ncategories: server \n---\n\n![http-cheatsheet](/img/http-cheatsheet.png)\n\n在线文档链接：[http-cheatsheet](https://www.processon.com/mindmap/5bf9300ae4b04dd279934191)\n\n参考文档：\n\n[MDN HTTP](https://developer.mozilla.org/zh-CN/docs/Web/HTTP)\n\n[Caching Tutorial ](https://www.mnot.net/cache_docs/)\n\n[HTTP缓存控制小结](http://imweb.io/topic/5795dcb6fb312541492eda8c)\n\n[HTTP协议之响应头Date与Age](https://blog.csdn.net/xifeijian/article/details/46460631)","slug":"HTTP知识图谱","published":1,"updated":"2018-11-25T11:27:35.879Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cd0000ny4zv6owmt6de","content":"<p><img src=\"/img/http-cheatsheet.png\" alt=\"http-cheatsheet\"></p>\n<p>在线文档链接：<a href=\"https://www.processon.com/mindmap/5bf9300ae4b04dd279934191\" target=\"_blank\" rel=\"noopener\">http-cheatsheet</a></p>\n<p>参考文档：</p>\n<p><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/HTTP\" target=\"_blank\" rel=\"noopener\">MDN HTTP</a></p>\n<p><a href=\"https://www.mnot.net/cache_docs/\" target=\"_blank\" rel=\"noopener\">Caching Tutorial </a></p>\n<p><a href=\"http://imweb.io/topic/5795dcb6fb312541492eda8c\" target=\"_blank\" rel=\"noopener\">HTTP缓存控制小结</a></p>\n<p><a href=\"https://blog.csdn.net/xifeijian/article/details/46460631\" target=\"_blank\" rel=\"noopener\">HTTP协议之响应头Date与Age</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p><img src=\"/img/http-cheatsheet.png\" alt=\"http-cheatsheet\"></p>\n<p>在线文档链接：<a href=\"https://www.processon.com/mindmap/5bf9300ae4b04dd279934191\" target=\"_blank\" rel=\"noopener\">http-cheatsheet</a></p>\n<p>参考文档：</p>\n<p><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/HTTP\" target=\"_blank\" rel=\"noopener\">MDN HTTP</a></p>\n<p><a href=\"https://www.mnot.net/cache_docs/\" target=\"_blank\" rel=\"noopener\">Caching Tutorial </a></p>\n<p><a href=\"http://imweb.io/topic/5795dcb6fb312541492eda8c\" target=\"_blank\" rel=\"noopener\">HTTP缓存控制小结</a></p>\n<p><a href=\"https://blog.csdn.net/xifeijian/article/details/46460631\" target=\"_blank\" rel=\"noopener\">HTTP协议之响应头Date与Age</a></p>\n"},{"title":"linux输入设备抽象","date":"2013-10-21T07:09:57.000Z","_content":"\n最近在些GUI程序，之前也写过一些。长久以来一直对其中一些问题有些好奇，如：鼠标事件和键盘事件是如何获取如何引入程序的，GUI底层绘制操作又是怎么实现的。最近花了点事件学习了下其底层的实现，在这里做个笔记。\n\n    LINUX下输入设备放在/dev/input/下，我的电脑该目录内容为：\n\n```shell\n\nlc@lc-Lenovo:~/work/sources$ cd /dev/input/\nlc@lc-Lenovo:/dev/input$ ls\nby-id    event0  event10  event3  event5  event7  event9  mouse0\nby-path  event1  event2   event4  event6  event8  mice\n\n```\n\n    这么多设备我们需要知道哪个设备对应鼠标哪个对应键盘，可以查看文件/proc/bus/input/devices，我的电脑下该文件鼠标和键盘相关信息为：\n\n```shell  \nI: Bus=0011 Vendor=0001 Product=0001 Version=ab41\nN: Name=\"AT Translated Set 2 keyboard\"\nP: Phys=isa0060/serio0/input0\nS: Sysfs=/devices/platform/i8042/serio0/input/input2\nU: Uniq=\nH: Handlers=sysrq kbd event2 \nB: PROP=0\nB: EV=120013\nB: KEY=4 2000000 3803078 f800d001 feffffdf ffefffff ffffffff fffffffe\nB: MSC=10\nB: LED=7\n\nI: Bus=0003 Vendor=17ef Product=6019 Version=0111\nN: Name=\"Logitech Lenovo USB Optical Mouse\"\nP: Phys=usb-0000:00:1d.0-1.4/input0\nS: Sysfs=/devices/pci0000:00/0000:00:1d.0/usb2/2-1/2-1.4/2-1.4:1.0/input/input3\nU: Uniq=\nH: Handlers=mouse0 event3 \nB: PROP=0\nB: EV=17\nB: KEY=70000 0 0 0 0 0 0 0 0\nB: REL=103\nB: MSC=10\n```\n\n可以看到鼠标对应的是event3键盘对应的是event2。\n\n    LINUX下每个设备都有一个ID，如果想监视一个设备的行为需要获取该设备句柄，然后交给SELECT或则epoll即可，对于输入设备也是一样。当SELECT循环检测到输入设备有数据可以读取的时候，调用相关接口获取输入设备信息再进一步分发判断具体的事件类型即可。LINUX下相关的数据结构为：\n\n```shell\nstruct input_event \n{\n    struct timeval time;  \t        //事件发生的时间\n    __u16 type; \t\t\t//事件类型\n    __u16 code; \t\t\t//事件的代码\n    __s32 value;\t\t\t//事件附带值\n};\n```\n\n该结构体定义在linux/input.h文件下。time表示事件发生的时间戳，type标识事件类型，主要的事件类型有：\n\n```c\n /*\n  * Event types\n  */\n \n #define EV_SYN                  0x00\n #define EV_KEY                  0x01\t//键盘事件\n #define EV_REL                  0x02\t//相对坐标\n #define EV_ABS                  0x03\t//绝对坐标\n #define EV_MSC                  0x04\n #define EV_SW                   0x05\n #define EV_LED                  0x11\n #define EV_SND                  0x12\n #define EV_REP                  0x14\n #define EV_FF                   0x15\n #define EV_PWR                  0x16\n #define EV_FF_STATUS            0x17\n #define EV_MAX                  0x1f\n #define EV_CNT                  (EV_MAX+1)\n```\n\n当type等于EV_KEY时，code的值为KEY_0,1,2...键盘上的按键，比较特殊的是，鼠标左键右键中间按下时键值分别为：BTN_LEFT/BTN_RIGHT/BTN_MIDDLE。EV_ABS表示绝对坐标事件，主要用于标识触摸屏下的用户触摸(touch)事件。此时事件代码code的值可能有ABS_X和ABS_Y两个，分别表示X轴坐标和Y轴坐标。如果事件的类型代码是EV_REL,code值表示轨迹的类型.如指示鼠标的X轴方向REL_X(代码为0x00),指示鼠标的Y轴方向REL_Y(代码为0x01),指示鼠标中轮子方向REL_WHEEL(代码为0x08）等。EV_SYN用于分割事件的一个标记，比如，鼠标按下会受到一个EV_KEY事件，紧接着就是一个EV_SYN事件，鼠标提起的时候也类似。\n\n输入事件分发示例代码：\n\n```c\nstatic RET_E source_input_dispatch(EVENT_SOURCE_T* pstThiz)\n{\n\tint nRet = 0;\n\tDECL_PRIV(pstThiz, priv);\n\tstruct input_event ievent;\n\tstatic int nCount = 0;\n\n\tnRet = read(priv->fd, &ievent, sizeof(ievent));\n\tif(nRet != sizeof(ievent))\n\t{\n\n\t\treturn;\n\t}\t\n\tswitch(ievent.type)\n\t{\n\t\tcase EV_KEY:\n\t\t{\n\t\t\tif(ievent.code == BTN_LEFT)\n\t\t\t{\n\t\t\t\tprintf(\"EV_KEY BTN_LEFT click\\n\");\n\t\t\t}\n\t\t\telse if(ievent.code == BTN_RIGHT)\n\t\t\t{\n\t\t\t\tprintf(\"EV_KEY BTN_RIGHT click\\n\");\n\t\t\t}\n\t\t\telse if(ievent.code == BTN_MIDDLE)\n\t\t\t{\n\t\t\t\tprintf(\"EV_KEY BTN_MIDDLE click\\n\");\n\t\t\t}\n\t\t\telse if(ievent.code == BTN_TOUCH)\n\t\t\t{\n\t\t\t\tprintf(\"EV_KEY BTN_TOUCH click\\n\");\n\t\t\t}\n\n\t\t\tif(ievent.code == BTN_LEFT || ievent.code == BTN_RIGHT\n\t\t\t\t|| ievent.code == BTN_MIDDLE || ievent.code == BTN_TOUCH)\n\t\t\t{\n\t\t\t\tpriv->stEvent.eType = ievent.value ? EVT_MOUSE_DOWN : EVT_MOUSE_UP;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tpriv->stEvent.eType = ievent.value ? EVT_KEY_DOWN : EVT_KEY_UP;\n\t\t\t\tpriv->stEvent.u.key.nCode = key_map(pstThiz, ievent.code);\n\t\t\t\tprintf(\"EVENT key code :%d\\n\", priv->stEvent.u.key.nCode);\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\t\tcase EV_ABS:\n\t\t{\n\t\t\tswitch(ievent.code)\n\t\t\t{\n\t\t\t\tcase ABS_X:\n\t\t\t\t{\n\t\t\t\t\tprintf(\"EV_ABS ABS_X value :%d\\n\", priv->x);\n\t\t\t\t\tpriv->x = ievent.value;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase ABS_Y:\n\t\t\t\t{\n\t\t\t\t\tprintf(\"EV_ABS ABS_Y value :%d\\n\", priv->y);\n\t\t\t\t\tpriv->y = ievent.value;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tdefault:\n\t\t\t\t{\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif(priv->stEvent.eType == EVT_NOP)\n\t\t\t{\n\t\t\t\t\n\t\t\t\tprintf(\"EV_ABS mouse move \\n\");\n\t\t\t\tpriv->stEvent.eType = EVT_MOUSE_MOVE;\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\t\tcase EV_REL:\n\t\t{\n\t\t\tswitch(ievent.code)\n\t\t\t{\n\t\t\t\tcase REL_X:\n\t\t\t\t{\n\t\t\t\t\tpriv->x += ievent.value;\n\t\t\t\t\tprintf(\"EV_REL REL_X value :%d\\n\", priv->x);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase REL_Y:\n\t\t\t\t{\n\t\t\t\t\tpriv->y += ievent.value;\n\t\t\t\t\tprintf(\"EV_REL REL_X value :%d\\n\", priv->y);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tdefault:break;\n\t\t\t}\n\t\t\tif(priv->stEvent.eType == EVT_NOP)\n\t\t\t{\n\t\t\t\tpriv->stEvent.eType = EVT_MOUSE_MOVE;\n\t\t\t\tprintf(\"EV_REL mouse move\\n\");\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\t\tcase EV_SYN:\n\t\t{\n\t\t\tif(priv->stEvent.eType == EVT_MOUSE_DOWN)\n\t\t\t{\n\t\t\t\tprintf(\"EV_SYN mouse down\\n\");\n\t\t\t}\n\t\t\telse if(priv->stEvent.eType == EVT_MOUSE_UP)\n\t\t\t{\t\n\t\t\t\tprintf(\"EV_SYN mouse up\\n\");\n\t\t\t}\n\t\t\telse if(priv->stEvent.eType == EVT_MOUSE_MOVE)\n\t\t\t{\t\n\t\t\t\tprintf(\"EV_SYN mouse move\\n\");\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\t\tdefault:break;\n\t}\n\treturn (RET_OK);\n}\n```\n\n鼠标左键按下提起事件捕获：\n\n![mouse](/img/linux-mouse.png)\n\n其他事件效果也是类似。","source":"_posts/LINUX输入设备抽象.md","raw":"---\ntitle: linux输入设备抽象\ndate: 2013-10-21 15:09:57\ntags: linux\ncategories: server\n---\n\n最近在些GUI程序，之前也写过一些。长久以来一直对其中一些问题有些好奇，如：鼠标事件和键盘事件是如何获取如何引入程序的，GUI底层绘制操作又是怎么实现的。最近花了点事件学习了下其底层的实现，在这里做个笔记。\n\n    LINUX下输入设备放在/dev/input/下，我的电脑该目录内容为：\n\n```shell\n\nlc@lc-Lenovo:~/work/sources$ cd /dev/input/\nlc@lc-Lenovo:/dev/input$ ls\nby-id    event0  event10  event3  event5  event7  event9  mouse0\nby-path  event1  event2   event4  event6  event8  mice\n\n```\n\n    这么多设备我们需要知道哪个设备对应鼠标哪个对应键盘，可以查看文件/proc/bus/input/devices，我的电脑下该文件鼠标和键盘相关信息为：\n\n```shell  \nI: Bus=0011 Vendor=0001 Product=0001 Version=ab41\nN: Name=\"AT Translated Set 2 keyboard\"\nP: Phys=isa0060/serio0/input0\nS: Sysfs=/devices/platform/i8042/serio0/input/input2\nU: Uniq=\nH: Handlers=sysrq kbd event2 \nB: PROP=0\nB: EV=120013\nB: KEY=4 2000000 3803078 f800d001 feffffdf ffefffff ffffffff fffffffe\nB: MSC=10\nB: LED=7\n\nI: Bus=0003 Vendor=17ef Product=6019 Version=0111\nN: Name=\"Logitech Lenovo USB Optical Mouse\"\nP: Phys=usb-0000:00:1d.0-1.4/input0\nS: Sysfs=/devices/pci0000:00/0000:00:1d.0/usb2/2-1/2-1.4/2-1.4:1.0/input/input3\nU: Uniq=\nH: Handlers=mouse0 event3 \nB: PROP=0\nB: EV=17\nB: KEY=70000 0 0 0 0 0 0 0 0\nB: REL=103\nB: MSC=10\n```\n\n可以看到鼠标对应的是event3键盘对应的是event2。\n\n    LINUX下每个设备都有一个ID，如果想监视一个设备的行为需要获取该设备句柄，然后交给SELECT或则epoll即可，对于输入设备也是一样。当SELECT循环检测到输入设备有数据可以读取的时候，调用相关接口获取输入设备信息再进一步分发判断具体的事件类型即可。LINUX下相关的数据结构为：\n\n```shell\nstruct input_event \n{\n    struct timeval time;  \t        //事件发生的时间\n    __u16 type; \t\t\t//事件类型\n    __u16 code; \t\t\t//事件的代码\n    __s32 value;\t\t\t//事件附带值\n};\n```\n\n该结构体定义在linux/input.h文件下。time表示事件发生的时间戳，type标识事件类型，主要的事件类型有：\n\n```c\n /*\n  * Event types\n  */\n \n #define EV_SYN                  0x00\n #define EV_KEY                  0x01\t//键盘事件\n #define EV_REL                  0x02\t//相对坐标\n #define EV_ABS                  0x03\t//绝对坐标\n #define EV_MSC                  0x04\n #define EV_SW                   0x05\n #define EV_LED                  0x11\n #define EV_SND                  0x12\n #define EV_REP                  0x14\n #define EV_FF                   0x15\n #define EV_PWR                  0x16\n #define EV_FF_STATUS            0x17\n #define EV_MAX                  0x1f\n #define EV_CNT                  (EV_MAX+1)\n```\n\n当type等于EV_KEY时，code的值为KEY_0,1,2...键盘上的按键，比较特殊的是，鼠标左键右键中间按下时键值分别为：BTN_LEFT/BTN_RIGHT/BTN_MIDDLE。EV_ABS表示绝对坐标事件，主要用于标识触摸屏下的用户触摸(touch)事件。此时事件代码code的值可能有ABS_X和ABS_Y两个，分别表示X轴坐标和Y轴坐标。如果事件的类型代码是EV_REL,code值表示轨迹的类型.如指示鼠标的X轴方向REL_X(代码为0x00),指示鼠标的Y轴方向REL_Y(代码为0x01),指示鼠标中轮子方向REL_WHEEL(代码为0x08）等。EV_SYN用于分割事件的一个标记，比如，鼠标按下会受到一个EV_KEY事件，紧接着就是一个EV_SYN事件，鼠标提起的时候也类似。\n\n输入事件分发示例代码：\n\n```c\nstatic RET_E source_input_dispatch(EVENT_SOURCE_T* pstThiz)\n{\n\tint nRet = 0;\n\tDECL_PRIV(pstThiz, priv);\n\tstruct input_event ievent;\n\tstatic int nCount = 0;\n\n\tnRet = read(priv->fd, &ievent, sizeof(ievent));\n\tif(nRet != sizeof(ievent))\n\t{\n\n\t\treturn;\n\t}\t\n\tswitch(ievent.type)\n\t{\n\t\tcase EV_KEY:\n\t\t{\n\t\t\tif(ievent.code == BTN_LEFT)\n\t\t\t{\n\t\t\t\tprintf(\"EV_KEY BTN_LEFT click\\n\");\n\t\t\t}\n\t\t\telse if(ievent.code == BTN_RIGHT)\n\t\t\t{\n\t\t\t\tprintf(\"EV_KEY BTN_RIGHT click\\n\");\n\t\t\t}\n\t\t\telse if(ievent.code == BTN_MIDDLE)\n\t\t\t{\n\t\t\t\tprintf(\"EV_KEY BTN_MIDDLE click\\n\");\n\t\t\t}\n\t\t\telse if(ievent.code == BTN_TOUCH)\n\t\t\t{\n\t\t\t\tprintf(\"EV_KEY BTN_TOUCH click\\n\");\n\t\t\t}\n\n\t\t\tif(ievent.code == BTN_LEFT || ievent.code == BTN_RIGHT\n\t\t\t\t|| ievent.code == BTN_MIDDLE || ievent.code == BTN_TOUCH)\n\t\t\t{\n\t\t\t\tpriv->stEvent.eType = ievent.value ? EVT_MOUSE_DOWN : EVT_MOUSE_UP;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tpriv->stEvent.eType = ievent.value ? EVT_KEY_DOWN : EVT_KEY_UP;\n\t\t\t\tpriv->stEvent.u.key.nCode = key_map(pstThiz, ievent.code);\n\t\t\t\tprintf(\"EVENT key code :%d\\n\", priv->stEvent.u.key.nCode);\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\t\tcase EV_ABS:\n\t\t{\n\t\t\tswitch(ievent.code)\n\t\t\t{\n\t\t\t\tcase ABS_X:\n\t\t\t\t{\n\t\t\t\t\tprintf(\"EV_ABS ABS_X value :%d\\n\", priv->x);\n\t\t\t\t\tpriv->x = ievent.value;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase ABS_Y:\n\t\t\t\t{\n\t\t\t\t\tprintf(\"EV_ABS ABS_Y value :%d\\n\", priv->y);\n\t\t\t\t\tpriv->y = ievent.value;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tdefault:\n\t\t\t\t{\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif(priv->stEvent.eType == EVT_NOP)\n\t\t\t{\n\t\t\t\t\n\t\t\t\tprintf(\"EV_ABS mouse move \\n\");\n\t\t\t\tpriv->stEvent.eType = EVT_MOUSE_MOVE;\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\t\tcase EV_REL:\n\t\t{\n\t\t\tswitch(ievent.code)\n\t\t\t{\n\t\t\t\tcase REL_X:\n\t\t\t\t{\n\t\t\t\t\tpriv->x += ievent.value;\n\t\t\t\t\tprintf(\"EV_REL REL_X value :%d\\n\", priv->x);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase REL_Y:\n\t\t\t\t{\n\t\t\t\t\tpriv->y += ievent.value;\n\t\t\t\t\tprintf(\"EV_REL REL_X value :%d\\n\", priv->y);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tdefault:break;\n\t\t\t}\n\t\t\tif(priv->stEvent.eType == EVT_NOP)\n\t\t\t{\n\t\t\t\tpriv->stEvent.eType = EVT_MOUSE_MOVE;\n\t\t\t\tprintf(\"EV_REL mouse move\\n\");\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\t\tcase EV_SYN:\n\t\t{\n\t\t\tif(priv->stEvent.eType == EVT_MOUSE_DOWN)\n\t\t\t{\n\t\t\t\tprintf(\"EV_SYN mouse down\\n\");\n\t\t\t}\n\t\t\telse if(priv->stEvent.eType == EVT_MOUSE_UP)\n\t\t\t{\t\n\t\t\t\tprintf(\"EV_SYN mouse up\\n\");\n\t\t\t}\n\t\t\telse if(priv->stEvent.eType == EVT_MOUSE_MOVE)\n\t\t\t{\t\n\t\t\t\tprintf(\"EV_SYN mouse move\\n\");\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\t\tdefault:break;\n\t}\n\treturn (RET_OK);\n}\n```\n\n鼠标左键按下提起事件捕获：\n\n![mouse](/img/linux-mouse.png)\n\n其他事件效果也是类似。","slug":"LINUX输入设备抽象","published":1,"updated":"2018-11-21T15:15:34.226Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cd1000py4zv3xjz028d","content":"<p>最近在些GUI程序，之前也写过一些。长久以来一直对其中一些问题有些好奇，如：鼠标事件和键盘事件是如何获取如何引入程序的，GUI底层绘制操作又是怎么实现的。最近花了点事件学习了下其底层的实现，在这里做个笔记。</p>\n<pre><code>LINUX下输入设备放在/dev/input/下，我的电脑该目录内容为：\n</code></pre><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">lc@lc-Lenovo:~/work/sources$ cd /dev/input/</span><br><span class=\"line\">lc@lc-Lenovo:/dev/input$ ls</span><br><span class=\"line\">by-id    event0  event10  event3  event5  event7  event9  mouse0</span><br><span class=\"line\">by-path  event1  event2   event4  event6  event8  mice</span><br></pre></td></tr></table></figure>\n<pre><code>这么多设备我们需要知道哪个设备对应鼠标哪个对应键盘，可以查看文件/proc/bus/input/devices，我的电脑下该文件鼠标和键盘相关信息为：\n</code></pre><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">I: Bus=0011 Vendor=0001 Product=0001 Version=ab41</span><br><span class=\"line\">N: Name=\"AT Translated Set 2 keyboard\"</span><br><span class=\"line\">P: Phys=isa0060/serio0/input0</span><br><span class=\"line\">S: Sysfs=/devices/platform/i8042/serio0/input/input2</span><br><span class=\"line\">U: Uniq=</span><br><span class=\"line\">H: Handlers=sysrq kbd event2 </span><br><span class=\"line\">B: PROP=0</span><br><span class=\"line\">B: EV=120013</span><br><span class=\"line\">B: KEY=4 2000000 3803078 f800d001 feffffdf ffefffff ffffffff fffffffe</span><br><span class=\"line\">B: MSC=10</span><br><span class=\"line\">B: LED=7</span><br><span class=\"line\"></span><br><span class=\"line\">I: Bus=0003 Vendor=17ef Product=6019 Version=0111</span><br><span class=\"line\">N: Name=\"Logitech Lenovo USB Optical Mouse\"</span><br><span class=\"line\">P: Phys=usb-0000:00:1d.0-1.4/input0</span><br><span class=\"line\">S: Sysfs=/devices/pci0000:00/0000:00:1d.0/usb2/2-1/2-1.4/2-1.4:1.0/input/input3</span><br><span class=\"line\">U: Uniq=</span><br><span class=\"line\">H: Handlers=mouse0 event3 </span><br><span class=\"line\">B: PROP=0</span><br><span class=\"line\">B: EV=17</span><br><span class=\"line\">B: KEY=70000 0 0 0 0 0 0 0 0</span><br><span class=\"line\">B: REL=103</span><br><span class=\"line\">B: MSC=10</span><br></pre></td></tr></table></figure>\n<p>可以看到鼠标对应的是event3键盘对应的是event2。</p>\n<pre><code>LINUX下每个设备都有一个ID，如果想监视一个设备的行为需要获取该设备句柄，然后交给SELECT或则epoll即可，对于输入设备也是一样。当SELECT循环检测到输入设备有数据可以读取的时候，调用相关接口获取输入设备信息再进一步分发判断具体的事件类型即可。LINUX下相关的数据结构为：\n</code></pre><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">struct input_event </span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    struct timeval time;  \t        //事件发生的时间</span><br><span class=\"line\">    __u16 type; \t\t\t//事件类型</span><br><span class=\"line\">    __u16 code; \t\t\t//事件的代码</span><br><span class=\"line\">    __s32 value;\t\t\t//事件附带值</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>该结构体定义在linux/input.h文件下。time表示事件发生的时间戳，type标识事件类型，主要的事件类型有：</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\"> * Event types</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> EV_SYN                  0x00</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> EV_KEY                  0x01\t<span class=\"comment\">//键盘事件</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> EV_REL                  0x02\t<span class=\"comment\">//相对坐标</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> EV_ABS                  0x03\t<span class=\"comment\">//绝对坐标</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> EV_MSC                  0x04</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> EV_SW                   0x05</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> EV_LED                  0x11</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> EV_SND                  0x12</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> EV_REP                  0x14</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> EV_FF                   0x15</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> EV_PWR                  0x16</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> EV_FF_STATUS            0x17</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> EV_MAX                  0x1f</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> EV_CNT                  (EV_MAX+1)</span></span><br></pre></td></tr></table></figure>\n<p>当type等于EV_KEY时，code的值为KEY_0,1,2…键盘上的按键，比较特殊的是，鼠标左键右键中间按下时键值分别为：BTN_LEFT/BTN_RIGHT/BTN_MIDDLE。EV_ABS表示绝对坐标事件，主要用于标识触摸屏下的用户触摸(touch)事件。此时事件代码code的值可能有ABS_X和ABS_Y两个，分别表示X轴坐标和Y轴坐标。如果事件的类型代码是EV_REL,code值表示轨迹的类型.如指示鼠标的X轴方向REL_X(代码为0x00),指示鼠标的Y轴方向REL_Y(代码为0x01),指示鼠标中轮子方向REL_WHEEL(代码为0x08）等。EV_SYN用于分割事件的一个标记，比如，鼠标按下会受到一个EV_KEY事件，紧接着就是一个EV_SYN事件，鼠标提起的时候也类似。</p>\n<p>输入事件分发示例代码：</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> RET_E <span class=\"title\">source_input_dispatch</span><span class=\"params\">(EVENT_SOURCE_T* pstThiz)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">int</span> nRet = <span class=\"number\">0</span>;</span><br><span class=\"line\">\tDECL_PRIV(pstThiz, priv);</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">input_event</span> <span class=\"title\">ievent</span>;</span></span><br><span class=\"line\">\t<span class=\"keyword\">static</span> <span class=\"keyword\">int</span> nCount = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\tnRet = read(priv-&gt;fd, &amp;ievent, <span class=\"keyword\">sizeof</span>(ievent));</span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(nRet != <span class=\"keyword\">sizeof</span>(ievent))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">\t&#125;\t</span><br><span class=\"line\">\t<span class=\"keyword\">switch</span>(ievent.type)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> EV_KEY:</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span>(ievent.code == BTN_LEFT)</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">\"EV_KEY BTN_LEFT click\\n\"</span>);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(ievent.code == BTN_RIGHT)</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">\"EV_KEY BTN_RIGHT click\\n\"</span>);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(ievent.code == BTN_MIDDLE)</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">\"EV_KEY BTN_MIDDLE click\\n\"</span>);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(ievent.code == BTN_TOUCH)</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">\"EV_KEY BTN_TOUCH click\\n\"</span>);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span>(ievent.code == BTN_LEFT || ievent.code == BTN_RIGHT</span><br><span class=\"line\">\t\t\t\t|| ievent.code == BTN_MIDDLE || ievent.code == BTN_TOUCH)</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\tpriv-&gt;stEvent.eType = ievent.value ? EVT_MOUSE_DOWN : EVT_MOUSE_UP;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">else</span></span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\tpriv-&gt;stEvent.eType = ievent.value ? EVT_KEY_DOWN : EVT_KEY_UP;</span><br><span class=\"line\">\t\t\t\tpriv-&gt;stEvent.u.key.nCode = key_map(pstThiz, ievent.code);</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">\"EVENT key code :%d\\n\"</span>, priv-&gt;stEvent.u.key.nCode);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> EV_ABS:</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">switch</span>(ievent.code)</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> ABS_X:</span><br><span class=\"line\">\t\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">\"EV_ABS ABS_X value :%d\\n\"</span>, priv-&gt;x);</span><br><span class=\"line\">\t\t\t\t\tpriv-&gt;x = ievent.value;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> ABS_Y:</span><br><span class=\"line\">\t\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">\"EV_ABS ABS_Y value :%d\\n\"</span>, priv-&gt;y);</span><br><span class=\"line\">\t\t\t\t\tpriv-&gt;y = ievent.value;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">default</span>:</span><br><span class=\"line\">\t\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span>(priv-&gt;stEvent.eType == EVT_NOP)</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">\"EV_ABS mouse move \\n\"</span>);</span><br><span class=\"line\">\t\t\t\tpriv-&gt;stEvent.eType = EVT_MOUSE_MOVE;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> EV_REL:</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">switch</span>(ievent.code)</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> REL_X:</span><br><span class=\"line\">\t\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t\tpriv-&gt;x += ievent.value;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">\"EV_REL REL_X value :%d\\n\"</span>, priv-&gt;x);</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> REL_Y:</span><br><span class=\"line\">\t\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t\tpriv-&gt;y += ievent.value;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">\"EV_REL REL_X value :%d\\n\"</span>, priv-&gt;y);</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">default</span>:<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span>(priv-&gt;stEvent.eType == EVT_NOP)</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\tpriv-&gt;stEvent.eType = EVT_MOUSE_MOVE;</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">\"EV_REL mouse move\\n\"</span>);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> EV_SYN:</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span>(priv-&gt;stEvent.eType == EVT_MOUSE_DOWN)</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">\"EV_SYN mouse down\\n\"</span>);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(priv-&gt;stEvent.eType == EVT_MOUSE_UP)</span><br><span class=\"line\">\t\t\t&#123;\t</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">\"EV_SYN mouse up\\n\"</span>);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(priv-&gt;stEvent.eType == EVT_MOUSE_MOVE)</span><br><span class=\"line\">\t\t\t&#123;\t</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">\"EV_SYN mouse move\\n\"</span>);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">default</span>:<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> (RET_OK);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>鼠标左键按下提起事件捕获：</p>\n<p><img src=\"/img/linux-mouse.png\" alt=\"mouse\"></p>\n<p>其他事件效果也是类似。</p>\n","site":{"data":{}},"excerpt":"","more":"<p>最近在些GUI程序，之前也写过一些。长久以来一直对其中一些问题有些好奇，如：鼠标事件和键盘事件是如何获取如何引入程序的，GUI底层绘制操作又是怎么实现的。最近花了点事件学习了下其底层的实现，在这里做个笔记。</p>\n<pre><code>LINUX下输入设备放在/dev/input/下，我的电脑该目录内容为：\n</code></pre><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">lc@lc-Lenovo:~/work/sources$ cd /dev/input/</span><br><span class=\"line\">lc@lc-Lenovo:/dev/input$ ls</span><br><span class=\"line\">by-id    event0  event10  event3  event5  event7  event9  mouse0</span><br><span class=\"line\">by-path  event1  event2   event4  event6  event8  mice</span><br></pre></td></tr></table></figure>\n<pre><code>这么多设备我们需要知道哪个设备对应鼠标哪个对应键盘，可以查看文件/proc/bus/input/devices，我的电脑下该文件鼠标和键盘相关信息为：\n</code></pre><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">I: Bus=0011 Vendor=0001 Product=0001 Version=ab41</span><br><span class=\"line\">N: Name=\"AT Translated Set 2 keyboard\"</span><br><span class=\"line\">P: Phys=isa0060/serio0/input0</span><br><span class=\"line\">S: Sysfs=/devices/platform/i8042/serio0/input/input2</span><br><span class=\"line\">U: Uniq=</span><br><span class=\"line\">H: Handlers=sysrq kbd event2 </span><br><span class=\"line\">B: PROP=0</span><br><span class=\"line\">B: EV=120013</span><br><span class=\"line\">B: KEY=4 2000000 3803078 f800d001 feffffdf ffefffff ffffffff fffffffe</span><br><span class=\"line\">B: MSC=10</span><br><span class=\"line\">B: LED=7</span><br><span class=\"line\"></span><br><span class=\"line\">I: Bus=0003 Vendor=17ef Product=6019 Version=0111</span><br><span class=\"line\">N: Name=\"Logitech Lenovo USB Optical Mouse\"</span><br><span class=\"line\">P: Phys=usb-0000:00:1d.0-1.4/input0</span><br><span class=\"line\">S: Sysfs=/devices/pci0000:00/0000:00:1d.0/usb2/2-1/2-1.4/2-1.4:1.0/input/input3</span><br><span class=\"line\">U: Uniq=</span><br><span class=\"line\">H: Handlers=mouse0 event3 </span><br><span class=\"line\">B: PROP=0</span><br><span class=\"line\">B: EV=17</span><br><span class=\"line\">B: KEY=70000 0 0 0 0 0 0 0 0</span><br><span class=\"line\">B: REL=103</span><br><span class=\"line\">B: MSC=10</span><br></pre></td></tr></table></figure>\n<p>可以看到鼠标对应的是event3键盘对应的是event2。</p>\n<pre><code>LINUX下每个设备都有一个ID，如果想监视一个设备的行为需要获取该设备句柄，然后交给SELECT或则epoll即可，对于输入设备也是一样。当SELECT循环检测到输入设备有数据可以读取的时候，调用相关接口获取输入设备信息再进一步分发判断具体的事件类型即可。LINUX下相关的数据结构为：\n</code></pre><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">struct input_event </span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    struct timeval time;  \t        //事件发生的时间</span><br><span class=\"line\">    __u16 type; \t\t\t//事件类型</span><br><span class=\"line\">    __u16 code; \t\t\t//事件的代码</span><br><span class=\"line\">    __s32 value;\t\t\t//事件附带值</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>该结构体定义在linux/input.h文件下。time表示事件发生的时间戳，type标识事件类型，主要的事件类型有：</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\"> * Event types</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> EV_SYN                  0x00</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> EV_KEY                  0x01\t<span class=\"comment\">//键盘事件</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> EV_REL                  0x02\t<span class=\"comment\">//相对坐标</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> EV_ABS                  0x03\t<span class=\"comment\">//绝对坐标</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> EV_MSC                  0x04</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> EV_SW                   0x05</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> EV_LED                  0x11</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> EV_SND                  0x12</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> EV_REP                  0x14</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> EV_FF                   0x15</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> EV_PWR                  0x16</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> EV_FF_STATUS            0x17</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> EV_MAX                  0x1f</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> EV_CNT                  (EV_MAX+1)</span></span><br></pre></td></tr></table></figure>\n<p>当type等于EV_KEY时，code的值为KEY_0,1,2…键盘上的按键，比较特殊的是，鼠标左键右键中间按下时键值分别为：BTN_LEFT/BTN_RIGHT/BTN_MIDDLE。EV_ABS表示绝对坐标事件，主要用于标识触摸屏下的用户触摸(touch)事件。此时事件代码code的值可能有ABS_X和ABS_Y两个，分别表示X轴坐标和Y轴坐标。如果事件的类型代码是EV_REL,code值表示轨迹的类型.如指示鼠标的X轴方向REL_X(代码为0x00),指示鼠标的Y轴方向REL_Y(代码为0x01),指示鼠标中轮子方向REL_WHEEL(代码为0x08）等。EV_SYN用于分割事件的一个标记，比如，鼠标按下会受到一个EV_KEY事件，紧接着就是一个EV_SYN事件，鼠标提起的时候也类似。</p>\n<p>输入事件分发示例代码：</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> RET_E <span class=\"title\">source_input_dispatch</span><span class=\"params\">(EVENT_SOURCE_T* pstThiz)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">int</span> nRet = <span class=\"number\">0</span>;</span><br><span class=\"line\">\tDECL_PRIV(pstThiz, priv);</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">input_event</span> <span class=\"title\">ievent</span>;</span></span><br><span class=\"line\">\t<span class=\"keyword\">static</span> <span class=\"keyword\">int</span> nCount = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\tnRet = read(priv-&gt;fd, &amp;ievent, <span class=\"keyword\">sizeof</span>(ievent));</span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(nRet != <span class=\"keyword\">sizeof</span>(ievent))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">\t&#125;\t</span><br><span class=\"line\">\t<span class=\"keyword\">switch</span>(ievent.type)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> EV_KEY:</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span>(ievent.code == BTN_LEFT)</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">\"EV_KEY BTN_LEFT click\\n\"</span>);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(ievent.code == BTN_RIGHT)</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">\"EV_KEY BTN_RIGHT click\\n\"</span>);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(ievent.code == BTN_MIDDLE)</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">\"EV_KEY BTN_MIDDLE click\\n\"</span>);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(ievent.code == BTN_TOUCH)</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">\"EV_KEY BTN_TOUCH click\\n\"</span>);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span>(ievent.code == BTN_LEFT || ievent.code == BTN_RIGHT</span><br><span class=\"line\">\t\t\t\t|| ievent.code == BTN_MIDDLE || ievent.code == BTN_TOUCH)</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\tpriv-&gt;stEvent.eType = ievent.value ? EVT_MOUSE_DOWN : EVT_MOUSE_UP;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">else</span></span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\tpriv-&gt;stEvent.eType = ievent.value ? EVT_KEY_DOWN : EVT_KEY_UP;</span><br><span class=\"line\">\t\t\t\tpriv-&gt;stEvent.u.key.nCode = key_map(pstThiz, ievent.code);</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">\"EVENT key code :%d\\n\"</span>, priv-&gt;stEvent.u.key.nCode);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> EV_ABS:</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">switch</span>(ievent.code)</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> ABS_X:</span><br><span class=\"line\">\t\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">\"EV_ABS ABS_X value :%d\\n\"</span>, priv-&gt;x);</span><br><span class=\"line\">\t\t\t\t\tpriv-&gt;x = ievent.value;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> ABS_Y:</span><br><span class=\"line\">\t\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">\"EV_ABS ABS_Y value :%d\\n\"</span>, priv-&gt;y);</span><br><span class=\"line\">\t\t\t\t\tpriv-&gt;y = ievent.value;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">default</span>:</span><br><span class=\"line\">\t\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span>(priv-&gt;stEvent.eType == EVT_NOP)</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">\"EV_ABS mouse move \\n\"</span>);</span><br><span class=\"line\">\t\t\t\tpriv-&gt;stEvent.eType = EVT_MOUSE_MOVE;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> EV_REL:</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">switch</span>(ievent.code)</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> REL_X:</span><br><span class=\"line\">\t\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t\tpriv-&gt;x += ievent.value;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">\"EV_REL REL_X value :%d\\n\"</span>, priv-&gt;x);</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> REL_Y:</span><br><span class=\"line\">\t\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t\tpriv-&gt;y += ievent.value;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">\"EV_REL REL_X value :%d\\n\"</span>, priv-&gt;y);</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">default</span>:<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span>(priv-&gt;stEvent.eType == EVT_NOP)</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\tpriv-&gt;stEvent.eType = EVT_MOUSE_MOVE;</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">\"EV_REL mouse move\\n\"</span>);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> EV_SYN:</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span>(priv-&gt;stEvent.eType == EVT_MOUSE_DOWN)</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">\"EV_SYN mouse down\\n\"</span>);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(priv-&gt;stEvent.eType == EVT_MOUSE_UP)</span><br><span class=\"line\">\t\t\t&#123;\t</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">\"EV_SYN mouse up\\n\"</span>);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(priv-&gt;stEvent.eType == EVT_MOUSE_MOVE)</span><br><span class=\"line\">\t\t\t&#123;\t</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">printf</span>(<span class=\"string\">\"EV_SYN mouse move\\n\"</span>);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">default</span>:<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> (RET_OK);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>鼠标左键按下提起事件捕获：</p>\n<p><img src=\"/img/linux-mouse.png\" alt=\"mouse\"></p>\n<p>其他事件效果也是类似。</p>\n"},{"title":"MobX知识图谱","date":"2019-02-23T09:04:27.000Z","_content":"\n![MobX-知识图谱](/img/MobX-知识图谱.png)\n\n在线连接: [MobX-知识图谱](https://www.processon.com/mindmap/5c667601e4b07fada4e735d5)","source":"_posts/MobX知识图谱.md","raw":"---\ntitle: MobX知识图谱\ndate: 2019-02-23 17:04:27\ntags: mobx\ncategories: web\n---\n\n![MobX-知识图谱](/img/MobX-知识图谱.png)\n\n在线连接: [MobX-知识图谱](https://www.processon.com/mindmap/5c667601e4b07fada4e735d5)","slug":"MobX知识图谱","published":1,"updated":"2019-02-23T09:09:36.132Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cd1000sy4zvuzltqoc0","content":"<p><img src=\"/img/MobX-知识图谱.png\" alt=\"MobX-知识图谱\"></p>\n<p>在线连接: <a href=\"https://www.processon.com/mindmap/5c667601e4b07fada4e735d5\" target=\"_blank\" rel=\"noopener\">MobX-知识图谱</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p><img src=\"/img/MobX-知识图谱.png\" alt=\"MobX-知识图谱\"></p>\n<p>在线连接: <a href=\"https://www.processon.com/mindmap/5c667601e4b07fada4e735d5\" target=\"_blank\" rel=\"noopener\">MobX-知识图谱</a></p>\n"},{"title":"ES6 属性遍历","date":"2017-06-15T11:08:42.000Z","_content":"\n![ES6 CheatSheet](/img/javascript-prop-iter.png)\n\n在线连接: [ES6 Property iter CheatSheet](https://www.processon.com/mindmap/5ad82c3de4b0518eacbeee90)\n","source":"_posts/ES6 属性遍历.md","raw":"---\ntitle: ES6 属性遍历\ndate: 2017-06-15 19:08:42\ntags: \n  - es6\n  - cheatsheet\n  - propertys\ncategories: javascript\n---\n\n![ES6 CheatSheet](/img/javascript-prop-iter.png)\n\n在线连接: [ES6 Property iter CheatSheet](https://www.processon.com/mindmap/5ad82c3de4b0518eacbeee90)\n","slug":"ES6 属性遍历","published":1,"updated":"2018-10-26T06:34:52.365Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cd3000wy4zv6qk23euk","content":"<p><img src=\"/img/javascript-prop-iter.png\" alt=\"ES6 CheatSheet\"></p>\n<p>在线连接: <a href=\"https://www.processon.com/mindmap/5ad82c3de4b0518eacbeee90\" target=\"_blank\" rel=\"noopener\">ES6 Property iter CheatSheet</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p><img src=\"/img/javascript-prop-iter.png\" alt=\"ES6 CheatSheet\"></p>\n<p>在线连接: <a href=\"https://www.processon.com/mindmap/5ad82c3de4b0518eacbeee90\" target=\"_blank\" rel=\"noopener\">ES6 Property iter CheatSheet</a></p>\n"},{"title":"React知识图谱","date":"2019-03-04T15:03:37.000Z","_content":"\n\n![React-知识图谱](/img/React-知识图谱.png)\n\n在线连接: [React-知识图谱](https://www.processon.com/mindmap/5c74fae4e4b03334b52ab8a7)","source":"_posts/React知识图谱.md","raw":"---\ntitle: React知识图谱\ndate: 2019-03-04 23:03:37\ntags: react\ncategories: web\n---\n\n\n![React-知识图谱](/img/React-知识图谱.png)\n\n在线连接: [React-知识图谱](https://www.processon.com/mindmap/5c74fae4e4b03334b52ab8a7)","slug":"React知识图谱","published":1,"updated":"2019-03-04T15:06:30.906Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cd40010y4zvezhjn8lt","content":"<p><img src=\"/img/React-知识图谱.png\" alt=\"React-知识图谱\"></p>\n<p>在线连接: <a href=\"https://www.processon.com/mindmap/5c74fae4e4b03334b52ab8a7\" target=\"_blank\" rel=\"noopener\">React-知识图谱</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p><img src=\"/img/React-知识图谱.png\" alt=\"React-知识图谱\"></p>\n<p>在线连接: <a href=\"https://www.processon.com/mindmap/5c74fae4e4b03334b52ab8a7\" target=\"_blank\" rel=\"noopener\">React-知识图谱</a></p>\n"},{"title":"Linux下SSH操作解析","date":"2015-01-13T15:19:34.000Z","_content":"\n### 1.查看SSH状态：\n\nservice sshd status\n\n查看ssh是否已经启动以及一些状态信息\n\n### 2.启动SSH服务：\nsystemctl restart sshd.service\n\nps:fedora下的一些基本服务都是通过systemctl restart/stop xxx.service操作来控制的，例如apache的服务器：httpd.service、防火墙服务firewalld.service等。\n\n### 3.SSH配置文件路径：\n/etc/ssh/sshd_config。配置ssh连接的端口号，权限等信息\n\n### 4.关闭防火墙\nsystemctl disable firewalld.service\n\n    把防火墙整个关闭不太合适，使用下面的命令比较好一些：\n\n### 5.将端口22（或者自定义的其他端口）加到防火墙的设置中，标记为Accept\niptables -A INPUT -p tcp --dport 22 -j ACCEPT\n\n    查看ssh的配置文件可以看到默认端口号是22，所以在防火墙解除屏蔽\n\n### 6.防火墙配置文件路径：\n/etc/sysconfig/iptables\n\n    SSH组件的一些基本操作：\n\n首先登录远程服务器：\n\n    ssh user@192.168.1.28\n\n    user表示远程服务器的用户名，这里需要输入密码。\n\n利用scp进行文件操作：\n\n文件上传：scp -r /home/xxx user@192.168.1.28:/home/xxx\n\n文件下载：和文件上传的路径对调下就OK了。\n\n利用sftp进行文件上传和下载：\n\nsftp和ftp工具操作类似，便于目录资源的管理。\n\n登录：\n\n格式：sftp -oPort=<port> <user>@<host>\n通过sftp连接<host>，端口为<port>，用户为<user>。\n\n\nsftp连接成功之后常用操作命令如下：\nhelp/? 打印帮助信息。\n\n```shell\npwd 查看远程服务器当前目录；\n\nlpwd 查看本地系统的当前目录。\n\ncd <dir> 将远程服务器的当前目录更改为<dir>\n\nlcd <dir> 将本地系统的当前目录更改为<dir>。\n\nls 显示远程服务器上当前目录的文件名；\n\nls -l 显示远程服务器上当前目录的文件详细列表\n\nls <pattern> 显示远程服务器上符合指定模式<pattern>的文件名；\n\nls -l <pattern> 显示远程服务器上符合指定模式<pattern>的文件详细列表。\n\nlls 显示本地系统上当前目录的文件名；\n\nlls的其他参数与ls命令的类似。\n\nget <file> 下载指定文件<file>；\nget <pattern> 下载符合指定模式<pattern>的文件。\nput <file> 上传指定文件<file>；  \nget <pattern> 上传符合指定模式<pattern>的文件。  \nprogress 切换是否显示文件传输进度。\nmkdir <dir> 在远程服务器上创建目录；   \n\nlmkdir <dir> 在本地系统上创建目录。  \n\nexit/quit/bye 退出sftp。  \n! 启动一个本地shell。  \n! <commandline> 执行本地命令行。\n\n其他命令还有：chgrp, chmod, chown, ln, lumask, rename, rm, rmdir, symlink, version。\n\n谨记：在sftp模式下对本地文件的操作前面会多一个'l'\n```\n\n\n免密码登陆：\n\nssh提供了一套密钥对验证机制，把公钥文件上传服务器，并导入公钥库文件。这样客户端在以后不用输入密码可以登陆了。\n\n### 一、生成密钥文件：\n\n```shell\n[luncher@localhost test]$ ssh-keygen -t rsa\nGenerating public/private rsa key pair.\nEnter file in which to save the key (/home/luncher/.ssh/id_rsa): \nEnter passphrase (empty for no passphrase): \nEnter same passphrase again: \nYour identification has been saved in /home/luncher/.ssh/id_rsa.\nYour public key has been saved in /home/luncher/.ssh/id_rsa.pub.\nThe key fingerprint is:\n9e:39:ec:d8:fa:46:02:6a:d1:36:b9:83:04:75:95:b9 luncher@localhost.localdomain\nThe key's randomart image is:\n+--[ RSA 2048]----+\n| .. ...o         |\n|.  .  o          |\n| . . . .         |\n|  o * E          |\n| . = +  S        |\n|  + o .o.o       |\n| .   . o*        |\n|       +..       |\n|      o++        |\n+-----------------+\n\n```\n\n### 二、利用scp命令把公钥拷贝到服务器\n\n```shell\n\n[luncher@localhost test]$ scp /home/luncher/.ssh/id_rsa.pub luncher@192.168.1.17:/tmp\nid_rsa.pub                                    100%  411     0.4KB/s   00:00    \n[luncher@localhost test]$ \n\n```\n\n### 三、在服务器端把公钥导入验证key文件\n\n```shell\ncat /tmp/id_rsa.pub /home/luncher/.ssh/authorized_keys\n```\n\n### 四、用ssh-agent和ssh-add管理密钥\nssh-agent是用于管理密钥，ssh-add用于将密钥加入到ssh-agent中，SSH可以和ssh-agent通信获取密钥，这样就不需要用户手工输入密码了。\n\n\nEnd~\n","source":"_posts/Linux下SSH操作解析.md","raw":"---\ntitle: Linux下SSH操作解析\ndate: 2015-01-13 23:19:34\ntags: ssh\ncategories: server\n---\n\n### 1.查看SSH状态：\n\nservice sshd status\n\n查看ssh是否已经启动以及一些状态信息\n\n### 2.启动SSH服务：\nsystemctl restart sshd.service\n\nps:fedora下的一些基本服务都是通过systemctl restart/stop xxx.service操作来控制的，例如apache的服务器：httpd.service、防火墙服务firewalld.service等。\n\n### 3.SSH配置文件路径：\n/etc/ssh/sshd_config。配置ssh连接的端口号，权限等信息\n\n### 4.关闭防火墙\nsystemctl disable firewalld.service\n\n    把防火墙整个关闭不太合适，使用下面的命令比较好一些：\n\n### 5.将端口22（或者自定义的其他端口）加到防火墙的设置中，标记为Accept\niptables -A INPUT -p tcp --dport 22 -j ACCEPT\n\n    查看ssh的配置文件可以看到默认端口号是22，所以在防火墙解除屏蔽\n\n### 6.防火墙配置文件路径：\n/etc/sysconfig/iptables\n\n    SSH组件的一些基本操作：\n\n首先登录远程服务器：\n\n    ssh user@192.168.1.28\n\n    user表示远程服务器的用户名，这里需要输入密码。\n\n利用scp进行文件操作：\n\n文件上传：scp -r /home/xxx user@192.168.1.28:/home/xxx\n\n文件下载：和文件上传的路径对调下就OK了。\n\n利用sftp进行文件上传和下载：\n\nsftp和ftp工具操作类似，便于目录资源的管理。\n\n登录：\n\n格式：sftp -oPort=<port> <user>@<host>\n通过sftp连接<host>，端口为<port>，用户为<user>。\n\n\nsftp连接成功之后常用操作命令如下：\nhelp/? 打印帮助信息。\n\n```shell\npwd 查看远程服务器当前目录；\n\nlpwd 查看本地系统的当前目录。\n\ncd <dir> 将远程服务器的当前目录更改为<dir>\n\nlcd <dir> 将本地系统的当前目录更改为<dir>。\n\nls 显示远程服务器上当前目录的文件名；\n\nls -l 显示远程服务器上当前目录的文件详细列表\n\nls <pattern> 显示远程服务器上符合指定模式<pattern>的文件名；\n\nls -l <pattern> 显示远程服务器上符合指定模式<pattern>的文件详细列表。\n\nlls 显示本地系统上当前目录的文件名；\n\nlls的其他参数与ls命令的类似。\n\nget <file> 下载指定文件<file>；\nget <pattern> 下载符合指定模式<pattern>的文件。\nput <file> 上传指定文件<file>；  \nget <pattern> 上传符合指定模式<pattern>的文件。  \nprogress 切换是否显示文件传输进度。\nmkdir <dir> 在远程服务器上创建目录；   \n\nlmkdir <dir> 在本地系统上创建目录。  \n\nexit/quit/bye 退出sftp。  \n! 启动一个本地shell。  \n! <commandline> 执行本地命令行。\n\n其他命令还有：chgrp, chmod, chown, ln, lumask, rename, rm, rmdir, symlink, version。\n\n谨记：在sftp模式下对本地文件的操作前面会多一个'l'\n```\n\n\n免密码登陆：\n\nssh提供了一套密钥对验证机制，把公钥文件上传服务器，并导入公钥库文件。这样客户端在以后不用输入密码可以登陆了。\n\n### 一、生成密钥文件：\n\n```shell\n[luncher@localhost test]$ ssh-keygen -t rsa\nGenerating public/private rsa key pair.\nEnter file in which to save the key (/home/luncher/.ssh/id_rsa): \nEnter passphrase (empty for no passphrase): \nEnter same passphrase again: \nYour identification has been saved in /home/luncher/.ssh/id_rsa.\nYour public key has been saved in /home/luncher/.ssh/id_rsa.pub.\nThe key fingerprint is:\n9e:39:ec:d8:fa:46:02:6a:d1:36:b9:83:04:75:95:b9 luncher@localhost.localdomain\nThe key's randomart image is:\n+--[ RSA 2048]----+\n| .. ...o         |\n|.  .  o          |\n| . . . .         |\n|  o * E          |\n| . = +  S        |\n|  + o .o.o       |\n| .   . o*        |\n|       +..       |\n|      o++        |\n+-----------------+\n\n```\n\n### 二、利用scp命令把公钥拷贝到服务器\n\n```shell\n\n[luncher@localhost test]$ scp /home/luncher/.ssh/id_rsa.pub luncher@192.168.1.17:/tmp\nid_rsa.pub                                    100%  411     0.4KB/s   00:00    \n[luncher@localhost test]$ \n\n```\n\n### 三、在服务器端把公钥导入验证key文件\n\n```shell\ncat /tmp/id_rsa.pub /home/luncher/.ssh/authorized_keys\n```\n\n### 四、用ssh-agent和ssh-add管理密钥\nssh-agent是用于管理密钥，ssh-add用于将密钥加入到ssh-agent中，SSH可以和ssh-agent通信获取密钥，这样就不需要用户手工输入密码了。\n\n\nEnd~\n","slug":"Linux下SSH操作解析","published":1,"updated":"2018-11-21T15:00:11.699Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cd50014y4zv6tijxfmf","content":"<h3 id=\"1-查看SSH状态：\"><a href=\"#1-查看SSH状态：\" class=\"headerlink\" title=\"1.查看SSH状态：\"></a>1.查看SSH状态：</h3><p>service sshd status</p>\n<p>查看ssh是否已经启动以及一些状态信息</p>\n<h3 id=\"2-启动SSH服务：\"><a href=\"#2-启动SSH服务：\" class=\"headerlink\" title=\"2.启动SSH服务：\"></a>2.启动SSH服务：</h3><p>systemctl restart sshd.service</p>\n<p>ps:fedora下的一些基本服务都是通过systemctl restart/stop xxx.service操作来控制的，例如apache的服务器：httpd.service、防火墙服务firewalld.service等。</p>\n<h3 id=\"3-SSH配置文件路径：\"><a href=\"#3-SSH配置文件路径：\" class=\"headerlink\" title=\"3.SSH配置文件路径：\"></a>3.SSH配置文件路径：</h3><p>/etc/ssh/sshd_config。配置ssh连接的端口号，权限等信息</p>\n<h3 id=\"4-关闭防火墙\"><a href=\"#4-关闭防火墙\" class=\"headerlink\" title=\"4.关闭防火墙\"></a>4.关闭防火墙</h3><p>systemctl disable firewalld.service</p>\n<pre><code>把防火墙整个关闭不太合适，使用下面的命令比较好一些：\n</code></pre><h3 id=\"5-将端口22（或者自定义的其他端口）加到防火墙的设置中，标记为Accept\"><a href=\"#5-将端口22（或者自定义的其他端口）加到防火墙的设置中，标记为Accept\" class=\"headerlink\" title=\"5.将端口22（或者自定义的其他端口）加到防火墙的设置中，标记为Accept\"></a>5.将端口22（或者自定义的其他端口）加到防火墙的设置中，标记为Accept</h3><p>iptables -A INPUT -p tcp –dport 22 -j ACCEPT</p>\n<pre><code>查看ssh的配置文件可以看到默认端口号是22，所以在防火墙解除屏蔽\n</code></pre><h3 id=\"6-防火墙配置文件路径：\"><a href=\"#6-防火墙配置文件路径：\" class=\"headerlink\" title=\"6.防火墙配置文件路径：\"></a>6.防火墙配置文件路径：</h3><p>/etc/sysconfig/iptables</p>\n<pre><code>SSH组件的一些基本操作：\n</code></pre><p>首先登录远程服务器：</p>\n<pre><code>ssh user@192.168.1.28\n\nuser表示远程服务器的用户名，这里需要输入密码。\n</code></pre><p>利用scp进行文件操作：</p>\n<p>文件上传：scp -r /home/xxx <a href=\"mailto:user@192.168.1.28\" target=\"_blank\" rel=\"noopener\">user@192.168.1.28</a>:/home/xxx</p>\n<p>文件下载：和文件上传的路径对调下就OK了。</p>\n<p>利用sftp进行文件上传和下载：</p>\n<p>sftp和ftp工具操作类似，便于目录资源的管理。</p>\n<p>登录：</p>\n<p>格式：sftp -oPort=<port> <user>@<host><br>通过sftp连接<host>，端口为<port>，用户为<user>。</user></port></host></host></user></port></p>\n<p>sftp连接成功之后常用操作命令如下：<br>help/? 打印帮助信息。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwd 查看远程服务器当前目录；</span><br><span class=\"line\"></span><br><span class=\"line\">lpwd 查看本地系统的当前目录。</span><br><span class=\"line\"></span><br><span class=\"line\">cd &lt;dir&gt; 将远程服务器的当前目录更改为&lt;dir&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">lcd &lt;dir&gt; 将本地系统的当前目录更改为&lt;dir&gt;。</span><br><span class=\"line\"></span><br><span class=\"line\">ls 显示远程服务器上当前目录的文件名；</span><br><span class=\"line\"></span><br><span class=\"line\">ls -l 显示远程服务器上当前目录的文件详细列表</span><br><span class=\"line\"></span><br><span class=\"line\">ls &lt;pattern&gt; 显示远程服务器上符合指定模式&lt;pattern&gt;的文件名；</span><br><span class=\"line\"></span><br><span class=\"line\">ls -l &lt;pattern&gt; 显示远程服务器上符合指定模式&lt;pattern&gt;的文件详细列表。</span><br><span class=\"line\"></span><br><span class=\"line\">lls 显示本地系统上当前目录的文件名；</span><br><span class=\"line\"></span><br><span class=\"line\">lls的其他参数与ls命令的类似。</span><br><span class=\"line\"></span><br><span class=\"line\">get &lt;file&gt; 下载指定文件&lt;file&gt;；</span><br><span class=\"line\">get &lt;pattern&gt; 下载符合指定模式&lt;pattern&gt;的文件。</span><br><span class=\"line\">put &lt;file&gt; 上传指定文件&lt;file&gt;；  </span><br><span class=\"line\">get &lt;pattern&gt; 上传符合指定模式&lt;pattern&gt;的文件。  </span><br><span class=\"line\">progress 切换是否显示文件传输进度。</span><br><span class=\"line\">mkdir &lt;dir&gt; 在远程服务器上创建目录；   </span><br><span class=\"line\"></span><br><span class=\"line\">lmkdir &lt;dir&gt; 在本地系统上创建目录。  </span><br><span class=\"line\"></span><br><span class=\"line\">exit/quit/bye 退出sftp。  </span><br><span class=\"line\">! 启动一个本地shell。  </span><br><span class=\"line\">! &lt;commandline&gt; 执行本地命令行。</span><br><span class=\"line\"></span><br><span class=\"line\">其他命令还有：chgrp, chmod, chown, ln, lumask, rename, rm, rmdir, symlink, version。</span><br><span class=\"line\"></span><br><span class=\"line\">谨记：在sftp模式下对本地文件的操作前面会多一个'l'</span><br></pre></td></tr></table></figure>\n<p>免密码登陆：</p>\n<p>ssh提供了一套密钥对验证机制，把公钥文件上传服务器，并导入公钥库文件。这样客户端在以后不用输入密码可以登陆了。</p>\n<h3 id=\"一、生成密钥文件：\"><a href=\"#一、生成密钥文件：\" class=\"headerlink\" title=\"一、生成密钥文件：\"></a>一、生成密钥文件：</h3><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[luncher@localhost test]$ ssh-keygen -t rsa</span><br><span class=\"line\">Generating public/private rsa key pair.</span><br><span class=\"line\">Enter file in which to save the key (/home/luncher/.ssh/id_rsa): </span><br><span class=\"line\">Enter passphrase (empty for no passphrase): </span><br><span class=\"line\">Enter same passphrase again: </span><br><span class=\"line\">Your identification has been saved in /home/luncher/.ssh/id_rsa.</span><br><span class=\"line\">Your public key has been saved in /home/luncher/.ssh/id_rsa.pub.</span><br><span class=\"line\">The key fingerprint is:</span><br><span class=\"line\">9e:39:ec:d8:fa:46:02:6a:d1:36:b9:83:04:75:95:b9 luncher@localhost.localdomain</span><br><span class=\"line\">The key's randomart image is:</span><br><span class=\"line\">+--[ RSA 2048]----+</span><br><span class=\"line\">| .. ...o         |</span><br><span class=\"line\">|.  .  o          |</span><br><span class=\"line\">| . . . .         |</span><br><span class=\"line\">|  o * E          |</span><br><span class=\"line\">| . = +  S        |</span><br><span class=\"line\">|  + o .o.o       |</span><br><span class=\"line\">| .   . o*        |</span><br><span class=\"line\">|       +..       |</span><br><span class=\"line\">|      o++        |</span><br><span class=\"line\">+-----------------+</span><br></pre></td></tr></table></figure>\n<h3 id=\"二、利用scp命令把公钥拷贝到服务器\"><a href=\"#二、利用scp命令把公钥拷贝到服务器\" class=\"headerlink\" title=\"二、利用scp命令把公钥拷贝到服务器\"></a>二、利用scp命令把公钥拷贝到服务器</h3><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">[luncher@localhost test]$ scp /home/luncher/.ssh/id_rsa.pub luncher@192.168.1.17:/tmp</span><br><span class=\"line\">id_rsa.pub                                    100%  411     0.4KB/s   00:00    </span><br><span class=\"line\">[luncher@localhost test]$</span><br></pre></td></tr></table></figure>\n<h3 id=\"三、在服务器端把公钥导入验证key文件\"><a href=\"#三、在服务器端把公钥导入验证key文件\" class=\"headerlink\" title=\"三、在服务器端把公钥导入验证key文件\"></a>三、在服务器端把公钥导入验证key文件</h3><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat /tmp/id_rsa.pub /home/luncher/.ssh/authorized_keys</span><br></pre></td></tr></table></figure>\n<h3 id=\"四、用ssh-agent和ssh-add管理密钥\"><a href=\"#四、用ssh-agent和ssh-add管理密钥\" class=\"headerlink\" title=\"四、用ssh-agent和ssh-add管理密钥\"></a>四、用ssh-agent和ssh-add管理密钥</h3><p>ssh-agent是用于管理密钥，ssh-add用于将密钥加入到ssh-agent中，SSH可以和ssh-agent通信获取密钥，这样就不需要用户手工输入密码了。</p>\n<p>End~</p>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"1-查看SSH状态：\"><a href=\"#1-查看SSH状态：\" class=\"headerlink\" title=\"1.查看SSH状态：\"></a>1.查看SSH状态：</h3><p>service sshd status</p>\n<p>查看ssh是否已经启动以及一些状态信息</p>\n<h3 id=\"2-启动SSH服务：\"><a href=\"#2-启动SSH服务：\" class=\"headerlink\" title=\"2.启动SSH服务：\"></a>2.启动SSH服务：</h3><p>systemctl restart sshd.service</p>\n<p>ps:fedora下的一些基本服务都是通过systemctl restart/stop xxx.service操作来控制的，例如apache的服务器：httpd.service、防火墙服务firewalld.service等。</p>\n<h3 id=\"3-SSH配置文件路径：\"><a href=\"#3-SSH配置文件路径：\" class=\"headerlink\" title=\"3.SSH配置文件路径：\"></a>3.SSH配置文件路径：</h3><p>/etc/ssh/sshd_config。配置ssh连接的端口号，权限等信息</p>\n<h3 id=\"4-关闭防火墙\"><a href=\"#4-关闭防火墙\" class=\"headerlink\" title=\"4.关闭防火墙\"></a>4.关闭防火墙</h3><p>systemctl disable firewalld.service</p>\n<pre><code>把防火墙整个关闭不太合适，使用下面的命令比较好一些：\n</code></pre><h3 id=\"5-将端口22（或者自定义的其他端口）加到防火墙的设置中，标记为Accept\"><a href=\"#5-将端口22（或者自定义的其他端口）加到防火墙的设置中，标记为Accept\" class=\"headerlink\" title=\"5.将端口22（或者自定义的其他端口）加到防火墙的设置中，标记为Accept\"></a>5.将端口22（或者自定义的其他端口）加到防火墙的设置中，标记为Accept</h3><p>iptables -A INPUT -p tcp –dport 22 -j ACCEPT</p>\n<pre><code>查看ssh的配置文件可以看到默认端口号是22，所以在防火墙解除屏蔽\n</code></pre><h3 id=\"6-防火墙配置文件路径：\"><a href=\"#6-防火墙配置文件路径：\" class=\"headerlink\" title=\"6.防火墙配置文件路径：\"></a>6.防火墙配置文件路径：</h3><p>/etc/sysconfig/iptables</p>\n<pre><code>SSH组件的一些基本操作：\n</code></pre><p>首先登录远程服务器：</p>\n<pre><code>ssh user@192.168.1.28\n\nuser表示远程服务器的用户名，这里需要输入密码。\n</code></pre><p>利用scp进行文件操作：</p>\n<p>文件上传：scp -r /home/xxx <a href=\"mailto:user@192.168.1.28\" target=\"_blank\" rel=\"noopener\">user@192.168.1.28</a>:/home/xxx</p>\n<p>文件下载：和文件上传的路径对调下就OK了。</p>\n<p>利用sftp进行文件上传和下载：</p>\n<p>sftp和ftp工具操作类似，便于目录资源的管理。</p>\n<p>登录：</p>\n<p>格式：sftp -oPort=<port> <user>@<host><br>通过sftp连接<host>，端口为<port>，用户为<user>。</user></port></host></host></user></port></p>\n<p>sftp连接成功之后常用操作命令如下：<br>help/? 打印帮助信息。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwd 查看远程服务器当前目录；</span><br><span class=\"line\"></span><br><span class=\"line\">lpwd 查看本地系统的当前目录。</span><br><span class=\"line\"></span><br><span class=\"line\">cd &lt;dir&gt; 将远程服务器的当前目录更改为&lt;dir&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">lcd &lt;dir&gt; 将本地系统的当前目录更改为&lt;dir&gt;。</span><br><span class=\"line\"></span><br><span class=\"line\">ls 显示远程服务器上当前目录的文件名；</span><br><span class=\"line\"></span><br><span class=\"line\">ls -l 显示远程服务器上当前目录的文件详细列表</span><br><span class=\"line\"></span><br><span class=\"line\">ls &lt;pattern&gt; 显示远程服务器上符合指定模式&lt;pattern&gt;的文件名；</span><br><span class=\"line\"></span><br><span class=\"line\">ls -l &lt;pattern&gt; 显示远程服务器上符合指定模式&lt;pattern&gt;的文件详细列表。</span><br><span class=\"line\"></span><br><span class=\"line\">lls 显示本地系统上当前目录的文件名；</span><br><span class=\"line\"></span><br><span class=\"line\">lls的其他参数与ls命令的类似。</span><br><span class=\"line\"></span><br><span class=\"line\">get &lt;file&gt; 下载指定文件&lt;file&gt;；</span><br><span class=\"line\">get &lt;pattern&gt; 下载符合指定模式&lt;pattern&gt;的文件。</span><br><span class=\"line\">put &lt;file&gt; 上传指定文件&lt;file&gt;；  </span><br><span class=\"line\">get &lt;pattern&gt; 上传符合指定模式&lt;pattern&gt;的文件。  </span><br><span class=\"line\">progress 切换是否显示文件传输进度。</span><br><span class=\"line\">mkdir &lt;dir&gt; 在远程服务器上创建目录；   </span><br><span class=\"line\"></span><br><span class=\"line\">lmkdir &lt;dir&gt; 在本地系统上创建目录。  </span><br><span class=\"line\"></span><br><span class=\"line\">exit/quit/bye 退出sftp。  </span><br><span class=\"line\">! 启动一个本地shell。  </span><br><span class=\"line\">! &lt;commandline&gt; 执行本地命令行。</span><br><span class=\"line\"></span><br><span class=\"line\">其他命令还有：chgrp, chmod, chown, ln, lumask, rename, rm, rmdir, symlink, version。</span><br><span class=\"line\"></span><br><span class=\"line\">谨记：在sftp模式下对本地文件的操作前面会多一个'l'</span><br></pre></td></tr></table></figure>\n<p>免密码登陆：</p>\n<p>ssh提供了一套密钥对验证机制，把公钥文件上传服务器，并导入公钥库文件。这样客户端在以后不用输入密码可以登陆了。</p>\n<h3 id=\"一、生成密钥文件：\"><a href=\"#一、生成密钥文件：\" class=\"headerlink\" title=\"一、生成密钥文件：\"></a>一、生成密钥文件：</h3><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[luncher@localhost test]$ ssh-keygen -t rsa</span><br><span class=\"line\">Generating public/private rsa key pair.</span><br><span class=\"line\">Enter file in which to save the key (/home/luncher/.ssh/id_rsa): </span><br><span class=\"line\">Enter passphrase (empty for no passphrase): </span><br><span class=\"line\">Enter same passphrase again: </span><br><span class=\"line\">Your identification has been saved in /home/luncher/.ssh/id_rsa.</span><br><span class=\"line\">Your public key has been saved in /home/luncher/.ssh/id_rsa.pub.</span><br><span class=\"line\">The key fingerprint is:</span><br><span class=\"line\">9e:39:ec:d8:fa:46:02:6a:d1:36:b9:83:04:75:95:b9 luncher@localhost.localdomain</span><br><span class=\"line\">The key's randomart image is:</span><br><span class=\"line\">+--[ RSA 2048]----+</span><br><span class=\"line\">| .. ...o         |</span><br><span class=\"line\">|.  .  o          |</span><br><span class=\"line\">| . . . .         |</span><br><span class=\"line\">|  o * E          |</span><br><span class=\"line\">| . = +  S        |</span><br><span class=\"line\">|  + o .o.o       |</span><br><span class=\"line\">| .   . o*        |</span><br><span class=\"line\">|       +..       |</span><br><span class=\"line\">|      o++        |</span><br><span class=\"line\">+-----------------+</span><br></pre></td></tr></table></figure>\n<h3 id=\"二、利用scp命令把公钥拷贝到服务器\"><a href=\"#二、利用scp命令把公钥拷贝到服务器\" class=\"headerlink\" title=\"二、利用scp命令把公钥拷贝到服务器\"></a>二、利用scp命令把公钥拷贝到服务器</h3><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">[luncher@localhost test]$ scp /home/luncher/.ssh/id_rsa.pub luncher@192.168.1.17:/tmp</span><br><span class=\"line\">id_rsa.pub                                    100%  411     0.4KB/s   00:00    </span><br><span class=\"line\">[luncher@localhost test]$</span><br></pre></td></tr></table></figure>\n<h3 id=\"三、在服务器端把公钥导入验证key文件\"><a href=\"#三、在服务器端把公钥导入验证key文件\" class=\"headerlink\" title=\"三、在服务器端把公钥导入验证key文件\"></a>三、在服务器端把公钥导入验证key文件</h3><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat /tmp/id_rsa.pub /home/luncher/.ssh/authorized_keys</span><br></pre></td></tr></table></figure>\n<h3 id=\"四、用ssh-agent和ssh-add管理密钥\"><a href=\"#四、用ssh-agent和ssh-add管理密钥\" class=\"headerlink\" title=\"四、用ssh-agent和ssh-add管理密钥\"></a>四、用ssh-agent和ssh-add管理密钥</h3><p>ssh-agent是用于管理密钥，ssh-add用于将密钥加入到ssh-agent中，SSH可以和ssh-agent通信获取密钥，这样就不需要用户手工输入密码了。</p>\n<p>End~</p>\n"},{"title":"SVG学习笔记","date":"2016-12-01T05:38:13.000Z","_content":"\n## SVG是什么\n\n>SVG意为可缩放的矢量图形，采用`XML`语言格式来标记图像信息。最新版本为`1.1`。\n\n---\n\n## SVG基本作用\n\n> 用于绘制图形以及文字，支持旋转、滤镜、裁剪、渐变等效果。\n\n---\n\n## 基本属性及语法\n\n- `html`文档嵌入`svg`\n  - 对于新的`html5`标准可以直接在`html`文档内嵌入\n  - 使用其他元素嵌入：`<object data=\"image.svg\" type=\"image/svg+xml\" />`\n\n- 语法规范\n  - SVG元素属性区分大小写(和`html`不同)\n  - SVG元素属性值必须用双引号引起来\n\n---\n\n## 基本使用\n\n### 坐标系统\n\n  类似于`canvas`，可以通过`viewBox`定义`用户坐标系统`, 达到缩放的结果。例如：\n\n  ``` html\n  <svg width=\"200\" height=\"200\" viewBox=\"0 0 100 100\">\n  ```\n  这里定义了视口(`viewport`)大小为: `200*200`, `viewBox`属性定义了画布上可以显示区域，这个区域会放大到画布`200*200`上显示。这里可以类比`canvas`里面类似的概念，`canvas`里面通过`style`属性定义的宽高为显示区域，用户坐标系统，直接给`canvas`元素设置的宽高为视口大小。既然有缩放，就得控制缩放比例，以及对齐方式。\n  `preserveAspectRatio`属性用于定义`viewBox`相对于`viewport`对齐方式以及缩放属性：\n  >preserveAspectRatio=\"xMidYMid meet\",意味着把`viewBox`的中心相对于`viewport`中心对齐，同时保持纵横比缩放`viewBox`适应`viewport`。其实这也就是默认值。\n  \n  preserveAspectRatio前半部分参数：\n  - xMin|xMid|xMax\n  - YMin|YMid|YMax\n\n  preserveAspectRatio后半部分对齐方式：\n  - meet:保持`viewBox`的纵横比，让`viewBox`在`viewport`内完全显示。\n  - slice:保持`viewBox`的纵横比，用`viewBox`最大化填充`viewport`。\n  - none: 水平和垂直都拉申填充`viewport`。\n\n  [SVG-Demo](git@github.com:Luncher/svg-demo.git),下载后可以直接编辑并用`SVG`查看器打开查看。\n\n### 绘制图形\n  \n  `SVG`包含[内值基本元素](https://developer.mozilla.org/en-US/docs/Web/SVG/Element),可以直接绘制基本图形例如：`rect`、`circle`等。还可以以类似于`canvas`路径的形式绘制图像：强大的路径支持绘制任意的元素。\n\n### 着色\n\n  着色类似于`canvas`分为填充与描边。通过设置`fill`于`stroke`属性控制颜色，`fill-opacity`和`stroke-opacity`控制透明度,以及一些其他属性控制描边的风格。\n\n---\n\n## 参考\n\n[MDN-SVG](https://developer.mozilla.org/en-US/docs/Web/SVG)\n[MDN-SVG Tutorial](https://developer.mozilla.org/zh-CN/docs/Web/SVG/Tutorial)\n[理解SVG的viewport,viewBox](http://www.zhangxinxu.com/wordpress/2014/08/svg-viewport-viewbox-preserveaspectratio/)","source":"_posts/SVG学习笔记.md","raw":"---\ntitle: SVG学习笔记\ndate: 2016-12-01 13:38:13\ntags: SVG\ncategories: web\n---\n\n## SVG是什么\n\n>SVG意为可缩放的矢量图形，采用`XML`语言格式来标记图像信息。最新版本为`1.1`。\n\n---\n\n## SVG基本作用\n\n> 用于绘制图形以及文字，支持旋转、滤镜、裁剪、渐变等效果。\n\n---\n\n## 基本属性及语法\n\n- `html`文档嵌入`svg`\n  - 对于新的`html5`标准可以直接在`html`文档内嵌入\n  - 使用其他元素嵌入：`<object data=\"image.svg\" type=\"image/svg+xml\" />`\n\n- 语法规范\n  - SVG元素属性区分大小写(和`html`不同)\n  - SVG元素属性值必须用双引号引起来\n\n---\n\n## 基本使用\n\n### 坐标系统\n\n  类似于`canvas`，可以通过`viewBox`定义`用户坐标系统`, 达到缩放的结果。例如：\n\n  ``` html\n  <svg width=\"200\" height=\"200\" viewBox=\"0 0 100 100\">\n  ```\n  这里定义了视口(`viewport`)大小为: `200*200`, `viewBox`属性定义了画布上可以显示区域，这个区域会放大到画布`200*200`上显示。这里可以类比`canvas`里面类似的概念，`canvas`里面通过`style`属性定义的宽高为显示区域，用户坐标系统，直接给`canvas`元素设置的宽高为视口大小。既然有缩放，就得控制缩放比例，以及对齐方式。\n  `preserveAspectRatio`属性用于定义`viewBox`相对于`viewport`对齐方式以及缩放属性：\n  >preserveAspectRatio=\"xMidYMid meet\",意味着把`viewBox`的中心相对于`viewport`中心对齐，同时保持纵横比缩放`viewBox`适应`viewport`。其实这也就是默认值。\n  \n  preserveAspectRatio前半部分参数：\n  - xMin|xMid|xMax\n  - YMin|YMid|YMax\n\n  preserveAspectRatio后半部分对齐方式：\n  - meet:保持`viewBox`的纵横比，让`viewBox`在`viewport`内完全显示。\n  - slice:保持`viewBox`的纵横比，用`viewBox`最大化填充`viewport`。\n  - none: 水平和垂直都拉申填充`viewport`。\n\n  [SVG-Demo](git@github.com:Luncher/svg-demo.git),下载后可以直接编辑并用`SVG`查看器打开查看。\n\n### 绘制图形\n  \n  `SVG`包含[内值基本元素](https://developer.mozilla.org/en-US/docs/Web/SVG/Element),可以直接绘制基本图形例如：`rect`、`circle`等。还可以以类似于`canvas`路径的形式绘制图像：强大的路径支持绘制任意的元素。\n\n### 着色\n\n  着色类似于`canvas`分为填充与描边。通过设置`fill`于`stroke`属性控制颜色，`fill-opacity`和`stroke-opacity`控制透明度,以及一些其他属性控制描边的风格。\n\n---\n\n## 参考\n\n[MDN-SVG](https://developer.mozilla.org/en-US/docs/Web/SVG)\n[MDN-SVG Tutorial](https://developer.mozilla.org/zh-CN/docs/Web/SVG/Tutorial)\n[理解SVG的viewport,viewBox](http://www.zhangxinxu.com/wordpress/2014/08/svg-viewport-viewbox-preserveaspectratio/)","slug":"SVG学习笔记","published":1,"updated":"2018-07-01T10:30:46.492Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cd60016y4zvh74lsk5h","content":"<h2 id=\"SVG是什么\"><a href=\"#SVG是什么\" class=\"headerlink\" title=\"SVG是什么\"></a>SVG是什么</h2><blockquote>\n<p>SVG意为可缩放的矢量图形，采用<code>XML</code>语言格式来标记图像信息。最新版本为<code>1.1</code>。</p>\n</blockquote>\n<hr>\n<h2 id=\"SVG基本作用\"><a href=\"#SVG基本作用\" class=\"headerlink\" title=\"SVG基本作用\"></a>SVG基本作用</h2><blockquote>\n<p>用于绘制图形以及文字，支持旋转、滤镜、裁剪、渐变等效果。</p>\n</blockquote>\n<hr>\n<h2 id=\"基本属性及语法\"><a href=\"#基本属性及语法\" class=\"headerlink\" title=\"基本属性及语法\"></a>基本属性及语法</h2><ul>\n<li><p><code>html</code>文档嵌入<code>svg</code></p>\n<ul>\n<li>对于新的<code>html5</code>标准可以直接在<code>html</code>文档内嵌入</li>\n<li>使用其他元素嵌入：<code>&lt;object data=&quot;image.svg&quot; type=&quot;image/svg+xml&quot; /&gt;</code></li>\n</ul>\n</li>\n<li><p>语法规范</p>\n<ul>\n<li>SVG元素属性区分大小写(和<code>html</code>不同)</li>\n<li>SVG元素属性值必须用双引号引起来</li>\n</ul>\n</li>\n</ul>\n<hr>\n<h2 id=\"基本使用\"><a href=\"#基本使用\" class=\"headerlink\" title=\"基本使用\"></a>基本使用</h2><h3 id=\"坐标系统\"><a href=\"#坐标系统\" class=\"headerlink\" title=\"坐标系统\"></a>坐标系统</h3><p>  类似于<code>canvas</code>，可以通过<code>viewBox</code>定义<code>用户坐标系统</code>, 达到缩放的结果。例如：</p>\n  <figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">svg</span> <span class=\"attr\">width</span>=<span class=\"string\">\"200\"</span> <span class=\"attr\">height</span>=<span class=\"string\">\"200\"</span> <span class=\"attr\">viewBox</span>=<span class=\"string\">\"0 0 100 100\"</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>  这里定义了视口(<code>viewport</code>)大小为: <code>200*200</code>, <code>viewBox</code>属性定义了画布上可以显示区域，这个区域会放大到画布<code>200*200</code>上显示。这里可以类比<code>canvas</code>里面类似的概念，<code>canvas</code>里面通过<code>style</code>属性定义的宽高为显示区域，用户坐标系统，直接给<code>canvas</code>元素设置的宽高为视口大小。既然有缩放，就得控制缩放比例，以及对齐方式。<br>  <code>preserveAspectRatio</code>属性用于定义<code>viewBox</code>相对于<code>viewport</code>对齐方式以及缩放属性：</p>\n<blockquote>\n<p>preserveAspectRatio=”xMidYMid meet”,意味着把<code>viewBox</code>的中心相对于<code>viewport</code>中心对齐，同时保持纵横比缩放<code>viewBox</code>适应<code>viewport</code>。其实这也就是默认值。</p>\n</blockquote>\n<p>  preserveAspectRatio前半部分参数：</p>\n<ul>\n<li>xMin|xMid|xMax</li>\n<li><p>YMin|YMid|YMax</p>\n<p>preserveAspectRatio后半部分对齐方式：</p>\n</li>\n<li>meet:保持<code>viewBox</code>的纵横比，让<code>viewBox</code>在<code>viewport</code>内完全显示。</li>\n<li>slice:保持<code>viewBox</code>的纵横比，用<code>viewBox</code>最大化填充<code>viewport</code>。</li>\n<li><p>none: 水平和垂直都拉申填充<code>viewport</code>。</p>\n<p><a href=\"git@github.com:Luncher/svg-demo.git\">SVG-Demo</a>,下载后可以直接编辑并用<code>SVG</code>查看器打开查看。</p>\n</li>\n</ul>\n<h3 id=\"绘制图形\"><a href=\"#绘制图形\" class=\"headerlink\" title=\"绘制图形\"></a>绘制图形</h3><p>  <code>SVG</code>包含<a href=\"https://developer.mozilla.org/en-US/docs/Web/SVG/Element\" target=\"_blank\" rel=\"noopener\">内值基本元素</a>,可以直接绘制基本图形例如：<code>rect</code>、<code>circle</code>等。还可以以类似于<code>canvas</code>路径的形式绘制图像：强大的路径支持绘制任意的元素。</p>\n<h3 id=\"着色\"><a href=\"#着色\" class=\"headerlink\" title=\"着色\"></a>着色</h3><p>  着色类似于<code>canvas</code>分为填充与描边。通过设置<code>fill</code>于<code>stroke</code>属性控制颜色，<code>fill-opacity</code>和<code>stroke-opacity</code>控制透明度,以及一些其他属性控制描边的风格。</p>\n<hr>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><p><a href=\"https://developer.mozilla.org/en-US/docs/Web/SVG\" target=\"_blank\" rel=\"noopener\">MDN-SVG</a><br><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/SVG/Tutorial\" target=\"_blank\" rel=\"noopener\">MDN-SVG Tutorial</a><br><a href=\"http://www.zhangxinxu.com/wordpress/2014/08/svg-viewport-viewbox-preserveaspectratio/\" target=\"_blank\" rel=\"noopener\">理解SVG的viewport,viewBox</a></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"SVG是什么\"><a href=\"#SVG是什么\" class=\"headerlink\" title=\"SVG是什么\"></a>SVG是什么</h2><blockquote>\n<p>SVG意为可缩放的矢量图形，采用<code>XML</code>语言格式来标记图像信息。最新版本为<code>1.1</code>。</p>\n</blockquote>\n<hr>\n<h2 id=\"SVG基本作用\"><a href=\"#SVG基本作用\" class=\"headerlink\" title=\"SVG基本作用\"></a>SVG基本作用</h2><blockquote>\n<p>用于绘制图形以及文字，支持旋转、滤镜、裁剪、渐变等效果。</p>\n</blockquote>\n<hr>\n<h2 id=\"基本属性及语法\"><a href=\"#基本属性及语法\" class=\"headerlink\" title=\"基本属性及语法\"></a>基本属性及语法</h2><ul>\n<li><p><code>html</code>文档嵌入<code>svg</code></p>\n<ul>\n<li>对于新的<code>html5</code>标准可以直接在<code>html</code>文档内嵌入</li>\n<li>使用其他元素嵌入：<code>&lt;object data=&quot;image.svg&quot; type=&quot;image/svg+xml&quot; /&gt;</code></li>\n</ul>\n</li>\n<li><p>语法规范</p>\n<ul>\n<li>SVG元素属性区分大小写(和<code>html</code>不同)</li>\n<li>SVG元素属性值必须用双引号引起来</li>\n</ul>\n</li>\n</ul>\n<hr>\n<h2 id=\"基本使用\"><a href=\"#基本使用\" class=\"headerlink\" title=\"基本使用\"></a>基本使用</h2><h3 id=\"坐标系统\"><a href=\"#坐标系统\" class=\"headerlink\" title=\"坐标系统\"></a>坐标系统</h3><p>  类似于<code>canvas</code>，可以通过<code>viewBox</code>定义<code>用户坐标系统</code>, 达到缩放的结果。例如：</p>\n  <figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">svg</span> <span class=\"attr\">width</span>=<span class=\"string\">\"200\"</span> <span class=\"attr\">height</span>=<span class=\"string\">\"200\"</span> <span class=\"attr\">viewBox</span>=<span class=\"string\">\"0 0 100 100\"</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>  这里定义了视口(<code>viewport</code>)大小为: <code>200*200</code>, <code>viewBox</code>属性定义了画布上可以显示区域，这个区域会放大到画布<code>200*200</code>上显示。这里可以类比<code>canvas</code>里面类似的概念，<code>canvas</code>里面通过<code>style</code>属性定义的宽高为显示区域，用户坐标系统，直接给<code>canvas</code>元素设置的宽高为视口大小。既然有缩放，就得控制缩放比例，以及对齐方式。<br>  <code>preserveAspectRatio</code>属性用于定义<code>viewBox</code>相对于<code>viewport</code>对齐方式以及缩放属性：</p>\n<blockquote>\n<p>preserveAspectRatio=”xMidYMid meet”,意味着把<code>viewBox</code>的中心相对于<code>viewport</code>中心对齐，同时保持纵横比缩放<code>viewBox</code>适应<code>viewport</code>。其实这也就是默认值。</p>\n</blockquote>\n<p>  preserveAspectRatio前半部分参数：</p>\n<ul>\n<li>xMin|xMid|xMax</li>\n<li><p>YMin|YMid|YMax</p>\n<p>preserveAspectRatio后半部分对齐方式：</p>\n</li>\n<li>meet:保持<code>viewBox</code>的纵横比，让<code>viewBox</code>在<code>viewport</code>内完全显示。</li>\n<li>slice:保持<code>viewBox</code>的纵横比，用<code>viewBox</code>最大化填充<code>viewport</code>。</li>\n<li><p>none: 水平和垂直都拉申填充<code>viewport</code>。</p>\n<p><a href=\"git@github.com:Luncher/svg-demo.git\">SVG-Demo</a>,下载后可以直接编辑并用<code>SVG</code>查看器打开查看。</p>\n</li>\n</ul>\n<h3 id=\"绘制图形\"><a href=\"#绘制图形\" class=\"headerlink\" title=\"绘制图形\"></a>绘制图形</h3><p>  <code>SVG</code>包含<a href=\"https://developer.mozilla.org/en-US/docs/Web/SVG/Element\" target=\"_blank\" rel=\"noopener\">内值基本元素</a>,可以直接绘制基本图形例如：<code>rect</code>、<code>circle</code>等。还可以以类似于<code>canvas</code>路径的形式绘制图像：强大的路径支持绘制任意的元素。</p>\n<h3 id=\"着色\"><a href=\"#着色\" class=\"headerlink\" title=\"着色\"></a>着色</h3><p>  着色类似于<code>canvas</code>分为填充与描边。通过设置<code>fill</code>于<code>stroke</code>属性控制颜色，<code>fill-opacity</code>和<code>stroke-opacity</code>控制透明度,以及一些其他属性控制描边的风格。</p>\n<hr>\n<h2 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h2><p><a href=\"https://developer.mozilla.org/en-US/docs/Web/SVG\" target=\"_blank\" rel=\"noopener\">MDN-SVG</a><br><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/SVG/Tutorial\" target=\"_blank\" rel=\"noopener\">MDN-SVG Tutorial</a><br><a href=\"http://www.zhangxinxu.com/wordpress/2014/08/svg-viewport-viewbox-preserveaspectratio/\" target=\"_blank\" rel=\"noopener\">理解SVG的viewport,viewBox</a></p>\n"},{"title":"Sailsjs参数校验","date":"2017-12-02T13:06:37.000Z","_content":"\n参数校验模块是所有`web server`必不可少的一环，而实现的思路无外乎：\n\n* 针对不同的`action`定义一个`schema`\n* 编写一个中间件根据`schema`校验对应的`action`请求参数是否合法\n\n之前针对`swagger`配合`koa2`编写过一套。因为通过`swagger`编写`API`规范的时候可以很容易的指定数据类型、数据长度、是否必传等信息。现在使用`sailsjs`框架实现思路也是类似，不过这次使用的不是`swagger`：\n\n首先利用`hapijs`团队开源的[joi](https://github.com/hapijs/joi)模块，编写action schema:\n\n```javascript\nconst Joi = require('joi')\n\nmodule.exports = {\n  putLogs: Joi.object().keys({\n    topic: Joi.string().required(),\n    source: Joi.string().optional().allow(''),\n    payload: Joi.array().items(Joi.object().keys({\n      time: Joi.string().required(),\n      level: Joi.string().required(),\n      message: Joi.string().required()\n    }))\n  })\n}\n\n```\n\n这是一个上传日志的action, 有两个参数是必传，一个参数是可选且允许传空。`payload`的三个字段也是必传。\n\n为了对现有的代码保持最小的侵入性，我希望在无需改变现有代码的前提下使用这个参数校验模块。sailsjs的hook机制是一个不错的选择：\n\n```javascript\nconst Joi = require('joi')\nconst schemas = require('../schemas')\n\nmodule.exports = (sails) => ({\n  initialize: callback => {\n    Object.keys(sails.controllers).forEach(key => {\n      wrapAction(sails.controllers[key])\n    })\n    callback()\n  }\n})\n\nfunction wrapAction (controller) {\n  const id = controller.identity\n  Object.keys(controller).forEach(key => {\n    if (schemas[id] && schemas[id][key]) {\n      const action = sails.hooks.controllers.middleware[id][key.toLowerCase()]\n      sails.hooks.controllers.middleware[id][key.toLowerCase()] =\n        validateAction(action, schemas[id][key])\n    }\n  })\n}\n\nfunction validateAction (action, schema) {\n  return (req, res) => {\n    const params = req.allParams()\n    const { error } = Joi.validate(params, schema, { allowUnknown: true })\n    if (error != null) {\n      return res.negotiate(sails.Error(ERROR_CODES.ERR_INVALID_PARAMS, error))\n    }\n    return action(req, res)\n  }\n}\n\n```\n\nsailsjs允许用户自定义hook,并且在启动应用启动之前初始化它。所以我在hook启动初始化的时候对所有的action做一层包装，这样就做到了用户层代码无感知。\n\n在校验错误的时候对客户端抛出一个参数错误字段。这里有一点需要注意的是，看到校验函数：\n\n```javascript\n\nconst { error } = Joi.validate(params, schema, { allowUnknown: true })\n\n```\n\n这里传了一个`allowUnknown`选项，该选项允许客户端传递schema以外的字段，这样也是为了向后兼容，因为一些客户端会默认传递一些额外的字段信息。","source":"_posts/Sailsjs参数校验.md","raw":"---\ntitle: Sailsjs参数校验\ndate: 2017-12-02 21:06:37\ncategories: server\ntags: \n  - sailsjs \n---\n\n参数校验模块是所有`web server`必不可少的一环，而实现的思路无外乎：\n\n* 针对不同的`action`定义一个`schema`\n* 编写一个中间件根据`schema`校验对应的`action`请求参数是否合法\n\n之前针对`swagger`配合`koa2`编写过一套。因为通过`swagger`编写`API`规范的时候可以很容易的指定数据类型、数据长度、是否必传等信息。现在使用`sailsjs`框架实现思路也是类似，不过这次使用的不是`swagger`：\n\n首先利用`hapijs`团队开源的[joi](https://github.com/hapijs/joi)模块，编写action schema:\n\n```javascript\nconst Joi = require('joi')\n\nmodule.exports = {\n  putLogs: Joi.object().keys({\n    topic: Joi.string().required(),\n    source: Joi.string().optional().allow(''),\n    payload: Joi.array().items(Joi.object().keys({\n      time: Joi.string().required(),\n      level: Joi.string().required(),\n      message: Joi.string().required()\n    }))\n  })\n}\n\n```\n\n这是一个上传日志的action, 有两个参数是必传，一个参数是可选且允许传空。`payload`的三个字段也是必传。\n\n为了对现有的代码保持最小的侵入性，我希望在无需改变现有代码的前提下使用这个参数校验模块。sailsjs的hook机制是一个不错的选择：\n\n```javascript\nconst Joi = require('joi')\nconst schemas = require('../schemas')\n\nmodule.exports = (sails) => ({\n  initialize: callback => {\n    Object.keys(sails.controllers).forEach(key => {\n      wrapAction(sails.controllers[key])\n    })\n    callback()\n  }\n})\n\nfunction wrapAction (controller) {\n  const id = controller.identity\n  Object.keys(controller).forEach(key => {\n    if (schemas[id] && schemas[id][key]) {\n      const action = sails.hooks.controllers.middleware[id][key.toLowerCase()]\n      sails.hooks.controllers.middleware[id][key.toLowerCase()] =\n        validateAction(action, schemas[id][key])\n    }\n  })\n}\n\nfunction validateAction (action, schema) {\n  return (req, res) => {\n    const params = req.allParams()\n    const { error } = Joi.validate(params, schema, { allowUnknown: true })\n    if (error != null) {\n      return res.negotiate(sails.Error(ERROR_CODES.ERR_INVALID_PARAMS, error))\n    }\n    return action(req, res)\n  }\n}\n\n```\n\nsailsjs允许用户自定义hook,并且在启动应用启动之前初始化它。所以我在hook启动初始化的时候对所有的action做一层包装，这样就做到了用户层代码无感知。\n\n在校验错误的时候对客户端抛出一个参数错误字段。这里有一点需要注意的是，看到校验函数：\n\n```javascript\n\nconst { error } = Joi.validate(params, schema, { allowUnknown: true })\n\n```\n\n这里传了一个`allowUnknown`选项，该选项允许客户端传递schema以外的字段，这样也是为了向后兼容，因为一些客户端会默认传递一些额外的字段信息。","slug":"Sailsjs参数校验","published":1,"updated":"2018-07-01T10:30:46.493Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cd8001by4zvcy9p47ob","content":"<p>参数校验模块是所有<code>web server</code>必不可少的一环，而实现的思路无外乎：</p>\n<ul>\n<li>针对不同的<code>action</code>定义一个<code>schema</code></li>\n<li>编写一个中间件根据<code>schema</code>校验对应的<code>action</code>请求参数是否合法</li>\n</ul>\n<p>之前针对<code>swagger</code>配合<code>koa2</code>编写过一套。因为通过<code>swagger</code>编写<code>API</code>规范的时候可以很容易的指定数据类型、数据长度、是否必传等信息。现在使用<code>sailsjs</code>框架实现思路也是类似，不过这次使用的不是<code>swagger</code>：</p>\n<p>首先利用<code>hapijs</code>团队开源的<a href=\"https://github.com/hapijs/joi\" target=\"_blank\" rel=\"noopener\">joi</a>模块，编写action schema:</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> Joi = <span class=\"built_in\">require</span>(<span class=\"string\">'joi'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">module</span>.exports = &#123;</span><br><span class=\"line\">  putLogs: Joi.object().keys(&#123;</span><br><span class=\"line\">    topic: Joi.string().required(),</span><br><span class=\"line\">    source: Joi.string().optional().allow(<span class=\"string\">''</span>),</span><br><span class=\"line\">    payload: Joi.array().items(Joi.object().keys(&#123;</span><br><span class=\"line\">      time: Joi.string().required(),</span><br><span class=\"line\">      level: Joi.string().required(),</span><br><span class=\"line\">      message: Joi.string().required()</span><br><span class=\"line\">    &#125;))</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这是一个上传日志的action, 有两个参数是必传，一个参数是可选且允许传空。<code>payload</code>的三个字段也是必传。</p>\n<p>为了对现有的代码保持最小的侵入性，我希望在无需改变现有代码的前提下使用这个参数校验模块。sailsjs的hook机制是一个不错的选择：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> Joi = <span class=\"built_in\">require</span>(<span class=\"string\">'joi'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> schemas = <span class=\"built_in\">require</span>(<span class=\"string\">'../schemas'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">module</span>.exports = <span class=\"function\">(<span class=\"params\">sails</span>) =&gt;</span> (&#123;</span><br><span class=\"line\">  initialize: <span class=\"function\"><span class=\"params\">callback</span> =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">Object</span>.keys(sails.controllers).forEach(<span class=\"function\"><span class=\"params\">key</span> =&gt;</span> &#123;</span><br><span class=\"line\">      wrapAction(sails.controllers[key])</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">    callback()</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">wrapAction</span> (<span class=\"params\">controller</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> id = controller.identity</span><br><span class=\"line\">  <span class=\"built_in\">Object</span>.keys(controller).forEach(<span class=\"function\"><span class=\"params\">key</span> =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (schemas[id] &amp;&amp; schemas[id][key]) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> action = sails.hooks.controllers.middleware[id][key.toLowerCase()]</span><br><span class=\"line\">      sails.hooks.controllers.middleware[id][key.toLowerCase()] =</span><br><span class=\"line\">        validateAction(action, schemas[id][key])</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">validateAction</span> (<span class=\"params\">action, schema</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"function\">(<span class=\"params\">req, res</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> params = req.allParams()</span><br><span class=\"line\">    <span class=\"keyword\">const</span> &#123; error &#125; = Joi.validate(params, schema, &#123; <span class=\"attr\">allowUnknown</span>: <span class=\"literal\">true</span> &#125;)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (error != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> res.negotiate(sails.Error(ERROR_CODES.ERR_INVALID_PARAMS, error))</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> action(req, res)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>sailsjs允许用户自定义hook,并且在启动应用启动之前初始化它。所以我在hook启动初始化的时候对所有的action做一层包装，这样就做到了用户层代码无感知。</p>\n<p>在校验错误的时候对客户端抛出一个参数错误字段。这里有一点需要注意的是，看到校验函数：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> &#123; error &#125; = Joi.validate(params, schema, &#123; <span class=\"attr\">allowUnknown</span>: <span class=\"literal\">true</span> &#125;)</span><br></pre></td></tr></table></figure>\n<p>这里传了一个<code>allowUnknown</code>选项，该选项允许客户端传递schema以外的字段，这样也是为了向后兼容，因为一些客户端会默认传递一些额外的字段信息。</p>\n","site":{"data":{}},"excerpt":"","more":"<p>参数校验模块是所有<code>web server</code>必不可少的一环，而实现的思路无外乎：</p>\n<ul>\n<li>针对不同的<code>action</code>定义一个<code>schema</code></li>\n<li>编写一个中间件根据<code>schema</code>校验对应的<code>action</code>请求参数是否合法</li>\n</ul>\n<p>之前针对<code>swagger</code>配合<code>koa2</code>编写过一套。因为通过<code>swagger</code>编写<code>API</code>规范的时候可以很容易的指定数据类型、数据长度、是否必传等信息。现在使用<code>sailsjs</code>框架实现思路也是类似，不过这次使用的不是<code>swagger</code>：</p>\n<p>首先利用<code>hapijs</code>团队开源的<a href=\"https://github.com/hapijs/joi\" target=\"_blank\" rel=\"noopener\">joi</a>模块，编写action schema:</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> Joi = <span class=\"built_in\">require</span>(<span class=\"string\">'joi'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">module</span>.exports = &#123;</span><br><span class=\"line\">  putLogs: Joi.object().keys(&#123;</span><br><span class=\"line\">    topic: Joi.string().required(),</span><br><span class=\"line\">    source: Joi.string().optional().allow(<span class=\"string\">''</span>),</span><br><span class=\"line\">    payload: Joi.array().items(Joi.object().keys(&#123;</span><br><span class=\"line\">      time: Joi.string().required(),</span><br><span class=\"line\">      level: Joi.string().required(),</span><br><span class=\"line\">      message: Joi.string().required()</span><br><span class=\"line\">    &#125;))</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这是一个上传日志的action, 有两个参数是必传，一个参数是可选且允许传空。<code>payload</code>的三个字段也是必传。</p>\n<p>为了对现有的代码保持最小的侵入性，我希望在无需改变现有代码的前提下使用这个参数校验模块。sailsjs的hook机制是一个不错的选择：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> Joi = <span class=\"built_in\">require</span>(<span class=\"string\">'joi'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> schemas = <span class=\"built_in\">require</span>(<span class=\"string\">'../schemas'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">module</span>.exports = <span class=\"function\">(<span class=\"params\">sails</span>) =&gt;</span> (&#123;</span><br><span class=\"line\">  initialize: <span class=\"function\"><span class=\"params\">callback</span> =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">Object</span>.keys(sails.controllers).forEach(<span class=\"function\"><span class=\"params\">key</span> =&gt;</span> &#123;</span><br><span class=\"line\">      wrapAction(sails.controllers[key])</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">    callback()</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">wrapAction</span> (<span class=\"params\">controller</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> id = controller.identity</span><br><span class=\"line\">  <span class=\"built_in\">Object</span>.keys(controller).forEach(<span class=\"function\"><span class=\"params\">key</span> =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (schemas[id] &amp;&amp; schemas[id][key]) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> action = sails.hooks.controllers.middleware[id][key.toLowerCase()]</span><br><span class=\"line\">      sails.hooks.controllers.middleware[id][key.toLowerCase()] =</span><br><span class=\"line\">        validateAction(action, schemas[id][key])</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">validateAction</span> (<span class=\"params\">action, schema</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"function\">(<span class=\"params\">req, res</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> params = req.allParams()</span><br><span class=\"line\">    <span class=\"keyword\">const</span> &#123; error &#125; = Joi.validate(params, schema, &#123; <span class=\"attr\">allowUnknown</span>: <span class=\"literal\">true</span> &#125;)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (error != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> res.negotiate(sails.Error(ERROR_CODES.ERR_INVALID_PARAMS, error))</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> action(req, res)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>sailsjs允许用户自定义hook,并且在启动应用启动之前初始化它。所以我在hook启动初始化的时候对所有的action做一层包装，这样就做到了用户层代码无感知。</p>\n<p>在校验错误的时候对客户端抛出一个参数错误字段。这里有一点需要注意的是，看到校验函数：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> &#123; error &#125; = Joi.validate(params, schema, &#123; <span class=\"attr\">allowUnknown</span>: <span class=\"literal\">true</span> &#125;)</span><br></pre></td></tr></table></figure>\n<p>这里传了一个<code>allowUnknown</code>选项，该选项允许客户端传递schema以外的字段，这样也是为了向后兼容，因为一些客户端会默认传递一些额外的字段信息。</p>\n"},{"title":"Quill编辑器添加自定义插件","date":"2018-06-02T06:03:30.000Z","_content":"\n在前端领域，富文本编辑器一直是一个比较复杂的模块。技术选型的时候，如果没有擦亮眼睛看清楚，一不小心就掉入的坑中。之前用过[summernote](https://github.com/summernote/summernote)最后因为业务需求逐渐复杂，一些关键特性没法支持，自己拓展起来非常痛苦。这次新项目开发的时候仔细调研了下当下比较好的web富文本编辑器主要有：[Quill](https://github.com/quilljs)，以及国内百度前端团队推出的[ueditor](https://github.com/fex-team/ueditor)。经过一番对比之后，选择了`Quill`作为最终方案。\n\n`Quill`实现了一套类似的DOM Tree。通过[parchment](https://github.com/quilljs/parchment)来实现。一颗`parchment` Tree包含了多个`Blot`，可以类比为DOM节点的概念。`parchment`提供了三种类型的`Blot`: `Inline Blot`、 `Block Blot`、`Embed Blot`。前两种分别对应`html`的行内元素、块元素，第三种类型是一个封装类型，`Quill`内置类型如：`Video`通过继承这个类型来实现。\n\n`Quill`默认没有提供`audio`类型的实现。所以通过扩展`Embed Blot`来实现一个。\n\n**导入模块**\n```javascript\n\nimport { Quill } from 'vue-quill-editor'\n\nconst BlockEmbed = Quill.import('blots/block/embed')\nconst Link = Quill.import('formats/link')\n\n```\n> `Quill`内置的模块只能通过`Quill.import`函数导入。\n\n\n**创建对象**\n```javascript\n\nexport default class Audio extends BlockEmbed {\n  static create (value) {\n    let node = super.create(value)\n    node.setAttribute('controls', 'controls')\n    node.setAttribute('src', this.sanitize(value))\n    return node\n  }\n\n  static sanitize (url) {\n    return Link.sanitize(url)\n  }\n  ...\n```\n> `create`由`Quill`负责调用`value`表示创建的对象的参数。这里`audio`只需要一个音频文件`url`参数。默认给音频文件添加控制按钮，如果有其他属性需要设置的可以在这里添加。\n\n\n**获取节点值**\n\n```javascript\n  static value (domNode) {\n    return domNode.getAttribute('src')\n  }\n```\n\n**节点属性变更**\n\n```javascript\nconst ATTRIBUTES = [\n  'height',\n  'width'\n]\n//...\n  //获取属性列表\n  static formats (domNode) {\n    return ATTRIBUTES.reduce(function (formats, attribute) {\n      if (domNode.hasAttribute(attribute)) {\n        formats[attribute] = domNode.getAttribute(attribute)\n      }\n      return formats\n    }, {})\n  }\n//...\n  //设置属性\n  format (name, value) {\n    if (ATTRIBUTES.indexOf(name) > -1) {\n      if (value) {\n        this.domNode.setAttribute(name, value)\n      } else {\n        this.domNode.removeAttribute(name)\n      }\n    } else {\n      super.format(name, value)\n    }\n  }\n\n```\n\n**标示节点并注册**\n\n```javascript\n\nAudio.blotName = 'audio'\nAudio.tagName = 'audio'\n\nQuill.register(Audio)\n\n```\n>`blotName`必须唯一，`tagName`指定该`Blot`对应的DOM节点类型。如果该节点已经被其他`Blot`使用了，则比较添加一个`className`加以区分。\n\n**自定义Blot使用**\n\n```html\n\n  <span class=\"ql-formats\">\n    <qiniu-uploader @input=\"getQiniuUrl\" iconType=\"audio\"></qiniu-uploader>\n  </span>\n\n  <!-- qiniu-uploader 组件实现-->\n  <template>\n    <!-- ... -->\n      <div>\n        <svg viewbox=\"0 0 18 18\" v-if=\"iconType === 'audio'\">\n        <ellipse class=\"ql-fill\" cx=\"10.5\" cy=\"14\" rx=\"2.5\" ry=\"2\"/>\n        <path class=\"ql-stroke\" d=\"M12,14V3c0,1.5,3,2.021,3,5\"/>\n        <path class=\"ql-fill\" d=\"M7,4A5,5,0,0,0,7,14a3.191,3.191,0,0,1,3-2.957V5.023A4.955,4.955,0,0,0,7,4ZM4.06,8.412a0.5,0.5,0,0,1-.49.4,0.485,0.485,0,0,1-.1-0.01,0.5,0.5,0,0,1-.393-0.588A3.98,3.98,0,0,1,6.216,5.079a0.5,0.5,0,0,1,.2.98A2.985,2.985,0,0,0,4.06,8.412ZM7,10A1,1,0,1,1,8,9,1,1,0,0,1,7,10Z\"/>\n      </svg>\n    </div>\n    <!-- ... -->\n```\n\n>因为使用的是`Vue`框架，在toolbar注入控制按钮，当然也可以通过formats选项，在创建`quill`的时候指定需要在工具栏出现哪些控制按钮。组件内提供一个`iconType`控制上传文件类型。这里使用`svg`方式绘制图标，这个图标可以通过[Quill](https://github.com/quilljs/quill/tree/develop/assets/icons)官方找到。\n\n**注入节点**\n\n```javascript\n\ngetQiniuUrl ({ url, type }) {\n  this.editor.focus()\n  this.editor.insertEmbed(this.editor.getSelection().index, type, url)\n}\n\n```\n>this.editor 表示`quill`实例对象，`type`这里传的是`audio`，和`blotName`一一对应。这段代码的含义表示：在当前编辑器光标位置插入一个音频文件节点。\n\n参考文档:  \nhttps://quilljs.com/guides/cloning-medium-with-parchment/  \nhttps://dev.to/charrondev/getting-to-know-quilljs---part-1-parchment-blots-and-lifecycle--3e76","source":"_posts/Quill编辑器添加自定义插件.md","raw":"---\ntitle: Quill编辑器添加自定义插件\ncategories: web\ndate: 2018-06-02 14:03:30\ntags:\n  - Quill\n  - 富文本编辑器\n---\n\n在前端领域，富文本编辑器一直是一个比较复杂的模块。技术选型的时候，如果没有擦亮眼睛看清楚，一不小心就掉入的坑中。之前用过[summernote](https://github.com/summernote/summernote)最后因为业务需求逐渐复杂，一些关键特性没法支持，自己拓展起来非常痛苦。这次新项目开发的时候仔细调研了下当下比较好的web富文本编辑器主要有：[Quill](https://github.com/quilljs)，以及国内百度前端团队推出的[ueditor](https://github.com/fex-team/ueditor)。经过一番对比之后，选择了`Quill`作为最终方案。\n\n`Quill`实现了一套类似的DOM Tree。通过[parchment](https://github.com/quilljs/parchment)来实现。一颗`parchment` Tree包含了多个`Blot`，可以类比为DOM节点的概念。`parchment`提供了三种类型的`Blot`: `Inline Blot`、 `Block Blot`、`Embed Blot`。前两种分别对应`html`的行内元素、块元素，第三种类型是一个封装类型，`Quill`内置类型如：`Video`通过继承这个类型来实现。\n\n`Quill`默认没有提供`audio`类型的实现。所以通过扩展`Embed Blot`来实现一个。\n\n**导入模块**\n```javascript\n\nimport { Quill } from 'vue-quill-editor'\n\nconst BlockEmbed = Quill.import('blots/block/embed')\nconst Link = Quill.import('formats/link')\n\n```\n> `Quill`内置的模块只能通过`Quill.import`函数导入。\n\n\n**创建对象**\n```javascript\n\nexport default class Audio extends BlockEmbed {\n  static create (value) {\n    let node = super.create(value)\n    node.setAttribute('controls', 'controls')\n    node.setAttribute('src', this.sanitize(value))\n    return node\n  }\n\n  static sanitize (url) {\n    return Link.sanitize(url)\n  }\n  ...\n```\n> `create`由`Quill`负责调用`value`表示创建的对象的参数。这里`audio`只需要一个音频文件`url`参数。默认给音频文件添加控制按钮，如果有其他属性需要设置的可以在这里添加。\n\n\n**获取节点值**\n\n```javascript\n  static value (domNode) {\n    return domNode.getAttribute('src')\n  }\n```\n\n**节点属性变更**\n\n```javascript\nconst ATTRIBUTES = [\n  'height',\n  'width'\n]\n//...\n  //获取属性列表\n  static formats (domNode) {\n    return ATTRIBUTES.reduce(function (formats, attribute) {\n      if (domNode.hasAttribute(attribute)) {\n        formats[attribute] = domNode.getAttribute(attribute)\n      }\n      return formats\n    }, {})\n  }\n//...\n  //设置属性\n  format (name, value) {\n    if (ATTRIBUTES.indexOf(name) > -1) {\n      if (value) {\n        this.domNode.setAttribute(name, value)\n      } else {\n        this.domNode.removeAttribute(name)\n      }\n    } else {\n      super.format(name, value)\n    }\n  }\n\n```\n\n**标示节点并注册**\n\n```javascript\n\nAudio.blotName = 'audio'\nAudio.tagName = 'audio'\n\nQuill.register(Audio)\n\n```\n>`blotName`必须唯一，`tagName`指定该`Blot`对应的DOM节点类型。如果该节点已经被其他`Blot`使用了，则比较添加一个`className`加以区分。\n\n**自定义Blot使用**\n\n```html\n\n  <span class=\"ql-formats\">\n    <qiniu-uploader @input=\"getQiniuUrl\" iconType=\"audio\"></qiniu-uploader>\n  </span>\n\n  <!-- qiniu-uploader 组件实现-->\n  <template>\n    <!-- ... -->\n      <div>\n        <svg viewbox=\"0 0 18 18\" v-if=\"iconType === 'audio'\">\n        <ellipse class=\"ql-fill\" cx=\"10.5\" cy=\"14\" rx=\"2.5\" ry=\"2\"/>\n        <path class=\"ql-stroke\" d=\"M12,14V3c0,1.5,3,2.021,3,5\"/>\n        <path class=\"ql-fill\" d=\"M7,4A5,5,0,0,0,7,14a3.191,3.191,0,0,1,3-2.957V5.023A4.955,4.955,0,0,0,7,4ZM4.06,8.412a0.5,0.5,0,0,1-.49.4,0.485,0.485,0,0,1-.1-0.01,0.5,0.5,0,0,1-.393-0.588A3.98,3.98,0,0,1,6.216,5.079a0.5,0.5,0,0,1,.2.98A2.985,2.985,0,0,0,4.06,8.412ZM7,10A1,1,0,1,1,8,9,1,1,0,0,1,7,10Z\"/>\n      </svg>\n    </div>\n    <!-- ... -->\n```\n\n>因为使用的是`Vue`框架，在toolbar注入控制按钮，当然也可以通过formats选项，在创建`quill`的时候指定需要在工具栏出现哪些控制按钮。组件内提供一个`iconType`控制上传文件类型。这里使用`svg`方式绘制图标，这个图标可以通过[Quill](https://github.com/quilljs/quill/tree/develop/assets/icons)官方找到。\n\n**注入节点**\n\n```javascript\n\ngetQiniuUrl ({ url, type }) {\n  this.editor.focus()\n  this.editor.insertEmbed(this.editor.getSelection().index, type, url)\n}\n\n```\n>this.editor 表示`quill`实例对象，`type`这里传的是`audio`，和`blotName`一一对应。这段代码的含义表示：在当前编辑器光标位置插入一个音频文件节点。\n\n参考文档:  \nhttps://quilljs.com/guides/cloning-medium-with-parchment/  \nhttps://dev.to/charrondev/getting-to-know-quilljs---part-1-parchment-blots-and-lifecycle--3e76","slug":"Quill编辑器添加自定义插件","published":1,"updated":"2018-07-01T10:30:46.492Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cd9001dy4zvf76bymvt","content":"<p>在前端领域，富文本编辑器一直是一个比较复杂的模块。技术选型的时候，如果没有擦亮眼睛看清楚，一不小心就掉入的坑中。之前用过<a href=\"https://github.com/summernote/summernote\" target=\"_blank\" rel=\"noopener\">summernote</a>最后因为业务需求逐渐复杂，一些关键特性没法支持，自己拓展起来非常痛苦。这次新项目开发的时候仔细调研了下当下比较好的web富文本编辑器主要有：<a href=\"https://github.com/quilljs\" target=\"_blank\" rel=\"noopener\">Quill</a>，以及国内百度前端团队推出的<a href=\"https://github.com/fex-team/ueditor\" target=\"_blank\" rel=\"noopener\">ueditor</a>。经过一番对比之后，选择了<code>Quill</code>作为最终方案。</p>\n<p><code>Quill</code>实现了一套类似的DOM Tree。通过<a href=\"https://github.com/quilljs/parchment\" target=\"_blank\" rel=\"noopener\">parchment</a>来实现。一颗<code>parchment</code> Tree包含了多个<code>Blot</code>，可以类比为DOM节点的概念。<code>parchment</code>提供了三种类型的<code>Blot</code>: <code>Inline Blot</code>、 <code>Block Blot</code>、<code>Embed Blot</code>。前两种分别对应<code>html</code>的行内元素、块元素，第三种类型是一个封装类型，<code>Quill</code>内置类型如：<code>Video</code>通过继承这个类型来实现。</p>\n<p><code>Quill</code>默认没有提供<code>audio</code>类型的实现。所以通过扩展<code>Embed Blot</code>来实现一个。</p>\n<p><strong>导入模块</strong><br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> &#123; Quill &#125; <span class=\"keyword\">from</span> <span class=\"string\">'vue-quill-editor'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> BlockEmbed = Quill.import(<span class=\"string\">'blots/block/embed'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> Link = Quill.import(<span class=\"string\">'formats/link'</span>)</span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p><code>Quill</code>内置的模块只能通过<code>Quill.import</code>函数导入。</p>\n</blockquote>\n<p><strong>创建对象</strong><br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">default</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Audio</span> <span class=\"keyword\">extends</span> <span class=\"title\">BlockEmbed</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">static</span> create (value) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> node = <span class=\"keyword\">super</span>.create(value)</span><br><span class=\"line\">    node.setAttribute(<span class=\"string\">'controls'</span>, <span class=\"string\">'controls'</span>)</span><br><span class=\"line\">    node.setAttribute(<span class=\"string\">'src'</span>, <span class=\"keyword\">this</span>.sanitize(value))</span><br><span class=\"line\">    <span class=\"keyword\">return</span> node</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">static</span> sanitize (url) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> Link.sanitize(url)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  ...</span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p><code>create</code>由<code>Quill</code>负责调用<code>value</code>表示创建的对象的参数。这里<code>audio</code>只需要一个音频文件<code>url</code>参数。默认给音频文件添加控制按钮，如果有其他属性需要设置的可以在这里添加。</p>\n</blockquote>\n<p><strong>获取节点值</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> value (domNode) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> domNode.getAttribute(<span class=\"string\">'src'</span>)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>节点属性变更</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> ATTRIBUTES = [</span><br><span class=\"line\">  <span class=\"string\">'height'</span>,</span><br><span class=\"line\">  <span class=\"string\">'width'</span></span><br><span class=\"line\">]</span><br><span class=\"line\"><span class=\"comment\">//...</span></span><br><span class=\"line\">  <span class=\"comment\">//获取属性列表</span></span><br><span class=\"line\">  <span class=\"keyword\">static</span> formats (domNode) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> ATTRIBUTES.reduce(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">formats, attribute</span>) </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (domNode.hasAttribute(attribute)) &#123;</span><br><span class=\"line\">        formats[attribute] = domNode.getAttribute(attribute)</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> formats</span><br><span class=\"line\">    &#125;, &#123;&#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"><span class=\"comment\">//...</span></span><br><span class=\"line\">  <span class=\"comment\">//设置属性</span></span><br><span class=\"line\">  format (name, value) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (ATTRIBUTES.indexOf(name) &gt; <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (value) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.domNode.setAttribute(name, value)</span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.domNode.removeAttribute(name)</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">super</span>.format(name, value)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n<p><strong>标示节点并注册</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">Audio.blotName = <span class=\"string\">'audio'</span></span><br><span class=\"line\">Audio.tagName = <span class=\"string\">'audio'</span></span><br><span class=\"line\"></span><br><span class=\"line\">Quill.register(Audio)</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>blotName</code>必须唯一，<code>tagName</code>指定该<code>Blot</code>对应的DOM节点类型。如果该节点已经被其他<code>Blot</code>使用了，则比较添加一个<code>className</code>加以区分。</p>\n</blockquote>\n<p><strong>自定义Blot使用</strong></p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">class</span>=<span class=\"string\">\"ql-formats\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">qiniu-uploader</span> @<span class=\"attr\">input</span>=<span class=\"string\">\"getQiniuUrl\"</span> <span class=\"attr\">iconType</span>=<span class=\"string\">\"audio\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">qiniu-uploader</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- qiniu-uploader 组件实现--&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- ... --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">svg</span> <span class=\"attr\">viewbox</span>=<span class=\"string\">\"0 0 18 18\"</span> <span class=\"attr\">v-if</span>=<span class=\"string\">\"iconType === 'audio'\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">ellipse</span> <span class=\"attr\">class</span>=<span class=\"string\">\"ql-fill\"</span> <span class=\"attr\">cx</span>=<span class=\"string\">\"10.5\"</span> <span class=\"attr\">cy</span>=<span class=\"string\">\"14\"</span> <span class=\"attr\">rx</span>=<span class=\"string\">\"2.5\"</span> <span class=\"attr\">ry</span>=<span class=\"string\">\"2\"</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">path</span> <span class=\"attr\">class</span>=<span class=\"string\">\"ql-stroke\"</span> <span class=\"attr\">d</span>=<span class=\"string\">\"M12,14V3c0,1.5,3,2.021,3,5\"</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">path</span> <span class=\"attr\">class</span>=<span class=\"string\">\"ql-fill\"</span> <span class=\"attr\">d</span>=<span class=\"string\">\"M7,4A5,5,0,0,0,7,14a3.191,3.191,0,0,1,3-2.957V5.023A4.955,4.955,0,0,0,7,4ZM4.06,8.412a0.5,0.5,0,0,1-.49.4,0.485,0.485,0,0,1-.1-0.01,0.5,0.5,0,0,1-.393-0.588A3.98,3.98,0,0,1,6.216,5.079a0.5,0.5,0,0,1,.2.98A2.985,2.985,0,0,0,4.06,8.412ZM7,10A1,1,0,1,1,8,9,1,1,0,0,1,7,10Z\"</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">svg</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- ... --&gt;</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>因为使用的是<code>Vue</code>框架，在toolbar注入控制按钮，当然也可以通过formats选项，在创建<code>quill</code>的时候指定需要在工具栏出现哪些控制按钮。组件内提供一个<code>iconType</code>控制上传文件类型。这里使用<code>svg</code>方式绘制图标，这个图标可以通过<a href=\"https://github.com/quilljs/quill/tree/develop/assets/icons\" target=\"_blank\" rel=\"noopener\">Quill</a>官方找到。</p>\n</blockquote>\n<p><strong>注入节点</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">getQiniuUrl (&#123; url, type &#125;) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.editor.focus()</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.editor.insertEmbed(<span class=\"keyword\">this</span>.editor.getSelection().index, type, url)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>this.editor 表示<code>quill</code>实例对象，<code>type</code>这里传的是<code>audio</code>，和<code>blotName</code>一一对应。这段代码的含义表示：在当前编辑器光标位置插入一个音频文件节点。</p>\n</blockquote>\n<p>参考文档:<br><a href=\"https://quilljs.com/guides/cloning-medium-with-parchment/\" target=\"_blank\" rel=\"noopener\">https://quilljs.com/guides/cloning-medium-with-parchment/</a><br><a href=\"https://dev.to/charrondev/getting-to-know-quilljs---part-1-parchment-blots-and-lifecycle--3e76\" target=\"_blank\" rel=\"noopener\">https://dev.to/charrondev/getting-to-know-quilljs---part-1-parchment-blots-and-lifecycle--3e76</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p>在前端领域，富文本编辑器一直是一个比较复杂的模块。技术选型的时候，如果没有擦亮眼睛看清楚，一不小心就掉入的坑中。之前用过<a href=\"https://github.com/summernote/summernote\" target=\"_blank\" rel=\"noopener\">summernote</a>最后因为业务需求逐渐复杂，一些关键特性没法支持，自己拓展起来非常痛苦。这次新项目开发的时候仔细调研了下当下比较好的web富文本编辑器主要有：<a href=\"https://github.com/quilljs\" target=\"_blank\" rel=\"noopener\">Quill</a>，以及国内百度前端团队推出的<a href=\"https://github.com/fex-team/ueditor\" target=\"_blank\" rel=\"noopener\">ueditor</a>。经过一番对比之后，选择了<code>Quill</code>作为最终方案。</p>\n<p><code>Quill</code>实现了一套类似的DOM Tree。通过<a href=\"https://github.com/quilljs/parchment\" target=\"_blank\" rel=\"noopener\">parchment</a>来实现。一颗<code>parchment</code> Tree包含了多个<code>Blot</code>，可以类比为DOM节点的概念。<code>parchment</code>提供了三种类型的<code>Blot</code>: <code>Inline Blot</code>、 <code>Block Blot</code>、<code>Embed Blot</code>。前两种分别对应<code>html</code>的行内元素、块元素，第三种类型是一个封装类型，<code>Quill</code>内置类型如：<code>Video</code>通过继承这个类型来实现。</p>\n<p><code>Quill</code>默认没有提供<code>audio</code>类型的实现。所以通过扩展<code>Embed Blot</code>来实现一个。</p>\n<p><strong>导入模块</strong><br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> &#123; Quill &#125; <span class=\"keyword\">from</span> <span class=\"string\">'vue-quill-editor'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> BlockEmbed = Quill.import(<span class=\"string\">'blots/block/embed'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> Link = Quill.import(<span class=\"string\">'formats/link'</span>)</span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p><code>Quill</code>内置的模块只能通过<code>Quill.import</code>函数导入。</p>\n</blockquote>\n<p><strong>创建对象</strong><br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">default</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Audio</span> <span class=\"keyword\">extends</span> <span class=\"title\">BlockEmbed</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">static</span> create (value) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> node = <span class=\"keyword\">super</span>.create(value)</span><br><span class=\"line\">    node.setAttribute(<span class=\"string\">'controls'</span>, <span class=\"string\">'controls'</span>)</span><br><span class=\"line\">    node.setAttribute(<span class=\"string\">'src'</span>, <span class=\"keyword\">this</span>.sanitize(value))</span><br><span class=\"line\">    <span class=\"keyword\">return</span> node</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">static</span> sanitize (url) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> Link.sanitize(url)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  ...</span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p><code>create</code>由<code>Quill</code>负责调用<code>value</code>表示创建的对象的参数。这里<code>audio</code>只需要一个音频文件<code>url</code>参数。默认给音频文件添加控制按钮，如果有其他属性需要设置的可以在这里添加。</p>\n</blockquote>\n<p><strong>获取节点值</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> value (domNode) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> domNode.getAttribute(<span class=\"string\">'src'</span>)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>节点属性变更</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> ATTRIBUTES = [</span><br><span class=\"line\">  <span class=\"string\">'height'</span>,</span><br><span class=\"line\">  <span class=\"string\">'width'</span></span><br><span class=\"line\">]</span><br><span class=\"line\"><span class=\"comment\">//...</span></span><br><span class=\"line\">  <span class=\"comment\">//获取属性列表</span></span><br><span class=\"line\">  <span class=\"keyword\">static</span> formats (domNode) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> ATTRIBUTES.reduce(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">formats, attribute</span>) </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (domNode.hasAttribute(attribute)) &#123;</span><br><span class=\"line\">        formats[attribute] = domNode.getAttribute(attribute)</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> formats</span><br><span class=\"line\">    &#125;, &#123;&#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"><span class=\"comment\">//...</span></span><br><span class=\"line\">  <span class=\"comment\">//设置属性</span></span><br><span class=\"line\">  format (name, value) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (ATTRIBUTES.indexOf(name) &gt; <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (value) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.domNode.setAttribute(name, value)</span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.domNode.removeAttribute(name)</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">super</span>.format(name, value)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n<p><strong>标示节点并注册</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">Audio.blotName = <span class=\"string\">'audio'</span></span><br><span class=\"line\">Audio.tagName = <span class=\"string\">'audio'</span></span><br><span class=\"line\"></span><br><span class=\"line\">Quill.register(Audio)</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>blotName</code>必须唯一，<code>tagName</code>指定该<code>Blot</code>对应的DOM节点类型。如果该节点已经被其他<code>Blot</code>使用了，则比较添加一个<code>className</code>加以区分。</p>\n</blockquote>\n<p><strong>自定义Blot使用</strong></p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">class</span>=<span class=\"string\">\"ql-formats\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">qiniu-uploader</span> @<span class=\"attr\">input</span>=<span class=\"string\">\"getQiniuUrl\"</span> <span class=\"attr\">iconType</span>=<span class=\"string\">\"audio\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">qiniu-uploader</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- qiniu-uploader 组件实现--&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- ... --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">svg</span> <span class=\"attr\">viewbox</span>=<span class=\"string\">\"0 0 18 18\"</span> <span class=\"attr\">v-if</span>=<span class=\"string\">\"iconType === 'audio'\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">ellipse</span> <span class=\"attr\">class</span>=<span class=\"string\">\"ql-fill\"</span> <span class=\"attr\">cx</span>=<span class=\"string\">\"10.5\"</span> <span class=\"attr\">cy</span>=<span class=\"string\">\"14\"</span> <span class=\"attr\">rx</span>=<span class=\"string\">\"2.5\"</span> <span class=\"attr\">ry</span>=<span class=\"string\">\"2\"</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">path</span> <span class=\"attr\">class</span>=<span class=\"string\">\"ql-stroke\"</span> <span class=\"attr\">d</span>=<span class=\"string\">\"M12,14V3c0,1.5,3,2.021,3,5\"</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">path</span> <span class=\"attr\">class</span>=<span class=\"string\">\"ql-fill\"</span> <span class=\"attr\">d</span>=<span class=\"string\">\"M7,4A5,5,0,0,0,7,14a3.191,3.191,0,0,1,3-2.957V5.023A4.955,4.955,0,0,0,7,4ZM4.06,8.412a0.5,0.5,0,0,1-.49.4,0.485,0.485,0,0,1-.1-0.01,0.5,0.5,0,0,1-.393-0.588A3.98,3.98,0,0,1,6.216,5.079a0.5,0.5,0,0,1,.2.98A2.985,2.985,0,0,0,4.06,8.412ZM7,10A1,1,0,1,1,8,9,1,1,0,0,1,7,10Z\"</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">svg</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- ... --&gt;</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>因为使用的是<code>Vue</code>框架，在toolbar注入控制按钮，当然也可以通过formats选项，在创建<code>quill</code>的时候指定需要在工具栏出现哪些控制按钮。组件内提供一个<code>iconType</code>控制上传文件类型。这里使用<code>svg</code>方式绘制图标，这个图标可以通过<a href=\"https://github.com/quilljs/quill/tree/develop/assets/icons\" target=\"_blank\" rel=\"noopener\">Quill</a>官方找到。</p>\n</blockquote>\n<p><strong>注入节点</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">getQiniuUrl (&#123; url, type &#125;) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.editor.focus()</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.editor.insertEmbed(<span class=\"keyword\">this</span>.editor.getSelection().index, type, url)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>this.editor 表示<code>quill</code>实例对象，<code>type</code>这里传的是<code>audio</code>，和<code>blotName</code>一一对应。这段代码的含义表示：在当前编辑器光标位置插入一个音频文件节点。</p>\n</blockquote>\n<p>参考文档:<br><a href=\"https://quilljs.com/guides/cloning-medium-with-parchment/\" target=\"_blank\" rel=\"noopener\">https://quilljs.com/guides/cloning-medium-with-parchment/</a><br><a href=\"https://dev.to/charrondev/getting-to-know-quilljs---part-1-parchment-blots-and-lifecycle--3e76\" target=\"_blank\" rel=\"noopener\">https://dev.to/charrondev/getting-to-know-quilljs---part-1-parchment-blots-and-lifecycle--3e76</a></p>\n"},{"title":"Sailsjs项目模板","date":"2017-12-10T12:30:39.000Z","_content":"\n在微服务体系下, 随着新需求的不断迭代，需要不停分解(新建)一些服务，这个时候会有很多重复的工作。譬如说搭建项目基础框架，设置开发、生产环境的配置。经过一段时间对sailsjs的折腾之后，下定决心总结一个属于自己的项目模板，方便下次直接使用。\n\n项目模板主要包含以下几个模块：\n\n### 基础结构\n\n\n#### 1. 创建项目\n\n因为是一个\b纯后端项目，所以创建项目的时候指定基本选项：\n\n> sails new project-name --no-linker --no-frontend\n\n\n#### 2. 配置`response`\n\n设置`response`:\n\n`api/responses`目录下有多个`response`文件，配置好相应的返回选项，譬如`serverError.js`:\n\n```javascript\n\nmodule.exports = function serverError (data, options) {\n  const res = this.res\n  const req = this.req\n\n  sails.log.error(`${req.method} ${req.url} Result: ${util.inspect(data)}`);\n\n  if (data instanceof VError) {\n    const info = VError.info(data)\n    const cause = VError.cause(data)\n    const message = info.message + ':' + (cause ? cause.message : \"\" )\n    res.status(info.status)\n    res.json({ code: info.code, message, data: info.data || {} })\n  } else if (data instanceof Error) {\n    res.status(500)\n    res.json({ code: -1, message: data.message, data: {} })\n  } else {\n    res.status(data.status || 500)\n    res.json({ code: -1, message: data.message, data: {} })\n  }\n\n  return\n}\n\n```\n\n#### 3. 设置`rest`风格的接口\n\n`config/blueprint.js`用于配置服务器支持的接口类型,关闭一些默认配置，只打开一些必要选项:\n\n```javascript\n  {\n    actions: false,\n    rest: true,\n    shortcuts: false,\n    restPrefix: '/api',\n    pluralize: true,\n  }\n\n```\n\n### 设置必要的`hooks`\n\n#### 1. 捕获错误`hook`\n\n*api/hooks/asyncWrapper.js*\n\n```javascript\n\nconst _ = require('lodash')\n\nmodule.exports = (sails) => {\n  return {\n    initialize: (callback) => {\n      _.each(sails.controllers, (controller, controllerId) => {\n        _.each(controller, (_, actionId) => {\n          actionId = actionId.toLowerCase()\n          const action = sails.hooks.controllers.middleware[controllerId][actionId]\n          sails.hooks.controllers.middleware[controllerId][actionId] = handleAction(action)\n        })\n      })\n\n      callback()\n    }\n  }\n\n  function handleAction (action) {\n    return (req, res) => {\n      try {\n        Promise.resolve(action(req, res))\n          .then(result => {\n            return handleResult(result, req, res)\n          })\n          .catch(err => {\n            return handleError(err, req, res)\n          })\n      } catch (err) {\n        return handleError(err, req, res)\n      }\n    }\n  }\n\n  function handleResult (result, req, res) {\n    if (res.headersSent || res.isHandled) return\n    return res.ok(result)\n  }\n\n  function handleError (error, req, res) {\n    if (res.headersSent || res.isHandled) return\n    return res.negotiate(error)\n  }\n}\n\n```\n\n#### 2. 参数校验`hook`\n\n*api/hooks/validator.js*\n```javascript\n\nconst Joi = require('joi')\nconst schemas = require('../schemas')\n\nmodule.exports = (sails) => ({\n  initialize: callback => {\n    Object.keys(sails.controllers).forEach(key => {\n      wrapAction(sails.controllers[key])\n    })\n    callback()\n  }\n})\n\nfunction wrapAction (controller) {\n  const id = controller.identity\n  Object.keys(controller).forEach(key => {\n    if (schemas && schemas[id] && schemas[id][key]) {\n      const action = sails.hooks.controllers.middleware[id][key.toLowerCase()]\n      sails.hooks.controllers.middleware[id][key.toLowerCase()] =\n        validateAction(action, schemas[id][key])\n    }\n  })\n}\n\nfunction validateAction (action, schema) {\n  return (req, res) => {\n    const params = req.allParams()\n    const { error } = Joi.validate(params, schema, { allowUnknown: true })\n    if (error != null) {\n      return res.negotiate(sails.Error(ERROR_CODES.ERR_INVALID_PARAMS, error))\n    }\n    return action(req, res)\n  }\n}\n\n```\n\n### 错误处理\n\n#### 1. 设置错误码\n\n再项目启动的时候设置错误代码：\n\n```javascript\n\nmodule.exports.bootstrap = function(cb) {\n  global.VError = require('verror')\n  global.ERROR_CODES = sails.config.app.ERROR_CODES\n  global.ERROR_PAYLOADS = sails.config.app.ERROR_PAYLOADS\n  sails.Error = UtilService.createError\n  cb()\n}\n\n```\n\n#### 2. 创建自定义错误\n\nUtilService.createError提供一个\b函数创建自定义错误:\n\n```javascript\n\n  createError: function (code, cause) {\n    const payload = ERROR_PAYLOADS[code]\n    const name = payload.name\n    const info = payload\n    info.code = code\n    return new VError({ name, info, cause })\n  }\n\n```\n\n#### 3. 错误冒泡\n\n项目启动的时候引入了`VError`, 项目代码在抛出错误的时候传递上一次错误的原因，在`response`函数内返回内嵌错误：\n\n```javascript\n\nif (data instanceof VError) {\n  const info = VError.info(data)\n  const cause = VError.cause(data)\n  const message = info.message + ':' + (cause ? cause.message : \"\" )\n  res.status(info.status)\n  res.json({ code: info.code, message, data: info.data || {} })\n}\n\n```\n\n### 测试\n\n目录结构：\n\n*sails-boilerplate/test*\n\n```shell\n\n├── bootstrap.test.js\n├── fixtures\n│   └── article.js\n├── integration\n│   ├── controllers\n│   └── services\n└── mocha.opts\n\n```\n\n`mocha.opts`放置mocha测试框架基本配置：\n\n```javascript\n\n--timeout 10s\n--exit\n--bail\n\n```\n\n`bootstrap.test.js`是sails启动测试的入口：\n\n```javascript\n\nbefore(function(done) {\n  sails.lift({\n    // configuration for testing purposes\n  }, function(err) {\n    if (err) return done(err);\n    // here you can load fixtures, etc.\n    setupFixtures(function (err) {\n      done(err, sails);      \n    })\n  });\n\n  after(function(done) {\n    // here you can clear fixtures, etc.\n    teardownFixtures(function (err) {\n      sails.lower(done);      \n    })\n  });\n})\n\n```\n\n> `setupFixtures`设置一些项目测试过程会使用的数据，`teardownFixtures`清除这些设置的数据。\n\n`integration`文件夹方式一些测试用例。`fixtures`文件夹方式设置一些创建各种测试数据的代码文件。\n\n项目\b地址：[sails-boilerplate](https://github.com/Luncher/sails-boilerplate)。","source":"_posts/Sailsjs项目模板.md","raw":"---\ntitle: Sailsjs项目模板\ndate: 2017-12-10 20:30:39\ncategories: server\ntags: \n  - sailsjs \n---\n\n在微服务体系下, 随着新需求的不断迭代，需要不停分解(新建)一些服务，这个时候会有很多重复的工作。譬如说搭建项目基础框架，设置开发、生产环境的配置。经过一段时间对sailsjs的折腾之后，下定决心总结一个属于自己的项目模板，方便下次直接使用。\n\n项目模板主要包含以下几个模块：\n\n### 基础结构\n\n\n#### 1. 创建项目\n\n因为是一个\b纯后端项目，所以创建项目的时候指定基本选项：\n\n> sails new project-name --no-linker --no-frontend\n\n\n#### 2. 配置`response`\n\n设置`response`:\n\n`api/responses`目录下有多个`response`文件，配置好相应的返回选项，譬如`serverError.js`:\n\n```javascript\n\nmodule.exports = function serverError (data, options) {\n  const res = this.res\n  const req = this.req\n\n  sails.log.error(`${req.method} ${req.url} Result: ${util.inspect(data)}`);\n\n  if (data instanceof VError) {\n    const info = VError.info(data)\n    const cause = VError.cause(data)\n    const message = info.message + ':' + (cause ? cause.message : \"\" )\n    res.status(info.status)\n    res.json({ code: info.code, message, data: info.data || {} })\n  } else if (data instanceof Error) {\n    res.status(500)\n    res.json({ code: -1, message: data.message, data: {} })\n  } else {\n    res.status(data.status || 500)\n    res.json({ code: -1, message: data.message, data: {} })\n  }\n\n  return\n}\n\n```\n\n#### 3. 设置`rest`风格的接口\n\n`config/blueprint.js`用于配置服务器支持的接口类型,关闭一些默认配置，只打开一些必要选项:\n\n```javascript\n  {\n    actions: false,\n    rest: true,\n    shortcuts: false,\n    restPrefix: '/api',\n    pluralize: true,\n  }\n\n```\n\n### 设置必要的`hooks`\n\n#### 1. 捕获错误`hook`\n\n*api/hooks/asyncWrapper.js*\n\n```javascript\n\nconst _ = require('lodash')\n\nmodule.exports = (sails) => {\n  return {\n    initialize: (callback) => {\n      _.each(sails.controllers, (controller, controllerId) => {\n        _.each(controller, (_, actionId) => {\n          actionId = actionId.toLowerCase()\n          const action = sails.hooks.controllers.middleware[controllerId][actionId]\n          sails.hooks.controllers.middleware[controllerId][actionId] = handleAction(action)\n        })\n      })\n\n      callback()\n    }\n  }\n\n  function handleAction (action) {\n    return (req, res) => {\n      try {\n        Promise.resolve(action(req, res))\n          .then(result => {\n            return handleResult(result, req, res)\n          })\n          .catch(err => {\n            return handleError(err, req, res)\n          })\n      } catch (err) {\n        return handleError(err, req, res)\n      }\n    }\n  }\n\n  function handleResult (result, req, res) {\n    if (res.headersSent || res.isHandled) return\n    return res.ok(result)\n  }\n\n  function handleError (error, req, res) {\n    if (res.headersSent || res.isHandled) return\n    return res.negotiate(error)\n  }\n}\n\n```\n\n#### 2. 参数校验`hook`\n\n*api/hooks/validator.js*\n```javascript\n\nconst Joi = require('joi')\nconst schemas = require('../schemas')\n\nmodule.exports = (sails) => ({\n  initialize: callback => {\n    Object.keys(sails.controllers).forEach(key => {\n      wrapAction(sails.controllers[key])\n    })\n    callback()\n  }\n})\n\nfunction wrapAction (controller) {\n  const id = controller.identity\n  Object.keys(controller).forEach(key => {\n    if (schemas && schemas[id] && schemas[id][key]) {\n      const action = sails.hooks.controllers.middleware[id][key.toLowerCase()]\n      sails.hooks.controllers.middleware[id][key.toLowerCase()] =\n        validateAction(action, schemas[id][key])\n    }\n  })\n}\n\nfunction validateAction (action, schema) {\n  return (req, res) => {\n    const params = req.allParams()\n    const { error } = Joi.validate(params, schema, { allowUnknown: true })\n    if (error != null) {\n      return res.negotiate(sails.Error(ERROR_CODES.ERR_INVALID_PARAMS, error))\n    }\n    return action(req, res)\n  }\n}\n\n```\n\n### 错误处理\n\n#### 1. 设置错误码\n\n再项目启动的时候设置错误代码：\n\n```javascript\n\nmodule.exports.bootstrap = function(cb) {\n  global.VError = require('verror')\n  global.ERROR_CODES = sails.config.app.ERROR_CODES\n  global.ERROR_PAYLOADS = sails.config.app.ERROR_PAYLOADS\n  sails.Error = UtilService.createError\n  cb()\n}\n\n```\n\n#### 2. 创建自定义错误\n\nUtilService.createError提供一个\b函数创建自定义错误:\n\n```javascript\n\n  createError: function (code, cause) {\n    const payload = ERROR_PAYLOADS[code]\n    const name = payload.name\n    const info = payload\n    info.code = code\n    return new VError({ name, info, cause })\n  }\n\n```\n\n#### 3. 错误冒泡\n\n项目启动的时候引入了`VError`, 项目代码在抛出错误的时候传递上一次错误的原因，在`response`函数内返回内嵌错误：\n\n```javascript\n\nif (data instanceof VError) {\n  const info = VError.info(data)\n  const cause = VError.cause(data)\n  const message = info.message + ':' + (cause ? cause.message : \"\" )\n  res.status(info.status)\n  res.json({ code: info.code, message, data: info.data || {} })\n}\n\n```\n\n### 测试\n\n目录结构：\n\n*sails-boilerplate/test*\n\n```shell\n\n├── bootstrap.test.js\n├── fixtures\n│   └── article.js\n├── integration\n│   ├── controllers\n│   └── services\n└── mocha.opts\n\n```\n\n`mocha.opts`放置mocha测试框架基本配置：\n\n```javascript\n\n--timeout 10s\n--exit\n--bail\n\n```\n\n`bootstrap.test.js`是sails启动测试的入口：\n\n```javascript\n\nbefore(function(done) {\n  sails.lift({\n    // configuration for testing purposes\n  }, function(err) {\n    if (err) return done(err);\n    // here you can load fixtures, etc.\n    setupFixtures(function (err) {\n      done(err, sails);      \n    })\n  });\n\n  after(function(done) {\n    // here you can clear fixtures, etc.\n    teardownFixtures(function (err) {\n      sails.lower(done);      \n    })\n  });\n})\n\n```\n\n> `setupFixtures`设置一些项目测试过程会使用的数据，`teardownFixtures`清除这些设置的数据。\n\n`integration`文件夹方式一些测试用例。`fixtures`文件夹方式设置一些创建各种测试数据的代码文件。\n\n项目\b地址：[sails-boilerplate](https://github.com/Luncher/sails-boilerplate)。","slug":"Sailsjs项目模板","published":1,"updated":"2018-07-01T10:30:46.493Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cdb001hy4zvyqr885b3","content":"<p>在微服务体系下, 随着新需求的不断迭代，需要不停分解(新建)一些服务，这个时候会有很多重复的工作。譬如说搭建项目基础框架，设置开发、生产环境的配置。经过一段时间对sailsjs的折腾之后，下定决心总结一个属于自己的项目模板，方便下次直接使用。</p>\n<p>项目模板主要包含以下几个模块：</p>\n<h3 id=\"基础结构\"><a href=\"#基础结构\" class=\"headerlink\" title=\"基础结构\"></a>基础结构</h3><h4 id=\"1-创建项目\"><a href=\"#1-创建项目\" class=\"headerlink\" title=\"1. 创建项目\"></a>1. 创建项目</h4><p>因为是一个\b纯后端项目，所以创建项目的时候指定基本选项：</p>\n<blockquote>\n<p>sails new project-name –no-linker –no-frontend</p>\n</blockquote>\n<h4 id=\"2-配置response\"><a href=\"#2-配置response\" class=\"headerlink\" title=\"2. 配置response\"></a>2. 配置<code>response</code></h4><p>设置<code>response</code>:</p>\n<p><code>api/responses</code>目录下有多个<code>response</code>文件，配置好相应的返回选项，譬如<code>serverError.js</code>:</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">module</span>.exports = <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">serverError</span> (<span class=\"params\">data, options</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> res = <span class=\"keyword\">this</span>.res</span><br><span class=\"line\">  <span class=\"keyword\">const</span> req = <span class=\"keyword\">this</span>.req</span><br><span class=\"line\"></span><br><span class=\"line\">  sails.log.error(<span class=\"string\">`<span class=\"subst\">$&#123;req.method&#125;</span> <span class=\"subst\">$&#123;req.url&#125;</span> Result: <span class=\"subst\">$&#123;util.inspect(data)&#125;</span>`</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (data <span class=\"keyword\">instanceof</span> VError) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> info = VError.info(data)</span><br><span class=\"line\">    <span class=\"keyword\">const</span> cause = VError.cause(data)</span><br><span class=\"line\">    <span class=\"keyword\">const</span> message = info.message + <span class=\"string\">':'</span> + (cause ? cause.message : <span class=\"string\">\"\"</span> )</span><br><span class=\"line\">    res.status(info.status)</span><br><span class=\"line\">    res.json(&#123; <span class=\"attr\">code</span>: info.code, message, <span class=\"attr\">data</span>: info.data || &#123;&#125; &#125;)</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (data <span class=\"keyword\">instanceof</span> <span class=\"built_in\">Error</span>) &#123;</span><br><span class=\"line\">    res.status(<span class=\"number\">500</span>)</span><br><span class=\"line\">    res.json(&#123; <span class=\"attr\">code</span>: <span class=\"number\">-1</span>, <span class=\"attr\">message</span>: data.message, <span class=\"attr\">data</span>: &#123;&#125; &#125;)</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    res.status(data.status || <span class=\"number\">500</span>)</span><br><span class=\"line\">    res.json(&#123; <span class=\"attr\">code</span>: <span class=\"number\">-1</span>, <span class=\"attr\">message</span>: data.message, <span class=\"attr\">data</span>: &#123;&#125; &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"3-设置rest风格的接口\"><a href=\"#3-设置rest风格的接口\" class=\"headerlink\" title=\"3. 设置rest风格的接口\"></a>3. 设置<code>rest</code>风格的接口</h4><p><code>config/blueprint.js</code>用于配置服务器支持的接口类型,关闭一些默认配置，只打开一些必要选项:</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  actions: <span class=\"literal\">false</span>,</span><br><span class=\"line\">  rest: <span class=\"literal\">true</span>,</span><br><span class=\"line\">  shortcuts: <span class=\"literal\">false</span>,</span><br><span class=\"line\">  restPrefix: <span class=\"string\">'/api'</span>,</span><br><span class=\"line\">  pluralize: <span class=\"literal\">true</span>,</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"设置必要的hooks\"><a href=\"#设置必要的hooks\" class=\"headerlink\" title=\"设置必要的hooks\"></a>设置必要的<code>hooks</code></h3><h4 id=\"1-捕获错误hook\"><a href=\"#1-捕获错误hook\" class=\"headerlink\" title=\"1. 捕获错误hook\"></a>1. 捕获错误<code>hook</code></h4><p><em>api/hooks/asyncWrapper.js</em></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> _ = <span class=\"built_in\">require</span>(<span class=\"string\">'lodash'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">module</span>.exports = <span class=\"function\">(<span class=\"params\">sails</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> &#123;</span><br><span class=\"line\">    initialize: <span class=\"function\">(<span class=\"params\">callback</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      _.each(sails.controllers, (controller, controllerId) =&gt; &#123;</span><br><span class=\"line\">        _.each(controller, (_, actionId) =&gt; &#123;</span><br><span class=\"line\">          actionId = actionId.toLowerCase()</span><br><span class=\"line\">          <span class=\"keyword\">const</span> action = sails.hooks.controllers.middleware[controllerId][actionId]</span><br><span class=\"line\">          sails.hooks.controllers.middleware[controllerId][actionId] = handleAction(action)</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">      callback()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">handleAction</span> (<span class=\"params\">action</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"function\">(<span class=\"params\">req, res</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">Promise</span>.resolve(action(req, res))</span><br><span class=\"line\">          .then(<span class=\"function\"><span class=\"params\">result</span> =&gt;</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> handleResult(result, req, res)</span><br><span class=\"line\">          &#125;)</span><br><span class=\"line\">          .catch(<span class=\"function\"><span class=\"params\">err</span> =&gt;</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> handleError(err, req, res)</span><br><span class=\"line\">          &#125;)</span><br><span class=\"line\">      &#125; <span class=\"keyword\">catch</span> (err) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> handleError(err, req, res)</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">handleResult</span> (<span class=\"params\">result, req, res</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (res.headersSent || res.isHandled) <span class=\"keyword\">return</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> res.ok(result)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">handleError</span> (<span class=\"params\">error, req, res</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (res.headersSent || res.isHandled) <span class=\"keyword\">return</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> res.negotiate(error)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"2-参数校验hook\"><a href=\"#2-参数校验hook\" class=\"headerlink\" title=\"2. 参数校验hook\"></a>2. 参数校验<code>hook</code></h4><p><em>api/hooks/validator.js</em><br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> Joi = <span class=\"built_in\">require</span>(<span class=\"string\">'joi'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> schemas = <span class=\"built_in\">require</span>(<span class=\"string\">'../schemas'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">module</span>.exports = <span class=\"function\">(<span class=\"params\">sails</span>) =&gt;</span> (&#123;</span><br><span class=\"line\">  initialize: <span class=\"function\"><span class=\"params\">callback</span> =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">Object</span>.keys(sails.controllers).forEach(<span class=\"function\"><span class=\"params\">key</span> =&gt;</span> &#123;</span><br><span class=\"line\">      wrapAction(sails.controllers[key])</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">    callback()</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">wrapAction</span> (<span class=\"params\">controller</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> id = controller.identity</span><br><span class=\"line\">  <span class=\"built_in\">Object</span>.keys(controller).forEach(<span class=\"function\"><span class=\"params\">key</span> =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (schemas &amp;&amp; schemas[id] &amp;&amp; schemas[id][key]) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> action = sails.hooks.controllers.middleware[id][key.toLowerCase()]</span><br><span class=\"line\">      sails.hooks.controllers.middleware[id][key.toLowerCase()] =</span><br><span class=\"line\">        validateAction(action, schemas[id][key])</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">validateAction</span> (<span class=\"params\">action, schema</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"function\">(<span class=\"params\">req, res</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> params = req.allParams()</span><br><span class=\"line\">    <span class=\"keyword\">const</span> &#123; error &#125; = Joi.validate(params, schema, &#123; <span class=\"attr\">allowUnknown</span>: <span class=\"literal\">true</span> &#125;)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (error != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> res.negotiate(sails.Error(ERROR_CODES.ERR_INVALID_PARAMS, error))</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> action(req, res)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"错误处理\"><a href=\"#错误处理\" class=\"headerlink\" title=\"错误处理\"></a>错误处理</h3><h4 id=\"1-设置错误码\"><a href=\"#1-设置错误码\" class=\"headerlink\" title=\"1. 设置错误码\"></a>1. 设置错误码</h4><p>再项目启动的时候设置错误代码：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">module</span>.exports.bootstrap = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">cb</span>) </span>&#123;</span><br><span class=\"line\">  global.VError = <span class=\"built_in\">require</span>(<span class=\"string\">'verror'</span>)</span><br><span class=\"line\">  global.ERROR_CODES = sails.config.app.ERROR_CODES</span><br><span class=\"line\">  global.ERROR_PAYLOADS = sails.config.app.ERROR_PAYLOADS</span><br><span class=\"line\">  sails.Error = UtilService.createError</span><br><span class=\"line\">  cb()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"2-创建自定义错误\"><a href=\"#2-创建自定义错误\" class=\"headerlink\" title=\"2. 创建自定义错误\"></a>2. 创建自定义错误</h4><p>UtilService.createError提供一个\b函数创建自定义错误:</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">createError: <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">code, cause</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> payload = ERROR_PAYLOADS[code]</span><br><span class=\"line\">  <span class=\"keyword\">const</span> name = payload.name</span><br><span class=\"line\">  <span class=\"keyword\">const</span> info = payload</span><br><span class=\"line\">  info.code = code</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> VError(&#123; name, info, cause &#125;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"3-错误冒泡\"><a href=\"#3-错误冒泡\" class=\"headerlink\" title=\"3. 错误冒泡\"></a>3. 错误冒泡</h4><p>项目启动的时候引入了<code>VError</code>, 项目代码在抛出错误的时候传递上一次错误的原因，在<code>response</code>函数内返回内嵌错误：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> (data <span class=\"keyword\">instanceof</span> VError) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> info = VError.info(data)</span><br><span class=\"line\">  <span class=\"keyword\">const</span> cause = VError.cause(data)</span><br><span class=\"line\">  <span class=\"keyword\">const</span> message = info.message + <span class=\"string\">':'</span> + (cause ? cause.message : <span class=\"string\">\"\"</span> )</span><br><span class=\"line\">  res.status(info.status)</span><br><span class=\"line\">  res.json(&#123; <span class=\"attr\">code</span>: info.code, message, <span class=\"attr\">data</span>: info.data || &#123;&#125; &#125;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h3><p>目录结构：</p>\n<p><em>sails-boilerplate/test</em></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">├── bootstrap.test.js</span><br><span class=\"line\">├── fixtures</span><br><span class=\"line\">│   └── article.js</span><br><span class=\"line\">├── integration</span><br><span class=\"line\">│   ├── controllers</span><br><span class=\"line\">│   └── services</span><br><span class=\"line\">└── mocha.opts</span><br></pre></td></tr></table></figure>\n<p><code>mocha.opts</code>放置mocha测试框架基本配置：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">--timeout <span class=\"number\">10</span>s</span><br><span class=\"line\">--exit</span><br><span class=\"line\">--bail</span><br></pre></td></tr></table></figure>\n<p><code>bootstrap.test.js</code>是sails启动测试的入口：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">before(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">done</span>) </span>&#123;</span><br><span class=\"line\">  sails.lift(&#123;</span><br><span class=\"line\">    <span class=\"comment\">// configuration for testing purposes</span></span><br><span class=\"line\">  &#125;, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">err</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (err) <span class=\"keyword\">return</span> done(err);</span><br><span class=\"line\">    <span class=\"comment\">// here you can load fixtures, etc.</span></span><br><span class=\"line\">    setupFixtures(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">err</span>) </span>&#123;</span><br><span class=\"line\">      done(err, sails);      </span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">  after(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">done</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// here you can clear fixtures, etc.</span></span><br><span class=\"line\">    teardownFixtures(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">err</span>) </span>&#123;</span><br><span class=\"line\">      sails.lower(done);      </span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>setupFixtures</code>设置一些项目测试过程会使用的数据，<code>teardownFixtures</code>清除这些设置的数据。</p>\n</blockquote>\n<p><code>integration</code>文件夹方式一些测试用例。<code>fixtures</code>文件夹方式设置一些创建各种测试数据的代码文件。</p>\n<p>项目\b地址：<a href=\"https://github.com/Luncher/sails-boilerplate\" target=\"_blank\" rel=\"noopener\">sails-boilerplate</a>。</p>\n","site":{"data":{}},"excerpt":"","more":"<p>在微服务体系下, 随着新需求的不断迭代，需要不停分解(新建)一些服务，这个时候会有很多重复的工作。譬如说搭建项目基础框架，设置开发、生产环境的配置。经过一段时间对sailsjs的折腾之后，下定决心总结一个属于自己的项目模板，方便下次直接使用。</p>\n<p>项目模板主要包含以下几个模块：</p>\n<h3 id=\"基础结构\"><a href=\"#基础结构\" class=\"headerlink\" title=\"基础结构\"></a>基础结构</h3><h4 id=\"1-创建项目\"><a href=\"#1-创建项目\" class=\"headerlink\" title=\"1. 创建项目\"></a>1. 创建项目</h4><p>因为是一个\b纯后端项目，所以创建项目的时候指定基本选项：</p>\n<blockquote>\n<p>sails new project-name –no-linker –no-frontend</p>\n</blockquote>\n<h4 id=\"2-配置response\"><a href=\"#2-配置response\" class=\"headerlink\" title=\"2. 配置response\"></a>2. 配置<code>response</code></h4><p>设置<code>response</code>:</p>\n<p><code>api/responses</code>目录下有多个<code>response</code>文件，配置好相应的返回选项，譬如<code>serverError.js</code>:</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">module</span>.exports = <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">serverError</span> (<span class=\"params\">data, options</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> res = <span class=\"keyword\">this</span>.res</span><br><span class=\"line\">  <span class=\"keyword\">const</span> req = <span class=\"keyword\">this</span>.req</span><br><span class=\"line\"></span><br><span class=\"line\">  sails.log.error(<span class=\"string\">`<span class=\"subst\">$&#123;req.method&#125;</span> <span class=\"subst\">$&#123;req.url&#125;</span> Result: <span class=\"subst\">$&#123;util.inspect(data)&#125;</span>`</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (data <span class=\"keyword\">instanceof</span> VError) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> info = VError.info(data)</span><br><span class=\"line\">    <span class=\"keyword\">const</span> cause = VError.cause(data)</span><br><span class=\"line\">    <span class=\"keyword\">const</span> message = info.message + <span class=\"string\">':'</span> + (cause ? cause.message : <span class=\"string\">\"\"</span> )</span><br><span class=\"line\">    res.status(info.status)</span><br><span class=\"line\">    res.json(&#123; <span class=\"attr\">code</span>: info.code, message, <span class=\"attr\">data</span>: info.data || &#123;&#125; &#125;)</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (data <span class=\"keyword\">instanceof</span> <span class=\"built_in\">Error</span>) &#123;</span><br><span class=\"line\">    res.status(<span class=\"number\">500</span>)</span><br><span class=\"line\">    res.json(&#123; <span class=\"attr\">code</span>: <span class=\"number\">-1</span>, <span class=\"attr\">message</span>: data.message, <span class=\"attr\">data</span>: &#123;&#125; &#125;)</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    res.status(data.status || <span class=\"number\">500</span>)</span><br><span class=\"line\">    res.json(&#123; <span class=\"attr\">code</span>: <span class=\"number\">-1</span>, <span class=\"attr\">message</span>: data.message, <span class=\"attr\">data</span>: &#123;&#125; &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"3-设置rest风格的接口\"><a href=\"#3-设置rest风格的接口\" class=\"headerlink\" title=\"3. 设置rest风格的接口\"></a>3. 设置<code>rest</code>风格的接口</h4><p><code>config/blueprint.js</code>用于配置服务器支持的接口类型,关闭一些默认配置，只打开一些必要选项:</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  actions: <span class=\"literal\">false</span>,</span><br><span class=\"line\">  rest: <span class=\"literal\">true</span>,</span><br><span class=\"line\">  shortcuts: <span class=\"literal\">false</span>,</span><br><span class=\"line\">  restPrefix: <span class=\"string\">'/api'</span>,</span><br><span class=\"line\">  pluralize: <span class=\"literal\">true</span>,</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"设置必要的hooks\"><a href=\"#设置必要的hooks\" class=\"headerlink\" title=\"设置必要的hooks\"></a>设置必要的<code>hooks</code></h3><h4 id=\"1-捕获错误hook\"><a href=\"#1-捕获错误hook\" class=\"headerlink\" title=\"1. 捕获错误hook\"></a>1. 捕获错误<code>hook</code></h4><p><em>api/hooks/asyncWrapper.js</em></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> _ = <span class=\"built_in\">require</span>(<span class=\"string\">'lodash'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">module</span>.exports = <span class=\"function\">(<span class=\"params\">sails</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> &#123;</span><br><span class=\"line\">    initialize: <span class=\"function\">(<span class=\"params\">callback</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      _.each(sails.controllers, (controller, controllerId) =&gt; &#123;</span><br><span class=\"line\">        _.each(controller, (_, actionId) =&gt; &#123;</span><br><span class=\"line\">          actionId = actionId.toLowerCase()</span><br><span class=\"line\">          <span class=\"keyword\">const</span> action = sails.hooks.controllers.middleware[controllerId][actionId]</span><br><span class=\"line\">          sails.hooks.controllers.middleware[controllerId][actionId] = handleAction(action)</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">      callback()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">handleAction</span> (<span class=\"params\">action</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"function\">(<span class=\"params\">req, res</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">Promise</span>.resolve(action(req, res))</span><br><span class=\"line\">          .then(<span class=\"function\"><span class=\"params\">result</span> =&gt;</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> handleResult(result, req, res)</span><br><span class=\"line\">          &#125;)</span><br><span class=\"line\">          .catch(<span class=\"function\"><span class=\"params\">err</span> =&gt;</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> handleError(err, req, res)</span><br><span class=\"line\">          &#125;)</span><br><span class=\"line\">      &#125; <span class=\"keyword\">catch</span> (err) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> handleError(err, req, res)</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">handleResult</span> (<span class=\"params\">result, req, res</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (res.headersSent || res.isHandled) <span class=\"keyword\">return</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> res.ok(result)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">handleError</span> (<span class=\"params\">error, req, res</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (res.headersSent || res.isHandled) <span class=\"keyword\">return</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> res.negotiate(error)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"2-参数校验hook\"><a href=\"#2-参数校验hook\" class=\"headerlink\" title=\"2. 参数校验hook\"></a>2. 参数校验<code>hook</code></h4><p><em>api/hooks/validator.js</em><br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> Joi = <span class=\"built_in\">require</span>(<span class=\"string\">'joi'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> schemas = <span class=\"built_in\">require</span>(<span class=\"string\">'../schemas'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">module</span>.exports = <span class=\"function\">(<span class=\"params\">sails</span>) =&gt;</span> (&#123;</span><br><span class=\"line\">  initialize: <span class=\"function\"><span class=\"params\">callback</span> =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">Object</span>.keys(sails.controllers).forEach(<span class=\"function\"><span class=\"params\">key</span> =&gt;</span> &#123;</span><br><span class=\"line\">      wrapAction(sails.controllers[key])</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">    callback()</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">wrapAction</span> (<span class=\"params\">controller</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> id = controller.identity</span><br><span class=\"line\">  <span class=\"built_in\">Object</span>.keys(controller).forEach(<span class=\"function\"><span class=\"params\">key</span> =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (schemas &amp;&amp; schemas[id] &amp;&amp; schemas[id][key]) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> action = sails.hooks.controllers.middleware[id][key.toLowerCase()]</span><br><span class=\"line\">      sails.hooks.controllers.middleware[id][key.toLowerCase()] =</span><br><span class=\"line\">        validateAction(action, schemas[id][key])</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">validateAction</span> (<span class=\"params\">action, schema</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"function\">(<span class=\"params\">req, res</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> params = req.allParams()</span><br><span class=\"line\">    <span class=\"keyword\">const</span> &#123; error &#125; = Joi.validate(params, schema, &#123; <span class=\"attr\">allowUnknown</span>: <span class=\"literal\">true</span> &#125;)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (error != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> res.negotiate(sails.Error(ERROR_CODES.ERR_INVALID_PARAMS, error))</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> action(req, res)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"错误处理\"><a href=\"#错误处理\" class=\"headerlink\" title=\"错误处理\"></a>错误处理</h3><h4 id=\"1-设置错误码\"><a href=\"#1-设置错误码\" class=\"headerlink\" title=\"1. 设置错误码\"></a>1. 设置错误码</h4><p>再项目启动的时候设置错误代码：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">module</span>.exports.bootstrap = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">cb</span>) </span>&#123;</span><br><span class=\"line\">  global.VError = <span class=\"built_in\">require</span>(<span class=\"string\">'verror'</span>)</span><br><span class=\"line\">  global.ERROR_CODES = sails.config.app.ERROR_CODES</span><br><span class=\"line\">  global.ERROR_PAYLOADS = sails.config.app.ERROR_PAYLOADS</span><br><span class=\"line\">  sails.Error = UtilService.createError</span><br><span class=\"line\">  cb()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"2-创建自定义错误\"><a href=\"#2-创建自定义错误\" class=\"headerlink\" title=\"2. 创建自定义错误\"></a>2. 创建自定义错误</h4><p>UtilService.createError提供一个\b函数创建自定义错误:</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">createError: <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">code, cause</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> payload = ERROR_PAYLOADS[code]</span><br><span class=\"line\">  <span class=\"keyword\">const</span> name = payload.name</span><br><span class=\"line\">  <span class=\"keyword\">const</span> info = payload</span><br><span class=\"line\">  info.code = code</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> VError(&#123; name, info, cause &#125;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"3-错误冒泡\"><a href=\"#3-错误冒泡\" class=\"headerlink\" title=\"3. 错误冒泡\"></a>3. 错误冒泡</h4><p>项目启动的时候引入了<code>VError</code>, 项目代码在抛出错误的时候传递上一次错误的原因，在<code>response</code>函数内返回内嵌错误：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> (data <span class=\"keyword\">instanceof</span> VError) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> info = VError.info(data)</span><br><span class=\"line\">  <span class=\"keyword\">const</span> cause = VError.cause(data)</span><br><span class=\"line\">  <span class=\"keyword\">const</span> message = info.message + <span class=\"string\">':'</span> + (cause ? cause.message : <span class=\"string\">\"\"</span> )</span><br><span class=\"line\">  res.status(info.status)</span><br><span class=\"line\">  res.json(&#123; <span class=\"attr\">code</span>: info.code, message, <span class=\"attr\">data</span>: info.data || &#123;&#125; &#125;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h3><p>目录结构：</p>\n<p><em>sails-boilerplate/test</em></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">├── bootstrap.test.js</span><br><span class=\"line\">├── fixtures</span><br><span class=\"line\">│   └── article.js</span><br><span class=\"line\">├── integration</span><br><span class=\"line\">│   ├── controllers</span><br><span class=\"line\">│   └── services</span><br><span class=\"line\">└── mocha.opts</span><br></pre></td></tr></table></figure>\n<p><code>mocha.opts</code>放置mocha测试框架基本配置：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">--timeout <span class=\"number\">10</span>s</span><br><span class=\"line\">--exit</span><br><span class=\"line\">--bail</span><br></pre></td></tr></table></figure>\n<p><code>bootstrap.test.js</code>是sails启动测试的入口：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">before(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">done</span>) </span>&#123;</span><br><span class=\"line\">  sails.lift(&#123;</span><br><span class=\"line\">    <span class=\"comment\">// configuration for testing purposes</span></span><br><span class=\"line\">  &#125;, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">err</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (err) <span class=\"keyword\">return</span> done(err);</span><br><span class=\"line\">    <span class=\"comment\">// here you can load fixtures, etc.</span></span><br><span class=\"line\">    setupFixtures(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">err</span>) </span>&#123;</span><br><span class=\"line\">      done(err, sails);      </span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">  after(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">done</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// here you can clear fixtures, etc.</span></span><br><span class=\"line\">    teardownFixtures(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">err</span>) </span>&#123;</span><br><span class=\"line\">      sails.lower(done);      </span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>setupFixtures</code>设置一些项目测试过程会使用的数据，<code>teardownFixtures</code>清除这些设置的数据。</p>\n</blockquote>\n<p><code>integration</code>文件夹方式一些测试用例。<code>fixtures</code>文件夹方式设置一些创建各种测试数据的代码文件。</p>\n<p>项目\b地址：<a href=\"https://github.com/Luncher/sails-boilerplate\" target=\"_blank\" rel=\"noopener\">sails-boilerplate</a>。</p>\n"},{"title":"ScrollTo动画","date":"2016-08-26T02:05:18.000Z","_content":"\n\n# 简单的ScrollTo动画实现\n\n在页面导航栏目设置几个标题按钮，按下的时候调转到对应的位置，这大概是浏览器页面开发最基本的动效之一了。看了一下很多页面都是基于`jquery`来实现，我不想用它，所以要自己造一个轮子。我们知道浏览器页面滚动都是基于`window.scrollTo`函数来实现的，还有一个函数叫`window.scrollBy`,用于滚动到某个相对坐标位置。\n\n---\n\n## 锚元素点击事件\n\n``` javascript\n\n let anchors = document.querySelectorAll('nav > a');\n  anchors.forEach(function(element) {\n    element.addEventListener('click', function(e) {\n      e.preventDefault();\n      scrollTo(this, document.getElementById(this.href.split('#')[1]), 2000);\n    });\n  }, this);\n\n```\n\n滚动时长设置为`2s`固定值。\n\n---\n\n## 滚动函数实现\n\n``` javascript\n\nfunction scrollTo(element, to, delay) {\n    var difference = to.getBoundingClientRect().top - element.getBoundingClientRect().top - 80;\n    var stepTime = 8;\n    var stepDis = difference*stepTime / delay ;\n    var count = Math.ceil(difference/stepDis);\n    var index = 0;\n\n    var outQuart = function(n){\n      return 1 - (--n * n * n * n);\n    };\n\n    function stepFunc() {\n      index++;\n      setTimeout(function() {\n        var diff = outQuart(index/count)*difference;\n        if(count >= index) {\n          window.scrollTo(0, diff);\n          stepFunc();\n        }\n      }, stepTime);\n    }\n\n    stepFunc();\n}\n\n```\n\n`getBoundingClientRect`函数用于获取元素大小和相对视口的位置。为了让屏幕滚动更加平滑一些，这里借助了`outQuart`插值算法，如果想要其他效果可以看[插值算法对照表](http://easings.net/zh-cn),\n赠送一个[插值算法库](https://github.com/component/ease)。","source":"_posts/ScrollTo动画.md","raw":"---\ntitle: ScrollTo动画\ndate: 2016-08-26 10:05:18\ntags: css scrollTo\ncategories: web\n---\n\n\n# 简单的ScrollTo动画实现\n\n在页面导航栏目设置几个标题按钮，按下的时候调转到对应的位置，这大概是浏览器页面开发最基本的动效之一了。看了一下很多页面都是基于`jquery`来实现，我不想用它，所以要自己造一个轮子。我们知道浏览器页面滚动都是基于`window.scrollTo`函数来实现的，还有一个函数叫`window.scrollBy`,用于滚动到某个相对坐标位置。\n\n---\n\n## 锚元素点击事件\n\n``` javascript\n\n let anchors = document.querySelectorAll('nav > a');\n  anchors.forEach(function(element) {\n    element.addEventListener('click', function(e) {\n      e.preventDefault();\n      scrollTo(this, document.getElementById(this.href.split('#')[1]), 2000);\n    });\n  }, this);\n\n```\n\n滚动时长设置为`2s`固定值。\n\n---\n\n## 滚动函数实现\n\n``` javascript\n\nfunction scrollTo(element, to, delay) {\n    var difference = to.getBoundingClientRect().top - element.getBoundingClientRect().top - 80;\n    var stepTime = 8;\n    var stepDis = difference*stepTime / delay ;\n    var count = Math.ceil(difference/stepDis);\n    var index = 0;\n\n    var outQuart = function(n){\n      return 1 - (--n * n * n * n);\n    };\n\n    function stepFunc() {\n      index++;\n      setTimeout(function() {\n        var diff = outQuart(index/count)*difference;\n        if(count >= index) {\n          window.scrollTo(0, diff);\n          stepFunc();\n        }\n      }, stepTime);\n    }\n\n    stepFunc();\n}\n\n```\n\n`getBoundingClientRect`函数用于获取元素大小和相对视口的位置。为了让屏幕滚动更加平滑一些，这里借助了`outQuart`插值算法，如果想要其他效果可以看[插值算法对照表](http://easings.net/zh-cn),\n赠送一个[插值算法库](https://github.com/component/ease)。","slug":"ScrollTo动画","published":1,"updated":"2018-07-01T10:30:46.493Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cdb001jy4zvatmkw8hi","content":"<h1 id=\"简单的ScrollTo动画实现\"><a href=\"#简单的ScrollTo动画实现\" class=\"headerlink\" title=\"简单的ScrollTo动画实现\"></a>简单的ScrollTo动画实现</h1><p>在页面导航栏目设置几个标题按钮，按下的时候调转到对应的位置，这大概是浏览器页面开发最基本的动效之一了。看了一下很多页面都是基于<code>jquery</code>来实现，我不想用它，所以要自己造一个轮子。我们知道浏览器页面滚动都是基于<code>window.scrollTo</code>函数来实现的，还有一个函数叫<code>window.scrollBy</code>,用于滚动到某个相对坐标位置。</p>\n<hr>\n<h2 id=\"锚元素点击事件\"><a href=\"#锚元素点击事件\" class=\"headerlink\" title=\"锚元素点击事件\"></a>锚元素点击事件</h2><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">let</span> anchors = <span class=\"built_in\">document</span>.querySelectorAll(<span class=\"string\">'nav &gt; a'</span>);</span><br><span class=\"line\"> anchors.forEach(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">element</span>) </span>&#123;</span><br><span class=\"line\">   element.addEventListener(<span class=\"string\">'click'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">e</span>) </span>&#123;</span><br><span class=\"line\">     e.preventDefault();</span><br><span class=\"line\">     scrollTo(<span class=\"keyword\">this</span>, <span class=\"built_in\">document</span>.getElementById(<span class=\"keyword\">this</span>.href.split(<span class=\"string\">'#'</span>)[<span class=\"number\">1</span>]), <span class=\"number\">2000</span>);</span><br><span class=\"line\">   &#125;);</span><br><span class=\"line\"> &#125;, <span class=\"keyword\">this</span>);</span><br></pre></td></tr></table></figure>\n<p>滚动时长设置为<code>2s</code>固定值。</p>\n<hr>\n<h2 id=\"滚动函数实现\"><a href=\"#滚动函数实现\" class=\"headerlink\" title=\"滚动函数实现\"></a>滚动函数实现</h2><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">scrollTo</span>(<span class=\"params\">element, to, delay</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> difference = to.getBoundingClientRect().top - element.getBoundingClientRect().top - <span class=\"number\">80</span>;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> stepTime = <span class=\"number\">8</span>;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> stepDis = difference*stepTime / delay ;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> count = <span class=\"built_in\">Math</span>.ceil(difference/stepDis);</span><br><span class=\"line\">    <span class=\"keyword\">var</span> index = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">var</span> outQuart = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">n</span>)</span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"number\">1</span> - (--n * n * n * n);</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">stepFunc</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">      index++;</span><br><span class=\"line\">      setTimeout(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> diff = outQuart(index/count)*difference;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(count &gt;= index) &#123;</span><br><span class=\"line\">          <span class=\"built_in\">window</span>.scrollTo(<span class=\"number\">0</span>, diff);</span><br><span class=\"line\">          stepFunc();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;, stepTime);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    stepFunc();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>getBoundingClientRect</code>函数用于获取元素大小和相对视口的位置。为了让屏幕滚动更加平滑一些，这里借助了<code>outQuart</code>插值算法，如果想要其他效果可以看<a href=\"http://easings.net/zh-cn\" target=\"_blank\" rel=\"noopener\">插值算法对照表</a>,<br>赠送一个<a href=\"https://github.com/component/ease\" target=\"_blank\" rel=\"noopener\">插值算法库</a>。</p>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"简单的ScrollTo动画实现\"><a href=\"#简单的ScrollTo动画实现\" class=\"headerlink\" title=\"简单的ScrollTo动画实现\"></a>简单的ScrollTo动画实现</h1><p>在页面导航栏目设置几个标题按钮，按下的时候调转到对应的位置，这大概是浏览器页面开发最基本的动效之一了。看了一下很多页面都是基于<code>jquery</code>来实现，我不想用它，所以要自己造一个轮子。我们知道浏览器页面滚动都是基于<code>window.scrollTo</code>函数来实现的，还有一个函数叫<code>window.scrollBy</code>,用于滚动到某个相对坐标位置。</p>\n<hr>\n<h2 id=\"锚元素点击事件\"><a href=\"#锚元素点击事件\" class=\"headerlink\" title=\"锚元素点击事件\"></a>锚元素点击事件</h2><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">let</span> anchors = <span class=\"built_in\">document</span>.querySelectorAll(<span class=\"string\">'nav &gt; a'</span>);</span><br><span class=\"line\"> anchors.forEach(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">element</span>) </span>&#123;</span><br><span class=\"line\">   element.addEventListener(<span class=\"string\">'click'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">e</span>) </span>&#123;</span><br><span class=\"line\">     e.preventDefault();</span><br><span class=\"line\">     scrollTo(<span class=\"keyword\">this</span>, <span class=\"built_in\">document</span>.getElementById(<span class=\"keyword\">this</span>.href.split(<span class=\"string\">'#'</span>)[<span class=\"number\">1</span>]), <span class=\"number\">2000</span>);</span><br><span class=\"line\">   &#125;);</span><br><span class=\"line\"> &#125;, <span class=\"keyword\">this</span>);</span><br></pre></td></tr></table></figure>\n<p>滚动时长设置为<code>2s</code>固定值。</p>\n<hr>\n<h2 id=\"滚动函数实现\"><a href=\"#滚动函数实现\" class=\"headerlink\" title=\"滚动函数实现\"></a>滚动函数实现</h2><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">scrollTo</span>(<span class=\"params\">element, to, delay</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> difference = to.getBoundingClientRect().top - element.getBoundingClientRect().top - <span class=\"number\">80</span>;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> stepTime = <span class=\"number\">8</span>;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> stepDis = difference*stepTime / delay ;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> count = <span class=\"built_in\">Math</span>.ceil(difference/stepDis);</span><br><span class=\"line\">    <span class=\"keyword\">var</span> index = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">var</span> outQuart = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">n</span>)</span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"number\">1</span> - (--n * n * n * n);</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">stepFunc</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">      index++;</span><br><span class=\"line\">      setTimeout(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> diff = outQuart(index/count)*difference;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(count &gt;= index) &#123;</span><br><span class=\"line\">          <span class=\"built_in\">window</span>.scrollTo(<span class=\"number\">0</span>, diff);</span><br><span class=\"line\">          stepFunc();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;, stepTime);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    stepFunc();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>getBoundingClientRect</code>函数用于获取元素大小和相对视口的位置。为了让屏幕滚动更加平滑一些，这里借助了<code>outQuart</code>插值算法，如果想要其他效果可以看<a href=\"http://easings.net/zh-cn\" target=\"_blank\" rel=\"noopener\">插值算法对照表</a>,<br>赠送一个<a href=\"https://github.com/component/ease\" target=\"_blank\" rel=\"noopener\">插值算法库</a>。</p>\n"},{"title":"textMate snippet说明","date":"2016-06-08T11:37:24.000Z","_content":"\ntextMate一直是`mac`下常用的编辑器不过现在好像被`sublime`、`atom`、`vscode`等一系列新生带编辑器取代。为了学习`vscode`的编写，打算系统学学`snippet`语法。\n\n以下译自：\n> https://manual.macromates.com/en/snippets\n\nsnippet是一小段的文本，你可以插入到你的文档里面。它可以包含代码，变量，`tab`键，占位符，以及转换。\n\n# 普通文本\n\n在最简单的情况下，你可以使用 snippet插入一些文本，避免一遍又一遍的重复输入。这样不仅减少输入次数，而且减少出错。  \n\n在你使用 snippet的时候唯一一件事情需要注意的是：`$`和\\`是保留字符，如果你想要使用这两个字符，你需要在字符前面加入一个转译符号：`\\`。\n\n# 变量\n\n你可以通过在变量名称前面加入`$`的形式插入变量。所有的正常变量都被支持，最有用的大概是：`TM_SELECTED_TEXT`变量。例如我们想要创建一个 snippet,用于包装`LaTeX \\textbf`命令的选择，我们可以这样写：\n\n> \\textbf{$TM_SELECTED_TEXT}\n\n如果没有文本被选中，变量不会被设置，也就不会插入任何文本。我们可以通过以下语法插入一个默认值： \n\n>\\textbf{${TM_SELECTED_TEXT:no text was selected}}\n\n默认值也可以包含变量，或者`shell code`。如果默认文本必须包含`}`，则需要转译。\n\n# `Tab`键\n\n在输入完成后，光标会停留在`snippet`最后的位置，又时候这不是我们要的结果。我们可以通过使用`$0`的形式指定光标停留的位置。例如，如果我们给`html`文件定义一个名为`div`的`snippet`，并且希望光标停留在开始和结束标签中间。我们可以这样写：\n\n``` html\n<div>\n    $0\n<div>\n```\n\n我们还可以在$后面指定更多的数字，按下`tab`键的时候控制光标在这些位置移动。例如：\n\n``` html\n<div$1>\n    $0\n<div>\n```\n\n第一次光标出现在$0位置，按下`tab`光标移动到$1位置。\n\n# 占位符\n\n和变量一样，`tab`也可以有占位符，语法类似：\n>${«tab stop»:«default value»}\n\n默认值可以包含文本、`shell code`、以及其他占位符：\n\n``` html\n<div${1: id=\"${2:some_id}\"}>\n    $0\n</div>\n```\n\n插入该`snippet`将会插入一个`div`标签，`id`参数被选中，我们可以直接编辑它或者按下`tab`键切换光标位置。当你编辑占位符文本，内嵌的`tab`停止位会被删除。\n\n# 镜像\n\n有时候我们想要同时修改多个位置，即编辑一个文本的时候能够影响到多个位置。例如，我们新建一个`laTex`的`snippet`：\n\n``` html\n\\begin{${1:enumerate}}\n    $0\n\\end{$1}\n```\n\n在插入完成该`snippet`，`enumerate`会被选中，修改它会影响到`\\end`位置部分。\n\n*vscode*没有支持的格式没有做翻译，有兴趣的自己研究：）","source":"_posts/TextMate snippet.md","raw":"---\ntitle: textMate snippet说明\ncategories: vscode\ndate: 2016-06-08 19:37:24\n---\n\ntextMate一直是`mac`下常用的编辑器不过现在好像被`sublime`、`atom`、`vscode`等一系列新生带编辑器取代。为了学习`vscode`的编写，打算系统学学`snippet`语法。\n\n以下译自：\n> https://manual.macromates.com/en/snippets\n\nsnippet是一小段的文本，你可以插入到你的文档里面。它可以包含代码，变量，`tab`键，占位符，以及转换。\n\n# 普通文本\n\n在最简单的情况下，你可以使用 snippet插入一些文本，避免一遍又一遍的重复输入。这样不仅减少输入次数，而且减少出错。  \n\n在你使用 snippet的时候唯一一件事情需要注意的是：`$`和\\`是保留字符，如果你想要使用这两个字符，你需要在字符前面加入一个转译符号：`\\`。\n\n# 变量\n\n你可以通过在变量名称前面加入`$`的形式插入变量。所有的正常变量都被支持，最有用的大概是：`TM_SELECTED_TEXT`变量。例如我们想要创建一个 snippet,用于包装`LaTeX \\textbf`命令的选择，我们可以这样写：\n\n> \\textbf{$TM_SELECTED_TEXT}\n\n如果没有文本被选中，变量不会被设置，也就不会插入任何文本。我们可以通过以下语法插入一个默认值： \n\n>\\textbf{${TM_SELECTED_TEXT:no text was selected}}\n\n默认值也可以包含变量，或者`shell code`。如果默认文本必须包含`}`，则需要转译。\n\n# `Tab`键\n\n在输入完成后，光标会停留在`snippet`最后的位置，又时候这不是我们要的结果。我们可以通过使用`$0`的形式指定光标停留的位置。例如，如果我们给`html`文件定义一个名为`div`的`snippet`，并且希望光标停留在开始和结束标签中间。我们可以这样写：\n\n``` html\n<div>\n    $0\n<div>\n```\n\n我们还可以在$后面指定更多的数字，按下`tab`键的时候控制光标在这些位置移动。例如：\n\n``` html\n<div$1>\n    $0\n<div>\n```\n\n第一次光标出现在$0位置，按下`tab`光标移动到$1位置。\n\n# 占位符\n\n和变量一样，`tab`也可以有占位符，语法类似：\n>${«tab stop»:«default value»}\n\n默认值可以包含文本、`shell code`、以及其他占位符：\n\n``` html\n<div${1: id=\"${2:some_id}\"}>\n    $0\n</div>\n```\n\n插入该`snippet`将会插入一个`div`标签，`id`参数被选中，我们可以直接编辑它或者按下`tab`键切换光标位置。当你编辑占位符文本，内嵌的`tab`停止位会被删除。\n\n# 镜像\n\n有时候我们想要同时修改多个位置，即编辑一个文本的时候能够影响到多个位置。例如，我们新建一个`laTex`的`snippet`：\n\n``` html\n\\begin{${1:enumerate}}\n    $0\n\\end{$1}\n```\n\n在插入完成该`snippet`，`enumerate`会被选中，修改它会影响到`\\end`位置部分。\n\n*vscode*没有支持的格式没有做翻译，有兴趣的自己研究：）","slug":"TextMate snippet","published":1,"updated":"2018-07-01T10:30:46.493Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cdd001my4zvssh8s7jw","content":"<p>textMate一直是<code>mac</code>下常用的编辑器不过现在好像被<code>sublime</code>、<code>atom</code>、<code>vscode</code>等一系列新生带编辑器取代。为了学习<code>vscode</code>的编写，打算系统学学<code>snippet</code>语法。</p>\n<p>以下译自：</p>\n<blockquote>\n<p><a href=\"https://manual.macromates.com/en/snippets\" target=\"_blank\" rel=\"noopener\">https://manual.macromates.com/en/snippets</a></p>\n</blockquote>\n<p>snippet是一小段的文本，你可以插入到你的文档里面。它可以包含代码，变量，<code>tab</code>键，占位符，以及转换。</p>\n<h1 id=\"普通文本\"><a href=\"#普通文本\" class=\"headerlink\" title=\"普通文本\"></a>普通文本</h1><p>在最简单的情况下，你可以使用 snippet插入一些文本，避免一遍又一遍的重复输入。这样不仅减少输入次数，而且减少出错。  </p>\n<p>在你使用 snippet的时候唯一一件事情需要注意的是：<code>$</code>和`是保留字符，如果你想要使用这两个字符，你需要在字符前面加入一个转译符号：<code>\\</code>。</p>\n<h1 id=\"变量\"><a href=\"#变量\" class=\"headerlink\" title=\"变量\"></a>变量</h1><p>你可以通过在变量名称前面加入<code>$</code>的形式插入变量。所有的正常变量都被支持，最有用的大概是：<code>TM_SELECTED_TEXT</code>变量。例如我们想要创建一个 snippet,用于包装<code>LaTeX \\textbf</code>命令的选择，我们可以这样写：</p>\n<blockquote>\n<p>\\textbf{$TM_SELECTED_TEXT}</p>\n</blockquote>\n<p>如果没有文本被选中，变量不会被设置，也就不会插入任何文本。我们可以通过以下语法插入一个默认值： </p>\n<blockquote>\n<p>\\textbf{${TM_SELECTED_TEXT:no text was selected}}</p>\n</blockquote>\n<p>默认值也可以包含变量，或者<code>shell code</code>。如果默认文本必须包含<code>}</code>，则需要转译。</p>\n<h1 id=\"Tab键\"><a href=\"#Tab键\" class=\"headerlink\" title=\"Tab键\"></a><code>Tab</code>键</h1><p>在输入完成后，光标会停留在<code>snippet</code>最后的位置，又时候这不是我们要的结果。我们可以通过使用<code>$0</code>的形式指定光标停留的位置。例如，如果我们给<code>html</code>文件定义一个名为<code>div</code>的<code>snippet</code>，并且希望光标停留在开始和结束标签中间。我们可以这样写：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">    $0</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>我们还可以在$后面指定更多的数字，按下<code>tab</code>键的时候控制光标在这些位置移动。例如：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div$1</span>&gt;</span></span><br><span class=\"line\">    $0</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>第一次光标出现在$0位置，按下<code>tab</code>光标移动到$1位置。</p>\n<h1 id=\"占位符\"><a href=\"#占位符\" class=\"headerlink\" title=\"占位符\"></a>占位符</h1><p>和变量一样，<code>tab</code>也可以有占位符，语法类似：</p>\n<blockquote>\n<p>${«tab stop»:«default value»}</p>\n</blockquote>\n<p>默认值可以包含文本、<code>shell code</code>、以及其他占位符：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div$&#123;1:</span> <span class=\"attr\">id</span>=<span class=\"string\">\"$&#123;2:some_id&#125;\"</span>&#125;&gt;</span></span><br><span class=\"line\">    $0</span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>插入该<code>snippet</code>将会插入一个<code>div</code>标签，<code>id</code>参数被选中，我们可以直接编辑它或者按下<code>tab</code>键切换光标位置。当你编辑占位符文本，内嵌的<code>tab</code>停止位会被删除。</p>\n<h1 id=\"镜像\"><a href=\"#镜像\" class=\"headerlink\" title=\"镜像\"></a>镜像</h1><p>有时候我们想要同时修改多个位置，即编辑一个文本的时候能够影响到多个位置。例如，我们新建一个<code>laTex</code>的<code>snippet</code>：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">\\begin&#123;$&#123;1:enumerate&#125;&#125;</span><br><span class=\"line\">    $0</span><br><span class=\"line\">\\end&#123;$1&#125;</span><br></pre></td></tr></table></figure>\n<p>在插入完成该<code>snippet</code>，<code>enumerate</code>会被选中，修改它会影响到<code>\\end</code>位置部分。</p>\n<p><em>vscode</em>没有支持的格式没有做翻译，有兴趣的自己研究：）</p>\n","site":{"data":{}},"excerpt":"","more":"<p>textMate一直是<code>mac</code>下常用的编辑器不过现在好像被<code>sublime</code>、<code>atom</code>、<code>vscode</code>等一系列新生带编辑器取代。为了学习<code>vscode</code>的编写，打算系统学学<code>snippet</code>语法。</p>\n<p>以下译自：</p>\n<blockquote>\n<p><a href=\"https://manual.macromates.com/en/snippets\" target=\"_blank\" rel=\"noopener\">https://manual.macromates.com/en/snippets</a></p>\n</blockquote>\n<p>snippet是一小段的文本，你可以插入到你的文档里面。它可以包含代码，变量，<code>tab</code>键，占位符，以及转换。</p>\n<h1 id=\"普通文本\"><a href=\"#普通文本\" class=\"headerlink\" title=\"普通文本\"></a>普通文本</h1><p>在最简单的情况下，你可以使用 snippet插入一些文本，避免一遍又一遍的重复输入。这样不仅减少输入次数，而且减少出错。  </p>\n<p>在你使用 snippet的时候唯一一件事情需要注意的是：<code>$</code>和`是保留字符，如果你想要使用这两个字符，你需要在字符前面加入一个转译符号：<code>\\</code>。</p>\n<h1 id=\"变量\"><a href=\"#变量\" class=\"headerlink\" title=\"变量\"></a>变量</h1><p>你可以通过在变量名称前面加入<code>$</code>的形式插入变量。所有的正常变量都被支持，最有用的大概是：<code>TM_SELECTED_TEXT</code>变量。例如我们想要创建一个 snippet,用于包装<code>LaTeX \\textbf</code>命令的选择，我们可以这样写：</p>\n<blockquote>\n<p>\\textbf{$TM_SELECTED_TEXT}</p>\n</blockquote>\n<p>如果没有文本被选中，变量不会被设置，也就不会插入任何文本。我们可以通过以下语法插入一个默认值： </p>\n<blockquote>\n<p>\\textbf{${TM_SELECTED_TEXT:no text was selected}}</p>\n</blockquote>\n<p>默认值也可以包含变量，或者<code>shell code</code>。如果默认文本必须包含<code>}</code>，则需要转译。</p>\n<h1 id=\"Tab键\"><a href=\"#Tab键\" class=\"headerlink\" title=\"Tab键\"></a><code>Tab</code>键</h1><p>在输入完成后，光标会停留在<code>snippet</code>最后的位置，又时候这不是我们要的结果。我们可以通过使用<code>$0</code>的形式指定光标停留的位置。例如，如果我们给<code>html</code>文件定义一个名为<code>div</code>的<code>snippet</code>，并且希望光标停留在开始和结束标签中间。我们可以这样写：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">    $0</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>我们还可以在$后面指定更多的数字，按下<code>tab</code>键的时候控制光标在这些位置移动。例如：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div$1</span>&gt;</span></span><br><span class=\"line\">    $0</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>第一次光标出现在$0位置，按下<code>tab</code>光标移动到$1位置。</p>\n<h1 id=\"占位符\"><a href=\"#占位符\" class=\"headerlink\" title=\"占位符\"></a>占位符</h1><p>和变量一样，<code>tab</code>也可以有占位符，语法类似：</p>\n<blockquote>\n<p>${«tab stop»:«default value»}</p>\n</blockquote>\n<p>默认值可以包含文本、<code>shell code</code>、以及其他占位符：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div$&#123;1:</span> <span class=\"attr\">id</span>=<span class=\"string\">\"$&#123;2:some_id&#125;\"</span>&#125;&gt;</span></span><br><span class=\"line\">    $0</span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>插入该<code>snippet</code>将会插入一个<code>div</code>标签，<code>id</code>参数被选中，我们可以直接编辑它或者按下<code>tab</code>键切换光标位置。当你编辑占位符文本，内嵌的<code>tab</code>停止位会被删除。</p>\n<h1 id=\"镜像\"><a href=\"#镜像\" class=\"headerlink\" title=\"镜像\"></a>镜像</h1><p>有时候我们想要同时修改多个位置，即编辑一个文本的时候能够影响到多个位置。例如，我们新建一个<code>laTex</code>的<code>snippet</code>：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">\\begin&#123;$&#123;1:enumerate&#125;&#125;</span><br><span class=\"line\">    $0</span><br><span class=\"line\">\\end&#123;$1&#125;</span><br></pre></td></tr></table></figure>\n<p>在插入完成该<code>snippet</code>，<code>enumerate</code>会被选中，修改它会影响到<code>\\end</code>位置部分。</p>\n<p><em>vscode</em>没有支持的格式没有做翻译，有兴趣的自己研究：）</p>\n"},{"title":"MobX-依赖注入","date":"2019-02-24T11:41:15.000Z","_content":"\n### 定义\n\nMobX基于React的`Context`机制，提供了依赖注入的语法来实现跨组件层级的数据注入功能。这项功能在要往子组件传递数据，但是不知道具体有多少层级的时候，相当有用。\n\n`inject`用在目标组件上，设置依赖的`store`。`Provider`是一个`HOC`，用它包装现有的组件，为子组件传递数据。\n\n### 使用方式\n\n基本用法：\n\n```tsx\n\ntype UserStore = {\n  name: string,\n  age: number\n}\n\ninterface IMessageProps {\n  text: string\n  userStore?: UserStore\n}\n\ninterface ImessageInjectProps extends IMessageProps {\n  userStore: UserStore\n}\n\n@inject(\"userStore\")\nclass Message extends Component<IMessageProps> {\n  render() {\n    const { userStore } = this.props\n    return (\n      <div>\n        {userStore && userStore.name}:\n        <strong>{this.props.text}</strong>\n      </div>\n    )\n  }\n}\n\ninterface IMessageListProps {\n  messages: IMessageProps[]\n}\n\nclass MessageList extends Component<IMessageListProps> {\n  render() {\n    return (\n      this.props.messages.map(it =>\n      <Message\n        key={it.text}\n        text={it.text}\n      />)\n    )\n  }\n}\nclass App extends Component {\n  render() {\n    return (\n      <Provider userStore={{ name: \"linchen\", age: 30 }}>\n        <MessageList\n          messages={[{ text: \"hello\"}, { text: \"foo\"}, { text: \"bar\"}]}\n        />\n      </Provider>\n    )\n  }\n}\n\n```\n\n### ts类型安全的依赖注入\n\n`Message`组件依赖`userStore`，`userStore`从`App`组件注入。整个应用程序能够正常工作。但是这里存在一个问题：`Message`的父组件`MessageList`并不需要知道`userStore`的存在，所以在定义`Message`的`props`类型的时候，把`userStore`设置为可选的参数。这也导致了，`Message`组件在使用`userStore`的时候，需要判断是否为空的情况。尽管我们知道，这里的`userStore`是必须存在的参数。\n\n一种更好的方式：\n\n```tsx\n\ninterface ImessageInjectProps extends IMessageProps {\n  userStore: UserStore\n}\n\n@inject(\"userStore\")\nclass Message extends Component<IMessageProps> {\n  get InjectedProps() {\n    return this.props as ImessageInjectProps\n  }\n\n  render() {\n    const { userStore } = this.InjectedProps\n    return (\n      <div>\n        {userStore.name}:\n        <strong>{this.props.text}</strong>\n      </div>\n    )\n  }\n}\n\n```\n\n定义一个`ImessageInjectProps`类型，继承`IMessageProps`。在使用的时候强制转换为`ImessageInjectProps`类型。同时享受了`ts`强大的类型系统带来的便利性。\n\n\n### 参考文档：\n\n[How to get typesafe injection](https://github.com/mobxjs/mobx-react/issues/256)  \n[strongly-typing-injected-react-props](https://medium.com/@prashaantt/strongly-typing-injected-react-props-635a6828acaf)","source":"_posts/MobX-依赖注入.md","raw":"---\ntitle: MobX-依赖注入\ndate: 2019-02-24 19:41:15\ntags: mobx\ncategories: web\n---\n\n### 定义\n\nMobX基于React的`Context`机制，提供了依赖注入的语法来实现跨组件层级的数据注入功能。这项功能在要往子组件传递数据，但是不知道具体有多少层级的时候，相当有用。\n\n`inject`用在目标组件上，设置依赖的`store`。`Provider`是一个`HOC`，用它包装现有的组件，为子组件传递数据。\n\n### 使用方式\n\n基本用法：\n\n```tsx\n\ntype UserStore = {\n  name: string,\n  age: number\n}\n\ninterface IMessageProps {\n  text: string\n  userStore?: UserStore\n}\n\ninterface ImessageInjectProps extends IMessageProps {\n  userStore: UserStore\n}\n\n@inject(\"userStore\")\nclass Message extends Component<IMessageProps> {\n  render() {\n    const { userStore } = this.props\n    return (\n      <div>\n        {userStore && userStore.name}:\n        <strong>{this.props.text}</strong>\n      </div>\n    )\n  }\n}\n\ninterface IMessageListProps {\n  messages: IMessageProps[]\n}\n\nclass MessageList extends Component<IMessageListProps> {\n  render() {\n    return (\n      this.props.messages.map(it =>\n      <Message\n        key={it.text}\n        text={it.text}\n      />)\n    )\n  }\n}\nclass App extends Component {\n  render() {\n    return (\n      <Provider userStore={{ name: \"linchen\", age: 30 }}>\n        <MessageList\n          messages={[{ text: \"hello\"}, { text: \"foo\"}, { text: \"bar\"}]}\n        />\n      </Provider>\n    )\n  }\n}\n\n```\n\n### ts类型安全的依赖注入\n\n`Message`组件依赖`userStore`，`userStore`从`App`组件注入。整个应用程序能够正常工作。但是这里存在一个问题：`Message`的父组件`MessageList`并不需要知道`userStore`的存在，所以在定义`Message`的`props`类型的时候，把`userStore`设置为可选的参数。这也导致了，`Message`组件在使用`userStore`的时候，需要判断是否为空的情况。尽管我们知道，这里的`userStore`是必须存在的参数。\n\n一种更好的方式：\n\n```tsx\n\ninterface ImessageInjectProps extends IMessageProps {\n  userStore: UserStore\n}\n\n@inject(\"userStore\")\nclass Message extends Component<IMessageProps> {\n  get InjectedProps() {\n    return this.props as ImessageInjectProps\n  }\n\n  render() {\n    const { userStore } = this.InjectedProps\n    return (\n      <div>\n        {userStore.name}:\n        <strong>{this.props.text}</strong>\n      </div>\n    )\n  }\n}\n\n```\n\n定义一个`ImessageInjectProps`类型，继承`IMessageProps`。在使用的时候强制转换为`ImessageInjectProps`类型。同时享受了`ts`强大的类型系统带来的便利性。\n\n\n### 参考文档：\n\n[How to get typesafe injection](https://github.com/mobxjs/mobx-react/issues/256)  \n[strongly-typing-injected-react-props](https://medium.com/@prashaantt/strongly-typing-injected-react-props-635a6828acaf)","slug":"MobX-依赖注入","published":1,"updated":"2019-02-24T12:18:58.953Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cde001oy4zvb2v81n5j","content":"<h3 id=\"定义\"><a href=\"#定义\" class=\"headerlink\" title=\"定义\"></a>定义</h3><p>MobX基于React的<code>Context</code>机制，提供了依赖注入的语法来实现跨组件层级的数据注入功能。这项功能在要往子组件传递数据，但是不知道具体有多少层级的时候，相当有用。</p>\n<p><code>inject</code>用在目标组件上，设置依赖的<code>store</code>。<code>Provider</code>是一个<code>HOC</code>，用它包装现有的组件，为子组件传递数据。</p>\n<h3 id=\"使用方式\"><a href=\"#使用方式\" class=\"headerlink\" title=\"使用方式\"></a>使用方式</h3><p>基本用法：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">type UserStore = &#123;</span><br><span class=\"line\">  name: string,</span><br><span class=\"line\">  age: number</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">interface IMessageProps &#123;</span><br><span class=\"line\">  text: string</span><br><span class=\"line\">  userStore?: UserStore</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">interface ImessageInjectProps extends IMessageProps &#123;</span><br><span class=\"line\">  userStore: UserStore</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">@inject(&quot;userStore&quot;)</span><br><span class=\"line\">class Message extends Component&lt;IMessageProps&gt; &#123;</span><br><span class=\"line\">  render() &#123;</span><br><span class=\"line\">    const &#123; userStore &#125; = this.props</span><br><span class=\"line\">    return (</span><br><span class=\"line\">      &lt;div&gt;</span><br><span class=\"line\">        &#123;userStore &amp;&amp; userStore.name&#125;:</span><br><span class=\"line\">        &lt;strong&gt;&#123;this.props.text&#125;&lt;/strong&gt;</span><br><span class=\"line\">      &lt;/div&gt;</span><br><span class=\"line\">    )</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">interface IMessageListProps &#123;</span><br><span class=\"line\">  messages: IMessageProps[]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">class MessageList extends Component&lt;IMessageListProps&gt; &#123;</span><br><span class=\"line\">  render() &#123;</span><br><span class=\"line\">    return (</span><br><span class=\"line\">      this.props.messages.map(it =&gt;</span><br><span class=\"line\">      &lt;Message</span><br><span class=\"line\">        key=&#123;it.text&#125;</span><br><span class=\"line\">        text=&#123;it.text&#125;</span><br><span class=\"line\">      /&gt;)</span><br><span class=\"line\">    )</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">class App extends Component &#123;</span><br><span class=\"line\">  render() &#123;</span><br><span class=\"line\">    return (</span><br><span class=\"line\">      &lt;Provider userStore=&#123;&#123; name: &quot;linchen&quot;, age: 30 &#125;&#125;&gt;</span><br><span class=\"line\">        &lt;MessageList</span><br><span class=\"line\">          messages=&#123;[&#123; text: &quot;hello&quot;&#125;, &#123; text: &quot;foo&quot;&#125;, &#123; text: &quot;bar&quot;&#125;]&#125;</span><br><span class=\"line\">        /&gt;</span><br><span class=\"line\">      &lt;/Provider&gt;</span><br><span class=\"line\">    )</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"ts类型安全的依赖注入\"><a href=\"#ts类型安全的依赖注入\" class=\"headerlink\" title=\"ts类型安全的依赖注入\"></a>ts类型安全的依赖注入</h3><p><code>Message</code>组件依赖<code>userStore</code>，<code>userStore</code>从<code>App</code>组件注入。整个应用程序能够正常工作。但是这里存在一个问题：<code>Message</code>的父组件<code>MessageList</code>并不需要知道<code>userStore</code>的存在，所以在定义<code>Message</code>的<code>props</code>类型的时候，把<code>userStore</code>设置为可选的参数。这也导致了，<code>Message</code>组件在使用<code>userStore</code>的时候，需要判断是否为空的情况。尽管我们知道，这里的<code>userStore</code>是必须存在的参数。</p>\n<p>一种更好的方式：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">interface ImessageInjectProps extends IMessageProps &#123;</span><br><span class=\"line\">  userStore: UserStore</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">@inject(&quot;userStore&quot;)</span><br><span class=\"line\">class Message extends Component&lt;IMessageProps&gt; &#123;</span><br><span class=\"line\">  get InjectedProps() &#123;</span><br><span class=\"line\">    return this.props as ImessageInjectProps</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  render() &#123;</span><br><span class=\"line\">    const &#123; userStore &#125; = this.InjectedProps</span><br><span class=\"line\">    return (</span><br><span class=\"line\">      &lt;div&gt;</span><br><span class=\"line\">        &#123;userStore.name&#125;:</span><br><span class=\"line\">        &lt;strong&gt;&#123;this.props.text&#125;&lt;/strong&gt;</span><br><span class=\"line\">      &lt;/div&gt;</span><br><span class=\"line\">    )</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>定义一个<code>ImessageInjectProps</code>类型，继承<code>IMessageProps</code>。在使用的时候强制转换为<code>ImessageInjectProps</code>类型。同时享受了<code>ts</code>强大的类型系统带来的便利性。</p>\n<h3 id=\"参考文档：\"><a href=\"#参考文档：\" class=\"headerlink\" title=\"参考文档：\"></a>参考文档：</h3><p><a href=\"https://github.com/mobxjs/mobx-react/issues/256\" target=\"_blank\" rel=\"noopener\">How to get typesafe injection</a><br><a href=\"https://medium.com/@prashaantt/strongly-typing-injected-react-props-635a6828acaf\" target=\"_blank\" rel=\"noopener\">strongly-typing-injected-react-props</a></p>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"定义\"><a href=\"#定义\" class=\"headerlink\" title=\"定义\"></a>定义</h3><p>MobX基于React的<code>Context</code>机制，提供了依赖注入的语法来实现跨组件层级的数据注入功能。这项功能在要往子组件传递数据，但是不知道具体有多少层级的时候，相当有用。</p>\n<p><code>inject</code>用在目标组件上，设置依赖的<code>store</code>。<code>Provider</code>是一个<code>HOC</code>，用它包装现有的组件，为子组件传递数据。</p>\n<h3 id=\"使用方式\"><a href=\"#使用方式\" class=\"headerlink\" title=\"使用方式\"></a>使用方式</h3><p>基本用法：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">type UserStore = &#123;</span><br><span class=\"line\">  name: string,</span><br><span class=\"line\">  age: number</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">interface IMessageProps &#123;</span><br><span class=\"line\">  text: string</span><br><span class=\"line\">  userStore?: UserStore</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">interface ImessageInjectProps extends IMessageProps &#123;</span><br><span class=\"line\">  userStore: UserStore</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">@inject(&quot;userStore&quot;)</span><br><span class=\"line\">class Message extends Component&lt;IMessageProps&gt; &#123;</span><br><span class=\"line\">  render() &#123;</span><br><span class=\"line\">    const &#123; userStore &#125; = this.props</span><br><span class=\"line\">    return (</span><br><span class=\"line\">      &lt;div&gt;</span><br><span class=\"line\">        &#123;userStore &amp;&amp; userStore.name&#125;:</span><br><span class=\"line\">        &lt;strong&gt;&#123;this.props.text&#125;&lt;/strong&gt;</span><br><span class=\"line\">      &lt;/div&gt;</span><br><span class=\"line\">    )</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">interface IMessageListProps &#123;</span><br><span class=\"line\">  messages: IMessageProps[]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">class MessageList extends Component&lt;IMessageListProps&gt; &#123;</span><br><span class=\"line\">  render() &#123;</span><br><span class=\"line\">    return (</span><br><span class=\"line\">      this.props.messages.map(it =&gt;</span><br><span class=\"line\">      &lt;Message</span><br><span class=\"line\">        key=&#123;it.text&#125;</span><br><span class=\"line\">        text=&#123;it.text&#125;</span><br><span class=\"line\">      /&gt;)</span><br><span class=\"line\">    )</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">class App extends Component &#123;</span><br><span class=\"line\">  render() &#123;</span><br><span class=\"line\">    return (</span><br><span class=\"line\">      &lt;Provider userStore=&#123;&#123; name: &quot;linchen&quot;, age: 30 &#125;&#125;&gt;</span><br><span class=\"line\">        &lt;MessageList</span><br><span class=\"line\">          messages=&#123;[&#123; text: &quot;hello&quot;&#125;, &#123; text: &quot;foo&quot;&#125;, &#123; text: &quot;bar&quot;&#125;]&#125;</span><br><span class=\"line\">        /&gt;</span><br><span class=\"line\">      &lt;/Provider&gt;</span><br><span class=\"line\">    )</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"ts类型安全的依赖注入\"><a href=\"#ts类型安全的依赖注入\" class=\"headerlink\" title=\"ts类型安全的依赖注入\"></a>ts类型安全的依赖注入</h3><p><code>Message</code>组件依赖<code>userStore</code>，<code>userStore</code>从<code>App</code>组件注入。整个应用程序能够正常工作。但是这里存在一个问题：<code>Message</code>的父组件<code>MessageList</code>并不需要知道<code>userStore</code>的存在，所以在定义<code>Message</code>的<code>props</code>类型的时候，把<code>userStore</code>设置为可选的参数。这也导致了，<code>Message</code>组件在使用<code>userStore</code>的时候，需要判断是否为空的情况。尽管我们知道，这里的<code>userStore</code>是必须存在的参数。</p>\n<p>一种更好的方式：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">interface ImessageInjectProps extends IMessageProps &#123;</span><br><span class=\"line\">  userStore: UserStore</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">@inject(&quot;userStore&quot;)</span><br><span class=\"line\">class Message extends Component&lt;IMessageProps&gt; &#123;</span><br><span class=\"line\">  get InjectedProps() &#123;</span><br><span class=\"line\">    return this.props as ImessageInjectProps</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  render() &#123;</span><br><span class=\"line\">    const &#123; userStore &#125; = this.InjectedProps</span><br><span class=\"line\">    return (</span><br><span class=\"line\">      &lt;div&gt;</span><br><span class=\"line\">        &#123;userStore.name&#125;:</span><br><span class=\"line\">        &lt;strong&gt;&#123;this.props.text&#125;&lt;/strong&gt;</span><br><span class=\"line\">      &lt;/div&gt;</span><br><span class=\"line\">    )</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>定义一个<code>ImessageInjectProps</code>类型，继承<code>IMessageProps</code>。在使用的时候强制转换为<code>ImessageInjectProps</code>类型。同时享受了<code>ts</code>强大的类型系统带来的便利性。</p>\n<h3 id=\"参考文档：\"><a href=\"#参考文档：\" class=\"headerlink\" title=\"参考文档：\"></a>参考文档：</h3><p><a href=\"https://github.com/mobxjs/mobx-react/issues/256\" target=\"_blank\" rel=\"noopener\">How to get typesafe injection</a><br><a href=\"https://medium.com/@prashaantt/strongly-typing-injected-react-props-635a6828acaf\" target=\"_blank\" rel=\"noopener\">strongly-typing-injected-react-props</a></p>\n"},{"title":"Session-&-Cookie","date":"2015-09-07T01:37:03.000Z","_content":"### Session\n\n&nbsp;&nbsp;&nbsp;&nbsp;web网站基于`HTTP`协议来做业务交互，`HTTP`协议本身是一个无状态的协议，但实际情况是日常很多业务逻辑都需要记录用户的行为信息。举个例子：\n\n> 一个购物网站，顾客会在商品浏览页面选取需要的各类商品，放置到虚拟的购物车内。下单的时候需要跳转到结算页面，在这一串连续的用户行为中，至关重要的一点是记录当前的购物车信息，而session机制可以恰当的处理此类问题。\n\n&nbsp;&nbsp;&nbsp;&nbsp;网站通常会在用户第一次登录的时候生成一个`Session ID`, `Session ID`不同于用户ID, 用户ID始终唯一，但是同一个用户每次登录获取的`Session ID`可能不一致。`Session ID`由服务器端生成，通过`HTTP`协议头返回给客户端，这样可以极大的降低可能导致的安全问题(其他劫持暂且不说)。因为浏览器拿到的只是一个`token`，而与此相关的数据存储都在服务器端完成。服务端在设置`session ID`的同时会指定改`session id`的过期时间，以及该`session id`试用的请求路径(path)。了解了`session`的大致原理，下面结合代码来了解大致的使用过程。\n\n#### 从cookie说起\n\n上述使用案例得益于`cookie`这一伟大发明，一般来说cookie的处理分为如下几个步骤：\n+ 1. 用户打开网页\n+ 2. 服务端生成cookie数据返回给浏览器\n+ 3. 浏览器将cookie保存\n+ 4. 之后每次加载该页面，浏览器都把cookie数据发送给服务器\n\n\n#### cookies的基本数据格式\n标准的 `HTTP`协议有一个字段`Set-Cookie`用于标示cookie数据。服务器通过该字段告知客户端cookie数据。设置`cookie`数据的同时支持给该数据指定一些配置信息：\n- Path: 表示该cookie数据影响到的路径，当前访问的url不满足该匹配时，不发送该cookie数据。\n- Expires: 该`cookies`数据的过期时间(具体的时间点)，如果不设置该选项，在浏览器关闭时该`cookie`丢失。该字段是一个UTC格式的字符串。\n- Max-Age: 告知浏览器`cookie`多久之后过期，可以解决客户端与服务器时间不一致导致过期时间不准确的问题, 在express里时间单位是毫秒。\n- HttpOnly: 告知浏览器该`cookie`不允许通过浏览器API的形式去修改，比如说通过`document.cookie`修改。在`document.cookie`不可见。\n- Secure: 当设置该值为`true`时，`cookie`数据在`HTTP`协议下无效，只有在`HTTPS`协议下才有效。\n- domain: `domain`属性指定了该`cookie`所属的域名(`Domain`), 比如说设置`domain=example.com`,那么浏览器在给`www.example.com`, `www.abc.example.com`发送`HTTP`请求时都会带上该`cookie`。如果服务器没有设置该属性那么浏览器默认该`cookie`从属于`www.example.com`域名。说到这里，一定会想，要是我把domain设置为其他网站,这样我是不是可以轻易更改其他网站的`cookie`数据了？浏览器有个策略，允许`foo.example.com`的服务器设置`domain`为`example.com`或者`foo.example.com`。但是不允许设置`domain`为`bar.example.com` ETC。同时考虑到安全方面的因素，浏览器拒绝只给`domain`设置公共(public suffixes)，比如说设置为`com`, `co.uk`是不被允许的。\n\n---\n\n**Set-Cookie格式定义**\n>\n*Set-Cookie: name=value; Path:/; Domin=.domin.com;Secure=true*\n\n第一部分表示设置的`cookie`键/值，后面跟着几个配置参数。\n\n\n###Cookie 解析\n`Express/Connect`有一个`cookieParser`中间件专门负责`cookieParser`的解析。其实现原理如下：\n``` javascript\n\n\nfunction parserCookie(cookie, options) {\n   var obj = {};\n   var pairs = cookies.split(/; /);\n   var decode = opt.decode || decodeURIComponent;\n   \n   pairs.forEach(function(pair) {\n      var eq_idx = pair.indexOf('=');\n      var key = pair.substr(0, eq_idx).trim();\n      var val = pair.substr(eq_idx, pair.length).trim();\n       try {\n           obj[key] = decode(val);\n        }\n        catch(err) {\n           obj[key] = val;\n        }\n   });\n   \n   return obj;\n}\n\nfunction parseSignCookie(cookies, secret) {\n  var keys = Object.keys(cookies);\n  var dec = null;\n  var ret = Object.create(null);\n  var val = null\n\n  for(var i = 0; i < keys.length; i++) {\n     var k = keys[i];\n     var v = cookies[k];\n     dec = unsign(v, secret);\n    ret[k] = dec;\n  }\n  return ret;\n}\n\nfunction parseJSONCookie(cookie) {\n   var keys = Object.keys(cookie);\n   var key;\n   var val;\n\n   for(var i = 0; i < cookie.length; i++) {\n      val = cookie[i];\n      key = keys[i];\n      obj[key] = JSON.parse(val);\n   }\n}\n\n\nvar cookieParser = function(secret, opts) {\nfunction(req, res, next) {\n    if(req.cookies) return;\n    \n    var cookies = req.headers.cookies;\n    req.cookies = {};\n    req.signCookies = {};\n\n   //把name=value格式的字符串解析为一个json对象\n    req.cookies = parserCookie(cookies, options);\n\n    if(secret) {\n      //解析加密过的cookie字段\n      req.signCookies = parseSignCookie(req.cookies, secret);\n      //解析stringify过的JSON对象\n      req.signCookies = parseJSONCookie(req.signCookies);\n    }\n    \n    req.cookies = parseJSONCookies(req.cookies);\n}\n}\n```\n\n> Express 给不一样的cookie字段值打上不一样的标签，如`j: `表示该值是一个JSON对象stringify后的值，`s: `表示该字段是经过加密的。默认把加密与未加密的字段分别放在`req.signCookies`, `req.cookies`。\n\n---\n\n### 设置 Cookie \n\n`Express`提供了一个`res.cookie`接口来设置`Cookie`数据。来看看`Express`的处理代码：\n\n``` javascript\n\nres.cookie = function (name, value, options) {\n  var opts = merge({}, options);\n  var secret = this.req.secret;\n  var signed = opts.signed;\n\n  if (signed && !secret) {\n    throw new Error('cookieParser(\"secret\") required for signed cookies');\n  }\n\n  var val = typeof value === 'object'\n    ? 'j:' + JSON.stringify(value)\n    : String(value);\n\n  if (signed) {\n    val = 's:' + sign(val, secret);\n  }\n\n  if ('maxAge' in opts) {\n    opts.expires = new Date(Date.now() + opts.maxAge);\n    opts.maxAge /= 1000;\n  }\n\n  if (opts.path == null) {\n    opts.path = '/';\n  }\n\n  this.append('Set-Cookie', cookie.serialize(name, String(val), opts));\n\n  return this;\n};\n\n//序列化cookie以及配置信息\nfunction serialize(name, val, options) {  \n  var enc = opt.encode || encode;  \n  var pairs = [name + '=' + enc(val)];  \n  if (null != opt.maxAge) {    \n    var maxAge = opt.maxAge - 0;    \n    if (isNaN(maxAge)) \n      throw new Error('maxAge should be a Number');    \n    pairs.push('Max-Age=' + maxAge);  \n  }  \n  if (opt.domain) pairs.push('Domain=' + opt.domain);  \n  if (opt.path) pairs.push('Path=' + opt.path);  \n  if (opt.expires) pairs.push('Expires=' + opt.expires.toUTCString());  \n  if (opt.httpOnly) pairs.push('HttpOnly');  \n  if (opt.secure) pairs.push('Secure');  return pairs.join('; ');\n}\n\n//设置到HTTP应答协议头\nres.append = function append(field, val) {\n  var prev = this.get(field);\n  var value = val;\n\n  if (prev) {\n    // concat the new and prev vals\n    value = Array.isArray(prev) ? prev.concat(val)\n      : Array.isArray(val) ? [prev].concat(val)\n      : [prev, val];\n  }\n\n  return this.set(field, value);\n};\n\n```\n\n---\n","source":"_posts/Session-&-Cookie.md","raw":"---\ntitle: Session-&-Cookie\ncategories: server\ndate: 2015-09-07 09:37:03\n---\n### Session\n\n&nbsp;&nbsp;&nbsp;&nbsp;web网站基于`HTTP`协议来做业务交互，`HTTP`协议本身是一个无状态的协议，但实际情况是日常很多业务逻辑都需要记录用户的行为信息。举个例子：\n\n> 一个购物网站，顾客会在商品浏览页面选取需要的各类商品，放置到虚拟的购物车内。下单的时候需要跳转到结算页面，在这一串连续的用户行为中，至关重要的一点是记录当前的购物车信息，而session机制可以恰当的处理此类问题。\n\n&nbsp;&nbsp;&nbsp;&nbsp;网站通常会在用户第一次登录的时候生成一个`Session ID`, `Session ID`不同于用户ID, 用户ID始终唯一，但是同一个用户每次登录获取的`Session ID`可能不一致。`Session ID`由服务器端生成，通过`HTTP`协议头返回给客户端，这样可以极大的降低可能导致的安全问题(其他劫持暂且不说)。因为浏览器拿到的只是一个`token`，而与此相关的数据存储都在服务器端完成。服务端在设置`session ID`的同时会指定改`session id`的过期时间，以及该`session id`试用的请求路径(path)。了解了`session`的大致原理，下面结合代码来了解大致的使用过程。\n\n#### 从cookie说起\n\n上述使用案例得益于`cookie`这一伟大发明，一般来说cookie的处理分为如下几个步骤：\n+ 1. 用户打开网页\n+ 2. 服务端生成cookie数据返回给浏览器\n+ 3. 浏览器将cookie保存\n+ 4. 之后每次加载该页面，浏览器都把cookie数据发送给服务器\n\n\n#### cookies的基本数据格式\n标准的 `HTTP`协议有一个字段`Set-Cookie`用于标示cookie数据。服务器通过该字段告知客户端cookie数据。设置`cookie`数据的同时支持给该数据指定一些配置信息：\n- Path: 表示该cookie数据影响到的路径，当前访问的url不满足该匹配时，不发送该cookie数据。\n- Expires: 该`cookies`数据的过期时间(具体的时间点)，如果不设置该选项，在浏览器关闭时该`cookie`丢失。该字段是一个UTC格式的字符串。\n- Max-Age: 告知浏览器`cookie`多久之后过期，可以解决客户端与服务器时间不一致导致过期时间不准确的问题, 在express里时间单位是毫秒。\n- HttpOnly: 告知浏览器该`cookie`不允许通过浏览器API的形式去修改，比如说通过`document.cookie`修改。在`document.cookie`不可见。\n- Secure: 当设置该值为`true`时，`cookie`数据在`HTTP`协议下无效，只有在`HTTPS`协议下才有效。\n- domain: `domain`属性指定了该`cookie`所属的域名(`Domain`), 比如说设置`domain=example.com`,那么浏览器在给`www.example.com`, `www.abc.example.com`发送`HTTP`请求时都会带上该`cookie`。如果服务器没有设置该属性那么浏览器默认该`cookie`从属于`www.example.com`域名。说到这里，一定会想，要是我把domain设置为其他网站,这样我是不是可以轻易更改其他网站的`cookie`数据了？浏览器有个策略，允许`foo.example.com`的服务器设置`domain`为`example.com`或者`foo.example.com`。但是不允许设置`domain`为`bar.example.com` ETC。同时考虑到安全方面的因素，浏览器拒绝只给`domain`设置公共(public suffixes)，比如说设置为`com`, `co.uk`是不被允许的。\n\n---\n\n**Set-Cookie格式定义**\n>\n*Set-Cookie: name=value; Path:/; Domin=.domin.com;Secure=true*\n\n第一部分表示设置的`cookie`键/值，后面跟着几个配置参数。\n\n\n###Cookie 解析\n`Express/Connect`有一个`cookieParser`中间件专门负责`cookieParser`的解析。其实现原理如下：\n``` javascript\n\n\nfunction parserCookie(cookie, options) {\n   var obj = {};\n   var pairs = cookies.split(/; /);\n   var decode = opt.decode || decodeURIComponent;\n   \n   pairs.forEach(function(pair) {\n      var eq_idx = pair.indexOf('=');\n      var key = pair.substr(0, eq_idx).trim();\n      var val = pair.substr(eq_idx, pair.length).trim();\n       try {\n           obj[key] = decode(val);\n        }\n        catch(err) {\n           obj[key] = val;\n        }\n   });\n   \n   return obj;\n}\n\nfunction parseSignCookie(cookies, secret) {\n  var keys = Object.keys(cookies);\n  var dec = null;\n  var ret = Object.create(null);\n  var val = null\n\n  for(var i = 0; i < keys.length; i++) {\n     var k = keys[i];\n     var v = cookies[k];\n     dec = unsign(v, secret);\n    ret[k] = dec;\n  }\n  return ret;\n}\n\nfunction parseJSONCookie(cookie) {\n   var keys = Object.keys(cookie);\n   var key;\n   var val;\n\n   for(var i = 0; i < cookie.length; i++) {\n      val = cookie[i];\n      key = keys[i];\n      obj[key] = JSON.parse(val);\n   }\n}\n\n\nvar cookieParser = function(secret, opts) {\nfunction(req, res, next) {\n    if(req.cookies) return;\n    \n    var cookies = req.headers.cookies;\n    req.cookies = {};\n    req.signCookies = {};\n\n   //把name=value格式的字符串解析为一个json对象\n    req.cookies = parserCookie(cookies, options);\n\n    if(secret) {\n      //解析加密过的cookie字段\n      req.signCookies = parseSignCookie(req.cookies, secret);\n      //解析stringify过的JSON对象\n      req.signCookies = parseJSONCookie(req.signCookies);\n    }\n    \n    req.cookies = parseJSONCookies(req.cookies);\n}\n}\n```\n\n> Express 给不一样的cookie字段值打上不一样的标签，如`j: `表示该值是一个JSON对象stringify后的值，`s: `表示该字段是经过加密的。默认把加密与未加密的字段分别放在`req.signCookies`, `req.cookies`。\n\n---\n\n### 设置 Cookie \n\n`Express`提供了一个`res.cookie`接口来设置`Cookie`数据。来看看`Express`的处理代码：\n\n``` javascript\n\nres.cookie = function (name, value, options) {\n  var opts = merge({}, options);\n  var secret = this.req.secret;\n  var signed = opts.signed;\n\n  if (signed && !secret) {\n    throw new Error('cookieParser(\"secret\") required for signed cookies');\n  }\n\n  var val = typeof value === 'object'\n    ? 'j:' + JSON.stringify(value)\n    : String(value);\n\n  if (signed) {\n    val = 's:' + sign(val, secret);\n  }\n\n  if ('maxAge' in opts) {\n    opts.expires = new Date(Date.now() + opts.maxAge);\n    opts.maxAge /= 1000;\n  }\n\n  if (opts.path == null) {\n    opts.path = '/';\n  }\n\n  this.append('Set-Cookie', cookie.serialize(name, String(val), opts));\n\n  return this;\n};\n\n//序列化cookie以及配置信息\nfunction serialize(name, val, options) {  \n  var enc = opt.encode || encode;  \n  var pairs = [name + '=' + enc(val)];  \n  if (null != opt.maxAge) {    \n    var maxAge = opt.maxAge - 0;    \n    if (isNaN(maxAge)) \n      throw new Error('maxAge should be a Number');    \n    pairs.push('Max-Age=' + maxAge);  \n  }  \n  if (opt.domain) pairs.push('Domain=' + opt.domain);  \n  if (opt.path) pairs.push('Path=' + opt.path);  \n  if (opt.expires) pairs.push('Expires=' + opt.expires.toUTCString());  \n  if (opt.httpOnly) pairs.push('HttpOnly');  \n  if (opt.secure) pairs.push('Secure');  return pairs.join('; ');\n}\n\n//设置到HTTP应答协议头\nres.append = function append(field, val) {\n  var prev = this.get(field);\n  var value = val;\n\n  if (prev) {\n    // concat the new and prev vals\n    value = Array.isArray(prev) ? prev.concat(val)\n      : Array.isArray(val) ? [prev].concat(val)\n      : [prev, val];\n  }\n\n  return this.set(field, value);\n};\n\n```\n\n---\n","slug":"Session-&-Cookie","published":1,"updated":"2018-07-01T10:30:46.493Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cdf001sy4zv9t2utis3","content":"<h3 id=\"Session\"><a href=\"#Session\" class=\"headerlink\" title=\"Session\"></a>Session</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;web网站基于<code>HTTP</code>协议来做业务交互，<code>HTTP</code>协议本身是一个无状态的协议，但实际情况是日常很多业务逻辑都需要记录用户的行为信息。举个例子：</p>\n<blockquote>\n<p>一个购物网站，顾客会在商品浏览页面选取需要的各类商品，放置到虚拟的购物车内。下单的时候需要跳转到结算页面，在这一串连续的用户行为中，至关重要的一点是记录当前的购物车信息，而session机制可以恰当的处理此类问题。</p>\n</blockquote>\n<p>&nbsp;&nbsp;&nbsp;&nbsp;网站通常会在用户第一次登录的时候生成一个<code>Session ID</code>, <code>Session ID</code>不同于用户ID, 用户ID始终唯一，但是同一个用户每次登录获取的<code>Session ID</code>可能不一致。<code>Session ID</code>由服务器端生成，通过<code>HTTP</code>协议头返回给客户端，这样可以极大的降低可能导致的安全问题(其他劫持暂且不说)。因为浏览器拿到的只是一个<code>token</code>，而与此相关的数据存储都在服务器端完成。服务端在设置<code>session ID</code>的同时会指定改<code>session id</code>的过期时间，以及该<code>session id</code>试用的请求路径(path)。了解了<code>session</code>的大致原理，下面结合代码来了解大致的使用过程。</p>\n<h4 id=\"从cookie说起\"><a href=\"#从cookie说起\" class=\"headerlink\" title=\"从cookie说起\"></a>从cookie说起</h4><p>上述使用案例得益于<code>cookie</code>这一伟大发明，一般来说cookie的处理分为如下几个步骤：</p>\n<ul>\n<li><ol>\n<li>用户打开网页</li>\n</ol>\n</li>\n<li><ol start=\"2\">\n<li>服务端生成cookie数据返回给浏览器</li>\n</ol>\n</li>\n<li><ol start=\"3\">\n<li>浏览器将cookie保存</li>\n</ol>\n</li>\n<li><ol start=\"4\">\n<li>之后每次加载该页面，浏览器都把cookie数据发送给服务器</li>\n</ol>\n</li>\n</ul>\n<h4 id=\"cookies的基本数据格式\"><a href=\"#cookies的基本数据格式\" class=\"headerlink\" title=\"cookies的基本数据格式\"></a>cookies的基本数据格式</h4><p>标准的 <code>HTTP</code>协议有一个字段<code>Set-Cookie</code>用于标示cookie数据。服务器通过该字段告知客户端cookie数据。设置<code>cookie</code>数据的同时支持给该数据指定一些配置信息：</p>\n<ul>\n<li>Path: 表示该cookie数据影响到的路径，当前访问的url不满足该匹配时，不发送该cookie数据。</li>\n<li>Expires: 该<code>cookies</code>数据的过期时间(具体的时间点)，如果不设置该选项，在浏览器关闭时该<code>cookie</code>丢失。该字段是一个UTC格式的字符串。</li>\n<li>Max-Age: 告知浏览器<code>cookie</code>多久之后过期，可以解决客户端与服务器时间不一致导致过期时间不准确的问题, 在express里时间单位是毫秒。</li>\n<li>HttpOnly: 告知浏览器该<code>cookie</code>不允许通过浏览器API的形式去修改，比如说通过<code>document.cookie</code>修改。在<code>document.cookie</code>不可见。</li>\n<li>Secure: 当设置该值为<code>true</code>时，<code>cookie</code>数据在<code>HTTP</code>协议下无效，只有在<code>HTTPS</code>协议下才有效。</li>\n<li>domain: <code>domain</code>属性指定了该<code>cookie</code>所属的域名(<code>Domain</code>), 比如说设置<code>domain=example.com</code>,那么浏览器在给<code>www.example.com</code>, <code>www.abc.example.com</code>发送<code>HTTP</code>请求时都会带上该<code>cookie</code>。如果服务器没有设置该属性那么浏览器默认该<code>cookie</code>从属于<code>www.example.com</code>域名。说到这里，一定会想，要是我把domain设置为其他网站,这样我是不是可以轻易更改其他网站的<code>cookie</code>数据了？浏览器有个策略，允许<code>foo.example.com</code>的服务器设置<code>domain</code>为<code>example.com</code>或者<code>foo.example.com</code>。但是不允许设置<code>domain</code>为<code>bar.example.com</code> ETC。同时考虑到安全方面的因素，浏览器拒绝只给<code>domain</code>设置公共(public suffixes)，比如说设置为<code>com</code>, <code>co.uk</code>是不被允许的。</li>\n</ul>\n<hr>\n<p><strong>Set-Cookie格式定义</strong></p>\n<blockquote>\n</blockquote>\n<p><em>Set-Cookie: name=value; Path:/; Domin=.domin.com;Secure=true</em></p>\n<p>第一部分表示设置的<code>cookie</code>键/值，后面跟着几个配置参数。</p>\n<p>###Cookie 解析<br><code>Express/Connect</code>有一个<code>cookieParser</code>中间件专门负责<code>cookieParser</code>的解析。其实现原理如下：<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">parserCookie</span>(<span class=\"params\">cookie, options</span>) </span>&#123;</span><br><span class=\"line\">   <span class=\"keyword\">var</span> obj = &#123;&#125;;</span><br><span class=\"line\">   <span class=\"keyword\">var</span> pairs = cookies.split(<span class=\"regexp\">/; /</span>);</span><br><span class=\"line\">   <span class=\"keyword\">var</span> decode = opt.decode || <span class=\"built_in\">decodeURIComponent</span>;</span><br><span class=\"line\">   </span><br><span class=\"line\">   pairs.forEach(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">pair</span>) </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">var</span> eq_idx = pair.indexOf(<span class=\"string\">'='</span>);</span><br><span class=\"line\">      <span class=\"keyword\">var</span> key = pair.substr(<span class=\"number\">0</span>, eq_idx).trim();</span><br><span class=\"line\">      <span class=\"keyword\">var</span> val = pair.substr(eq_idx, pair.length).trim();</span><br><span class=\"line\">       <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">           obj[key] = decode(val);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">catch</span>(err) &#123;</span><br><span class=\"line\">           obj[key] = val;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">   &#125;);</span><br><span class=\"line\">   </span><br><span class=\"line\">   <span class=\"keyword\">return</span> obj;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">parseSignCookie</span>(<span class=\"params\">cookies, secret</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> keys = <span class=\"built_in\">Object</span>.keys(cookies);</span><br><span class=\"line\">  <span class=\"keyword\">var</span> dec = <span class=\"literal\">null</span>;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> ret = <span class=\"built_in\">Object</span>.create(<span class=\"literal\">null</span>);</span><br><span class=\"line\">  <span class=\"keyword\">var</span> val = <span class=\"literal\">null</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">for</span>(<span class=\"keyword\">var</span> i = <span class=\"number\">0</span>; i &lt; keys.length; i++) &#123;</span><br><span class=\"line\">     <span class=\"keyword\">var</span> k = keys[i];</span><br><span class=\"line\">     <span class=\"keyword\">var</span> v = cookies[k];</span><br><span class=\"line\">     dec = unsign(v, secret);</span><br><span class=\"line\">    ret[k] = dec;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> ret;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">parseJSONCookie</span>(<span class=\"params\">cookie</span>) </span>&#123;</span><br><span class=\"line\">   <span class=\"keyword\">var</span> keys = <span class=\"built_in\">Object</span>.keys(cookie);</span><br><span class=\"line\">   <span class=\"keyword\">var</span> key;</span><br><span class=\"line\">   <span class=\"keyword\">var</span> val;</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"keyword\">for</span>(<span class=\"keyword\">var</span> i = <span class=\"number\">0</span>; i &lt; cookie.length; i++) &#123;</span><br><span class=\"line\">      val = cookie[i];</span><br><span class=\"line\">      key = keys[i];</span><br><span class=\"line\">      obj[key] = <span class=\"built_in\">JSON</span>.parse(val);</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> cookieParser = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">secret, opts</span>) </span>&#123;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">req, res, next</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(req.cookies) <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">var</span> cookies = req.headers.cookies;</span><br><span class=\"line\">    req.cookies = &#123;&#125;;</span><br><span class=\"line\">    req.signCookies = &#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"comment\">//把name=value格式的字符串解析为一个json对象</span></span><br><span class=\"line\">    req.cookies = parserCookie(cookies, options);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(secret) &#123;</span><br><span class=\"line\">      <span class=\"comment\">//解析加密过的cookie字段</span></span><br><span class=\"line\">      req.signCookies = parseSignCookie(req.cookies, secret);</span><br><span class=\"line\">      <span class=\"comment\">//解析stringify过的JSON对象</span></span><br><span class=\"line\">      req.signCookies = parseJSONCookie(req.signCookies);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    req.cookies = parseJSONCookies(req.cookies);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>Express 给不一样的cookie字段值打上不一样的标签，如<code>j:</code>表示该值是一个JSON对象stringify后的值，<code>s:</code>表示该字段是经过加密的。默认把加密与未加密的字段分别放在<code>req.signCookies</code>, <code>req.cookies</code>。</p>\n</blockquote>\n<hr>\n<h3 id=\"设置-Cookie\"><a href=\"#设置-Cookie\" class=\"headerlink\" title=\"设置 Cookie\"></a>设置 Cookie</h3><p><code>Express</code>提供了一个<code>res.cookie</code>接口来设置<code>Cookie</code>数据。来看看<code>Express</code>的处理代码：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">res.cookie = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">name, value, options</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> opts = merge(&#123;&#125;, options);</span><br><span class=\"line\">  <span class=\"keyword\">var</span> secret = <span class=\"keyword\">this</span>.req.secret;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> signed = opts.signed;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (signed &amp;&amp; !secret) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Error</span>(<span class=\"string\">'cookieParser(\"secret\") required for signed cookies'</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">var</span> val = <span class=\"keyword\">typeof</span> value === <span class=\"string\">'object'</span></span><br><span class=\"line\">    ? <span class=\"string\">'j:'</span> + <span class=\"built_in\">JSON</span>.stringify(value)</span><br><span class=\"line\">    : <span class=\"built_in\">String</span>(value);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (signed) &#123;</span><br><span class=\"line\">    val = <span class=\"string\">'s:'</span> + sign(val, secret);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"string\">'maxAge'</span> <span class=\"keyword\">in</span> opts) &#123;</span><br><span class=\"line\">    opts.expires = <span class=\"keyword\">new</span> <span class=\"built_in\">Date</span>(<span class=\"built_in\">Date</span>.now() + opts.maxAge);</span><br><span class=\"line\">    opts.maxAge /= <span class=\"number\">1000</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (opts.path == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">    opts.path = <span class=\"string\">'/'</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">this</span>.append(<span class=\"string\">'Set-Cookie'</span>, cookie.serialize(name, <span class=\"built_in\">String</span>(val), opts));</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//序列化cookie以及配置信息</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">serialize</span>(<span class=\"params\">name, val, options</span>) </span>&#123;  </span><br><span class=\"line\">  <span class=\"keyword\">var</span> enc = opt.encode || encode;  </span><br><span class=\"line\">  <span class=\"keyword\">var</span> pairs = [name + <span class=\"string\">'='</span> + enc(val)];  </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"literal\">null</span> != opt.maxAge) &#123;    </span><br><span class=\"line\">    <span class=\"keyword\">var</span> maxAge = opt.maxAge - <span class=\"number\">0</span>;    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"built_in\">isNaN</span>(maxAge)) </span><br><span class=\"line\">      <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Error</span>(<span class=\"string\">'maxAge should be a Number'</span>);    </span><br><span class=\"line\">    pairs.push(<span class=\"string\">'Max-Age='</span> + maxAge);  </span><br><span class=\"line\">  &#125;  </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (opt.domain) pairs.push(<span class=\"string\">'Domain='</span> + opt.domain);  </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (opt.path) pairs.push(<span class=\"string\">'Path='</span> + opt.path);  </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (opt.expires) pairs.push(<span class=\"string\">'Expires='</span> + opt.expires.toUTCString());  </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (opt.httpOnly) pairs.push(<span class=\"string\">'HttpOnly'</span>);  </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (opt.secure) pairs.push(<span class=\"string\">'Secure'</span>);  <span class=\"keyword\">return</span> pairs.join(<span class=\"string\">'; '</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//设置到HTTP应答协议头</span></span><br><span class=\"line\">res.append = <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">append</span>(<span class=\"params\">field, val</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> prev = <span class=\"keyword\">this</span>.get(field);</span><br><span class=\"line\">  <span class=\"keyword\">var</span> value = val;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (prev) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// concat the new and prev vals</span></span><br><span class=\"line\">    value = <span class=\"built_in\">Array</span>.isArray(prev) ? prev.concat(val)</span><br><span class=\"line\">      : <span class=\"built_in\">Array</span>.isArray(val) ? [prev].concat(val)</span><br><span class=\"line\">      : [prev, val];</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.set(field, value);</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<hr>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"Session\"><a href=\"#Session\" class=\"headerlink\" title=\"Session\"></a>Session</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;web网站基于<code>HTTP</code>协议来做业务交互，<code>HTTP</code>协议本身是一个无状态的协议，但实际情况是日常很多业务逻辑都需要记录用户的行为信息。举个例子：</p>\n<blockquote>\n<p>一个购物网站，顾客会在商品浏览页面选取需要的各类商品，放置到虚拟的购物车内。下单的时候需要跳转到结算页面，在这一串连续的用户行为中，至关重要的一点是记录当前的购物车信息，而session机制可以恰当的处理此类问题。</p>\n</blockquote>\n<p>&nbsp;&nbsp;&nbsp;&nbsp;网站通常会在用户第一次登录的时候生成一个<code>Session ID</code>, <code>Session ID</code>不同于用户ID, 用户ID始终唯一，但是同一个用户每次登录获取的<code>Session ID</code>可能不一致。<code>Session ID</code>由服务器端生成，通过<code>HTTP</code>协议头返回给客户端，这样可以极大的降低可能导致的安全问题(其他劫持暂且不说)。因为浏览器拿到的只是一个<code>token</code>，而与此相关的数据存储都在服务器端完成。服务端在设置<code>session ID</code>的同时会指定改<code>session id</code>的过期时间，以及该<code>session id</code>试用的请求路径(path)。了解了<code>session</code>的大致原理，下面结合代码来了解大致的使用过程。</p>\n<h4 id=\"从cookie说起\"><a href=\"#从cookie说起\" class=\"headerlink\" title=\"从cookie说起\"></a>从cookie说起</h4><p>上述使用案例得益于<code>cookie</code>这一伟大发明，一般来说cookie的处理分为如下几个步骤：</p>\n<ul>\n<li><ol>\n<li>用户打开网页</li>\n</ol>\n</li>\n<li><ol start=\"2\">\n<li>服务端生成cookie数据返回给浏览器</li>\n</ol>\n</li>\n<li><ol start=\"3\">\n<li>浏览器将cookie保存</li>\n</ol>\n</li>\n<li><ol start=\"4\">\n<li>之后每次加载该页面，浏览器都把cookie数据发送给服务器</li>\n</ol>\n</li>\n</ul>\n<h4 id=\"cookies的基本数据格式\"><a href=\"#cookies的基本数据格式\" class=\"headerlink\" title=\"cookies的基本数据格式\"></a>cookies的基本数据格式</h4><p>标准的 <code>HTTP</code>协议有一个字段<code>Set-Cookie</code>用于标示cookie数据。服务器通过该字段告知客户端cookie数据。设置<code>cookie</code>数据的同时支持给该数据指定一些配置信息：</p>\n<ul>\n<li>Path: 表示该cookie数据影响到的路径，当前访问的url不满足该匹配时，不发送该cookie数据。</li>\n<li>Expires: 该<code>cookies</code>数据的过期时间(具体的时间点)，如果不设置该选项，在浏览器关闭时该<code>cookie</code>丢失。该字段是一个UTC格式的字符串。</li>\n<li>Max-Age: 告知浏览器<code>cookie</code>多久之后过期，可以解决客户端与服务器时间不一致导致过期时间不准确的问题, 在express里时间单位是毫秒。</li>\n<li>HttpOnly: 告知浏览器该<code>cookie</code>不允许通过浏览器API的形式去修改，比如说通过<code>document.cookie</code>修改。在<code>document.cookie</code>不可见。</li>\n<li>Secure: 当设置该值为<code>true</code>时，<code>cookie</code>数据在<code>HTTP</code>协议下无效，只有在<code>HTTPS</code>协议下才有效。</li>\n<li>domain: <code>domain</code>属性指定了该<code>cookie</code>所属的域名(<code>Domain</code>), 比如说设置<code>domain=example.com</code>,那么浏览器在给<code>www.example.com</code>, <code>www.abc.example.com</code>发送<code>HTTP</code>请求时都会带上该<code>cookie</code>。如果服务器没有设置该属性那么浏览器默认该<code>cookie</code>从属于<code>www.example.com</code>域名。说到这里，一定会想，要是我把domain设置为其他网站,这样我是不是可以轻易更改其他网站的<code>cookie</code>数据了？浏览器有个策略，允许<code>foo.example.com</code>的服务器设置<code>domain</code>为<code>example.com</code>或者<code>foo.example.com</code>。但是不允许设置<code>domain</code>为<code>bar.example.com</code> ETC。同时考虑到安全方面的因素，浏览器拒绝只给<code>domain</code>设置公共(public suffixes)，比如说设置为<code>com</code>, <code>co.uk</code>是不被允许的。</li>\n</ul>\n<hr>\n<p><strong>Set-Cookie格式定义</strong></p>\n<blockquote>\n</blockquote>\n<p><em>Set-Cookie: name=value; Path:/; Domin=.domin.com;Secure=true</em></p>\n<p>第一部分表示设置的<code>cookie</code>键/值，后面跟着几个配置参数。</p>\n<p>###Cookie 解析<br><code>Express/Connect</code>有一个<code>cookieParser</code>中间件专门负责<code>cookieParser</code>的解析。其实现原理如下：<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">parserCookie</span>(<span class=\"params\">cookie, options</span>) </span>&#123;</span><br><span class=\"line\">   <span class=\"keyword\">var</span> obj = &#123;&#125;;</span><br><span class=\"line\">   <span class=\"keyword\">var</span> pairs = cookies.split(<span class=\"regexp\">/; /</span>);</span><br><span class=\"line\">   <span class=\"keyword\">var</span> decode = opt.decode || <span class=\"built_in\">decodeURIComponent</span>;</span><br><span class=\"line\">   </span><br><span class=\"line\">   pairs.forEach(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">pair</span>) </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">var</span> eq_idx = pair.indexOf(<span class=\"string\">'='</span>);</span><br><span class=\"line\">      <span class=\"keyword\">var</span> key = pair.substr(<span class=\"number\">0</span>, eq_idx).trim();</span><br><span class=\"line\">      <span class=\"keyword\">var</span> val = pair.substr(eq_idx, pair.length).trim();</span><br><span class=\"line\">       <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">           obj[key] = decode(val);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">catch</span>(err) &#123;</span><br><span class=\"line\">           obj[key] = val;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">   &#125;);</span><br><span class=\"line\">   </span><br><span class=\"line\">   <span class=\"keyword\">return</span> obj;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">parseSignCookie</span>(<span class=\"params\">cookies, secret</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> keys = <span class=\"built_in\">Object</span>.keys(cookies);</span><br><span class=\"line\">  <span class=\"keyword\">var</span> dec = <span class=\"literal\">null</span>;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> ret = <span class=\"built_in\">Object</span>.create(<span class=\"literal\">null</span>);</span><br><span class=\"line\">  <span class=\"keyword\">var</span> val = <span class=\"literal\">null</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">for</span>(<span class=\"keyword\">var</span> i = <span class=\"number\">0</span>; i &lt; keys.length; i++) &#123;</span><br><span class=\"line\">     <span class=\"keyword\">var</span> k = keys[i];</span><br><span class=\"line\">     <span class=\"keyword\">var</span> v = cookies[k];</span><br><span class=\"line\">     dec = unsign(v, secret);</span><br><span class=\"line\">    ret[k] = dec;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> ret;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">parseJSONCookie</span>(<span class=\"params\">cookie</span>) </span>&#123;</span><br><span class=\"line\">   <span class=\"keyword\">var</span> keys = <span class=\"built_in\">Object</span>.keys(cookie);</span><br><span class=\"line\">   <span class=\"keyword\">var</span> key;</span><br><span class=\"line\">   <span class=\"keyword\">var</span> val;</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"keyword\">for</span>(<span class=\"keyword\">var</span> i = <span class=\"number\">0</span>; i &lt; cookie.length; i++) &#123;</span><br><span class=\"line\">      val = cookie[i];</span><br><span class=\"line\">      key = keys[i];</span><br><span class=\"line\">      obj[key] = <span class=\"built_in\">JSON</span>.parse(val);</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> cookieParser = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">secret, opts</span>) </span>&#123;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">req, res, next</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(req.cookies) <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">var</span> cookies = req.headers.cookies;</span><br><span class=\"line\">    req.cookies = &#123;&#125;;</span><br><span class=\"line\">    req.signCookies = &#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"comment\">//把name=value格式的字符串解析为一个json对象</span></span><br><span class=\"line\">    req.cookies = parserCookie(cookies, options);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(secret) &#123;</span><br><span class=\"line\">      <span class=\"comment\">//解析加密过的cookie字段</span></span><br><span class=\"line\">      req.signCookies = parseSignCookie(req.cookies, secret);</span><br><span class=\"line\">      <span class=\"comment\">//解析stringify过的JSON对象</span></span><br><span class=\"line\">      req.signCookies = parseJSONCookie(req.signCookies);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    req.cookies = parseJSONCookies(req.cookies);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>Express 给不一样的cookie字段值打上不一样的标签，如<code>j:</code>表示该值是一个JSON对象stringify后的值，<code>s:</code>表示该字段是经过加密的。默认把加密与未加密的字段分别放在<code>req.signCookies</code>, <code>req.cookies</code>。</p>\n</blockquote>\n<hr>\n<h3 id=\"设置-Cookie\"><a href=\"#设置-Cookie\" class=\"headerlink\" title=\"设置 Cookie\"></a>设置 Cookie</h3><p><code>Express</code>提供了一个<code>res.cookie</code>接口来设置<code>Cookie</code>数据。来看看<code>Express</code>的处理代码：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">res.cookie = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">name, value, options</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> opts = merge(&#123;&#125;, options);</span><br><span class=\"line\">  <span class=\"keyword\">var</span> secret = <span class=\"keyword\">this</span>.req.secret;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> signed = opts.signed;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (signed &amp;&amp; !secret) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Error</span>(<span class=\"string\">'cookieParser(\"secret\") required for signed cookies'</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">var</span> val = <span class=\"keyword\">typeof</span> value === <span class=\"string\">'object'</span></span><br><span class=\"line\">    ? <span class=\"string\">'j:'</span> + <span class=\"built_in\">JSON</span>.stringify(value)</span><br><span class=\"line\">    : <span class=\"built_in\">String</span>(value);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (signed) &#123;</span><br><span class=\"line\">    val = <span class=\"string\">'s:'</span> + sign(val, secret);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"string\">'maxAge'</span> <span class=\"keyword\">in</span> opts) &#123;</span><br><span class=\"line\">    opts.expires = <span class=\"keyword\">new</span> <span class=\"built_in\">Date</span>(<span class=\"built_in\">Date</span>.now() + opts.maxAge);</span><br><span class=\"line\">    opts.maxAge /= <span class=\"number\">1000</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (opts.path == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">    opts.path = <span class=\"string\">'/'</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">this</span>.append(<span class=\"string\">'Set-Cookie'</span>, cookie.serialize(name, <span class=\"built_in\">String</span>(val), opts));</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//序列化cookie以及配置信息</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">serialize</span>(<span class=\"params\">name, val, options</span>) </span>&#123;  </span><br><span class=\"line\">  <span class=\"keyword\">var</span> enc = opt.encode || encode;  </span><br><span class=\"line\">  <span class=\"keyword\">var</span> pairs = [name + <span class=\"string\">'='</span> + enc(val)];  </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"literal\">null</span> != opt.maxAge) &#123;    </span><br><span class=\"line\">    <span class=\"keyword\">var</span> maxAge = opt.maxAge - <span class=\"number\">0</span>;    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"built_in\">isNaN</span>(maxAge)) </span><br><span class=\"line\">      <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Error</span>(<span class=\"string\">'maxAge should be a Number'</span>);    </span><br><span class=\"line\">    pairs.push(<span class=\"string\">'Max-Age='</span> + maxAge);  </span><br><span class=\"line\">  &#125;  </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (opt.domain) pairs.push(<span class=\"string\">'Domain='</span> + opt.domain);  </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (opt.path) pairs.push(<span class=\"string\">'Path='</span> + opt.path);  </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (opt.expires) pairs.push(<span class=\"string\">'Expires='</span> + opt.expires.toUTCString());  </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (opt.httpOnly) pairs.push(<span class=\"string\">'HttpOnly'</span>);  </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (opt.secure) pairs.push(<span class=\"string\">'Secure'</span>);  <span class=\"keyword\">return</span> pairs.join(<span class=\"string\">'; '</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//设置到HTTP应答协议头</span></span><br><span class=\"line\">res.append = <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">append</span>(<span class=\"params\">field, val</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> prev = <span class=\"keyword\">this</span>.get(field);</span><br><span class=\"line\">  <span class=\"keyword\">var</span> value = val;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (prev) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// concat the new and prev vals</span></span><br><span class=\"line\">    value = <span class=\"built_in\">Array</span>.isArray(prev) ? prev.concat(val)</span><br><span class=\"line\">      : <span class=\"built_in\">Array</span>.isArray(val) ? [prev].concat(val)</span><br><span class=\"line\">      : [prev, val];</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.set(field, value);</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<hr>\n"},{"title":"URL编解码","date":"2016-04-17T02:37:03.000Z","_content":"&nbsp;&nbsp;&nbsp;&nbsp;URI(统一资源定为标志)，用于指定想要访问的资源，URI可以有各种形式，如：日常在用的URL、每本书背面的ISBN码都是URI的一种形式, 日常过程中，如果不加区分，一般说的`URI`都指的是`URL`。拿我们熟悉的URL来说：\n\n一个普通的URL：\n>https://www.baidu.com/fuck.php?action=run#hash=1\n\nURL一般包括以下几个部分：\n\n+ 1. Scheme\n指定URL协议：http/https\n+ 2. hostname\n指定域名，如上面的`www.baidu.com`\n+ 3. port\n指定目标主机端口号，`http`协议默认为80端口，`https`默认为433端口。\n+ 4. path\n指定要访问的资源路径，以上为`fuck.php`\n+ 5. query\n以`?`开头，传递给目标主机的参数，`key/value`的形式来表示参数，参数之间通过`&`符号间隔开来。在`Nodejs`服务器，上面的`URL`最终解析得到`query`对象:\n> req.query = {action: run}\n+ 6. hash\n`hash`参数用于给浏览器渲染出来的`HTML`界面指定锚点，服务器在解析`URL`的时候会把`#`后面的字符丢弃。\n\n如果在实际运用过程中我们仅仅只需要知道这些概念就好了，可惜事情的复杂度往往比现象的要大。\n\n- 如果要给`URL`放其他字符怎么处理，如果我想放一些二进制数据呢？\n- 数据量一大，URL会不会出现过长的问题？\n\n####URL编解码\n&nbsp;&nbsp;&nbsp;&nbsp;在编写`js`代码过程中有几个常用的`URL`编码函数：`encodeURI`, `encodeURIComponent`, `atob`。以及对应的解码函数：`decodeURI`, `decodeURIComponent`, `btoa`。关于编解码，官方也有明确的规定(RFC 3986文档)，以下字符为保留字符，如果开发者需要使用它，就需要对其编码：\n> ; , / ? : @ & = + $\n\n同时也规定了一些非保留字符：\n>字母/数字/- _ . ! ~ * ' ( )\t\n\n**对URL特殊字符的编码称之为`百分号编码`**。即：\n> 对于特殊字符序，需要转换为`UTF-8`编码方式，然后取每个字节的16进制值，在其前面加上`%`号，完成编码。由于`UTF-8`编码兼容`ASCII`码，所以对于**特殊字符**只需要取其`ASCII`码的16进制值，在前面加上`%`即可。由于`%`号(ASCII HEX = 25)在`URL`编码有特殊的含义，所以也需要对它编码：`%25`。最终得到的`url`仅仅由定义`URL schema`需要的字符，加上非保留字符组成。\n\n\n来看看几个编解码函数的具体功能：\n+ encodeURI/decodeURI\n用于对整个`URL`编解码，但是其不会对**保留字符与上面定义的非保留字符**进行编码。举个例子：\n普通的编码：\n```javascript\n\n> var url1 = 'http://www.baidu.com/fuck.php?action=run';\nundefined\n\n> encodeURI(url1)\n'http://www.baidu.com/fuck.php?action=run'\n> \n\n```\n\n加上几个保留字符试一试：\n``` javascript\n\n> var url1 = 'http:/$/@;www.baidu.com/fuck.php?action=run';\n\n> encodeURI(url1)\n'http:/$/@;www.baidu.com/fuck.php?action=run'\n> \n\n```\n**可以看到并没有对保留字符编码。**\n\n再加入几个其他字符，如中文，试一试：\n```javascript\n> var url1 = 'http:/$/@;www.baidu.com/你好fuck.php?action=run';\n\n> encodeURI(url1)\n'http:/$/@;www.baidu.com/%E4%BD%A0%E5%A5%BDfuck.php?action=run'\n\n```\n`你好`对应的`Unicode`码为：`4F60`、`597D`。`UTF-8`编码之后分别为：`E4BDA0`与`E5A5BD`正好匹配`encodeURI`的输出。\n**可以看到对encodeURI除保留字符与特殊字符外的字符进行了编码。**\n\n>由于`encodeURI`不会对一些特殊字符编码，但是`URL`规范使用中必须对一些特殊字符譬如说：`&`, `=`,`+`进行编码。所以我们要用到的另一个函数是`encodeURIComponent`。\n\n**encodeURIComponent会把除非保留字符外的字符，通过百分号编码，转化为非保留字符的形式，这其中就包括了特殊字符。**\n看几个例子：\n``` javascript\n> var component = 'http://www.baidu.com'; \n\n> encodeURIComponent(component);\n'http%3A%2F%2Fwww.baidu.com'\n> \n\n```\n`:`, `/`都是保留字符，而`.`以及字母是非保留字符，验证了我们的想法。\n\n如果我们要在`URL`传入一些二进制数据怎么办呢？首先想到的是：**`Base64`编码的出现主要就是为了解决二进制数据的传输问题**。`btoa`就是我们想要的接口。\n举个例子：\n```javascript\nvar atob = require('atob');\nvar btoa = require('btoa');\n\nvar u1 = 'http://www.baidu.com';\n\nconsole.log(btoa(u1));\n\n```\n输出：\n> aHR0cDovL3d3dy5iYWlkdS5jb20=\n\n由于`Base64`在被编码字符长度不为`3`的倍数情况下会出现`=`号，**而`=`是保留字符**，由于它在这里有特殊的含义(表示传输数据的一部分)，所以需要调用`encodeURIComponent`对其进行编码。\n\n\n####URL的一些数据长度限制规定\n`web 浏览器`对整个 URI 长度有一定的限制。传统的IE浏览器是2048个字节，而现代各种浏览器和 web 服务器的设定均不一样，这依赖于各个浏览器厂家的规定或者可以根据 web 服务器的处理能力来设定。\n\n\n\n","source":"_posts/URL编解码.md","raw":"---\ntitle: URL编解码\ncategories: web\ndate: 2016-04-17 10:37:03\n---\n&nbsp;&nbsp;&nbsp;&nbsp;URI(统一资源定为标志)，用于指定想要访问的资源，URI可以有各种形式，如：日常在用的URL、每本书背面的ISBN码都是URI的一种形式, 日常过程中，如果不加区分，一般说的`URI`都指的是`URL`。拿我们熟悉的URL来说：\n\n一个普通的URL：\n>https://www.baidu.com/fuck.php?action=run#hash=1\n\nURL一般包括以下几个部分：\n\n+ 1. Scheme\n指定URL协议：http/https\n+ 2. hostname\n指定域名，如上面的`www.baidu.com`\n+ 3. port\n指定目标主机端口号，`http`协议默认为80端口，`https`默认为433端口。\n+ 4. path\n指定要访问的资源路径，以上为`fuck.php`\n+ 5. query\n以`?`开头，传递给目标主机的参数，`key/value`的形式来表示参数，参数之间通过`&`符号间隔开来。在`Nodejs`服务器，上面的`URL`最终解析得到`query`对象:\n> req.query = {action: run}\n+ 6. hash\n`hash`参数用于给浏览器渲染出来的`HTML`界面指定锚点，服务器在解析`URL`的时候会把`#`后面的字符丢弃。\n\n如果在实际运用过程中我们仅仅只需要知道这些概念就好了，可惜事情的复杂度往往比现象的要大。\n\n- 如果要给`URL`放其他字符怎么处理，如果我想放一些二进制数据呢？\n- 数据量一大，URL会不会出现过长的问题？\n\n####URL编解码\n&nbsp;&nbsp;&nbsp;&nbsp;在编写`js`代码过程中有几个常用的`URL`编码函数：`encodeURI`, `encodeURIComponent`, `atob`。以及对应的解码函数：`decodeURI`, `decodeURIComponent`, `btoa`。关于编解码，官方也有明确的规定(RFC 3986文档)，以下字符为保留字符，如果开发者需要使用它，就需要对其编码：\n> ; , / ? : @ & = + $\n\n同时也规定了一些非保留字符：\n>字母/数字/- _ . ! ~ * ' ( )\t\n\n**对URL特殊字符的编码称之为`百分号编码`**。即：\n> 对于特殊字符序，需要转换为`UTF-8`编码方式，然后取每个字节的16进制值，在其前面加上`%`号，完成编码。由于`UTF-8`编码兼容`ASCII`码，所以对于**特殊字符**只需要取其`ASCII`码的16进制值，在前面加上`%`即可。由于`%`号(ASCII HEX = 25)在`URL`编码有特殊的含义，所以也需要对它编码：`%25`。最终得到的`url`仅仅由定义`URL schema`需要的字符，加上非保留字符组成。\n\n\n来看看几个编解码函数的具体功能：\n+ encodeURI/decodeURI\n用于对整个`URL`编解码，但是其不会对**保留字符与上面定义的非保留字符**进行编码。举个例子：\n普通的编码：\n```javascript\n\n> var url1 = 'http://www.baidu.com/fuck.php?action=run';\nundefined\n\n> encodeURI(url1)\n'http://www.baidu.com/fuck.php?action=run'\n> \n\n```\n\n加上几个保留字符试一试：\n``` javascript\n\n> var url1 = 'http:/$/@;www.baidu.com/fuck.php?action=run';\n\n> encodeURI(url1)\n'http:/$/@;www.baidu.com/fuck.php?action=run'\n> \n\n```\n**可以看到并没有对保留字符编码。**\n\n再加入几个其他字符，如中文，试一试：\n```javascript\n> var url1 = 'http:/$/@;www.baidu.com/你好fuck.php?action=run';\n\n> encodeURI(url1)\n'http:/$/@;www.baidu.com/%E4%BD%A0%E5%A5%BDfuck.php?action=run'\n\n```\n`你好`对应的`Unicode`码为：`4F60`、`597D`。`UTF-8`编码之后分别为：`E4BDA0`与`E5A5BD`正好匹配`encodeURI`的输出。\n**可以看到对encodeURI除保留字符与特殊字符外的字符进行了编码。**\n\n>由于`encodeURI`不会对一些特殊字符编码，但是`URL`规范使用中必须对一些特殊字符譬如说：`&`, `=`,`+`进行编码。所以我们要用到的另一个函数是`encodeURIComponent`。\n\n**encodeURIComponent会把除非保留字符外的字符，通过百分号编码，转化为非保留字符的形式，这其中就包括了特殊字符。**\n看几个例子：\n``` javascript\n> var component = 'http://www.baidu.com'; \n\n> encodeURIComponent(component);\n'http%3A%2F%2Fwww.baidu.com'\n> \n\n```\n`:`, `/`都是保留字符，而`.`以及字母是非保留字符，验证了我们的想法。\n\n如果我们要在`URL`传入一些二进制数据怎么办呢？首先想到的是：**`Base64`编码的出现主要就是为了解决二进制数据的传输问题**。`btoa`就是我们想要的接口。\n举个例子：\n```javascript\nvar atob = require('atob');\nvar btoa = require('btoa');\n\nvar u1 = 'http://www.baidu.com';\n\nconsole.log(btoa(u1));\n\n```\n输出：\n> aHR0cDovL3d3dy5iYWlkdS5jb20=\n\n由于`Base64`在被编码字符长度不为`3`的倍数情况下会出现`=`号，**而`=`是保留字符**，由于它在这里有特殊的含义(表示传输数据的一部分)，所以需要调用`encodeURIComponent`对其进行编码。\n\n\n####URL的一些数据长度限制规定\n`web 浏览器`对整个 URI 长度有一定的限制。传统的IE浏览器是2048个字节，而现代各种浏览器和 web 服务器的设定均不一样，这依赖于各个浏览器厂家的规定或者可以根据 web 服务器的处理能力来设定。\n\n\n\n","slug":"URL编解码","published":1,"updated":"2018-07-01T10:30:46.494Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cdg001vy4zv11d68ixp","content":"<p>&nbsp;&nbsp;&nbsp;&nbsp;URI(统一资源定为标志)，用于指定想要访问的资源，URI可以有各种形式，如：日常在用的URL、每本书背面的ISBN码都是URI的一种形式, 日常过程中，如果不加区分，一般说的<code>URI</code>都指的是<code>URL</code>。拿我们熟悉的URL来说：</p>\n<p>一个普通的URL：</p>\n<blockquote>\n<p><a href=\"https://www.baidu.com/fuck.php?action=run#hash=1\" target=\"_blank\" rel=\"noopener\">https://www.baidu.com/fuck.php?action=run#hash=1</a></p>\n</blockquote>\n<p>URL一般包括以下几个部分：</p>\n<ul>\n<li><ol>\n<li>Scheme<br>指定URL协议：http/https</li>\n</ol>\n</li>\n<li><ol start=\"2\">\n<li>hostname<br>指定域名，如上面的<code>www.baidu.com</code></li>\n</ol>\n</li>\n<li><ol start=\"3\">\n<li>port<br>指定目标主机端口号，<code>http</code>协议默认为80端口，<code>https</code>默认为433端口。</li>\n</ol>\n</li>\n<li><ol start=\"4\">\n<li>path<br>指定要访问的资源路径，以上为<code>fuck.php</code></li>\n</ol>\n</li>\n<li><ol start=\"5\">\n<li>query<br>以<code>?</code>开头，传递给目标主机的参数，<code>key/value</code>的形式来表示参数，参数之间通过<code>&amp;</code>符号间隔开来。在<code>Nodejs</code>服务器，上面的<code>URL</code>最终解析得到<code>query</code>对象:<blockquote>\n<p>req.query = {action: run}</p>\n</blockquote>\n</li>\n</ol>\n</li>\n<li><ol start=\"6\">\n<li>hash<br><code>hash</code>参数用于给浏览器渲染出来的<code>HTML</code>界面指定锚点，服务器在解析<code>URL</code>的时候会把<code>#</code>后面的字符丢弃。</li>\n</ol>\n</li>\n</ul>\n<p>如果在实际运用过程中我们仅仅只需要知道这些概念就好了，可惜事情的复杂度往往比现象的要大。</p>\n<ul>\n<li>如果要给<code>URL</code>放其他字符怎么处理，如果我想放一些二进制数据呢？</li>\n<li>数据量一大，URL会不会出现过长的问题？</li>\n</ul>\n<p>####URL编解码<br>&nbsp;&nbsp;&nbsp;&nbsp;在编写<code>js</code>代码过程中有几个常用的<code>URL</code>编码函数：<code>encodeURI</code>, <code>encodeURIComponent</code>, <code>atob</code>。以及对应的解码函数：<code>decodeURI</code>, <code>decodeURIComponent</code>, <code>btoa</code>。关于编解码，官方也有明确的规定(RFC 3986文档)，以下字符为保留字符，如果开发者需要使用它，就需要对其编码：</p>\n<blockquote>\n<p>; , / ? : @ &amp; = + $</p>\n</blockquote>\n<p>同时也规定了一些非保留字符：</p>\n<blockquote>\n<p>字母/数字/- _ . ! ~ * ‘ ( )    </p>\n</blockquote>\n<p><strong>对URL特殊字符的编码称之为<code>百分号编码</code></strong>。即：</p>\n<blockquote>\n<p>对于特殊字符序，需要转换为<code>UTF-8</code>编码方式，然后取每个字节的16进制值，在其前面加上<code>%</code>号，完成编码。由于<code>UTF-8</code>编码兼容<code>ASCII</code>码，所以对于<strong>特殊字符</strong>只需要取其<code>ASCII</code>码的16进制值，在前面加上<code>%</code>即可。由于<code>%</code>号(ASCII HEX = 25)在<code>URL</code>编码有特殊的含义，所以也需要对它编码：<code>%25</code>。最终得到的<code>url</code>仅仅由定义<code>URL schema</code>需要的字符，加上非保留字符组成。</p>\n</blockquote>\n<p>来看看几个编解码函数的具体功能：</p>\n<ul>\n<li>encodeURI/decodeURI<br>用于对整个<code>URL</code>编解码，但是其不会对<strong>保留字符与上面定义的非保留字符</strong>进行编码。举个例子：<br>普通的编码：<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">&gt; <span class=\"keyword\">var</span> url1 = <span class=\"string\">'http://www.baidu.com/fuck.php?action=run'</span>;</span><br><span class=\"line\"><span class=\"literal\">undefined</span></span><br><span class=\"line\"></span><br><span class=\"line\">&gt; <span class=\"built_in\">encodeURI</span>(url1)</span><br><span class=\"line\"><span class=\"string\">'http://www.baidu.com/fuck.php?action=run'</span></span><br><span class=\"line\">&gt;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>加上几个保留字符试一试：<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">&gt; <span class=\"keyword\">var</span> url1 = <span class=\"string\">'http:/$/@;www.baidu.com/fuck.php?action=run'</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; <span class=\"built_in\">encodeURI</span>(url1)</span><br><span class=\"line\"><span class=\"string\">'http:/$/@;www.baidu.com/fuck.php?action=run'</span></span><br><span class=\"line\">&gt;</span><br></pre></td></tr></table></figure></p>\n<p><strong>可以看到并没有对保留字符编码。</strong></p>\n<p>再加入几个其他字符，如中文，试一试：<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; <span class=\"keyword\">var</span> url1 = <span class=\"string\">'http:/$/@;www.baidu.com/你好fuck.php?action=run'</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; <span class=\"built_in\">encodeURI</span>(url1)</span><br><span class=\"line\"><span class=\"string\">'http:/$/@;www.baidu.com/%E4%BD%A0%E5%A5%BDfuck.php?action=run'</span></span><br></pre></td></tr></table></figure></p>\n<p><code>你好</code>对应的<code>Unicode</code>码为：<code>4F60</code>、<code>597D</code>。<code>UTF-8</code>编码之后分别为：<code>E4BDA0</code>与<code>E5A5BD</code>正好匹配<code>encodeURI</code>的输出。<br><strong>可以看到对encodeURI除保留字符与特殊字符外的字符进行了编码。</strong></p>\n<blockquote>\n<p>由于<code>encodeURI</code>不会对一些特殊字符编码，但是<code>URL</code>规范使用中必须对一些特殊字符譬如说：<code>&amp;</code>, <code>=</code>,<code>+</code>进行编码。所以我们要用到的另一个函数是<code>encodeURIComponent</code>。</p>\n</blockquote>\n<p><strong>encodeURIComponent会把除非保留字符外的字符，通过百分号编码，转化为非保留字符的形式，这其中就包括了特殊字符。</strong><br>看几个例子：<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; <span class=\"keyword\">var</span> component = <span class=\"string\">'http://www.baidu.com'</span>; </span><br><span class=\"line\"></span><br><span class=\"line\">&gt; <span class=\"built_in\">encodeURIComponent</span>(component);</span><br><span class=\"line\"><span class=\"string\">'http%3A%2F%2Fwww.baidu.com'</span></span><br><span class=\"line\">&gt;</span><br></pre></td></tr></table></figure></p>\n<p><code>:</code>, <code>/</code>都是保留字符，而<code>.</code>以及字母是非保留字符，验证了我们的想法。</p>\n<p>如果我们要在<code>URL</code>传入一些二进制数据怎么办呢？首先想到的是：<strong><code>Base64</code>编码的出现主要就是为了解决二进制数据的传输问题</strong>。<code>btoa</code>就是我们想要的接口。<br>举个例子：<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> atob = <span class=\"built_in\">require</span>(<span class=\"string\">'atob'</span>);</span><br><span class=\"line\"><span class=\"keyword\">var</span> btoa = <span class=\"built_in\">require</span>(<span class=\"string\">'btoa'</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> u1 = <span class=\"string\">'http://www.baidu.com'</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">console</span>.log(btoa(u1));</span><br></pre></td></tr></table></figure></p>\n<p>输出：</p>\n<blockquote>\n<p>aHR0cDovL3d3dy5iYWlkdS5jb20=</p>\n</blockquote>\n<p>由于<code>Base64</code>在被编码字符长度不为<code>3</code>的倍数情况下会出现<code>=</code>号，<strong>而<code>=</code>是保留字符</strong>，由于它在这里有特殊的含义(表示传输数据的一部分)，所以需要调用<code>encodeURIComponent</code>对其进行编码。</p>\n<p>####URL的一些数据长度限制规定<br><code>web 浏览器</code>对整个 URI 长度有一定的限制。传统的IE浏览器是2048个字节，而现代各种浏览器和 web 服务器的设定均不一样，这依赖于各个浏览器厂家的规定或者可以根据 web 服务器的处理能力来设定。</p>\n","site":{"data":{}},"excerpt":"","more":"<p>&nbsp;&nbsp;&nbsp;&nbsp;URI(统一资源定为标志)，用于指定想要访问的资源，URI可以有各种形式，如：日常在用的URL、每本书背面的ISBN码都是URI的一种形式, 日常过程中，如果不加区分，一般说的<code>URI</code>都指的是<code>URL</code>。拿我们熟悉的URL来说：</p>\n<p>一个普通的URL：</p>\n<blockquote>\n<p><a href=\"https://www.baidu.com/fuck.php?action=run#hash=1\" target=\"_blank\" rel=\"noopener\">https://www.baidu.com/fuck.php?action=run#hash=1</a></p>\n</blockquote>\n<p>URL一般包括以下几个部分：</p>\n<ul>\n<li><ol>\n<li>Scheme<br>指定URL协议：http/https</li>\n</ol>\n</li>\n<li><ol start=\"2\">\n<li>hostname<br>指定域名，如上面的<code>www.baidu.com</code></li>\n</ol>\n</li>\n<li><ol start=\"3\">\n<li>port<br>指定目标主机端口号，<code>http</code>协议默认为80端口，<code>https</code>默认为433端口。</li>\n</ol>\n</li>\n<li><ol start=\"4\">\n<li>path<br>指定要访问的资源路径，以上为<code>fuck.php</code></li>\n</ol>\n</li>\n<li><ol start=\"5\">\n<li>query<br>以<code>?</code>开头，传递给目标主机的参数，<code>key/value</code>的形式来表示参数，参数之间通过<code>&amp;</code>符号间隔开来。在<code>Nodejs</code>服务器，上面的<code>URL</code>最终解析得到<code>query</code>对象:<blockquote>\n<p>req.query = {action: run}</p>\n</blockquote>\n</li>\n</ol>\n</li>\n<li><ol start=\"6\">\n<li>hash<br><code>hash</code>参数用于给浏览器渲染出来的<code>HTML</code>界面指定锚点，服务器在解析<code>URL</code>的时候会把<code>#</code>后面的字符丢弃。</li>\n</ol>\n</li>\n</ul>\n<p>如果在实际运用过程中我们仅仅只需要知道这些概念就好了，可惜事情的复杂度往往比现象的要大。</p>\n<ul>\n<li>如果要给<code>URL</code>放其他字符怎么处理，如果我想放一些二进制数据呢？</li>\n<li>数据量一大，URL会不会出现过长的问题？</li>\n</ul>\n<p>####URL编解码<br>&nbsp;&nbsp;&nbsp;&nbsp;在编写<code>js</code>代码过程中有几个常用的<code>URL</code>编码函数：<code>encodeURI</code>, <code>encodeURIComponent</code>, <code>atob</code>。以及对应的解码函数：<code>decodeURI</code>, <code>decodeURIComponent</code>, <code>btoa</code>。关于编解码，官方也有明确的规定(RFC 3986文档)，以下字符为保留字符，如果开发者需要使用它，就需要对其编码：</p>\n<blockquote>\n<p>; , / ? : @ &amp; = + $</p>\n</blockquote>\n<p>同时也规定了一些非保留字符：</p>\n<blockquote>\n<p>字母/数字/- _ . ! ~ * ‘ ( )    </p>\n</blockquote>\n<p><strong>对URL特殊字符的编码称之为<code>百分号编码</code></strong>。即：</p>\n<blockquote>\n<p>对于特殊字符序，需要转换为<code>UTF-8</code>编码方式，然后取每个字节的16进制值，在其前面加上<code>%</code>号，完成编码。由于<code>UTF-8</code>编码兼容<code>ASCII</code>码，所以对于<strong>特殊字符</strong>只需要取其<code>ASCII</code>码的16进制值，在前面加上<code>%</code>即可。由于<code>%</code>号(ASCII HEX = 25)在<code>URL</code>编码有特殊的含义，所以也需要对它编码：<code>%25</code>。最终得到的<code>url</code>仅仅由定义<code>URL schema</code>需要的字符，加上非保留字符组成。</p>\n</blockquote>\n<p>来看看几个编解码函数的具体功能：</p>\n<ul>\n<li>encodeURI/decodeURI<br>用于对整个<code>URL</code>编解码，但是其不会对<strong>保留字符与上面定义的非保留字符</strong>进行编码。举个例子：<br>普通的编码：<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">&gt; <span class=\"keyword\">var</span> url1 = <span class=\"string\">'http://www.baidu.com/fuck.php?action=run'</span>;</span><br><span class=\"line\"><span class=\"literal\">undefined</span></span><br><span class=\"line\"></span><br><span class=\"line\">&gt; <span class=\"built_in\">encodeURI</span>(url1)</span><br><span class=\"line\"><span class=\"string\">'http://www.baidu.com/fuck.php?action=run'</span></span><br><span class=\"line\">&gt;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>加上几个保留字符试一试：<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">&gt; <span class=\"keyword\">var</span> url1 = <span class=\"string\">'http:/$/@;www.baidu.com/fuck.php?action=run'</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; <span class=\"built_in\">encodeURI</span>(url1)</span><br><span class=\"line\"><span class=\"string\">'http:/$/@;www.baidu.com/fuck.php?action=run'</span></span><br><span class=\"line\">&gt;</span><br></pre></td></tr></table></figure></p>\n<p><strong>可以看到并没有对保留字符编码。</strong></p>\n<p>再加入几个其他字符，如中文，试一试：<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; <span class=\"keyword\">var</span> url1 = <span class=\"string\">'http:/$/@;www.baidu.com/你好fuck.php?action=run'</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; <span class=\"built_in\">encodeURI</span>(url1)</span><br><span class=\"line\"><span class=\"string\">'http:/$/@;www.baidu.com/%E4%BD%A0%E5%A5%BDfuck.php?action=run'</span></span><br></pre></td></tr></table></figure></p>\n<p><code>你好</code>对应的<code>Unicode</code>码为：<code>4F60</code>、<code>597D</code>。<code>UTF-8</code>编码之后分别为：<code>E4BDA0</code>与<code>E5A5BD</code>正好匹配<code>encodeURI</code>的输出。<br><strong>可以看到对encodeURI除保留字符与特殊字符外的字符进行了编码。</strong></p>\n<blockquote>\n<p>由于<code>encodeURI</code>不会对一些特殊字符编码，但是<code>URL</code>规范使用中必须对一些特殊字符譬如说：<code>&amp;</code>, <code>=</code>,<code>+</code>进行编码。所以我们要用到的另一个函数是<code>encodeURIComponent</code>。</p>\n</blockquote>\n<p><strong>encodeURIComponent会把除非保留字符外的字符，通过百分号编码，转化为非保留字符的形式，这其中就包括了特殊字符。</strong><br>看几个例子：<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; <span class=\"keyword\">var</span> component = <span class=\"string\">'http://www.baidu.com'</span>; </span><br><span class=\"line\"></span><br><span class=\"line\">&gt; <span class=\"built_in\">encodeURIComponent</span>(component);</span><br><span class=\"line\"><span class=\"string\">'http%3A%2F%2Fwww.baidu.com'</span></span><br><span class=\"line\">&gt;</span><br></pre></td></tr></table></figure></p>\n<p><code>:</code>, <code>/</code>都是保留字符，而<code>.</code>以及字母是非保留字符，验证了我们的想法。</p>\n<p>如果我们要在<code>URL</code>传入一些二进制数据怎么办呢？首先想到的是：<strong><code>Base64</code>编码的出现主要就是为了解决二进制数据的传输问题</strong>。<code>btoa</code>就是我们想要的接口。<br>举个例子：<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> atob = <span class=\"built_in\">require</span>(<span class=\"string\">'atob'</span>);</span><br><span class=\"line\"><span class=\"keyword\">var</span> btoa = <span class=\"built_in\">require</span>(<span class=\"string\">'btoa'</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> u1 = <span class=\"string\">'http://www.baidu.com'</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">console</span>.log(btoa(u1));</span><br></pre></td></tr></table></figure></p>\n<p>输出：</p>\n<blockquote>\n<p>aHR0cDovL3d3dy5iYWlkdS5jb20=</p>\n</blockquote>\n<p>由于<code>Base64</code>在被编码字符长度不为<code>3</code>的倍数情况下会出现<code>=</code>号，<strong>而<code>=</code>是保留字符</strong>，由于它在这里有特殊的含义(表示传输数据的一部分)，所以需要调用<code>encodeURIComponent</code>对其进行编码。</p>\n<p>####URL的一些数据长度限制规定<br><code>web 浏览器</code>对整个 URI 长度有一定的限制。传统的IE浏览器是2048个字节，而现代各种浏览器和 web 服务器的设定均不一样，这依赖于各个浏览器厂家的规定或者可以根据 web 服务器的处理能力来设定。</p>\n"},{"title":"css视觉格式化1","date":"2016-08-18T02:43:12.000Z","_content":"\n# 视觉格式化基本概念总结\n\n## 块级元素水平格式化\n\n- 1、水平格式化七个属性，只有宽度、左右外边距可以设置为`auto`，其他必须为特定值，或者默认为0.\n- 2、外边距可以为负、其他不能。`width`默认为`auto`、其他默认为0.\n- 3、七个水平布局属性之和等于父元素的`width`，只要所有所有属性都是大于或者等于0，元素就不会超过父元素的内容区域。\n- 4、如果外边距离与`width`都设置为特定值且之和大于父元素的`width`，右边距会重置为`auto`。\n- 5、如果只有一个设置为`auto`，其会根据公式计算。\n- 6、如果参数之和大于父元素的`width`且`margin-right`设置为`auto`，则会重置`margin-right`以适配公式(如果没有设置`margin-right`为`auto`则会保持设置值)\n\n---\n\n## 块级元素的垂直格式化\n\n- 1、高度默认由其内容决定、受到内容宽度影响\n- 2、七个属性的值必须等于元素包含的`height`\n- 3、七个属性只有三个可以设置为`auto`\n- 4、如果把上下外边距设置为`auto`，那么它会自动计算为0\n- 5、如果块级正常流元素的高度设置为`auto`,而且只有块级子元素，其默认高度是最高元素外边框(border)边界到最低子元素外边框边界的距离。\n- 6、如果给包含块设置`边框`或者内边距时，包含块的高度会把子元素的外边距(margin)包含在内\n- 7、垂直负外边距合并规则：\n    + 如果两个外边距都是负，浏览器取绝对值比较大的那个数\n    + 如果一正一负，浏览器会用正外边距减去负外边距的绝对值\n    + 行内框、浮动定位、和绝对定位元素之间的外边距不会叠加(外边距合并只发生在正常流元素)\n\n---\n\n## 行内元素布局的基本概念\n\n- 1、`em`框： `font-size`大小确定\n- 2、内容区\n    + 行内非替换元素：等于`em`框\n    + 行内替换元素：元素固有宽高、加上边距、边框\n\n- 3、行间距\n    + 行内非替换元素：等于`font-size`与`line-height`的差\n    + 行内替换元素：没有行间距的概念\n\n- 4、行内框\n\n    + 行内非替换元素：等于`line-height`\n    + 行内替换元素：等于内容区\n\n---\n\n## 行内元素布局一些有用的概念\n\n- 1、内容区类似于块级元素的内容框\n- 2、行内元素背景作用于内容区以及内边距\n- 3、行内元素的边框包围内容区、内边距\n- 4、非替换元素的边框、边距不会影响行内框高度\n- 5、替换元素的边距、边框会影响行内框高度\n- 6、可以为除了行内非替换元素外的任意元素设置垂直外边距\n\n---\n\n# 关于百分数参数\n\n- 1、对`margin/padding`使用百分比将会相对于包含块的内容区宽度计算\n- 2、对于`height`属性使用百分比将会相对于包含块内容区的高度计算\n- 3、对于定位元素(`position`属性非`static`)的`top`、`bottom`属性使用百分比将会相对于包含块高度计算\n- 4、不允许对`border`属性使用百分比","source":"_posts/css视觉格式化1.md","raw":"---\ntitle: css视觉格式化1\ndate: 2016-08-18 10:43:12\ntags: inline block\ncategories: web\n---\n\n# 视觉格式化基本概念总结\n\n## 块级元素水平格式化\n\n- 1、水平格式化七个属性，只有宽度、左右外边距可以设置为`auto`，其他必须为特定值，或者默认为0.\n- 2、外边距可以为负、其他不能。`width`默认为`auto`、其他默认为0.\n- 3、七个水平布局属性之和等于父元素的`width`，只要所有所有属性都是大于或者等于0，元素就不会超过父元素的内容区域。\n- 4、如果外边距离与`width`都设置为特定值且之和大于父元素的`width`，右边距会重置为`auto`。\n- 5、如果只有一个设置为`auto`，其会根据公式计算。\n- 6、如果参数之和大于父元素的`width`且`margin-right`设置为`auto`，则会重置`margin-right`以适配公式(如果没有设置`margin-right`为`auto`则会保持设置值)\n\n---\n\n## 块级元素的垂直格式化\n\n- 1、高度默认由其内容决定、受到内容宽度影响\n- 2、七个属性的值必须等于元素包含的`height`\n- 3、七个属性只有三个可以设置为`auto`\n- 4、如果把上下外边距设置为`auto`，那么它会自动计算为0\n- 5、如果块级正常流元素的高度设置为`auto`,而且只有块级子元素，其默认高度是最高元素外边框(border)边界到最低子元素外边框边界的距离。\n- 6、如果给包含块设置`边框`或者内边距时，包含块的高度会把子元素的外边距(margin)包含在内\n- 7、垂直负外边距合并规则：\n    + 如果两个外边距都是负，浏览器取绝对值比较大的那个数\n    + 如果一正一负，浏览器会用正外边距减去负外边距的绝对值\n    + 行内框、浮动定位、和绝对定位元素之间的外边距不会叠加(外边距合并只发生在正常流元素)\n\n---\n\n## 行内元素布局的基本概念\n\n- 1、`em`框： `font-size`大小确定\n- 2、内容区\n    + 行内非替换元素：等于`em`框\n    + 行内替换元素：元素固有宽高、加上边距、边框\n\n- 3、行间距\n    + 行内非替换元素：等于`font-size`与`line-height`的差\n    + 行内替换元素：没有行间距的概念\n\n- 4、行内框\n\n    + 行内非替换元素：等于`line-height`\n    + 行内替换元素：等于内容区\n\n---\n\n## 行内元素布局一些有用的概念\n\n- 1、内容区类似于块级元素的内容框\n- 2、行内元素背景作用于内容区以及内边距\n- 3、行内元素的边框包围内容区、内边距\n- 4、非替换元素的边框、边距不会影响行内框高度\n- 5、替换元素的边距、边框会影响行内框高度\n- 6、可以为除了行内非替换元素外的任意元素设置垂直外边距\n\n---\n\n# 关于百分数参数\n\n- 1、对`margin/padding`使用百分比将会相对于包含块的内容区宽度计算\n- 2、对于`height`属性使用百分比将会相对于包含块内容区的高度计算\n- 3、对于定位元素(`position`属性非`static`)的`top`、`bottom`属性使用百分比将会相对于包含块高度计算\n- 4、不允许对`border`属性使用百分比","slug":"css视觉格式化1","published":1,"updated":"2018-07-01T10:30:46.494Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cdh001zy4zvguwbarsr","content":"<h1 id=\"视觉格式化基本概念总结\"><a href=\"#视觉格式化基本概念总结\" class=\"headerlink\" title=\"视觉格式化基本概念总结\"></a>视觉格式化基本概念总结</h1><h2 id=\"块级元素水平格式化\"><a href=\"#块级元素水平格式化\" class=\"headerlink\" title=\"块级元素水平格式化\"></a>块级元素水平格式化</h2><ul>\n<li>1、水平格式化七个属性，只有宽度、左右外边距可以设置为<code>auto</code>，其他必须为特定值，或者默认为0.</li>\n<li>2、外边距可以为负、其他不能。<code>width</code>默认为<code>auto</code>、其他默认为0.</li>\n<li>3、七个水平布局属性之和等于父元素的<code>width</code>，只要所有所有属性都是大于或者等于0，元素就不会超过父元素的内容区域。</li>\n<li>4、如果外边距离与<code>width</code>都设置为特定值且之和大于父元素的<code>width</code>，右边距会重置为<code>auto</code>。</li>\n<li>5、如果只有一个设置为<code>auto</code>，其会根据公式计算。</li>\n<li>6、如果参数之和大于父元素的<code>width</code>且<code>margin-right</code>设置为<code>auto</code>，则会重置<code>margin-right</code>以适配公式(如果没有设置<code>margin-right</code>为<code>auto</code>则会保持设置值)</li>\n</ul>\n<hr>\n<h2 id=\"块级元素的垂直格式化\"><a href=\"#块级元素的垂直格式化\" class=\"headerlink\" title=\"块级元素的垂直格式化\"></a>块级元素的垂直格式化</h2><ul>\n<li>1、高度默认由其内容决定、受到内容宽度影响</li>\n<li>2、七个属性的值必须等于元素包含的<code>height</code></li>\n<li>3、七个属性只有三个可以设置为<code>auto</code></li>\n<li>4、如果把上下外边距设置为<code>auto</code>，那么它会自动计算为0</li>\n<li>5、如果块级正常流元素的高度设置为<code>auto</code>,而且只有块级子元素，其默认高度是最高元素外边框(border)边界到最低子元素外边框边界的距离。</li>\n<li>6、如果给包含块设置<code>边框</code>或者内边距时，包含块的高度会把子元素的外边距(margin)包含在内</li>\n<li>7、垂直负外边距合并规则：<ul>\n<li>如果两个外边距都是负，浏览器取绝对值比较大的那个数</li>\n<li>如果一正一负，浏览器会用正外边距减去负外边距的绝对值</li>\n<li>行内框、浮动定位、和绝对定位元素之间的外边距不会叠加(外边距合并只发生在正常流元素)</li>\n</ul>\n</li>\n</ul>\n<hr>\n<h2 id=\"行内元素布局的基本概念\"><a href=\"#行内元素布局的基本概念\" class=\"headerlink\" title=\"行内元素布局的基本概念\"></a>行内元素布局的基本概念</h2><ul>\n<li>1、<code>em</code>框： <code>font-size</code>大小确定</li>\n<li><p>2、内容区</p>\n<ul>\n<li>行内非替换元素：等于<code>em</code>框</li>\n<li>行内替换元素：元素固有宽高、加上边距、边框</li>\n</ul>\n</li>\n<li><p>3、行间距</p>\n<ul>\n<li>行内非替换元素：等于<code>font-size</code>与<code>line-height</code>的差</li>\n<li>行内替换元素：没有行间距的概念</li>\n</ul>\n</li>\n<li><p>4、行内框</p>\n<ul>\n<li>行内非替换元素：等于<code>line-height</code></li>\n<li>行内替换元素：等于内容区</li>\n</ul>\n</li>\n</ul>\n<hr>\n<h2 id=\"行内元素布局一些有用的概念\"><a href=\"#行内元素布局一些有用的概念\" class=\"headerlink\" title=\"行内元素布局一些有用的概念\"></a>行内元素布局一些有用的概念</h2><ul>\n<li>1、内容区类似于块级元素的内容框</li>\n<li>2、行内元素背景作用于内容区以及内边距</li>\n<li>3、行内元素的边框包围内容区、内边距</li>\n<li>4、非替换元素的边框、边距不会影响行内框高度</li>\n<li>5、替换元素的边距、边框会影响行内框高度</li>\n<li>6、可以为除了行内非替换元素外的任意元素设置垂直外边距</li>\n</ul>\n<hr>\n<h1 id=\"关于百分数参数\"><a href=\"#关于百分数参数\" class=\"headerlink\" title=\"关于百分数参数\"></a>关于百分数参数</h1><ul>\n<li>1、对<code>margin/padding</code>使用百分比将会相对于包含块的内容区宽度计算</li>\n<li>2、对于<code>height</code>属性使用百分比将会相对于包含块内容区的高度计算</li>\n<li>3、对于定位元素(<code>position</code>属性非<code>static</code>)的<code>top</code>、<code>bottom</code>属性使用百分比将会相对于包含块高度计算</li>\n<li>4、不允许对<code>border</code>属性使用百分比</li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"视觉格式化基本概念总结\"><a href=\"#视觉格式化基本概念总结\" class=\"headerlink\" title=\"视觉格式化基本概念总结\"></a>视觉格式化基本概念总结</h1><h2 id=\"块级元素水平格式化\"><a href=\"#块级元素水平格式化\" class=\"headerlink\" title=\"块级元素水平格式化\"></a>块级元素水平格式化</h2><ul>\n<li>1、水平格式化七个属性，只有宽度、左右外边距可以设置为<code>auto</code>，其他必须为特定值，或者默认为0.</li>\n<li>2、外边距可以为负、其他不能。<code>width</code>默认为<code>auto</code>、其他默认为0.</li>\n<li>3、七个水平布局属性之和等于父元素的<code>width</code>，只要所有所有属性都是大于或者等于0，元素就不会超过父元素的内容区域。</li>\n<li>4、如果外边距离与<code>width</code>都设置为特定值且之和大于父元素的<code>width</code>，右边距会重置为<code>auto</code>。</li>\n<li>5、如果只有一个设置为<code>auto</code>，其会根据公式计算。</li>\n<li>6、如果参数之和大于父元素的<code>width</code>且<code>margin-right</code>设置为<code>auto</code>，则会重置<code>margin-right</code>以适配公式(如果没有设置<code>margin-right</code>为<code>auto</code>则会保持设置值)</li>\n</ul>\n<hr>\n<h2 id=\"块级元素的垂直格式化\"><a href=\"#块级元素的垂直格式化\" class=\"headerlink\" title=\"块级元素的垂直格式化\"></a>块级元素的垂直格式化</h2><ul>\n<li>1、高度默认由其内容决定、受到内容宽度影响</li>\n<li>2、七个属性的值必须等于元素包含的<code>height</code></li>\n<li>3、七个属性只有三个可以设置为<code>auto</code></li>\n<li>4、如果把上下外边距设置为<code>auto</code>，那么它会自动计算为0</li>\n<li>5、如果块级正常流元素的高度设置为<code>auto</code>,而且只有块级子元素，其默认高度是最高元素外边框(border)边界到最低子元素外边框边界的距离。</li>\n<li>6、如果给包含块设置<code>边框</code>或者内边距时，包含块的高度会把子元素的外边距(margin)包含在内</li>\n<li>7、垂直负外边距合并规则：<ul>\n<li>如果两个外边距都是负，浏览器取绝对值比较大的那个数</li>\n<li>如果一正一负，浏览器会用正外边距减去负外边距的绝对值</li>\n<li>行内框、浮动定位、和绝对定位元素之间的外边距不会叠加(外边距合并只发生在正常流元素)</li>\n</ul>\n</li>\n</ul>\n<hr>\n<h2 id=\"行内元素布局的基本概念\"><a href=\"#行内元素布局的基本概念\" class=\"headerlink\" title=\"行内元素布局的基本概念\"></a>行内元素布局的基本概念</h2><ul>\n<li>1、<code>em</code>框： <code>font-size</code>大小确定</li>\n<li><p>2、内容区</p>\n<ul>\n<li>行内非替换元素：等于<code>em</code>框</li>\n<li>行内替换元素：元素固有宽高、加上边距、边框</li>\n</ul>\n</li>\n<li><p>3、行间距</p>\n<ul>\n<li>行内非替换元素：等于<code>font-size</code>与<code>line-height</code>的差</li>\n<li>行内替换元素：没有行间距的概念</li>\n</ul>\n</li>\n<li><p>4、行内框</p>\n<ul>\n<li>行内非替换元素：等于<code>line-height</code></li>\n<li>行内替换元素：等于内容区</li>\n</ul>\n</li>\n</ul>\n<hr>\n<h2 id=\"行内元素布局一些有用的概念\"><a href=\"#行内元素布局一些有用的概念\" class=\"headerlink\" title=\"行内元素布局一些有用的概念\"></a>行内元素布局一些有用的概念</h2><ul>\n<li>1、内容区类似于块级元素的内容框</li>\n<li>2、行内元素背景作用于内容区以及内边距</li>\n<li>3、行内元素的边框包围内容区、内边距</li>\n<li>4、非替换元素的边框、边距不会影响行内框高度</li>\n<li>5、替换元素的边距、边框会影响行内框高度</li>\n<li>6、可以为除了行内非替换元素外的任意元素设置垂直外边距</li>\n</ul>\n<hr>\n<h1 id=\"关于百分数参数\"><a href=\"#关于百分数参数\" class=\"headerlink\" title=\"关于百分数参数\"></a>关于百分数参数</h1><ul>\n<li>1、对<code>margin/padding</code>使用百分比将会相对于包含块的内容区宽度计算</li>\n<li>2、对于<code>height</code>属性使用百分比将会相对于包含块内容区的高度计算</li>\n<li>3、对于定位元素(<code>position</code>属性非<code>static</code>)的<code>top</code>、<code>bottom</code>属性使用百分比将会相对于包含块高度计算</li>\n<li>4、不允许对<code>border</code>属性使用百分比</li>\n</ul>\n"},{"title":"async-tutorial","date":"2016-06-07T11:37:24.000Z","_content":"`async`是一个强大的异步流程控制库，其语义类似于`js`对数组的操作。它提供了一系列非常强大而便捷的方法，有助于我们在`javascript`单线程模型背景下写出优雅的逻辑控制代码。  \n\n### **牛刀小试**   \n先从文件操作开始初步了解`async`函数库的作用：  \n\n+ 使用`filter`过滤出磁盘中存在的文件  \n\n```javascript\nconst fs = require('fs');  \nconst async = require('async');  \n\nasync.filter(['f1', 'f2', 'f3'], function(it, callback) {\n    fs.access(it, function(err) {\n      callback(null, !err);\n    });\n}, function(err, results) {\n  console.log(results);\n});\n\n```  \n假设当前目录下存在以上三个文件，那么`results`输出为：  \n```javascript\n['f1', 'f2', 'f3']\n```  \n\n+ 使用`map`判断文件是否存在  \n```javascript\nasync.map(['f1', 'f2', 'f3'], function(it, callback) {\n  fs.exists(function(exists) {\n      callback(null, exists);\n  });\n}, function(err, results) {\n    console.log(results);//[true, true, true]\n});\n```  \n\n>以上两个例子分别使用了`access`与`exists`判断文件是否存在，关于两个`API`的详细说明，请查看`nodejs`[官方文档](https://nodejs.org/dist/latest-v6.x/docs/api/fs.html#fs_fs_exists_path_callback)  \n\n\n+ 常用的多任务并行   \n\n```javascript  \nfunction asyncTask(delay, arg) {\n    return function(callback) {\n        setTimeout(function() {\n            console.log(arg + \"done\");\n            callback(null, arg);\n        }, delay);\n    };\n}\n\nasync.parallel([\n    asyncTask(10, \"task1\"),\n    asyncTask(1, \"task2\"),\n    asyncTask(100, \"task3\"),\n], function(err, ret) {\n    console.log(ret);\n});\n\n```  \n`asyncTask`输出的顺序依次为：\n```javascript  \n\n[luncher@localhost async]$ node app.js\ntask2done\ntask1done\ntask3done\n//ret\n[ 'task1', 'task2', 'task3' ]\n\n```  \n可见虽然任务是并行的，但是最终的结果依然按照任务数组的顺序排列。  \n\n+ 顺序执行任务  \n\n```javascript  \n\nfunction asyncTask(delay, arg) {\n    return function(callback) {\n        setTimeout(function() {\n            console.log(arg + \"done\");\n            callback(null, arg);\n        }, delay);\n    };\n}\n\nasync.series([\n    asyncTask(10, \"task1\"),\n    asyncTask(1, \"task2\"),\n    asyncTask(100, \"task3\"),\n], function(err, ret) {\n    console.log(ret);\n});\n\n```  \n\n输出：  \n\n```javascript  \n[luncher@localhost async]$ node app.js\ntask1done\ntask2done\ntask3done\n[ 'task1', 'task2', 'task3' ]  \n```  \n可以看到任务按照传入的顺序依次执行。  \n\n---   \n\n### 集合类型多任务处理  \n- `each`  \n`each`函数依次遍历数组执行回调函数：  \n\n```javascript  \n\nfunction readFile(file, callback) {\n    fs.readFile(file, function(err, ret) {\n        console.log(\"readFile \"+ file + \" done\");\n        callback(err);\n    });\n}\n\nasync.each(['f1', 'f2', 'f3'], readFile, function(err) {\n    console.log(\"all done\");\n});\n\n```  \n**需要注意的是，each不能保证迭代函数完成的顺序，这取决于用户的具体任务**  \n\n- `forEachOf`  \n\n`each`函数可以对数组进行遍历，如果想要遍历的是一个对象，那么需要用到`forEachOf`.  \n\n```javascript  \nfunction readFile(file, k, callback) {\n    fs.readFile(file, function(err, ret) {\n        console.log(\"readFile \"+ k + \" \" + file + \" done\");\n        callback(err);\n    });\n}\n\nasync.forEachOf({k1: \"f1\", k2: \"f2\", k3: \"f3\"}, readFile, function(err) {\n    console.log(\"all done\");\n});\n```  \n\n迭代函数第一个参数是`value`，第二个参数是`key`.  \n\n- 控制`each`和`foEachOf`的顺序  \n` eachSeries`与`forEachOf`都是用来控制迭代函数的顺序执行：  \n\n```javascript  \n\nfunction readFile(file, k, callback) {\n    fs.readFile(file, function(err, ret) {\n        console.log(\"readFile \"+ k + \" \" + file + \" done\");\n        callback(err);\n    });\n}\n\nasync.forEachOfSeries({k1: \"f1\", k2: \"f2\", k3: \"f3\"}, readFile, function(err) {\n    console.log(\"all done\");\n});\n\n```  \n\n这样程序的输出始终是：  \n\n\n```javascript\n[luncher@localhost async]$ node app.js\nreadFile k1 f1 done  \nreadFile k2 f2 done\nreadFile k3 f3 done\nall done\n\n```\n\n+ 使用`apply`包装异步任务  \n\n前面几个异步任务都需要人为的额外写一个函数，如`asyncTask`，`async`提供一个`apply`语法糖用于解决此类问题：  \n\n```javascript  \n\n// 使用 apply\n\nasync.parallel([\n    async.apply(fs.writeFile, 'testfile1', 'test1'),\n    async.apply(fs.writeFile, 'testfile2', 'test2'),\n]);\n\n\n// 等同于\n\nasync.parallel([\n    function(callback){\n        fs.writeFile('testfile1', 'test1', callback);\n    },\n    function(callback){\n        fs.writeFile('testfile2', 'test2', callback);\n    }\n]);\n\n```  \n\n\n+ 使用`Limit`类函数控制并发数量  \n\n`async`为每个接口都提供了一个`Limit`参数，用户限制并发数量，我们利用`filterLimit`做一个简单的测试：  \n\n```javascript\n\nvar count = 0;\nasync.filterLimit([1, 10, 28, 90, 10], 2, function(it, callback) {\n    count++;\n    console.log(it + \"开始\");\n    console.log(\"并发数：\", count);\n    setTimeout(function() {\n        count--;\n        console.log(it + \"结束\");\n        callback(null);\n    }, it);\n}, function(results) {\n    console.log(results);\n});\n\n```  \n输出：  \n\n```javascript  \n[luncher@localhost async]$ node app.js \n1开始\n并发数： 1\n10开始\n并发数： 2\n1结束\n28开始\n并发数： 2\n10结束\n90开始\n并发数： 2\n28结束\n10开始\n并发数： 2\n10结束\n90结束\nnull\n\n```  \n\n可以看到，最大并发数也就是`2`，虽然待执行任务大于`2`.  \n\n`async`几乎提供了全类数组操作类型的接口，例如：`sortBy`、`reduce`、`some`等，这里不再一一展开。  \n\n### 异步控制函数  \n\n前面介绍了两个异步流程控制函数：`series`和`parallel`。下面介绍其他几个流程控制函数：    \n\n+ 使用`whilst`实现`while`操作  \n\n`whilst`用于实现，类似于`while`的效果，直到满足条件，否则持续执行回调函数。  \n\n```javascript  \nvar c = 0;\n\nasync.whilst(function() {\n    console.log(\"judge\");\n    return c < 3;\n}, function(callback) {\n    c++;\n    console.log(\"try \" + c);\n    setTimeout(function() {\n        callback(null, c);\n    }, 1000);\n}, function(err, val) {\n    console.log('err', err);\n    console.log('value: ', val);\n});\n\n```  \n输出：  \n\n```javascript  \n[luncher@localhost async]$ node app.js \njudge\ntry 1\njudge\ntry 2\njudge\ntry 3\njudge\nerr null\nvalue:  3\n```  \n\n+ 使用`waterFall`解决异步任务依赖问题  \n\n```javascript  \nasync.waterfall([\n    function(callback) {\n        callback(null, 'one', 'two');\n    },\n    function(arg1, arg2, callback) {\n      // arg1 now equals 'one' and arg2 now equals 'two'\n        callback(null, 'three');\n    },\n    function(arg1, callback) {\n        // arg1 now equals 'three'\n        callback(null, 'done');\n    }\n], function (err, result) {\n    // result now equals 'done'\n});\n```  \n\n\n","source":"_posts/async-tutorial.md","raw":"---\ntitle: async-tutorial\ncategories: server\ndate: 2016-06-07 19:37:24\n---\n`async`是一个强大的异步流程控制库，其语义类似于`js`对数组的操作。它提供了一系列非常强大而便捷的方法，有助于我们在`javascript`单线程模型背景下写出优雅的逻辑控制代码。  \n\n### **牛刀小试**   \n先从文件操作开始初步了解`async`函数库的作用：  \n\n+ 使用`filter`过滤出磁盘中存在的文件  \n\n```javascript\nconst fs = require('fs');  \nconst async = require('async');  \n\nasync.filter(['f1', 'f2', 'f3'], function(it, callback) {\n    fs.access(it, function(err) {\n      callback(null, !err);\n    });\n}, function(err, results) {\n  console.log(results);\n});\n\n```  \n假设当前目录下存在以上三个文件，那么`results`输出为：  \n```javascript\n['f1', 'f2', 'f3']\n```  \n\n+ 使用`map`判断文件是否存在  \n```javascript\nasync.map(['f1', 'f2', 'f3'], function(it, callback) {\n  fs.exists(function(exists) {\n      callback(null, exists);\n  });\n}, function(err, results) {\n    console.log(results);//[true, true, true]\n});\n```  \n\n>以上两个例子分别使用了`access`与`exists`判断文件是否存在，关于两个`API`的详细说明，请查看`nodejs`[官方文档](https://nodejs.org/dist/latest-v6.x/docs/api/fs.html#fs_fs_exists_path_callback)  \n\n\n+ 常用的多任务并行   \n\n```javascript  \nfunction asyncTask(delay, arg) {\n    return function(callback) {\n        setTimeout(function() {\n            console.log(arg + \"done\");\n            callback(null, arg);\n        }, delay);\n    };\n}\n\nasync.parallel([\n    asyncTask(10, \"task1\"),\n    asyncTask(1, \"task2\"),\n    asyncTask(100, \"task3\"),\n], function(err, ret) {\n    console.log(ret);\n});\n\n```  \n`asyncTask`输出的顺序依次为：\n```javascript  \n\n[luncher@localhost async]$ node app.js\ntask2done\ntask1done\ntask3done\n//ret\n[ 'task1', 'task2', 'task3' ]\n\n```  \n可见虽然任务是并行的，但是最终的结果依然按照任务数组的顺序排列。  \n\n+ 顺序执行任务  \n\n```javascript  \n\nfunction asyncTask(delay, arg) {\n    return function(callback) {\n        setTimeout(function() {\n            console.log(arg + \"done\");\n            callback(null, arg);\n        }, delay);\n    };\n}\n\nasync.series([\n    asyncTask(10, \"task1\"),\n    asyncTask(1, \"task2\"),\n    asyncTask(100, \"task3\"),\n], function(err, ret) {\n    console.log(ret);\n});\n\n```  \n\n输出：  \n\n```javascript  \n[luncher@localhost async]$ node app.js\ntask1done\ntask2done\ntask3done\n[ 'task1', 'task2', 'task3' ]  \n```  \n可以看到任务按照传入的顺序依次执行。  \n\n---   \n\n### 集合类型多任务处理  \n- `each`  \n`each`函数依次遍历数组执行回调函数：  \n\n```javascript  \n\nfunction readFile(file, callback) {\n    fs.readFile(file, function(err, ret) {\n        console.log(\"readFile \"+ file + \" done\");\n        callback(err);\n    });\n}\n\nasync.each(['f1', 'f2', 'f3'], readFile, function(err) {\n    console.log(\"all done\");\n});\n\n```  \n**需要注意的是，each不能保证迭代函数完成的顺序，这取决于用户的具体任务**  \n\n- `forEachOf`  \n\n`each`函数可以对数组进行遍历，如果想要遍历的是一个对象，那么需要用到`forEachOf`.  \n\n```javascript  \nfunction readFile(file, k, callback) {\n    fs.readFile(file, function(err, ret) {\n        console.log(\"readFile \"+ k + \" \" + file + \" done\");\n        callback(err);\n    });\n}\n\nasync.forEachOf({k1: \"f1\", k2: \"f2\", k3: \"f3\"}, readFile, function(err) {\n    console.log(\"all done\");\n});\n```  \n\n迭代函数第一个参数是`value`，第二个参数是`key`.  \n\n- 控制`each`和`foEachOf`的顺序  \n` eachSeries`与`forEachOf`都是用来控制迭代函数的顺序执行：  \n\n```javascript  \n\nfunction readFile(file, k, callback) {\n    fs.readFile(file, function(err, ret) {\n        console.log(\"readFile \"+ k + \" \" + file + \" done\");\n        callback(err);\n    });\n}\n\nasync.forEachOfSeries({k1: \"f1\", k2: \"f2\", k3: \"f3\"}, readFile, function(err) {\n    console.log(\"all done\");\n});\n\n```  \n\n这样程序的输出始终是：  \n\n\n```javascript\n[luncher@localhost async]$ node app.js\nreadFile k1 f1 done  \nreadFile k2 f2 done\nreadFile k3 f3 done\nall done\n\n```\n\n+ 使用`apply`包装异步任务  \n\n前面几个异步任务都需要人为的额外写一个函数，如`asyncTask`，`async`提供一个`apply`语法糖用于解决此类问题：  \n\n```javascript  \n\n// 使用 apply\n\nasync.parallel([\n    async.apply(fs.writeFile, 'testfile1', 'test1'),\n    async.apply(fs.writeFile, 'testfile2', 'test2'),\n]);\n\n\n// 等同于\n\nasync.parallel([\n    function(callback){\n        fs.writeFile('testfile1', 'test1', callback);\n    },\n    function(callback){\n        fs.writeFile('testfile2', 'test2', callback);\n    }\n]);\n\n```  \n\n\n+ 使用`Limit`类函数控制并发数量  \n\n`async`为每个接口都提供了一个`Limit`参数，用户限制并发数量，我们利用`filterLimit`做一个简单的测试：  \n\n```javascript\n\nvar count = 0;\nasync.filterLimit([1, 10, 28, 90, 10], 2, function(it, callback) {\n    count++;\n    console.log(it + \"开始\");\n    console.log(\"并发数：\", count);\n    setTimeout(function() {\n        count--;\n        console.log(it + \"结束\");\n        callback(null);\n    }, it);\n}, function(results) {\n    console.log(results);\n});\n\n```  \n输出：  \n\n```javascript  \n[luncher@localhost async]$ node app.js \n1开始\n并发数： 1\n10开始\n并发数： 2\n1结束\n28开始\n并发数： 2\n10结束\n90开始\n并发数： 2\n28结束\n10开始\n并发数： 2\n10结束\n90结束\nnull\n\n```  \n\n可以看到，最大并发数也就是`2`，虽然待执行任务大于`2`.  \n\n`async`几乎提供了全类数组操作类型的接口，例如：`sortBy`、`reduce`、`some`等，这里不再一一展开。  \n\n### 异步控制函数  \n\n前面介绍了两个异步流程控制函数：`series`和`parallel`。下面介绍其他几个流程控制函数：    \n\n+ 使用`whilst`实现`while`操作  \n\n`whilst`用于实现，类似于`while`的效果，直到满足条件，否则持续执行回调函数。  \n\n```javascript  \nvar c = 0;\n\nasync.whilst(function() {\n    console.log(\"judge\");\n    return c < 3;\n}, function(callback) {\n    c++;\n    console.log(\"try \" + c);\n    setTimeout(function() {\n        callback(null, c);\n    }, 1000);\n}, function(err, val) {\n    console.log('err', err);\n    console.log('value: ', val);\n});\n\n```  \n输出：  \n\n```javascript  \n[luncher@localhost async]$ node app.js \njudge\ntry 1\njudge\ntry 2\njudge\ntry 3\njudge\nerr null\nvalue:  3\n```  \n\n+ 使用`waterFall`解决异步任务依赖问题  \n\n```javascript  \nasync.waterfall([\n    function(callback) {\n        callback(null, 'one', 'two');\n    },\n    function(arg1, arg2, callback) {\n      // arg1 now equals 'one' and arg2 now equals 'two'\n        callback(null, 'three');\n    },\n    function(arg1, callback) {\n        // arg1 now equals 'three'\n        callback(null, 'done');\n    }\n], function (err, result) {\n    // result now equals 'done'\n});\n```  \n\n\n","slug":"async-tutorial","published":1,"updated":"2018-07-01T10:30:46.494Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cdi0021y4zvajg42ktn","content":"<p><code>async</code>是一个强大的异步流程控制库，其语义类似于<code>js</code>对数组的操作。它提供了一系列非常强大而便捷的方法，有助于我们在<code>javascript</code>单线程模型背景下写出优雅的逻辑控制代码。  </p>\n<h3 id=\"牛刀小试\"><a href=\"#牛刀小试\" class=\"headerlink\" title=\"牛刀小试\"></a><strong>牛刀小试</strong></h3><p>先从文件操作开始初步了解<code>async</code>函数库的作用：  </p>\n<ul>\n<li>使用<code>filter</code>过滤出磁盘中存在的文件  </li>\n</ul>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> fs = <span class=\"built_in\">require</span>(<span class=\"string\">'fs'</span>);  </span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"keyword\">async</span> = <span class=\"built_in\">require</span>(<span class=\"string\">'async'</span>);  </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">async</span>.filter([<span class=\"string\">'f1'</span>, <span class=\"string\">'f2'</span>, <span class=\"string\">'f3'</span>], <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">it, callback</span>) </span>&#123;</span><br><span class=\"line\">    fs.access(it, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">err</span>) </span>&#123;</span><br><span class=\"line\">      callback(<span class=\"literal\">null</span>, !err);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">&#125;, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">err, results</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(results);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\">假设当前目录下存在以上三个文件，那么`</span>results<span class=\"string\">`输出为：  </span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript</span><br><span class=\"line\">[<span class=\"string\">'f1'</span>, <span class=\"string\">'f2'</span>, <span class=\"string\">'f3'</span>]</span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">+ 使用`</span>map<span class=\"string\">`判断文件是否存在  </span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript</span><br><span class=\"line\"><span class=\"keyword\">async</span>.map([<span class=\"string\">'f1'</span>, <span class=\"string\">'f2'</span>, <span class=\"string\">'f3'</span>], <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">it, callback</span>) </span>&#123;</span><br><span class=\"line\">  fs.exists(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">exists</span>) </span>&#123;</span><br><span class=\"line\">      callback(<span class=\"literal\">null</span>, exists);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">err, results</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(results);<span class=\"comment\">//[true, true, true]</span></span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&gt;以上两个例子分别使用了`</span>access<span class=\"string\">`与`</span>exists<span class=\"string\">`判断文件是否存在，关于两个`</span>API<span class=\"string\">`的详细说明，请查看`</span>nodejs<span class=\"string\">`[官方文档](https://nodejs.org/dist/latest-v6.x/docs/api/fs.html#fs_fs_exists_path_callback)  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">+ 常用的多任务并行   </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript  </span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">asyncTask</span>(<span class=\"params\">delay, arg</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">callback</span>) </span>&#123;</span><br><span class=\"line\">        setTimeout(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">            <span class=\"built_in\">console</span>.log(arg + <span class=\"string\">\"done\"</span>);</span><br><span class=\"line\">            callback(<span class=\"literal\">null</span>, arg);</span><br><span class=\"line\">        &#125;, delay);</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">async</span>.parallel([</span><br><span class=\"line\">    asyncTask(<span class=\"number\">10</span>, <span class=\"string\">\"task1\"</span>),</span><br><span class=\"line\">    asyncTask(<span class=\"number\">1</span>, <span class=\"string\">\"task2\"</span>),</span><br><span class=\"line\">    asyncTask(<span class=\"number\">100</span>, <span class=\"string\">\"task3\"</span>),</span><br><span class=\"line\">], <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">err, ret</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(ret);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\">`</span>asyncTask<span class=\"string\">`输出的顺序依次为：</span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript  </span><br><span class=\"line\"></span><br><span class=\"line\">[luncher@localhost <span class=\"keyword\">async</span>]$ node app.js</span><br><span class=\"line\">task2done</span><br><span class=\"line\">task1done</span><br><span class=\"line\">task3done</span><br><span class=\"line\"><span class=\"comment\">//ret</span></span><br><span class=\"line\">[ <span class=\"string\">'task1'</span>, <span class=\"string\">'task2'</span>, <span class=\"string\">'task3'</span> ]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\">可见虽然任务是并行的，但是最终的结果依然按照任务数组的顺序排列。  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">+ 顺序执行任务  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript  </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">asyncTask</span>(<span class=\"params\">delay, arg</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">callback</span>) </span>&#123;</span><br><span class=\"line\">        setTimeout(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">            <span class=\"built_in\">console</span>.log(arg + <span class=\"string\">\"done\"</span>);</span><br><span class=\"line\">            callback(<span class=\"literal\">null</span>, arg);</span><br><span class=\"line\">        &#125;, delay);</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">async</span>.series([</span><br><span class=\"line\">    asyncTask(<span class=\"number\">10</span>, <span class=\"string\">\"task1\"</span>),</span><br><span class=\"line\">    asyncTask(<span class=\"number\">1</span>, <span class=\"string\">\"task2\"</span>),</span><br><span class=\"line\">    asyncTask(<span class=\"number\">100</span>, <span class=\"string\">\"task3\"</span>),</span><br><span class=\"line\">], <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">err, ret</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(ret);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">输出：  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript  </span><br><span class=\"line\">[luncher@localhost <span class=\"keyword\">async</span>]$ node app.js</span><br><span class=\"line\">task1done</span><br><span class=\"line\">task2done</span><br><span class=\"line\">task3done</span><br><span class=\"line\">[ <span class=\"string\">'task1'</span>, <span class=\"string\">'task2'</span>, <span class=\"string\">'task3'</span> ]  </span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\">可以看到任务按照传入的顺序依次执行。  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">---   </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">### 集合类型多任务处理  </span></span><br><span class=\"line\"><span class=\"string\">- `</span>each<span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\">`</span>each<span class=\"string\">`函数依次遍历数组执行回调函数：  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript  </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">readFile</span>(<span class=\"params\">file, callback</span>) </span>&#123;</span><br><span class=\"line\">    fs.readFile(file, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">err, ret</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(<span class=\"string\">\"readFile \"</span>+ file + <span class=\"string\">\" done\"</span>);</span><br><span class=\"line\">        callback(err);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">async</span>.each([<span class=\"string\">'f1'</span>, <span class=\"string\">'f2'</span>, <span class=\"string\">'f3'</span>], readFile, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">err</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">\"all done\"</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\">**需要注意的是，each不能保证迭代函数完成的顺序，这取决于用户的具体任务**  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- `</span>forEachOf<span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">`</span>each<span class=\"string\">`函数可以对数组进行遍历，如果想要遍历的是一个对象，那么需要用到`</span>forEachOf<span class=\"string\">`.  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript  </span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">readFile</span>(<span class=\"params\">file, k, callback</span>) </span>&#123;</span><br><span class=\"line\">    fs.readFile(file, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">err, ret</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(<span class=\"string\">\"readFile \"</span>+ k + <span class=\"string\">\" \"</span> + file + <span class=\"string\">\" done\"</span>);</span><br><span class=\"line\">        callback(err);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">async</span>.forEachOf(&#123;<span class=\"attr\">k1</span>: <span class=\"string\">\"f1\"</span>, <span class=\"attr\">k2</span>: <span class=\"string\">\"f2\"</span>, <span class=\"attr\">k3</span>: <span class=\"string\">\"f3\"</span>&#125;, readFile, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">err</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">\"all done\"</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">迭代函数第一个参数是`</span>value<span class=\"string\">`，第二个参数是`</span>key<span class=\"string\">`.  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- 控制`</span>each<span class=\"string\">`和`</span>foEachOf<span class=\"string\">`的顺序  </span></span><br><span class=\"line\"><span class=\"string\">`</span> eachSeries<span class=\"string\">`与`</span>forEachOf<span class=\"string\">`都是用来控制迭代函数的顺序执行：  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript  </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">readFile</span>(<span class=\"params\">file, k, callback</span>) </span>&#123;</span><br><span class=\"line\">    fs.readFile(file, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">err, ret</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(<span class=\"string\">\"readFile \"</span>+ k + <span class=\"string\">\" \"</span> + file + <span class=\"string\">\" done\"</span>);</span><br><span class=\"line\">        callback(err);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">async</span>.forEachOfSeries(&#123;<span class=\"attr\">k1</span>: <span class=\"string\">\"f1\"</span>, <span class=\"attr\">k2</span>: <span class=\"string\">\"f2\"</span>, <span class=\"attr\">k3</span>: <span class=\"string\">\"f3\"</span>&#125;, readFile, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">err</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">\"all done\"</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">这样程序的输出始终是：  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript</span><br><span class=\"line\">[luncher@localhost <span class=\"keyword\">async</span>]$ node app.js</span><br><span class=\"line\">readFile k1 f1 done  </span><br><span class=\"line\">readFile k2 f2 done</span><br><span class=\"line\">readFile k3 f3 done</span><br><span class=\"line\">all done</span><br></pre></td></tr></table></figure>\n<ul>\n<li>使用<code>apply</code>包装异步任务  </li>\n</ul>\n<p>前面几个异步任务都需要人为的额外写一个函数，如<code>asyncTask</code>，<code>async</code>提供一个<code>apply</code>语法糖用于解决此类问题：  </p>\n<pre><code class=\"javascript\">\n<span class=\"comment\">// 使用 apply</span>\n\n<span class=\"keyword\">async</span>.parallel([\n    <span class=\"keyword\">async</span>.apply(fs.writeFile, <span class=\"string\">'testfile1'</span>, <span class=\"string\">'test1'</span>),\n    <span class=\"keyword\">async</span>.apply(fs.writeFile, <span class=\"string\">'testfile2'</span>, <span class=\"string\">'test2'</span>),\n]);\n\n\n<span class=\"comment\">// 等同于</span>\n\n<span class=\"keyword\">async</span>.parallel([\n    <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">callback</span>)</span>{\n        fs.writeFile(<span class=\"string\">'testfile1'</span>, <span class=\"string\">'test1'</span>, callback);\n    },\n    <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">callback</span>)</span>{\n        fs.writeFile(<span class=\"string\">'testfile2'</span>, <span class=\"string\">'test2'</span>, callback);\n    }\n]);\n\n</code></pre>\n<ul>\n<li>使用<code>Limit</code>类函数控制并发数量  </li>\n</ul>\n<p><code>async</code>为每个接口都提供了一个<code>Limit</code>参数，用户限制并发数量，我们利用<code>filterLimit</code>做一个简单的测试：  </p>\n<pre><code class=\"javascript\">\n<span class=\"keyword\">var</span> count = <span class=\"number\">0</span>;\n<span class=\"keyword\">async</span>.filterLimit([<span class=\"number\">1</span>, <span class=\"number\">10</span>, <span class=\"number\">28</span>, <span class=\"number\">90</span>, <span class=\"number\">10</span>], <span class=\"number\">2</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">it, callback</span>) </span>{\n    count++;\n    <span class=\"built_in\">console</span>.log(it + <span class=\"string\">\"开始\"</span>);\n    <span class=\"built_in\">console</span>.log(<span class=\"string\">\"并发数：\"</span>, count);\n    setTimeout(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>{\n        count--;\n        <span class=\"built_in\">console</span>.log(it + <span class=\"string\">\"结束\"</span>);\n        callback(<span class=\"literal\">null</span>);\n    }, it);\n}, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">results</span>) </span>{\n    <span class=\"built_in\">console</span>.log(results);\n});\n\n</code></pre>\n<p>输出：  </p>\n<pre><code class=\"javascript\">[luncher@localhost <span class=\"keyword\">async</span>]$ node app.js \n<span class=\"number\">1</span>开始\n并发数： <span class=\"number\">1</span>\n<span class=\"number\">10</span>开始\n并发数： <span class=\"number\">2</span>\n<span class=\"number\">1</span>结束\n<span class=\"number\">28</span>开始\n并发数： <span class=\"number\">2</span>\n<span class=\"number\">10</span>结束\n<span class=\"number\">90</span>开始\n并发数： <span class=\"number\">2</span>\n<span class=\"number\">28</span>结束\n<span class=\"number\">10</span>开始\n并发数： <span class=\"number\">2</span>\n<span class=\"number\">10</span>结束\n<span class=\"number\">90</span>结束\n<span class=\"literal\">null</span>\n\n</code></pre>\n<p>可以看到，最大并发数也就是<code>2</code>，虽然待执行任务大于<code>2</code>.  </p>\n<p><code>async</code>几乎提供了全类数组操作类型的接口，例如：<code>sortBy</code>、<code>reduce</code>、<code>some</code>等，这里不再一一展开。  </p>\n<h3 id=\"异步控制函数\"><a href=\"#异步控制函数\" class=\"headerlink\" title=\"异步控制函数\"></a>异步控制函数</h3><p>前面介绍了两个异步流程控制函数：<code>series</code>和<code>parallel</code>。下面介绍其他几个流程控制函数：    </p>\n<ul>\n<li>使用<code>whilst</code>实现<code>while</code>操作  </li>\n</ul>\n<p><code>whilst</code>用于实现，类似于<code>while</code>的效果，直到满足条件，否则持续执行回调函数。  </p>\n<pre><code class=\"javascript\"><span class=\"keyword\">var</span> c = <span class=\"number\">0</span>;\n\n<span class=\"keyword\">async</span>.whilst(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>{\n    <span class=\"built_in\">console</span>.log(<span class=\"string\">\"judge\"</span>);\n    <span class=\"keyword\">return</span> c &lt; <span class=\"number\">3</span>;\n}, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">callback</span>) </span>{\n    c++;\n    <span class=\"built_in\">console</span>.log(<span class=\"string\">\"try \"</span> + c);\n    setTimeout(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>{\n        callback(<span class=\"literal\">null</span>, c);\n    }, <span class=\"number\">1000</span>);\n}, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">err, val</span>) </span>{\n    <span class=\"built_in\">console</span>.log(<span class=\"string\">'err'</span>, err);\n    <span class=\"built_in\">console</span>.log(<span class=\"string\">'value: '</span>, val);\n});\n\n</code></pre>\n<p>输出：  </p>\n<pre><code class=\"javascript\">[luncher@localhost <span class=\"keyword\">async</span>]$ node app.js \njudge\n<span class=\"keyword\">try</span> <span class=\"number\">1</span>\njudge\n<span class=\"keyword\">try</span> <span class=\"number\">2</span>\njudge\n<span class=\"keyword\">try</span> <span class=\"number\">3</span>\njudge\nerr <span class=\"literal\">null</span>\nvalue:  <span class=\"number\">3</span>\n</code></pre>\n<ul>\n<li>使用<code>waterFall</code>解决异步任务依赖问题  </li>\n</ul>\n<pre><code class=\"javascript\"><span class=\"keyword\">async</span>.waterfall([\n    <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">callback</span>) </span>{\n        callback(<span class=\"literal\">null</span>, <span class=\"string\">'one'</span>, <span class=\"string\">'two'</span>);\n    },\n    <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">arg1, arg2, callback</span>) </span>{\n      <span class=\"comment\">// arg1 now equals 'one' and arg2 now equals 'two'</span>\n        callback(<span class=\"literal\">null</span>, <span class=\"string\">'three'</span>);\n    },\n    <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">arg1, callback</span>) </span>{\n        <span class=\"comment\">// arg1 now equals 'three'</span>\n        callback(<span class=\"literal\">null</span>, <span class=\"string\">'done'</span>);\n    }\n], <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">err, result</span>) </span>{\n    <span class=\"comment\">// result now equals 'done'</span>\n});\n</code></pre>\n","site":{"data":{}},"excerpt":"","more":"<p><code>async</code>是一个强大的异步流程控制库，其语义类似于<code>js</code>对数组的操作。它提供了一系列非常强大而便捷的方法，有助于我们在<code>javascript</code>单线程模型背景下写出优雅的逻辑控制代码。  </p>\n<h3 id=\"牛刀小试\"><a href=\"#牛刀小试\" class=\"headerlink\" title=\"牛刀小试\"></a><strong>牛刀小试</strong></h3><p>先从文件操作开始初步了解<code>async</code>函数库的作用：  </p>\n<ul>\n<li>使用<code>filter</code>过滤出磁盘中存在的文件  </li>\n</ul>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> fs = <span class=\"built_in\">require</span>(<span class=\"string\">'fs'</span>);  </span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"keyword\">async</span> = <span class=\"built_in\">require</span>(<span class=\"string\">'async'</span>);  </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">async</span>.filter([<span class=\"string\">'f1'</span>, <span class=\"string\">'f2'</span>, <span class=\"string\">'f3'</span>], <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">it, callback</span>) </span>&#123;</span><br><span class=\"line\">    fs.access(it, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">err</span>) </span>&#123;</span><br><span class=\"line\">      callback(<span class=\"literal\">null</span>, !err);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">&#125;, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">err, results</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(results);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\">假设当前目录下存在以上三个文件，那么`</span>results<span class=\"string\">`输出为：  </span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript</span><br><span class=\"line\">[<span class=\"string\">'f1'</span>, <span class=\"string\">'f2'</span>, <span class=\"string\">'f3'</span>]</span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">+ 使用`</span>map<span class=\"string\">`判断文件是否存在  </span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript</span><br><span class=\"line\"><span class=\"keyword\">async</span>.map([<span class=\"string\">'f1'</span>, <span class=\"string\">'f2'</span>, <span class=\"string\">'f3'</span>], <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">it, callback</span>) </span>&#123;</span><br><span class=\"line\">  fs.exists(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">exists</span>) </span>&#123;</span><br><span class=\"line\">      callback(<span class=\"literal\">null</span>, exists);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">err, results</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(results);<span class=\"comment\">//[true, true, true]</span></span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&gt;以上两个例子分别使用了`</span>access<span class=\"string\">`与`</span>exists<span class=\"string\">`判断文件是否存在，关于两个`</span>API<span class=\"string\">`的详细说明，请查看`</span>nodejs<span class=\"string\">`[官方文档](https://nodejs.org/dist/latest-v6.x/docs/api/fs.html#fs_fs_exists_path_callback)  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">+ 常用的多任务并行   </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript  </span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">asyncTask</span>(<span class=\"params\">delay, arg</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">callback</span>) </span>&#123;</span><br><span class=\"line\">        setTimeout(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">            <span class=\"built_in\">console</span>.log(arg + <span class=\"string\">\"done\"</span>);</span><br><span class=\"line\">            callback(<span class=\"literal\">null</span>, arg);</span><br><span class=\"line\">        &#125;, delay);</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">async</span>.parallel([</span><br><span class=\"line\">    asyncTask(<span class=\"number\">10</span>, <span class=\"string\">\"task1\"</span>),</span><br><span class=\"line\">    asyncTask(<span class=\"number\">1</span>, <span class=\"string\">\"task2\"</span>),</span><br><span class=\"line\">    asyncTask(<span class=\"number\">100</span>, <span class=\"string\">\"task3\"</span>),</span><br><span class=\"line\">], <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">err, ret</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(ret);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\">`</span>asyncTask<span class=\"string\">`输出的顺序依次为：</span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript  </span><br><span class=\"line\"></span><br><span class=\"line\">[luncher@localhost <span class=\"keyword\">async</span>]$ node app.js</span><br><span class=\"line\">task2done</span><br><span class=\"line\">task1done</span><br><span class=\"line\">task3done</span><br><span class=\"line\"><span class=\"comment\">//ret</span></span><br><span class=\"line\">[ <span class=\"string\">'task1'</span>, <span class=\"string\">'task2'</span>, <span class=\"string\">'task3'</span> ]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\">可见虽然任务是并行的，但是最终的结果依然按照任务数组的顺序排列。  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">+ 顺序执行任务  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript  </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">asyncTask</span>(<span class=\"params\">delay, arg</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">callback</span>) </span>&#123;</span><br><span class=\"line\">        setTimeout(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">            <span class=\"built_in\">console</span>.log(arg + <span class=\"string\">\"done\"</span>);</span><br><span class=\"line\">            callback(<span class=\"literal\">null</span>, arg);</span><br><span class=\"line\">        &#125;, delay);</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">async</span>.series([</span><br><span class=\"line\">    asyncTask(<span class=\"number\">10</span>, <span class=\"string\">\"task1\"</span>),</span><br><span class=\"line\">    asyncTask(<span class=\"number\">1</span>, <span class=\"string\">\"task2\"</span>),</span><br><span class=\"line\">    asyncTask(<span class=\"number\">100</span>, <span class=\"string\">\"task3\"</span>),</span><br><span class=\"line\">], <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">err, ret</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(ret);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">输出：  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript  </span><br><span class=\"line\">[luncher@localhost <span class=\"keyword\">async</span>]$ node app.js</span><br><span class=\"line\">task1done</span><br><span class=\"line\">task2done</span><br><span class=\"line\">task3done</span><br><span class=\"line\">[ <span class=\"string\">'task1'</span>, <span class=\"string\">'task2'</span>, <span class=\"string\">'task3'</span> ]  </span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\">可以看到任务按照传入的顺序依次执行。  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">---   </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">### 集合类型多任务处理  </span></span><br><span class=\"line\"><span class=\"string\">- `</span>each<span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\">`</span>each<span class=\"string\">`函数依次遍历数组执行回调函数：  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript  </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">readFile</span>(<span class=\"params\">file, callback</span>) </span>&#123;</span><br><span class=\"line\">    fs.readFile(file, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">err, ret</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(<span class=\"string\">\"readFile \"</span>+ file + <span class=\"string\">\" done\"</span>);</span><br><span class=\"line\">        callback(err);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">async</span>.each([<span class=\"string\">'f1'</span>, <span class=\"string\">'f2'</span>, <span class=\"string\">'f3'</span>], readFile, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">err</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">\"all done\"</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\">**需要注意的是，each不能保证迭代函数完成的顺序，这取决于用户的具体任务**  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- `</span>forEachOf<span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">`</span>each<span class=\"string\">`函数可以对数组进行遍历，如果想要遍历的是一个对象，那么需要用到`</span>forEachOf<span class=\"string\">`.  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript  </span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">readFile</span>(<span class=\"params\">file, k, callback</span>) </span>&#123;</span><br><span class=\"line\">    fs.readFile(file, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">err, ret</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(<span class=\"string\">\"readFile \"</span>+ k + <span class=\"string\">\" \"</span> + file + <span class=\"string\">\" done\"</span>);</span><br><span class=\"line\">        callback(err);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">async</span>.forEachOf(&#123;<span class=\"attr\">k1</span>: <span class=\"string\">\"f1\"</span>, <span class=\"attr\">k2</span>: <span class=\"string\">\"f2\"</span>, <span class=\"attr\">k3</span>: <span class=\"string\">\"f3\"</span>&#125;, readFile, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">err</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">\"all done\"</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">迭代函数第一个参数是`</span>value<span class=\"string\">`，第二个参数是`</span>key<span class=\"string\">`.  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- 控制`</span>each<span class=\"string\">`和`</span>foEachOf<span class=\"string\">`的顺序  </span></span><br><span class=\"line\"><span class=\"string\">`</span> eachSeries<span class=\"string\">`与`</span>forEachOf<span class=\"string\">`都是用来控制迭代函数的顺序执行：  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript  </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">readFile</span>(<span class=\"params\">file, k, callback</span>) </span>&#123;</span><br><span class=\"line\">    fs.readFile(file, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">err, ret</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(<span class=\"string\">\"readFile \"</span>+ k + <span class=\"string\">\" \"</span> + file + <span class=\"string\">\" done\"</span>);</span><br><span class=\"line\">        callback(err);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">async</span>.forEachOfSeries(&#123;<span class=\"attr\">k1</span>: <span class=\"string\">\"f1\"</span>, <span class=\"attr\">k2</span>: <span class=\"string\">\"f2\"</span>, <span class=\"attr\">k3</span>: <span class=\"string\">\"f3\"</span>&#125;, readFile, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">err</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">\"all done\"</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">这样程序的输出始终是：  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript</span><br><span class=\"line\">[luncher@localhost <span class=\"keyword\">async</span>]$ node app.js</span><br><span class=\"line\">readFile k1 f1 done  </span><br><span class=\"line\">readFile k2 f2 done</span><br><span class=\"line\">readFile k3 f3 done</span><br><span class=\"line\">all done</span><br></pre></td></tr></table></figure>\n<ul>\n<li>使用<code>apply</code>包装异步任务  </li>\n</ul>\n<p>前面几个异步任务都需要人为的额外写一个函数，如<code>asyncTask</code>，<code>async</code>提供一个<code>apply</code>语法糖用于解决此类问题：  </p>\n<pre><code class=\"javascript\">\n<span class=\"comment\">// 使用 apply</span>\n\n<span class=\"keyword\">async</span>.parallel([\n    <span class=\"keyword\">async</span>.apply(fs.writeFile, <span class=\"string\">'testfile1'</span>, <span class=\"string\">'test1'</span>),\n    <span class=\"keyword\">async</span>.apply(fs.writeFile, <span class=\"string\">'testfile2'</span>, <span class=\"string\">'test2'</span>),\n]);\n\n\n<span class=\"comment\">// 等同于</span>\n\n<span class=\"keyword\">async</span>.parallel([\n    <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">callback</span>)</span>{\n        fs.writeFile(<span class=\"string\">'testfile1'</span>, <span class=\"string\">'test1'</span>, callback);\n    },\n    <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">callback</span>)</span>{\n        fs.writeFile(<span class=\"string\">'testfile2'</span>, <span class=\"string\">'test2'</span>, callback);\n    }\n]);\n\n</code></pre>\n<ul>\n<li>使用<code>Limit</code>类函数控制并发数量  </li>\n</ul>\n<p><code>async</code>为每个接口都提供了一个<code>Limit</code>参数，用户限制并发数量，我们利用<code>filterLimit</code>做一个简单的测试：  </p>\n<pre><code class=\"javascript\">\n<span class=\"keyword\">var</span> count = <span class=\"number\">0</span>;\n<span class=\"keyword\">async</span>.filterLimit([<span class=\"number\">1</span>, <span class=\"number\">10</span>, <span class=\"number\">28</span>, <span class=\"number\">90</span>, <span class=\"number\">10</span>], <span class=\"number\">2</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">it, callback</span>) </span>{\n    count++;\n    <span class=\"built_in\">console</span>.log(it + <span class=\"string\">\"开始\"</span>);\n    <span class=\"built_in\">console</span>.log(<span class=\"string\">\"并发数：\"</span>, count);\n    setTimeout(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>{\n        count--;\n        <span class=\"built_in\">console</span>.log(it + <span class=\"string\">\"结束\"</span>);\n        callback(<span class=\"literal\">null</span>);\n    }, it);\n}, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">results</span>) </span>{\n    <span class=\"built_in\">console</span>.log(results);\n});\n\n</code></pre>\n<p>输出：  </p>\n<pre><code class=\"javascript\">[luncher@localhost <span class=\"keyword\">async</span>]$ node app.js \n<span class=\"number\">1</span>开始\n并发数： <span class=\"number\">1</span>\n<span class=\"number\">10</span>开始\n并发数： <span class=\"number\">2</span>\n<span class=\"number\">1</span>结束\n<span class=\"number\">28</span>开始\n并发数： <span class=\"number\">2</span>\n<span class=\"number\">10</span>结束\n<span class=\"number\">90</span>开始\n并发数： <span class=\"number\">2</span>\n<span class=\"number\">28</span>结束\n<span class=\"number\">10</span>开始\n并发数： <span class=\"number\">2</span>\n<span class=\"number\">10</span>结束\n<span class=\"number\">90</span>结束\n<span class=\"literal\">null</span>\n\n</code></pre>\n<p>可以看到，最大并发数也就是<code>2</code>，虽然待执行任务大于<code>2</code>.  </p>\n<p><code>async</code>几乎提供了全类数组操作类型的接口，例如：<code>sortBy</code>、<code>reduce</code>、<code>some</code>等，这里不再一一展开。  </p>\n<h3 id=\"异步控制函数\"><a href=\"#异步控制函数\" class=\"headerlink\" title=\"异步控制函数\"></a>异步控制函数</h3><p>前面介绍了两个异步流程控制函数：<code>series</code>和<code>parallel</code>。下面介绍其他几个流程控制函数：    </p>\n<ul>\n<li>使用<code>whilst</code>实现<code>while</code>操作  </li>\n</ul>\n<p><code>whilst</code>用于实现，类似于<code>while</code>的效果，直到满足条件，否则持续执行回调函数。  </p>\n<pre><code class=\"javascript\"><span class=\"keyword\">var</span> c = <span class=\"number\">0</span>;\n\n<span class=\"keyword\">async</span>.whilst(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>{\n    <span class=\"built_in\">console</span>.log(<span class=\"string\">\"judge\"</span>);\n    <span class=\"keyword\">return</span> c &lt; <span class=\"number\">3</span>;\n}, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">callback</span>) </span>{\n    c++;\n    <span class=\"built_in\">console</span>.log(<span class=\"string\">\"try \"</span> + c);\n    setTimeout(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>{\n        callback(<span class=\"literal\">null</span>, c);\n    }, <span class=\"number\">1000</span>);\n}, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">err, val</span>) </span>{\n    <span class=\"built_in\">console</span>.log(<span class=\"string\">'err'</span>, err);\n    <span class=\"built_in\">console</span>.log(<span class=\"string\">'value: '</span>, val);\n});\n\n</code></pre>\n<p>输出：  </p>\n<pre><code class=\"javascript\">[luncher@localhost <span class=\"keyword\">async</span>]$ node app.js \njudge\n<span class=\"keyword\">try</span> <span class=\"number\">1</span>\njudge\n<span class=\"keyword\">try</span> <span class=\"number\">2</span>\njudge\n<span class=\"keyword\">try</span> <span class=\"number\">3</span>\njudge\nerr <span class=\"literal\">null</span>\nvalue:  <span class=\"number\">3</span>\n</code></pre>\n<ul>\n<li>使用<code>waterFall</code>解决异步任务依赖问题  </li>\n</ul>\n<pre><code class=\"javascript\"><span class=\"keyword\">async</span>.waterfall([\n    <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">callback</span>) </span>{\n        callback(<span class=\"literal\">null</span>, <span class=\"string\">'one'</span>, <span class=\"string\">'two'</span>);\n    },\n    <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">arg1, arg2, callback</span>) </span>{\n      <span class=\"comment\">// arg1 now equals 'one' and arg2 now equals 'two'</span>\n        callback(<span class=\"literal\">null</span>, <span class=\"string\">'three'</span>);\n    },\n    <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">arg1, callback</span>) </span>{\n        <span class=\"comment\">// arg1 now equals 'three'</span>\n        callback(<span class=\"literal\">null</span>, <span class=\"string\">'done'</span>);\n    }\n], <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">err, result</span>) </span>{\n    <span class=\"comment\">// result now equals 'done'</span>\n});\n</code></pre>\n"},{"title":"create-react-app支持ts和decorator","date":"2019-02-01T08:59:35.000Z","_content":"\ncreate-react-app默认使用`js`作为开发语言，`ts`拥有强大的类型系统，更加适用于大型项目开发。许多面向对象的语言都有装饰器的语法，目前js也有相关的提案[decorators](https://github.com/tc39/proposal-decorators)。\n\n#### 创建新的应用：\n\n1. 直接创建`ts`项目\n\n```shell\nnpx create-react-app my-app --typescript\n\n# or\n\nyarn create react-app my-app --typescript\n\n```\n\n2. 把老的`js`项目迁移到`ts`\n\n```shell\n\nnpm install --save typescript @types/node @types/react @types/react-dom @types/jest\n\n# or\n\nyarn add typescript @types/node @types/react @types/react-dom @types/jest\n\n```\n\n#### 修改jsx文件名后缀，改为tsx\n\n```shell\n\nApp.jsx -> App.tsx\nindex.jsx -> index.tsx\n\n```\n\n#### `ts`开启装饰器支持\n\n修改`tsconfig.json`文件，加入配置：\n\n```shell\n\n\"experimentalDecorators\": true\n\n```\n\n\n#### 其他\n\n##### js项目开启装饰器\n\n+ 把配置文件暴露出来\n\n```shell\n\nyarn run eject\n\n```\n\n+ 安装装饰器模块\n\n```shell\n\nyarn add babel-plugin-transform-decorators-legacy\n\n```\n\n+ 修改配置文件\n\n开发环境和生产环境的配置文件都在` /config/webpack.config.js`下面。修改相应的配置项目：\n\n```shell\n\n// Process JS with Babel.\n {\n   test: /\\.(js|jsx)$/,\n   include: paths.appSrc,\n   loader: require.resolve(‘babel-loader’),\n   options: {\n     plugins: [‘transform-decorators-legacy’],\n     ...\n\n```\n\n\n参考资料：\n\n[adding-typescript](https://facebook.github.io/create-react-app/docs/adding-typescript)  \n[decorator-support-to-your-create-react-app](https://medium.com/@rodcisal/ejecting-and-adding-decorator-support-to-your-create-react-app-a4a7d80e4077)","source":"_posts/create-react-app支持ts和decorator.md","raw":"---\ntitle: create-react-app支持ts和decorator\ndate: 2019-02-01 16:59:35\ntags: react\ncategories: web\n---\n\ncreate-react-app默认使用`js`作为开发语言，`ts`拥有强大的类型系统，更加适用于大型项目开发。许多面向对象的语言都有装饰器的语法，目前js也有相关的提案[decorators](https://github.com/tc39/proposal-decorators)。\n\n#### 创建新的应用：\n\n1. 直接创建`ts`项目\n\n```shell\nnpx create-react-app my-app --typescript\n\n# or\n\nyarn create react-app my-app --typescript\n\n```\n\n2. 把老的`js`项目迁移到`ts`\n\n```shell\n\nnpm install --save typescript @types/node @types/react @types/react-dom @types/jest\n\n# or\n\nyarn add typescript @types/node @types/react @types/react-dom @types/jest\n\n```\n\n#### 修改jsx文件名后缀，改为tsx\n\n```shell\n\nApp.jsx -> App.tsx\nindex.jsx -> index.tsx\n\n```\n\n#### `ts`开启装饰器支持\n\n修改`tsconfig.json`文件，加入配置：\n\n```shell\n\n\"experimentalDecorators\": true\n\n```\n\n\n#### 其他\n\n##### js项目开启装饰器\n\n+ 把配置文件暴露出来\n\n```shell\n\nyarn run eject\n\n```\n\n+ 安装装饰器模块\n\n```shell\n\nyarn add babel-plugin-transform-decorators-legacy\n\n```\n\n+ 修改配置文件\n\n开发环境和生产环境的配置文件都在` /config/webpack.config.js`下面。修改相应的配置项目：\n\n```shell\n\n// Process JS with Babel.\n {\n   test: /\\.(js|jsx)$/,\n   include: paths.appSrc,\n   loader: require.resolve(‘babel-loader’),\n   options: {\n     plugins: [‘transform-decorators-legacy’],\n     ...\n\n```\n\n\n参考资料：\n\n[adding-typescript](https://facebook.github.io/create-react-app/docs/adding-typescript)  \n[decorator-support-to-your-create-react-app](https://medium.com/@rodcisal/ejecting-and-adding-decorator-support-to-your-create-react-app-a4a7d80e4077)","slug":"create-react-app支持ts和decorator","published":1,"updated":"2019-02-23T09:00:42.317Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cdj0024y4zvywxclik2","content":"<p>create-react-app默认使用<code>js</code>作为开发语言，<code>ts</code>拥有强大的类型系统，更加适用于大型项目开发。许多面向对象的语言都有装饰器的语法，目前js也有相关的提案<a href=\"https://github.com/tc39/proposal-decorators\" target=\"_blank\" rel=\"noopener\">decorators</a>。</p>\n<h4 id=\"创建新的应用：\"><a href=\"#创建新的应用：\" class=\"headerlink\" title=\"创建新的应用：\"></a>创建新的应用：</h4><ol>\n<li>直接创建<code>ts</code>项目</li>\n</ol>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npx create-react-app my-app --typescript</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span> or</span><br><span class=\"line\"></span><br><span class=\"line\">yarn create react-app my-app --typescript</span><br></pre></td></tr></table></figure>\n<ol start=\"2\">\n<li>把老的<code>js</code>项目迁移到<code>ts</code></li>\n</ol>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">npm install --save typescript @types/node @types/react @types/react-dom @types/jest</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span> or</span><br><span class=\"line\"></span><br><span class=\"line\">yarn add typescript @types/node @types/react @types/react-dom @types/jest</span><br></pre></td></tr></table></figure>\n<h4 id=\"修改jsx文件名后缀，改为tsx\"><a href=\"#修改jsx文件名后缀，改为tsx\" class=\"headerlink\" title=\"修改jsx文件名后缀，改为tsx\"></a>修改jsx文件名后缀，改为tsx</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">App.jsx -&gt; App.tsx</span><br><span class=\"line\">index.jsx -&gt; index.tsx</span><br></pre></td></tr></table></figure>\n<h4 id=\"ts开启装饰器支持\"><a href=\"#ts开启装饰器支持\" class=\"headerlink\" title=\"ts开启装饰器支持\"></a><code>ts</code>开启装饰器支持</h4><p>修改<code>tsconfig.json</code>文件，加入配置：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">\"experimentalDecorators\": true</span><br></pre></td></tr></table></figure>\n<h4 id=\"其他\"><a href=\"#其他\" class=\"headerlink\" title=\"其他\"></a>其他</h4><h5 id=\"js项目开启装饰器\"><a href=\"#js项目开启装饰器\" class=\"headerlink\" title=\"js项目开启装饰器\"></a>js项目开启装饰器</h5><ul>\n<li>把配置文件暴露出来</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">yarn run eject</span><br></pre></td></tr></table></figure>\n<ul>\n<li>安装装饰器模块</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">yarn add babel-plugin-transform-decorators-legacy</span><br></pre></td></tr></table></figure>\n<ul>\n<li>修改配置文件</li>\n</ul>\n<p>开发环境和生产环境的配置文件都在<code>/config/webpack.config.js</code>下面。修改相应的配置项目：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">// Process JS with Babel.</span><br><span class=\"line\"> &#123;</span><br><span class=\"line\">   test: /\\.(js|jsx)$/,</span><br><span class=\"line\">   include: paths.appSrc,</span><br><span class=\"line\">   loader: require.resolve(‘babel-loader’),</span><br><span class=\"line\">   options: &#123;</span><br><span class=\"line\">     plugins: [‘transform-decorators-legacy’],</span><br><span class=\"line\">     ...</span><br></pre></td></tr></table></figure>\n<p>参考资料：</p>\n<p><a href=\"https://facebook.github.io/create-react-app/docs/adding-typescript\" target=\"_blank\" rel=\"noopener\">adding-typescript</a><br><a href=\"https://medium.com/@rodcisal/ejecting-and-adding-decorator-support-to-your-create-react-app-a4a7d80e4077\" target=\"_blank\" rel=\"noopener\">decorator-support-to-your-create-react-app</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p>create-react-app默认使用<code>js</code>作为开发语言，<code>ts</code>拥有强大的类型系统，更加适用于大型项目开发。许多面向对象的语言都有装饰器的语法，目前js也有相关的提案<a href=\"https://github.com/tc39/proposal-decorators\" target=\"_blank\" rel=\"noopener\">decorators</a>。</p>\n<h4 id=\"创建新的应用：\"><a href=\"#创建新的应用：\" class=\"headerlink\" title=\"创建新的应用：\"></a>创建新的应用：</h4><ol>\n<li>直接创建<code>ts</code>项目</li>\n</ol>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npx create-react-app my-app --typescript</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span> or</span><br><span class=\"line\"></span><br><span class=\"line\">yarn create react-app my-app --typescript</span><br></pre></td></tr></table></figure>\n<ol start=\"2\">\n<li>把老的<code>js</code>项目迁移到<code>ts</code></li>\n</ol>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">npm install --save typescript @types/node @types/react @types/react-dom @types/jest</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span> or</span><br><span class=\"line\"></span><br><span class=\"line\">yarn add typescript @types/node @types/react @types/react-dom @types/jest</span><br></pre></td></tr></table></figure>\n<h4 id=\"修改jsx文件名后缀，改为tsx\"><a href=\"#修改jsx文件名后缀，改为tsx\" class=\"headerlink\" title=\"修改jsx文件名后缀，改为tsx\"></a>修改jsx文件名后缀，改为tsx</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">App.jsx -&gt; App.tsx</span><br><span class=\"line\">index.jsx -&gt; index.tsx</span><br></pre></td></tr></table></figure>\n<h4 id=\"ts开启装饰器支持\"><a href=\"#ts开启装饰器支持\" class=\"headerlink\" title=\"ts开启装饰器支持\"></a><code>ts</code>开启装饰器支持</h4><p>修改<code>tsconfig.json</code>文件，加入配置：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">\"experimentalDecorators\": true</span><br></pre></td></tr></table></figure>\n<h4 id=\"其他\"><a href=\"#其他\" class=\"headerlink\" title=\"其他\"></a>其他</h4><h5 id=\"js项目开启装饰器\"><a href=\"#js项目开启装饰器\" class=\"headerlink\" title=\"js项目开启装饰器\"></a>js项目开启装饰器</h5><ul>\n<li>把配置文件暴露出来</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">yarn run eject</span><br></pre></td></tr></table></figure>\n<ul>\n<li>安装装饰器模块</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">yarn add babel-plugin-transform-decorators-legacy</span><br></pre></td></tr></table></figure>\n<ul>\n<li>修改配置文件</li>\n</ul>\n<p>开发环境和生产环境的配置文件都在<code>/config/webpack.config.js</code>下面。修改相应的配置项目：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">// Process JS with Babel.</span><br><span class=\"line\"> &#123;</span><br><span class=\"line\">   test: /\\.(js|jsx)$/,</span><br><span class=\"line\">   include: paths.appSrc,</span><br><span class=\"line\">   loader: require.resolve(‘babel-loader’),</span><br><span class=\"line\">   options: &#123;</span><br><span class=\"line\">     plugins: [‘transform-decorators-legacy’],</span><br><span class=\"line\">     ...</span><br></pre></td></tr></table></figure>\n<p>参考资料：</p>\n<p><a href=\"https://facebook.github.io/create-react-app/docs/adding-typescript\" target=\"_blank\" rel=\"noopener\">adding-typescript</a><br><a href=\"https://medium.com/@rodcisal/ejecting-and-adding-decorator-support-to-your-create-react-app-a4a7d80e4077\" target=\"_blank\" rel=\"noopener\">decorator-support-to-your-create-react-app</a></p>\n"},{"title":"electron-打包web应用","date":"2016-05-22T03:30:24.000Z","_content":"时下流行的web app打包工具主要有两个，一个是国内开发者主导的`nw.js`，另一个是国外大厂支撑的`electron`。对比了`nw.js`以及`electron`之后还是选择了`electron`，原因主要有以下几点：\n\n+ 1、基于该工具已有广泛被使用的产品，如：`atom`、`vs code`等。\n+ 2、在开发者中口碑比较好，有大公司参与进来，遇到问题，提个`issue`能很快得到响应。\n\n下载基于`electron`打包的[HolaStudio](http://cdn.studio.holaverse.cn/dist/)。   \n\n---  \n\n### 使用`webpack`编译项目   \n\n`HolaStudio`离线版本打包的时候需要把服务器、客户端打包到一个安装包内。所以第一步首先要把服务器代码混淆，为接下来打包做准备。  \n\n构建工具选择了`webpack`, 关于构建工具没有做很细致的筛选，因为我都不熟悉：）。所以就听从朋友建议，选择了入了`webpack`的坑。  \n\n关于`webpack`的使用，官方有详细的文档说明,`github`自行搜索。\n\n`webpack`需要一个配置文件(`webpack.config.js`)，用来描述项目的环境，以及第三方插件的集成等信息：\n\n```javascript\n\nvar webpack = require('webpack');\nvar path = require('path');\nvar fs = require('fs-extra');\nvar packageJSON = fs.readJsonSync('./package.json');\n\nvar nodeModules = {};\nfs.readdirSync('./node_modules')\n  .filter(function(x) {\n    return ['.bin', '.npminstall'].indexOf(x) === -1;\n  })\n  .filter(function(y) {\n    return !(y in packageJSON.devDependencies);\n  })\n  .forEach(function(mod) {\n\tnodeModules[mod] = 'commonjs ' + mod;\n});\n\nmodule.exports = {\n    entry: './app.js',\n    target: 'node',\n    context: __dirname,\n    node: {\n        __dirname: false,\n        __filename: false\n    },  \n    output: {\n        path: path.join(__dirname, 'output'),\n        filename: 'output.js',\n        externals: nodeModules,\n    },\n    externals: nodeModules,\n    plugins: [\n        new webpack.optimize.UglifyJsPlugin({compress: {warnings: false}}),\n        new webpack.IgnorePlugin(/\\.(css|less)$/)\n    ]\n}\n\n```  \n简要的说明：  \n- entry: 指定项目的入口文件，即启动`node`服务指定的文件  \n- target: 指定当前的编译环境为`node`, 其他选择有`web`、`webworker`等    \n- context: 指定一个路径找到`entry`文件  \n- node: 用于指定一些`nodejs`环境配置  __dirname=false 表示启用__dirname 变量(默认为'/'), __filename=false 表示启用__filename 变量(默认为'/index.js')。  \n- output: 指定编译输出文件及目录  \n- externals: 指定外部依赖库文件  \n- plugins: `webpack`插件集成，这里主要用到了一个混淆插件  \n\n运行 `webpack .` 会在当前目录下的`output` 文件夹得到编译输出文件。\n\n---   \n### 安装`electron`以及相关工具  \n\n- 运行命令`npm i -g electron-prebuilt` 安装`electron`。\n\n简要说说关于`electron`的设计理念：\n\n`electron`打包的应用分为主进程和渲染进程，渲染进程使用`Chromium`来展示页面，主进程以类似创建窗口的方式创建网页。主进程具备调用系统相关服务的功能，主进程和渲染进程之间以`进程间通信`的方式交互。  更详细的`electron`[说明文档](https://github.com/electron/electron/blob/master/docs-translations/zh-CN/).  \n\n*在打包`HolaStudio`的过程中，选择把`node`服务端代码放在主进程，编辑器放在一个渲染进程。*    \n\n`electron`项目的构建目录结构：  \n![图1](http://7xsec6.com1.z0.glb.clouddn.com/electron-release.png)  \n\n在该目录下运行`electron .`即可调式`electron`应用。  \n\n所以在启动`electron`应用的过程中，需要启动`node`后台的同时创建一个渲染窗口显示编辑器。  \n\n```javascript\n\n//处理windows 应用安装以及更新时刻的默认事件  \nif(require('electron-squirrel-startup')) return;\n\nvar app = require('app');\nvar path = require('path');\nvar electron = require('electron');\nvar BrowserWindow = require('browser-window');\nvar globalShortcut = require('global-shortcut');\n\nvar mainWindow = null;\nvar webContents = null;\n\n//所有窗口被关闭\napp.on('window-all-closed', function() {\n  // 在 OS X 上，通常用户在明确地按下 Cmd + Q 之前\n  // 应用会保持活动状态\n    if(process.platform != 'darwin') {\n        app.quit();\n    }\n});\n\n//当前应用准备退出\napp.on('will-quit', function() {\n    globalShortcut.unregisterAll();\n});\n\n// 当 Electron 完成了初始化并且准备创建浏览器窗口的时候\napp.on('ready', function() {\n    global.mainProcess = app;\n    require('./hola_studio.js');\n    registerShortcut();\n});\n\n//hola_studio 服务器发出`done`事件后，准备渲染编辑器界面\napp.on('done', function(url) {\n    var electronScreen = electron.screen;\n    var size = electronScreen.getPrimaryDisplay().workAreaSize;\n    mainWindow = new BrowserWindow({resizable: true, width: size.width, height: size.height,\n        title: 'HolaStudio'});\n    mainWindow.loadURL(url);\n    webContents = mainWindow.webContents;\n    mainWindow.on('closed', function() {\n        mainWindow = null;\n        webContents = null;\n    });\n});\n\n//注册快捷键用于打开开发者工具以及刷新当前页面\nfunction registerShortcut() {\n    function doRegister(cmd, callback) {\n        globalShortcut.register(cmd, callback);\n    }\n\n    doRegister('F12', function() {\n        var win = BrowserWindow.getFocusedWindow();\n        win.webContents.toggleDevTools();\n        console.log(\"toggleDevTools F12\");\n    });\n\n    //windows 平台下`F12`按键按下收不到消息(貌似还没有解决方案)，所以写了一个替代按键\n    doRegister('F6', function() {\n        var win = BrowserWindow.getFocusedWindow();\n        win.webContents.toggleDevTools();\n        console.log(\"toggleDevTools F6\");\n    });\n\n    doRegister('F5', function() {\n        var win = BrowserWindow.getFocusedWindow();\n        win.reload();\n        console.log(\"refresh\");\n    });\n\n    return;\n}\n\n```\n如果之前有做过`MFC`、`QT`类GUI的开发，对`electron`这样的工作流程一定非常熟悉。  \n\n---  \n\n### 安装`electron-builder`工具来编译安装包   \n\n`electron-builder`把几个不同平台的安装包编译工具集成到一起，得到一个统一的接口，方便使用。  \n\n`electron-builder` 建议把构建目录分为两层，上面一层主要管理编译工具、构建所需的资源以及构建的输出，称之为dev 目录。下面一层则为以`electron`为入口的工程目录，称之为app 目录。  \n\n`dev`目录预览：\n\n![图3](http://7xsec6.com1.z0.glb.clouddn.com/electron-builder.png)\n\n`app`目录预览：  \n![图4](http://7xsec6.com1.z0.glb.clouddn.com/electron-release.png)\n\n需要做的工作很简单：\n- 安装构建工具(electron、electron-prebuilder)  \n- 修改dev目录下`package.json`指定编译脚本  \n- 修改app目录下`package.json`指定编译选项  \n- 运行脚本编译安装包  \n\ndev 目录下`package.json`预览:  \n\n``` javascript  \n{\n  \"name\": \"HolaStudio\",\n  \"version\": \"0.0.1\",\n  \"homepage\": \"http://studio.holaverse.cn\",\n  \"description\": \"HolaStudio Release Version.\",\n  \"scripts\": {\n    \"dist\": \"npm run dist:linux && npm run dist:win\",\n    \"dist:osx\": \"build --platform darwin --arch all -d\",\n    \"dist:win\": \"build --platform win32 --arch all -d\",\n    \"dist:linux\": \"build --platform linux --arch all -d\"\n  },\n  \"keywords\": [\n    \"HolaStudio\"\n  ],\n  \"author\": \"holaverse Tech Inc.\",\n  \"license\": \"ISC\",\n  \"devDependencies\": {\n    \"electron-builder\": \"^2.11.0\",\n    \"electron-prebuilt\": \"^0.37.2\"\n  },\n  \"build\": {\n    \"osx\": {\n      \"title\": \"HolaStudio\",\n      \"background\": \"build/background.png\",\n      \"icon\": \"build/icon.icns\",\n      \"icon-size\": 128,\n      \"contents\": [\n        {\n          \"x\": 355,\n          \"y\": 125,\n          \"type\": \"link\",\n          \"path\": \"/Applications\"\n        },\n        {\n          \"x\": 155,\n          \"y\": 125,\n          \"type\": \"file\"\n        }\n      ]\n    }\n  }\n}\n\n```  \n\n- `scripts`字段指定`npm`编译不同平台的运行脚本。  \n- `build`指定编译时载入的资源配置  \n\napp 目录下`package.json`增加编译时配置选项(最新版本`electron-builder`已经把它提出到`dev`目录下的`package.json`)  \n  ```javascript  \n\"build\": {\n    \"asar\": false,\n    \"iconUrl\": \"http://7xsec6.com1.z0.glb.clouddn.com/icon.ico\",\n    \"app-bundle-id\": \"holaverse.studio\",\n    \"app-category-type\": \"public.app-category.productivity\"\n  },\n```  \n- asar告诉打包工具，不要压缩资源文件，因为在`HolaStudio`运行过程中，需要频繁改动项目路径下文件。  \n- iconUrl指定windows安装包`icon url`  \n- app-bundle-id/public.app-category.productivity,mac平台下编译选项  \n\n更详细的配置文档[请看这里](https://github.com/electron-userland/electron-builder/blob/master/docs/options.md)。  \n\n\n成功打包了各种平台的安装包后，后续需要做的是阅读`electron`文档，在有新需求的时候能够很快的处理掉。  \n","source":"_posts/electron-打包web应用.md","raw":"---\ntitle: electron-打包web应用\ncategories: web\ndate: 2016-05-22 11:30:24\n---\n时下流行的web app打包工具主要有两个，一个是国内开发者主导的`nw.js`，另一个是国外大厂支撑的`electron`。对比了`nw.js`以及`electron`之后还是选择了`electron`，原因主要有以下几点：\n\n+ 1、基于该工具已有广泛被使用的产品，如：`atom`、`vs code`等。\n+ 2、在开发者中口碑比较好，有大公司参与进来，遇到问题，提个`issue`能很快得到响应。\n\n下载基于`electron`打包的[HolaStudio](http://cdn.studio.holaverse.cn/dist/)。   \n\n---  \n\n### 使用`webpack`编译项目   \n\n`HolaStudio`离线版本打包的时候需要把服务器、客户端打包到一个安装包内。所以第一步首先要把服务器代码混淆，为接下来打包做准备。  \n\n构建工具选择了`webpack`, 关于构建工具没有做很细致的筛选，因为我都不熟悉：）。所以就听从朋友建议，选择了入了`webpack`的坑。  \n\n关于`webpack`的使用，官方有详细的文档说明,`github`自行搜索。\n\n`webpack`需要一个配置文件(`webpack.config.js`)，用来描述项目的环境，以及第三方插件的集成等信息：\n\n```javascript\n\nvar webpack = require('webpack');\nvar path = require('path');\nvar fs = require('fs-extra');\nvar packageJSON = fs.readJsonSync('./package.json');\n\nvar nodeModules = {};\nfs.readdirSync('./node_modules')\n  .filter(function(x) {\n    return ['.bin', '.npminstall'].indexOf(x) === -1;\n  })\n  .filter(function(y) {\n    return !(y in packageJSON.devDependencies);\n  })\n  .forEach(function(mod) {\n\tnodeModules[mod] = 'commonjs ' + mod;\n});\n\nmodule.exports = {\n    entry: './app.js',\n    target: 'node',\n    context: __dirname,\n    node: {\n        __dirname: false,\n        __filename: false\n    },  \n    output: {\n        path: path.join(__dirname, 'output'),\n        filename: 'output.js',\n        externals: nodeModules,\n    },\n    externals: nodeModules,\n    plugins: [\n        new webpack.optimize.UglifyJsPlugin({compress: {warnings: false}}),\n        new webpack.IgnorePlugin(/\\.(css|less)$/)\n    ]\n}\n\n```  \n简要的说明：  \n- entry: 指定项目的入口文件，即启动`node`服务指定的文件  \n- target: 指定当前的编译环境为`node`, 其他选择有`web`、`webworker`等    \n- context: 指定一个路径找到`entry`文件  \n- node: 用于指定一些`nodejs`环境配置  __dirname=false 表示启用__dirname 变量(默认为'/'), __filename=false 表示启用__filename 变量(默认为'/index.js')。  \n- output: 指定编译输出文件及目录  \n- externals: 指定外部依赖库文件  \n- plugins: `webpack`插件集成，这里主要用到了一个混淆插件  \n\n运行 `webpack .` 会在当前目录下的`output` 文件夹得到编译输出文件。\n\n---   \n### 安装`electron`以及相关工具  \n\n- 运行命令`npm i -g electron-prebuilt` 安装`electron`。\n\n简要说说关于`electron`的设计理念：\n\n`electron`打包的应用分为主进程和渲染进程，渲染进程使用`Chromium`来展示页面，主进程以类似创建窗口的方式创建网页。主进程具备调用系统相关服务的功能，主进程和渲染进程之间以`进程间通信`的方式交互。  更详细的`electron`[说明文档](https://github.com/electron/electron/blob/master/docs-translations/zh-CN/).  \n\n*在打包`HolaStudio`的过程中，选择把`node`服务端代码放在主进程，编辑器放在一个渲染进程。*    \n\n`electron`项目的构建目录结构：  \n![图1](http://7xsec6.com1.z0.glb.clouddn.com/electron-release.png)  \n\n在该目录下运行`electron .`即可调式`electron`应用。  \n\n所以在启动`electron`应用的过程中，需要启动`node`后台的同时创建一个渲染窗口显示编辑器。  \n\n```javascript\n\n//处理windows 应用安装以及更新时刻的默认事件  \nif(require('electron-squirrel-startup')) return;\n\nvar app = require('app');\nvar path = require('path');\nvar electron = require('electron');\nvar BrowserWindow = require('browser-window');\nvar globalShortcut = require('global-shortcut');\n\nvar mainWindow = null;\nvar webContents = null;\n\n//所有窗口被关闭\napp.on('window-all-closed', function() {\n  // 在 OS X 上，通常用户在明确地按下 Cmd + Q 之前\n  // 应用会保持活动状态\n    if(process.platform != 'darwin') {\n        app.quit();\n    }\n});\n\n//当前应用准备退出\napp.on('will-quit', function() {\n    globalShortcut.unregisterAll();\n});\n\n// 当 Electron 完成了初始化并且准备创建浏览器窗口的时候\napp.on('ready', function() {\n    global.mainProcess = app;\n    require('./hola_studio.js');\n    registerShortcut();\n});\n\n//hola_studio 服务器发出`done`事件后，准备渲染编辑器界面\napp.on('done', function(url) {\n    var electronScreen = electron.screen;\n    var size = electronScreen.getPrimaryDisplay().workAreaSize;\n    mainWindow = new BrowserWindow({resizable: true, width: size.width, height: size.height,\n        title: 'HolaStudio'});\n    mainWindow.loadURL(url);\n    webContents = mainWindow.webContents;\n    mainWindow.on('closed', function() {\n        mainWindow = null;\n        webContents = null;\n    });\n});\n\n//注册快捷键用于打开开发者工具以及刷新当前页面\nfunction registerShortcut() {\n    function doRegister(cmd, callback) {\n        globalShortcut.register(cmd, callback);\n    }\n\n    doRegister('F12', function() {\n        var win = BrowserWindow.getFocusedWindow();\n        win.webContents.toggleDevTools();\n        console.log(\"toggleDevTools F12\");\n    });\n\n    //windows 平台下`F12`按键按下收不到消息(貌似还没有解决方案)，所以写了一个替代按键\n    doRegister('F6', function() {\n        var win = BrowserWindow.getFocusedWindow();\n        win.webContents.toggleDevTools();\n        console.log(\"toggleDevTools F6\");\n    });\n\n    doRegister('F5', function() {\n        var win = BrowserWindow.getFocusedWindow();\n        win.reload();\n        console.log(\"refresh\");\n    });\n\n    return;\n}\n\n```\n如果之前有做过`MFC`、`QT`类GUI的开发，对`electron`这样的工作流程一定非常熟悉。  \n\n---  \n\n### 安装`electron-builder`工具来编译安装包   \n\n`electron-builder`把几个不同平台的安装包编译工具集成到一起，得到一个统一的接口，方便使用。  \n\n`electron-builder` 建议把构建目录分为两层，上面一层主要管理编译工具、构建所需的资源以及构建的输出，称之为dev 目录。下面一层则为以`electron`为入口的工程目录，称之为app 目录。  \n\n`dev`目录预览：\n\n![图3](http://7xsec6.com1.z0.glb.clouddn.com/electron-builder.png)\n\n`app`目录预览：  \n![图4](http://7xsec6.com1.z0.glb.clouddn.com/electron-release.png)\n\n需要做的工作很简单：\n- 安装构建工具(electron、electron-prebuilder)  \n- 修改dev目录下`package.json`指定编译脚本  \n- 修改app目录下`package.json`指定编译选项  \n- 运行脚本编译安装包  \n\ndev 目录下`package.json`预览:  \n\n``` javascript  \n{\n  \"name\": \"HolaStudio\",\n  \"version\": \"0.0.1\",\n  \"homepage\": \"http://studio.holaverse.cn\",\n  \"description\": \"HolaStudio Release Version.\",\n  \"scripts\": {\n    \"dist\": \"npm run dist:linux && npm run dist:win\",\n    \"dist:osx\": \"build --platform darwin --arch all -d\",\n    \"dist:win\": \"build --platform win32 --arch all -d\",\n    \"dist:linux\": \"build --platform linux --arch all -d\"\n  },\n  \"keywords\": [\n    \"HolaStudio\"\n  ],\n  \"author\": \"holaverse Tech Inc.\",\n  \"license\": \"ISC\",\n  \"devDependencies\": {\n    \"electron-builder\": \"^2.11.0\",\n    \"electron-prebuilt\": \"^0.37.2\"\n  },\n  \"build\": {\n    \"osx\": {\n      \"title\": \"HolaStudio\",\n      \"background\": \"build/background.png\",\n      \"icon\": \"build/icon.icns\",\n      \"icon-size\": 128,\n      \"contents\": [\n        {\n          \"x\": 355,\n          \"y\": 125,\n          \"type\": \"link\",\n          \"path\": \"/Applications\"\n        },\n        {\n          \"x\": 155,\n          \"y\": 125,\n          \"type\": \"file\"\n        }\n      ]\n    }\n  }\n}\n\n```  \n\n- `scripts`字段指定`npm`编译不同平台的运行脚本。  \n- `build`指定编译时载入的资源配置  \n\napp 目录下`package.json`增加编译时配置选项(最新版本`electron-builder`已经把它提出到`dev`目录下的`package.json`)  \n  ```javascript  \n\"build\": {\n    \"asar\": false,\n    \"iconUrl\": \"http://7xsec6.com1.z0.glb.clouddn.com/icon.ico\",\n    \"app-bundle-id\": \"holaverse.studio\",\n    \"app-category-type\": \"public.app-category.productivity\"\n  },\n```  \n- asar告诉打包工具，不要压缩资源文件，因为在`HolaStudio`运行过程中，需要频繁改动项目路径下文件。  \n- iconUrl指定windows安装包`icon url`  \n- app-bundle-id/public.app-category.productivity,mac平台下编译选项  \n\n更详细的配置文档[请看这里](https://github.com/electron-userland/electron-builder/blob/master/docs/options.md)。  \n\n\n成功打包了各种平台的安装包后，后续需要做的是阅读`electron`文档，在有新需求的时候能够很快的处理掉。  \n","slug":"electron-打包web应用","published":1,"updated":"2018-07-01T10:30:46.494Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cdj0027y4zvwz9bardv","content":"<p>时下流行的web app打包工具主要有两个，一个是国内开发者主导的<code>nw.js</code>，另一个是国外大厂支撑的<code>electron</code>。对比了<code>nw.js</code>以及<code>electron</code>之后还是选择了<code>electron</code>，原因主要有以下几点：</p>\n<ul>\n<li>1、基于该工具已有广泛被使用的产品，如：<code>atom</code>、<code>vs code</code>等。</li>\n<li>2、在开发者中口碑比较好，有大公司参与进来，遇到问题，提个<code>issue</code>能很快得到响应。</li>\n</ul>\n<p>下载基于<code>electron</code>打包的<a href=\"http://cdn.studio.holaverse.cn/dist/\" target=\"_blank\" rel=\"noopener\">HolaStudio</a>。   </p>\n<hr>\n<h3 id=\"使用webpack编译项目\"><a href=\"#使用webpack编译项目\" class=\"headerlink\" title=\"使用webpack编译项目\"></a>使用<code>webpack</code>编译项目</h3><p><code>HolaStudio</code>离线版本打包的时候需要把服务器、客户端打包到一个安装包内。所以第一步首先要把服务器代码混淆，为接下来打包做准备。  </p>\n<p>构建工具选择了<code>webpack</code>, 关于构建工具没有做很细致的筛选，因为我都不熟悉：）。所以就听从朋友建议，选择了入了<code>webpack</code>的坑。  </p>\n<p>关于<code>webpack</code>的使用，官方有详细的文档说明,<code>github</code>自行搜索。</p>\n<p><code>webpack</code>需要一个配置文件(<code>webpack.config.js</code>)，用来描述项目的环境，以及第三方插件的集成等信息：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> webpack = <span class=\"built_in\">require</span>(<span class=\"string\">'webpack'</span>);</span><br><span class=\"line\"><span class=\"keyword\">var</span> path = <span class=\"built_in\">require</span>(<span class=\"string\">'path'</span>);</span><br><span class=\"line\"><span class=\"keyword\">var</span> fs = <span class=\"built_in\">require</span>(<span class=\"string\">'fs-extra'</span>);</span><br><span class=\"line\"><span class=\"keyword\">var</span> packageJSON = fs.readJsonSync(<span class=\"string\">'./package.json'</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> nodeModules = &#123;&#125;;</span><br><span class=\"line\">fs.readdirSync(<span class=\"string\">'./node_modules'</span>)</span><br><span class=\"line\">  .filter(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">x</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> [<span class=\"string\">'.bin'</span>, <span class=\"string\">'.npminstall'</span>].indexOf(x) === <span class=\"number\">-1</span>;</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">  .filter(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">y</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> !(y <span class=\"keyword\">in</span> packageJSON.devDependencies);</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">  .forEach(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">mod</span>) </span>&#123;</span><br><span class=\"line\">\tnodeModules[mod] = <span class=\"string\">'commonjs '</span> + mod;</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">module</span>.exports = &#123;</span><br><span class=\"line\">    entry: <span class=\"string\">'./app.js'</span>,</span><br><span class=\"line\">    target: <span class=\"string\">'node'</span>,</span><br><span class=\"line\">    context: __dirname,</span><br><span class=\"line\">    node: &#123;</span><br><span class=\"line\">        __dirname: <span class=\"literal\">false</span>,</span><br><span class=\"line\">        __filename: <span class=\"literal\">false</span></span><br><span class=\"line\">    &#125;,  </span><br><span class=\"line\">    output: &#123;</span><br><span class=\"line\">        path: path.join(__dirname, <span class=\"string\">'output'</span>),</span><br><span class=\"line\">        filename: <span class=\"string\">'output.js'</span>,</span><br><span class=\"line\">        externals: nodeModules,</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    externals: nodeModules,</span><br><span class=\"line\">    plugins: [</span><br><span class=\"line\">        <span class=\"keyword\">new</span> webpack.optimize.UglifyJsPlugin(&#123;<span class=\"attr\">compress</span>: &#123;<span class=\"attr\">warnings</span>: <span class=\"literal\">false</span>&#125;&#125;),</span><br><span class=\"line\">        <span class=\"keyword\">new</span> webpack.IgnorePlugin(<span class=\"regexp\">/\\.(css|less)$/</span>)</span><br><span class=\"line\">    ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\">简要的说明：  </span></span><br><span class=\"line\"><span class=\"string\">- entry: 指定项目的入口文件，即启动`</span>node<span class=\"string\">`服务指定的文件  </span></span><br><span class=\"line\"><span class=\"string\">- target: 指定当前的编译环境为`</span>node<span class=\"string\">`, 其他选择有`</span>web<span class=\"string\">`、`</span>webworker<span class=\"string\">`等    </span></span><br><span class=\"line\"><span class=\"string\">- context: 指定一个路径找到`</span>entry<span class=\"string\">`文件  </span></span><br><span class=\"line\"><span class=\"string\">- node: 用于指定一些`</span>nodejs<span class=\"string\">`环境配置  __dirname=false 表示启用__dirname 变量(默认为'/'), __filename=false 表示启用__filename 变量(默认为'/index.js')。  </span></span><br><span class=\"line\"><span class=\"string\">- output: 指定编译输出文件及目录  </span></span><br><span class=\"line\"><span class=\"string\">- externals: 指定外部依赖库文件  </span></span><br><span class=\"line\"><span class=\"string\">- plugins: `</span>webpack<span class=\"string\">`插件集成，这里主要用到了一个混淆插件  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">运行 `</span>webpack .<span class=\"string\">` 会在当前目录下的`</span>output<span class=\"string\">` 文件夹得到编译输出文件。</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">---   </span></span><br><span class=\"line\"><span class=\"string\">### 安装`</span>electron<span class=\"string\">`以及相关工具  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- 运行命令`</span>npm i -g electron-prebuilt<span class=\"string\">` 安装`</span>electron<span class=\"string\">`。</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">简要说说关于`</span>electron<span class=\"string\">`的设计理念：</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">`</span>electron<span class=\"string\">`打包的应用分为主进程和渲染进程，渲染进程使用`</span>Chromium<span class=\"string\">`来展示页面，主进程以类似创建窗口的方式创建网页。主进程具备调用系统相关服务的功能，主进程和渲染进程之间以`</span>进程间通信<span class=\"string\">`的方式交互。  更详细的`</span>electron<span class=\"string\">`[说明文档](https://github.com/electron/electron/blob/master/docs-translations/zh-CN/).  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">*在打包`</span>HolaStudio<span class=\"string\">`的过程中，选择把`</span>node<span class=\"string\">`服务端代码放在主进程，编辑器放在一个渲染进程。*    </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">`</span>electron<span class=\"string\">`项目的构建目录结构：  </span></span><br><span class=\"line\"><span class=\"string\">![图1](http://7xsec6.com1.z0.glb.clouddn.com/electron-release.png)  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">在该目录下运行`</span>electron .<span class=\"string\">`即可调式`</span>electron<span class=\"string\">`应用。  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">所以在启动`</span>electron<span class=\"string\">`应用的过程中，需要启动`</span>node<span class=\"string\">`后台的同时创建一个渲染窗口显示编辑器。  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//处理windows 应用安装以及更新时刻的默认事件  </span></span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"built_in\">require</span>(<span class=\"string\">'electron-squirrel-startup'</span>)) <span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> app = <span class=\"built_in\">require</span>(<span class=\"string\">'app'</span>);</span><br><span class=\"line\"><span class=\"keyword\">var</span> path = <span class=\"built_in\">require</span>(<span class=\"string\">'path'</span>);</span><br><span class=\"line\"><span class=\"keyword\">var</span> electron = <span class=\"built_in\">require</span>(<span class=\"string\">'electron'</span>);</span><br><span class=\"line\"><span class=\"keyword\">var</span> BrowserWindow = <span class=\"built_in\">require</span>(<span class=\"string\">'browser-window'</span>);</span><br><span class=\"line\"><span class=\"keyword\">var</span> globalShortcut = <span class=\"built_in\">require</span>(<span class=\"string\">'global-shortcut'</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> mainWindow = <span class=\"literal\">null</span>;</span><br><span class=\"line\"><span class=\"keyword\">var</span> webContents = <span class=\"literal\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//所有窗口被关闭</span></span><br><span class=\"line\">app.on(<span class=\"string\">'window-all-closed'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// 在 OS X 上，通常用户在明确地按下 Cmd + Q 之前</span></span><br><span class=\"line\">  <span class=\"comment\">// 应用会保持活动状态</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(process.platform != <span class=\"string\">'darwin'</span>) &#123;</span><br><span class=\"line\">        app.quit();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//当前应用准备退出</span></span><br><span class=\"line\">app.on(<span class=\"string\">'will-quit'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    globalShortcut.unregisterAll();</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 当 Electron 完成了初始化并且准备创建浏览器窗口的时候</span></span><br><span class=\"line\">app.on(<span class=\"string\">'ready'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    global.mainProcess = app;</span><br><span class=\"line\">    <span class=\"built_in\">require</span>(<span class=\"string\">'./hola_studio.js'</span>);</span><br><span class=\"line\">    registerShortcut();</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//hola_studio 服务器发出`done`事件后，准备渲染编辑器界面</span></span><br><span class=\"line\">app.on(<span class=\"string\">'done'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">url</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> electronScreen = electron.screen;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> size = electronScreen.getPrimaryDisplay().workAreaSize;</span><br><span class=\"line\">    mainWindow = <span class=\"keyword\">new</span> BrowserWindow(&#123;<span class=\"attr\">resizable</span>: <span class=\"literal\">true</span>, <span class=\"attr\">width</span>: size.width, <span class=\"attr\">height</span>: size.height,</span><br><span class=\"line\">        title: <span class=\"string\">'HolaStudio'</span>&#125;);</span><br><span class=\"line\">    mainWindow.loadURL(url);</span><br><span class=\"line\">    webContents = mainWindow.webContents;</span><br><span class=\"line\">    mainWindow.on(<span class=\"string\">'closed'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        mainWindow = <span class=\"literal\">null</span>;</span><br><span class=\"line\">        webContents = <span class=\"literal\">null</span>;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//注册快捷键用于打开开发者工具以及刷新当前页面</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">registerShortcut</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">doRegister</span>(<span class=\"params\">cmd, callback</span>) </span>&#123;</span><br><span class=\"line\">        globalShortcut.register(cmd, callback);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    doRegister(<span class=\"string\">'F12'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> win = BrowserWindow.getFocusedWindow();</span><br><span class=\"line\">        win.webContents.toggleDevTools();</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(<span class=\"string\">\"toggleDevTools F12\"</span>);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//windows 平台下`F12`按键按下收不到消息(貌似还没有解决方案)，所以写了一个替代按键</span></span><br><span class=\"line\">    doRegister(<span class=\"string\">'F6'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> win = BrowserWindow.getFocusedWindow();</span><br><span class=\"line\">        win.webContents.toggleDevTools();</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(<span class=\"string\">\"toggleDevTools F6\"</span>);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">    doRegister(<span class=\"string\">'F5'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> win = BrowserWindow.getFocusedWindow();</span><br><span class=\"line\">        win.reload();</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(<span class=\"string\">\"refresh\"</span>);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>如果之前有做过<code>MFC</code>、<code>QT</code>类GUI的开发，对<code>electron</code>这样的工作流程一定非常熟悉。  </p>\n<hr>\n<h3 id=\"安装electron-builder工具来编译安装包\"><a href=\"#安装electron-builder工具来编译安装包\" class=\"headerlink\" title=\"安装electron-builder工具来编译安装包\"></a>安装<code>electron-builder</code>工具来编译安装包</h3><p><code>electron-builder</code>把几个不同平台的安装包编译工具集成到一起，得到一个统一的接口，方便使用。  </p>\n<p><code>electron-builder</code> 建议把构建目录分为两层，上面一层主要管理编译工具、构建所需的资源以及构建的输出，称之为dev 目录。下面一层则为以<code>electron</code>为入口的工程目录，称之为app 目录。  </p>\n<p><code>dev</code>目录预览：</p>\n<p><img src=\"http://7xsec6.com1.z0.glb.clouddn.com/electron-builder.png\" alt=\"图3\"></p>\n<p><code>app</code>目录预览：<br><img src=\"http://7xsec6.com1.z0.glb.clouddn.com/electron-release.png\" alt=\"图4\"></p>\n<p>需要做的工作很简单：</p>\n<ul>\n<li>安装构建工具(electron、electron-prebuilder)  </li>\n<li>修改dev目录下<code>package.json</code>指定编译脚本  </li>\n<li>修改app目录下<code>package.json</code>指定编译选项  </li>\n<li>运行脚本编译安装包  </li>\n</ul>\n<p>dev 目录下<code>package.json</code>预览:  </p>\n<pre><code class=\"javascript\">{\n  <span class=\"string\">\"name\"</span>: <span class=\"string\">\"HolaStudio\"</span>,\n  <span class=\"string\">\"version\"</span>: <span class=\"string\">\"0.0.1\"</span>,\n  <span class=\"string\">\"homepage\"</span>: <span class=\"string\">\"http://studio.holaverse.cn\"</span>,\n  <span class=\"string\">\"description\"</span>: <span class=\"string\">\"HolaStudio Release Version.\"</span>,\n  <span class=\"string\">\"scripts\"</span>: {\n    <span class=\"string\">\"dist\"</span>: <span class=\"string\">\"npm run dist:linux &amp;&amp; npm run dist:win\"</span>,\n    <span class=\"string\">\"dist:osx\"</span>: <span class=\"string\">\"build --platform darwin --arch all -d\"</span>,\n    <span class=\"string\">\"dist:win\"</span>: <span class=\"string\">\"build --platform win32 --arch all -d\"</span>,\n    <span class=\"string\">\"dist:linux\"</span>: <span class=\"string\">\"build --platform linux --arch all -d\"</span>\n  },\n  <span class=\"string\">\"keywords\"</span>: [\n    <span class=\"string\">\"HolaStudio\"</span>\n  ],\n  <span class=\"string\">\"author\"</span>: <span class=\"string\">\"holaverse Tech Inc.\"</span>,\n  <span class=\"string\">\"license\"</span>: <span class=\"string\">\"ISC\"</span>,\n  <span class=\"string\">\"devDependencies\"</span>: {\n    <span class=\"string\">\"electron-builder\"</span>: <span class=\"string\">\"^2.11.0\"</span>,\n    <span class=\"string\">\"electron-prebuilt\"</span>: <span class=\"string\">\"^0.37.2\"</span>\n  },\n  <span class=\"string\">\"build\"</span>: {\n    <span class=\"string\">\"osx\"</span>: {\n      <span class=\"string\">\"title\"</span>: <span class=\"string\">\"HolaStudio\"</span>,\n      <span class=\"string\">\"background\"</span>: <span class=\"string\">\"build/background.png\"</span>,\n      <span class=\"string\">\"icon\"</span>: <span class=\"string\">\"build/icon.icns\"</span>,\n      <span class=\"string\">\"icon-size\"</span>: <span class=\"number\">128</span>,\n      <span class=\"string\">\"contents\"</span>: [\n        {\n          <span class=\"string\">\"x\"</span>: <span class=\"number\">355</span>,\n          <span class=\"string\">\"y\"</span>: <span class=\"number\">125</span>,\n          <span class=\"string\">\"type\"</span>: <span class=\"string\">\"link\"</span>,\n          <span class=\"string\">\"path\"</span>: <span class=\"string\">\"/Applications\"</span>\n        },\n        {\n          <span class=\"string\">\"x\"</span>: <span class=\"number\">155</span>,\n          <span class=\"string\">\"y\"</span>: <span class=\"number\">125</span>,\n          <span class=\"string\">\"type\"</span>: <span class=\"string\">\"file\"</span>\n        }\n      ]\n    }\n  }\n}\n\n</code></pre>\n<ul>\n<li><code>scripts</code>字段指定<code>npm</code>编译不同平台的运行脚本。  </li>\n<li><code>build</code>指定编译时载入的资源配置  </li>\n</ul>\n<p>app 目录下<code>package.json</code>增加编译时配置选项(最新版本<code>electron-builder</code>已经把它提出到<code>dev</code>目录下的<code>package.json</code>)  </p>\n<pre><code class=\"javascript\"><span class=\"string\">\"build\"</span>: {\n    <span class=\"string\">\"asar\"</span>: <span class=\"literal\">false</span>,\n    <span class=\"string\">\"iconUrl\"</span>: <span class=\"string\">\"http://7xsec6.com1.z0.glb.clouddn.com/icon.ico\"</span>,\n    <span class=\"string\">\"app-bundle-id\"</span>: <span class=\"string\">\"holaverse.studio\"</span>,\n    <span class=\"string\">\"app-category-type\"</span>: <span class=\"string\">\"public.app-category.productivity\"</span>\n  },\n</code></pre>\n<ul>\n<li>asar告诉打包工具，不要压缩资源文件，因为在<code>HolaStudio</code>运行过程中，需要频繁改动项目路径下文件。  </li>\n<li>iconUrl指定windows安装包<code>icon url</code>  </li>\n<li>app-bundle-id/public.app-category.productivity,mac平台下编译选项  </li>\n</ul>\n<p>更详细的配置文档<a href=\"https://github.com/electron-userland/electron-builder/blob/master/docs/options.md\" target=\"_blank\" rel=\"noopener\">请看这里</a>。  </p>\n<p>成功打包了各种平台的安装包后，后续需要做的是阅读<code>electron</code>文档，在有新需求的时候能够很快的处理掉。  </p>\n","site":{"data":{}},"excerpt":"","more":"<p>时下流行的web app打包工具主要有两个，一个是国内开发者主导的<code>nw.js</code>，另一个是国外大厂支撑的<code>electron</code>。对比了<code>nw.js</code>以及<code>electron</code>之后还是选择了<code>electron</code>，原因主要有以下几点：</p>\n<ul>\n<li>1、基于该工具已有广泛被使用的产品，如：<code>atom</code>、<code>vs code</code>等。</li>\n<li>2、在开发者中口碑比较好，有大公司参与进来，遇到问题，提个<code>issue</code>能很快得到响应。</li>\n</ul>\n<p>下载基于<code>electron</code>打包的<a href=\"http://cdn.studio.holaverse.cn/dist/\" target=\"_blank\" rel=\"noopener\">HolaStudio</a>。   </p>\n<hr>\n<h3 id=\"使用webpack编译项目\"><a href=\"#使用webpack编译项目\" class=\"headerlink\" title=\"使用webpack编译项目\"></a>使用<code>webpack</code>编译项目</h3><p><code>HolaStudio</code>离线版本打包的时候需要把服务器、客户端打包到一个安装包内。所以第一步首先要把服务器代码混淆，为接下来打包做准备。  </p>\n<p>构建工具选择了<code>webpack</code>, 关于构建工具没有做很细致的筛选，因为我都不熟悉：）。所以就听从朋友建议，选择了入了<code>webpack</code>的坑。  </p>\n<p>关于<code>webpack</code>的使用，官方有详细的文档说明,<code>github</code>自行搜索。</p>\n<p><code>webpack</code>需要一个配置文件(<code>webpack.config.js</code>)，用来描述项目的环境，以及第三方插件的集成等信息：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> webpack = <span class=\"built_in\">require</span>(<span class=\"string\">'webpack'</span>);</span><br><span class=\"line\"><span class=\"keyword\">var</span> path = <span class=\"built_in\">require</span>(<span class=\"string\">'path'</span>);</span><br><span class=\"line\"><span class=\"keyword\">var</span> fs = <span class=\"built_in\">require</span>(<span class=\"string\">'fs-extra'</span>);</span><br><span class=\"line\"><span class=\"keyword\">var</span> packageJSON = fs.readJsonSync(<span class=\"string\">'./package.json'</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> nodeModules = &#123;&#125;;</span><br><span class=\"line\">fs.readdirSync(<span class=\"string\">'./node_modules'</span>)</span><br><span class=\"line\">  .filter(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">x</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> [<span class=\"string\">'.bin'</span>, <span class=\"string\">'.npminstall'</span>].indexOf(x) === <span class=\"number\">-1</span>;</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">  .filter(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">y</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> !(y <span class=\"keyword\">in</span> packageJSON.devDependencies);</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">  .forEach(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">mod</span>) </span>&#123;</span><br><span class=\"line\">\tnodeModules[mod] = <span class=\"string\">'commonjs '</span> + mod;</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">module</span>.exports = &#123;</span><br><span class=\"line\">    entry: <span class=\"string\">'./app.js'</span>,</span><br><span class=\"line\">    target: <span class=\"string\">'node'</span>,</span><br><span class=\"line\">    context: __dirname,</span><br><span class=\"line\">    node: &#123;</span><br><span class=\"line\">        __dirname: <span class=\"literal\">false</span>,</span><br><span class=\"line\">        __filename: <span class=\"literal\">false</span></span><br><span class=\"line\">    &#125;,  </span><br><span class=\"line\">    output: &#123;</span><br><span class=\"line\">        path: path.join(__dirname, <span class=\"string\">'output'</span>),</span><br><span class=\"line\">        filename: <span class=\"string\">'output.js'</span>,</span><br><span class=\"line\">        externals: nodeModules,</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    externals: nodeModules,</span><br><span class=\"line\">    plugins: [</span><br><span class=\"line\">        <span class=\"keyword\">new</span> webpack.optimize.UglifyJsPlugin(&#123;<span class=\"attr\">compress</span>: &#123;<span class=\"attr\">warnings</span>: <span class=\"literal\">false</span>&#125;&#125;),</span><br><span class=\"line\">        <span class=\"keyword\">new</span> webpack.IgnorePlugin(<span class=\"regexp\">/\\.(css|less)$/</span>)</span><br><span class=\"line\">    ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\">简要的说明：  </span></span><br><span class=\"line\"><span class=\"string\">- entry: 指定项目的入口文件，即启动`</span>node<span class=\"string\">`服务指定的文件  </span></span><br><span class=\"line\"><span class=\"string\">- target: 指定当前的编译环境为`</span>node<span class=\"string\">`, 其他选择有`</span>web<span class=\"string\">`、`</span>webworker<span class=\"string\">`等    </span></span><br><span class=\"line\"><span class=\"string\">- context: 指定一个路径找到`</span>entry<span class=\"string\">`文件  </span></span><br><span class=\"line\"><span class=\"string\">- node: 用于指定一些`</span>nodejs<span class=\"string\">`环境配置  __dirname=false 表示启用__dirname 变量(默认为'/'), __filename=false 表示启用__filename 变量(默认为'/index.js')。  </span></span><br><span class=\"line\"><span class=\"string\">- output: 指定编译输出文件及目录  </span></span><br><span class=\"line\"><span class=\"string\">- externals: 指定外部依赖库文件  </span></span><br><span class=\"line\"><span class=\"string\">- plugins: `</span>webpack<span class=\"string\">`插件集成，这里主要用到了一个混淆插件  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">运行 `</span>webpack .<span class=\"string\">` 会在当前目录下的`</span>output<span class=\"string\">` 文件夹得到编译输出文件。</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">---   </span></span><br><span class=\"line\"><span class=\"string\">### 安装`</span>electron<span class=\"string\">`以及相关工具  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- 运行命令`</span>npm i -g electron-prebuilt<span class=\"string\">` 安装`</span>electron<span class=\"string\">`。</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">简要说说关于`</span>electron<span class=\"string\">`的设计理念：</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">`</span>electron<span class=\"string\">`打包的应用分为主进程和渲染进程，渲染进程使用`</span>Chromium<span class=\"string\">`来展示页面，主进程以类似创建窗口的方式创建网页。主进程具备调用系统相关服务的功能，主进程和渲染进程之间以`</span>进程间通信<span class=\"string\">`的方式交互。  更详细的`</span>electron<span class=\"string\">`[说明文档](https://github.com/electron/electron/blob/master/docs-translations/zh-CN/).  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">*在打包`</span>HolaStudio<span class=\"string\">`的过程中，选择把`</span>node<span class=\"string\">`服务端代码放在主进程，编辑器放在一个渲染进程。*    </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">`</span>electron<span class=\"string\">`项目的构建目录结构：  </span></span><br><span class=\"line\"><span class=\"string\">![图1](http://7xsec6.com1.z0.glb.clouddn.com/electron-release.png)  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">在该目录下运行`</span>electron .<span class=\"string\">`即可调式`</span>electron<span class=\"string\">`应用。  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">所以在启动`</span>electron<span class=\"string\">`应用的过程中，需要启动`</span>node<span class=\"string\">`后台的同时创建一个渲染窗口显示编辑器。  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//处理windows 应用安装以及更新时刻的默认事件  </span></span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"built_in\">require</span>(<span class=\"string\">'electron-squirrel-startup'</span>)) <span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> app = <span class=\"built_in\">require</span>(<span class=\"string\">'app'</span>);</span><br><span class=\"line\"><span class=\"keyword\">var</span> path = <span class=\"built_in\">require</span>(<span class=\"string\">'path'</span>);</span><br><span class=\"line\"><span class=\"keyword\">var</span> electron = <span class=\"built_in\">require</span>(<span class=\"string\">'electron'</span>);</span><br><span class=\"line\"><span class=\"keyword\">var</span> BrowserWindow = <span class=\"built_in\">require</span>(<span class=\"string\">'browser-window'</span>);</span><br><span class=\"line\"><span class=\"keyword\">var</span> globalShortcut = <span class=\"built_in\">require</span>(<span class=\"string\">'global-shortcut'</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> mainWindow = <span class=\"literal\">null</span>;</span><br><span class=\"line\"><span class=\"keyword\">var</span> webContents = <span class=\"literal\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//所有窗口被关闭</span></span><br><span class=\"line\">app.on(<span class=\"string\">'window-all-closed'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// 在 OS X 上，通常用户在明确地按下 Cmd + Q 之前</span></span><br><span class=\"line\">  <span class=\"comment\">// 应用会保持活动状态</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(process.platform != <span class=\"string\">'darwin'</span>) &#123;</span><br><span class=\"line\">        app.quit();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//当前应用准备退出</span></span><br><span class=\"line\">app.on(<span class=\"string\">'will-quit'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    globalShortcut.unregisterAll();</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 当 Electron 完成了初始化并且准备创建浏览器窗口的时候</span></span><br><span class=\"line\">app.on(<span class=\"string\">'ready'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    global.mainProcess = app;</span><br><span class=\"line\">    <span class=\"built_in\">require</span>(<span class=\"string\">'./hola_studio.js'</span>);</span><br><span class=\"line\">    registerShortcut();</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//hola_studio 服务器发出`done`事件后，准备渲染编辑器界面</span></span><br><span class=\"line\">app.on(<span class=\"string\">'done'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">url</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> electronScreen = electron.screen;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> size = electronScreen.getPrimaryDisplay().workAreaSize;</span><br><span class=\"line\">    mainWindow = <span class=\"keyword\">new</span> BrowserWindow(&#123;<span class=\"attr\">resizable</span>: <span class=\"literal\">true</span>, <span class=\"attr\">width</span>: size.width, <span class=\"attr\">height</span>: size.height,</span><br><span class=\"line\">        title: <span class=\"string\">'HolaStudio'</span>&#125;);</span><br><span class=\"line\">    mainWindow.loadURL(url);</span><br><span class=\"line\">    webContents = mainWindow.webContents;</span><br><span class=\"line\">    mainWindow.on(<span class=\"string\">'closed'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        mainWindow = <span class=\"literal\">null</span>;</span><br><span class=\"line\">        webContents = <span class=\"literal\">null</span>;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//注册快捷键用于打开开发者工具以及刷新当前页面</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">registerShortcut</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">doRegister</span>(<span class=\"params\">cmd, callback</span>) </span>&#123;</span><br><span class=\"line\">        globalShortcut.register(cmd, callback);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    doRegister(<span class=\"string\">'F12'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> win = BrowserWindow.getFocusedWindow();</span><br><span class=\"line\">        win.webContents.toggleDevTools();</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(<span class=\"string\">\"toggleDevTools F12\"</span>);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//windows 平台下`F12`按键按下收不到消息(貌似还没有解决方案)，所以写了一个替代按键</span></span><br><span class=\"line\">    doRegister(<span class=\"string\">'F6'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> win = BrowserWindow.getFocusedWindow();</span><br><span class=\"line\">        win.webContents.toggleDevTools();</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(<span class=\"string\">\"toggleDevTools F6\"</span>);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">    doRegister(<span class=\"string\">'F5'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> win = BrowserWindow.getFocusedWindow();</span><br><span class=\"line\">        win.reload();</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(<span class=\"string\">\"refresh\"</span>);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>如果之前有做过<code>MFC</code>、<code>QT</code>类GUI的开发，对<code>electron</code>这样的工作流程一定非常熟悉。  </p>\n<hr>\n<h3 id=\"安装electron-builder工具来编译安装包\"><a href=\"#安装electron-builder工具来编译安装包\" class=\"headerlink\" title=\"安装electron-builder工具来编译安装包\"></a>安装<code>electron-builder</code>工具来编译安装包</h3><p><code>electron-builder</code>把几个不同平台的安装包编译工具集成到一起，得到一个统一的接口，方便使用。  </p>\n<p><code>electron-builder</code> 建议把构建目录分为两层，上面一层主要管理编译工具、构建所需的资源以及构建的输出，称之为dev 目录。下面一层则为以<code>electron</code>为入口的工程目录，称之为app 目录。  </p>\n<p><code>dev</code>目录预览：</p>\n<p><img src=\"http://7xsec6.com1.z0.glb.clouddn.com/electron-builder.png\" alt=\"图3\"></p>\n<p><code>app</code>目录预览：<br><img src=\"http://7xsec6.com1.z0.glb.clouddn.com/electron-release.png\" alt=\"图4\"></p>\n<p>需要做的工作很简单：</p>\n<ul>\n<li>安装构建工具(electron、electron-prebuilder)  </li>\n<li>修改dev目录下<code>package.json</code>指定编译脚本  </li>\n<li>修改app目录下<code>package.json</code>指定编译选项  </li>\n<li>运行脚本编译安装包  </li>\n</ul>\n<p>dev 目录下<code>package.json</code>预览:  </p>\n<pre><code class=\"javascript\">{\n  <span class=\"string\">\"name\"</span>: <span class=\"string\">\"HolaStudio\"</span>,\n  <span class=\"string\">\"version\"</span>: <span class=\"string\">\"0.0.1\"</span>,\n  <span class=\"string\">\"homepage\"</span>: <span class=\"string\">\"http://studio.holaverse.cn\"</span>,\n  <span class=\"string\">\"description\"</span>: <span class=\"string\">\"HolaStudio Release Version.\"</span>,\n  <span class=\"string\">\"scripts\"</span>: {\n    <span class=\"string\">\"dist\"</span>: <span class=\"string\">\"npm run dist:linux &amp;&amp; npm run dist:win\"</span>,\n    <span class=\"string\">\"dist:osx\"</span>: <span class=\"string\">\"build --platform darwin --arch all -d\"</span>,\n    <span class=\"string\">\"dist:win\"</span>: <span class=\"string\">\"build --platform win32 --arch all -d\"</span>,\n    <span class=\"string\">\"dist:linux\"</span>: <span class=\"string\">\"build --platform linux --arch all -d\"</span>\n  },\n  <span class=\"string\">\"keywords\"</span>: [\n    <span class=\"string\">\"HolaStudio\"</span>\n  ],\n  <span class=\"string\">\"author\"</span>: <span class=\"string\">\"holaverse Tech Inc.\"</span>,\n  <span class=\"string\">\"license\"</span>: <span class=\"string\">\"ISC\"</span>,\n  <span class=\"string\">\"devDependencies\"</span>: {\n    <span class=\"string\">\"electron-builder\"</span>: <span class=\"string\">\"^2.11.0\"</span>,\n    <span class=\"string\">\"electron-prebuilt\"</span>: <span class=\"string\">\"^0.37.2\"</span>\n  },\n  <span class=\"string\">\"build\"</span>: {\n    <span class=\"string\">\"osx\"</span>: {\n      <span class=\"string\">\"title\"</span>: <span class=\"string\">\"HolaStudio\"</span>,\n      <span class=\"string\">\"background\"</span>: <span class=\"string\">\"build/background.png\"</span>,\n      <span class=\"string\">\"icon\"</span>: <span class=\"string\">\"build/icon.icns\"</span>,\n      <span class=\"string\">\"icon-size\"</span>: <span class=\"number\">128</span>,\n      <span class=\"string\">\"contents\"</span>: [\n        {\n          <span class=\"string\">\"x\"</span>: <span class=\"number\">355</span>,\n          <span class=\"string\">\"y\"</span>: <span class=\"number\">125</span>,\n          <span class=\"string\">\"type\"</span>: <span class=\"string\">\"link\"</span>,\n          <span class=\"string\">\"path\"</span>: <span class=\"string\">\"/Applications\"</span>\n        },\n        {\n          <span class=\"string\">\"x\"</span>: <span class=\"number\">155</span>,\n          <span class=\"string\">\"y\"</span>: <span class=\"number\">125</span>,\n          <span class=\"string\">\"type\"</span>: <span class=\"string\">\"file\"</span>\n        }\n      ]\n    }\n  }\n}\n\n</code></pre>\n<ul>\n<li><code>scripts</code>字段指定<code>npm</code>编译不同平台的运行脚本。  </li>\n<li><code>build</code>指定编译时载入的资源配置  </li>\n</ul>\n<p>app 目录下<code>package.json</code>增加编译时配置选项(最新版本<code>electron-builder</code>已经把它提出到<code>dev</code>目录下的<code>package.json</code>)  </p>\n<pre><code class=\"javascript\"><span class=\"string\">\"build\"</span>: {\n    <span class=\"string\">\"asar\"</span>: <span class=\"literal\">false</span>,\n    <span class=\"string\">\"iconUrl\"</span>: <span class=\"string\">\"http://7xsec6.com1.z0.glb.clouddn.com/icon.ico\"</span>,\n    <span class=\"string\">\"app-bundle-id\"</span>: <span class=\"string\">\"holaverse.studio\"</span>,\n    <span class=\"string\">\"app-category-type\"</span>: <span class=\"string\">\"public.app-category.productivity\"</span>\n  },\n</code></pre>\n<ul>\n<li>asar告诉打包工具，不要压缩资源文件，因为在<code>HolaStudio</code>运行过程中，需要频繁改动项目路径下文件。  </li>\n<li>iconUrl指定windows安装包<code>icon url</code>  </li>\n<li>app-bundle-id/public.app-category.productivity,mac平台下编译选项  </li>\n</ul>\n<p>更详细的配置文档<a href=\"https://github.com/electron-userland/electron-builder/blob/master/docs/options.md\" target=\"_blank\" rel=\"noopener\">请看这里</a>。  </p>\n<p>成功打包了各种平台的安装包后，后续需要做的是阅读<code>electron</code>文档，在有新需求的时候能够很快的处理掉。  </p>\n"},{"title":"Vue数据绑定(一)","date":"2018-07-09T11:30:03.000Z","_content":"\nVue作为当下炙手可热的前端三大框架之一，一直都想深入研究一下其内部的实现原理，去学习`MVVM`模式的精髓。如果说`MVVM`是当下最流行的图形用户界面开发模式，那么数据绑定则是这一模式的根基。这也是我为什么要从数据绑定开始了解Vue的原因。\n\n本篇文章首先从Vue构建开始，后面主要了解`methods`、`data`的执行过程以及原理，结合Vue文档来分析，做到知其然且知其所以然。对于计算属性、组件系统、指令等将在后续文章中分析。\n\n>源代码基于vue1.0，最新版本为2.x，其中的差异我会在文章尽量列出来。\n\n### Vue构造过程\n\n```javascript\n\nfunction Vue (options) {\n  this._init(options)\n}\n\n```\n\nVue构造函数调用了一个`_init`函数，Vue所有的内置属性和方法都以_或者$开头：\n\n```javascript\n//util/lang.js\nexports.isReserved = function (str) {\n  var c = (str + '').charCodeAt(0)\n  return c === 0x24 || c === 0x5F\n}\n\n```\n\n`_init`函数调用了若干个初始化函数其中就包含了一个初始化状态属性相关的函数：\n\n```javascript\n//instance/state.js\nexports._initState = function () {\n  this._initProps()\n  this._initMeta()\n  this._initMethods()\n  this._initData()\n  this._initComputed()\n}\n```\n\n看到调用函数的名称都知道是什么意思，这里主要研究一下`_initMethods`和`_initData`两个函数的实现原理。其余的会在后续文章分析。\n\n`_initMethods`:\n\n```javascript\nexports._initMethods = function () {\n  var methods = this.$options.methods\n  if (methods) {\n    for (var key in methods) {\n      this[key] = _.bind(methods[key], this)\n    }\n  }\n}\n```\n\n对于`methods`的初始化相对比较简单，这个函数的主要作用就是把用户定义在methods属性内的一些方法绑定到当前的Vue实例中。由于ES6的箭头函数会导致`bind`失败，这也是为什么Vue在文档中提示：\n>不要在选项属性或回调上使用箭头函数，比如 created: () => console.log(this.a) 或 vm.$watch('a', newValue => this.myMethod())。因为箭头函数是和父级上下文绑定在一起的，this 不会是如你所预期的 Vue 实例，经常导致 Uncaught TypeError: Cannot read property of undefined 或 Uncaught TypeError: this.myMethod is not a function 之类的错误。\n\n`_initData`:\n```javascript\nexports._initData = function () {\n  var propsData = this._data\n  var optionsDataFn = this.$options.data\n  var optionsData = optionsDataFn && optionsDataFn()\n  if (optionsData) {\n    this._data = optionsData\n    for (var prop in propsData) {\n      if (process.env.NODE_ENV !== 'production' &&\n          optionsData.hasOwnProperty(prop)) {\n        _.warn(\n          'Data field \"' + prop + '\" is already defined ' +\n          'as a prop. Use prop default value instead.'\n        )\n      }\n      if (this._props[prop].raw !== null ||\n          !optionsData.hasOwnProperty(prop)) {\n        _.set(optionsData, prop, propsData[prop])\n      }\n    }\n  }\n  //...\n}\n```\n\n对于子组件而言，`propsData`表示父组件传递过来的数据，因为initProp先执行`_data`填充的是父组件传递过来的数据。`optionsDataFn`表示组件自身的数据。 为什么这里看到的是一个函数呢？这是因为在Vue的初始化函数`_init`内调用了`util/option.js`下的`mergeOptions`这个方法，为了方便合并父组件和子组件的数据，它定义了一系列策略把组件传入的参数替换了。为了避免父组件的数据被子组件原生的数据覆盖需要做一次判定，发现有数据覆盖就警告用户。需要注意的是属性值为null且子组件原生就有的数据字段是不会被覆盖的。\n\n\n在把数据合并之后，接下来要对组件数据做一个代理： \n\n```javascript\n//...\nvar data = this._data\n// proxy data on instance\nvar keys = Object.keys(data)\nvar i, key\ni = keys.length\nwhile (i--) {\n  key = keys[i]\n  this._proxy(key)\n}\n//...\n```\n\n数据代理的作用就是为了实现：`vm.prop === vm._data.prop`的效果。代码位置在`instance/state.js`下的`_proxy`函数:\n\n```javascript\nexports._proxy = function (key) {\n  if (!_.isReserved(key)) {\n    // need to store ref to self here\n    // because these getter/setters might\n    // be called by child scopes via\n    // prototype inheritance.\n    var self = this\n    Object.defineProperty(self, key, {\n      configurable: true,\n      enumerable: true,\n      get: function proxyGetter () {\n        return self._data[key]\n      },\n      set: function proxySetter (val) {\n        self._data[key] = val\n      }\n    })\n  }\n}\n```\n\n为了避免覆盖Vue内置的属性所以做一次判定，接下来就是对数据的访问做一个代理。\n\n仅仅代理数据是不够的，接下来要看到的是监控数据的变化：\n\n```javascript\nexports._initData = function () {\n  //...\n  // observe data\n  Observer.create(data, this)\n}\n```\n\n`Observer.create`是Vue响应式数据绑定的核心:\n\n```javascript\n\nObserver.create = function (value, vm) {\n  if (!value || typeof value !== 'object') {\n    return\n  }\n  var ob\n  if (\n    value.hasOwnProperty('__ob__') &&\n    value.__ob__ instanceof Observer\n  ) {\n    ob = value.__ob__\n  } else if (\n    (_.isArray(value) || _.isPlainObject(value)) &&\n    !Object.isFrozen(value) &&\n    !value._isVue\n  ) {\n    ob = new Observer(value)\n  }\n  if (ob && vm) {\n    ob.addVm(vm)\n  }\n  return ob\n}\n\n```\n\n数据监听只针对对象类型，监听对象会内嵌到被监听的对象，这样可以避免重复监听数据对象：\n\n```javascript\nfunction Observer (value) {\n//...\n  _.define(value, '__ob__', this)\n//...\n}\n```\n\n需要注意的是,Vue对象实例不会被监听，通过`_isVue`属性来辨别。对于被冻结的对象也是不能监听的,Vue通过接口`Object.isFrozen`来判定，官方文档也有说明：\n\n>这里唯一的例外是使用 Object.freeze()，这会阻止修改现有的属性，也意味着响应系统无法再追踪变化。\n\nObserver对象会反向引用Vue实例对象，这是为了在用户调用`$delete`的时候能够反向通知到Vue实例对象, 把挂在实例上的被删除属性去除：\n\n```javascript\nexports.delete = function (obj, key) {\n  if (!obj.hasOwnProperty(key)) {\n    return\n  }\n  delete obj[key]\n  var ob = obj.__ob__\n  if (!ob) {\n    return\n  }\n  ob.notify()\n  if (ob.vms) {\n    var i = ob.vms.length\n    while (i--) {\n      var vm = ob.vms[i]\n      vm._unproxy(key)\n      vm._digest()\n    }\n  }\n}\n```\n\n数据的变化追踪分为两类：对象和数组类型。对象类型遍历属性监听每个属性的变化：\n\n```javascript\nObserver.prototype.walk = function (obj) {\n  var keys = Object.keys(obj)\n  var i = keys.length\n  while (i--) {\n    this.convert(keys[i], obj[keys[i]])\n  }\n}\n```\n\n`convert`函数调用了数据追踪最关键的一个函数：\n```javascript\nfunction defineReactive (obj, key, val) {\n  var dep = new Dep()\n  var childOb = Observer.create(val)\n  Object.defineProperty(obj, key, {\n    enumerable: true,\n    configurable: true,\n    get: function metaGetter () {\n      if (Dep.target) {\n        dep.depend()\n        if (childOb) {\n          childOb.dep.depend()\n        }\n      }\n      return val\n    },\n    set: function metaSetter (newVal) {\n      if (newVal === val) return\n      val = newVal\n      childOb = Observer.create(newVal)\n      dep.notify()\n    }\n  })\n}\n```\n由于对象的属性可能还是一个对象或者数组。所以需要递归的追踪内嵌数据的变化。数据的监听者存放在`Dep`模块内。每次设置新的对象需要重新监听数据属性。\n\n---\n\n\n数组类型的数据监听追踪比较特殊，Vue通过拦截几个数组方法来追踪数组的变化\n\n```javascript\nfunction Observer (value) {\n  //...\n  if (_.isArray(value)) {\n    var augment = _.hasProto\n      ? protoAugment\n      : copyAugment\n    augment(value, arrayMethods, arrayKeys)\n    this.observeArray(value)\n  } else {\n    this.walk(value)\n  }\n}\n```\n\narrayMethods是一个以`Array.prototype`为原型的对象：//`observer/array.js`\n```javascript\nvar arrayProto = Array.prototype\nvar arrayMethods = Object.create(arrayProto)\n```\n\n通过`_.hasProto`方法判定代理数组对象的若干个方法：\n```javascript\nfunction protoAugment (target, src) {\n  target.__proto__ = src\n}\n```\n\n至此Vue的数据追踪流程执行完毕。Vue提供了两个全局方法`Vue.set`和`Vue.delete`。下面来研究一下两个函数的实现，`Vue.set`最终会调用到`util/lang.js`下的`set`方法：\n\n```javascript\nexports.set = function set (obj, key, val) {\n  if (obj.hasOwnProperty(key)) {\n    obj[key] = val\n    return\n  }\n  if (obj._isVue) {\n    set(obj._data, key, val)\n    return\n  }\n  var ob = obj.__ob__\n  if (!ob) {\n    obj[key] = val\n    return\n  }\n  ob.convert(key, val)\n  ob.notify()\n  if (ob.vms) {\n    var i = ob.vms.length\n    while (i--) {\n      var vm = ob.vms[i]\n      vm._proxy(key)\n      vm._digest()\n    }\n  }\n}\n```\n\n如果设置的属性之前已经有了，这个时候直接设置就行，会促发相应的更新逻辑。如果是Vue对象则设置到`_data`属性内。如果数据对象不是响应式的则直接新增数据属性。这个时候不会触发视图更新等操作。反之通知相应的监听方，并且递归追踪新增的数据值。Vue官方文档有如下提示：\n>向响应式对象中添加一个属性，并确保这个新属性同样是响应式的，且触发视图更新。它必须用于向响应式对象上添加新属性，因为 Vue 无法探测普通的新增属性。\n\n`Vue.delete`最终调用`util/lang.js`下的`delete`方法。\n\n```javascript\nexports.delete = function (obj, key) {\n  if (!obj.hasOwnProperty(key)) {\n    return\n  }\n  delete obj[key]\n  var ob = obj.__ob__\n  if (!ob) {\n    return\n  }\n  ob.notify()\n  if (ob.vms) {\n    var i = ob.vms.length\n    while (i--) {\n      var vm = ob.vms[i]\n      vm._unproxy(key)\n      vm._digest()\n    }\n  }\n}\n```\n\n被删除的属性如果不是响应式的，则直接删除然后退出函数。反之，通知各个监听对象，并且通过`_unproxy`方法把挂在`Vue`实例上的属性删除。","source":"_posts/Vue数据绑定(一).md","raw":"---\ntitle: Vue数据绑定(一)\ncategories: Vue源码分析系列文章\ndate: 2018-07-09 19:30:03\n---\n\nVue作为当下炙手可热的前端三大框架之一，一直都想深入研究一下其内部的实现原理，去学习`MVVM`模式的精髓。如果说`MVVM`是当下最流行的图形用户界面开发模式，那么数据绑定则是这一模式的根基。这也是我为什么要从数据绑定开始了解Vue的原因。\n\n本篇文章首先从Vue构建开始，后面主要了解`methods`、`data`的执行过程以及原理，结合Vue文档来分析，做到知其然且知其所以然。对于计算属性、组件系统、指令等将在后续文章中分析。\n\n>源代码基于vue1.0，最新版本为2.x，其中的差异我会在文章尽量列出来。\n\n### Vue构造过程\n\n```javascript\n\nfunction Vue (options) {\n  this._init(options)\n}\n\n```\n\nVue构造函数调用了一个`_init`函数，Vue所有的内置属性和方法都以_或者$开头：\n\n```javascript\n//util/lang.js\nexports.isReserved = function (str) {\n  var c = (str + '').charCodeAt(0)\n  return c === 0x24 || c === 0x5F\n}\n\n```\n\n`_init`函数调用了若干个初始化函数其中就包含了一个初始化状态属性相关的函数：\n\n```javascript\n//instance/state.js\nexports._initState = function () {\n  this._initProps()\n  this._initMeta()\n  this._initMethods()\n  this._initData()\n  this._initComputed()\n}\n```\n\n看到调用函数的名称都知道是什么意思，这里主要研究一下`_initMethods`和`_initData`两个函数的实现原理。其余的会在后续文章分析。\n\n`_initMethods`:\n\n```javascript\nexports._initMethods = function () {\n  var methods = this.$options.methods\n  if (methods) {\n    for (var key in methods) {\n      this[key] = _.bind(methods[key], this)\n    }\n  }\n}\n```\n\n对于`methods`的初始化相对比较简单，这个函数的主要作用就是把用户定义在methods属性内的一些方法绑定到当前的Vue实例中。由于ES6的箭头函数会导致`bind`失败，这也是为什么Vue在文档中提示：\n>不要在选项属性或回调上使用箭头函数，比如 created: () => console.log(this.a) 或 vm.$watch('a', newValue => this.myMethod())。因为箭头函数是和父级上下文绑定在一起的，this 不会是如你所预期的 Vue 实例，经常导致 Uncaught TypeError: Cannot read property of undefined 或 Uncaught TypeError: this.myMethod is not a function 之类的错误。\n\n`_initData`:\n```javascript\nexports._initData = function () {\n  var propsData = this._data\n  var optionsDataFn = this.$options.data\n  var optionsData = optionsDataFn && optionsDataFn()\n  if (optionsData) {\n    this._data = optionsData\n    for (var prop in propsData) {\n      if (process.env.NODE_ENV !== 'production' &&\n          optionsData.hasOwnProperty(prop)) {\n        _.warn(\n          'Data field \"' + prop + '\" is already defined ' +\n          'as a prop. Use prop default value instead.'\n        )\n      }\n      if (this._props[prop].raw !== null ||\n          !optionsData.hasOwnProperty(prop)) {\n        _.set(optionsData, prop, propsData[prop])\n      }\n    }\n  }\n  //...\n}\n```\n\n对于子组件而言，`propsData`表示父组件传递过来的数据，因为initProp先执行`_data`填充的是父组件传递过来的数据。`optionsDataFn`表示组件自身的数据。 为什么这里看到的是一个函数呢？这是因为在Vue的初始化函数`_init`内调用了`util/option.js`下的`mergeOptions`这个方法，为了方便合并父组件和子组件的数据，它定义了一系列策略把组件传入的参数替换了。为了避免父组件的数据被子组件原生的数据覆盖需要做一次判定，发现有数据覆盖就警告用户。需要注意的是属性值为null且子组件原生就有的数据字段是不会被覆盖的。\n\n\n在把数据合并之后，接下来要对组件数据做一个代理： \n\n```javascript\n//...\nvar data = this._data\n// proxy data on instance\nvar keys = Object.keys(data)\nvar i, key\ni = keys.length\nwhile (i--) {\n  key = keys[i]\n  this._proxy(key)\n}\n//...\n```\n\n数据代理的作用就是为了实现：`vm.prop === vm._data.prop`的效果。代码位置在`instance/state.js`下的`_proxy`函数:\n\n```javascript\nexports._proxy = function (key) {\n  if (!_.isReserved(key)) {\n    // need to store ref to self here\n    // because these getter/setters might\n    // be called by child scopes via\n    // prototype inheritance.\n    var self = this\n    Object.defineProperty(self, key, {\n      configurable: true,\n      enumerable: true,\n      get: function proxyGetter () {\n        return self._data[key]\n      },\n      set: function proxySetter (val) {\n        self._data[key] = val\n      }\n    })\n  }\n}\n```\n\n为了避免覆盖Vue内置的属性所以做一次判定，接下来就是对数据的访问做一个代理。\n\n仅仅代理数据是不够的，接下来要看到的是监控数据的变化：\n\n```javascript\nexports._initData = function () {\n  //...\n  // observe data\n  Observer.create(data, this)\n}\n```\n\n`Observer.create`是Vue响应式数据绑定的核心:\n\n```javascript\n\nObserver.create = function (value, vm) {\n  if (!value || typeof value !== 'object') {\n    return\n  }\n  var ob\n  if (\n    value.hasOwnProperty('__ob__') &&\n    value.__ob__ instanceof Observer\n  ) {\n    ob = value.__ob__\n  } else if (\n    (_.isArray(value) || _.isPlainObject(value)) &&\n    !Object.isFrozen(value) &&\n    !value._isVue\n  ) {\n    ob = new Observer(value)\n  }\n  if (ob && vm) {\n    ob.addVm(vm)\n  }\n  return ob\n}\n\n```\n\n数据监听只针对对象类型，监听对象会内嵌到被监听的对象，这样可以避免重复监听数据对象：\n\n```javascript\nfunction Observer (value) {\n//...\n  _.define(value, '__ob__', this)\n//...\n}\n```\n\n需要注意的是,Vue对象实例不会被监听，通过`_isVue`属性来辨别。对于被冻结的对象也是不能监听的,Vue通过接口`Object.isFrozen`来判定，官方文档也有说明：\n\n>这里唯一的例外是使用 Object.freeze()，这会阻止修改现有的属性，也意味着响应系统无法再追踪变化。\n\nObserver对象会反向引用Vue实例对象，这是为了在用户调用`$delete`的时候能够反向通知到Vue实例对象, 把挂在实例上的被删除属性去除：\n\n```javascript\nexports.delete = function (obj, key) {\n  if (!obj.hasOwnProperty(key)) {\n    return\n  }\n  delete obj[key]\n  var ob = obj.__ob__\n  if (!ob) {\n    return\n  }\n  ob.notify()\n  if (ob.vms) {\n    var i = ob.vms.length\n    while (i--) {\n      var vm = ob.vms[i]\n      vm._unproxy(key)\n      vm._digest()\n    }\n  }\n}\n```\n\n数据的变化追踪分为两类：对象和数组类型。对象类型遍历属性监听每个属性的变化：\n\n```javascript\nObserver.prototype.walk = function (obj) {\n  var keys = Object.keys(obj)\n  var i = keys.length\n  while (i--) {\n    this.convert(keys[i], obj[keys[i]])\n  }\n}\n```\n\n`convert`函数调用了数据追踪最关键的一个函数：\n```javascript\nfunction defineReactive (obj, key, val) {\n  var dep = new Dep()\n  var childOb = Observer.create(val)\n  Object.defineProperty(obj, key, {\n    enumerable: true,\n    configurable: true,\n    get: function metaGetter () {\n      if (Dep.target) {\n        dep.depend()\n        if (childOb) {\n          childOb.dep.depend()\n        }\n      }\n      return val\n    },\n    set: function metaSetter (newVal) {\n      if (newVal === val) return\n      val = newVal\n      childOb = Observer.create(newVal)\n      dep.notify()\n    }\n  })\n}\n```\n由于对象的属性可能还是一个对象或者数组。所以需要递归的追踪内嵌数据的变化。数据的监听者存放在`Dep`模块内。每次设置新的对象需要重新监听数据属性。\n\n---\n\n\n数组类型的数据监听追踪比较特殊，Vue通过拦截几个数组方法来追踪数组的变化\n\n```javascript\nfunction Observer (value) {\n  //...\n  if (_.isArray(value)) {\n    var augment = _.hasProto\n      ? protoAugment\n      : copyAugment\n    augment(value, arrayMethods, arrayKeys)\n    this.observeArray(value)\n  } else {\n    this.walk(value)\n  }\n}\n```\n\narrayMethods是一个以`Array.prototype`为原型的对象：//`observer/array.js`\n```javascript\nvar arrayProto = Array.prototype\nvar arrayMethods = Object.create(arrayProto)\n```\n\n通过`_.hasProto`方法判定代理数组对象的若干个方法：\n```javascript\nfunction protoAugment (target, src) {\n  target.__proto__ = src\n}\n```\n\n至此Vue的数据追踪流程执行完毕。Vue提供了两个全局方法`Vue.set`和`Vue.delete`。下面来研究一下两个函数的实现，`Vue.set`最终会调用到`util/lang.js`下的`set`方法：\n\n```javascript\nexports.set = function set (obj, key, val) {\n  if (obj.hasOwnProperty(key)) {\n    obj[key] = val\n    return\n  }\n  if (obj._isVue) {\n    set(obj._data, key, val)\n    return\n  }\n  var ob = obj.__ob__\n  if (!ob) {\n    obj[key] = val\n    return\n  }\n  ob.convert(key, val)\n  ob.notify()\n  if (ob.vms) {\n    var i = ob.vms.length\n    while (i--) {\n      var vm = ob.vms[i]\n      vm._proxy(key)\n      vm._digest()\n    }\n  }\n}\n```\n\n如果设置的属性之前已经有了，这个时候直接设置就行，会促发相应的更新逻辑。如果是Vue对象则设置到`_data`属性内。如果数据对象不是响应式的则直接新增数据属性。这个时候不会触发视图更新等操作。反之通知相应的监听方，并且递归追踪新增的数据值。Vue官方文档有如下提示：\n>向响应式对象中添加一个属性，并确保这个新属性同样是响应式的，且触发视图更新。它必须用于向响应式对象上添加新属性，因为 Vue 无法探测普通的新增属性。\n\n`Vue.delete`最终调用`util/lang.js`下的`delete`方法。\n\n```javascript\nexports.delete = function (obj, key) {\n  if (!obj.hasOwnProperty(key)) {\n    return\n  }\n  delete obj[key]\n  var ob = obj.__ob__\n  if (!ob) {\n    return\n  }\n  ob.notify()\n  if (ob.vms) {\n    var i = ob.vms.length\n    while (i--) {\n      var vm = ob.vms[i]\n      vm._unproxy(key)\n      vm._digest()\n    }\n  }\n}\n```\n\n被删除的属性如果不是响应式的，则直接删除然后退出函数。反之，通知各个监听对象，并且通过`_unproxy`方法把挂在`Vue`实例上的属性删除。","slug":"Vue数据绑定(一)","published":1,"updated":"2018-07-15T14:44:19.849Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cdl002by4zvn955txck","content":"<p>Vue作为当下炙手可热的前端三大框架之一，一直都想深入研究一下其内部的实现原理，去学习<code>MVVM</code>模式的精髓。如果说<code>MVVM</code>是当下最流行的图形用户界面开发模式，那么数据绑定则是这一模式的根基。这也是我为什么要从数据绑定开始了解Vue的原因。</p>\n<p>本篇文章首先从Vue构建开始，后面主要了解<code>methods</code>、<code>data</code>的执行过程以及原理，结合Vue文档来分析，做到知其然且知其所以然。对于计算属性、组件系统、指令等将在后续文章中分析。</p>\n<blockquote>\n<p>源代码基于vue1.0，最新版本为2.x，其中的差异我会在文章尽量列出来。</p>\n</blockquote>\n<h3 id=\"Vue构造过程\"><a href=\"#Vue构造过程\" class=\"headerlink\" title=\"Vue构造过程\"></a>Vue构造过程</h3><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">Vue</span> (<span class=\"params\">options</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>._init(options)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Vue构造函数调用了一个<code>_init</code>函数，Vue所有的内置属性和方法都以_或者$开头：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//util/lang.js</span></span><br><span class=\"line\">exports.isReserved = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">str</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> c = (str + <span class=\"string\">''</span>).charCodeAt(<span class=\"number\">0</span>)</span><br><span class=\"line\">  <span class=\"keyword\">return</span> c === <span class=\"number\">0x24</span> || c === <span class=\"number\">0x5F</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>_init</code>函数调用了若干个初始化函数其中就包含了一个初始化状态属性相关的函数：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//instance/state.js</span></span><br><span class=\"line\">exports._initState = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>._initProps()</span><br><span class=\"line\">  <span class=\"keyword\">this</span>._initMeta()</span><br><span class=\"line\">  <span class=\"keyword\">this</span>._initMethods()</span><br><span class=\"line\">  <span class=\"keyword\">this</span>._initData()</span><br><span class=\"line\">  <span class=\"keyword\">this</span>._initComputed()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>看到调用函数的名称都知道是什么意思，这里主要研究一下<code>_initMethods</code>和<code>_initData</code>两个函数的实现原理。其余的会在后续文章分析。</p>\n<p><code>_initMethods</code>:</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">exports._initMethods = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> methods = <span class=\"keyword\">this</span>.$options.methods</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (methods) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> key <span class=\"keyword\">in</span> methods) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">this</span>[key] = _.bind(methods[key], <span class=\"keyword\">this</span>)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>对于<code>methods</code>的初始化相对比较简单，这个函数的主要作用就是把用户定义在methods属性内的一些方法绑定到当前的Vue实例中。由于ES6的箭头函数会导致<code>bind</code>失败，这也是为什么Vue在文档中提示：</p>\n<blockquote>\n<p>不要在选项属性或回调上使用箭头函数，比如 created: () =&gt; console.log(this.a) 或 vm.$watch(‘a’, newValue =&gt; this.myMethod())。因为箭头函数是和父级上下文绑定在一起的，this 不会是如你所预期的 Vue 实例，经常导致 Uncaught TypeError: Cannot read property of undefined 或 Uncaught TypeError: this.myMethod is not a function 之类的错误。</p>\n</blockquote>\n<p><code>_initData</code>:<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">exports._initData = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> propsData = <span class=\"keyword\">this</span>._data</span><br><span class=\"line\">  <span class=\"keyword\">var</span> optionsDataFn = <span class=\"keyword\">this</span>.$options.data</span><br><span class=\"line\">  <span class=\"keyword\">var</span> optionsData = optionsDataFn &amp;&amp; optionsDataFn()</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (optionsData) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>._data = optionsData</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> prop <span class=\"keyword\">in</span> propsData) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (process.env.NODE_ENV !== <span class=\"string\">'production'</span> &amp;&amp;</span><br><span class=\"line\">          optionsData.hasOwnProperty(prop)) &#123;</span><br><span class=\"line\">        _.warn(</span><br><span class=\"line\">          <span class=\"string\">'Data field \"'</span> + prop + <span class=\"string\">'\" is already defined '</span> +</span><br><span class=\"line\">          <span class=\"string\">'as a prop. Use prop default value instead.'</span></span><br><span class=\"line\">        )</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>._props[prop].raw !== <span class=\"literal\">null</span> ||</span><br><span class=\"line\">          !optionsData.hasOwnProperty(prop)) &#123;</span><br><span class=\"line\">        _.set(optionsData, prop, propsData[prop])</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">//...</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>对于子组件而言，<code>propsData</code>表示父组件传递过来的数据，因为initProp先执行<code>_data</code>填充的是父组件传递过来的数据。<code>optionsDataFn</code>表示组件自身的数据。 为什么这里看到的是一个函数呢？这是因为在Vue的初始化函数<code>_init</code>内调用了<code>util/option.js</code>下的<code>mergeOptions</code>这个方法，为了方便合并父组件和子组件的数据，它定义了一系列策略把组件传入的参数替换了。为了避免父组件的数据被子组件原生的数据覆盖需要做一次判定，发现有数据覆盖就警告用户。需要注意的是属性值为null且子组件原生就有的数据字段是不会被覆盖的。</p>\n<p>在把数据合并之后，接下来要对组件数据做一个代理： </p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//...</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> data = <span class=\"keyword\">this</span>._data</span><br><span class=\"line\"><span class=\"comment\">// proxy data on instance</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> keys = <span class=\"built_in\">Object</span>.keys(data)</span><br><span class=\"line\"><span class=\"keyword\">var</span> i, key</span><br><span class=\"line\">i = keys.length</span><br><span class=\"line\"><span class=\"keyword\">while</span> (i--) &#123;</span><br><span class=\"line\">  key = keys[i]</span><br><span class=\"line\">  <span class=\"keyword\">this</span>._proxy(key)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//...</span></span><br></pre></td></tr></table></figure>\n<p>数据代理的作用就是为了实现：<code>vm.prop === vm._data.prop</code>的效果。代码位置在<code>instance/state.js</code>下的<code>_proxy</code>函数:</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">exports._proxy = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">key</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!_.isReserved(key)) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// need to store ref to self here</span></span><br><span class=\"line\">    <span class=\"comment\">// because these getter/setters might</span></span><br><span class=\"line\">    <span class=\"comment\">// be called by child scopes via</span></span><br><span class=\"line\">    <span class=\"comment\">// prototype inheritance.</span></span><br><span class=\"line\">    <span class=\"keyword\">var</span> self = <span class=\"keyword\">this</span></span><br><span class=\"line\">    <span class=\"built_in\">Object</span>.defineProperty(self, key, &#123;</span><br><span class=\"line\">      configurable: <span class=\"literal\">true</span>,</span><br><span class=\"line\">      enumerable: <span class=\"literal\">true</span>,</span><br><span class=\"line\">      get: <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">proxyGetter</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> self._data[key]</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      set: <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">proxySetter</span> (<span class=\"params\">val</span>) </span>&#123;</span><br><span class=\"line\">        self._data[key] = val</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>为了避免覆盖Vue内置的属性所以做一次判定，接下来就是对数据的访问做一个代理。</p>\n<p>仅仅代理数据是不够的，接下来要看到的是监控数据的变化：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">exports._initData = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">//...</span></span><br><span class=\"line\">  <span class=\"comment\">// observe data</span></span><br><span class=\"line\">  Observer.create(data, <span class=\"keyword\">this</span>)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>Observer.create</code>是Vue响应式数据绑定的核心:</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">Observer.create = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">value, vm</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!value || <span class=\"keyword\">typeof</span> value !== <span class=\"string\">'object'</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> ob</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (</span><br><span class=\"line\">    value.hasOwnProperty(<span class=\"string\">'__ob__'</span>) &amp;&amp;</span><br><span class=\"line\">    value.__ob__ <span class=\"keyword\">instanceof</span> Observer</span><br><span class=\"line\">  ) &#123;</span><br><span class=\"line\">    ob = value.__ob__</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (</span><br><span class=\"line\">    (_.isArray(value) || _.isPlainObject(value)) &amp;&amp;</span><br><span class=\"line\">    !<span class=\"built_in\">Object</span>.isFrozen(value) &amp;&amp;</span><br><span class=\"line\">    !value._isVue</span><br><span class=\"line\">  ) &#123;</span><br><span class=\"line\">    ob = <span class=\"keyword\">new</span> Observer(value)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (ob &amp;&amp; vm) &#123;</span><br><span class=\"line\">    ob.addVm(vm)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> ob</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>数据监听只针对对象类型，监听对象会内嵌到被监听的对象，这样可以避免重复监听数据对象：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">Observer</span> (<span class=\"params\">value</span>) </span>&#123;</span><br><span class=\"line\"><span class=\"comment\">//...</span></span><br><span class=\"line\">  _.define(value, <span class=\"string\">'__ob__'</span>, <span class=\"keyword\">this</span>)</span><br><span class=\"line\"><span class=\"comment\">//...</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>需要注意的是,Vue对象实例不会被监听，通过<code>_isVue</code>属性来辨别。对于被冻结的对象也是不能监听的,Vue通过接口<code>Object.isFrozen</code>来判定，官方文档也有说明：</p>\n<blockquote>\n<p>这里唯一的例外是使用 Object.freeze()，这会阻止修改现有的属性，也意味着响应系统无法再追踪变化。</p>\n</blockquote>\n<p>Observer对象会反向引用Vue实例对象，这是为了在用户调用<code>$delete</code>的时候能够反向通知到Vue实例对象, 把挂在实例上的被删除属性去除：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">exports.delete = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">obj, key</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!obj.hasOwnProperty(key)) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">delete</span> obj[key]</span><br><span class=\"line\">  <span class=\"keyword\">var</span> ob = obj.__ob__</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!ob) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  ob.notify()</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (ob.vms) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> i = ob.vms.length</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (i--) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">var</span> vm = ob.vms[i]</span><br><span class=\"line\">      vm._unproxy(key)</span><br><span class=\"line\">      vm._digest()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>数据的变化追踪分为两类：对象和数组类型。对象类型遍历属性监听每个属性的变化：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Observer.prototype.walk = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">obj</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> keys = <span class=\"built_in\">Object</span>.keys(obj)</span><br><span class=\"line\">  <span class=\"keyword\">var</span> i = keys.length</span><br><span class=\"line\">  <span class=\"keyword\">while</span> (i--) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.convert(keys[i], obj[keys[i]])</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>convert</code>函数调用了数据追踪最关键的一个函数：<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">defineReactive</span> (<span class=\"params\">obj, key, val</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> dep = <span class=\"keyword\">new</span> Dep()</span><br><span class=\"line\">  <span class=\"keyword\">var</span> childOb = Observer.create(val)</span><br><span class=\"line\">  <span class=\"built_in\">Object</span>.defineProperty(obj, key, &#123;</span><br><span class=\"line\">    enumerable: <span class=\"literal\">true</span>,</span><br><span class=\"line\">    configurable: <span class=\"literal\">true</span>,</span><br><span class=\"line\">    get: <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">metaGetter</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (Dep.target) &#123;</span><br><span class=\"line\">        dep.depend()</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (childOb) &#123;</span><br><span class=\"line\">          childOb.dep.depend()</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> val</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    set: <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">metaSetter</span> (<span class=\"params\">newVal</span>) </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (newVal === val) <span class=\"keyword\">return</span></span><br><span class=\"line\">      val = newVal</span><br><span class=\"line\">      childOb = Observer.create(newVal)</span><br><span class=\"line\">      dep.notify()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>由于对象的属性可能还是一个对象或者数组。所以需要递归的追踪内嵌数据的变化。数据的监听者存放在<code>Dep</code>模块内。每次设置新的对象需要重新监听数据属性。</p>\n<hr>\n<p>数组类型的数据监听追踪比较特殊，Vue通过拦截几个数组方法来追踪数组的变化</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">Observer</span> (<span class=\"params\">value</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">//...</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (_.isArray(value)) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> augment = _.hasProto</span><br><span class=\"line\">      ? protoAugment</span><br><span class=\"line\">      : copyAugment</span><br><span class=\"line\">    augment(value, arrayMethods, arrayKeys)</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.observeArray(value)</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.walk(value)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>arrayMethods是一个以<code>Array.prototype</code>为原型的对象：//<code>observer/array.js</code><br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> arrayProto = <span class=\"built_in\">Array</span>.prototype</span><br><span class=\"line\"><span class=\"keyword\">var</span> arrayMethods = <span class=\"built_in\">Object</span>.create(arrayProto)</span><br></pre></td></tr></table></figure></p>\n<p>通过<code>_.hasProto</code>方法判定代理数组对象的若干个方法：<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">protoAugment</span> (<span class=\"params\">target, src</span>) </span>&#123;</span><br><span class=\"line\">  target.__proto__ = src</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>至此Vue的数据追踪流程执行完毕。Vue提供了两个全局方法<code>Vue.set</code>和<code>Vue.delete</code>。下面来研究一下两个函数的实现，<code>Vue.set</code>最终会调用到<code>util/lang.js</code>下的<code>set</code>方法：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">exports.set = <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">set</span> (<span class=\"params\">obj, key, val</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (obj.hasOwnProperty(key)) &#123;</span><br><span class=\"line\">    obj[key] = val</span><br><span class=\"line\">    <span class=\"keyword\">return</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (obj._isVue) &#123;</span><br><span class=\"line\">    set(obj._data, key, val)</span><br><span class=\"line\">    <span class=\"keyword\">return</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> ob = obj.__ob__</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!ob) &#123;</span><br><span class=\"line\">    obj[key] = val</span><br><span class=\"line\">    <span class=\"keyword\">return</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  ob.convert(key, val)</span><br><span class=\"line\">  ob.notify()</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (ob.vms) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> i = ob.vms.length</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (i--) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">var</span> vm = ob.vms[i]</span><br><span class=\"line\">      vm._proxy(key)</span><br><span class=\"line\">      vm._digest()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>如果设置的属性之前已经有了，这个时候直接设置就行，会促发相应的更新逻辑。如果是Vue对象则设置到<code>_data</code>属性内。如果数据对象不是响应式的则直接新增数据属性。这个时候不会触发视图更新等操作。反之通知相应的监听方，并且递归追踪新增的数据值。Vue官方文档有如下提示：</p>\n<blockquote>\n<p>向响应式对象中添加一个属性，并确保这个新属性同样是响应式的，且触发视图更新。它必须用于向响应式对象上添加新属性，因为 Vue 无法探测普通的新增属性。</p>\n</blockquote>\n<p><code>Vue.delete</code>最终调用<code>util/lang.js</code>下的<code>delete</code>方法。</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">exports.delete = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">obj, key</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!obj.hasOwnProperty(key)) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">delete</span> obj[key]</span><br><span class=\"line\">  <span class=\"keyword\">var</span> ob = obj.__ob__</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!ob) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  ob.notify()</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (ob.vms) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> i = ob.vms.length</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (i--) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">var</span> vm = ob.vms[i]</span><br><span class=\"line\">      vm._unproxy(key)</span><br><span class=\"line\">      vm._digest()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>被删除的属性如果不是响应式的，则直接删除然后退出函数。反之，通知各个监听对象，并且通过<code>_unproxy</code>方法把挂在<code>Vue</code>实例上的属性删除。</p>\n","site":{"data":{}},"excerpt":"","more":"<p>Vue作为当下炙手可热的前端三大框架之一，一直都想深入研究一下其内部的实现原理，去学习<code>MVVM</code>模式的精髓。如果说<code>MVVM</code>是当下最流行的图形用户界面开发模式，那么数据绑定则是这一模式的根基。这也是我为什么要从数据绑定开始了解Vue的原因。</p>\n<p>本篇文章首先从Vue构建开始，后面主要了解<code>methods</code>、<code>data</code>的执行过程以及原理，结合Vue文档来分析，做到知其然且知其所以然。对于计算属性、组件系统、指令等将在后续文章中分析。</p>\n<blockquote>\n<p>源代码基于vue1.0，最新版本为2.x，其中的差异我会在文章尽量列出来。</p>\n</blockquote>\n<h3 id=\"Vue构造过程\"><a href=\"#Vue构造过程\" class=\"headerlink\" title=\"Vue构造过程\"></a>Vue构造过程</h3><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">Vue</span> (<span class=\"params\">options</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>._init(options)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Vue构造函数调用了一个<code>_init</code>函数，Vue所有的内置属性和方法都以_或者$开头：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//util/lang.js</span></span><br><span class=\"line\">exports.isReserved = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">str</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> c = (str + <span class=\"string\">''</span>).charCodeAt(<span class=\"number\">0</span>)</span><br><span class=\"line\">  <span class=\"keyword\">return</span> c === <span class=\"number\">0x24</span> || c === <span class=\"number\">0x5F</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>_init</code>函数调用了若干个初始化函数其中就包含了一个初始化状态属性相关的函数：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//instance/state.js</span></span><br><span class=\"line\">exports._initState = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>._initProps()</span><br><span class=\"line\">  <span class=\"keyword\">this</span>._initMeta()</span><br><span class=\"line\">  <span class=\"keyword\">this</span>._initMethods()</span><br><span class=\"line\">  <span class=\"keyword\">this</span>._initData()</span><br><span class=\"line\">  <span class=\"keyword\">this</span>._initComputed()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>看到调用函数的名称都知道是什么意思，这里主要研究一下<code>_initMethods</code>和<code>_initData</code>两个函数的实现原理。其余的会在后续文章分析。</p>\n<p><code>_initMethods</code>:</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">exports._initMethods = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> methods = <span class=\"keyword\">this</span>.$options.methods</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (methods) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> key <span class=\"keyword\">in</span> methods) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">this</span>[key] = _.bind(methods[key], <span class=\"keyword\">this</span>)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>对于<code>methods</code>的初始化相对比较简单，这个函数的主要作用就是把用户定义在methods属性内的一些方法绑定到当前的Vue实例中。由于ES6的箭头函数会导致<code>bind</code>失败，这也是为什么Vue在文档中提示：</p>\n<blockquote>\n<p>不要在选项属性或回调上使用箭头函数，比如 created: () =&gt; console.log(this.a) 或 vm.$watch(‘a’, newValue =&gt; this.myMethod())。因为箭头函数是和父级上下文绑定在一起的，this 不会是如你所预期的 Vue 实例，经常导致 Uncaught TypeError: Cannot read property of undefined 或 Uncaught TypeError: this.myMethod is not a function 之类的错误。</p>\n</blockquote>\n<p><code>_initData</code>:<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">exports._initData = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> propsData = <span class=\"keyword\">this</span>._data</span><br><span class=\"line\">  <span class=\"keyword\">var</span> optionsDataFn = <span class=\"keyword\">this</span>.$options.data</span><br><span class=\"line\">  <span class=\"keyword\">var</span> optionsData = optionsDataFn &amp;&amp; optionsDataFn()</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (optionsData) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>._data = optionsData</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> prop <span class=\"keyword\">in</span> propsData) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (process.env.NODE_ENV !== <span class=\"string\">'production'</span> &amp;&amp;</span><br><span class=\"line\">          optionsData.hasOwnProperty(prop)) &#123;</span><br><span class=\"line\">        _.warn(</span><br><span class=\"line\">          <span class=\"string\">'Data field \"'</span> + prop + <span class=\"string\">'\" is already defined '</span> +</span><br><span class=\"line\">          <span class=\"string\">'as a prop. Use prop default value instead.'</span></span><br><span class=\"line\">        )</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>._props[prop].raw !== <span class=\"literal\">null</span> ||</span><br><span class=\"line\">          !optionsData.hasOwnProperty(prop)) &#123;</span><br><span class=\"line\">        _.set(optionsData, prop, propsData[prop])</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">//...</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>对于子组件而言，<code>propsData</code>表示父组件传递过来的数据，因为initProp先执行<code>_data</code>填充的是父组件传递过来的数据。<code>optionsDataFn</code>表示组件自身的数据。 为什么这里看到的是一个函数呢？这是因为在Vue的初始化函数<code>_init</code>内调用了<code>util/option.js</code>下的<code>mergeOptions</code>这个方法，为了方便合并父组件和子组件的数据，它定义了一系列策略把组件传入的参数替换了。为了避免父组件的数据被子组件原生的数据覆盖需要做一次判定，发现有数据覆盖就警告用户。需要注意的是属性值为null且子组件原生就有的数据字段是不会被覆盖的。</p>\n<p>在把数据合并之后，接下来要对组件数据做一个代理： </p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//...</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> data = <span class=\"keyword\">this</span>._data</span><br><span class=\"line\"><span class=\"comment\">// proxy data on instance</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> keys = <span class=\"built_in\">Object</span>.keys(data)</span><br><span class=\"line\"><span class=\"keyword\">var</span> i, key</span><br><span class=\"line\">i = keys.length</span><br><span class=\"line\"><span class=\"keyword\">while</span> (i--) &#123;</span><br><span class=\"line\">  key = keys[i]</span><br><span class=\"line\">  <span class=\"keyword\">this</span>._proxy(key)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//...</span></span><br></pre></td></tr></table></figure>\n<p>数据代理的作用就是为了实现：<code>vm.prop === vm._data.prop</code>的效果。代码位置在<code>instance/state.js</code>下的<code>_proxy</code>函数:</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">exports._proxy = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">key</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!_.isReserved(key)) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// need to store ref to self here</span></span><br><span class=\"line\">    <span class=\"comment\">// because these getter/setters might</span></span><br><span class=\"line\">    <span class=\"comment\">// be called by child scopes via</span></span><br><span class=\"line\">    <span class=\"comment\">// prototype inheritance.</span></span><br><span class=\"line\">    <span class=\"keyword\">var</span> self = <span class=\"keyword\">this</span></span><br><span class=\"line\">    <span class=\"built_in\">Object</span>.defineProperty(self, key, &#123;</span><br><span class=\"line\">      configurable: <span class=\"literal\">true</span>,</span><br><span class=\"line\">      enumerable: <span class=\"literal\">true</span>,</span><br><span class=\"line\">      get: <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">proxyGetter</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> self._data[key]</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      set: <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">proxySetter</span> (<span class=\"params\">val</span>) </span>&#123;</span><br><span class=\"line\">        self._data[key] = val</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>为了避免覆盖Vue内置的属性所以做一次判定，接下来就是对数据的访问做一个代理。</p>\n<p>仅仅代理数据是不够的，接下来要看到的是监控数据的变化：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">exports._initData = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">//...</span></span><br><span class=\"line\">  <span class=\"comment\">// observe data</span></span><br><span class=\"line\">  Observer.create(data, <span class=\"keyword\">this</span>)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>Observer.create</code>是Vue响应式数据绑定的核心:</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">Observer.create = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">value, vm</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!value || <span class=\"keyword\">typeof</span> value !== <span class=\"string\">'object'</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> ob</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (</span><br><span class=\"line\">    value.hasOwnProperty(<span class=\"string\">'__ob__'</span>) &amp;&amp;</span><br><span class=\"line\">    value.__ob__ <span class=\"keyword\">instanceof</span> Observer</span><br><span class=\"line\">  ) &#123;</span><br><span class=\"line\">    ob = value.__ob__</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (</span><br><span class=\"line\">    (_.isArray(value) || _.isPlainObject(value)) &amp;&amp;</span><br><span class=\"line\">    !<span class=\"built_in\">Object</span>.isFrozen(value) &amp;&amp;</span><br><span class=\"line\">    !value._isVue</span><br><span class=\"line\">  ) &#123;</span><br><span class=\"line\">    ob = <span class=\"keyword\">new</span> Observer(value)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (ob &amp;&amp; vm) &#123;</span><br><span class=\"line\">    ob.addVm(vm)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> ob</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>数据监听只针对对象类型，监听对象会内嵌到被监听的对象，这样可以避免重复监听数据对象：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">Observer</span> (<span class=\"params\">value</span>) </span>&#123;</span><br><span class=\"line\"><span class=\"comment\">//...</span></span><br><span class=\"line\">  _.define(value, <span class=\"string\">'__ob__'</span>, <span class=\"keyword\">this</span>)</span><br><span class=\"line\"><span class=\"comment\">//...</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>需要注意的是,Vue对象实例不会被监听，通过<code>_isVue</code>属性来辨别。对于被冻结的对象也是不能监听的,Vue通过接口<code>Object.isFrozen</code>来判定，官方文档也有说明：</p>\n<blockquote>\n<p>这里唯一的例外是使用 Object.freeze()，这会阻止修改现有的属性，也意味着响应系统无法再追踪变化。</p>\n</blockquote>\n<p>Observer对象会反向引用Vue实例对象，这是为了在用户调用<code>$delete</code>的时候能够反向通知到Vue实例对象, 把挂在实例上的被删除属性去除：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">exports.delete = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">obj, key</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!obj.hasOwnProperty(key)) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">delete</span> obj[key]</span><br><span class=\"line\">  <span class=\"keyword\">var</span> ob = obj.__ob__</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!ob) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  ob.notify()</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (ob.vms) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> i = ob.vms.length</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (i--) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">var</span> vm = ob.vms[i]</span><br><span class=\"line\">      vm._unproxy(key)</span><br><span class=\"line\">      vm._digest()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>数据的变化追踪分为两类：对象和数组类型。对象类型遍历属性监听每个属性的变化：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Observer.prototype.walk = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">obj</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> keys = <span class=\"built_in\">Object</span>.keys(obj)</span><br><span class=\"line\">  <span class=\"keyword\">var</span> i = keys.length</span><br><span class=\"line\">  <span class=\"keyword\">while</span> (i--) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.convert(keys[i], obj[keys[i]])</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>convert</code>函数调用了数据追踪最关键的一个函数：<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">defineReactive</span> (<span class=\"params\">obj, key, val</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> dep = <span class=\"keyword\">new</span> Dep()</span><br><span class=\"line\">  <span class=\"keyword\">var</span> childOb = Observer.create(val)</span><br><span class=\"line\">  <span class=\"built_in\">Object</span>.defineProperty(obj, key, &#123;</span><br><span class=\"line\">    enumerable: <span class=\"literal\">true</span>,</span><br><span class=\"line\">    configurable: <span class=\"literal\">true</span>,</span><br><span class=\"line\">    get: <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">metaGetter</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (Dep.target) &#123;</span><br><span class=\"line\">        dep.depend()</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (childOb) &#123;</span><br><span class=\"line\">          childOb.dep.depend()</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> val</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    set: <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">metaSetter</span> (<span class=\"params\">newVal</span>) </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (newVal === val) <span class=\"keyword\">return</span></span><br><span class=\"line\">      val = newVal</span><br><span class=\"line\">      childOb = Observer.create(newVal)</span><br><span class=\"line\">      dep.notify()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>由于对象的属性可能还是一个对象或者数组。所以需要递归的追踪内嵌数据的变化。数据的监听者存放在<code>Dep</code>模块内。每次设置新的对象需要重新监听数据属性。</p>\n<hr>\n<p>数组类型的数据监听追踪比较特殊，Vue通过拦截几个数组方法来追踪数组的变化</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">Observer</span> (<span class=\"params\">value</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">//...</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (_.isArray(value)) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> augment = _.hasProto</span><br><span class=\"line\">      ? protoAugment</span><br><span class=\"line\">      : copyAugment</span><br><span class=\"line\">    augment(value, arrayMethods, arrayKeys)</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.observeArray(value)</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.walk(value)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>arrayMethods是一个以<code>Array.prototype</code>为原型的对象：//<code>observer/array.js</code><br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> arrayProto = <span class=\"built_in\">Array</span>.prototype</span><br><span class=\"line\"><span class=\"keyword\">var</span> arrayMethods = <span class=\"built_in\">Object</span>.create(arrayProto)</span><br></pre></td></tr></table></figure></p>\n<p>通过<code>_.hasProto</code>方法判定代理数组对象的若干个方法：<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">protoAugment</span> (<span class=\"params\">target, src</span>) </span>&#123;</span><br><span class=\"line\">  target.__proto__ = src</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>至此Vue的数据追踪流程执行完毕。Vue提供了两个全局方法<code>Vue.set</code>和<code>Vue.delete</code>。下面来研究一下两个函数的实现，<code>Vue.set</code>最终会调用到<code>util/lang.js</code>下的<code>set</code>方法：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">exports.set = <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">set</span> (<span class=\"params\">obj, key, val</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (obj.hasOwnProperty(key)) &#123;</span><br><span class=\"line\">    obj[key] = val</span><br><span class=\"line\">    <span class=\"keyword\">return</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (obj._isVue) &#123;</span><br><span class=\"line\">    set(obj._data, key, val)</span><br><span class=\"line\">    <span class=\"keyword\">return</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> ob = obj.__ob__</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!ob) &#123;</span><br><span class=\"line\">    obj[key] = val</span><br><span class=\"line\">    <span class=\"keyword\">return</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  ob.convert(key, val)</span><br><span class=\"line\">  ob.notify()</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (ob.vms) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> i = ob.vms.length</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (i--) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">var</span> vm = ob.vms[i]</span><br><span class=\"line\">      vm._proxy(key)</span><br><span class=\"line\">      vm._digest()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>如果设置的属性之前已经有了，这个时候直接设置就行，会促发相应的更新逻辑。如果是Vue对象则设置到<code>_data</code>属性内。如果数据对象不是响应式的则直接新增数据属性。这个时候不会触发视图更新等操作。反之通知相应的监听方，并且递归追踪新增的数据值。Vue官方文档有如下提示：</p>\n<blockquote>\n<p>向响应式对象中添加一个属性，并确保这个新属性同样是响应式的，且触发视图更新。它必须用于向响应式对象上添加新属性，因为 Vue 无法探测普通的新增属性。</p>\n</blockquote>\n<p><code>Vue.delete</code>最终调用<code>util/lang.js</code>下的<code>delete</code>方法。</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">exports.delete = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">obj, key</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!obj.hasOwnProperty(key)) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">delete</span> obj[key]</span><br><span class=\"line\">  <span class=\"keyword\">var</span> ob = obj.__ob__</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!ob) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  ob.notify()</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (ob.vms) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> i = ob.vms.length</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (i--) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">var</span> vm = ob.vms[i]</span><br><span class=\"line\">      vm._unproxy(key)</span><br><span class=\"line\">      vm._digest()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>被删除的属性如果不是响应式的，则直接删除然后退出函数。反之，通知各个监听对象，并且通过<code>_unproxy</code>方法把挂在<code>Vue</code>实例上的属性删除。</p>\n"},{"title":"flex-box-xmind","date":"2016-07-31T14:10:36.000Z","_content":"\nCSS3引入了强大的弹性布局(flex-box)，解决了传统CSS布局效率低下的问题。说句实话，学了一个礼拜多的CSS知识，我到现在都还没搞清楚，float\\display\\clear。\n三个布局参数之间的联系。查资料的过程中发现了`flex-box`这一神器，仿佛抓住了救命稻草。\n\n---  \n\n兼容性探测：\n![](https://luncher.github.io/images/caniuse-flexbox.png)\n\n\n推荐一个主流浏览器的特性支持情况检测网站: [caniuse-flexbox](http://caniuse.com/#search=flex)\n\nflex-box所有属性思维导图：\n\n![](https://luncher.github.io/images/flexbox.png)\n\n","source":"_posts/flex-box-xmind.md","raw":"---\ntitle: flex-box-xmind\ndate: 2016-07-31 22:10:36\ntags: flexbox xmind\ncategories: web\n---\n\nCSS3引入了强大的弹性布局(flex-box)，解决了传统CSS布局效率低下的问题。说句实话，学了一个礼拜多的CSS知识，我到现在都还没搞清楚，float\\display\\clear。\n三个布局参数之间的联系。查资料的过程中发现了`flex-box`这一神器，仿佛抓住了救命稻草。\n\n---  \n\n兼容性探测：\n![](https://luncher.github.io/images/caniuse-flexbox.png)\n\n\n推荐一个主流浏览器的特性支持情况检测网站: [caniuse-flexbox](http://caniuse.com/#search=flex)\n\nflex-box所有属性思维导图：\n\n![](https://luncher.github.io/images/flexbox.png)\n\n","slug":"flex-box-xmind","published":1,"updated":"2018-07-01T10:30:46.495Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cdm002ey4zvd8rr4v7u","content":"<p>CSS3引入了强大的弹性布局(flex-box)，解决了传统CSS布局效率低下的问题。说句实话，学了一个礼拜多的CSS知识，我到现在都还没搞清楚，float\\display\\clear。<br>三个布局参数之间的联系。查资料的过程中发现了<code>flex-box</code>这一神器，仿佛抓住了救命稻草。</p>\n<hr>\n<p>兼容性探测：<br><img src=\"https://luncher.github.io/images/caniuse-flexbox.png\" alt=\"\"></p>\n<p>推荐一个主流浏览器的特性支持情况检测网站: <a href=\"http://caniuse.com/#search=flex\" target=\"_blank\" rel=\"noopener\">caniuse-flexbox</a></p>\n<p>flex-box所有属性思维导图：</p>\n<p><img src=\"https://luncher.github.io/images/flexbox.png\" alt=\"\"></p>\n","site":{"data":{}},"excerpt":"","more":"<p>CSS3引入了强大的弹性布局(flex-box)，解决了传统CSS布局效率低下的问题。说句实话，学了一个礼拜多的CSS知识，我到现在都还没搞清楚，float\\display\\clear。<br>三个布局参数之间的联系。查资料的过程中发现了<code>flex-box</code>这一神器，仿佛抓住了救命稻草。</p>\n<hr>\n<p>兼容性探测：<br><img src=\"https://luncher.github.io/images/caniuse-flexbox.png\" alt=\"\"></p>\n<p>推荐一个主流浏览器的特性支持情况检测网站: <a href=\"http://caniuse.com/#search=flex\" target=\"_blank\" rel=\"noopener\">caniuse-flexbox</a></p>\n<p>flex-box所有属性思维导图：</p>\n<p><img src=\"https://luncher.github.io/images/flexbox.png\" alt=\"\"></p>\n"},{"title":"electron-研究笔记","date":"2016-05-07T14:37:24.000Z","_content":"使用`electron`有一阵子了，随着项目推进，需要研究的东西也逐渐多起来。总结了以下，问题主要出现在：  \n- 跨平台兼容性  \n- 新的功能需求  \n\n=================\n\n#### `electron` 渲染进程模拟浏览器环境  \n\n`electron`渲染进程默认为`nodejs`环境，在里面你可以调用`require`引入第三方模块，但有时候我们想要的是一个真实的浏览器环境。`electron`需要做的配置如下：  \n\n```javascript  \n\n    var mainWindow = new BrowserWindow({\n        resizable: true,\n        width: size.width,\n        height: size.height,\n        title: 'HolaStudio',\n        webPreferences:\n        {\n            nodeIntegration: false,\n            preload: path.join(__dirname, 'tangide', 'expose-window-apis.js')\n        }\n    });\n\n```  \n\n创建`BrowserWindow`的时候指定`nodeIntegration`为`false`。  这样在`electron`内置浏览器里面不会有`module`和`require`全局变量。  \n\n====================\n\n#### 渲染进程与主进程之间的通信  \n`electron`下主进程与渲染进程之间的通信主要有如下几种方式：  \n- 使用`remote`模块  \n- 使用`ipc`做进程间通信  \n\n这里我选择了第二种方式：  \n```javascript  \n\n// In main process.\nconst ipcMain = require('electron').ipcMain;\nipcMain.on('asynchronous-message', function(event, arg) {\n  console.log(arg);  // prints \"ping\"\n  event.sender.send('asynchronous-reply', 'pong');\n});\n\nipcMain.on('synchronous-message', function(event, arg) {\n  console.log(arg);  // prints \"ping\"\n  event.returnValue = 'pong';\n});\n\n// In renderer process (web page).\nconst ipcRenderer = require('electron').ipcRenderer;\nconsole.log(ipcRenderer.sendSync('synchronous-message', 'ping')); // prints \"pong\"\n\nipcRenderer.on('asynchronous-reply', function(event, arg) {\n  console.log(arg); // prints \"pong\"\n});\nipcRenderer.send('asynchronous-message', 'ping');\n\n```  \n在渲染进程引入模块，都需要用`require`的方式，但是按照要求，渲染进程必须是一个真实的浏览器环境，所以需要通过其他方式来引入模块包。  \n\n```javascript  \n    preload: path.join(__dirname, 'tangide', 'expose-window-apis.js')\n```  \n\n该配置的作用在于：  \n>界面的其它脚本运行之前预先加载一个指定脚本. 这个脚本将一直可以使用 node APIs 无论 node integration 是否开启. 脚本路径为绝对路径。  \n\n`expose-window-apis.js`实现如下：  \n```javascript  \n//inner process communication\nwindow.ipc = require('electron').ipcRenderer;  \n```  \n\n通过这种方式，渲染进程`window`对应引入了`ipc`模块，解决了渲染进程引入模块包的问题：）  \n\n============================\n\n#### mac系统下快捷键问题  \n\n`Mac`系统下，默认的快捷键`Redo`、`Undo`、复制粘贴等不能使用，阅读了`electron`发现需要通过创建应用菜单的方式做一个映射。  \n```  javascript\n\nconst Menu = require(\"menu\");\n     // Create the Application's main menu\n    let template = [{\n        label: \"Application\",\n        submenu: [\n            { label: \"About Application\", selector: \"orderFrontStandardAboutPanel:\" },\n            { type: \"separator\" },\n            { label: \"Quit\", accelerator: \"Command+Q\", click: function() { app.quit(); }}\n        ]}, {\n        label: keysBinding[\"Edit\"],\n        submenu: [\n            { label: keysBinding[\"Undo\"], accelerator: \"CmdOrCtrl+Z\", selector: \"undo:\" },\n            { label: keysBinding[\"Redo\"], accelerator: \"Shift+CmdOrCtrl+Z\", selector: \"redo:\" },\n            { type: \"separator\" },\n            { label: keysBinding[\"Cut\"], accelerator: \"CmdOrCtrl+X\", selector: \"cut:\" },\n            { label: keysBinding[\"Copy\"], accelerator: \"CmdOrCtrl+C\", selector: \"copy:\" },\n            { label: keysBinding[\"Paste\"], accelerator: \"CmdOrCtrl+V\", selector: \"paste:\" },\n            { label: keysBinding[\"Select All\"], accelerator: \"CmdOrCtrl+A\", selector: \"selectAll:\" }\n        ]}\n    ];\n\n//注册菜单  \nMenu.setApplicationMenu(Menu.buildFromTemplate(template));\n\n```  \n\n=======================\n\n#### 系统快捷键冲突问题  \n\n开发者最常用到的快捷键一个是`F12`,打开开发者工具。 `F5`刷新当前网页：  \n```javascript  \nconst globalShortcut = require('global-shortcut');   \nregisterShortcut();  \nfunction registerShortcut() {\n    function doRegister(cmd, callback) {\n        globalShortcut.register(cmd, callback);\n    }\n\n    let registed = globalShortcut.isRegistered('F12');\n    if(registed) return;\n\n    doRegister('F12', function() {\n        let win = BrowserWindow.getFocusedWindow();\n        if(!win) return;\n        win.webContents.toggleDevTools();\n        console.log(\"toggleDevTools F12\");\n    });\n\n    doRegister('F6', function() {\n        let win = BrowserWindow.getFocusedWindow();\n        if(!win) return;\n        win.webContents.toggleDevTools();\n        console.log(\"toggleDevTools F6\");\n    });\n\n    doRegister('F5', function() {\n        let win = BrowserWindow.getFocusedWindow();\n        if(!win) return;\n        win.reload();\n        console.log(\"refresh\");\n    });\n\n    return;\n}\n\n```   \n\n正常情况下通过注册全局快捷键的方式能够满足绝大多数情况下的应用场景，但是使用过程中还是有如下问题：  \n- `electron`注册了快捷键后，系统默认浏览器无法通过快捷键触发调式工具。  \n- `windows`系统`electron`应用的`F12`按键无效。  \n\n对于`windows`系统`F12`无效问题，`electron`官方貌似也没有一个好的解决方案。一个讨论的[帖子](https://github.com/electron/electron/issues/5066)。  \n\n快捷键覆盖的问题，目前的解决办法如下：  \n监听`blur`和`focus`事件，在`blur`事件下注消快捷键，在`focus`下重新注册监听快捷键。  \n\n```javascript  \n    mainWindow.on('blur', function() {\n        let win = BrowserWindow.getFocusedWindow();\n        if(win) return;\n        globalShortcut.unregisterAll();\n        console.log('blur');\n    });\n\n    mainWindow.on('focus', function() {\n        registerShortcut();\n        console.log('focus');\n    });\n```  \n\n一个`electron`应用可能存在多个窗口，所以在主窗口触发`blur`事件的时候需要判断是不是所有`electron`都失去了焦点。  在这种情况下注消快捷键，以便系统浏览器能正常调式。  \n","source":"_posts/electron-研究笔记.md","raw":"---\ntitle: electron-研究笔记\ncategories: web\ndate: 2016-05-07 22:37:24\n---\n使用`electron`有一阵子了，随着项目推进，需要研究的东西也逐渐多起来。总结了以下，问题主要出现在：  \n- 跨平台兼容性  \n- 新的功能需求  \n\n=================\n\n#### `electron` 渲染进程模拟浏览器环境  \n\n`electron`渲染进程默认为`nodejs`环境，在里面你可以调用`require`引入第三方模块，但有时候我们想要的是一个真实的浏览器环境。`electron`需要做的配置如下：  \n\n```javascript  \n\n    var mainWindow = new BrowserWindow({\n        resizable: true,\n        width: size.width,\n        height: size.height,\n        title: 'HolaStudio',\n        webPreferences:\n        {\n            nodeIntegration: false,\n            preload: path.join(__dirname, 'tangide', 'expose-window-apis.js')\n        }\n    });\n\n```  \n\n创建`BrowserWindow`的时候指定`nodeIntegration`为`false`。  这样在`electron`内置浏览器里面不会有`module`和`require`全局变量。  \n\n====================\n\n#### 渲染进程与主进程之间的通信  \n`electron`下主进程与渲染进程之间的通信主要有如下几种方式：  \n- 使用`remote`模块  \n- 使用`ipc`做进程间通信  \n\n这里我选择了第二种方式：  \n```javascript  \n\n// In main process.\nconst ipcMain = require('electron').ipcMain;\nipcMain.on('asynchronous-message', function(event, arg) {\n  console.log(arg);  // prints \"ping\"\n  event.sender.send('asynchronous-reply', 'pong');\n});\n\nipcMain.on('synchronous-message', function(event, arg) {\n  console.log(arg);  // prints \"ping\"\n  event.returnValue = 'pong';\n});\n\n// In renderer process (web page).\nconst ipcRenderer = require('electron').ipcRenderer;\nconsole.log(ipcRenderer.sendSync('synchronous-message', 'ping')); // prints \"pong\"\n\nipcRenderer.on('asynchronous-reply', function(event, arg) {\n  console.log(arg); // prints \"pong\"\n});\nipcRenderer.send('asynchronous-message', 'ping');\n\n```  \n在渲染进程引入模块，都需要用`require`的方式，但是按照要求，渲染进程必须是一个真实的浏览器环境，所以需要通过其他方式来引入模块包。  \n\n```javascript  \n    preload: path.join(__dirname, 'tangide', 'expose-window-apis.js')\n```  \n\n该配置的作用在于：  \n>界面的其它脚本运行之前预先加载一个指定脚本. 这个脚本将一直可以使用 node APIs 无论 node integration 是否开启. 脚本路径为绝对路径。  \n\n`expose-window-apis.js`实现如下：  \n```javascript  \n//inner process communication\nwindow.ipc = require('electron').ipcRenderer;  \n```  \n\n通过这种方式，渲染进程`window`对应引入了`ipc`模块，解决了渲染进程引入模块包的问题：）  \n\n============================\n\n#### mac系统下快捷键问题  \n\n`Mac`系统下，默认的快捷键`Redo`、`Undo`、复制粘贴等不能使用，阅读了`electron`发现需要通过创建应用菜单的方式做一个映射。  \n```  javascript\n\nconst Menu = require(\"menu\");\n     // Create the Application's main menu\n    let template = [{\n        label: \"Application\",\n        submenu: [\n            { label: \"About Application\", selector: \"orderFrontStandardAboutPanel:\" },\n            { type: \"separator\" },\n            { label: \"Quit\", accelerator: \"Command+Q\", click: function() { app.quit(); }}\n        ]}, {\n        label: keysBinding[\"Edit\"],\n        submenu: [\n            { label: keysBinding[\"Undo\"], accelerator: \"CmdOrCtrl+Z\", selector: \"undo:\" },\n            { label: keysBinding[\"Redo\"], accelerator: \"Shift+CmdOrCtrl+Z\", selector: \"redo:\" },\n            { type: \"separator\" },\n            { label: keysBinding[\"Cut\"], accelerator: \"CmdOrCtrl+X\", selector: \"cut:\" },\n            { label: keysBinding[\"Copy\"], accelerator: \"CmdOrCtrl+C\", selector: \"copy:\" },\n            { label: keysBinding[\"Paste\"], accelerator: \"CmdOrCtrl+V\", selector: \"paste:\" },\n            { label: keysBinding[\"Select All\"], accelerator: \"CmdOrCtrl+A\", selector: \"selectAll:\" }\n        ]}\n    ];\n\n//注册菜单  \nMenu.setApplicationMenu(Menu.buildFromTemplate(template));\n\n```  \n\n=======================\n\n#### 系统快捷键冲突问题  \n\n开发者最常用到的快捷键一个是`F12`,打开开发者工具。 `F5`刷新当前网页：  \n```javascript  \nconst globalShortcut = require('global-shortcut');   \nregisterShortcut();  \nfunction registerShortcut() {\n    function doRegister(cmd, callback) {\n        globalShortcut.register(cmd, callback);\n    }\n\n    let registed = globalShortcut.isRegistered('F12');\n    if(registed) return;\n\n    doRegister('F12', function() {\n        let win = BrowserWindow.getFocusedWindow();\n        if(!win) return;\n        win.webContents.toggleDevTools();\n        console.log(\"toggleDevTools F12\");\n    });\n\n    doRegister('F6', function() {\n        let win = BrowserWindow.getFocusedWindow();\n        if(!win) return;\n        win.webContents.toggleDevTools();\n        console.log(\"toggleDevTools F6\");\n    });\n\n    doRegister('F5', function() {\n        let win = BrowserWindow.getFocusedWindow();\n        if(!win) return;\n        win.reload();\n        console.log(\"refresh\");\n    });\n\n    return;\n}\n\n```   \n\n正常情况下通过注册全局快捷键的方式能够满足绝大多数情况下的应用场景，但是使用过程中还是有如下问题：  \n- `electron`注册了快捷键后，系统默认浏览器无法通过快捷键触发调式工具。  \n- `windows`系统`electron`应用的`F12`按键无效。  \n\n对于`windows`系统`F12`无效问题，`electron`官方貌似也没有一个好的解决方案。一个讨论的[帖子](https://github.com/electron/electron/issues/5066)。  \n\n快捷键覆盖的问题，目前的解决办法如下：  \n监听`blur`和`focus`事件，在`blur`事件下注消快捷键，在`focus`下重新注册监听快捷键。  \n\n```javascript  \n    mainWindow.on('blur', function() {\n        let win = BrowserWindow.getFocusedWindow();\n        if(win) return;\n        globalShortcut.unregisterAll();\n        console.log('blur');\n    });\n\n    mainWindow.on('focus', function() {\n        registerShortcut();\n        console.log('focus');\n    });\n```  \n\n一个`electron`应用可能存在多个窗口，所以在主窗口触发`blur`事件的时候需要判断是不是所有`electron`都失去了焦点。  在这种情况下注消快捷键，以便系统浏览器能正常调式。  \n","slug":"electron-研究笔记","published":1,"updated":"2018-07-01T10:30:46.494Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cdn002hy4zvdseavxwq","content":"<p>使用<code>electron</code>有一阵子了，随着项目推进，需要研究的东西也逐渐多起来。总结了以下，问题主要出现在：  </p>\n<ul>\n<li>跨平台兼容性  </li>\n<li>新的功能需求  </li>\n</ul>\n<p>=================</p>\n<h4 id=\"electron-渲染进程模拟浏览器环境\"><a href=\"#electron-渲染进程模拟浏览器环境\" class=\"headerlink\" title=\"electron 渲染进程模拟浏览器环境\"></a><code>electron</code> 渲染进程模拟浏览器环境</h4><p><code>electron</code>渲染进程默认为<code>nodejs</code>环境，在里面你可以调用<code>require</code>引入第三方模块，但有时候我们想要的是一个真实的浏览器环境。<code>electron</code>需要做的配置如下：  </p>\n<pre><code class=\"javascript\">\n<span class=\"keyword\">var</span> mainWindow = <span class=\"keyword\">new</span> BrowserWindow({\n    resizable: <span class=\"literal\">true</span>,\n    width: size.width,\n    height: size.height,\n    title: <span class=\"string\">'HolaStudio'</span>,\n    webPreferences:\n    {\n        nodeIntegration: <span class=\"literal\">false</span>,\n        preload: path.join(__dirname, <span class=\"string\">'tangide'</span>, <span class=\"string\">'expose-window-apis.js'</span>)\n    }\n});\n\n</code></pre>\n<p>创建<code>BrowserWindow</code>的时候指定<code>nodeIntegration</code>为<code>false</code>。  这样在<code>electron</code>内置浏览器里面不会有<code>module</code>和<code>require</code>全局变量。  </p>\n<p>====================</p>\n<h4 id=\"渲染进程与主进程之间的通信\"><a href=\"#渲染进程与主进程之间的通信\" class=\"headerlink\" title=\"渲染进程与主进程之间的通信\"></a>渲染进程与主进程之间的通信</h4><p><code>electron</code>下主进程与渲染进程之间的通信主要有如下几种方式：  </p>\n<ul>\n<li>使用<code>remote</code>模块  </li>\n<li>使用<code>ipc</code>做进程间通信  </li>\n</ul>\n<p>这里我选择了第二种方式：  </p>\n<pre><code class=\"javascript\">\n<span class=\"comment\">// In main process.</span>\n<span class=\"keyword\">const</span> ipcMain = <span class=\"built_in\">require</span>(<span class=\"string\">'electron'</span>).ipcMain;\nipcMain.on(<span class=\"string\">'asynchronous-message'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">event, arg</span>) </span>{\n  <span class=\"built_in\">console</span>.log(arg);  <span class=\"comment\">// prints \"ping\"</span>\n  event.sender.send(<span class=\"string\">'asynchronous-reply'</span>, <span class=\"string\">'pong'</span>);\n});\n\nipcMain.on(<span class=\"string\">'synchronous-message'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">event, arg</span>) </span>{\n  <span class=\"built_in\">console</span>.log(arg);  <span class=\"comment\">// prints \"ping\"</span>\n  event.returnValue = <span class=\"string\">'pong'</span>;\n});\n\n<span class=\"comment\">// In renderer process (web page).</span>\n<span class=\"keyword\">const</span> ipcRenderer = <span class=\"built_in\">require</span>(<span class=\"string\">'electron'</span>).ipcRenderer;\n<span class=\"built_in\">console</span>.log(ipcRenderer.sendSync(<span class=\"string\">'synchronous-message'</span>, <span class=\"string\">'ping'</span>)); <span class=\"comment\">// prints \"pong\"</span>\n\nipcRenderer.on(<span class=\"string\">'asynchronous-reply'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">event, arg</span>) </span>{\n  <span class=\"built_in\">console</span>.log(arg); <span class=\"comment\">// prints \"pong\"</span>\n});\nipcRenderer.send(<span class=\"string\">'asynchronous-message'</span>, <span class=\"string\">'ping'</span>);\n\n</code></pre>\n<p>在渲染进程引入模块，都需要用<code>require</code>的方式，但是按照要求，渲染进程必须是一个真实的浏览器环境，所以需要通过其他方式来引入模块包。  </p>\n<pre><code class=\"javascript\">preload: path.join(__dirname, <span class=\"string\">'tangide'</span>, <span class=\"string\">'expose-window-apis.js'</span>)\n</code></pre>\n<p>该配置的作用在于：  </p>\n<blockquote>\n<p>界面的其它脚本运行之前预先加载一个指定脚本. 这个脚本将一直可以使用 node APIs 无论 node integration 是否开启. 脚本路径为绝对路径。  </p>\n</blockquote>\n<p><code>expose-window-apis.js</code>实现如下：  </p>\n<pre><code class=\"javascript\"><span class=\"comment\">//inner process communication</span>\n<span class=\"built_in\">window</span>.ipc = <span class=\"built_in\">require</span>(<span class=\"string\">'electron'</span>).ipcRenderer;  \n</code></pre>\n<p>通过这种方式，渲染进程<code>window</code>对应引入了<code>ipc</code>模块，解决了渲染进程引入模块包的问题：）  </p>\n<p>============================</p>\n<h4 id=\"mac系统下快捷键问题\"><a href=\"#mac系统下快捷键问题\" class=\"headerlink\" title=\"mac系统下快捷键问题\"></a>mac系统下快捷键问题</h4><p><code>Mac</code>系统下，默认的快捷键<code>Redo</code>、<code>Undo</code>、复制粘贴等不能使用，阅读了<code>electron</code>发现需要通过创建应用菜单的方式做一个映射。  </p>\n<pre><code class=\"javascript\">\n<span class=\"keyword\">const</span> Menu = <span class=\"built_in\">require</span>(<span class=\"string\">\"menu\"</span>);\n     <span class=\"comment\">// Create the Application's main menu</span>\n    <span class=\"keyword\">let</span> template = [{\n        label: <span class=\"string\">\"Application\"</span>,\n        submenu: [\n            { <span class=\"attr\">label</span>: <span class=\"string\">\"About Application\"</span>, <span class=\"attr\">selector</span>: <span class=\"string\">\"orderFrontStandardAboutPanel:\"</span> },\n            { <span class=\"attr\">type</span>: <span class=\"string\">\"separator\"</span> },\n            { <span class=\"attr\">label</span>: <span class=\"string\">\"Quit\"</span>, <span class=\"attr\">accelerator</span>: <span class=\"string\">\"Command+Q\"</span>, <span class=\"attr\">click</span>: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>{ app.quit(); }}\n        ]}, {\n        label: keysBinding[<span class=\"string\">\"Edit\"</span>],\n        submenu: [\n            { <span class=\"attr\">label</span>: keysBinding[<span class=\"string\">\"Undo\"</span>], <span class=\"attr\">accelerator</span>: <span class=\"string\">\"CmdOrCtrl+Z\"</span>, <span class=\"attr\">selector</span>: <span class=\"string\">\"undo:\"</span> },\n            { <span class=\"attr\">label</span>: keysBinding[<span class=\"string\">\"Redo\"</span>], <span class=\"attr\">accelerator</span>: <span class=\"string\">\"Shift+CmdOrCtrl+Z\"</span>, <span class=\"attr\">selector</span>: <span class=\"string\">\"redo:\"</span> },\n            { <span class=\"attr\">type</span>: <span class=\"string\">\"separator\"</span> },\n            { <span class=\"attr\">label</span>: keysBinding[<span class=\"string\">\"Cut\"</span>], <span class=\"attr\">accelerator</span>: <span class=\"string\">\"CmdOrCtrl+X\"</span>, <span class=\"attr\">selector</span>: <span class=\"string\">\"cut:\"</span> },\n            { <span class=\"attr\">label</span>: keysBinding[<span class=\"string\">\"Copy\"</span>], <span class=\"attr\">accelerator</span>: <span class=\"string\">\"CmdOrCtrl+C\"</span>, <span class=\"attr\">selector</span>: <span class=\"string\">\"copy:\"</span> },\n            { <span class=\"attr\">label</span>: keysBinding[<span class=\"string\">\"Paste\"</span>], <span class=\"attr\">accelerator</span>: <span class=\"string\">\"CmdOrCtrl+V\"</span>, <span class=\"attr\">selector</span>: <span class=\"string\">\"paste:\"</span> },\n            { <span class=\"attr\">label</span>: keysBinding[<span class=\"string\">\"Select All\"</span>], <span class=\"attr\">accelerator</span>: <span class=\"string\">\"CmdOrCtrl+A\"</span>, <span class=\"attr\">selector</span>: <span class=\"string\">\"selectAll:\"</span> }\n        ]}\n    ];\n\n<span class=\"comment\">//注册菜单  </span>\nMenu.setApplicationMenu(Menu.buildFromTemplate(template));\n\n</code></pre>\n<p>=======================</p>\n<h4 id=\"系统快捷键冲突问题\"><a href=\"#系统快捷键冲突问题\" class=\"headerlink\" title=\"系统快捷键冲突问题\"></a>系统快捷键冲突问题</h4><p>开发者最常用到的快捷键一个是<code>F12</code>,打开开发者工具。 <code>F5</code>刷新当前网页：  </p>\n<pre><code class=\"javascript\"><span class=\"keyword\">const</span> globalShortcut = <span class=\"built_in\">require</span>(<span class=\"string\">'global-shortcut'</span>);   \nregisterShortcut();  \n<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">registerShortcut</span>(<span class=\"params\"></span>) </span>{\n    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">doRegister</span>(<span class=\"params\">cmd, callback</span>) </span>{\n        globalShortcut.register(cmd, callback);\n    }\n\n    <span class=\"keyword\">let</span> registed = globalShortcut.isRegistered(<span class=\"string\">'F12'</span>);\n    <span class=\"keyword\">if</span>(registed) <span class=\"keyword\">return</span>;\n\n    doRegister(<span class=\"string\">'F12'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>{\n        <span class=\"keyword\">let</span> win = BrowserWindow.getFocusedWindow();\n        <span class=\"keyword\">if</span>(!win) <span class=\"keyword\">return</span>;\n        win.webContents.toggleDevTools();\n        <span class=\"built_in\">console</span>.log(<span class=\"string\">\"toggleDevTools F12\"</span>);\n    });\n\n    doRegister(<span class=\"string\">'F6'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>{\n        <span class=\"keyword\">let</span> win = BrowserWindow.getFocusedWindow();\n        <span class=\"keyword\">if</span>(!win) <span class=\"keyword\">return</span>;\n        win.webContents.toggleDevTools();\n        <span class=\"built_in\">console</span>.log(<span class=\"string\">\"toggleDevTools F6\"</span>);\n    });\n\n    doRegister(<span class=\"string\">'F5'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>{\n        <span class=\"keyword\">let</span> win = BrowserWindow.getFocusedWindow();\n        <span class=\"keyword\">if</span>(!win) <span class=\"keyword\">return</span>;\n        win.reload();\n        <span class=\"built_in\">console</span>.log(<span class=\"string\">\"refresh\"</span>);\n    });\n\n    <span class=\"keyword\">return</span>;\n}\n\n</code></pre>\n<p>正常情况下通过注册全局快捷键的方式能够满足绝大多数情况下的应用场景，但是使用过程中还是有如下问题：  </p>\n<ul>\n<li><code>electron</code>注册了快捷键后，系统默认浏览器无法通过快捷键触发调式工具。  </li>\n<li><code>windows</code>系统<code>electron</code>应用的<code>F12</code>按键无效。  </li>\n</ul>\n<p>对于<code>windows</code>系统<code>F12</code>无效问题，<code>electron</code>官方貌似也没有一个好的解决方案。一个讨论的<a href=\"https://github.com/electron/electron/issues/5066\" target=\"_blank\" rel=\"noopener\">帖子</a>。  </p>\n<p>快捷键覆盖的问题，目前的解决办法如下：<br>监听<code>blur</code>和<code>focus</code>事件，在<code>blur</code>事件下注消快捷键，在<code>focus</code>下重新注册监听快捷键。  </p>\n<pre><code class=\"javascript\">mainWindow.on(<span class=\"string\">'blur'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>{\n    <span class=\"keyword\">let</span> win = BrowserWindow.getFocusedWindow();\n    <span class=\"keyword\">if</span>(win) <span class=\"keyword\">return</span>;\n    globalShortcut.unregisterAll();\n    <span class=\"built_in\">console</span>.log(<span class=\"string\">'blur'</span>);\n});\n\nmainWindow.on(<span class=\"string\">'focus'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>{\n    registerShortcut();\n    <span class=\"built_in\">console</span>.log(<span class=\"string\">'focus'</span>);\n});\n</code></pre>\n<p>一个<code>electron</code>应用可能存在多个窗口，所以在主窗口触发<code>blur</code>事件的时候需要判断是不是所有<code>electron</code>都失去了焦点。  在这种情况下注消快捷键，以便系统浏览器能正常调式。  </p>\n","site":{"data":{}},"excerpt":"","more":"<p>使用<code>electron</code>有一阵子了，随着项目推进，需要研究的东西也逐渐多起来。总结了以下，问题主要出现在：  </p>\n<ul>\n<li>跨平台兼容性  </li>\n<li>新的功能需求  </li>\n</ul>\n<p>=================</p>\n<h4 id=\"electron-渲染进程模拟浏览器环境\"><a href=\"#electron-渲染进程模拟浏览器环境\" class=\"headerlink\" title=\"electron 渲染进程模拟浏览器环境\"></a><code>electron</code> 渲染进程模拟浏览器环境</h4><p><code>electron</code>渲染进程默认为<code>nodejs</code>环境，在里面你可以调用<code>require</code>引入第三方模块，但有时候我们想要的是一个真实的浏览器环境。<code>electron</code>需要做的配置如下：  </p>\n<pre><code class=\"javascript\">\n<span class=\"keyword\">var</span> mainWindow = <span class=\"keyword\">new</span> BrowserWindow({\n    resizable: <span class=\"literal\">true</span>,\n    width: size.width,\n    height: size.height,\n    title: <span class=\"string\">'HolaStudio'</span>,\n    webPreferences:\n    {\n        nodeIntegration: <span class=\"literal\">false</span>,\n        preload: path.join(__dirname, <span class=\"string\">'tangide'</span>, <span class=\"string\">'expose-window-apis.js'</span>)\n    }\n});\n\n</code></pre>\n<p>创建<code>BrowserWindow</code>的时候指定<code>nodeIntegration</code>为<code>false</code>。  这样在<code>electron</code>内置浏览器里面不会有<code>module</code>和<code>require</code>全局变量。  </p>\n<p>====================</p>\n<h4 id=\"渲染进程与主进程之间的通信\"><a href=\"#渲染进程与主进程之间的通信\" class=\"headerlink\" title=\"渲染进程与主进程之间的通信\"></a>渲染进程与主进程之间的通信</h4><p><code>electron</code>下主进程与渲染进程之间的通信主要有如下几种方式：  </p>\n<ul>\n<li>使用<code>remote</code>模块  </li>\n<li>使用<code>ipc</code>做进程间通信  </li>\n</ul>\n<p>这里我选择了第二种方式：  </p>\n<pre><code class=\"javascript\">\n<span class=\"comment\">// In main process.</span>\n<span class=\"keyword\">const</span> ipcMain = <span class=\"built_in\">require</span>(<span class=\"string\">'electron'</span>).ipcMain;\nipcMain.on(<span class=\"string\">'asynchronous-message'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">event, arg</span>) </span>{\n  <span class=\"built_in\">console</span>.log(arg);  <span class=\"comment\">// prints \"ping\"</span>\n  event.sender.send(<span class=\"string\">'asynchronous-reply'</span>, <span class=\"string\">'pong'</span>);\n});\n\nipcMain.on(<span class=\"string\">'synchronous-message'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">event, arg</span>) </span>{\n  <span class=\"built_in\">console</span>.log(arg);  <span class=\"comment\">// prints \"ping\"</span>\n  event.returnValue = <span class=\"string\">'pong'</span>;\n});\n\n<span class=\"comment\">// In renderer process (web page).</span>\n<span class=\"keyword\">const</span> ipcRenderer = <span class=\"built_in\">require</span>(<span class=\"string\">'electron'</span>).ipcRenderer;\n<span class=\"built_in\">console</span>.log(ipcRenderer.sendSync(<span class=\"string\">'synchronous-message'</span>, <span class=\"string\">'ping'</span>)); <span class=\"comment\">// prints \"pong\"</span>\n\nipcRenderer.on(<span class=\"string\">'asynchronous-reply'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">event, arg</span>) </span>{\n  <span class=\"built_in\">console</span>.log(arg); <span class=\"comment\">// prints \"pong\"</span>\n});\nipcRenderer.send(<span class=\"string\">'asynchronous-message'</span>, <span class=\"string\">'ping'</span>);\n\n</code></pre>\n<p>在渲染进程引入模块，都需要用<code>require</code>的方式，但是按照要求，渲染进程必须是一个真实的浏览器环境，所以需要通过其他方式来引入模块包。  </p>\n<pre><code class=\"javascript\">preload: path.join(__dirname, <span class=\"string\">'tangide'</span>, <span class=\"string\">'expose-window-apis.js'</span>)\n</code></pre>\n<p>该配置的作用在于：  </p>\n<blockquote>\n<p>界面的其它脚本运行之前预先加载一个指定脚本. 这个脚本将一直可以使用 node APIs 无论 node integration 是否开启. 脚本路径为绝对路径。  </p>\n</blockquote>\n<p><code>expose-window-apis.js</code>实现如下：  </p>\n<pre><code class=\"javascript\"><span class=\"comment\">//inner process communication</span>\n<span class=\"built_in\">window</span>.ipc = <span class=\"built_in\">require</span>(<span class=\"string\">'electron'</span>).ipcRenderer;  \n</code></pre>\n<p>通过这种方式，渲染进程<code>window</code>对应引入了<code>ipc</code>模块，解决了渲染进程引入模块包的问题：）  </p>\n<p>============================</p>\n<h4 id=\"mac系统下快捷键问题\"><a href=\"#mac系统下快捷键问题\" class=\"headerlink\" title=\"mac系统下快捷键问题\"></a>mac系统下快捷键问题</h4><p><code>Mac</code>系统下，默认的快捷键<code>Redo</code>、<code>Undo</code>、复制粘贴等不能使用，阅读了<code>electron</code>发现需要通过创建应用菜单的方式做一个映射。  </p>\n<pre><code class=\"javascript\">\n<span class=\"keyword\">const</span> Menu = <span class=\"built_in\">require</span>(<span class=\"string\">\"menu\"</span>);\n     <span class=\"comment\">// Create the Application's main menu</span>\n    <span class=\"keyword\">let</span> template = [{\n        label: <span class=\"string\">\"Application\"</span>,\n        submenu: [\n            { <span class=\"attr\">label</span>: <span class=\"string\">\"About Application\"</span>, <span class=\"attr\">selector</span>: <span class=\"string\">\"orderFrontStandardAboutPanel:\"</span> },\n            { <span class=\"attr\">type</span>: <span class=\"string\">\"separator\"</span> },\n            { <span class=\"attr\">label</span>: <span class=\"string\">\"Quit\"</span>, <span class=\"attr\">accelerator</span>: <span class=\"string\">\"Command+Q\"</span>, <span class=\"attr\">click</span>: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>{ app.quit(); }}\n        ]}, {\n        label: keysBinding[<span class=\"string\">\"Edit\"</span>],\n        submenu: [\n            { <span class=\"attr\">label</span>: keysBinding[<span class=\"string\">\"Undo\"</span>], <span class=\"attr\">accelerator</span>: <span class=\"string\">\"CmdOrCtrl+Z\"</span>, <span class=\"attr\">selector</span>: <span class=\"string\">\"undo:\"</span> },\n            { <span class=\"attr\">label</span>: keysBinding[<span class=\"string\">\"Redo\"</span>], <span class=\"attr\">accelerator</span>: <span class=\"string\">\"Shift+CmdOrCtrl+Z\"</span>, <span class=\"attr\">selector</span>: <span class=\"string\">\"redo:\"</span> },\n            { <span class=\"attr\">type</span>: <span class=\"string\">\"separator\"</span> },\n            { <span class=\"attr\">label</span>: keysBinding[<span class=\"string\">\"Cut\"</span>], <span class=\"attr\">accelerator</span>: <span class=\"string\">\"CmdOrCtrl+X\"</span>, <span class=\"attr\">selector</span>: <span class=\"string\">\"cut:\"</span> },\n            { <span class=\"attr\">label</span>: keysBinding[<span class=\"string\">\"Copy\"</span>], <span class=\"attr\">accelerator</span>: <span class=\"string\">\"CmdOrCtrl+C\"</span>, <span class=\"attr\">selector</span>: <span class=\"string\">\"copy:\"</span> },\n            { <span class=\"attr\">label</span>: keysBinding[<span class=\"string\">\"Paste\"</span>], <span class=\"attr\">accelerator</span>: <span class=\"string\">\"CmdOrCtrl+V\"</span>, <span class=\"attr\">selector</span>: <span class=\"string\">\"paste:\"</span> },\n            { <span class=\"attr\">label</span>: keysBinding[<span class=\"string\">\"Select All\"</span>], <span class=\"attr\">accelerator</span>: <span class=\"string\">\"CmdOrCtrl+A\"</span>, <span class=\"attr\">selector</span>: <span class=\"string\">\"selectAll:\"</span> }\n        ]}\n    ];\n\n<span class=\"comment\">//注册菜单  </span>\nMenu.setApplicationMenu(Menu.buildFromTemplate(template));\n\n</code></pre>\n<p>=======================</p>\n<h4 id=\"系统快捷键冲突问题\"><a href=\"#系统快捷键冲突问题\" class=\"headerlink\" title=\"系统快捷键冲突问题\"></a>系统快捷键冲突问题</h4><p>开发者最常用到的快捷键一个是<code>F12</code>,打开开发者工具。 <code>F5</code>刷新当前网页：  </p>\n<pre><code class=\"javascript\"><span class=\"keyword\">const</span> globalShortcut = <span class=\"built_in\">require</span>(<span class=\"string\">'global-shortcut'</span>);   \nregisterShortcut();  \n<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">registerShortcut</span>(<span class=\"params\"></span>) </span>{\n    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">doRegister</span>(<span class=\"params\">cmd, callback</span>) </span>{\n        globalShortcut.register(cmd, callback);\n    }\n\n    <span class=\"keyword\">let</span> registed = globalShortcut.isRegistered(<span class=\"string\">'F12'</span>);\n    <span class=\"keyword\">if</span>(registed) <span class=\"keyword\">return</span>;\n\n    doRegister(<span class=\"string\">'F12'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>{\n        <span class=\"keyword\">let</span> win = BrowserWindow.getFocusedWindow();\n        <span class=\"keyword\">if</span>(!win) <span class=\"keyword\">return</span>;\n        win.webContents.toggleDevTools();\n        <span class=\"built_in\">console</span>.log(<span class=\"string\">\"toggleDevTools F12\"</span>);\n    });\n\n    doRegister(<span class=\"string\">'F6'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>{\n        <span class=\"keyword\">let</span> win = BrowserWindow.getFocusedWindow();\n        <span class=\"keyword\">if</span>(!win) <span class=\"keyword\">return</span>;\n        win.webContents.toggleDevTools();\n        <span class=\"built_in\">console</span>.log(<span class=\"string\">\"toggleDevTools F6\"</span>);\n    });\n\n    doRegister(<span class=\"string\">'F5'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>{\n        <span class=\"keyword\">let</span> win = BrowserWindow.getFocusedWindow();\n        <span class=\"keyword\">if</span>(!win) <span class=\"keyword\">return</span>;\n        win.reload();\n        <span class=\"built_in\">console</span>.log(<span class=\"string\">\"refresh\"</span>);\n    });\n\n    <span class=\"keyword\">return</span>;\n}\n\n</code></pre>\n<p>正常情况下通过注册全局快捷键的方式能够满足绝大多数情况下的应用场景，但是使用过程中还是有如下问题：  </p>\n<ul>\n<li><code>electron</code>注册了快捷键后，系统默认浏览器无法通过快捷键触发调式工具。  </li>\n<li><code>windows</code>系统<code>electron</code>应用的<code>F12</code>按键无效。  </li>\n</ul>\n<p>对于<code>windows</code>系统<code>F12</code>无效问题，<code>electron</code>官方貌似也没有一个好的解决方案。一个讨论的<a href=\"https://github.com/electron/electron/issues/5066\" target=\"_blank\" rel=\"noopener\">帖子</a>。  </p>\n<p>快捷键覆盖的问题，目前的解决办法如下：<br>监听<code>blur</code>和<code>focus</code>事件，在<code>blur</code>事件下注消快捷键，在<code>focus</code>下重新注册监听快捷键。  </p>\n<pre><code class=\"javascript\">mainWindow.on(<span class=\"string\">'blur'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>{\n    <span class=\"keyword\">let</span> win = BrowserWindow.getFocusedWindow();\n    <span class=\"keyword\">if</span>(win) <span class=\"keyword\">return</span>;\n    globalShortcut.unregisterAll();\n    <span class=\"built_in\">console</span>.log(<span class=\"string\">'blur'</span>);\n});\n\nmainWindow.on(<span class=\"string\">'focus'</span>, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>{\n    registerShortcut();\n    <span class=\"built_in\">console</span>.log(<span class=\"string\">'focus'</span>);\n});\n</code></pre>\n<p>一个<code>electron</code>应用可能存在多个窗口，所以在主窗口触发<code>blur</code>事件的时候需要判断是不是所有<code>electron</code>都失去了焦点。  在这种情况下注消快捷键，以便系统浏览器能正常调式。  </p>\n"},{"title":"jvascript模块管理","date":"2016-01-15T08:26:23.000Z","_content":"\n代码模块化目的：\n\n- 1、封装\n- 2、代码复用\n\n---\n\n# 常见模块化解决反案\n\n## 1、AMD(`Asynchronous Module Definition`)\n\n  >`RequireJS`实现了AMD规范。\n\n---\n\n## 2、CMD(`Common Module Definition`)\n\n  >`SeaJS`实现了`CMD`规范。\n\n---\n\n## 3、CommonJS Modules\n\n  >`NodeJS`环境的模块加载实现了`CommonJS`规范。每个文件都是一个单独的模块，\n有单独的作用域。模块之间通过global设置共享变量。`Browserify`可以让服务器代码跑在客户端。\n\n  特点：\n\n- 1、所有代码都运行在模块作用域，不会污染全局作用域。\n- 2、模块可以多次加载，但是只会在第一次加载时运行一次，\n    然后运行结果就被缓存了，以后再加载，就直接读取缓存结果。要想让模块再次运行，必须清除缓存。\n- 3、模块加载的顺序，按照其在代码中出现的顺序。\n\n常见问题：\n\n- 清除缓存：\n  delete require.cache[require.resolve('./b.js')]\n模块按照绝对路径缓存，require.resolve返回模块的绝对路径。\n\n- 解决互相依赖包含问题：\n  CommonJS的做法是，一旦出现某个模块被\"循环加载\"，就只输出已经执行的部分，还未执行的部分不会输出。\n\n总结：\n> AMD、CMD主要用在浏览器端异步加载、COMMONJS主要用在服务器端的同步加载。\n","source":"_posts/javascript模块管理.md","raw":"---\ntitle: jvascript模块管理\ndate: 2016-01-15 16:26:23\ntags:\n  - AMD\n  - CMD\n  - commonjs\ncategories: web\n---\n\n代码模块化目的：\n\n- 1、封装\n- 2、代码复用\n\n---\n\n# 常见模块化解决反案\n\n## 1、AMD(`Asynchronous Module Definition`)\n\n  >`RequireJS`实现了AMD规范。\n\n---\n\n## 2、CMD(`Common Module Definition`)\n\n  >`SeaJS`实现了`CMD`规范。\n\n---\n\n## 3、CommonJS Modules\n\n  >`NodeJS`环境的模块加载实现了`CommonJS`规范。每个文件都是一个单独的模块，\n有单独的作用域。模块之间通过global设置共享变量。`Browserify`可以让服务器代码跑在客户端。\n\n  特点：\n\n- 1、所有代码都运行在模块作用域，不会污染全局作用域。\n- 2、模块可以多次加载，但是只会在第一次加载时运行一次，\n    然后运行结果就被缓存了，以后再加载，就直接读取缓存结果。要想让模块再次运行，必须清除缓存。\n- 3、模块加载的顺序，按照其在代码中出现的顺序。\n\n常见问题：\n\n- 清除缓存：\n  delete require.cache[require.resolve('./b.js')]\n模块按照绝对路径缓存，require.resolve返回模块的绝对路径。\n\n- 解决互相依赖包含问题：\n  CommonJS的做法是，一旦出现某个模块被\"循环加载\"，就只输出已经执行的部分，还未执行的部分不会输出。\n\n总结：\n> AMD、CMD主要用在浏览器端异步加载、COMMONJS主要用在服务器端的同步加载。\n","slug":"javascript模块管理","published":1,"updated":"2018-07-01T10:30:46.495Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cdo002ly4zvejdwvsfb","content":"<p>代码模块化目的：</p>\n<ul>\n<li>1、封装</li>\n<li>2、代码复用</li>\n</ul>\n<hr>\n<h1 id=\"常见模块化解决反案\"><a href=\"#常见模块化解决反案\" class=\"headerlink\" title=\"常见模块化解决反案\"></a>常见模块化解决反案</h1><h2 id=\"1、AMD-Asynchronous-Module-Definition\"><a href=\"#1、AMD-Asynchronous-Module-Definition\" class=\"headerlink\" title=\"1、AMD(Asynchronous Module Definition)\"></a>1、AMD(<code>Asynchronous Module Definition</code>)</h2><blockquote>\n<p><code>RequireJS</code>实现了AMD规范。</p>\n</blockquote>\n<hr>\n<h2 id=\"2、CMD-Common-Module-Definition\"><a href=\"#2、CMD-Common-Module-Definition\" class=\"headerlink\" title=\"2、CMD(Common Module Definition)\"></a>2、CMD(<code>Common Module Definition</code>)</h2><blockquote>\n<p><code>SeaJS</code>实现了<code>CMD</code>规范。</p>\n</blockquote>\n<hr>\n<h2 id=\"3、CommonJS-Modules\"><a href=\"#3、CommonJS-Modules\" class=\"headerlink\" title=\"3、CommonJS Modules\"></a>3、CommonJS Modules</h2><blockquote>\n<p><code>NodeJS</code>环境的模块加载实现了<code>CommonJS</code>规范。每个文件都是一个单独的模块，<br>有单独的作用域。模块之间通过global设置共享变量。<code>Browserify</code>可以让服务器代码跑在客户端。</p>\n</blockquote>\n<p>  特点：</p>\n<ul>\n<li>1、所有代码都运行在模块作用域，不会污染全局作用域。</li>\n<li>2、模块可以多次加载，但是只会在第一次加载时运行一次，<br>  然后运行结果就被缓存了，以后再加载，就直接读取缓存结果。要想让模块再次运行，必须清除缓存。</li>\n<li>3、模块加载的顺序，按照其在代码中出现的顺序。</li>\n</ul>\n<p>常见问题：</p>\n<ul>\n<li><p>清除缓存：<br>delete require.cache[require.resolve(‘./b.js’)]<br>模块按照绝对路径缓存，require.resolve返回模块的绝对路径。</p>\n</li>\n<li><p>解决互相依赖包含问题：<br>CommonJS的做法是，一旦出现某个模块被”循环加载”，就只输出已经执行的部分，还未执行的部分不会输出。</p>\n</li>\n</ul>\n<p>总结：</p>\n<blockquote>\n<p>AMD、CMD主要用在浏览器端异步加载、COMMONJS主要用在服务器端的同步加载。</p>\n</blockquote>\n","site":{"data":{}},"excerpt":"","more":"<p>代码模块化目的：</p>\n<ul>\n<li>1、封装</li>\n<li>2、代码复用</li>\n</ul>\n<hr>\n<h1 id=\"常见模块化解决反案\"><a href=\"#常见模块化解决反案\" class=\"headerlink\" title=\"常见模块化解决反案\"></a>常见模块化解决反案</h1><h2 id=\"1、AMD-Asynchronous-Module-Definition\"><a href=\"#1、AMD-Asynchronous-Module-Definition\" class=\"headerlink\" title=\"1、AMD(Asynchronous Module Definition)\"></a>1、AMD(<code>Asynchronous Module Definition</code>)</h2><blockquote>\n<p><code>RequireJS</code>实现了AMD规范。</p>\n</blockquote>\n<hr>\n<h2 id=\"2、CMD-Common-Module-Definition\"><a href=\"#2、CMD-Common-Module-Definition\" class=\"headerlink\" title=\"2、CMD(Common Module Definition)\"></a>2、CMD(<code>Common Module Definition</code>)</h2><blockquote>\n<p><code>SeaJS</code>实现了<code>CMD</code>规范。</p>\n</blockquote>\n<hr>\n<h2 id=\"3、CommonJS-Modules\"><a href=\"#3、CommonJS-Modules\" class=\"headerlink\" title=\"3、CommonJS Modules\"></a>3、CommonJS Modules</h2><blockquote>\n<p><code>NodeJS</code>环境的模块加载实现了<code>CommonJS</code>规范。每个文件都是一个单独的模块，<br>有单独的作用域。模块之间通过global设置共享变量。<code>Browserify</code>可以让服务器代码跑在客户端。</p>\n</blockquote>\n<p>  特点：</p>\n<ul>\n<li>1、所有代码都运行在模块作用域，不会污染全局作用域。</li>\n<li>2、模块可以多次加载，但是只会在第一次加载时运行一次，<br>  然后运行结果就被缓存了，以后再加载，就直接读取缓存结果。要想让模块再次运行，必须清除缓存。</li>\n<li>3、模块加载的顺序，按照其在代码中出现的顺序。</li>\n</ul>\n<p>常见问题：</p>\n<ul>\n<li><p>清除缓存：<br>delete require.cache[require.resolve(‘./b.js’)]<br>模块按照绝对路径缓存，require.resolve返回模块的绝对路径。</p>\n</li>\n<li><p>解决互相依赖包含问题：<br>CommonJS的做法是，一旦出现某个模块被”循环加载”，就只输出已经执行的部分，还未执行的部分不会输出。</p>\n</li>\n</ul>\n<p>总结：</p>\n<blockquote>\n<p>AMD、CMD主要用在浏览器端异步加载、COMMONJS主要用在服务器端的同步加载。</p>\n</blockquote>\n"},{"title":"Mixed-Content-混合内容","date":"2019-01-28T13:07:43.000Z","_content":"\n### 项目背景\n\nLinking项目里存在一项设备视频回放功能，回放的视频文件格式为`m3u8`。`m3u8`是一种基于[HTTP Live Streaming](https://en.wikipedia.org/wiki/HTTP_Live_Streaming)协议的文件视频格式。对于该类型的视频文件解析步骤如下：\n\n![hls.jpg](/img/hls.jpg)\n\nHLS依赖浏览器提供的[Media Source Extensions API](https://developer.mozilla.org/zh-CN/docs/Web/API/Media_Source_Extensions_API)\n来完成组合，使之能够使用`<audio>`和`<video>`来进行播放。所以第一步需要`Browser API Check`。可以通过[caniuse](https://caniuse.com/#feat=mediasource)来查询API的支持情况。\n\n第二步加载视频文本文件`Load Mainfile`。文件内容大致如下：\n\n```shell\n#EXTM3U\n#EXT-X-VERSION:3\n#EXT-X-PLAYLIST-TYPE:VOD\n#EXT-X-TARGETDURATION:11\n#EXTINF:10.000,\nurl_462/193039199_mp4_h264_aac_hd_7.ts\n#EXTINF:10.000,\nurl_463/193039199_mp4_h264_aac_hd_7.ts\n#EXTINF:10.000,\nurl_464/193039199_mp4_h264_aac_hd_7.ts\n#EXTINF:10.000,\nurl_465/193039199_mp4_h264_aac_hd_7.ts\n#EXTINF:10.000,\nurl_466/193039199_mp4_h264_aac_hd_7.ts\n...\n```\n`ts`文件存放的是视频分片的二进制内容，通过浏览器的`XHR`加载`m3u8`和`ts`文件。\n\nLinking项目设备视频的`ts`文件存放在客户的存储空间`bucket`，而客户存储空间的外网域名往往不会绑定`https`证书。这个时候在播放视频的时候，浏览器会报出一个`Mix-Content`错误。\n\n---\n\n### 定义\nHTTPS网站中加载的HTTP资源被称之为Mixed Content。举个例子，如果你的网站地址是：`https://www.example.com`，该页面包含了一个图片资源：`<img src=\"http://external.com/resource.jpg\"/>`那么这个图片资源被称之为Mixed Content。\n\n---\n\n### 分类\nW3C标准组织按照混合内容被中间人篡改攻击时的损害程度分为两个类别：\n\n\n#### 被动内容(Passive content)\n\n指的是一些纯展示型的内容，这些内容往往不会修改网页的其他部分，危险比较小，即使被中间人攻击也无大碍，根据W3C的规定这类资源内容也被归类为`Optionally-Blockable`。主要包含以下几类：\n\n+ 通过`img`标签加载的图片或者CSS的`backgrounng-image`、`border-image`加载的图片\n+ 通过`video`、`source`标签加载的视频资源\n+ 通过`audio`、`source`标签加载的音频资源\n>目前由于改类型的资源使用过于广泛，浏览器默认允许加载该类型的资源。W3C希望尽可能缩小该类型资源的范围, 不过没有一个具体的`roadmap`。\n\n\n#### 活跃的内容(Active content)\n依据W3C的标准，任何不属于`Optionally-Blockable`的资源内容均归为此类型。这类资源也称之为`Blockable`。最典型的包含：脚本和CSS资源、通过`XHR`发送的数据请求等。\n\n---\n\n### 混合内容的`strict mode`\n现代浏览器默认允许加载`Optionally-Blockable`的内容，而阻止加载`Blockable`的内容。为了确保呈现给用户界面的安全性。网页开发者可以启用更加严格的策略来控制混合内容。\n\n#### 使用CSP开启严格模式\n>CSP全称：`Content-Security-Policy`。它是一个而外的安全层，用于检测并削弱特定类型的攻击，如XSS和数据注入等。\n\n使用CSP控制混合内容有两种形式：\n+ HTTP 响应头方式\n>Content-Security-Policy: block-all-mixed-content\n\n+ meta标签\n><meta http-equiv=\"Content-Security-Policy\" content=\"block-all-mixed-content\">\n\n---\n\n### 浏览器的行为\n>以下测试基于chrome 71, 不同的浏览器可能会有差异 :)\n\n#### 安全小锁\n如果站点所有的资源都是通过安全的`https`请求加载，那么在地址栏将会看到一个小锁：\n![mixed-content-http1.png](/img/http1.jpg)\n反之会看到小锁变成一个类似惊叹号的图标：\n![mixed-content-http2.png](/img/http2.jpg)\n\n浏览器地址栏的小锁就像是一个指示器, 告知用户当前网页是否存在安全风险。\n地址栏的指示器主要有三个状态：\n+ 安全--小锁\n>网页下所有资源都是通过https请求返回，即理想状态。\n+ 信息或不安全--惊叹号\n>网页下部分资源通过http请求返回，例如加载了某些`Optional-Blockable`的图片资源等。\n+ 不安全或危险--红色警告\n>主要因为chrome验证https网站提供的证书过期或者网站提供的证书不是由受信任组织发放等。\n\n##### 修正安全指示: `惊叹号`\n通过`upgrade-insecure-requests`这个 CSP 指令页面所有 HTTP 资源，会被替换为 HTTPS 地址再发起请求。这个时候可能会出现一些资源无法访问这个时候就需要通过一个支持https的域名做一次反向代理。\n\n##### 修正安全指示: `不安全或危险`\n对于证书出现过期，或者无法获取有效的https。可以考虑使用[letsencrypt](https://letsencrypt.org/)这个免费提供证书的服务。\n\n#### 加载`Optionally-Blockable`资源\n浏览器默认加载`Optionally-Blockable`的资源，但是会给出一些警告，例如把全站https的网页内的某个图片换成http请求：\n\n![mixed-content-http3](/img/http3.jpg)\n\n地址栏的小锁消失了。同时打开console，可以看到浏览器给出的一个警告：\n\n![mixed-content-http4](/img/http4.jpg)\n\n\n#### 加载`Blockable`资源\n把网页的一个css资源链接从`https`换成`http`:\n\n![mixed-content-http5](/img/http5.jpg)\n\n可以看到，浏览器默认禁止加载此类资源。\n\n#### 严格模式\n\n编辑网页，加入启用严格模式的`meta`标签：\n![mixed-content-http6](/img/http6.jpg)\n\n修改图片链接地址：\n\n![mixed-content-http7](/img/http7.jpg)\n\n查看浏览器终端：\n![mixed-content-http8](/img/http8.jpg)\n\n在启用严格模式情况下，全站资源都被当作`Blockable`类型处理，浏览器默认报错，不允许加载这些资源。\n\n---\n\n### MixedContent vs SameOriginPolicy\n\n`MixedContent`和`SameOriginPolicy`都是浏览器基于安全的设计, `MixedContent`可以被认为是更加严格的模式，限制的范围更广。`SameOriginPolicy`并没有阻止通过html的tag加载第三方资源。而`MixedContent`限制的更加严格。而对于`XHR`和`Fetch`发起的请求，`SameOriginPolicy`可以通过`CORS`来控制，`MixedContent`默认禁止，也没有相应的配置, `MixedContent`依托于浏览器自身的限制，而`SameOriginPolicy`浏览器需要依赖服务器的响应作出判定。\n","source":"_posts/mixed-content.md","raw":"---\ntitle: Mixed-Content-混合内容\ndate: 2019-01-28 21:07:43\ntags: http, mixed-content\ncategories: web\n---\n\n### 项目背景\n\nLinking项目里存在一项设备视频回放功能，回放的视频文件格式为`m3u8`。`m3u8`是一种基于[HTTP Live Streaming](https://en.wikipedia.org/wiki/HTTP_Live_Streaming)协议的文件视频格式。对于该类型的视频文件解析步骤如下：\n\n![hls.jpg](/img/hls.jpg)\n\nHLS依赖浏览器提供的[Media Source Extensions API](https://developer.mozilla.org/zh-CN/docs/Web/API/Media_Source_Extensions_API)\n来完成组合，使之能够使用`<audio>`和`<video>`来进行播放。所以第一步需要`Browser API Check`。可以通过[caniuse](https://caniuse.com/#feat=mediasource)来查询API的支持情况。\n\n第二步加载视频文本文件`Load Mainfile`。文件内容大致如下：\n\n```shell\n#EXTM3U\n#EXT-X-VERSION:3\n#EXT-X-PLAYLIST-TYPE:VOD\n#EXT-X-TARGETDURATION:11\n#EXTINF:10.000,\nurl_462/193039199_mp4_h264_aac_hd_7.ts\n#EXTINF:10.000,\nurl_463/193039199_mp4_h264_aac_hd_7.ts\n#EXTINF:10.000,\nurl_464/193039199_mp4_h264_aac_hd_7.ts\n#EXTINF:10.000,\nurl_465/193039199_mp4_h264_aac_hd_7.ts\n#EXTINF:10.000,\nurl_466/193039199_mp4_h264_aac_hd_7.ts\n...\n```\n`ts`文件存放的是视频分片的二进制内容，通过浏览器的`XHR`加载`m3u8`和`ts`文件。\n\nLinking项目设备视频的`ts`文件存放在客户的存储空间`bucket`，而客户存储空间的外网域名往往不会绑定`https`证书。这个时候在播放视频的时候，浏览器会报出一个`Mix-Content`错误。\n\n---\n\n### 定义\nHTTPS网站中加载的HTTP资源被称之为Mixed Content。举个例子，如果你的网站地址是：`https://www.example.com`，该页面包含了一个图片资源：`<img src=\"http://external.com/resource.jpg\"/>`那么这个图片资源被称之为Mixed Content。\n\n---\n\n### 分类\nW3C标准组织按照混合内容被中间人篡改攻击时的损害程度分为两个类别：\n\n\n#### 被动内容(Passive content)\n\n指的是一些纯展示型的内容，这些内容往往不会修改网页的其他部分，危险比较小，即使被中间人攻击也无大碍，根据W3C的规定这类资源内容也被归类为`Optionally-Blockable`。主要包含以下几类：\n\n+ 通过`img`标签加载的图片或者CSS的`backgrounng-image`、`border-image`加载的图片\n+ 通过`video`、`source`标签加载的视频资源\n+ 通过`audio`、`source`标签加载的音频资源\n>目前由于改类型的资源使用过于广泛，浏览器默认允许加载该类型的资源。W3C希望尽可能缩小该类型资源的范围, 不过没有一个具体的`roadmap`。\n\n\n#### 活跃的内容(Active content)\n依据W3C的标准，任何不属于`Optionally-Blockable`的资源内容均归为此类型。这类资源也称之为`Blockable`。最典型的包含：脚本和CSS资源、通过`XHR`发送的数据请求等。\n\n---\n\n### 混合内容的`strict mode`\n现代浏览器默认允许加载`Optionally-Blockable`的内容，而阻止加载`Blockable`的内容。为了确保呈现给用户界面的安全性。网页开发者可以启用更加严格的策略来控制混合内容。\n\n#### 使用CSP开启严格模式\n>CSP全称：`Content-Security-Policy`。它是一个而外的安全层，用于检测并削弱特定类型的攻击，如XSS和数据注入等。\n\n使用CSP控制混合内容有两种形式：\n+ HTTP 响应头方式\n>Content-Security-Policy: block-all-mixed-content\n\n+ meta标签\n><meta http-equiv=\"Content-Security-Policy\" content=\"block-all-mixed-content\">\n\n---\n\n### 浏览器的行为\n>以下测试基于chrome 71, 不同的浏览器可能会有差异 :)\n\n#### 安全小锁\n如果站点所有的资源都是通过安全的`https`请求加载，那么在地址栏将会看到一个小锁：\n![mixed-content-http1.png](/img/http1.jpg)\n反之会看到小锁变成一个类似惊叹号的图标：\n![mixed-content-http2.png](/img/http2.jpg)\n\n浏览器地址栏的小锁就像是一个指示器, 告知用户当前网页是否存在安全风险。\n地址栏的指示器主要有三个状态：\n+ 安全--小锁\n>网页下所有资源都是通过https请求返回，即理想状态。\n+ 信息或不安全--惊叹号\n>网页下部分资源通过http请求返回，例如加载了某些`Optional-Blockable`的图片资源等。\n+ 不安全或危险--红色警告\n>主要因为chrome验证https网站提供的证书过期或者网站提供的证书不是由受信任组织发放等。\n\n##### 修正安全指示: `惊叹号`\n通过`upgrade-insecure-requests`这个 CSP 指令页面所有 HTTP 资源，会被替换为 HTTPS 地址再发起请求。这个时候可能会出现一些资源无法访问这个时候就需要通过一个支持https的域名做一次反向代理。\n\n##### 修正安全指示: `不安全或危险`\n对于证书出现过期，或者无法获取有效的https。可以考虑使用[letsencrypt](https://letsencrypt.org/)这个免费提供证书的服务。\n\n#### 加载`Optionally-Blockable`资源\n浏览器默认加载`Optionally-Blockable`的资源，但是会给出一些警告，例如把全站https的网页内的某个图片换成http请求：\n\n![mixed-content-http3](/img/http3.jpg)\n\n地址栏的小锁消失了。同时打开console，可以看到浏览器给出的一个警告：\n\n![mixed-content-http4](/img/http4.jpg)\n\n\n#### 加载`Blockable`资源\n把网页的一个css资源链接从`https`换成`http`:\n\n![mixed-content-http5](/img/http5.jpg)\n\n可以看到，浏览器默认禁止加载此类资源。\n\n#### 严格模式\n\n编辑网页，加入启用严格模式的`meta`标签：\n![mixed-content-http6](/img/http6.jpg)\n\n修改图片链接地址：\n\n![mixed-content-http7](/img/http7.jpg)\n\n查看浏览器终端：\n![mixed-content-http8](/img/http8.jpg)\n\n在启用严格模式情况下，全站资源都被当作`Blockable`类型处理，浏览器默认报错，不允许加载这些资源。\n\n---\n\n### MixedContent vs SameOriginPolicy\n\n`MixedContent`和`SameOriginPolicy`都是浏览器基于安全的设计, `MixedContent`可以被认为是更加严格的模式，限制的范围更广。`SameOriginPolicy`并没有阻止通过html的tag加载第三方资源。而`MixedContent`限制的更加严格。而对于`XHR`和`Fetch`发起的请求，`SameOriginPolicy`可以通过`CORS`来控制，`MixedContent`默认禁止，也没有相应的配置, `MixedContent`依托于浏览器自身的限制，而`SameOriginPolicy`浏览器需要依赖服务器的响应作出判定。\n","slug":"mixed-content","published":1,"updated":"2019-02-17T13:39:40.162Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cdp002ny4zvduto8u9t","content":"<h3 id=\"项目背景\"><a href=\"#项目背景\" class=\"headerlink\" title=\"项目背景\"></a>项目背景</h3><p>Linking项目里存在一项设备视频回放功能，回放的视频文件格式为<code>m3u8</code>。<code>m3u8</code>是一种基于<a href=\"https://en.wikipedia.org/wiki/HTTP_Live_Streaming\" target=\"_blank\" rel=\"noopener\">HTTP Live Streaming</a>协议的文件视频格式。对于该类型的视频文件解析步骤如下：</p>\n<p><img src=\"/img/hls.jpg\" alt=\"hls.jpg\"></p>\n<p>HLS依赖浏览器提供的<a href=\"https://developer.mozilla.org/zh-CN/docs/Web/API/Media_Source_Extensions_API\" target=\"_blank\" rel=\"noopener\">Media Source Extensions API</a><br>来完成组合，使之能够使用<code>&lt;audio&gt;</code>和<code>&lt;video&gt;</code>来进行播放。所以第一步需要<code>Browser API Check</code>。可以通过<a href=\"https://caniuse.com/#feat=mediasource\" target=\"_blank\" rel=\"noopener\">caniuse</a>来查询API的支持情况。</p>\n<p>第二步加载视频文本文件<code>Load Mainfile</code>。文件内容大致如下：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span>EXTM3U</span><br><span class=\"line\"><span class=\"meta\">#</span>EXT-X-VERSION:3</span><br><span class=\"line\"><span class=\"meta\">#</span>EXT-X-PLAYLIST-TYPE:VOD</span><br><span class=\"line\"><span class=\"meta\">#</span>EXT-X-TARGETDURATION:11</span><br><span class=\"line\"><span class=\"meta\">#</span>EXTINF:10.000,</span><br><span class=\"line\">url_462/193039199_mp4_h264_aac_hd_7.ts</span><br><span class=\"line\"><span class=\"meta\">#</span>EXTINF:10.000,</span><br><span class=\"line\">url_463/193039199_mp4_h264_aac_hd_7.ts</span><br><span class=\"line\"><span class=\"meta\">#</span>EXTINF:10.000,</span><br><span class=\"line\">url_464/193039199_mp4_h264_aac_hd_7.ts</span><br><span class=\"line\"><span class=\"meta\">#</span>EXTINF:10.000,</span><br><span class=\"line\">url_465/193039199_mp4_h264_aac_hd_7.ts</span><br><span class=\"line\"><span class=\"meta\">#</span>EXTINF:10.000,</span><br><span class=\"line\">url_466/193039199_mp4_h264_aac_hd_7.ts</span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure>\n<p><code>ts</code>文件存放的是视频分片的二进制内容，通过浏览器的<code>XHR</code>加载<code>m3u8</code>和<code>ts</code>文件。</p>\n<p>Linking项目设备视频的<code>ts</code>文件存放在客户的存储空间<code>bucket</code>，而客户存储空间的外网域名往往不会绑定<code>https</code>证书。这个时候在播放视频的时候，浏览器会报出一个<code>Mix-Content</code>错误。</p>\n<hr>\n<h3 id=\"定义\"><a href=\"#定义\" class=\"headerlink\" title=\"定义\"></a>定义</h3><p>HTTPS网站中加载的HTTP资源被称之为Mixed Content。举个例子，如果你的网站地址是：<code>https://www.example.com</code>，该页面包含了一个图片资源：<code>&lt;img src=&quot;http://external.com/resource.jpg&quot;/&gt;</code>那么这个图片资源被称之为Mixed Content。</p>\n<hr>\n<h3 id=\"分类\"><a href=\"#分类\" class=\"headerlink\" title=\"分类\"></a>分类</h3><p>W3C标准组织按照混合内容被中间人篡改攻击时的损害程度分为两个类别：</p>\n<h4 id=\"被动内容-Passive-content\"><a href=\"#被动内容-Passive-content\" class=\"headerlink\" title=\"被动内容(Passive content)\"></a>被动内容(Passive content)</h4><p>指的是一些纯展示型的内容，这些内容往往不会修改网页的其他部分，危险比较小，即使被中间人攻击也无大碍，根据W3C的规定这类资源内容也被归类为<code>Optionally-Blockable</code>。主要包含以下几类：</p>\n<ul>\n<li>通过<code>img</code>标签加载的图片或者CSS的<code>backgrounng-image</code>、<code>border-image</code>加载的图片</li>\n<li>通过<code>video</code>、<code>source</code>标签加载的视频资源</li>\n<li>通过<code>audio</code>、<code>source</code>标签加载的音频资源<blockquote>\n<p>目前由于改类型的资源使用过于广泛，浏览器默认允许加载该类型的资源。W3C希望尽可能缩小该类型资源的范围, 不过没有一个具体的<code>roadmap</code>。</p>\n</blockquote>\n</li>\n</ul>\n<h4 id=\"活跃的内容-Active-content\"><a href=\"#活跃的内容-Active-content\" class=\"headerlink\" title=\"活跃的内容(Active content)\"></a>活跃的内容(Active content)</h4><p>依据W3C的标准，任何不属于<code>Optionally-Blockable</code>的资源内容均归为此类型。这类资源也称之为<code>Blockable</code>。最典型的包含：脚本和CSS资源、通过<code>XHR</code>发送的数据请求等。</p>\n<hr>\n<h3 id=\"混合内容的strict-mode\"><a href=\"#混合内容的strict-mode\" class=\"headerlink\" title=\"混合内容的strict mode\"></a>混合内容的<code>strict mode</code></h3><p>现代浏览器默认允许加载<code>Optionally-Blockable</code>的内容，而阻止加载<code>Blockable</code>的内容。为了确保呈现给用户界面的安全性。网页开发者可以启用更加严格的策略来控制混合内容。</p>\n<h4 id=\"使用CSP开启严格模式\"><a href=\"#使用CSP开启严格模式\" class=\"headerlink\" title=\"使用CSP开启严格模式\"></a>使用CSP开启严格模式</h4><blockquote>\n<p>CSP全称：<code>Content-Security-Policy</code>。它是一个而外的安全层，用于检测并削弱特定类型的攻击，如XSS和数据注入等。</p>\n</blockquote>\n<p>使用CSP控制混合内容有两种形式：</p>\n<ul>\n<li><p>HTTP 响应头方式</p>\n<blockquote>\n<p>Content-Security-Policy: block-all-mixed-content</p>\n</blockquote>\n</li>\n<li><p>meta标签</p>\n<blockquote>\n<meta http-equiv=\"Content-Security-Policy\" content=\"block-all-mixed-content\">\n</blockquote>\n</li>\n</ul>\n<hr>\n<h3 id=\"浏览器的行为\"><a href=\"#浏览器的行为\" class=\"headerlink\" title=\"浏览器的行为\"></a>浏览器的行为</h3><blockquote>\n<p>以下测试基于chrome 71, 不同的浏览器可能会有差异 :)</p>\n</blockquote>\n<h4 id=\"安全小锁\"><a href=\"#安全小锁\" class=\"headerlink\" title=\"安全小锁\"></a>安全小锁</h4><p>如果站点所有的资源都是通过安全的<code>https</code>请求加载，那么在地址栏将会看到一个小锁：<br><img src=\"/img/http1.jpg\" alt=\"mixed-content-http1.png\"><br>反之会看到小锁变成一个类似惊叹号的图标：<br><img src=\"/img/http2.jpg\" alt=\"mixed-content-http2.png\"></p>\n<p>浏览器地址栏的小锁就像是一个指示器, 告知用户当前网页是否存在安全风险。<br>地址栏的指示器主要有三个状态：</p>\n<ul>\n<li>安全–小锁<blockquote>\n<p>网页下所有资源都是通过https请求返回，即理想状态。</p>\n</blockquote>\n</li>\n<li>信息或不安全–惊叹号<blockquote>\n<p>网页下部分资源通过http请求返回，例如加载了某些<code>Optional-Blockable</code>的图片资源等。</p>\n</blockquote>\n</li>\n<li>不安全或危险–红色警告<blockquote>\n<p>主要因为chrome验证https网站提供的证书过期或者网站提供的证书不是由受信任组织发放等。</p>\n</blockquote>\n</li>\n</ul>\n<h5 id=\"修正安全指示-惊叹号\"><a href=\"#修正安全指示-惊叹号\" class=\"headerlink\" title=\"修正安全指示: 惊叹号\"></a>修正安全指示: <code>惊叹号</code></h5><p>通过<code>upgrade-insecure-requests</code>这个 CSP 指令页面所有 HTTP 资源，会被替换为 HTTPS 地址再发起请求。这个时候可能会出现一些资源无法访问这个时候就需要通过一个支持https的域名做一次反向代理。</p>\n<h5 id=\"修正安全指示-不安全或危险\"><a href=\"#修正安全指示-不安全或危险\" class=\"headerlink\" title=\"修正安全指示: 不安全或危险\"></a>修正安全指示: <code>不安全或危险</code></h5><p>对于证书出现过期，或者无法获取有效的https。可以考虑使用<a href=\"https://letsencrypt.org/\" target=\"_blank\" rel=\"noopener\">letsencrypt</a>这个免费提供证书的服务。</p>\n<h4 id=\"加载Optionally-Blockable资源\"><a href=\"#加载Optionally-Blockable资源\" class=\"headerlink\" title=\"加载Optionally-Blockable资源\"></a>加载<code>Optionally-Blockable</code>资源</h4><p>浏览器默认加载<code>Optionally-Blockable</code>的资源，但是会给出一些警告，例如把全站https的网页内的某个图片换成http请求：</p>\n<p><img src=\"/img/http3.jpg\" alt=\"mixed-content-http3\"></p>\n<p>地址栏的小锁消失了。同时打开console，可以看到浏览器给出的一个警告：</p>\n<p><img src=\"/img/http4.jpg\" alt=\"mixed-content-http4\"></p>\n<h4 id=\"加载Blockable资源\"><a href=\"#加载Blockable资源\" class=\"headerlink\" title=\"加载Blockable资源\"></a>加载<code>Blockable</code>资源</h4><p>把网页的一个css资源链接从<code>https</code>换成<code>http</code>:</p>\n<p><img src=\"/img/http5.jpg\" alt=\"mixed-content-http5\"></p>\n<p>可以看到，浏览器默认禁止加载此类资源。</p>\n<h4 id=\"严格模式\"><a href=\"#严格模式\" class=\"headerlink\" title=\"严格模式\"></a>严格模式</h4><p>编辑网页，加入启用严格模式的<code>meta</code>标签：<br><img src=\"/img/http6.jpg\" alt=\"mixed-content-http6\"></p>\n<p>修改图片链接地址：</p>\n<p><img src=\"/img/http7.jpg\" alt=\"mixed-content-http7\"></p>\n<p>查看浏览器终端：<br><img src=\"/img/http8.jpg\" alt=\"mixed-content-http8\"></p>\n<p>在启用严格模式情况下，全站资源都被当作<code>Blockable</code>类型处理，浏览器默认报错，不允许加载这些资源。</p>\n<hr>\n<h3 id=\"MixedContent-vs-SameOriginPolicy\"><a href=\"#MixedContent-vs-SameOriginPolicy\" class=\"headerlink\" title=\"MixedContent vs SameOriginPolicy\"></a>MixedContent vs SameOriginPolicy</h3><p><code>MixedContent</code>和<code>SameOriginPolicy</code>都是浏览器基于安全的设计, <code>MixedContent</code>可以被认为是更加严格的模式，限制的范围更广。<code>SameOriginPolicy</code>并没有阻止通过html的tag加载第三方资源。而<code>MixedContent</code>限制的更加严格。而对于<code>XHR</code>和<code>Fetch</code>发起的请求，<code>SameOriginPolicy</code>可以通过<code>CORS</code>来控制，<code>MixedContent</code>默认禁止，也没有相应的配置, <code>MixedContent</code>依托于浏览器自身的限制，而<code>SameOriginPolicy</code>浏览器需要依赖服务器的响应作出判定。</p>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"项目背景\"><a href=\"#项目背景\" class=\"headerlink\" title=\"项目背景\"></a>项目背景</h3><p>Linking项目里存在一项设备视频回放功能，回放的视频文件格式为<code>m3u8</code>。<code>m3u8</code>是一种基于<a href=\"https://en.wikipedia.org/wiki/HTTP_Live_Streaming\" target=\"_blank\" rel=\"noopener\">HTTP Live Streaming</a>协议的文件视频格式。对于该类型的视频文件解析步骤如下：</p>\n<p><img src=\"/img/hls.jpg\" alt=\"hls.jpg\"></p>\n<p>HLS依赖浏览器提供的<a href=\"https://developer.mozilla.org/zh-CN/docs/Web/API/Media_Source_Extensions_API\" target=\"_blank\" rel=\"noopener\">Media Source Extensions API</a><br>来完成组合，使之能够使用<code>&lt;audio&gt;</code>和<code>&lt;video&gt;</code>来进行播放。所以第一步需要<code>Browser API Check</code>。可以通过<a href=\"https://caniuse.com/#feat=mediasource\" target=\"_blank\" rel=\"noopener\">caniuse</a>来查询API的支持情况。</p>\n<p>第二步加载视频文本文件<code>Load Mainfile</code>。文件内容大致如下：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span>EXTM3U</span><br><span class=\"line\"><span class=\"meta\">#</span>EXT-X-VERSION:3</span><br><span class=\"line\"><span class=\"meta\">#</span>EXT-X-PLAYLIST-TYPE:VOD</span><br><span class=\"line\"><span class=\"meta\">#</span>EXT-X-TARGETDURATION:11</span><br><span class=\"line\"><span class=\"meta\">#</span>EXTINF:10.000,</span><br><span class=\"line\">url_462/193039199_mp4_h264_aac_hd_7.ts</span><br><span class=\"line\"><span class=\"meta\">#</span>EXTINF:10.000,</span><br><span class=\"line\">url_463/193039199_mp4_h264_aac_hd_7.ts</span><br><span class=\"line\"><span class=\"meta\">#</span>EXTINF:10.000,</span><br><span class=\"line\">url_464/193039199_mp4_h264_aac_hd_7.ts</span><br><span class=\"line\"><span class=\"meta\">#</span>EXTINF:10.000,</span><br><span class=\"line\">url_465/193039199_mp4_h264_aac_hd_7.ts</span><br><span class=\"line\"><span class=\"meta\">#</span>EXTINF:10.000,</span><br><span class=\"line\">url_466/193039199_mp4_h264_aac_hd_7.ts</span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure>\n<p><code>ts</code>文件存放的是视频分片的二进制内容，通过浏览器的<code>XHR</code>加载<code>m3u8</code>和<code>ts</code>文件。</p>\n<p>Linking项目设备视频的<code>ts</code>文件存放在客户的存储空间<code>bucket</code>，而客户存储空间的外网域名往往不会绑定<code>https</code>证书。这个时候在播放视频的时候，浏览器会报出一个<code>Mix-Content</code>错误。</p>\n<hr>\n<h3 id=\"定义\"><a href=\"#定义\" class=\"headerlink\" title=\"定义\"></a>定义</h3><p>HTTPS网站中加载的HTTP资源被称之为Mixed Content。举个例子，如果你的网站地址是：<code>https://www.example.com</code>，该页面包含了一个图片资源：<code>&lt;img src=&quot;http://external.com/resource.jpg&quot;/&gt;</code>那么这个图片资源被称之为Mixed Content。</p>\n<hr>\n<h3 id=\"分类\"><a href=\"#分类\" class=\"headerlink\" title=\"分类\"></a>分类</h3><p>W3C标准组织按照混合内容被中间人篡改攻击时的损害程度分为两个类别：</p>\n<h4 id=\"被动内容-Passive-content\"><a href=\"#被动内容-Passive-content\" class=\"headerlink\" title=\"被动内容(Passive content)\"></a>被动内容(Passive content)</h4><p>指的是一些纯展示型的内容，这些内容往往不会修改网页的其他部分，危险比较小，即使被中间人攻击也无大碍，根据W3C的规定这类资源内容也被归类为<code>Optionally-Blockable</code>。主要包含以下几类：</p>\n<ul>\n<li>通过<code>img</code>标签加载的图片或者CSS的<code>backgrounng-image</code>、<code>border-image</code>加载的图片</li>\n<li>通过<code>video</code>、<code>source</code>标签加载的视频资源</li>\n<li>通过<code>audio</code>、<code>source</code>标签加载的音频资源<blockquote>\n<p>目前由于改类型的资源使用过于广泛，浏览器默认允许加载该类型的资源。W3C希望尽可能缩小该类型资源的范围, 不过没有一个具体的<code>roadmap</code>。</p>\n</blockquote>\n</li>\n</ul>\n<h4 id=\"活跃的内容-Active-content\"><a href=\"#活跃的内容-Active-content\" class=\"headerlink\" title=\"活跃的内容(Active content)\"></a>活跃的内容(Active content)</h4><p>依据W3C的标准，任何不属于<code>Optionally-Blockable</code>的资源内容均归为此类型。这类资源也称之为<code>Blockable</code>。最典型的包含：脚本和CSS资源、通过<code>XHR</code>发送的数据请求等。</p>\n<hr>\n<h3 id=\"混合内容的strict-mode\"><a href=\"#混合内容的strict-mode\" class=\"headerlink\" title=\"混合内容的strict mode\"></a>混合内容的<code>strict mode</code></h3><p>现代浏览器默认允许加载<code>Optionally-Blockable</code>的内容，而阻止加载<code>Blockable</code>的内容。为了确保呈现给用户界面的安全性。网页开发者可以启用更加严格的策略来控制混合内容。</p>\n<h4 id=\"使用CSP开启严格模式\"><a href=\"#使用CSP开启严格模式\" class=\"headerlink\" title=\"使用CSP开启严格模式\"></a>使用CSP开启严格模式</h4><blockquote>\n<p>CSP全称：<code>Content-Security-Policy</code>。它是一个而外的安全层，用于检测并削弱特定类型的攻击，如XSS和数据注入等。</p>\n</blockquote>\n<p>使用CSP控制混合内容有两种形式：</p>\n<ul>\n<li><p>HTTP 响应头方式</p>\n<blockquote>\n<p>Content-Security-Policy: block-all-mixed-content</p>\n</blockquote>\n</li>\n<li><p>meta标签</p>\n<blockquote>\n<meta http-equiv=\"Content-Security-Policy\" content=\"block-all-mixed-content\">\n</blockquote>\n</li>\n</ul>\n<hr>\n<h3 id=\"浏览器的行为\"><a href=\"#浏览器的行为\" class=\"headerlink\" title=\"浏览器的行为\"></a>浏览器的行为</h3><blockquote>\n<p>以下测试基于chrome 71, 不同的浏览器可能会有差异 :)</p>\n</blockquote>\n<h4 id=\"安全小锁\"><a href=\"#安全小锁\" class=\"headerlink\" title=\"安全小锁\"></a>安全小锁</h4><p>如果站点所有的资源都是通过安全的<code>https</code>请求加载，那么在地址栏将会看到一个小锁：<br><img src=\"/img/http1.jpg\" alt=\"mixed-content-http1.png\"><br>反之会看到小锁变成一个类似惊叹号的图标：<br><img src=\"/img/http2.jpg\" alt=\"mixed-content-http2.png\"></p>\n<p>浏览器地址栏的小锁就像是一个指示器, 告知用户当前网页是否存在安全风险。<br>地址栏的指示器主要有三个状态：</p>\n<ul>\n<li>安全–小锁<blockquote>\n<p>网页下所有资源都是通过https请求返回，即理想状态。</p>\n</blockquote>\n</li>\n<li>信息或不安全–惊叹号<blockquote>\n<p>网页下部分资源通过http请求返回，例如加载了某些<code>Optional-Blockable</code>的图片资源等。</p>\n</blockquote>\n</li>\n<li>不安全或危险–红色警告<blockquote>\n<p>主要因为chrome验证https网站提供的证书过期或者网站提供的证书不是由受信任组织发放等。</p>\n</blockquote>\n</li>\n</ul>\n<h5 id=\"修正安全指示-惊叹号\"><a href=\"#修正安全指示-惊叹号\" class=\"headerlink\" title=\"修正安全指示: 惊叹号\"></a>修正安全指示: <code>惊叹号</code></h5><p>通过<code>upgrade-insecure-requests</code>这个 CSP 指令页面所有 HTTP 资源，会被替换为 HTTPS 地址再发起请求。这个时候可能会出现一些资源无法访问这个时候就需要通过一个支持https的域名做一次反向代理。</p>\n<h5 id=\"修正安全指示-不安全或危险\"><a href=\"#修正安全指示-不安全或危险\" class=\"headerlink\" title=\"修正安全指示: 不安全或危险\"></a>修正安全指示: <code>不安全或危险</code></h5><p>对于证书出现过期，或者无法获取有效的https。可以考虑使用<a href=\"https://letsencrypt.org/\" target=\"_blank\" rel=\"noopener\">letsencrypt</a>这个免费提供证书的服务。</p>\n<h4 id=\"加载Optionally-Blockable资源\"><a href=\"#加载Optionally-Blockable资源\" class=\"headerlink\" title=\"加载Optionally-Blockable资源\"></a>加载<code>Optionally-Blockable</code>资源</h4><p>浏览器默认加载<code>Optionally-Blockable</code>的资源，但是会给出一些警告，例如把全站https的网页内的某个图片换成http请求：</p>\n<p><img src=\"/img/http3.jpg\" alt=\"mixed-content-http3\"></p>\n<p>地址栏的小锁消失了。同时打开console，可以看到浏览器给出的一个警告：</p>\n<p><img src=\"/img/http4.jpg\" alt=\"mixed-content-http4\"></p>\n<h4 id=\"加载Blockable资源\"><a href=\"#加载Blockable资源\" class=\"headerlink\" title=\"加载Blockable资源\"></a>加载<code>Blockable</code>资源</h4><p>把网页的一个css资源链接从<code>https</code>换成<code>http</code>:</p>\n<p><img src=\"/img/http5.jpg\" alt=\"mixed-content-http5\"></p>\n<p>可以看到，浏览器默认禁止加载此类资源。</p>\n<h4 id=\"严格模式\"><a href=\"#严格模式\" class=\"headerlink\" title=\"严格模式\"></a>严格模式</h4><p>编辑网页，加入启用严格模式的<code>meta</code>标签：<br><img src=\"/img/http6.jpg\" alt=\"mixed-content-http6\"></p>\n<p>修改图片链接地址：</p>\n<p><img src=\"/img/http7.jpg\" alt=\"mixed-content-http7\"></p>\n<p>查看浏览器终端：<br><img src=\"/img/http8.jpg\" alt=\"mixed-content-http8\"></p>\n<p>在启用严格模式情况下，全站资源都被当作<code>Blockable</code>类型处理，浏览器默认报错，不允许加载这些资源。</p>\n<hr>\n<h3 id=\"MixedContent-vs-SameOriginPolicy\"><a href=\"#MixedContent-vs-SameOriginPolicy\" class=\"headerlink\" title=\"MixedContent vs SameOriginPolicy\"></a>MixedContent vs SameOriginPolicy</h3><p><code>MixedContent</code>和<code>SameOriginPolicy</code>都是浏览器基于安全的设计, <code>MixedContent</code>可以被认为是更加严格的模式，限制的范围更广。<code>SameOriginPolicy</code>并没有阻止通过html的tag加载第三方资源。而<code>MixedContent</code>限制的更加严格。而对于<code>XHR</code>和<code>Fetch</code>发起的请求，<code>SameOriginPolicy</code>可以通过<code>CORS</code>来控制，<code>MixedContent</code>默认禁止，也没有相应的配置, <code>MixedContent</code>依托于浏览器自身的限制，而<code>SameOriginPolicy</code>浏览器需要依赖服务器的响应作出判定。</p>\n"},{"title":"iptables配置","date":"2015-10-07T02:37:03.000Z","_content":"### 1、Iptables介绍\n\nCentos系统内建了一个强大的防火墙，通常又被称为`iptables`。准确的说应该叫iptables/netfilter。iptables工作于用户层，用户通过命令行给防火墙预定规则表。netfilter是一个内核模块，完成实际的过滤工作。有许多GUI软件方便用户来设置防火墙规则，但都缺乏一定的灵活性，并且限制用户了解其中真正发生了什么。\n\n在开始配置Iptables之前，我们需要知道知道一些它是如何工作的。Iptables利用到了 IP 地址、协议(tcp,udp,icmp)和端口。我们不需要成为这方面的专家，但多少知道一些有助于理解iptables是如何工作的。\n\nIptables给预定义的链路(INPUT、OUTPUT、FORWARD)设置规则。链路校验IP包并根据定义的规则对其做相应的处理，如：接受、丢弃等。对包的处理又被称为：`targets`。两个通常用到的`target`一个是`DROP`用于丢弃一个包、一个是`ACCEPT`用于接受一个包。\n\n#### 链路  \n有三个预定义的链路定义在`filter`表内，我们可以给它添加规则来处理通过链路的IP包。三个链路分别是：  \n- INPUT -所有发往本机的数据包\n- OUTPUT -所有从本机输出的数据包  \n- FORWARD -所有的即不是发往本机也不是从本机发出的数据包，但是需要通过本机的数据包。通常用在本机当作一个路由器的情况下。\n\n所有的规则最终被添加到链路的一张表内。一个数据包在链路的规则表内轮流被校验，从顶部开始，一旦匹配到规则，规则定义的行为被执行，例如接受(ACCEPT)、丢弃(DROP)数据包。一旦数据包被处理、后续的规则将不会被执行。如果一个数据包没有匹配到任何一条规则，那么链路的默认行为会被使用，这被称为链路的默认策略。通常有两种默认的链路配置策略：  \n\n+ 1、 设置默认策略丢弃所有的数据包、添加规则指定我们需要允许的IP地址或者指定端口的服务，如FTP、web服务器、Samba文件服务等。  \n+ 2、 设置默认策略接受所有的数据包、添加规则指定我们需要拒绝的IP地址或者指定端口等。\n\n### 2、起步\n\n确认iptables已经安装：  \n```\n[luncher@localhost ide-server]$ rpm -qa iptables\niptables-1.4.21-13.fc21.x86_64\n[luncher@localhost ide-server]$\n```\n\n查看当前配置信息：  \n```\n[luncher@localhost ide-server]$ sudo iptables -L\n[sudo] password for luncher: \nChain INPUT (policy DROP)\ntarget     prot opt source               destination         \nACCEPT     all  --  anywhere             anywhere            \nACCEPT     all  --  anywhere             anywhere             state RELATED,ESTABLISHED\nACCEPT     tcp  --  anywhere             anywhere             tcp dpt:ssh\n\n```\n\n我们可以看到ssh服务默认被centos服务允许了。\n\niptables 还有一些基本的命令如：start/restart/off/on等，和其他系统服务器基本类似。\n\n\n### 3、写一个简单的规则设置\n\n一组简单的配置规则：  \n```  \n# iptables -P INPUT ACCEPT\n# iptables -F\n# iptables -A INPUT -i lo -j ACCEPT\n# iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT\n# iptables -A INPUT -p tcp --dport 22 -j ACCEPT\n# iptables -P INPUT DROP\n# iptables -P FORWARD DROP\n# iptables -P OUTPUT ACCEPT\n# iptables -L -v\n```\n\n看看最终的结果：\n```\n[luncher@localhost ide-server]$ sudo iptables -L -v\nChain INPUT (policy DROP 0 packets, 0 bytes)\n pkts bytes target     prot opt in     out     source               destination         \n   34  6368 ACCEPT     all  --  any    any     anywhere             anywhere             state RELATED,ESTABLISHED\n    0     0 ACCEPT     tcp  --  any    any     anywhere             anywhere             tcp dpt:ssh\n\n```\n\n下面来详细解释一下以上八个命令的具体作用：  \n+ 1、 iptables -P INPUT ACCEPT  \n如果我们远程登录到服务器修改配置，那么我们必须临时给INPUT设置默认的策略ACCEPT，否则一旦我们把规则表清空，我们将无法登录服务器。  \n\n+ 2、 iptables -F  \n用户清空`filter`表当前的配置规则。以便添加新规则。  \n\n+ 3、iptables -A INPUT -i lo -j ACCEPT  \n给INPUT链的末尾添加规则，当数据包进入本地网络使用的接口为`localhost`时，那么跳转(-j)到行为接受(ACCEPT)。多数软件都回和本地主机(localhost)适配器通信，所以必须开启该通道。  \n\n+ 4、iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT  \n接下来我们要保障已经建立的链路通信，这里我们使用`state`判断数据包的状态，辨别这是一个新的链接、还是一个已经建立的链接。允许接受已经建立链接的数据包。\n\n+ 5、iptables -A INPUT -p tcp --dport 22 -j ACCEPT  \n`SSH`链接基于22端口，我们必须开启ssh服务。`--dport`选项基于tcp包的目的端口来匹配包，`--sport`类似。  \n\n+ 6、iptables -P INPUT DROP  \n为`INPUT`链设置默认的行为(`target`)。`-P`用于指定链路(`--policy`)。  \n\n+ 7、iptables -P FORWARD DROP  \n为`FORWARD`链设置默认行为(`target`)。  \n\n+ 8、iptables -P OUTPUT ACCEPT  \n最后，我们设置`OUTPUT`允许默认输出，表明我们信任我们的用户。  \n\n+ 9、iptables -L -v  \n列出当前的配置规则  \n\n\n### 4、接口  \n\n在上面例子，我们可以给以指定网络接口的数据包设置规则，例如：\n\n```\niptables -A INPUT -i lo -j ACCEPT  \n```  \n\n常用的网口还有:`eth0`、`eth1`等等。  \n\n\n### 5、IP地址\n\n有时候对整个网口做限制还是不够精确，我们需要更加细致的规则来达到我们说要的效果。例如，添加一个可信的IP地址：\n```\niptables -A INPUT -s 192.168.0.51 -j ACCEPT  \n```  \n有时候一个IP还是不够用，我们需要对一个地址范围的IP定制规则：\n```\niptables -A INPUT -s 192.168.0.0/51 -j ACCEPT \n```  \n为了防止`IP`地址伪造，我们也可以根据`mac`地址来过滤：  \n```\niptables -A INPUT -s 192.168.0.51 -m mac --mac-source 0a:d0:62:de -j ACCEPT\n```  \n\n### 6、端口和协议\n\n上面我们看到了一些基于IP地址的过滤规则配置，接下来我们来学习根据协议以及端口号来设置过滤规则。在我们开始之前，必须知道一些特定服务的协议以及端口号，例如：bittorrent 服务，使用的是`tcp`协议，端口号默认`6881`：  \n```\niptables -A INPUT -p tcp --dport 6881 -j ACCEPT\n```  \n如果我们要对一系列连续的端口做相同的操作可以这样：  \n```\niptables -A INPUT -p tcp --dport 6881:6991 -j ACCEPT  \n```  \n注意：在限制端口之前必须指定协议类型，常用的有：tcp、udp、icmp。  \n\n### 7、总结  \n来看一个生产机器上的防火墙配置：\n\n```\n*filter\n:INPUT ACCEPT [0:0]\n:FORWARD ACCEPT [0:0]\n:OUTPUT ACCEPT [0:0]\n-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT\n-A INPUT -p icmp -j ACCEPT\n-A INPUT -i lo -j ACCEPT\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 22 -j ACCEPT\n-A INPUT -m state --state NEW -s 117.135.137.133 -m tcp -p tcp --dport 10050 -j ACCEPT\n-A INPUT -p tcp -m state --state NEW -m tcp --dport 10240 -j ACCEPT\n-A INPUT -p tcp -m state --state NEW -m tcp --dport 80 -j ACCEPT\n-A INPUT -j REJECT --reject-with icmp-host-prohibited\n-A INPUT -p tcp -m tcp --dport 80 -j ACCEPT\n-A FORWARD -j REJECT --reject-with icmp-host-prohibited\n-A OUTPUT -p tcp -m tcp --sport 10240 -j ACCEPT\nCOMMIT\n\n```  \n解释几个选项  \n- 1、*filter表示当前的表名为`filter`，一般不可以修改  \n- 2、:INPUT ACCEPT [0:0]表示链的详细说明，`:<chain-name> <chain-policy> [<packet-counter>:<byte-counter>]`。 \n- 3、COMMIT：每个表的描述都以`COMMIT`关键字结束  \n- 4、--reject-with icmp-host-prohibited：设置REJECT(target)的返回信息，也就是给发送者返回拒绝信息。可以参看常用的`icmp`类型。\n\n---  \n*到这里，我们学习了`iptables`的基础配置。相信经过不断的刻意练习，iptables配置一定烂熟于心。*\n\n\n\n\n\n","source":"_posts/iptables配置.md","raw":"---\ntitle: iptables配置\ncategories: server\ndate: 2015-10-07 10:37:03\n\n---\n### 1、Iptables介绍\n\nCentos系统内建了一个强大的防火墙，通常又被称为`iptables`。准确的说应该叫iptables/netfilter。iptables工作于用户层，用户通过命令行给防火墙预定规则表。netfilter是一个内核模块，完成实际的过滤工作。有许多GUI软件方便用户来设置防火墙规则，但都缺乏一定的灵活性，并且限制用户了解其中真正发生了什么。\n\n在开始配置Iptables之前，我们需要知道知道一些它是如何工作的。Iptables利用到了 IP 地址、协议(tcp,udp,icmp)和端口。我们不需要成为这方面的专家，但多少知道一些有助于理解iptables是如何工作的。\n\nIptables给预定义的链路(INPUT、OUTPUT、FORWARD)设置规则。链路校验IP包并根据定义的规则对其做相应的处理，如：接受、丢弃等。对包的处理又被称为：`targets`。两个通常用到的`target`一个是`DROP`用于丢弃一个包、一个是`ACCEPT`用于接受一个包。\n\n#### 链路  \n有三个预定义的链路定义在`filter`表内，我们可以给它添加规则来处理通过链路的IP包。三个链路分别是：  \n- INPUT -所有发往本机的数据包\n- OUTPUT -所有从本机输出的数据包  \n- FORWARD -所有的即不是发往本机也不是从本机发出的数据包，但是需要通过本机的数据包。通常用在本机当作一个路由器的情况下。\n\n所有的规则最终被添加到链路的一张表内。一个数据包在链路的规则表内轮流被校验，从顶部开始，一旦匹配到规则，规则定义的行为被执行，例如接受(ACCEPT)、丢弃(DROP)数据包。一旦数据包被处理、后续的规则将不会被执行。如果一个数据包没有匹配到任何一条规则，那么链路的默认行为会被使用，这被称为链路的默认策略。通常有两种默认的链路配置策略：  \n\n+ 1、 设置默认策略丢弃所有的数据包、添加规则指定我们需要允许的IP地址或者指定端口的服务，如FTP、web服务器、Samba文件服务等。  \n+ 2、 设置默认策略接受所有的数据包、添加规则指定我们需要拒绝的IP地址或者指定端口等。\n\n### 2、起步\n\n确认iptables已经安装：  \n```\n[luncher@localhost ide-server]$ rpm -qa iptables\niptables-1.4.21-13.fc21.x86_64\n[luncher@localhost ide-server]$\n```\n\n查看当前配置信息：  \n```\n[luncher@localhost ide-server]$ sudo iptables -L\n[sudo] password for luncher: \nChain INPUT (policy DROP)\ntarget     prot opt source               destination         \nACCEPT     all  --  anywhere             anywhere            \nACCEPT     all  --  anywhere             anywhere             state RELATED,ESTABLISHED\nACCEPT     tcp  --  anywhere             anywhere             tcp dpt:ssh\n\n```\n\n我们可以看到ssh服务默认被centos服务允许了。\n\niptables 还有一些基本的命令如：start/restart/off/on等，和其他系统服务器基本类似。\n\n\n### 3、写一个简单的规则设置\n\n一组简单的配置规则：  \n```  \n# iptables -P INPUT ACCEPT\n# iptables -F\n# iptables -A INPUT -i lo -j ACCEPT\n# iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT\n# iptables -A INPUT -p tcp --dport 22 -j ACCEPT\n# iptables -P INPUT DROP\n# iptables -P FORWARD DROP\n# iptables -P OUTPUT ACCEPT\n# iptables -L -v\n```\n\n看看最终的结果：\n```\n[luncher@localhost ide-server]$ sudo iptables -L -v\nChain INPUT (policy DROP 0 packets, 0 bytes)\n pkts bytes target     prot opt in     out     source               destination         \n   34  6368 ACCEPT     all  --  any    any     anywhere             anywhere             state RELATED,ESTABLISHED\n    0     0 ACCEPT     tcp  --  any    any     anywhere             anywhere             tcp dpt:ssh\n\n```\n\n下面来详细解释一下以上八个命令的具体作用：  \n+ 1、 iptables -P INPUT ACCEPT  \n如果我们远程登录到服务器修改配置，那么我们必须临时给INPUT设置默认的策略ACCEPT，否则一旦我们把规则表清空，我们将无法登录服务器。  \n\n+ 2、 iptables -F  \n用户清空`filter`表当前的配置规则。以便添加新规则。  \n\n+ 3、iptables -A INPUT -i lo -j ACCEPT  \n给INPUT链的末尾添加规则，当数据包进入本地网络使用的接口为`localhost`时，那么跳转(-j)到行为接受(ACCEPT)。多数软件都回和本地主机(localhost)适配器通信，所以必须开启该通道。  \n\n+ 4、iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT  \n接下来我们要保障已经建立的链路通信，这里我们使用`state`判断数据包的状态，辨别这是一个新的链接、还是一个已经建立的链接。允许接受已经建立链接的数据包。\n\n+ 5、iptables -A INPUT -p tcp --dport 22 -j ACCEPT  \n`SSH`链接基于22端口，我们必须开启ssh服务。`--dport`选项基于tcp包的目的端口来匹配包，`--sport`类似。  \n\n+ 6、iptables -P INPUT DROP  \n为`INPUT`链设置默认的行为(`target`)。`-P`用于指定链路(`--policy`)。  \n\n+ 7、iptables -P FORWARD DROP  \n为`FORWARD`链设置默认行为(`target`)。  \n\n+ 8、iptables -P OUTPUT ACCEPT  \n最后，我们设置`OUTPUT`允许默认输出，表明我们信任我们的用户。  \n\n+ 9、iptables -L -v  \n列出当前的配置规则  \n\n\n### 4、接口  \n\n在上面例子，我们可以给以指定网络接口的数据包设置规则，例如：\n\n```\niptables -A INPUT -i lo -j ACCEPT  \n```  \n\n常用的网口还有:`eth0`、`eth1`等等。  \n\n\n### 5、IP地址\n\n有时候对整个网口做限制还是不够精确，我们需要更加细致的规则来达到我们说要的效果。例如，添加一个可信的IP地址：\n```\niptables -A INPUT -s 192.168.0.51 -j ACCEPT  \n```  \n有时候一个IP还是不够用，我们需要对一个地址范围的IP定制规则：\n```\niptables -A INPUT -s 192.168.0.0/51 -j ACCEPT \n```  \n为了防止`IP`地址伪造，我们也可以根据`mac`地址来过滤：  \n```\niptables -A INPUT -s 192.168.0.51 -m mac --mac-source 0a:d0:62:de -j ACCEPT\n```  \n\n### 6、端口和协议\n\n上面我们看到了一些基于IP地址的过滤规则配置，接下来我们来学习根据协议以及端口号来设置过滤规则。在我们开始之前，必须知道一些特定服务的协议以及端口号，例如：bittorrent 服务，使用的是`tcp`协议，端口号默认`6881`：  \n```\niptables -A INPUT -p tcp --dport 6881 -j ACCEPT\n```  \n如果我们要对一系列连续的端口做相同的操作可以这样：  \n```\niptables -A INPUT -p tcp --dport 6881:6991 -j ACCEPT  \n```  \n注意：在限制端口之前必须指定协议类型，常用的有：tcp、udp、icmp。  \n\n### 7、总结  \n来看一个生产机器上的防火墙配置：\n\n```\n*filter\n:INPUT ACCEPT [0:0]\n:FORWARD ACCEPT [0:0]\n:OUTPUT ACCEPT [0:0]\n-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT\n-A INPUT -p icmp -j ACCEPT\n-A INPUT -i lo -j ACCEPT\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 22 -j ACCEPT\n-A INPUT -m state --state NEW -s 117.135.137.133 -m tcp -p tcp --dport 10050 -j ACCEPT\n-A INPUT -p tcp -m state --state NEW -m tcp --dport 10240 -j ACCEPT\n-A INPUT -p tcp -m state --state NEW -m tcp --dport 80 -j ACCEPT\n-A INPUT -j REJECT --reject-with icmp-host-prohibited\n-A INPUT -p tcp -m tcp --dport 80 -j ACCEPT\n-A FORWARD -j REJECT --reject-with icmp-host-prohibited\n-A OUTPUT -p tcp -m tcp --sport 10240 -j ACCEPT\nCOMMIT\n\n```  \n解释几个选项  \n- 1、*filter表示当前的表名为`filter`，一般不可以修改  \n- 2、:INPUT ACCEPT [0:0]表示链的详细说明，`:<chain-name> <chain-policy> [<packet-counter>:<byte-counter>]`。 \n- 3、COMMIT：每个表的描述都以`COMMIT`关键字结束  \n- 4、--reject-with icmp-host-prohibited：设置REJECT(target)的返回信息，也就是给发送者返回拒绝信息。可以参看常用的`icmp`类型。\n\n---  \n*到这里，我们学习了`iptables`的基础配置。相信经过不断的刻意练习，iptables配置一定烂熟于心。*\n\n\n\n\n\n","slug":"iptables配置","published":1,"updated":"2018-07-01T10:30:46.495Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cdq002qy4zvby3dypec","content":"<h3 id=\"1、Iptables介绍\"><a href=\"#1、Iptables介绍\" class=\"headerlink\" title=\"1、Iptables介绍\"></a>1、Iptables介绍</h3><p>Centos系统内建了一个强大的防火墙，通常又被称为<code>iptables</code>。准确的说应该叫iptables/netfilter。iptables工作于用户层，用户通过命令行给防火墙预定规则表。netfilter是一个内核模块，完成实际的过滤工作。有许多GUI软件方便用户来设置防火墙规则，但都缺乏一定的灵活性，并且限制用户了解其中真正发生了什么。</p>\n<p>在开始配置Iptables之前，我们需要知道知道一些它是如何工作的。Iptables利用到了 IP 地址、协议(tcp,udp,icmp)和端口。我们不需要成为这方面的专家，但多少知道一些有助于理解iptables是如何工作的。</p>\n<p>Iptables给预定义的链路(INPUT、OUTPUT、FORWARD)设置规则。链路校验IP包并根据定义的规则对其做相应的处理，如：接受、丢弃等。对包的处理又被称为：<code>targets</code>。两个通常用到的<code>target</code>一个是<code>DROP</code>用于丢弃一个包、一个是<code>ACCEPT</code>用于接受一个包。</p>\n<h4 id=\"链路\"><a href=\"#链路\" class=\"headerlink\" title=\"链路\"></a>链路</h4><p>有三个预定义的链路定义在<code>filter</code>表内，我们可以给它添加规则来处理通过链路的IP包。三个链路分别是：  </p>\n<ul>\n<li>INPUT -所有发往本机的数据包</li>\n<li>OUTPUT -所有从本机输出的数据包  </li>\n<li>FORWARD -所有的即不是发往本机也不是从本机发出的数据包，但是需要通过本机的数据包。通常用在本机当作一个路由器的情况下。</li>\n</ul>\n<p>所有的规则最终被添加到链路的一张表内。一个数据包在链路的规则表内轮流被校验，从顶部开始，一旦匹配到规则，规则定义的行为被执行，例如接受(ACCEPT)、丢弃(DROP)数据包。一旦数据包被处理、后续的规则将不会被执行。如果一个数据包没有匹配到任何一条规则，那么链路的默认行为会被使用，这被称为链路的默认策略。通常有两种默认的链路配置策略：  </p>\n<ul>\n<li>1、 设置默认策略丢弃所有的数据包、添加规则指定我们需要允许的IP地址或者指定端口的服务，如FTP、web服务器、Samba文件服务等。  </li>\n<li>2、 设置默认策略接受所有的数据包、添加规则指定我们需要拒绝的IP地址或者指定端口等。</li>\n</ul>\n<h3 id=\"2、起步\"><a href=\"#2、起步\" class=\"headerlink\" title=\"2、起步\"></a>2、起步</h3><p>确认iptables已经安装：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[luncher@localhost ide-server]$ rpm -qa iptables</span><br><span class=\"line\">iptables-1.4.21-13.fc21.x86_64</span><br><span class=\"line\">[luncher@localhost ide-server]$</span><br></pre></td></tr></table></figure></p>\n<p>查看当前配置信息：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[luncher@localhost ide-server]$ sudo iptables -L</span><br><span class=\"line\">[sudo] password for luncher: </span><br><span class=\"line\">Chain INPUT (policy DROP)</span><br><span class=\"line\">target     prot opt source               destination         </span><br><span class=\"line\">ACCEPT     all  --  anywhere             anywhere            </span><br><span class=\"line\">ACCEPT     all  --  anywhere             anywhere             state RELATED,ESTABLISHED</span><br><span class=\"line\">ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:ssh</span><br></pre></td></tr></table></figure></p>\n<p>我们可以看到ssh服务默认被centos服务允许了。</p>\n<p>iptables 还有一些基本的命令如：start/restart/off/on等，和其他系统服务器基本类似。</p>\n<h3 id=\"3、写一个简单的规则设置\"><a href=\"#3、写一个简单的规则设置\" class=\"headerlink\" title=\"3、写一个简单的规则设置\"></a>3、写一个简单的规则设置</h3><p>一组简单的配置规则：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># iptables -P INPUT ACCEPT</span><br><span class=\"line\"># iptables -F</span><br><span class=\"line\"># iptables -A INPUT -i lo -j ACCEPT</span><br><span class=\"line\"># iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class=\"line\"># iptables -A INPUT -p tcp --dport 22 -j ACCEPT</span><br><span class=\"line\"># iptables -P INPUT DROP</span><br><span class=\"line\"># iptables -P FORWARD DROP</span><br><span class=\"line\"># iptables -P OUTPUT ACCEPT</span><br><span class=\"line\"># iptables -L -v</span><br></pre></td></tr></table></figure></p>\n<p>看看最终的结果：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[luncher@localhost ide-server]$ sudo iptables -L -v</span><br><span class=\"line\">Chain INPUT (policy DROP 0 packets, 0 bytes)</span><br><span class=\"line\"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\">   34  6368 ACCEPT     all  --  any    any     anywhere             anywhere             state RELATED,ESTABLISHED</span><br><span class=\"line\">    0     0 ACCEPT     tcp  --  any    any     anywhere             anywhere             tcp dpt:ssh</span><br></pre></td></tr></table></figure></p>\n<p>下面来详细解释一下以上八个命令的具体作用：  </p>\n<ul>\n<li><p>1、 iptables -P INPUT ACCEPT<br>如果我们远程登录到服务器修改配置，那么我们必须临时给INPUT设置默认的策略ACCEPT，否则一旦我们把规则表清空，我们将无法登录服务器。  </p>\n</li>\n<li><p>2、 iptables -F<br>用户清空<code>filter</code>表当前的配置规则。以便添加新规则。  </p>\n</li>\n<li><p>3、iptables -A INPUT -i lo -j ACCEPT<br>给INPUT链的末尾添加规则，当数据包进入本地网络使用的接口为<code>localhost</code>时，那么跳转(-j)到行为接受(ACCEPT)。多数软件都回和本地主机(localhost)适配器通信，所以必须开启该通道。  </p>\n</li>\n<li><p>4、iptables -A INPUT -m state –state ESTABLISHED,RELATED -j ACCEPT<br>接下来我们要保障已经建立的链路通信，这里我们使用<code>state</code>判断数据包的状态，辨别这是一个新的链接、还是一个已经建立的链接。允许接受已经建立链接的数据包。</p>\n</li>\n<li><p>5、iptables -A INPUT -p tcp –dport 22 -j ACCEPT<br><code>SSH</code>链接基于22端口，我们必须开启ssh服务。<code>--dport</code>选项基于tcp包的目的端口来匹配包，<code>--sport</code>类似。  </p>\n</li>\n<li><p>6、iptables -P INPUT DROP<br>为<code>INPUT</code>链设置默认的行为(<code>target</code>)。<code>-P</code>用于指定链路(<code>--policy</code>)。  </p>\n</li>\n<li><p>7、iptables -P FORWARD DROP<br>为<code>FORWARD</code>链设置默认行为(<code>target</code>)。  </p>\n</li>\n<li><p>8、iptables -P OUTPUT ACCEPT<br>最后，我们设置<code>OUTPUT</code>允许默认输出，表明我们信任我们的用户。  </p>\n</li>\n<li><p>9、iptables -L -v<br>列出当前的配置规则  </p>\n</li>\n</ul>\n<h3 id=\"4、接口\"><a href=\"#4、接口\" class=\"headerlink\" title=\"4、接口\"></a>4、接口</h3><p>在上面例子，我们可以给以指定网络接口的数据包设置规则，例如：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">iptables -A INPUT -i lo -j ACCEPT  </span><br><span class=\"line\">```  </span><br><span class=\"line\"></span><br><span class=\"line\">常用的网口还有:`eth0`、`eth1`等等。  </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">### 5、IP地址</span><br><span class=\"line\"></span><br><span class=\"line\">有时候对整个网口做限制还是不够精确，我们需要更加细致的规则来达到我们说要的效果。例如，添加一个可信的IP地址：</span><br></pre></td></tr></table></figure>\n<p>iptables -A INPUT -s 192.168.0.51 -j ACCEPT<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">有时候一个IP还是不够用，我们需要对一个地址范围的IP定制规则：</span><br></pre></td></tr></table></figure></p>\n<p>iptables -A INPUT -s 192.168.0.0/51 -j ACCEPT<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">为了防止`IP`地址伪造，我们也可以根据`mac`地址来过滤：</span><br></pre></td></tr></table></figure></p>\n<p>iptables -A INPUT -s 192.168.0.51 -m mac –mac-source 0a:d0:62:de -j ACCEPT<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">### 6、端口和协议</span><br><span class=\"line\"></span><br><span class=\"line\">上面我们看到了一些基于IP地址的过滤规则配置，接下来我们来学习根据协议以及端口号来设置过滤规则。在我们开始之前，必须知道一些特定服务的协议以及端口号，例如：bittorrent 服务，使用的是`tcp`协议，端口号默认`6881`：</span><br></pre></td></tr></table></figure></p>\n<p>iptables -A INPUT -p tcp –dport 6881 -j ACCEPT<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">如果我们要对一系列连续的端口做相同的操作可以这样：</span><br></pre></td></tr></table></figure></p>\n<p>iptables -A INPUT -p tcp –dport 6881:6991 -j ACCEPT<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">注意：在限制端口之前必须指定协议类型，常用的有：tcp、udp、icmp。  </span><br><span class=\"line\"></span><br><span class=\"line\">### 7、总结  </span><br><span class=\"line\">来看一个生产机器上的防火墙配置：</span><br></pre></td></tr></table></figure></p>\n<p>*filter<br>:INPUT ACCEPT [0:0]<br>:FORWARD ACCEPT [0:0]<br>:OUTPUT ACCEPT [0:0]<br>-A INPUT -m state –state ESTABLISHED,RELATED -j ACCEPT<br>-A INPUT -p icmp -j ACCEPT<br>-A INPUT -i lo -j ACCEPT<br>-A INPUT -m state –state NEW -m tcp -p tcp –dport 22 -j ACCEPT<br>-A INPUT -m state –state NEW -s 117.135.137.133 -m tcp -p tcp –dport 10050 -j ACCEPT<br>-A INPUT -p tcp -m state –state NEW -m tcp –dport 10240 -j ACCEPT<br>-A INPUT -p tcp -m state –state NEW -m tcp –dport 80 -j ACCEPT<br>-A INPUT -j REJECT –reject-with icmp-host-prohibited<br>-A INPUT -p tcp -m tcp –dport 80 -j ACCEPT<br>-A FORWARD -j REJECT –reject-with icmp-host-prohibited<br>-A OUTPUT -p tcp -m tcp –sport 10240 -j ACCEPT<br>COMMIT</p>\n<p><code>`</code><br>解释几个选项  </p>\n<ul>\n<li>1、*filter表示当前的表名为<code>filter</code>，一般不可以修改  </li>\n<li>2、:INPUT ACCEPT [0:0]表示链的详细说明，<code>:&lt;chain-name&gt; &lt;chain-policy&gt; [&lt;packet-counter&gt;:&lt;byte-counter&gt;]</code>。 </li>\n<li>3、COMMIT：每个表的描述都以<code>COMMIT</code>关键字结束  </li>\n<li>4、–reject-with icmp-host-prohibited：设置REJECT(target)的返回信息，也就是给发送者返回拒绝信息。可以参看常用的<code>icmp</code>类型。</li>\n</ul>\n<hr>\n<p><em>到这里，我们学习了<code>iptables</code>的基础配置。相信经过不断的刻意练习，iptables配置一定烂熟于心。</em></p>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"1、Iptables介绍\"><a href=\"#1、Iptables介绍\" class=\"headerlink\" title=\"1、Iptables介绍\"></a>1、Iptables介绍</h3><p>Centos系统内建了一个强大的防火墙，通常又被称为<code>iptables</code>。准确的说应该叫iptables/netfilter。iptables工作于用户层，用户通过命令行给防火墙预定规则表。netfilter是一个内核模块，完成实际的过滤工作。有许多GUI软件方便用户来设置防火墙规则，但都缺乏一定的灵活性，并且限制用户了解其中真正发生了什么。</p>\n<p>在开始配置Iptables之前，我们需要知道知道一些它是如何工作的。Iptables利用到了 IP 地址、协议(tcp,udp,icmp)和端口。我们不需要成为这方面的专家，但多少知道一些有助于理解iptables是如何工作的。</p>\n<p>Iptables给预定义的链路(INPUT、OUTPUT、FORWARD)设置规则。链路校验IP包并根据定义的规则对其做相应的处理，如：接受、丢弃等。对包的处理又被称为：<code>targets</code>。两个通常用到的<code>target</code>一个是<code>DROP</code>用于丢弃一个包、一个是<code>ACCEPT</code>用于接受一个包。</p>\n<h4 id=\"链路\"><a href=\"#链路\" class=\"headerlink\" title=\"链路\"></a>链路</h4><p>有三个预定义的链路定义在<code>filter</code>表内，我们可以给它添加规则来处理通过链路的IP包。三个链路分别是：  </p>\n<ul>\n<li>INPUT -所有发往本机的数据包</li>\n<li>OUTPUT -所有从本机输出的数据包  </li>\n<li>FORWARD -所有的即不是发往本机也不是从本机发出的数据包，但是需要通过本机的数据包。通常用在本机当作一个路由器的情况下。</li>\n</ul>\n<p>所有的规则最终被添加到链路的一张表内。一个数据包在链路的规则表内轮流被校验，从顶部开始，一旦匹配到规则，规则定义的行为被执行，例如接受(ACCEPT)、丢弃(DROP)数据包。一旦数据包被处理、后续的规则将不会被执行。如果一个数据包没有匹配到任何一条规则，那么链路的默认行为会被使用，这被称为链路的默认策略。通常有两种默认的链路配置策略：  </p>\n<ul>\n<li>1、 设置默认策略丢弃所有的数据包、添加规则指定我们需要允许的IP地址或者指定端口的服务，如FTP、web服务器、Samba文件服务等。  </li>\n<li>2、 设置默认策略接受所有的数据包、添加规则指定我们需要拒绝的IP地址或者指定端口等。</li>\n</ul>\n<h3 id=\"2、起步\"><a href=\"#2、起步\" class=\"headerlink\" title=\"2、起步\"></a>2、起步</h3><p>确认iptables已经安装：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[luncher@localhost ide-server]$ rpm -qa iptables</span><br><span class=\"line\">iptables-1.4.21-13.fc21.x86_64</span><br><span class=\"line\">[luncher@localhost ide-server]$</span><br></pre></td></tr></table></figure></p>\n<p>查看当前配置信息：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[luncher@localhost ide-server]$ sudo iptables -L</span><br><span class=\"line\">[sudo] password for luncher: </span><br><span class=\"line\">Chain INPUT (policy DROP)</span><br><span class=\"line\">target     prot opt source               destination         </span><br><span class=\"line\">ACCEPT     all  --  anywhere             anywhere            </span><br><span class=\"line\">ACCEPT     all  --  anywhere             anywhere             state RELATED,ESTABLISHED</span><br><span class=\"line\">ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:ssh</span><br></pre></td></tr></table></figure></p>\n<p>我们可以看到ssh服务默认被centos服务允许了。</p>\n<p>iptables 还有一些基本的命令如：start/restart/off/on等，和其他系统服务器基本类似。</p>\n<h3 id=\"3、写一个简单的规则设置\"><a href=\"#3、写一个简单的规则设置\" class=\"headerlink\" title=\"3、写一个简单的规则设置\"></a>3、写一个简单的规则设置</h3><p>一组简单的配置规则：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># iptables -P INPUT ACCEPT</span><br><span class=\"line\"># iptables -F</span><br><span class=\"line\"># iptables -A INPUT -i lo -j ACCEPT</span><br><span class=\"line\"># iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class=\"line\"># iptables -A INPUT -p tcp --dport 22 -j ACCEPT</span><br><span class=\"line\"># iptables -P INPUT DROP</span><br><span class=\"line\"># iptables -P FORWARD DROP</span><br><span class=\"line\"># iptables -P OUTPUT ACCEPT</span><br><span class=\"line\"># iptables -L -v</span><br></pre></td></tr></table></figure></p>\n<p>看看最终的结果：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[luncher@localhost ide-server]$ sudo iptables -L -v</span><br><span class=\"line\">Chain INPUT (policy DROP 0 packets, 0 bytes)</span><br><span class=\"line\"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\">   34  6368 ACCEPT     all  --  any    any     anywhere             anywhere             state RELATED,ESTABLISHED</span><br><span class=\"line\">    0     0 ACCEPT     tcp  --  any    any     anywhere             anywhere             tcp dpt:ssh</span><br></pre></td></tr></table></figure></p>\n<p>下面来详细解释一下以上八个命令的具体作用：  </p>\n<ul>\n<li><p>1、 iptables -P INPUT ACCEPT<br>如果我们远程登录到服务器修改配置，那么我们必须临时给INPUT设置默认的策略ACCEPT，否则一旦我们把规则表清空，我们将无法登录服务器。  </p>\n</li>\n<li><p>2、 iptables -F<br>用户清空<code>filter</code>表当前的配置规则。以便添加新规则。  </p>\n</li>\n<li><p>3、iptables -A INPUT -i lo -j ACCEPT<br>给INPUT链的末尾添加规则，当数据包进入本地网络使用的接口为<code>localhost</code>时，那么跳转(-j)到行为接受(ACCEPT)。多数软件都回和本地主机(localhost)适配器通信，所以必须开启该通道。  </p>\n</li>\n<li><p>4、iptables -A INPUT -m state –state ESTABLISHED,RELATED -j ACCEPT<br>接下来我们要保障已经建立的链路通信，这里我们使用<code>state</code>判断数据包的状态，辨别这是一个新的链接、还是一个已经建立的链接。允许接受已经建立链接的数据包。</p>\n</li>\n<li><p>5、iptables -A INPUT -p tcp –dport 22 -j ACCEPT<br><code>SSH</code>链接基于22端口，我们必须开启ssh服务。<code>--dport</code>选项基于tcp包的目的端口来匹配包，<code>--sport</code>类似。  </p>\n</li>\n<li><p>6、iptables -P INPUT DROP<br>为<code>INPUT</code>链设置默认的行为(<code>target</code>)。<code>-P</code>用于指定链路(<code>--policy</code>)。  </p>\n</li>\n<li><p>7、iptables -P FORWARD DROP<br>为<code>FORWARD</code>链设置默认行为(<code>target</code>)。  </p>\n</li>\n<li><p>8、iptables -P OUTPUT ACCEPT<br>最后，我们设置<code>OUTPUT</code>允许默认输出，表明我们信任我们的用户。  </p>\n</li>\n<li><p>9、iptables -L -v<br>列出当前的配置规则  </p>\n</li>\n</ul>\n<h3 id=\"4、接口\"><a href=\"#4、接口\" class=\"headerlink\" title=\"4、接口\"></a>4、接口</h3><p>在上面例子，我们可以给以指定网络接口的数据包设置规则，例如：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">iptables -A INPUT -i lo -j ACCEPT  </span><br><span class=\"line\">```  </span><br><span class=\"line\"></span><br><span class=\"line\">常用的网口还有:`eth0`、`eth1`等等。  </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">### 5、IP地址</span><br><span class=\"line\"></span><br><span class=\"line\">有时候对整个网口做限制还是不够精确，我们需要更加细致的规则来达到我们说要的效果。例如，添加一个可信的IP地址：</span><br></pre></td></tr></table></figure>\n<p>iptables -A INPUT -s 192.168.0.51 -j ACCEPT<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">有时候一个IP还是不够用，我们需要对一个地址范围的IP定制规则：</span><br></pre></td></tr></table></figure></p>\n<p>iptables -A INPUT -s 192.168.0.0/51 -j ACCEPT<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">为了防止`IP`地址伪造，我们也可以根据`mac`地址来过滤：</span><br></pre></td></tr></table></figure></p>\n<p>iptables -A INPUT -s 192.168.0.51 -m mac –mac-source 0a:d0:62:de -j ACCEPT<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">### 6、端口和协议</span><br><span class=\"line\"></span><br><span class=\"line\">上面我们看到了一些基于IP地址的过滤规则配置，接下来我们来学习根据协议以及端口号来设置过滤规则。在我们开始之前，必须知道一些特定服务的协议以及端口号，例如：bittorrent 服务，使用的是`tcp`协议，端口号默认`6881`：</span><br></pre></td></tr></table></figure></p>\n<p>iptables -A INPUT -p tcp –dport 6881 -j ACCEPT<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">如果我们要对一系列连续的端口做相同的操作可以这样：</span><br></pre></td></tr></table></figure></p>\n<p>iptables -A INPUT -p tcp –dport 6881:6991 -j ACCEPT<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">注意：在限制端口之前必须指定协议类型，常用的有：tcp、udp、icmp。  </span><br><span class=\"line\"></span><br><span class=\"line\">### 7、总结  </span><br><span class=\"line\">来看一个生产机器上的防火墙配置：</span><br></pre></td></tr></table></figure></p>\n<p>*filter<br>:INPUT ACCEPT [0:0]<br>:FORWARD ACCEPT [0:0]<br>:OUTPUT ACCEPT [0:0]<br>-A INPUT -m state –state ESTABLISHED,RELATED -j ACCEPT<br>-A INPUT -p icmp -j ACCEPT<br>-A INPUT -i lo -j ACCEPT<br>-A INPUT -m state –state NEW -m tcp -p tcp –dport 22 -j ACCEPT<br>-A INPUT -m state –state NEW -s 117.135.137.133 -m tcp -p tcp –dport 10050 -j ACCEPT<br>-A INPUT -p tcp -m state –state NEW -m tcp –dport 10240 -j ACCEPT<br>-A INPUT -p tcp -m state –state NEW -m tcp –dport 80 -j ACCEPT<br>-A INPUT -j REJECT –reject-with icmp-host-prohibited<br>-A INPUT -p tcp -m tcp –dport 80 -j ACCEPT<br>-A FORWARD -j REJECT –reject-with icmp-host-prohibited<br>-A OUTPUT -p tcp -m tcp –sport 10240 -j ACCEPT<br>COMMIT</p>\n<p><code>`</code><br>解释几个选项  </p>\n<ul>\n<li>1、*filter表示当前的表名为<code>filter</code>，一般不可以修改  </li>\n<li>2、:INPUT ACCEPT [0:0]表示链的详细说明，<code>:&lt;chain-name&gt; &lt;chain-policy&gt; [&lt;packet-counter&gt;:&lt;byte-counter&gt;]</code>。 </li>\n<li>3、COMMIT：每个表的描述都以<code>COMMIT</code>关键字结束  </li>\n<li>4、–reject-with icmp-host-prohibited：设置REJECT(target)的返回信息，也就是给发送者返回拒绝信息。可以参看常用的<code>icmp</code>类型。</li>\n</ul>\n<hr>\n<p><em>到这里，我们学习了<code>iptables</code>的基础配置。相信经过不断的刻意练习，iptables配置一定烂熟于心。</em></p>\n"},{"title":"nginx反向代理基本配置","date":"2018-05-20T02:08:42.000Z","keywords":["nginx","cache","proxy"],"_content":"\n## nginx 基本配置\n\n为了让`nginx`能正常运行，必须设置它的一些基本配置，`nginx`基本配置主要包含了\b`nginx`正常运行的配置，包括了日志，以及对master/worker进程的控制、\b`nginx`服务监听分发等。\n\n```nginx\nuser nobody; #worker进程启动用户\n\nworker_processes 1; #worker进程数量\n\nerror_log logs/error.log debug; #设置nginx错误日志输出路径以及日志等级\n\npid logs/nginx.pid;#设置保存master进程ID的文件路径\n\nevents {\n  worker_connections 1024;#设置每个worker进程最大连接数量为1024\n}\n\nhttp {\n  # 定义MIME type 到文件拓展\b名的映射\n  include       mime.types;\n\n  #默认的MIME type\n  default_type  application/octet-stream;\n\n  # 新增日志格式，格式名称为main\n  log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                    '$status $body_bytes_sent \"$http_referer\" '\n                    '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n  # 设置http请求访问日志写入的路径，以及解析请求日志的格式\n  access_log   logs/access.log  main;\n\n  #设置上游服务器地址\n  upstream backend {\n    server 127.0.0.1:3000;\n    server 127.0.0.1:3001;\n  }\n\n  server {\n    listen 80;# 设置nginx服务监听80端口\n    server_name localhost; # 该server只处理请求的Host等于`localhost`的请求\n  }\n}\n\n```\n\n## nginx 反向代理配置\n\b`nginx`包含了一系列的http请求相关的配置，包含如：`ngx_http_core_module`、`ngx_http_proxy_module`等。参考链接: [Modules reference](http://nginx.org/en/docs/)。这里只配置一些能够用得上的选项：\n\n\n### 定义缓存路径\n\n```nginx\n\nhttp {\n  # 设置缓存路径、设置一个两层结构的目录、设置缓存键和元数据的共享内存区名称为：mycache, 大小：10m\n  # 设置项目不被访问情况下再内存中保持60分钟、缓存的上限为1g、关闭缓存临时文件，避免不必要的文件拷贝\n  proxy_cache_path  /data/nginx/cache levels=1:2 keys_zone=my_cache:10m inactive=60m  max_size=1g use_temp_path=off;\n}\n\n```\n\n### 反向代理缓存基本配置\n\n```nginx\n\nserver {\n  # 定义共享内存区域名称\n  proxy_cache   my_cache;\n\n  # 定义nginx连接到代理服务器的超时时间\n  proxy_connect_timeout 1s;\n\n  #如果当前正在更新缓存或者当前没有代理服务器来处理请求，则使用老的缓存\n  proxy_cache_use_stale timeout updating;\n\n  #同一时间只允许一个请求修改缓存\n  #锁定时间：1秒\n  proxy_cache_lock on;\n  proxy_cache_lock_timeout 1s;\n\n  #关闭代理服务器的重定向请求\n  proxy_redirect off;\n\n  #根据客户端请求的uri生成缓存键(对uri做md5操作)\n  proxy_cache_key \"$request_uri\"\n\n  #设置200状态码的返回数据的缓存时间为1秒钟\n  #定义的其实是一个绝对过期时间即：(第一次缓存的时间+配置的缓存时间)\n  proxy_cache_valid   200   1s;\n\n  #nginx反向代理的时候，一些http头部请求字段不会传递给代理服务器，这个时候需要我们手动指定\n  proxy_set_header Host $host;\n  proxy_set_header X-Real-IP $remote_addr;\n  proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;\n\n  #设置代理服务器集群\n  location / {\n    proxy_pass http://backend;\n  }\n}\n\n```\n\n### 利用`ngx_http_headers_module`和`ngx_http_upstream_module`设置响应头信息\n\n```nginx\n\nlocation / {\n  # 设置响应头部信息，判断请求是否被缓存\n  add_header  X-Cache   '$upstream_cache_status';\n}\n\n```\n\n## nginx gzip模块配置\n\n```nginx\n\nserver {\n  #开启gzip压缩功能\n  gzip on;\n\n  #设置启用gzip的http版本信息\n  gzip_http_version   1.0;\n\n  #设置gzip压缩等级\n  gzip_comp_level   5;\n\n  #设置当Content-Length大于256的时候启用gzip配置\n  gzip_min_length   256;\n\n  #对所有的代理请求都启用gzip\n  gzip_proxied  any;\n\n  #添加“Vary: Accept-Encoding”到请求头部告知代理服务器是否支持gzip压缩\n  gzip_vary   on;\n\n  #设置需要压缩的MIME types\n  gzip_types\n    application/atom+xml\n    application/javascript\n    application/json\n    application/rss+xml\n    application/vnd.ms-fontobject\n    application/x-font-ttf\n    application/x-web-app-manifest+json\n    application/xhtml+xml\n    application/xml\n    font/opentype\n    image/svg+xml\n    image/x-icon\n    text/css\n    text/plain\n    text/x-component;\n}\n\n```\n\n--EOF--","source":"_posts/nginx反向代理配置.md","raw":"---\ntitle: nginx反向代理基本配置\ndate: 2018-05-20 10:08:42\ntags: \n  - nginx\n  - proxy\n  - cache\nkeywords: \n  - nginx\n  - cache\n  - proxy\ncategories: server\n---\n\n## nginx 基本配置\n\n为了让`nginx`能正常运行，必须设置它的一些基本配置，`nginx`基本配置主要包含了\b`nginx`正常运行的配置，包括了日志，以及对master/worker进程的控制、\b`nginx`服务监听分发等。\n\n```nginx\nuser nobody; #worker进程启动用户\n\nworker_processes 1; #worker进程数量\n\nerror_log logs/error.log debug; #设置nginx错误日志输出路径以及日志等级\n\npid logs/nginx.pid;#设置保存master进程ID的文件路径\n\nevents {\n  worker_connections 1024;#设置每个worker进程最大连接数量为1024\n}\n\nhttp {\n  # 定义MIME type 到文件拓展\b名的映射\n  include       mime.types;\n\n  #默认的MIME type\n  default_type  application/octet-stream;\n\n  # 新增日志格式，格式名称为main\n  log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                    '$status $body_bytes_sent \"$http_referer\" '\n                    '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n  # 设置http请求访问日志写入的路径，以及解析请求日志的格式\n  access_log   logs/access.log  main;\n\n  #设置上游服务器地址\n  upstream backend {\n    server 127.0.0.1:3000;\n    server 127.0.0.1:3001;\n  }\n\n  server {\n    listen 80;# 设置nginx服务监听80端口\n    server_name localhost; # 该server只处理请求的Host等于`localhost`的请求\n  }\n}\n\n```\n\n## nginx 反向代理配置\n\b`nginx`包含了一系列的http请求相关的配置，包含如：`ngx_http_core_module`、`ngx_http_proxy_module`等。参考链接: [Modules reference](http://nginx.org/en/docs/)。这里只配置一些能够用得上的选项：\n\n\n### 定义缓存路径\n\n```nginx\n\nhttp {\n  # 设置缓存路径、设置一个两层结构的目录、设置缓存键和元数据的共享内存区名称为：mycache, 大小：10m\n  # 设置项目不被访问情况下再内存中保持60分钟、缓存的上限为1g、关闭缓存临时文件，避免不必要的文件拷贝\n  proxy_cache_path  /data/nginx/cache levels=1:2 keys_zone=my_cache:10m inactive=60m  max_size=1g use_temp_path=off;\n}\n\n```\n\n### 反向代理缓存基本配置\n\n```nginx\n\nserver {\n  # 定义共享内存区域名称\n  proxy_cache   my_cache;\n\n  # 定义nginx连接到代理服务器的超时时间\n  proxy_connect_timeout 1s;\n\n  #如果当前正在更新缓存或者当前没有代理服务器来处理请求，则使用老的缓存\n  proxy_cache_use_stale timeout updating;\n\n  #同一时间只允许一个请求修改缓存\n  #锁定时间：1秒\n  proxy_cache_lock on;\n  proxy_cache_lock_timeout 1s;\n\n  #关闭代理服务器的重定向请求\n  proxy_redirect off;\n\n  #根据客户端请求的uri生成缓存键(对uri做md5操作)\n  proxy_cache_key \"$request_uri\"\n\n  #设置200状态码的返回数据的缓存时间为1秒钟\n  #定义的其实是一个绝对过期时间即：(第一次缓存的时间+配置的缓存时间)\n  proxy_cache_valid   200   1s;\n\n  #nginx反向代理的时候，一些http头部请求字段不会传递给代理服务器，这个时候需要我们手动指定\n  proxy_set_header Host $host;\n  proxy_set_header X-Real-IP $remote_addr;\n  proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;\n\n  #设置代理服务器集群\n  location / {\n    proxy_pass http://backend;\n  }\n}\n\n```\n\n### 利用`ngx_http_headers_module`和`ngx_http_upstream_module`设置响应头信息\n\n```nginx\n\nlocation / {\n  # 设置响应头部信息，判断请求是否被缓存\n  add_header  X-Cache   '$upstream_cache_status';\n}\n\n```\n\n## nginx gzip模块配置\n\n```nginx\n\nserver {\n  #开启gzip压缩功能\n  gzip on;\n\n  #设置启用gzip的http版本信息\n  gzip_http_version   1.0;\n\n  #设置gzip压缩等级\n  gzip_comp_level   5;\n\n  #设置当Content-Length大于256的时候启用gzip配置\n  gzip_min_length   256;\n\n  #对所有的代理请求都启用gzip\n  gzip_proxied  any;\n\n  #添加“Vary: Accept-Encoding”到请求头部告知代理服务器是否支持gzip压缩\n  gzip_vary   on;\n\n  #设置需要压缩的MIME types\n  gzip_types\n    application/atom+xml\n    application/javascript\n    application/json\n    application/rss+xml\n    application/vnd.ms-fontobject\n    application/x-font-ttf\n    application/x-web-app-manifest+json\n    application/xhtml+xml\n    application/xml\n    font/opentype\n    image/svg+xml\n    image/x-icon\n    text/css\n    text/plain\n    text/x-component;\n}\n\n```\n\n--EOF--","slug":"nginx反向代理配置","published":1,"updated":"2018-11-11T16:17:49.604Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cdr002ty4zvtgevonne","content":"<h2 id=\"nginx-基本配置\"><a href=\"#nginx-基本配置\" class=\"headerlink\" title=\"nginx 基本配置\"></a>nginx 基本配置</h2><p>为了让<code>nginx</code>能正常运行，必须设置它的一些基本配置，<code>nginx</code>基本配置主要包含了\b<code>nginx</code>正常运行的配置，包括了日志，以及对master/worker进程的控制、\b<code>nginx</code>服务监听分发等。</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">user</span> nobody; <span class=\"comment\">#worker进程启动用户</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attribute\">worker_processes</span> <span class=\"number\">1</span>; <span class=\"comment\">#worker进程数量</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attribute\">error_log</span> logs/error.log <span class=\"literal\">debug</span>; <span class=\"comment\">#设置nginx错误日志输出路径以及日志等级</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attribute\">pid</span> logs/nginx.pid;<span class=\"comment\">#设置保存master进程ID的文件路径</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">events</span> &#123;</span><br><span class=\"line\">  <span class=\"attribute\">worker_connections</span> <span class=\"number\">1024</span>;<span class=\"comment\">#设置每个worker进程最大连接数量为1024</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">http</span> &#123;</span><br><span class=\"line\">  <span class=\"comment\"># 定义MIME type 到文件拓展\b名的映射</span></span><br><span class=\"line\">  <span class=\"attribute\">include</span>       mime.types;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#默认的MIME type</span></span><br><span class=\"line\">  <span class=\"attribute\">default_type</span>  application/octet-stream;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># 新增日志格式，格式名称为main</span></span><br><span class=\"line\">  <span class=\"attribute\">log_format</span>  main  <span class=\"string\">'<span class=\"variable\">$remote_addr</span> - <span class=\"variable\">$remote_user</span> [<span class=\"variable\">$time_local</span>] \"<span class=\"variable\">$request</span>\" '</span></span><br><span class=\"line\">                    <span class=\"string\">'<span class=\"variable\">$status</span> <span class=\"variable\">$body_bytes_sent</span> \"<span class=\"variable\">$http_referer</span>\" '</span></span><br><span class=\"line\">                    <span class=\"string\">'\"<span class=\"variable\">$http_user_agent</span>\" \"<span class=\"variable\">$http_x_forwarded_for</span>\"'</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># 设置http请求访问日志写入的路径，以及解析请求日志的格式</span></span><br><span class=\"line\">  <span class=\"attribute\">access_log</span>   logs/access.log  main;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#设置上游服务器地址</span></span><br><span class=\"line\">  <span class=\"attribute\">upstream</span> backend &#123;</span><br><span class=\"line\">    <span class=\"attribute\">server</span> <span class=\"number\">127.0.0.1:3000</span>;</span><br><span class=\"line\">    <span class=\"attribute\">server</span> <span class=\"number\">127.0.0.1:3001</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">80</span>;<span class=\"comment\"># 设置nginx服务监听80端口</span></span><br><span class=\"line\">    <span class=\"attribute\">server_name</span> localhost; <span class=\"comment\"># 该server只处理请求的Host等于`localhost`的请求</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"nginx-反向代理配置\"><a href=\"#nginx-反向代理配置\" class=\"headerlink\" title=\"nginx 反向代理配置\"></a>nginx 反向代理配置</h2><p>\b<code>nginx</code>包含了一系列的http请求相关的配置，包含如：<code>ngx_http_core_module</code>、<code>ngx_http_proxy_module</code>等。参考链接: <a href=\"http://nginx.org/en/docs/\" target=\"_blank\" rel=\"noopener\">Modules reference</a>。这里只配置一些能够用得上的选项：</p>\n<h3 id=\"定义缓存路径\"><a href=\"#定义缓存路径\" class=\"headerlink\" title=\"定义缓存路径\"></a>定义缓存路径</h3><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">http</span> &#123;</span><br><span class=\"line\">  <span class=\"comment\"># 设置缓存路径、设置一个两层结构的目录、设置缓存键和元数据的共享内存区名称为：mycache, 大小：10m</span></span><br><span class=\"line\">  <span class=\"comment\"># 设置项目不被访问情况下再内存中保持60分钟、缓存的上限为1g、关闭缓存临时文件，避免不必要的文件拷贝</span></span><br><span class=\"line\">  <span class=\"attribute\">proxy_cache_path</span>  /data/nginx/cache levels=<span class=\"number\">1</span>:<span class=\"number\">2</span> keys_zone=my_cache:<span class=\"number\">10m</span> inactive=<span class=\"number\">60m</span>  max_size=<span class=\"number\">1g</span> use_temp_path=<span class=\"literal\">off</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"反向代理缓存基本配置\"><a href=\"#反向代理缓存基本配置\" class=\"headerlink\" title=\"反向代理缓存基本配置\"></a>反向代理缓存基本配置</h3><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">  <span class=\"comment\"># 定义共享内存区域名称</span></span><br><span class=\"line\">  <span class=\"attribute\">proxy_cache</span>   my_cache;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># 定义nginx连接到代理服务器的超时时间</span></span><br><span class=\"line\">  <span class=\"attribute\">proxy_connect_timeout</span> <span class=\"number\">1s</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#如果当前正在更新缓存或者当前没有代理服务器来处理请求，则使用老的缓存</span></span><br><span class=\"line\">  <span class=\"attribute\">proxy_cache_use_stale</span> timeout updating;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#同一时间只允许一个请求修改缓存</span></span><br><span class=\"line\">  <span class=\"comment\">#锁定时间：1秒</span></span><br><span class=\"line\">  <span class=\"attribute\">proxy_cache_lock</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\">  <span class=\"attribute\">proxy_cache_lock_timeout</span> <span class=\"number\">1s</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#关闭代理服务器的重定向请求</span></span><br><span class=\"line\">  <span class=\"attribute\">proxy_redirect</span> <span class=\"literal\">off</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#根据客户端请求的uri生成缓存键(对uri做md5操作)</span></span><br><span class=\"line\">  <span class=\"attribute\">proxy_cache_key</span> <span class=\"string\">\"<span class=\"variable\">$request_uri</span>\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#设置200状态码的返回数据的缓存时间为1秒钟</span></span><br><span class=\"line\">  <span class=\"comment\">#定义的其实是一个绝对过期时间即：(第一次缓存的时间+配置的缓存时间)</span></span><br><span class=\"line\">  proxy_cache_valid   <span class=\"number\">200</span>   <span class=\"number\">1s</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#nginx反向代理的时候，一些http头部请求字段不会传递给代理服务器，这个时候需要我们手动指定</span></span><br><span class=\"line\">  <span class=\"attribute\">proxy_set_header</span> Host <span class=\"variable\">$host</span>;</span><br><span class=\"line\">  <span class=\"attribute\">proxy_set_header</span> X-Real-IP <span class=\"variable\">$remote_addr</span>;</span><br><span class=\"line\">  <span class=\"attribute\">proxy_set_header</span>   X-Forwarded-For  <span class=\"variable\">$proxy_add_x_forwarded_for</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#设置代理服务器集群</span></span><br><span class=\"line\">  <span class=\"attribute\">location</span> / &#123;</span><br><span class=\"line\">    <span class=\"attribute\">proxy_pass</span> http://backend;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"利用ngx-http-headers-module和ngx-http-upstream-module设置响应头信息\"><a href=\"#利用ngx-http-headers-module和ngx-http-upstream-module设置响应头信息\" class=\"headerlink\" title=\"利用ngx_http_headers_module和ngx_http_upstream_module设置响应头信息\"></a>利用<code>ngx_http_headers_module</code>和<code>ngx_http_upstream_module</code>设置响应头信息</h3><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"attribute\">location</span> / &#123;</span><br><span class=\"line\">  <span class=\"comment\"># 设置响应头部信息，判断请求是否被缓存</span></span><br><span class=\"line\">  <span class=\"attribute\">add_header</span>  X-Cache   <span class=\"string\">'<span class=\"variable\">$upstream_cache_status</span>'</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"nginx-gzip模块配置\"><a href=\"#nginx-gzip模块配置\" class=\"headerlink\" title=\"nginx gzip模块配置\"></a>nginx gzip模块配置</h2><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">  <span class=\"comment\">#开启gzip压缩功能</span></span><br><span class=\"line\">  <span class=\"attribute\">gzip</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#设置启用gzip的http版本信息</span></span><br><span class=\"line\">  <span class=\"attribute\">gzip_http_version</span>   <span class=\"number\">1</span>.<span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#设置gzip压缩等级</span></span><br><span class=\"line\">  <span class=\"attribute\">gzip_comp_level</span>   <span class=\"number\">5</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#设置当Content-Length大于256的时候启用gzip配置</span></span><br><span class=\"line\">  <span class=\"attribute\">gzip_min_length</span>   <span class=\"number\">256</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#对所有的代理请求都启用gzip</span></span><br><span class=\"line\">  <span class=\"attribute\">gzip_proxied</span>  any;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#添加“Vary: Accept-Encoding”到请求头部告知代理服务器是否支持gzip压缩</span></span><br><span class=\"line\">  <span class=\"attribute\">gzip_vary</span>   <span class=\"literal\">on</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#设置需要压缩的MIME types</span></span><br><span class=\"line\">  gzip_types</span><br><span class=\"line\">    application/atom+xml</span><br><span class=\"line\">    application/javascript</span><br><span class=\"line\">    application/json</span><br><span class=\"line\">    application/rss+xml</span><br><span class=\"line\">    application/vnd.ms-fontobject</span><br><span class=\"line\">    application/x-font-ttf</span><br><span class=\"line\">    application/x-web-app-manifest+json</span><br><span class=\"line\">    application/xhtml+xml</span><br><span class=\"line\">    application/xml</span><br><span class=\"line\">    font/opentype</span><br><span class=\"line\">    image/svg+xml</span><br><span class=\"line\">    image/x-icon</span><br><span class=\"line\">    text/css</span><br><span class=\"line\">    text/plain</span><br><span class=\"line\">    text/x-component;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>–EOF–</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"nginx-基本配置\"><a href=\"#nginx-基本配置\" class=\"headerlink\" title=\"nginx 基本配置\"></a>nginx 基本配置</h2><p>为了让<code>nginx</code>能正常运行，必须设置它的一些基本配置，<code>nginx</code>基本配置主要包含了\b<code>nginx</code>正常运行的配置，包括了日志，以及对master/worker进程的控制、\b<code>nginx</code>服务监听分发等。</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">user</span> nobody; <span class=\"comment\">#worker进程启动用户</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attribute\">worker_processes</span> <span class=\"number\">1</span>; <span class=\"comment\">#worker进程数量</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attribute\">error_log</span> logs/error.log <span class=\"literal\">debug</span>; <span class=\"comment\">#设置nginx错误日志输出路径以及日志等级</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attribute\">pid</span> logs/nginx.pid;<span class=\"comment\">#设置保存master进程ID的文件路径</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">events</span> &#123;</span><br><span class=\"line\">  <span class=\"attribute\">worker_connections</span> <span class=\"number\">1024</span>;<span class=\"comment\">#设置每个worker进程最大连接数量为1024</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">http</span> &#123;</span><br><span class=\"line\">  <span class=\"comment\"># 定义MIME type 到文件拓展\b名的映射</span></span><br><span class=\"line\">  <span class=\"attribute\">include</span>       mime.types;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#默认的MIME type</span></span><br><span class=\"line\">  <span class=\"attribute\">default_type</span>  application/octet-stream;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># 新增日志格式，格式名称为main</span></span><br><span class=\"line\">  <span class=\"attribute\">log_format</span>  main  <span class=\"string\">'<span class=\"variable\">$remote_addr</span> - <span class=\"variable\">$remote_user</span> [<span class=\"variable\">$time_local</span>] \"<span class=\"variable\">$request</span>\" '</span></span><br><span class=\"line\">                    <span class=\"string\">'<span class=\"variable\">$status</span> <span class=\"variable\">$body_bytes_sent</span> \"<span class=\"variable\">$http_referer</span>\" '</span></span><br><span class=\"line\">                    <span class=\"string\">'\"<span class=\"variable\">$http_user_agent</span>\" \"<span class=\"variable\">$http_x_forwarded_for</span>\"'</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># 设置http请求访问日志写入的路径，以及解析请求日志的格式</span></span><br><span class=\"line\">  <span class=\"attribute\">access_log</span>   logs/access.log  main;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#设置上游服务器地址</span></span><br><span class=\"line\">  <span class=\"attribute\">upstream</span> backend &#123;</span><br><span class=\"line\">    <span class=\"attribute\">server</span> <span class=\"number\">127.0.0.1:3000</span>;</span><br><span class=\"line\">    <span class=\"attribute\">server</span> <span class=\"number\">127.0.0.1:3001</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">80</span>;<span class=\"comment\"># 设置nginx服务监听80端口</span></span><br><span class=\"line\">    <span class=\"attribute\">server_name</span> localhost; <span class=\"comment\"># 该server只处理请求的Host等于`localhost`的请求</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"nginx-反向代理配置\"><a href=\"#nginx-反向代理配置\" class=\"headerlink\" title=\"nginx 反向代理配置\"></a>nginx 反向代理配置</h2><p>\b<code>nginx</code>包含了一系列的http请求相关的配置，包含如：<code>ngx_http_core_module</code>、<code>ngx_http_proxy_module</code>等。参考链接: <a href=\"http://nginx.org/en/docs/\" target=\"_blank\" rel=\"noopener\">Modules reference</a>。这里只配置一些能够用得上的选项：</p>\n<h3 id=\"定义缓存路径\"><a href=\"#定义缓存路径\" class=\"headerlink\" title=\"定义缓存路径\"></a>定义缓存路径</h3><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">http</span> &#123;</span><br><span class=\"line\">  <span class=\"comment\"># 设置缓存路径、设置一个两层结构的目录、设置缓存键和元数据的共享内存区名称为：mycache, 大小：10m</span></span><br><span class=\"line\">  <span class=\"comment\"># 设置项目不被访问情况下再内存中保持60分钟、缓存的上限为1g、关闭缓存临时文件，避免不必要的文件拷贝</span></span><br><span class=\"line\">  <span class=\"attribute\">proxy_cache_path</span>  /data/nginx/cache levels=<span class=\"number\">1</span>:<span class=\"number\">2</span> keys_zone=my_cache:<span class=\"number\">10m</span> inactive=<span class=\"number\">60m</span>  max_size=<span class=\"number\">1g</span> use_temp_path=<span class=\"literal\">off</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"反向代理缓存基本配置\"><a href=\"#反向代理缓存基本配置\" class=\"headerlink\" title=\"反向代理缓存基本配置\"></a>反向代理缓存基本配置</h3><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">  <span class=\"comment\"># 定义共享内存区域名称</span></span><br><span class=\"line\">  <span class=\"attribute\">proxy_cache</span>   my_cache;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># 定义nginx连接到代理服务器的超时时间</span></span><br><span class=\"line\">  <span class=\"attribute\">proxy_connect_timeout</span> <span class=\"number\">1s</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#如果当前正在更新缓存或者当前没有代理服务器来处理请求，则使用老的缓存</span></span><br><span class=\"line\">  <span class=\"attribute\">proxy_cache_use_stale</span> timeout updating;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#同一时间只允许一个请求修改缓存</span></span><br><span class=\"line\">  <span class=\"comment\">#锁定时间：1秒</span></span><br><span class=\"line\">  <span class=\"attribute\">proxy_cache_lock</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\">  <span class=\"attribute\">proxy_cache_lock_timeout</span> <span class=\"number\">1s</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#关闭代理服务器的重定向请求</span></span><br><span class=\"line\">  <span class=\"attribute\">proxy_redirect</span> <span class=\"literal\">off</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#根据客户端请求的uri生成缓存键(对uri做md5操作)</span></span><br><span class=\"line\">  <span class=\"attribute\">proxy_cache_key</span> <span class=\"string\">\"<span class=\"variable\">$request_uri</span>\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#设置200状态码的返回数据的缓存时间为1秒钟</span></span><br><span class=\"line\">  <span class=\"comment\">#定义的其实是一个绝对过期时间即：(第一次缓存的时间+配置的缓存时间)</span></span><br><span class=\"line\">  proxy_cache_valid   <span class=\"number\">200</span>   <span class=\"number\">1s</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#nginx反向代理的时候，一些http头部请求字段不会传递给代理服务器，这个时候需要我们手动指定</span></span><br><span class=\"line\">  <span class=\"attribute\">proxy_set_header</span> Host <span class=\"variable\">$host</span>;</span><br><span class=\"line\">  <span class=\"attribute\">proxy_set_header</span> X-Real-IP <span class=\"variable\">$remote_addr</span>;</span><br><span class=\"line\">  <span class=\"attribute\">proxy_set_header</span>   X-Forwarded-For  <span class=\"variable\">$proxy_add_x_forwarded_for</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#设置代理服务器集群</span></span><br><span class=\"line\">  <span class=\"attribute\">location</span> / &#123;</span><br><span class=\"line\">    <span class=\"attribute\">proxy_pass</span> http://backend;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"利用ngx-http-headers-module和ngx-http-upstream-module设置响应头信息\"><a href=\"#利用ngx-http-headers-module和ngx-http-upstream-module设置响应头信息\" class=\"headerlink\" title=\"利用ngx_http_headers_module和ngx_http_upstream_module设置响应头信息\"></a>利用<code>ngx_http_headers_module</code>和<code>ngx_http_upstream_module</code>设置响应头信息</h3><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"attribute\">location</span> / &#123;</span><br><span class=\"line\">  <span class=\"comment\"># 设置响应头部信息，判断请求是否被缓存</span></span><br><span class=\"line\">  <span class=\"attribute\">add_header</span>  X-Cache   <span class=\"string\">'<span class=\"variable\">$upstream_cache_status</span>'</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"nginx-gzip模块配置\"><a href=\"#nginx-gzip模块配置\" class=\"headerlink\" title=\"nginx gzip模块配置\"></a>nginx gzip模块配置</h2><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">  <span class=\"comment\">#开启gzip压缩功能</span></span><br><span class=\"line\">  <span class=\"attribute\">gzip</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#设置启用gzip的http版本信息</span></span><br><span class=\"line\">  <span class=\"attribute\">gzip_http_version</span>   <span class=\"number\">1</span>.<span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#设置gzip压缩等级</span></span><br><span class=\"line\">  <span class=\"attribute\">gzip_comp_level</span>   <span class=\"number\">5</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#设置当Content-Length大于256的时候启用gzip配置</span></span><br><span class=\"line\">  <span class=\"attribute\">gzip_min_length</span>   <span class=\"number\">256</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#对所有的代理请求都启用gzip</span></span><br><span class=\"line\">  <span class=\"attribute\">gzip_proxied</span>  any;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#添加“Vary: Accept-Encoding”到请求头部告知代理服务器是否支持gzip压缩</span></span><br><span class=\"line\">  <span class=\"attribute\">gzip_vary</span>   <span class=\"literal\">on</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">#设置需要压缩的MIME types</span></span><br><span class=\"line\">  gzip_types</span><br><span class=\"line\">    application/atom+xml</span><br><span class=\"line\">    application/javascript</span><br><span class=\"line\">    application/json</span><br><span class=\"line\">    application/rss+xml</span><br><span class=\"line\">    application/vnd.ms-fontobject</span><br><span class=\"line\">    application/x-font-ttf</span><br><span class=\"line\">    application/x-web-app-manifest+json</span><br><span class=\"line\">    application/xhtml+xml</span><br><span class=\"line\">    application/xml</span><br><span class=\"line\">    font/opentype</span><br><span class=\"line\">    image/svg+xml</span><br><span class=\"line\">    image/x-icon</span><br><span class=\"line\">    text/css</span><br><span class=\"line\">    text/plain</span><br><span class=\"line\">    text/x-component;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>–EOF–</p>\n"},{"title":"npm-的工作原理","date":"2015-11-07T02:37:03.000Z","_content":"### 包(Package)和模块(Module)  \n\n#### 如何定义一个`Package`  \n\n满足如下条件都可以称为一个包：  \n- 一个文件夹包含应用程序，使用`package.json`来描述它(a)    \n- 一个用gzip压缩的文件夹，满足(a)定义(b)    \n- 一个url可以获取(b)描述的压缩包(c)  \n- 一个<name>@<version>描述的一个包已经被发布到`npm`仓库 (d)  \n- 一个<name>@<tag>描述的包同(e)  \n- 一个<name>描述的包，并且具有`latest`标签，满足(e) (f)    \n- 一个`git url` 可以被克隆，满足(a) 定义  \n\n---  \n\n**即使没有把包推送到公共的`npm`仓库，依然可以从`npm`获得很多好处：**  \n+ 如果你只是想写一个基于`nodejs`的应用程序，或者  \n+ 如果你想安装一个压缩的包  \n\n`git URL`可以是以下几种格式：  \n- git://github.com/user/project.git#commit-ish  \n- git+ssh://user@hostname:project.git#commit-ish  \n- git+http://user@hostname/project/blah.git#commit-ish  \n- git+https://user@hostname/project/blah.git#commit-ish  \n\n`commit-ish` 是一个可以`git checkout`的参数。默认为`master`。  \n\n---  \n\n#### 如何定义一个`Module`  \n\n**`Module`是任何的能被`nodejs`程序使用`require`加载的模块。**满足以下条件均可以称为`Module`：  \n+ 一个文件夹包含`package.json`文件并指定了`main`字段  \n+ 一个文件夹包含`index.js`文件  \n+ 一个`javascript`文件  \n\n\n#### 大多数`Package`都是一个`Module`  \n\n譬如说一些`cli`程序的`package`只包含一些可执行的命令行程序，并没有提供`main`字段来指定程序供外部使用。 这些`package`不是`module`。  \n\n---  \n\n### npm v2解析包的依赖关系  \n\n想像一下现在有三个模块`module A`、`module B`、`module C`。A依赖B的`V1`版本，C依赖于B的`V2`版本。  \n![deps2](http://7xsec6.com1.z0.glb.clouddn.com/deps2.png)  \n\n\n现在创建一个应用程序依赖`A`和`C`。   \n![deps4](http://7xsec6.com1.z0.glb.clouddn.com/deps4.png)  \n\n---  \n#### 模块依赖地狱(Dependency Hell)  \n包管理器必须必须提供一个`module B`的版本。在`nodejs`之前的`runtime`，都会尝试通过提供一个折中的版本来解决它。\n![deps3](http://7xsec6.com1.z0.glb.clouddn.com/deps3.png)  \n\n\n`npm`采取了另外一种方式，**把依赖的模块包嵌入子目录：**    \n![deps](http://7xsec6.com1.z0.glb.clouddn.com/deps.png)  \n\n\n---  \n\n### npm V3 解析包的依赖关系  \n\nnpm3和npm2的不同之处在于：  \n> npm2使用嵌套的方式来管理依赖包，`npm3`尝试缓和过长的包依赖路径问题。 把二级依赖的包安装在同一级目录下。  \n\n想像一下我们有一个模块`A`依赖模块`B`。我们在安装模块`A`的时候，在项目的`node_modules`文件夹下： 可以看到 `npm v2`与`npm v3`的差异：  \n\n![deps2deps3](http://7xsec6.com1.z0.glb.clouddn.com/npm3deps2.png)  \n\n\n现在我们需要安装一个模块`C`，模块`C`依赖模块`B`但是版本与模块`A`依赖的不同：  \n\n![deps3deps3](http://7xsec6.com1.z0.glb.clouddn.com/npm3deps3.png)  \n\n\n由于`B v1.0`已经安装在`node_modules`目录的根目录下了，不能把`B v2.0`也安装在根目录下。这个时候`npm v3`的处理方式和`npm v2`类似：  \n\n![deps3deps4](http://7xsec6.com1.z0.glb.clouddn.com/npm3deps4.png)  \n\n\n通过 `npm ls`查看当前项目所有包的依赖关系。如果只是想看顶级包的依赖关系可以执行`npm ls --depth=0`。  \n\n---  \n### `npm v3`去重  \n\n**npm dedupe**\n\n该命令会删除`node_modules`顶级目录下没有被使用的模块，并且把被重复依赖的模块移动到顶级目录下。  \n\n\n","source":"_posts/npm-的工作原理.md","raw":"---\ntitle: npm-的工作原理\ncategories: server\ndate: 2015-11-07 10:37:03\n---\n### 包(Package)和模块(Module)  \n\n#### 如何定义一个`Package`  \n\n满足如下条件都可以称为一个包：  \n- 一个文件夹包含应用程序，使用`package.json`来描述它(a)    \n- 一个用gzip压缩的文件夹，满足(a)定义(b)    \n- 一个url可以获取(b)描述的压缩包(c)  \n- 一个<name>@<version>描述的一个包已经被发布到`npm`仓库 (d)  \n- 一个<name>@<tag>描述的包同(e)  \n- 一个<name>描述的包，并且具有`latest`标签，满足(e) (f)    \n- 一个`git url` 可以被克隆，满足(a) 定义  \n\n---  \n\n**即使没有把包推送到公共的`npm`仓库，依然可以从`npm`获得很多好处：**  \n+ 如果你只是想写一个基于`nodejs`的应用程序，或者  \n+ 如果你想安装一个压缩的包  \n\n`git URL`可以是以下几种格式：  \n- git://github.com/user/project.git#commit-ish  \n- git+ssh://user@hostname:project.git#commit-ish  \n- git+http://user@hostname/project/blah.git#commit-ish  \n- git+https://user@hostname/project/blah.git#commit-ish  \n\n`commit-ish` 是一个可以`git checkout`的参数。默认为`master`。  \n\n---  \n\n#### 如何定义一个`Module`  \n\n**`Module`是任何的能被`nodejs`程序使用`require`加载的模块。**满足以下条件均可以称为`Module`：  \n+ 一个文件夹包含`package.json`文件并指定了`main`字段  \n+ 一个文件夹包含`index.js`文件  \n+ 一个`javascript`文件  \n\n\n#### 大多数`Package`都是一个`Module`  \n\n譬如说一些`cli`程序的`package`只包含一些可执行的命令行程序，并没有提供`main`字段来指定程序供外部使用。 这些`package`不是`module`。  \n\n---  \n\n### npm v2解析包的依赖关系  \n\n想像一下现在有三个模块`module A`、`module B`、`module C`。A依赖B的`V1`版本，C依赖于B的`V2`版本。  \n![deps2](http://7xsec6.com1.z0.glb.clouddn.com/deps2.png)  \n\n\n现在创建一个应用程序依赖`A`和`C`。   \n![deps4](http://7xsec6.com1.z0.glb.clouddn.com/deps4.png)  \n\n---  \n#### 模块依赖地狱(Dependency Hell)  \n包管理器必须必须提供一个`module B`的版本。在`nodejs`之前的`runtime`，都会尝试通过提供一个折中的版本来解决它。\n![deps3](http://7xsec6.com1.z0.glb.clouddn.com/deps3.png)  \n\n\n`npm`采取了另外一种方式，**把依赖的模块包嵌入子目录：**    \n![deps](http://7xsec6.com1.z0.glb.clouddn.com/deps.png)  \n\n\n---  \n\n### npm V3 解析包的依赖关系  \n\nnpm3和npm2的不同之处在于：  \n> npm2使用嵌套的方式来管理依赖包，`npm3`尝试缓和过长的包依赖路径问题。 把二级依赖的包安装在同一级目录下。  \n\n想像一下我们有一个模块`A`依赖模块`B`。我们在安装模块`A`的时候，在项目的`node_modules`文件夹下： 可以看到 `npm v2`与`npm v3`的差异：  \n\n![deps2deps3](http://7xsec6.com1.z0.glb.clouddn.com/npm3deps2.png)  \n\n\n现在我们需要安装一个模块`C`，模块`C`依赖模块`B`但是版本与模块`A`依赖的不同：  \n\n![deps3deps3](http://7xsec6.com1.z0.glb.clouddn.com/npm3deps3.png)  \n\n\n由于`B v1.0`已经安装在`node_modules`目录的根目录下了，不能把`B v2.0`也安装在根目录下。这个时候`npm v3`的处理方式和`npm v2`类似：  \n\n![deps3deps4](http://7xsec6.com1.z0.glb.clouddn.com/npm3deps4.png)  \n\n\n通过 `npm ls`查看当前项目所有包的依赖关系。如果只是想看顶级包的依赖关系可以执行`npm ls --depth=0`。  \n\n---  \n### `npm v3`去重  \n\n**npm dedupe**\n\n该命令会删除`node_modules`顶级目录下没有被使用的模块，并且把被重复依赖的模块移动到顶级目录下。  \n\n\n","slug":"npm-的工作原理","published":1,"updated":"2018-07-01T10:30:46.496Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cds002wy4zv708ae0lo","content":"<h3 id=\"包-Package-和模块-Module\"><a href=\"#包-Package-和模块-Module\" class=\"headerlink\" title=\"包(Package)和模块(Module)\"></a>包(Package)和模块(Module)</h3><h4 id=\"如何定义一个Package\"><a href=\"#如何定义一个Package\" class=\"headerlink\" title=\"如何定义一个Package\"></a>如何定义一个<code>Package</code></h4><p>满足如下条件都可以称为一个包：  </p>\n<ul>\n<li>一个文件夹包含应用程序，使用<code>package.json</code>来描述它(a)    </li>\n<li>一个用gzip压缩的文件夹，满足(a)定义(b)    </li>\n<li>一个url可以获取(b)描述的压缩包(c)  </li>\n<li>一个<name>@<version>描述的一个包已经被发布到<code>npm</code>仓库 (d)  </version></name></li>\n<li>一个<name>@<tag>描述的包同(e)  </tag></name></li>\n<li>一个<name>描述的包，并且具有<code>latest</code>标签，满足(e) (f)    </name></li>\n<li>一个<code>git url</code> 可以被克隆，满足(a) 定义  </li>\n</ul>\n<hr>\n<p><strong>即使没有把包推送到公共的<code>npm</code>仓库，依然可以从<code>npm</code>获得很多好处：</strong>  </p>\n<ul>\n<li>如果你只是想写一个基于<code>nodejs</code>的应用程序，或者  </li>\n<li>如果你想安装一个压缩的包  </li>\n</ul>\n<p><code>git URL</code>可以是以下几种格式：  </p>\n<ul>\n<li>git://github.com/user/project.git#commit-ish  </li>\n<li>git+ssh://user@hostname:project.git#commit-ish  </li>\n<li>git+<a href=\"http://user@hostname/project/blah.git#commit-ish\" target=\"_blank\" rel=\"noopener\">http://user@hostname/project/blah.git#commit-ish</a>  </li>\n<li>git+<a href=\"https://user@hostname/project/blah.git#commit-ish\" target=\"_blank\" rel=\"noopener\">https://user@hostname/project/blah.git#commit-ish</a>  </li>\n</ul>\n<p><code>commit-ish</code> 是一个可以<code>git checkout</code>的参数。默认为<code>master</code>。  </p>\n<hr>\n<h4 id=\"如何定义一个Module\"><a href=\"#如何定义一个Module\" class=\"headerlink\" title=\"如何定义一个Module\"></a>如何定义一个<code>Module</code></h4><p><strong><code>Module</code>是任何的能被<code>nodejs</code>程序使用<code>require</code>加载的模块。</strong>满足以下条件均可以称为<code>Module</code>：  </p>\n<ul>\n<li>一个文件夹包含<code>package.json</code>文件并指定了<code>main</code>字段  </li>\n<li>一个文件夹包含<code>index.js</code>文件  </li>\n<li>一个<code>javascript</code>文件  </li>\n</ul>\n<h4 id=\"大多数Package都是一个Module\"><a href=\"#大多数Package都是一个Module\" class=\"headerlink\" title=\"大多数Package都是一个Module\"></a>大多数<code>Package</code>都是一个<code>Module</code></h4><p>譬如说一些<code>cli</code>程序的<code>package</code>只包含一些可执行的命令行程序，并没有提供<code>main</code>字段来指定程序供外部使用。 这些<code>package</code>不是<code>module</code>。  </p>\n<hr>\n<h3 id=\"npm-v2解析包的依赖关系\"><a href=\"#npm-v2解析包的依赖关系\" class=\"headerlink\" title=\"npm v2解析包的依赖关系\"></a>npm v2解析包的依赖关系</h3><p>想像一下现在有三个模块<code>module A</code>、<code>module B</code>、<code>module C</code>。A依赖B的<code>V1</code>版本，C依赖于B的<code>V2</code>版本。<br><img src=\"http://7xsec6.com1.z0.glb.clouddn.com/deps2.png\" alt=\"deps2\">  </p>\n<p>现在创建一个应用程序依赖<code>A</code>和<code>C</code>。<br><img src=\"http://7xsec6.com1.z0.glb.clouddn.com/deps4.png\" alt=\"deps4\">  </p>\n<hr>\n<h4 id=\"模块依赖地狱-Dependency-Hell\"><a href=\"#模块依赖地狱-Dependency-Hell\" class=\"headerlink\" title=\"模块依赖地狱(Dependency Hell)\"></a>模块依赖地狱(Dependency Hell)</h4><p>包管理器必须必须提供一个<code>module B</code>的版本。在<code>nodejs</code>之前的<code>runtime</code>，都会尝试通过提供一个折中的版本来解决它。<br><img src=\"http://7xsec6.com1.z0.glb.clouddn.com/deps3.png\" alt=\"deps3\">  </p>\n<p><code>npm</code>采取了另外一种方式，<strong>把依赖的模块包嵌入子目录：</strong><br><img src=\"http://7xsec6.com1.z0.glb.clouddn.com/deps.png\" alt=\"deps\">  </p>\n<hr>\n<h3 id=\"npm-V3-解析包的依赖关系\"><a href=\"#npm-V3-解析包的依赖关系\" class=\"headerlink\" title=\"npm V3 解析包的依赖关系\"></a>npm V3 解析包的依赖关系</h3><p>npm3和npm2的不同之处在于：  </p>\n<blockquote>\n<p>npm2使用嵌套的方式来管理依赖包，<code>npm3</code>尝试缓和过长的包依赖路径问题。 把二级依赖的包安装在同一级目录下。  </p>\n</blockquote>\n<p>想像一下我们有一个模块<code>A</code>依赖模块<code>B</code>。我们在安装模块<code>A</code>的时候，在项目的<code>node_modules</code>文件夹下： 可以看到 <code>npm v2</code>与<code>npm v3</code>的差异：  </p>\n<p><img src=\"http://7xsec6.com1.z0.glb.clouddn.com/npm3deps2.png\" alt=\"deps2deps3\">  </p>\n<p>现在我们需要安装一个模块<code>C</code>，模块<code>C</code>依赖模块<code>B</code>但是版本与模块<code>A</code>依赖的不同：  </p>\n<p><img src=\"http://7xsec6.com1.z0.glb.clouddn.com/npm3deps3.png\" alt=\"deps3deps3\">  </p>\n<p>由于<code>B v1.0</code>已经安装在<code>node_modules</code>目录的根目录下了，不能把<code>B v2.0</code>也安装在根目录下。这个时候<code>npm v3</code>的处理方式和<code>npm v2</code>类似：  </p>\n<p><img src=\"http://7xsec6.com1.z0.glb.clouddn.com/npm3deps4.png\" alt=\"deps3deps4\">  </p>\n<p>通过 <code>npm ls</code>查看当前项目所有包的依赖关系。如果只是想看顶级包的依赖关系可以执行<code>npm ls --depth=0</code>。  </p>\n<hr>\n<h3 id=\"npm-v3去重\"><a href=\"#npm-v3去重\" class=\"headerlink\" title=\"npm v3去重\"></a><code>npm v3</code>去重</h3><p><strong>npm dedupe</strong></p>\n<p>该命令会删除<code>node_modules</code>顶级目录下没有被使用的模块，并且把被重复依赖的模块移动到顶级目录下。  </p>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"包-Package-和模块-Module\"><a href=\"#包-Package-和模块-Module\" class=\"headerlink\" title=\"包(Package)和模块(Module)\"></a>包(Package)和模块(Module)</h3><h4 id=\"如何定义一个Package\"><a href=\"#如何定义一个Package\" class=\"headerlink\" title=\"如何定义一个Package\"></a>如何定义一个<code>Package</code></h4><p>满足如下条件都可以称为一个包：  </p>\n<ul>\n<li>一个文件夹包含应用程序，使用<code>package.json</code>来描述它(a)    </li>\n<li>一个用gzip压缩的文件夹，满足(a)定义(b)    </li>\n<li>一个url可以获取(b)描述的压缩包(c)  </li>\n<li>一个<name>@<version>描述的一个包已经被发布到<code>npm</code>仓库 (d)  </version></name></li>\n<li>一个<name>@<tag>描述的包同(e)  </tag></name></li>\n<li>一个<name>描述的包，并且具有<code>latest</code>标签，满足(e) (f)    </name></li>\n<li>一个<code>git url</code> 可以被克隆，满足(a) 定义  </li>\n</ul>\n<hr>\n<p><strong>即使没有把包推送到公共的<code>npm</code>仓库，依然可以从<code>npm</code>获得很多好处：</strong>  </p>\n<ul>\n<li>如果你只是想写一个基于<code>nodejs</code>的应用程序，或者  </li>\n<li>如果你想安装一个压缩的包  </li>\n</ul>\n<p><code>git URL</code>可以是以下几种格式：  </p>\n<ul>\n<li>git://github.com/user/project.git#commit-ish  </li>\n<li>git+ssh://user@hostname:project.git#commit-ish  </li>\n<li>git+<a href=\"http://user@hostname/project/blah.git#commit-ish\" target=\"_blank\" rel=\"noopener\">http://user@hostname/project/blah.git#commit-ish</a>  </li>\n<li>git+<a href=\"https://user@hostname/project/blah.git#commit-ish\" target=\"_blank\" rel=\"noopener\">https://user@hostname/project/blah.git#commit-ish</a>  </li>\n</ul>\n<p><code>commit-ish</code> 是一个可以<code>git checkout</code>的参数。默认为<code>master</code>。  </p>\n<hr>\n<h4 id=\"如何定义一个Module\"><a href=\"#如何定义一个Module\" class=\"headerlink\" title=\"如何定义一个Module\"></a>如何定义一个<code>Module</code></h4><p><strong><code>Module</code>是任何的能被<code>nodejs</code>程序使用<code>require</code>加载的模块。</strong>满足以下条件均可以称为<code>Module</code>：  </p>\n<ul>\n<li>一个文件夹包含<code>package.json</code>文件并指定了<code>main</code>字段  </li>\n<li>一个文件夹包含<code>index.js</code>文件  </li>\n<li>一个<code>javascript</code>文件  </li>\n</ul>\n<h4 id=\"大多数Package都是一个Module\"><a href=\"#大多数Package都是一个Module\" class=\"headerlink\" title=\"大多数Package都是一个Module\"></a>大多数<code>Package</code>都是一个<code>Module</code></h4><p>譬如说一些<code>cli</code>程序的<code>package</code>只包含一些可执行的命令行程序，并没有提供<code>main</code>字段来指定程序供外部使用。 这些<code>package</code>不是<code>module</code>。  </p>\n<hr>\n<h3 id=\"npm-v2解析包的依赖关系\"><a href=\"#npm-v2解析包的依赖关系\" class=\"headerlink\" title=\"npm v2解析包的依赖关系\"></a>npm v2解析包的依赖关系</h3><p>想像一下现在有三个模块<code>module A</code>、<code>module B</code>、<code>module C</code>。A依赖B的<code>V1</code>版本，C依赖于B的<code>V2</code>版本。<br><img src=\"http://7xsec6.com1.z0.glb.clouddn.com/deps2.png\" alt=\"deps2\">  </p>\n<p>现在创建一个应用程序依赖<code>A</code>和<code>C</code>。<br><img src=\"http://7xsec6.com1.z0.glb.clouddn.com/deps4.png\" alt=\"deps4\">  </p>\n<hr>\n<h4 id=\"模块依赖地狱-Dependency-Hell\"><a href=\"#模块依赖地狱-Dependency-Hell\" class=\"headerlink\" title=\"模块依赖地狱(Dependency Hell)\"></a>模块依赖地狱(Dependency Hell)</h4><p>包管理器必须必须提供一个<code>module B</code>的版本。在<code>nodejs</code>之前的<code>runtime</code>，都会尝试通过提供一个折中的版本来解决它。<br><img src=\"http://7xsec6.com1.z0.glb.clouddn.com/deps3.png\" alt=\"deps3\">  </p>\n<p><code>npm</code>采取了另外一种方式，<strong>把依赖的模块包嵌入子目录：</strong><br><img src=\"http://7xsec6.com1.z0.glb.clouddn.com/deps.png\" alt=\"deps\">  </p>\n<hr>\n<h3 id=\"npm-V3-解析包的依赖关系\"><a href=\"#npm-V3-解析包的依赖关系\" class=\"headerlink\" title=\"npm V3 解析包的依赖关系\"></a>npm V3 解析包的依赖关系</h3><p>npm3和npm2的不同之处在于：  </p>\n<blockquote>\n<p>npm2使用嵌套的方式来管理依赖包，<code>npm3</code>尝试缓和过长的包依赖路径问题。 把二级依赖的包安装在同一级目录下。  </p>\n</blockquote>\n<p>想像一下我们有一个模块<code>A</code>依赖模块<code>B</code>。我们在安装模块<code>A</code>的时候，在项目的<code>node_modules</code>文件夹下： 可以看到 <code>npm v2</code>与<code>npm v3</code>的差异：  </p>\n<p><img src=\"http://7xsec6.com1.z0.glb.clouddn.com/npm3deps2.png\" alt=\"deps2deps3\">  </p>\n<p>现在我们需要安装一个模块<code>C</code>，模块<code>C</code>依赖模块<code>B</code>但是版本与模块<code>A</code>依赖的不同：  </p>\n<p><img src=\"http://7xsec6.com1.z0.glb.clouddn.com/npm3deps3.png\" alt=\"deps3deps3\">  </p>\n<p>由于<code>B v1.0</code>已经安装在<code>node_modules</code>目录的根目录下了，不能把<code>B v2.0</code>也安装在根目录下。这个时候<code>npm v3</code>的处理方式和<code>npm v2</code>类似：  </p>\n<p><img src=\"http://7xsec6.com1.z0.glb.clouddn.com/npm3deps4.png\" alt=\"deps3deps4\">  </p>\n<p>通过 <code>npm ls</code>查看当前项目所有包的依赖关系。如果只是想看顶级包的依赖关系可以执行<code>npm ls --depth=0</code>。  </p>\n<hr>\n<h3 id=\"npm-v3去重\"><a href=\"#npm-v3去重\" class=\"headerlink\" title=\"npm v3去重\"></a><code>npm v3</code>去重</h3><p><strong>npm dedupe</strong></p>\n<p>该命令会删除<code>node_modules</code>顶级目录下没有被使用的模块，并且把被重复依赖的模块移动到顶级目录下。  </p>\n"},{"title":"position","date":"2016-08-02T15:04:37.000Z","_content":"\n提到`web`控件的布局(`layout`)，`position`的概念必须理清楚。简单对`position`属性的基本概念做一个总结吧！\n以下文档参考了：[CSS-tricks](https://css-tricks.com/almanac/properties/p/position/)、[W3School](http://www.w3schools.com/css/css_positioning.asp)。\n\n---\n\n# `position`基本属性：\n\n- static\n- relative\n- absolute\n- fixed\n- inherits\n\n## static\n\n所有web element默认的`position`属性都为`static`。在`static`模式下，元素的`left`、`top`、`right`、`bottom`、`z-index`。**属性都不起作用**。\n也就是说，默认情况下，所有元素的这些属性都不能用！\n\n\n## relative\n\n`relative`顾名思义表示相对定位，相对元素在正常流中的位置做偏移。注意：**`relative`定位的元素参考的是该元素正常流氏布局的位置**。\n\n\n## absolute\n\n`absolute`又名绝对定位，该属性的元素在计算位置的时候参考的是最近的非`static`属性的祖先元素。如果不存在相应元素，则参考`body`定位。\n注意：`absolute`定位的元素会随着屏幕滚动。\n\n\n## fixed\n\n`fixed`意为固定，参考浏览器视口来定位(`viewport`)。不随屏幕滚动,所以在调出调式工具的时候依然可见。\n\n\n## inherits\n\n`position`属性非继承。所以可以显示的把父元素的属性强制继承过来。\n\n\n\n## 再所说`z-index`\n\n`z-index`表示元素元素所在的层级，默认为`0`，数字越大越贴近用户，当然也可以为负数。","source":"_posts/position.md","raw":"---\ntitle: position\ndate: 2016-08-02 23:04:37\ncategories: web\ntags: \n  - position \n  - layout\n---\n\n提到`web`控件的布局(`layout`)，`position`的概念必须理清楚。简单对`position`属性的基本概念做一个总结吧！\n以下文档参考了：[CSS-tricks](https://css-tricks.com/almanac/properties/p/position/)、[W3School](http://www.w3schools.com/css/css_positioning.asp)。\n\n---\n\n# `position`基本属性：\n\n- static\n- relative\n- absolute\n- fixed\n- inherits\n\n## static\n\n所有web element默认的`position`属性都为`static`。在`static`模式下，元素的`left`、`top`、`right`、`bottom`、`z-index`。**属性都不起作用**。\n也就是说，默认情况下，所有元素的这些属性都不能用！\n\n\n## relative\n\n`relative`顾名思义表示相对定位，相对元素在正常流中的位置做偏移。注意：**`relative`定位的元素参考的是该元素正常流氏布局的位置**。\n\n\n## absolute\n\n`absolute`又名绝对定位，该属性的元素在计算位置的时候参考的是最近的非`static`属性的祖先元素。如果不存在相应元素，则参考`body`定位。\n注意：`absolute`定位的元素会随着屏幕滚动。\n\n\n## fixed\n\n`fixed`意为固定，参考浏览器视口来定位(`viewport`)。不随屏幕滚动,所以在调出调式工具的时候依然可见。\n\n\n## inherits\n\n`position`属性非继承。所以可以显示的把父元素的属性强制继承过来。\n\n\n\n## 再所说`z-index`\n\n`z-index`表示元素元素所在的层级，默认为`0`，数字越大越贴近用户，当然也可以为负数。","slug":"position","published":1,"updated":"2018-07-01T10:30:46.496Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cdt002yy4zvjqa3dp1y","content":"<p>提到<code>web</code>控件的布局(<code>layout</code>)，<code>position</code>的概念必须理清楚。简单对<code>position</code>属性的基本概念做一个总结吧！<br>以下文档参考了：<a href=\"https://css-tricks.com/almanac/properties/p/position/\" target=\"_blank\" rel=\"noopener\">CSS-tricks</a>、<a href=\"http://www.w3schools.com/css/css_positioning.asp\" target=\"_blank\" rel=\"noopener\">W3School</a>。</p>\n<hr>\n<h1 id=\"position基本属性：\"><a href=\"#position基本属性：\" class=\"headerlink\" title=\"position基本属性：\"></a><code>position</code>基本属性：</h1><ul>\n<li>static</li>\n<li>relative</li>\n<li>absolute</li>\n<li>fixed</li>\n<li>inherits</li>\n</ul>\n<h2 id=\"static\"><a href=\"#static\" class=\"headerlink\" title=\"static\"></a>static</h2><p>所有web element默认的<code>position</code>属性都为<code>static</code>。在<code>static</code>模式下，元素的<code>left</code>、<code>top</code>、<code>right</code>、<code>bottom</code>、<code>z-index</code>。<strong>属性都不起作用</strong>。<br>也就是说，默认情况下，所有元素的这些属性都不能用！</p>\n<h2 id=\"relative\"><a href=\"#relative\" class=\"headerlink\" title=\"relative\"></a>relative</h2><p><code>relative</code>顾名思义表示相对定位，相对元素在正常流中的位置做偏移。注意：<strong><code>relative</code>定位的元素参考的是该元素正常流氏布局的位置</strong>。</p>\n<h2 id=\"absolute\"><a href=\"#absolute\" class=\"headerlink\" title=\"absolute\"></a>absolute</h2><p><code>absolute</code>又名绝对定位，该属性的元素在计算位置的时候参考的是最近的非<code>static</code>属性的祖先元素。如果不存在相应元素，则参考<code>body</code>定位。<br>注意：<code>absolute</code>定位的元素会随着屏幕滚动。</p>\n<h2 id=\"fixed\"><a href=\"#fixed\" class=\"headerlink\" title=\"fixed\"></a>fixed</h2><p><code>fixed</code>意为固定，参考浏览器视口来定位(<code>viewport</code>)。不随屏幕滚动,所以在调出调式工具的时候依然可见。</p>\n<h2 id=\"inherits\"><a href=\"#inherits\" class=\"headerlink\" title=\"inherits\"></a>inherits</h2><p><code>position</code>属性非继承。所以可以显示的把父元素的属性强制继承过来。</p>\n<h2 id=\"再所说z-index\"><a href=\"#再所说z-index\" class=\"headerlink\" title=\"再所说z-index\"></a>再所说<code>z-index</code></h2><p><code>z-index</code>表示元素元素所在的层级，默认为<code>0</code>，数字越大越贴近用户，当然也可以为负数。</p>\n","site":{"data":{}},"excerpt":"","more":"<p>提到<code>web</code>控件的布局(<code>layout</code>)，<code>position</code>的概念必须理清楚。简单对<code>position</code>属性的基本概念做一个总结吧！<br>以下文档参考了：<a href=\"https://css-tricks.com/almanac/properties/p/position/\" target=\"_blank\" rel=\"noopener\">CSS-tricks</a>、<a href=\"http://www.w3schools.com/css/css_positioning.asp\" target=\"_blank\" rel=\"noopener\">W3School</a>。</p>\n<hr>\n<h1 id=\"position基本属性：\"><a href=\"#position基本属性：\" class=\"headerlink\" title=\"position基本属性：\"></a><code>position</code>基本属性：</h1><ul>\n<li>static</li>\n<li>relative</li>\n<li>absolute</li>\n<li>fixed</li>\n<li>inherits</li>\n</ul>\n<h2 id=\"static\"><a href=\"#static\" class=\"headerlink\" title=\"static\"></a>static</h2><p>所有web element默认的<code>position</code>属性都为<code>static</code>。在<code>static</code>模式下，元素的<code>left</code>、<code>top</code>、<code>right</code>、<code>bottom</code>、<code>z-index</code>。<strong>属性都不起作用</strong>。<br>也就是说，默认情况下，所有元素的这些属性都不能用！</p>\n<h2 id=\"relative\"><a href=\"#relative\" class=\"headerlink\" title=\"relative\"></a>relative</h2><p><code>relative</code>顾名思义表示相对定位，相对元素在正常流中的位置做偏移。注意：<strong><code>relative</code>定位的元素参考的是该元素正常流氏布局的位置</strong>。</p>\n<h2 id=\"absolute\"><a href=\"#absolute\" class=\"headerlink\" title=\"absolute\"></a>absolute</h2><p><code>absolute</code>又名绝对定位，该属性的元素在计算位置的时候参考的是最近的非<code>static</code>属性的祖先元素。如果不存在相应元素，则参考<code>body</code>定位。<br>注意：<code>absolute</code>定位的元素会随着屏幕滚动。</p>\n<h2 id=\"fixed\"><a href=\"#fixed\" class=\"headerlink\" title=\"fixed\"></a>fixed</h2><p><code>fixed</code>意为固定，参考浏览器视口来定位(<code>viewport</code>)。不随屏幕滚动,所以在调出调式工具的时候依然可见。</p>\n<h2 id=\"inherits\"><a href=\"#inherits\" class=\"headerlink\" title=\"inherits\"></a>inherits</h2><p><code>position</code>属性非继承。所以可以显示的把父元素的属性强制继承过来。</p>\n<h2 id=\"再所说z-index\"><a href=\"#再所说z-index\" class=\"headerlink\" title=\"再所说z-index\"></a>再所说<code>z-index</code></h2><p><code>z-index</code>表示元素元素所在的层级，默认为<code>0</code>，数字越大越贴近用户，当然也可以为负数。</p>\n"},{"title":"nodejs-Modules-(一)","date":"2015-12-07T02:37:01.000Z","_content":"  Nodejs拥有一套简单的模块加载系统，在Nodejs里面文件和模块是一一对应的关系。例如：`foo.js`加载了同一个目录下的`circle.js`文件。  \n\n\n`circle.js`文件内容：  \n``` javascript  \nconst PI = Math.PI;  \nexports.area = (r) => PI*r*r;  \nexports.circumference = (r) => 2*PI*r;  \n```  \n\n`foo.js`文件内容：  \n```javascript  \nconst circle = require('./circle.js');  \nconsole.log(`the area of radius 4 is ${circle.area(4)}`);\n\n```    \n\n`circle`模块导出了`area`和`circumference`函数，为了根模块能够引用到它，你可以把它们添加到`exports`对象上。  \n\n**模块内部的局部变量都是私有的,  因为每个模块都被封装在一个函数内部。**上面的例中`PI`就是属于`circle`模块的局部变量。  \n\n**如果你希望导出一个函数或者一个对象，你应该把该函数或者对象赋值给`module.exports`而不是`exports`**。  \n\n---  \n\n### 访问主模块  \n如果一个模块直接通过`Node.js`启动运行，`require.main`将会设置为该模块。你可以通过如下方式测试当前模块是否为主模块：  \n```javascript  \nconsole.log(require.main === module);\n```  \n举个例子，对于`foo.js`文件，如果通过`nodejs foo.js`运行，那么该测试将会输出`true`, 如果通过`require('foo.js')`，测试将输出`false`。  \n由于每个`module`对象都有一个`filename`属性，也可以通过`require.main.filename`查看主模块文件名。  \n\n---  \n\n### 模块加载  \n\n当我们调用`require`加载外部文件的时候，将会调用`require.resolve`函数。具体的解析规则如下：  \n\n```  \n在Y目录下的模块调用require(X)  \n- 1. 如果X是一个内建核心模块，  \n   a. 返回该模块  \n   b. 停止执行  \n\n- 2. 如果X使用`./`或者`/`或者`../`开头  \n   a. 把(Y+X)作为文件路径来加载(LOAD_AS_FILE)      \n   b. 把(Y+X)作为目录路径来加载(LOAD_AS_DIRECTORY)    \n\n- 3. 加载`node_modules(X, dirname(Y))`(LOAD_NODE_MODULES)    \n\n- 4. 抛出`not found`异常  \n\n```  \n\n**LOAD_AS_FILE(x)**  \n- A. 如果`x`是一个文件则把`x`作为`javascript`文本文件加载。  停止  \n- B. 如果`x.js`是一个文件则把`x.js`作为`javascript`文本文件加载。 停止  \n- C. 如果`x.json`是一个文件则把`x.json`作为一个`javascript`对象来解析。 停止  \n- D. 如果`x.node`是一个文件则把`x.node`作为一个二进制插件。停止  \n\n**LOAD_AS_DIRECTORY(x)**  \n- A. 如果`x/package.json`是一个文件  \n   a. 解析`package.json`读取`main`字段.  \n   b. let m = x + `main`字段值  \n   c. LOAD_AS_FILE(m)   \n- B. 如果`x/index.js`是一个文件，则把`x/index.js`作为`javascript`文本文件加载。 停止  \n- C. 如果`x/index.json`是一个文件，则把`x/index.json`作为`js`对象来解析。停止  \n- D. 如果`x/index.node`是一个文件， 则把`x/index.node`作为二进制插件加载。停止  \n\n**NODE_MODULES_PATHS(START)**  \n- 1. let PARTS = path split(START)  \n- 2. let I = count of PARTS - 1  \n- 3. let DIRS = []  \n- 4. while I >= 0,  \n   a. if PARTS[I] = \"node_modules\" CONTINUE  \n   c. DIR = path join(PARTS[0 .. I] + \"node_modules\")  \n   b. DIRS = DIRS + DIR    \n   c. let I = I - 1  \n- 5. return DIRS  \n\n---  \n\n### 模块缓存  \n模块在首次加载完毕之后会被缓存， 这意味着`require('foo.js')`不会导致`foo.js`被执行两次。 如果希望多次执行模块代码，可以导出`export`一个函数，该函数负责执行代码。  \n\n#### 模块缓存警告  \n+ 1、模块基于被解析的名字来缓存，由于同一个模块在不同目录被加载可能会得到不同的文件名，所以`require('foo')`，不能保证总是得到相同的对象。  \n\n+ 2、在一些大小写不敏感的系统，不同的文件名被系统指向同一个文件，但是缓存模块依旧认为它们是两个不同的模块，也就是说，`require('foo')`和`require('FOO')`将会得到两个不同的对象，而不考虑，`foo`和`FOO`是否是同一个文件。  \n\n---  \n\n### 核心模块  \n`Nodejs`内置几个被打成二进制形式的包。内置模块将会被优先加载，例如`require('http')`将会加载内置的`http`模块，即使有一个文件名也为`http`。  \n\n**需要注意的是：核心模块在安装的时候已经和`node`可执行程序打包到一起了。**  \n\n--- \n\n### 循环加载  \n\n考虑有这样几个模块：  \n`a.js`  \n```javascript  \nconsole.log('a starting');\nexports.done = false;\nconst b = require('./b.js');\nconsole.log('in a, b.done = %j', b.done);\nexports.done = true;\nconsole.log('a done');  \n```  \n\n`b.js`  \n```javascript\nconsole.log('b starting');\nexports.done = false;\nconst a = require('./a.js');\nconsole.log('in b, a.done = %j', a.done);\nexports.done = true;\nconsole.log('b done');\n```\n\n`main.js`\n```javascript  \nconsole.log('main starting');\nconst a = require('./a.js');\nconst b = require('./b.js');\nconsole.log('in main, a.done=%j, b.done=%j', a.done, b.done);\n```\n\n但`main.js`开始加载`a.js`而，`a.js`开始加载`b.js`，而`b.js`又开始加载`a.js`。为了阻止无限循环模块加载，一个**未加载完成的a模块**将会返回给`b.js`，接着`b.js`模块加载完毕，把`exports`对象返回给`a.js`。  \n\n于此同时`main.js`两个模块都加载完毕了，运行`main.js`输出如下： \n\n```javascript  \n$ node main.js\nmain starting\na starting\nb starting\nin b, a.done = false\nb done\nin a, b.done = true\na done\nin main, a.done=true, b.done=true\n```\n\n---  \n\n### 文件模块   \n如果指定的文件名文件不存在，那么`Node.js`将会尝试加载不同后缀名的文件主要有：(`.js`, `.json`, `.node`)。  \n`.js`后缀被解析为`js`文本文件，`.json`文件被解析文`js`对象，`.node`文件被解析为`node`插件，通过`dlopen`加载。  \n\n---  \n\n### 文件夹作为模块    \n使用文件夹是一个非常便捷的代码管理方式，提供一个统一的外部入口，供外部调用该文件夹。主要有三种方式可以达到该目的：  \n\n- 在文件夹的根目录建立一个`package.json`，使用`main`字段指定入口脚本文件，例如：  \n```javascript  \n{ \"name\" : \"some-library\",\n  \"main\" : \"./lib/some-library.js\" }\n```  \n\n在当前目录下有一个`some-library`文件夹，此时调用`require('./some-library')`将会尝试加载`./some-library/lib/some-library.js`文件。如果`main`字段指定的文件找不到，`Node.js`将会报错：  \n```\nError: Cannot find module 'some-library'\n```  \n\n如果在该文件夹下没有`package.json`,`Node.js`将会尝试加载：  \n- ./some-library/index.js  \n- ./some-library/index.json  \n- ./some-library/index.node  \n\n---  \n\n### 从`node_modules`文件夹加载  \n\n如果传递给`require`的参数既不是内置模块，模块名称也不是以`./`、`/`、`../`开头，那么`Node.js`将会尝试寻找父目录下的`node_modules`文件夹。如果没有找到就再往上面一层查找，直到退回系统根目录。  \n\n举个例子：文件`/home/ry/project/foo.js`，调用`require('bar.js')`，将会查找以下`node_modules`文件夹：  \n- `/home/ry/project/node_modules/bar.js`  \n- `/home/ry/node_modules/bar.js`     \n- `/home/node_modules/bar.js`    \n- `/node_modules/bar.js`  \n\n---  \n\n### 从全局文件夹加载模块  \n\n`NODE_PATH`环境变量被配置为用一系列冒号分隔的绝对路径，`Nodejs`将会去这些目录下寻找模块。`NODE_PATH`最初在前面的一些模块加载方法都没有出现的时候使用，现在慢慢变得没那么必要了。  \n除此之外`Node.js`还会查找以下目录：  \n- $HOME/.node_modules  \n- $HOME/.node_libraries  \n- $PREFIX/lib/node_modules  \n\n`$HOME`为当前用户的根目录，`$PREFIX`通过`node_prefix`来配置。  \n\n**基于一些历史方面的原因，建议把模块安装在本地的`node_modules`文件夹下，这一加载速度最快也最可靠。**  \n\n---  \n\n### 模块包装  \n\n在模块执行之前，`Node.js`把它包装成一个函数的形式，看起来像这样：  \n```javascript  \n(function (exports, require, module, __filename, __dirname) {\n// Your module code actually lives in here\n});  \n```  \n\n通过这种做法带来以下好处：  \n- 保证被`let`,`var`,`const`定义的变量作用域局限于模块内部，而不是全局变量。  \n- 包装了几个看起来类似于全局变量来指定该模块，例如：  \n  + `module`和`exports`变量，用于从该模块导出数据到其他模块。  \n  + `__filename`,`__dirname`,指向该模块的文件绝对路径以及文件夹路径。  \n\n---  \n\n### `module`对象  \n\n- module.children   \n一个数组指定了当前模块引用的其他模块。  \n\n- module.exports  \n一个对象，用于导出数据，如果希望导出的是一个函数，则应该给`module.exports`赋值，而不是给`exports`。否则会造成意想不到的后果。\n\n- exports\n一个对象，最初指向`module.exports`，如果你给它赋值，它将会指向对象，而不是最初的`module.exports`。  \n类似于：  \n\n```javascript  \nfunction require(...) {\n  // ...\n  ((module, exports) => {\n    // Your module code here\n    exports = some_func;        // re-assigns exports, exports is no longer\n                                // a shortcut, and nothing is exported.\n    module.exports = some_func; // makes your module export 0\n  })(module, module.exports);\n  return module;\n}\n```  \n\n- module.filename  \n模块的绝对路径名称  \n\n- module.id  \n模块`id`通常等于`module.filename`  \n\n- module.loaded  \n用于判断模块是否加载完毕，或者正在加载中。  \n\n- module.parent  \n指向首次加载本模块的模块。  \n\n- module.require(id)  \n + id: String  \n + 返回一个module.exports导出的对象。  \n\n\n  \n","source":"_posts/nodejs-Modules-(一).md","raw":"---\ntitle: nodejs-Modules-(一)\ncategories: server\ndate: 2015-12-07 10:37:01\n---\n  Nodejs拥有一套简单的模块加载系统，在Nodejs里面文件和模块是一一对应的关系。例如：`foo.js`加载了同一个目录下的`circle.js`文件。  \n\n\n`circle.js`文件内容：  \n``` javascript  \nconst PI = Math.PI;  \nexports.area = (r) => PI*r*r;  \nexports.circumference = (r) => 2*PI*r;  \n```  \n\n`foo.js`文件内容：  \n```javascript  \nconst circle = require('./circle.js');  \nconsole.log(`the area of radius 4 is ${circle.area(4)}`);\n\n```    \n\n`circle`模块导出了`area`和`circumference`函数，为了根模块能够引用到它，你可以把它们添加到`exports`对象上。  \n\n**模块内部的局部变量都是私有的,  因为每个模块都被封装在一个函数内部。**上面的例中`PI`就是属于`circle`模块的局部变量。  \n\n**如果你希望导出一个函数或者一个对象，你应该把该函数或者对象赋值给`module.exports`而不是`exports`**。  \n\n---  \n\n### 访问主模块  \n如果一个模块直接通过`Node.js`启动运行，`require.main`将会设置为该模块。你可以通过如下方式测试当前模块是否为主模块：  \n```javascript  \nconsole.log(require.main === module);\n```  \n举个例子，对于`foo.js`文件，如果通过`nodejs foo.js`运行，那么该测试将会输出`true`, 如果通过`require('foo.js')`，测试将输出`false`。  \n由于每个`module`对象都有一个`filename`属性，也可以通过`require.main.filename`查看主模块文件名。  \n\n---  \n\n### 模块加载  \n\n当我们调用`require`加载外部文件的时候，将会调用`require.resolve`函数。具体的解析规则如下：  \n\n```  \n在Y目录下的模块调用require(X)  \n- 1. 如果X是一个内建核心模块，  \n   a. 返回该模块  \n   b. 停止执行  \n\n- 2. 如果X使用`./`或者`/`或者`../`开头  \n   a. 把(Y+X)作为文件路径来加载(LOAD_AS_FILE)      \n   b. 把(Y+X)作为目录路径来加载(LOAD_AS_DIRECTORY)    \n\n- 3. 加载`node_modules(X, dirname(Y))`(LOAD_NODE_MODULES)    \n\n- 4. 抛出`not found`异常  \n\n```  \n\n**LOAD_AS_FILE(x)**  \n- A. 如果`x`是一个文件则把`x`作为`javascript`文本文件加载。  停止  \n- B. 如果`x.js`是一个文件则把`x.js`作为`javascript`文本文件加载。 停止  \n- C. 如果`x.json`是一个文件则把`x.json`作为一个`javascript`对象来解析。 停止  \n- D. 如果`x.node`是一个文件则把`x.node`作为一个二进制插件。停止  \n\n**LOAD_AS_DIRECTORY(x)**  \n- A. 如果`x/package.json`是一个文件  \n   a. 解析`package.json`读取`main`字段.  \n   b. let m = x + `main`字段值  \n   c. LOAD_AS_FILE(m)   \n- B. 如果`x/index.js`是一个文件，则把`x/index.js`作为`javascript`文本文件加载。 停止  \n- C. 如果`x/index.json`是一个文件，则把`x/index.json`作为`js`对象来解析。停止  \n- D. 如果`x/index.node`是一个文件， 则把`x/index.node`作为二进制插件加载。停止  \n\n**NODE_MODULES_PATHS(START)**  \n- 1. let PARTS = path split(START)  \n- 2. let I = count of PARTS - 1  \n- 3. let DIRS = []  \n- 4. while I >= 0,  \n   a. if PARTS[I] = \"node_modules\" CONTINUE  \n   c. DIR = path join(PARTS[0 .. I] + \"node_modules\")  \n   b. DIRS = DIRS + DIR    \n   c. let I = I - 1  \n- 5. return DIRS  \n\n---  \n\n### 模块缓存  \n模块在首次加载完毕之后会被缓存， 这意味着`require('foo.js')`不会导致`foo.js`被执行两次。 如果希望多次执行模块代码，可以导出`export`一个函数，该函数负责执行代码。  \n\n#### 模块缓存警告  \n+ 1、模块基于被解析的名字来缓存，由于同一个模块在不同目录被加载可能会得到不同的文件名，所以`require('foo')`，不能保证总是得到相同的对象。  \n\n+ 2、在一些大小写不敏感的系统，不同的文件名被系统指向同一个文件，但是缓存模块依旧认为它们是两个不同的模块，也就是说，`require('foo')`和`require('FOO')`将会得到两个不同的对象，而不考虑，`foo`和`FOO`是否是同一个文件。  \n\n---  \n\n### 核心模块  \n`Nodejs`内置几个被打成二进制形式的包。内置模块将会被优先加载，例如`require('http')`将会加载内置的`http`模块，即使有一个文件名也为`http`。  \n\n**需要注意的是：核心模块在安装的时候已经和`node`可执行程序打包到一起了。**  \n\n--- \n\n### 循环加载  \n\n考虑有这样几个模块：  \n`a.js`  \n```javascript  \nconsole.log('a starting');\nexports.done = false;\nconst b = require('./b.js');\nconsole.log('in a, b.done = %j', b.done);\nexports.done = true;\nconsole.log('a done');  \n```  \n\n`b.js`  \n```javascript\nconsole.log('b starting');\nexports.done = false;\nconst a = require('./a.js');\nconsole.log('in b, a.done = %j', a.done);\nexports.done = true;\nconsole.log('b done');\n```\n\n`main.js`\n```javascript  \nconsole.log('main starting');\nconst a = require('./a.js');\nconst b = require('./b.js');\nconsole.log('in main, a.done=%j, b.done=%j', a.done, b.done);\n```\n\n但`main.js`开始加载`a.js`而，`a.js`开始加载`b.js`，而`b.js`又开始加载`a.js`。为了阻止无限循环模块加载，一个**未加载完成的a模块**将会返回给`b.js`，接着`b.js`模块加载完毕，把`exports`对象返回给`a.js`。  \n\n于此同时`main.js`两个模块都加载完毕了，运行`main.js`输出如下： \n\n```javascript  \n$ node main.js\nmain starting\na starting\nb starting\nin b, a.done = false\nb done\nin a, b.done = true\na done\nin main, a.done=true, b.done=true\n```\n\n---  \n\n### 文件模块   \n如果指定的文件名文件不存在，那么`Node.js`将会尝试加载不同后缀名的文件主要有：(`.js`, `.json`, `.node`)。  \n`.js`后缀被解析为`js`文本文件，`.json`文件被解析文`js`对象，`.node`文件被解析为`node`插件，通过`dlopen`加载。  \n\n---  \n\n### 文件夹作为模块    \n使用文件夹是一个非常便捷的代码管理方式，提供一个统一的外部入口，供外部调用该文件夹。主要有三种方式可以达到该目的：  \n\n- 在文件夹的根目录建立一个`package.json`，使用`main`字段指定入口脚本文件，例如：  \n```javascript  \n{ \"name\" : \"some-library\",\n  \"main\" : \"./lib/some-library.js\" }\n```  \n\n在当前目录下有一个`some-library`文件夹，此时调用`require('./some-library')`将会尝试加载`./some-library/lib/some-library.js`文件。如果`main`字段指定的文件找不到，`Node.js`将会报错：  \n```\nError: Cannot find module 'some-library'\n```  \n\n如果在该文件夹下没有`package.json`,`Node.js`将会尝试加载：  \n- ./some-library/index.js  \n- ./some-library/index.json  \n- ./some-library/index.node  \n\n---  \n\n### 从`node_modules`文件夹加载  \n\n如果传递给`require`的参数既不是内置模块，模块名称也不是以`./`、`/`、`../`开头，那么`Node.js`将会尝试寻找父目录下的`node_modules`文件夹。如果没有找到就再往上面一层查找，直到退回系统根目录。  \n\n举个例子：文件`/home/ry/project/foo.js`，调用`require('bar.js')`，将会查找以下`node_modules`文件夹：  \n- `/home/ry/project/node_modules/bar.js`  \n- `/home/ry/node_modules/bar.js`     \n- `/home/node_modules/bar.js`    \n- `/node_modules/bar.js`  \n\n---  \n\n### 从全局文件夹加载模块  \n\n`NODE_PATH`环境变量被配置为用一系列冒号分隔的绝对路径，`Nodejs`将会去这些目录下寻找模块。`NODE_PATH`最初在前面的一些模块加载方法都没有出现的时候使用，现在慢慢变得没那么必要了。  \n除此之外`Node.js`还会查找以下目录：  \n- $HOME/.node_modules  \n- $HOME/.node_libraries  \n- $PREFIX/lib/node_modules  \n\n`$HOME`为当前用户的根目录，`$PREFIX`通过`node_prefix`来配置。  \n\n**基于一些历史方面的原因，建议把模块安装在本地的`node_modules`文件夹下，这一加载速度最快也最可靠。**  \n\n---  \n\n### 模块包装  \n\n在模块执行之前，`Node.js`把它包装成一个函数的形式，看起来像这样：  \n```javascript  \n(function (exports, require, module, __filename, __dirname) {\n// Your module code actually lives in here\n});  \n```  \n\n通过这种做法带来以下好处：  \n- 保证被`let`,`var`,`const`定义的变量作用域局限于模块内部，而不是全局变量。  \n- 包装了几个看起来类似于全局变量来指定该模块，例如：  \n  + `module`和`exports`变量，用于从该模块导出数据到其他模块。  \n  + `__filename`,`__dirname`,指向该模块的文件绝对路径以及文件夹路径。  \n\n---  \n\n### `module`对象  \n\n- module.children   \n一个数组指定了当前模块引用的其他模块。  \n\n- module.exports  \n一个对象，用于导出数据，如果希望导出的是一个函数，则应该给`module.exports`赋值，而不是给`exports`。否则会造成意想不到的后果。\n\n- exports\n一个对象，最初指向`module.exports`，如果你给它赋值，它将会指向对象，而不是最初的`module.exports`。  \n类似于：  \n\n```javascript  \nfunction require(...) {\n  // ...\n  ((module, exports) => {\n    // Your module code here\n    exports = some_func;        // re-assigns exports, exports is no longer\n                                // a shortcut, and nothing is exported.\n    module.exports = some_func; // makes your module export 0\n  })(module, module.exports);\n  return module;\n}\n```  \n\n- module.filename  \n模块的绝对路径名称  \n\n- module.id  \n模块`id`通常等于`module.filename`  \n\n- module.loaded  \n用于判断模块是否加载完毕，或者正在加载中。  \n\n- module.parent  \n指向首次加载本模块的模块。  \n\n- module.require(id)  \n + id: String  \n + 返回一个module.exports导出的对象。  \n\n\n  \n","slug":"nodejs-Modules-(一)","published":1,"updated":"2018-07-01T10:30:46.496Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cdu0031y4zvxpb5al10","content":"<p>  Nodejs拥有一套简单的模块加载系统，在Nodejs里面文件和模块是一一对应的关系。例如：<code>foo.js</code>加载了同一个目录下的<code>circle.js</code>文件。  </p>\n<p><code>circle.js</code>文件内容：<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> PI = <span class=\"built_in\">Math</span>.PI;  </span><br><span class=\"line\">exports.area = <span class=\"function\">(<span class=\"params\">r</span>) =&gt;</span> PI*r*r;  </span><br><span class=\"line\">exports.circumference = <span class=\"function\">(<span class=\"params\">r</span>) =&gt;</span> <span class=\"number\">2</span>*PI*r;  </span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">`</span>foo.js<span class=\"string\">`文件内容：  </span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript  </span><br><span class=\"line\"><span class=\"keyword\">const</span> circle = <span class=\"built_in\">require</span>(<span class=\"string\">'./circle.js'</span>);  </span><br><span class=\"line\"><span class=\"built_in\">console</span>.log(<span class=\"string\">`the area of radius 4 is <span class=\"subst\">$&#123;circle.area(<span class=\"number\">4</span>)&#125;</span>`</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`    </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">`</span>circle<span class=\"string\">`模块导出了`</span>area<span class=\"string\">`和`</span>circumference<span class=\"string\">`函数，为了根模块能够引用到它，你可以把它们添加到`</span>exports<span class=\"string\">`对象上。  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">**模块内部的局部变量都是私有的,  因为每个模块都被封装在一个函数内部。**上面的例中`</span>PI<span class=\"string\">`就是属于`</span>circle<span class=\"string\">`模块的局部变量。  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">**如果你希望导出一个函数或者一个对象，你应该把该函数或者对象赋值给`</span><span class=\"built_in\">module</span>.exports<span class=\"string\">`而不是`</span>exports<span class=\"string\">`**。  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">---  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">### 访问主模块  </span></span><br><span class=\"line\"><span class=\"string\">如果一个模块直接通过`</span>Node.js<span class=\"string\">`启动运行，`</span><span class=\"built_in\">require</span>.main<span class=\"string\">`将会设置为该模块。你可以通过如下方式测试当前模块是否为主模块：  </span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript  </span><br><span class=\"line\"><span class=\"built_in\">console</span>.log(<span class=\"built_in\">require</span>.main === <span class=\"built_in\">module</span>);</span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\">举个例子，对于`</span>foo.js<span class=\"string\">`文件，如果通过`</span>nodejs foo.js<span class=\"string\">`运行，那么该测试将会输出`</span><span class=\"literal\">true</span><span class=\"string\">`, 如果通过`</span><span class=\"built_in\">require</span>(<span class=\"string\">'foo.js'</span>)<span class=\"string\">`，测试将输出`</span><span class=\"literal\">false</span><span class=\"string\">`。  </span></span><br><span class=\"line\"><span class=\"string\">由于每个`</span><span class=\"built_in\">module</span><span class=\"string\">`对象都有一个`</span>filename<span class=\"string\">`属性，也可以通过`</span><span class=\"built_in\">require</span>.main.filename<span class=\"string\">`查看主模块文件名。  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">---  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">### 模块加载  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">当我们调用`</span><span class=\"built_in\">require</span><span class=\"string\">`加载外部文件的时候，将会调用`</span><span class=\"built_in\">require</span>.resolve<span class=\"string\">`函数。具体的解析规则如下：  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>  </span><br><span class=\"line\">在Y目录下的模块调用<span class=\"built_in\">require</span>(X)  </span><br><span class=\"line\">- <span class=\"number\">1.</span> 如果X是一个内建核心模块，  </span><br><span class=\"line\">   a. 返回该模块  </span><br><span class=\"line\">   b. 停止执行  </span><br><span class=\"line\"></span><br><span class=\"line\">- <span class=\"number\">2.</span> 如果X使用<span class=\"string\">`./`</span>或者<span class=\"string\">`/`</span>或者<span class=\"string\">`../`</span>开头  </span><br><span class=\"line\">   a. 把(Y+X)作为文件路径来加载(LOAD_AS_FILE)      </span><br><span class=\"line\">   b. 把(Y+X)作为目录路径来加载(LOAD_AS_DIRECTORY)    </span><br><span class=\"line\"></span><br><span class=\"line\">- <span class=\"number\">3.</span> 加载<span class=\"string\">`node_modules(X, dirname(Y))`</span>(LOAD_NODE_MODULES)    </span><br><span class=\"line\"></span><br><span class=\"line\">- <span class=\"number\">4.</span> 抛出<span class=\"string\">`not found`</span>异常  </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">**LOAD_AS_FILE(x)**  </span></span><br><span class=\"line\"><span class=\"string\">- A. 如果`</span>x<span class=\"string\">`是一个文件则把`</span>x<span class=\"string\">`作为`</span>javascript<span class=\"string\">`文本文件加载。  停止  </span></span><br><span class=\"line\"><span class=\"string\">- B. 如果`</span>x.js<span class=\"string\">`是一个文件则把`</span>x.js<span class=\"string\">`作为`</span>javascript<span class=\"string\">`文本文件加载。 停止  </span></span><br><span class=\"line\"><span class=\"string\">- C. 如果`</span>x.json<span class=\"string\">`是一个文件则把`</span>x.json<span class=\"string\">`作为一个`</span>javascript<span class=\"string\">`对象来解析。 停止  </span></span><br><span class=\"line\"><span class=\"string\">- D. 如果`</span>x.node<span class=\"string\">`是一个文件则把`</span>x.node<span class=\"string\">`作为一个二进制插件。停止  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">**LOAD_AS_DIRECTORY(x)**  </span></span><br><span class=\"line\"><span class=\"string\">- A. 如果`</span>x/package.json<span class=\"string\">`是一个文件  </span></span><br><span class=\"line\"><span class=\"string\">   a. 解析`</span>package.json<span class=\"string\">`读取`</span>main<span class=\"string\">`字段.  </span></span><br><span class=\"line\"><span class=\"string\">   b. let m = x + `</span>main<span class=\"string\">`字段值  </span></span><br><span class=\"line\"><span class=\"string\">   c. LOAD_AS_FILE(m)   </span></span><br><span class=\"line\"><span class=\"string\">- B. 如果`</span>x/index.js<span class=\"string\">`是一个文件，则把`</span>x/index.js<span class=\"string\">`作为`</span>javascript<span class=\"string\">`文本文件加载。 停止  </span></span><br><span class=\"line\"><span class=\"string\">- C. 如果`</span>x/index.json<span class=\"string\">`是一个文件，则把`</span>x/index.json<span class=\"string\">`作为`</span>js<span class=\"string\">`对象来解析。停止  </span></span><br><span class=\"line\"><span class=\"string\">- D. 如果`</span>x/index.node<span class=\"string\">`是一个文件， 则把`</span>x/index.node<span class=\"string\">`作为二进制插件加载。停止  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">**NODE_MODULES_PATHS(START)**  </span></span><br><span class=\"line\"><span class=\"string\">- 1. let PARTS = path split(START)  </span></span><br><span class=\"line\"><span class=\"string\">- 2. let I = count of PARTS - 1  </span></span><br><span class=\"line\"><span class=\"string\">- 3. let DIRS = []  </span></span><br><span class=\"line\"><span class=\"string\">- 4. while I &gt;= 0,  </span></span><br><span class=\"line\"><span class=\"string\">   a. if PARTS[I] = \"node_modules\" CONTINUE  </span></span><br><span class=\"line\"><span class=\"string\">   c. DIR = path join(PARTS[0 .. I] + \"node_modules\")  </span></span><br><span class=\"line\"><span class=\"string\">   b. DIRS = DIRS + DIR    </span></span><br><span class=\"line\"><span class=\"string\">   c. let I = I - 1  </span></span><br><span class=\"line\"><span class=\"string\">- 5. return DIRS  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">---  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">### 模块缓存  </span></span><br><span class=\"line\"><span class=\"string\">模块在首次加载完毕之后会被缓存， 这意味着`</span><span class=\"built_in\">require</span>(<span class=\"string\">'foo.js'</span>)<span class=\"string\">`不会导致`</span>foo.js<span class=\"string\">`被执行两次。 如果希望多次执行模块代码，可以导出`</span><span class=\"keyword\">export</span><span class=\"string\">`一个函数，该函数负责执行代码。  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">#### 模块缓存警告  </span></span><br><span class=\"line\"><span class=\"string\">+ 1、模块基于被解析的名字来缓存，由于同一个模块在不同目录被加载可能会得到不同的文件名，所以`</span><span class=\"built_in\">require</span>(<span class=\"string\">'foo'</span>)<span class=\"string\">`，不能保证总是得到相同的对象。  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">+ 2、在一些大小写不敏感的系统，不同的文件名被系统指向同一个文件，但是缓存模块依旧认为它们是两个不同的模块，也就是说，`</span><span class=\"built_in\">require</span>(<span class=\"string\">'foo'</span>)<span class=\"string\">`和`</span><span class=\"built_in\">require</span>(<span class=\"string\">'FOO'</span>)<span class=\"string\">`将会得到两个不同的对象，而不考虑，`</span>foo<span class=\"string\">`和`</span>FOO<span class=\"string\">`是否是同一个文件。  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">---  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">### 核心模块  </span></span><br><span class=\"line\"><span class=\"string\">`</span>Nodejs<span class=\"string\">`内置几个被打成二进制形式的包。内置模块将会被优先加载，例如`</span><span class=\"built_in\">require</span>(<span class=\"string\">'http'</span>)<span class=\"string\">`将会加载内置的`</span>http<span class=\"string\">`模块，即使有一个文件名也为`</span>http<span class=\"string\">`。  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">**需要注意的是：核心模块在安装的时候已经和`</span>node<span class=\"string\">`可执行程序打包到一起了。**  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">--- </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">### 循环加载  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">考虑有这样几个模块：  </span></span><br><span class=\"line\"><span class=\"string\">`</span>a.js<span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript  </span><br><span class=\"line\"><span class=\"built_in\">console</span>.log(<span class=\"string\">'a starting'</span>);</span><br><span class=\"line\">exports.done = <span class=\"literal\">false</span>;</span><br><span class=\"line\"><span class=\"keyword\">const</span> b = <span class=\"built_in\">require</span>(<span class=\"string\">'./b.js'</span>);</span><br><span class=\"line\"><span class=\"built_in\">console</span>.log(<span class=\"string\">'in a, b.done = %j'</span>, b.done);</span><br><span class=\"line\">exports.done = <span class=\"literal\">true</span>;</span><br><span class=\"line\"><span class=\"built_in\">console</span>.log(<span class=\"string\">'a done'</span>);  </span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">`</span>b.js<span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript</span><br><span class=\"line\"><span class=\"built_in\">console</span>.log(<span class=\"string\">'b starting'</span>);</span><br><span class=\"line\">exports.done = <span class=\"literal\">false</span>;</span><br><span class=\"line\"><span class=\"keyword\">const</span> a = <span class=\"built_in\">require</span>(<span class=\"string\">'./a.js'</span>);</span><br><span class=\"line\"><span class=\"built_in\">console</span>.log(<span class=\"string\">'in b, a.done = %j'</span>, a.done);</span><br><span class=\"line\">exports.done = <span class=\"literal\">true</span>;</span><br><span class=\"line\"><span class=\"built_in\">console</span>.log(<span class=\"string\">'b done'</span>);</span><br></pre></td></tr></table></figure></p>\n<p><code>main.js</code><br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">console</span>.log(<span class=\"string\">'main starting'</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> a = <span class=\"built_in\">require</span>(<span class=\"string\">'./a.js'</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> b = <span class=\"built_in\">require</span>(<span class=\"string\">'./b.js'</span>);</span><br><span class=\"line\"><span class=\"built_in\">console</span>.log(<span class=\"string\">'in main, a.done=%j, b.done=%j'</span>, a.done, b.done);</span><br></pre></td></tr></table></figure></p>\n<p>但<code>main.js</code>开始加载<code>a.js</code>而，<code>a.js</code>开始加载<code>b.js</code>，而<code>b.js</code>又开始加载<code>a.js</code>。为了阻止无限循环模块加载，一个<strong>未加载完成的a模块</strong>将会返回给<code>b.js</code>，接着<code>b.js</code>模块加载完毕，把<code>exports</code>对象返回给<code>a.js</code>。  </p>\n<p>于此同时<code>main.js</code>两个模块都加载完毕了，运行<code>main.js</code>输出如下： </p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ node main.js</span><br><span class=\"line\">main starting</span><br><span class=\"line\">a starting</span><br><span class=\"line\">b starting</span><br><span class=\"line\"><span class=\"keyword\">in</span> b, a.done = <span class=\"literal\">false</span></span><br><span class=\"line\">b done</span><br><span class=\"line\"><span class=\"keyword\">in</span> a, b.done = <span class=\"literal\">true</span></span><br><span class=\"line\">a done</span><br><span class=\"line\"><span class=\"keyword\">in</span> main, a.done=<span class=\"literal\">true</span>, b.done=<span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n<hr>\n<h3 id=\"文件模块\"><a href=\"#文件模块\" class=\"headerlink\" title=\"文件模块\"></a>文件模块</h3><p>如果指定的文件名文件不存在，那么<code>Node.js</code>将会尝试加载不同后缀名的文件主要有：(<code>.js</code>, <code>.json</code>, <code>.node</code>)。<br><code>.js</code>后缀被解析为<code>js</code>文本文件，<code>.json</code>文件被解析文<code>js</code>对象，<code>.node</code>文件被解析为<code>node</code>插件，通过<code>dlopen</code>加载。  </p>\n<hr>\n<h3 id=\"文件夹作为模块\"><a href=\"#文件夹作为模块\" class=\"headerlink\" title=\"文件夹作为模块\"></a>文件夹作为模块</h3><p>使用文件夹是一个非常便捷的代码管理方式，提供一个统一的外部入口，供外部调用该文件夹。主要有三种方式可以达到该目的：  </p>\n<ul>\n<li>在文件夹的根目录建立一个<code>package.json</code>，使用<code>main</code>字段指定入口脚本文件，例如：  <figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123; <span class=\"string\">\"name\"</span> : <span class=\"string\">\"some-library\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"main\"</span> : <span class=\"string\">\"./lib/some-library.js\"</span> &#125;</span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">在当前目录下有一个`</span>some-library<span class=\"string\">`文件夹，此时调用`</span><span class=\"built_in\">require</span>(<span class=\"string\">'./some-library'</span>)<span class=\"string\">`将会尝试加载`</span>./some-library/lib/some-library.js<span class=\"string\">`文件。如果`</span>main<span class=\"string\">`字段指定的文件找不到，`</span>Node.js<span class=\"string\">`将会报错：</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>Error: Cannot find module ‘some-library’</p>\n<pre><code>\n如果在该文件夹下没有`package.json`,`Node.js`将会尝试加载：  \n- ./some-library/index.js  \n- ./some-library/index.json  \n- ./some-library/index.node  \n\n---  \n\n### 从`node_modules`文件夹加载  \n\n如果传递给`require`的参数既不是内置模块，模块名称也不是以`./`、`/`、`../`开头，那么`Node.js`将会尝试寻找父目录下的`node_modules`文件夹。如果没有找到就再往上面一层查找，直到退回系统根目录。  \n\n举个例子：文件`/home/ry/project/foo.js`，调用`require(&apos;bar.js&apos;)`，将会查找以下`node_modules`文件夹：  \n- `/home/ry/project/node_modules/bar.js`  \n- `/home/ry/node_modules/bar.js`     \n- `/home/node_modules/bar.js`    \n- `/node_modules/bar.js`  \n\n---  \n\n### 从全局文件夹加载模块  \n\n`NODE_PATH`环境变量被配置为用一系列冒号分隔的绝对路径，`Nodejs`将会去这些目录下寻找模块。`NODE_PATH`最初在前面的一些模块加载方法都没有出现的时候使用，现在慢慢变得没那么必要了。  \n除此之外`Node.js`还会查找以下目录：  \n- $HOME/.node_modules  \n- $HOME/.node_libraries  \n- $PREFIX/lib/node_modules  \n\n`$HOME`为当前用户的根目录，`$PREFIX`通过`node_prefix`来配置。  \n\n**基于一些历史方面的原因，建议把模块安装在本地的`node_modules`文件夹下，这一加载速度最快也最可靠。**  \n\n---  \n\n### 模块包装  \n\n在模块执行之前，`Node.js`把它包装成一个函数的形式，看起来像这样：  \n```javascript  \n(function (exports, require, module, __filename, __dirname) {\n// Your module code actually lives in here\n});  \n</code></pre><p>通过这种做法带来以下好处：  </p>\n<ul>\n<li>保证被<code>let</code>,<code>var</code>,<code>const</code>定义的变量作用域局限于模块内部，而不是全局变量。  </li>\n<li>包装了几个看起来类似于全局变量来指定该模块，例如：  <ul>\n<li><code>module</code>和<code>exports</code>变量，用于从该模块导出数据到其他模块。  </li>\n<li><code>__filename</code>,<code>__dirname</code>,指向该模块的文件绝对路径以及文件夹路径。  </li>\n</ul>\n</li>\n</ul>\n<hr>\n<h3 id=\"module对象\"><a href=\"#module对象\" class=\"headerlink\" title=\"module对象\"></a><code>module</code>对象</h3><ul>\n<li><p>module.children<br>一个数组指定了当前模块引用的其他模块。  </p>\n</li>\n<li><p>module.exports<br>一个对象，用于导出数据，如果希望导出的是一个函数，则应该给<code>module.exports</code>赋值，而不是给<code>exports</code>。否则会造成意想不到的后果。</p>\n</li>\n<li><p>exports<br>一个对象，最初指向<code>module.exports</code>，如果你给它赋值，它将会指向对象，而不是最初的<code>module.exports</code>。<br>类似于：  </p>\n</li>\n</ul>\n<pre><code class=\"javascript\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">require</span>(<span class=\"params\">...</span>) </span>{\n  <span class=\"comment\">// ...</span>\n  (<span class=\"function\">(<span class=\"params\"><span class=\"built_in\">module</span>, exports</span>) =&gt;</span> {\n    <span class=\"comment\">// Your module code here</span>\n    exports = some_func;        <span class=\"comment\">// re-assigns exports, exports is no longer</span>\n                                <span class=\"comment\">// a shortcut, and nothing is exported.</span>\n    <span class=\"built_in\">module</span>.exports = some_func; <span class=\"comment\">// makes your module export 0</span>\n  })(<span class=\"built_in\">module</span>, <span class=\"built_in\">module</span>.exports);\n  <span class=\"keyword\">return</span> <span class=\"built_in\">module</span>;\n}\n</code></pre>\n<ul>\n<li><p>module.filename<br>模块的绝对路径名称  </p>\n</li>\n<li><p>module.id<br>模块<code>id</code>通常等于<code>module.filename</code>  </p>\n</li>\n<li><p>module.loaded<br>用于判断模块是否加载完毕，或者正在加载中。  </p>\n</li>\n<li><p>module.parent<br>指向首次加载本模块的模块。  </p>\n</li>\n<li><p>module.require(id)  </p>\n<ul>\n<li>id: String  </li>\n<li>返回一个module.exports导出的对象。  </li>\n</ul>\n</li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<p>  Nodejs拥有一套简单的模块加载系统，在Nodejs里面文件和模块是一一对应的关系。例如：<code>foo.js</code>加载了同一个目录下的<code>circle.js</code>文件。  </p>\n<p><code>circle.js</code>文件内容：<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> PI = <span class=\"built_in\">Math</span>.PI;  </span><br><span class=\"line\">exports.area = <span class=\"function\">(<span class=\"params\">r</span>) =&gt;</span> PI*r*r;  </span><br><span class=\"line\">exports.circumference = <span class=\"function\">(<span class=\"params\">r</span>) =&gt;</span> <span class=\"number\">2</span>*PI*r;  </span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">`</span>foo.js<span class=\"string\">`文件内容：  </span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript  </span><br><span class=\"line\"><span class=\"keyword\">const</span> circle = <span class=\"built_in\">require</span>(<span class=\"string\">'./circle.js'</span>);  </span><br><span class=\"line\"><span class=\"built_in\">console</span>.log(<span class=\"string\">`the area of radius 4 is <span class=\"subst\">$&#123;circle.area(<span class=\"number\">4</span>)&#125;</span>`</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`    </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">`</span>circle<span class=\"string\">`模块导出了`</span>area<span class=\"string\">`和`</span>circumference<span class=\"string\">`函数，为了根模块能够引用到它，你可以把它们添加到`</span>exports<span class=\"string\">`对象上。  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">**模块内部的局部变量都是私有的,  因为每个模块都被封装在一个函数内部。**上面的例中`</span>PI<span class=\"string\">`就是属于`</span>circle<span class=\"string\">`模块的局部变量。  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">**如果你希望导出一个函数或者一个对象，你应该把该函数或者对象赋值给`</span><span class=\"built_in\">module</span>.exports<span class=\"string\">`而不是`</span>exports<span class=\"string\">`**。  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">---  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">### 访问主模块  </span></span><br><span class=\"line\"><span class=\"string\">如果一个模块直接通过`</span>Node.js<span class=\"string\">`启动运行，`</span><span class=\"built_in\">require</span>.main<span class=\"string\">`将会设置为该模块。你可以通过如下方式测试当前模块是否为主模块：  </span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript  </span><br><span class=\"line\"><span class=\"built_in\">console</span>.log(<span class=\"built_in\">require</span>.main === <span class=\"built_in\">module</span>);</span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\">举个例子，对于`</span>foo.js<span class=\"string\">`文件，如果通过`</span>nodejs foo.js<span class=\"string\">`运行，那么该测试将会输出`</span><span class=\"literal\">true</span><span class=\"string\">`, 如果通过`</span><span class=\"built_in\">require</span>(<span class=\"string\">'foo.js'</span>)<span class=\"string\">`，测试将输出`</span><span class=\"literal\">false</span><span class=\"string\">`。  </span></span><br><span class=\"line\"><span class=\"string\">由于每个`</span><span class=\"built_in\">module</span><span class=\"string\">`对象都有一个`</span>filename<span class=\"string\">`属性，也可以通过`</span><span class=\"built_in\">require</span>.main.filename<span class=\"string\">`查看主模块文件名。  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">---  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">### 模块加载  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">当我们调用`</span><span class=\"built_in\">require</span><span class=\"string\">`加载外部文件的时候，将会调用`</span><span class=\"built_in\">require</span>.resolve<span class=\"string\">`函数。具体的解析规则如下：  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>  </span><br><span class=\"line\">在Y目录下的模块调用<span class=\"built_in\">require</span>(X)  </span><br><span class=\"line\">- <span class=\"number\">1.</span> 如果X是一个内建核心模块，  </span><br><span class=\"line\">   a. 返回该模块  </span><br><span class=\"line\">   b. 停止执行  </span><br><span class=\"line\"></span><br><span class=\"line\">- <span class=\"number\">2.</span> 如果X使用<span class=\"string\">`./`</span>或者<span class=\"string\">`/`</span>或者<span class=\"string\">`../`</span>开头  </span><br><span class=\"line\">   a. 把(Y+X)作为文件路径来加载(LOAD_AS_FILE)      </span><br><span class=\"line\">   b. 把(Y+X)作为目录路径来加载(LOAD_AS_DIRECTORY)    </span><br><span class=\"line\"></span><br><span class=\"line\">- <span class=\"number\">3.</span> 加载<span class=\"string\">`node_modules(X, dirname(Y))`</span>(LOAD_NODE_MODULES)    </span><br><span class=\"line\"></span><br><span class=\"line\">- <span class=\"number\">4.</span> 抛出<span class=\"string\">`not found`</span>异常  </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">**LOAD_AS_FILE(x)**  </span></span><br><span class=\"line\"><span class=\"string\">- A. 如果`</span>x<span class=\"string\">`是一个文件则把`</span>x<span class=\"string\">`作为`</span>javascript<span class=\"string\">`文本文件加载。  停止  </span></span><br><span class=\"line\"><span class=\"string\">- B. 如果`</span>x.js<span class=\"string\">`是一个文件则把`</span>x.js<span class=\"string\">`作为`</span>javascript<span class=\"string\">`文本文件加载。 停止  </span></span><br><span class=\"line\"><span class=\"string\">- C. 如果`</span>x.json<span class=\"string\">`是一个文件则把`</span>x.json<span class=\"string\">`作为一个`</span>javascript<span class=\"string\">`对象来解析。 停止  </span></span><br><span class=\"line\"><span class=\"string\">- D. 如果`</span>x.node<span class=\"string\">`是一个文件则把`</span>x.node<span class=\"string\">`作为一个二进制插件。停止  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">**LOAD_AS_DIRECTORY(x)**  </span></span><br><span class=\"line\"><span class=\"string\">- A. 如果`</span>x/package.json<span class=\"string\">`是一个文件  </span></span><br><span class=\"line\"><span class=\"string\">   a. 解析`</span>package.json<span class=\"string\">`读取`</span>main<span class=\"string\">`字段.  </span></span><br><span class=\"line\"><span class=\"string\">   b. let m = x + `</span>main<span class=\"string\">`字段值  </span></span><br><span class=\"line\"><span class=\"string\">   c. LOAD_AS_FILE(m)   </span></span><br><span class=\"line\"><span class=\"string\">- B. 如果`</span>x/index.js<span class=\"string\">`是一个文件，则把`</span>x/index.js<span class=\"string\">`作为`</span>javascript<span class=\"string\">`文本文件加载。 停止  </span></span><br><span class=\"line\"><span class=\"string\">- C. 如果`</span>x/index.json<span class=\"string\">`是一个文件，则把`</span>x/index.json<span class=\"string\">`作为`</span>js<span class=\"string\">`对象来解析。停止  </span></span><br><span class=\"line\"><span class=\"string\">- D. 如果`</span>x/index.node<span class=\"string\">`是一个文件， 则把`</span>x/index.node<span class=\"string\">`作为二进制插件加载。停止  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">**NODE_MODULES_PATHS(START)**  </span></span><br><span class=\"line\"><span class=\"string\">- 1. let PARTS = path split(START)  </span></span><br><span class=\"line\"><span class=\"string\">- 2. let I = count of PARTS - 1  </span></span><br><span class=\"line\"><span class=\"string\">- 3. let DIRS = []  </span></span><br><span class=\"line\"><span class=\"string\">- 4. while I &gt;= 0,  </span></span><br><span class=\"line\"><span class=\"string\">   a. if PARTS[I] = \"node_modules\" CONTINUE  </span></span><br><span class=\"line\"><span class=\"string\">   c. DIR = path join(PARTS[0 .. I] + \"node_modules\")  </span></span><br><span class=\"line\"><span class=\"string\">   b. DIRS = DIRS + DIR    </span></span><br><span class=\"line\"><span class=\"string\">   c. let I = I - 1  </span></span><br><span class=\"line\"><span class=\"string\">- 5. return DIRS  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">---  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">### 模块缓存  </span></span><br><span class=\"line\"><span class=\"string\">模块在首次加载完毕之后会被缓存， 这意味着`</span><span class=\"built_in\">require</span>(<span class=\"string\">'foo.js'</span>)<span class=\"string\">`不会导致`</span>foo.js<span class=\"string\">`被执行两次。 如果希望多次执行模块代码，可以导出`</span><span class=\"keyword\">export</span><span class=\"string\">`一个函数，该函数负责执行代码。  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">#### 模块缓存警告  </span></span><br><span class=\"line\"><span class=\"string\">+ 1、模块基于被解析的名字来缓存，由于同一个模块在不同目录被加载可能会得到不同的文件名，所以`</span><span class=\"built_in\">require</span>(<span class=\"string\">'foo'</span>)<span class=\"string\">`，不能保证总是得到相同的对象。  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">+ 2、在一些大小写不敏感的系统，不同的文件名被系统指向同一个文件，但是缓存模块依旧认为它们是两个不同的模块，也就是说，`</span><span class=\"built_in\">require</span>(<span class=\"string\">'foo'</span>)<span class=\"string\">`和`</span><span class=\"built_in\">require</span>(<span class=\"string\">'FOO'</span>)<span class=\"string\">`将会得到两个不同的对象，而不考虑，`</span>foo<span class=\"string\">`和`</span>FOO<span class=\"string\">`是否是同一个文件。  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">---  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">### 核心模块  </span></span><br><span class=\"line\"><span class=\"string\">`</span>Nodejs<span class=\"string\">`内置几个被打成二进制形式的包。内置模块将会被优先加载，例如`</span><span class=\"built_in\">require</span>(<span class=\"string\">'http'</span>)<span class=\"string\">`将会加载内置的`</span>http<span class=\"string\">`模块，即使有一个文件名也为`</span>http<span class=\"string\">`。  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">**需要注意的是：核心模块在安装的时候已经和`</span>node<span class=\"string\">`可执行程序打包到一起了。**  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">--- </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">### 循环加载  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">考虑有这样几个模块：  </span></span><br><span class=\"line\"><span class=\"string\">`</span>a.js<span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript  </span><br><span class=\"line\"><span class=\"built_in\">console</span>.log(<span class=\"string\">'a starting'</span>);</span><br><span class=\"line\">exports.done = <span class=\"literal\">false</span>;</span><br><span class=\"line\"><span class=\"keyword\">const</span> b = <span class=\"built_in\">require</span>(<span class=\"string\">'./b.js'</span>);</span><br><span class=\"line\"><span class=\"built_in\">console</span>.log(<span class=\"string\">'in a, b.done = %j'</span>, b.done);</span><br><span class=\"line\">exports.done = <span class=\"literal\">true</span>;</span><br><span class=\"line\"><span class=\"built_in\">console</span>.log(<span class=\"string\">'a done'</span>);  </span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">`</span>b.js<span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript</span><br><span class=\"line\"><span class=\"built_in\">console</span>.log(<span class=\"string\">'b starting'</span>);</span><br><span class=\"line\">exports.done = <span class=\"literal\">false</span>;</span><br><span class=\"line\"><span class=\"keyword\">const</span> a = <span class=\"built_in\">require</span>(<span class=\"string\">'./a.js'</span>);</span><br><span class=\"line\"><span class=\"built_in\">console</span>.log(<span class=\"string\">'in b, a.done = %j'</span>, a.done);</span><br><span class=\"line\">exports.done = <span class=\"literal\">true</span>;</span><br><span class=\"line\"><span class=\"built_in\">console</span>.log(<span class=\"string\">'b done'</span>);</span><br></pre></td></tr></table></figure></p>\n<p><code>main.js</code><br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">console</span>.log(<span class=\"string\">'main starting'</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> a = <span class=\"built_in\">require</span>(<span class=\"string\">'./a.js'</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> b = <span class=\"built_in\">require</span>(<span class=\"string\">'./b.js'</span>);</span><br><span class=\"line\"><span class=\"built_in\">console</span>.log(<span class=\"string\">'in main, a.done=%j, b.done=%j'</span>, a.done, b.done);</span><br></pre></td></tr></table></figure></p>\n<p>但<code>main.js</code>开始加载<code>a.js</code>而，<code>a.js</code>开始加载<code>b.js</code>，而<code>b.js</code>又开始加载<code>a.js</code>。为了阻止无限循环模块加载，一个<strong>未加载完成的a模块</strong>将会返回给<code>b.js</code>，接着<code>b.js</code>模块加载完毕，把<code>exports</code>对象返回给<code>a.js</code>。  </p>\n<p>于此同时<code>main.js</code>两个模块都加载完毕了，运行<code>main.js</code>输出如下： </p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ node main.js</span><br><span class=\"line\">main starting</span><br><span class=\"line\">a starting</span><br><span class=\"line\">b starting</span><br><span class=\"line\"><span class=\"keyword\">in</span> b, a.done = <span class=\"literal\">false</span></span><br><span class=\"line\">b done</span><br><span class=\"line\"><span class=\"keyword\">in</span> a, b.done = <span class=\"literal\">true</span></span><br><span class=\"line\">a done</span><br><span class=\"line\"><span class=\"keyword\">in</span> main, a.done=<span class=\"literal\">true</span>, b.done=<span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n<hr>\n<h3 id=\"文件模块\"><a href=\"#文件模块\" class=\"headerlink\" title=\"文件模块\"></a>文件模块</h3><p>如果指定的文件名文件不存在，那么<code>Node.js</code>将会尝试加载不同后缀名的文件主要有：(<code>.js</code>, <code>.json</code>, <code>.node</code>)。<br><code>.js</code>后缀被解析为<code>js</code>文本文件，<code>.json</code>文件被解析文<code>js</code>对象，<code>.node</code>文件被解析为<code>node</code>插件，通过<code>dlopen</code>加载。  </p>\n<hr>\n<h3 id=\"文件夹作为模块\"><a href=\"#文件夹作为模块\" class=\"headerlink\" title=\"文件夹作为模块\"></a>文件夹作为模块</h3><p>使用文件夹是一个非常便捷的代码管理方式，提供一个统一的外部入口，供外部调用该文件夹。主要有三种方式可以达到该目的：  </p>\n<ul>\n<li>在文件夹的根目录建立一个<code>package.json</code>，使用<code>main</code>字段指定入口脚本文件，例如：  <figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123; <span class=\"string\">\"name\"</span> : <span class=\"string\">\"some-library\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"main\"</span> : <span class=\"string\">\"./lib/some-library.js\"</span> &#125;</span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">在当前目录下有一个`</span>some-library<span class=\"string\">`文件夹，此时调用`</span><span class=\"built_in\">require</span>(<span class=\"string\">'./some-library'</span>)<span class=\"string\">`将会尝试加载`</span>./some-library/lib/some-library.js<span class=\"string\">`文件。如果`</span>main<span class=\"string\">`字段指定的文件找不到，`</span>Node.js<span class=\"string\">`将会报错：</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>Error: Cannot find module ‘some-library’</p>\n<pre><code>\n如果在该文件夹下没有`package.json`,`Node.js`将会尝试加载：  \n- ./some-library/index.js  \n- ./some-library/index.json  \n- ./some-library/index.node  \n\n---  \n\n### 从`node_modules`文件夹加载  \n\n如果传递给`require`的参数既不是内置模块，模块名称也不是以`./`、`/`、`../`开头，那么`Node.js`将会尝试寻找父目录下的`node_modules`文件夹。如果没有找到就再往上面一层查找，直到退回系统根目录。  \n\n举个例子：文件`/home/ry/project/foo.js`，调用`require(&apos;bar.js&apos;)`，将会查找以下`node_modules`文件夹：  \n- `/home/ry/project/node_modules/bar.js`  \n- `/home/ry/node_modules/bar.js`     \n- `/home/node_modules/bar.js`    \n- `/node_modules/bar.js`  \n\n---  \n\n### 从全局文件夹加载模块  \n\n`NODE_PATH`环境变量被配置为用一系列冒号分隔的绝对路径，`Nodejs`将会去这些目录下寻找模块。`NODE_PATH`最初在前面的一些模块加载方法都没有出现的时候使用，现在慢慢变得没那么必要了。  \n除此之外`Node.js`还会查找以下目录：  \n- $HOME/.node_modules  \n- $HOME/.node_libraries  \n- $PREFIX/lib/node_modules  \n\n`$HOME`为当前用户的根目录，`$PREFIX`通过`node_prefix`来配置。  \n\n**基于一些历史方面的原因，建议把模块安装在本地的`node_modules`文件夹下，这一加载速度最快也最可靠。**  \n\n---  \n\n### 模块包装  \n\n在模块执行之前，`Node.js`把它包装成一个函数的形式，看起来像这样：  \n```javascript  \n(function (exports, require, module, __filename, __dirname) {\n// Your module code actually lives in here\n});  \n</code></pre><p>通过这种做法带来以下好处：  </p>\n<ul>\n<li>保证被<code>let</code>,<code>var</code>,<code>const</code>定义的变量作用域局限于模块内部，而不是全局变量。  </li>\n<li>包装了几个看起来类似于全局变量来指定该模块，例如：  <ul>\n<li><code>module</code>和<code>exports</code>变量，用于从该模块导出数据到其他模块。  </li>\n<li><code>__filename</code>,<code>__dirname</code>,指向该模块的文件绝对路径以及文件夹路径。  </li>\n</ul>\n</li>\n</ul>\n<hr>\n<h3 id=\"module对象\"><a href=\"#module对象\" class=\"headerlink\" title=\"module对象\"></a><code>module</code>对象</h3><ul>\n<li><p>module.children<br>一个数组指定了当前模块引用的其他模块。  </p>\n</li>\n<li><p>module.exports<br>一个对象，用于导出数据，如果希望导出的是一个函数，则应该给<code>module.exports</code>赋值，而不是给<code>exports</code>。否则会造成意想不到的后果。</p>\n</li>\n<li><p>exports<br>一个对象，最初指向<code>module.exports</code>，如果你给它赋值，它将会指向对象，而不是最初的<code>module.exports</code>。<br>类似于：  </p>\n</li>\n</ul>\n<pre><code class=\"javascript\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">require</span>(<span class=\"params\">...</span>) </span>{\n  <span class=\"comment\">// ...</span>\n  (<span class=\"function\">(<span class=\"params\"><span class=\"built_in\">module</span>, exports</span>) =&gt;</span> {\n    <span class=\"comment\">// Your module code here</span>\n    exports = some_func;        <span class=\"comment\">// re-assigns exports, exports is no longer</span>\n                                <span class=\"comment\">// a shortcut, and nothing is exported.</span>\n    <span class=\"built_in\">module</span>.exports = some_func; <span class=\"comment\">// makes your module export 0</span>\n  })(<span class=\"built_in\">module</span>, <span class=\"built_in\">module</span>.exports);\n  <span class=\"keyword\">return</span> <span class=\"built_in\">module</span>;\n}\n</code></pre>\n<ul>\n<li><p>module.filename<br>模块的绝对路径名称  </p>\n</li>\n<li><p>module.id<br>模块<code>id</code>通常等于<code>module.filename</code>  </p>\n</li>\n<li><p>module.loaded<br>用于判断模块是否加载完毕，或者正在加载中。  </p>\n</li>\n<li><p>module.parent<br>指向首次加载本模块的模块。  </p>\n</li>\n<li><p>module.require(id)  </p>\n<ul>\n<li>id: String  </li>\n<li>返回一个module.exports导出的对象。  </li>\n</ul>\n</li>\n</ul>\n"},{"title":"重读refactoring","date":"2018-05-09T13:08:41.000Z","keywords":["重构","refactoring"],"_content":"\n记得刚毕业那年，在网络上寻找各种经典的计算机软件工程相关书籍来阅读，其中就包含了`martin fowler`的`refactoring`这本书。毫无项目经验的我，对书中列举的各种重构方案如: `extract method`、`pull up method`等不以为然，一方面觉得这些点都太小了，简单的移动字段，提取函数真的有那么大的效用么？这当时在我心里是一个大大的问号。另一方面在我心里一直对重构有一种偏见，总觉得它是一种对软件架构设计缺陷的补丁方案，为什么当初在设计之初没有考虑好呢？这种打补丁的方案真的好吗？\n\n最近重新阅读了这本书，五年来经历了大大小小多个项目，深刻体会到重构带来的价值。重构这种中庸之道，在不推翻所有代码的前提下，能够保证项目的正常交付，同时防止的代码的腐烂，这或许是最佳的工程实践方案了。\n\n## 一、为什么需要重构\n\n### 1、需求变更\n\n软件开发领域切实的印证了那句话，`不变的或许就是变化本身`。程序员再项目开发的时候应该尽可能的洞悉项目未来的业务发展方向。但是，这也仅仅是一种可能。企业为了生存，需要不断的调整方向，来追求利益的最大化。需求变更或许是软件需要重构的最大原因。\n\n\n### 2、人无完人\n\n人无完人，我们不可能在项目开发初期就把架构设计的天衣无缝。或许某一天学习到了某个好的模式，希望把它运用到项目中，这个时候我们就需要重构了。也许因为项目开发周期短，一些模块不得不采用当下最快的方式来实现，等到未来某一天希望把实现方式通过重构变更一下。\n\n## 二、准备工作\n\n`重构`书本上列举了一系列需要重构的预判条件，这些统一称之为“坏味道”。其中包含，如：\"函数过长\"、“函数参数过长”、\"注释过多\"、\"类职责不单一\"等等。再遇到这些情况的适合，我们就需要仔细的审视是不是该重构了。\n\n嗅出这些坏味道只是第一步，正如`重构`的序言四人帮之一`Erich Gamma`说的那样：`设计模式`是实现重构的手段，所以在执行重构之前需要对常用的软件开发模式方法有一定的了解。\n\n`重构`的定义：**在不改变软件外在行为的前提下，改善软件内部结构。**`重构`书中着重说明了测试的重要性，测试直接关系到重构的成败。没有测试作为保障的前提下进行重构那将会是一场灾难。对于动态语言更是如此，没有编译期的保障下，任何一点修正都无法及时发现。\n\n## 三、常用原则\n\n有了一定项目经验再回过头来看书中列举的各种重构案例，惊讶的发现，这不就是我一直在用的手段吗？原来我一直窃喜的开发方法早就有人总结并且广为流传了。其中最印象深刻的莫过于`Form Template Method`以及`Replace Conditional with Polymorphism`。`Form Template Method`需要对设计模式中的模版方法有一定的理解，反过来说，如果理解了模版方法会更加容易的发现它的适用场景。对于`Replace Conditional with Polymorphism`方案，不同的条件判断意味着不同的类别，在面向对象的大环境下很容易想到每个类别代替不同的子类。而不同的子类有不同的行为这刚好印证了面向对象编程最重要的特性：多态。\n\n## 四、总结\n\n软件开发更像是一门艺术，软件产品就是一个艺术品，需要不断的细心雕琢。非常赞同人月神话作者的那句话: \"软件开发最大的复杂度来自于变化。\"所以隔离变化，降低复杂度将会是软件开发永恒的主题。","source":"_posts/refactoring.md","raw":"---\ntitle: 重读refactoring\ndate: 2018-05-09 21:08:41\ntags: 重构\nkeywords: \n  - 重构\n  - refactoring\ncategories: 软件开发\n---\n\n记得刚毕业那年，在网络上寻找各种经典的计算机软件工程相关书籍来阅读，其中就包含了`martin fowler`的`refactoring`这本书。毫无项目经验的我，对书中列举的各种重构方案如: `extract method`、`pull up method`等不以为然，一方面觉得这些点都太小了，简单的移动字段，提取函数真的有那么大的效用么？这当时在我心里是一个大大的问号。另一方面在我心里一直对重构有一种偏见，总觉得它是一种对软件架构设计缺陷的补丁方案，为什么当初在设计之初没有考虑好呢？这种打补丁的方案真的好吗？\n\n最近重新阅读了这本书，五年来经历了大大小小多个项目，深刻体会到重构带来的价值。重构这种中庸之道，在不推翻所有代码的前提下，能够保证项目的正常交付，同时防止的代码的腐烂，这或许是最佳的工程实践方案了。\n\n## 一、为什么需要重构\n\n### 1、需求变更\n\n软件开发领域切实的印证了那句话，`不变的或许就是变化本身`。程序员再项目开发的时候应该尽可能的洞悉项目未来的业务发展方向。但是，这也仅仅是一种可能。企业为了生存，需要不断的调整方向，来追求利益的最大化。需求变更或许是软件需要重构的最大原因。\n\n\n### 2、人无完人\n\n人无完人，我们不可能在项目开发初期就把架构设计的天衣无缝。或许某一天学习到了某个好的模式，希望把它运用到项目中，这个时候我们就需要重构了。也许因为项目开发周期短，一些模块不得不采用当下最快的方式来实现，等到未来某一天希望把实现方式通过重构变更一下。\n\n## 二、准备工作\n\n`重构`书本上列举了一系列需要重构的预判条件，这些统一称之为“坏味道”。其中包含，如：\"函数过长\"、“函数参数过长”、\"注释过多\"、\"类职责不单一\"等等。再遇到这些情况的适合，我们就需要仔细的审视是不是该重构了。\n\n嗅出这些坏味道只是第一步，正如`重构`的序言四人帮之一`Erich Gamma`说的那样：`设计模式`是实现重构的手段，所以在执行重构之前需要对常用的软件开发模式方法有一定的了解。\n\n`重构`的定义：**在不改变软件外在行为的前提下，改善软件内部结构。**`重构`书中着重说明了测试的重要性，测试直接关系到重构的成败。没有测试作为保障的前提下进行重构那将会是一场灾难。对于动态语言更是如此，没有编译期的保障下，任何一点修正都无法及时发现。\n\n## 三、常用原则\n\n有了一定项目经验再回过头来看书中列举的各种重构案例，惊讶的发现，这不就是我一直在用的手段吗？原来我一直窃喜的开发方法早就有人总结并且广为流传了。其中最印象深刻的莫过于`Form Template Method`以及`Replace Conditional with Polymorphism`。`Form Template Method`需要对设计模式中的模版方法有一定的理解，反过来说，如果理解了模版方法会更加容易的发现它的适用场景。对于`Replace Conditional with Polymorphism`方案，不同的条件判断意味着不同的类别，在面向对象的大环境下很容易想到每个类别代替不同的子类。而不同的子类有不同的行为这刚好印证了面向对象编程最重要的特性：多态。\n\n## 四、总结\n\n软件开发更像是一门艺术，软件产品就是一个艺术品，需要不断的细心雕琢。非常赞同人月神话作者的那句话: \"软件开发最大的复杂度来自于变化。\"所以隔离变化，降低复杂度将会是软件开发永恒的主题。","slug":"refactoring","published":1,"updated":"2018-07-01T10:30:46.496Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cdv0033y4zvkh7bmizb","content":"<p>记得刚毕业那年，在网络上寻找各种经典的计算机软件工程相关书籍来阅读，其中就包含了<code>martin fowler</code>的<code>refactoring</code>这本书。毫无项目经验的我，对书中列举的各种重构方案如: <code>extract method</code>、<code>pull up method</code>等不以为然，一方面觉得这些点都太小了，简单的移动字段，提取函数真的有那么大的效用么？这当时在我心里是一个大大的问号。另一方面在我心里一直对重构有一种偏见，总觉得它是一种对软件架构设计缺陷的补丁方案，为什么当初在设计之初没有考虑好呢？这种打补丁的方案真的好吗？</p>\n<p>最近重新阅读了这本书，五年来经历了大大小小多个项目，深刻体会到重构带来的价值。重构这种中庸之道，在不推翻所有代码的前提下，能够保证项目的正常交付，同时防止的代码的腐烂，这或许是最佳的工程实践方案了。</p>\n<h2 id=\"一、为什么需要重构\"><a href=\"#一、为什么需要重构\" class=\"headerlink\" title=\"一、为什么需要重构\"></a>一、为什么需要重构</h2><h3 id=\"1、需求变更\"><a href=\"#1、需求变更\" class=\"headerlink\" title=\"1、需求变更\"></a>1、需求变更</h3><p>软件开发领域切实的印证了那句话，<code>不变的或许就是变化本身</code>。程序员再项目开发的时候应该尽可能的洞悉项目未来的业务发展方向。但是，这也仅仅是一种可能。企业为了生存，需要不断的调整方向，来追求利益的最大化。需求变更或许是软件需要重构的最大原因。</p>\n<h3 id=\"2、人无完人\"><a href=\"#2、人无完人\" class=\"headerlink\" title=\"2、人无完人\"></a>2、人无完人</h3><p>人无完人，我们不可能在项目开发初期就把架构设计的天衣无缝。或许某一天学习到了某个好的模式，希望把它运用到项目中，这个时候我们就需要重构了。也许因为项目开发周期短，一些模块不得不采用当下最快的方式来实现，等到未来某一天希望把实现方式通过重构变更一下。</p>\n<h2 id=\"二、准备工作\"><a href=\"#二、准备工作\" class=\"headerlink\" title=\"二、准备工作\"></a>二、准备工作</h2><p><code>重构</code>书本上列举了一系列需要重构的预判条件，这些统一称之为“坏味道”。其中包含，如：”函数过长”、“函数参数过长”、”注释过多”、”类职责不单一”等等。再遇到这些情况的适合，我们就需要仔细的审视是不是该重构了。</p>\n<p>嗅出这些坏味道只是第一步，正如<code>重构</code>的序言四人帮之一<code>Erich Gamma</code>说的那样：<code>设计模式</code>是实现重构的手段，所以在执行重构之前需要对常用的软件开发模式方法有一定的了解。</p>\n<p><code>重构</code>的定义：<strong>在不改变软件外在行为的前提下，改善软件内部结构。</strong><code>重构</code>书中着重说明了测试的重要性，测试直接关系到重构的成败。没有测试作为保障的前提下进行重构那将会是一场灾难。对于动态语言更是如此，没有编译期的保障下，任何一点修正都无法及时发现。</p>\n<h2 id=\"三、常用原则\"><a href=\"#三、常用原则\" class=\"headerlink\" title=\"三、常用原则\"></a>三、常用原则</h2><p>有了一定项目经验再回过头来看书中列举的各种重构案例，惊讶的发现，这不就是我一直在用的手段吗？原来我一直窃喜的开发方法早就有人总结并且广为流传了。其中最印象深刻的莫过于<code>Form Template Method</code>以及<code>Replace Conditional with Polymorphism</code>。<code>Form Template Method</code>需要对设计模式中的模版方法有一定的理解，反过来说，如果理解了模版方法会更加容易的发现它的适用场景。对于<code>Replace Conditional with Polymorphism</code>方案，不同的条件判断意味着不同的类别，在面向对象的大环境下很容易想到每个类别代替不同的子类。而不同的子类有不同的行为这刚好印证了面向对象编程最重要的特性：多态。</p>\n<h2 id=\"四、总结\"><a href=\"#四、总结\" class=\"headerlink\" title=\"四、总结\"></a>四、总结</h2><p>软件开发更像是一门艺术，软件产品就是一个艺术品，需要不断的细心雕琢。非常赞同人月神话作者的那句话: “软件开发最大的复杂度来自于变化。”所以隔离变化，降低复杂度将会是软件开发永恒的主题。</p>\n","site":{"data":{}},"excerpt":"","more":"<p>记得刚毕业那年，在网络上寻找各种经典的计算机软件工程相关书籍来阅读，其中就包含了<code>martin fowler</code>的<code>refactoring</code>这本书。毫无项目经验的我，对书中列举的各种重构方案如: <code>extract method</code>、<code>pull up method</code>等不以为然，一方面觉得这些点都太小了，简单的移动字段，提取函数真的有那么大的效用么？这当时在我心里是一个大大的问号。另一方面在我心里一直对重构有一种偏见，总觉得它是一种对软件架构设计缺陷的补丁方案，为什么当初在设计之初没有考虑好呢？这种打补丁的方案真的好吗？</p>\n<p>最近重新阅读了这本书，五年来经历了大大小小多个项目，深刻体会到重构带来的价值。重构这种中庸之道，在不推翻所有代码的前提下，能够保证项目的正常交付，同时防止的代码的腐烂，这或许是最佳的工程实践方案了。</p>\n<h2 id=\"一、为什么需要重构\"><a href=\"#一、为什么需要重构\" class=\"headerlink\" title=\"一、为什么需要重构\"></a>一、为什么需要重构</h2><h3 id=\"1、需求变更\"><a href=\"#1、需求变更\" class=\"headerlink\" title=\"1、需求变更\"></a>1、需求变更</h3><p>软件开发领域切实的印证了那句话，<code>不变的或许就是变化本身</code>。程序员再项目开发的时候应该尽可能的洞悉项目未来的业务发展方向。但是，这也仅仅是一种可能。企业为了生存，需要不断的调整方向，来追求利益的最大化。需求变更或许是软件需要重构的最大原因。</p>\n<h3 id=\"2、人无完人\"><a href=\"#2、人无完人\" class=\"headerlink\" title=\"2、人无完人\"></a>2、人无完人</h3><p>人无完人，我们不可能在项目开发初期就把架构设计的天衣无缝。或许某一天学习到了某个好的模式，希望把它运用到项目中，这个时候我们就需要重构了。也许因为项目开发周期短，一些模块不得不采用当下最快的方式来实现，等到未来某一天希望把实现方式通过重构变更一下。</p>\n<h2 id=\"二、准备工作\"><a href=\"#二、准备工作\" class=\"headerlink\" title=\"二、准备工作\"></a>二、准备工作</h2><p><code>重构</code>书本上列举了一系列需要重构的预判条件，这些统一称之为“坏味道”。其中包含，如：”函数过长”、“函数参数过长”、”注释过多”、”类职责不单一”等等。再遇到这些情况的适合，我们就需要仔细的审视是不是该重构了。</p>\n<p>嗅出这些坏味道只是第一步，正如<code>重构</code>的序言四人帮之一<code>Erich Gamma</code>说的那样：<code>设计模式</code>是实现重构的手段，所以在执行重构之前需要对常用的软件开发模式方法有一定的了解。</p>\n<p><code>重构</code>的定义：<strong>在不改变软件外在行为的前提下，改善软件内部结构。</strong><code>重构</code>书中着重说明了测试的重要性，测试直接关系到重构的成败。没有测试作为保障的前提下进行重构那将会是一场灾难。对于动态语言更是如此，没有编译期的保障下，任何一点修正都无法及时发现。</p>\n<h2 id=\"三、常用原则\"><a href=\"#三、常用原则\" class=\"headerlink\" title=\"三、常用原则\"></a>三、常用原则</h2><p>有了一定项目经验再回过头来看书中列举的各种重构案例，惊讶的发现，这不就是我一直在用的手段吗？原来我一直窃喜的开发方法早就有人总结并且广为流传了。其中最印象深刻的莫过于<code>Form Template Method</code>以及<code>Replace Conditional with Polymorphism</code>。<code>Form Template Method</code>需要对设计模式中的模版方法有一定的理解，反过来说，如果理解了模版方法会更加容易的发现它的适用场景。对于<code>Replace Conditional with Polymorphism</code>方案，不同的条件判断意味着不同的类别，在面向对象的大环境下很容易想到每个类别代替不同的子类。而不同的子类有不同的行为这刚好印证了面向对象编程最重要的特性：多态。</p>\n<h2 id=\"四、总结\"><a href=\"#四、总结\" class=\"headerlink\" title=\"四、总结\"></a>四、总结</h2><p>软件开发更像是一门艺术，软件产品就是一个艺术品，需要不断的细心雕琢。非常赞同人月神话作者的那句话: “软件开发最大的复杂度来自于变化。”所以隔离变化，降低复杂度将会是软件开发永恒的主题。</p>\n"},{"title":"table","date":"2016-08-07T11:09:38.000Z","_content":"\n表格大概是`html`里面最常用的元素之一。看书上介绍说，在`css`出现之前，前端工程师一直采用`table`来布局页面，\n不过我没有尝试过，相比于那些早些年的前端工程师，现在的前端工程师应该算比较幸运吧！`IE`系列老旧浏览器逐渐`死去`，\n`HTML5`标准颁布，一切都在往好的方向走～\n\n# 表格的基本属性以及实践\n\n## 表格相关的基本元素\n\n- table\n  定义表格的根元素\n- thead\n  定义表头(页眉)\n- tbody\n  定义表体\n- tfoot\n  定义表脚(页脚)\n- tr\n  定义一行\n- th\n  定义表头内单元格\n- td\n  定义普通数据单元格\n- caption\n  定义表格标题\n- col\n  定义表格列\n- colgroup\n  定义表格列组\n---\n\n**注意事项**：\n\n- `thead`、`tbody`、`tfoot`主要方便对表格不同区域进行分组，以及在打印表格的时候提供不同信息。\n- `td`、`th`单元格必须包含在`tr`属性里面\n- `col`、`colgroup`元素主要方便对表格不同列进行样式设置,需要注意的是列元素可以控制的属性[比较有限](http://www.w3.org/TR/CSS21/tables.html#columns).基本的`color`、`text-align`都不被支持\n\n比较合理的解释看这里：\n>The colour of text is dependent on the 'color' property of its element. Unless specified, the 'color' property (basically) defaults to 'inherit', which means \"take the value of the parent element\".\n\nSo for some text in a cell, the colour is determined by the 'color' property of the cell, which is taken from the row, which is taken from the table, which is taken from the table's parent, and so on.\n\nWhat about the column? Well, the column isn't one of the cell's ancestors, so it never gets a look-in! And therein lies the problem.\n\n\n\n## 表格样式布局\n\n- caption-side\n  控制表格标题位置\n- border-collapse\n  控制表格边框模型\n- table-layout\n  控制表格布局，是否根据单元格内容缩放\n- border-spacing\n  控制相邻单元格边框之间的距离，仅用于边框模型为分离模式\n- empty-cells\n  控制隐藏表格中空单元格的背景与边框\n- rowspan\n  控制单元格所跨行数\n- colspan\n  控制单元格所跨列数\n\n---\n\n## 实践问题\n\n### 奇偶行设置不同背景色\n\n1、css 奇偶行伪类选择器\n\n`nth-child(n)`选择器匹配其父元素的第`n`个子元素，odd 和 even 是可用于匹配下标是奇数或偶数的子元素的关键词。\n\n``` css\ntable tr:nth-child(even) {\n  background-color: red;\n}\n```\n\n> 为`tr`相对父元素为偶数索引(从1开始)的行设置背景为红色\n\n\n### 设置第一列为不同背景\n\n1、使用`first-child`伪类选择器\n\n``` css\ntable td:first-child {\n  background-color: red;\n}\n```\n\n\n2、使用`col`元素控制样式\n\n``` html\n\n<table>\n  <caption>hahah</caption>\n  <col class=\"col1\"\\>\n  <tr>\n    <th>th1</th>\n    <th>th2</th>\n    /...\n\n```\n\n``` css\n\ntable .col1 {\n  background-color: gray;\n}\n\n```\n\n### 设置单元格边框并合并单元格\n\n控制单元格的显示除了`盒模型`基本属性外还有`rowspan` `colspan` `empty-cells`三个属性。\n\n需要注意的是`rowspan`与`colspan`只能通过`html`属性设置，而不能通过`css`样式引用。\n\n","source":"_posts/table.md","raw":"---\ntitle: table\ndate: 2016-08-07 19:09:38\ntags: \n  - css \n  - html \n  - table\ncategories: web\n---\n\n表格大概是`html`里面最常用的元素之一。看书上介绍说，在`css`出现之前，前端工程师一直采用`table`来布局页面，\n不过我没有尝试过，相比于那些早些年的前端工程师，现在的前端工程师应该算比较幸运吧！`IE`系列老旧浏览器逐渐`死去`，\n`HTML5`标准颁布，一切都在往好的方向走～\n\n# 表格的基本属性以及实践\n\n## 表格相关的基本元素\n\n- table\n  定义表格的根元素\n- thead\n  定义表头(页眉)\n- tbody\n  定义表体\n- tfoot\n  定义表脚(页脚)\n- tr\n  定义一行\n- th\n  定义表头内单元格\n- td\n  定义普通数据单元格\n- caption\n  定义表格标题\n- col\n  定义表格列\n- colgroup\n  定义表格列组\n---\n\n**注意事项**：\n\n- `thead`、`tbody`、`tfoot`主要方便对表格不同区域进行分组，以及在打印表格的时候提供不同信息。\n- `td`、`th`单元格必须包含在`tr`属性里面\n- `col`、`colgroup`元素主要方便对表格不同列进行样式设置,需要注意的是列元素可以控制的属性[比较有限](http://www.w3.org/TR/CSS21/tables.html#columns).基本的`color`、`text-align`都不被支持\n\n比较合理的解释看这里：\n>The colour of text is dependent on the 'color' property of its element. Unless specified, the 'color' property (basically) defaults to 'inherit', which means \"take the value of the parent element\".\n\nSo for some text in a cell, the colour is determined by the 'color' property of the cell, which is taken from the row, which is taken from the table, which is taken from the table's parent, and so on.\n\nWhat about the column? Well, the column isn't one of the cell's ancestors, so it never gets a look-in! And therein lies the problem.\n\n\n\n## 表格样式布局\n\n- caption-side\n  控制表格标题位置\n- border-collapse\n  控制表格边框模型\n- table-layout\n  控制表格布局，是否根据单元格内容缩放\n- border-spacing\n  控制相邻单元格边框之间的距离，仅用于边框模型为分离模式\n- empty-cells\n  控制隐藏表格中空单元格的背景与边框\n- rowspan\n  控制单元格所跨行数\n- colspan\n  控制单元格所跨列数\n\n---\n\n## 实践问题\n\n### 奇偶行设置不同背景色\n\n1、css 奇偶行伪类选择器\n\n`nth-child(n)`选择器匹配其父元素的第`n`个子元素，odd 和 even 是可用于匹配下标是奇数或偶数的子元素的关键词。\n\n``` css\ntable tr:nth-child(even) {\n  background-color: red;\n}\n```\n\n> 为`tr`相对父元素为偶数索引(从1开始)的行设置背景为红色\n\n\n### 设置第一列为不同背景\n\n1、使用`first-child`伪类选择器\n\n``` css\ntable td:first-child {\n  background-color: red;\n}\n```\n\n\n2、使用`col`元素控制样式\n\n``` html\n\n<table>\n  <caption>hahah</caption>\n  <col class=\"col1\"\\>\n  <tr>\n    <th>th1</th>\n    <th>th2</th>\n    /...\n\n```\n\n``` css\n\ntable .col1 {\n  background-color: gray;\n}\n\n```\n\n### 设置单元格边框并合并单元格\n\n控制单元格的显示除了`盒模型`基本属性外还有`rowspan` `colspan` `empty-cells`三个属性。\n\n需要注意的是`rowspan`与`colspan`只能通过`html`属性设置，而不能通过`css`样式引用。\n\n","slug":"table","published":1,"updated":"2018-07-01T10:30:46.496Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cdw0036y4zv4vli8jb4","content":"<p>表格大概是<code>html</code>里面最常用的元素之一。看书上介绍说，在<code>css</code>出现之前，前端工程师一直采用<code>table</code>来布局页面，<br>不过我没有尝试过，相比于那些早些年的前端工程师，现在的前端工程师应该算比较幸运吧！<code>IE</code>系列老旧浏览器逐渐<code>死去</code>，<br><code>HTML5</code>标准颁布，一切都在往好的方向走～</p>\n<h1 id=\"表格的基本属性以及实践\"><a href=\"#表格的基本属性以及实践\" class=\"headerlink\" title=\"表格的基本属性以及实践\"></a>表格的基本属性以及实践</h1><h2 id=\"表格相关的基本元素\"><a href=\"#表格相关的基本元素\" class=\"headerlink\" title=\"表格相关的基本元素\"></a>表格相关的基本元素</h2><ul>\n<li>table<br>定义表格的根元素</li>\n<li>thead<br>定义表头(页眉)</li>\n<li>tbody<br>定义表体</li>\n<li>tfoot<br>定义表脚(页脚)</li>\n<li>tr<br>定义一行</li>\n<li>th<br>定义表头内单元格</li>\n<li>td<br>定义普通数据单元格</li>\n<li>caption<br>定义表格标题</li>\n<li>col<br>定义表格列</li>\n<li>colgroup<br>定义表格列组</li>\n</ul>\n<hr>\n<p><strong>注意事项</strong>：</p>\n<ul>\n<li><code>thead</code>、<code>tbody</code>、<code>tfoot</code>主要方便对表格不同区域进行分组，以及在打印表格的时候提供不同信息。</li>\n<li><code>td</code>、<code>th</code>单元格必须包含在<code>tr</code>属性里面</li>\n<li><code>col</code>、<code>colgroup</code>元素主要方便对表格不同列进行样式设置,需要注意的是列元素可以控制的属性<a href=\"http://www.w3.org/TR/CSS21/tables.html#columns\" target=\"_blank\" rel=\"noopener\">比较有限</a>.基本的<code>color</code>、<code>text-align</code>都不被支持</li>\n</ul>\n<p>比较合理的解释看这里：</p>\n<blockquote>\n<p>The colour of text is dependent on the ‘color’ property of its element. Unless specified, the ‘color’ property (basically) defaults to ‘inherit’, which means “take the value of the parent element”.</p>\n</blockquote>\n<p>So for some text in a cell, the colour is determined by the ‘color’ property of the cell, which is taken from the row, which is taken from the table, which is taken from the table’s parent, and so on.</p>\n<p>What about the column? Well, the column isn’t one of the cell’s ancestors, so it never gets a look-in! And therein lies the problem.</p>\n<h2 id=\"表格样式布局\"><a href=\"#表格样式布局\" class=\"headerlink\" title=\"表格样式布局\"></a>表格样式布局</h2><ul>\n<li>caption-side<br>控制表格标题位置</li>\n<li>border-collapse<br>控制表格边框模型</li>\n<li>table-layout<br>控制表格布局，是否根据单元格内容缩放</li>\n<li>border-spacing<br>控制相邻单元格边框之间的距离，仅用于边框模型为分离模式</li>\n<li>empty-cells<br>控制隐藏表格中空单元格的背景与边框</li>\n<li>rowspan<br>控制单元格所跨行数</li>\n<li>colspan<br>控制单元格所跨列数</li>\n</ul>\n<hr>\n<h2 id=\"实践问题\"><a href=\"#实践问题\" class=\"headerlink\" title=\"实践问题\"></a>实践问题</h2><h3 id=\"奇偶行设置不同背景色\"><a href=\"#奇偶行设置不同背景色\" class=\"headerlink\" title=\"奇偶行设置不同背景色\"></a>奇偶行设置不同背景色</h3><p>1、css 奇偶行伪类选择器</p>\n<p><code>nth-child(n)</code>选择器匹配其父元素的第<code>n</code>个子元素，odd 和 even 是可用于匹配下标是奇数或偶数的子元素的关键词。</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">table</span> <span class=\"selector-tag\">tr</span><span class=\"selector-pseudo\">:nth-child(even)</span> &#123;</span><br><span class=\"line\">  <span class=\"attribute\">background-color</span>: red;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>为<code>tr</code>相对父元素为偶数索引(从1开始)的行设置背景为红色</p>\n</blockquote>\n<h3 id=\"设置第一列为不同背景\"><a href=\"#设置第一列为不同背景\" class=\"headerlink\" title=\"设置第一列为不同背景\"></a>设置第一列为不同背景</h3><p>1、使用<code>first-child</code>伪类选择器</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">table</span> <span class=\"selector-tag\">td</span><span class=\"selector-pseudo\">:first-child</span> &#123;</span><br><span class=\"line\">  <span class=\"attribute\">background-color</span>: red;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>2、使用<code>col</code>元素控制样式</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">table</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">caption</span>&gt;</span>hahah<span class=\"tag\">&lt;/<span class=\"name\">caption</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">col</span> <span class=\"attr\">class</span>=<span class=\"string\">\"col1\"</span>\\&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">tr</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">th</span>&gt;</span>th1<span class=\"tag\">&lt;/<span class=\"name\">th</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">th</span>&gt;</span>th2<span class=\"tag\">&lt;/<span class=\"name\">th</span>&gt;</span></span><br><span class=\"line\">    /...</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">table</span> <span class=\"selector-class\">.col1</span> &#123;</span><br><span class=\"line\">  <span class=\"attribute\">background-color</span>: gray;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"设置单元格边框并合并单元格\"><a href=\"#设置单元格边框并合并单元格\" class=\"headerlink\" title=\"设置单元格边框并合并单元格\"></a>设置单元格边框并合并单元格</h3><p>控制单元格的显示除了<code>盒模型</code>基本属性外还有<code>rowspan</code> <code>colspan</code> <code>empty-cells</code>三个属性。</p>\n<p>需要注意的是<code>rowspan</code>与<code>colspan</code>只能通过<code>html</code>属性设置，而不能通过<code>css</code>样式引用。</p>\n","site":{"data":{}},"excerpt":"","more":"<p>表格大概是<code>html</code>里面最常用的元素之一。看书上介绍说，在<code>css</code>出现之前，前端工程师一直采用<code>table</code>来布局页面，<br>不过我没有尝试过，相比于那些早些年的前端工程师，现在的前端工程师应该算比较幸运吧！<code>IE</code>系列老旧浏览器逐渐<code>死去</code>，<br><code>HTML5</code>标准颁布，一切都在往好的方向走～</p>\n<h1 id=\"表格的基本属性以及实践\"><a href=\"#表格的基本属性以及实践\" class=\"headerlink\" title=\"表格的基本属性以及实践\"></a>表格的基本属性以及实践</h1><h2 id=\"表格相关的基本元素\"><a href=\"#表格相关的基本元素\" class=\"headerlink\" title=\"表格相关的基本元素\"></a>表格相关的基本元素</h2><ul>\n<li>table<br>定义表格的根元素</li>\n<li>thead<br>定义表头(页眉)</li>\n<li>tbody<br>定义表体</li>\n<li>tfoot<br>定义表脚(页脚)</li>\n<li>tr<br>定义一行</li>\n<li>th<br>定义表头内单元格</li>\n<li>td<br>定义普通数据单元格</li>\n<li>caption<br>定义表格标题</li>\n<li>col<br>定义表格列</li>\n<li>colgroup<br>定义表格列组</li>\n</ul>\n<hr>\n<p><strong>注意事项</strong>：</p>\n<ul>\n<li><code>thead</code>、<code>tbody</code>、<code>tfoot</code>主要方便对表格不同区域进行分组，以及在打印表格的时候提供不同信息。</li>\n<li><code>td</code>、<code>th</code>单元格必须包含在<code>tr</code>属性里面</li>\n<li><code>col</code>、<code>colgroup</code>元素主要方便对表格不同列进行样式设置,需要注意的是列元素可以控制的属性<a href=\"http://www.w3.org/TR/CSS21/tables.html#columns\" target=\"_blank\" rel=\"noopener\">比较有限</a>.基本的<code>color</code>、<code>text-align</code>都不被支持</li>\n</ul>\n<p>比较合理的解释看这里：</p>\n<blockquote>\n<p>The colour of text is dependent on the ‘color’ property of its element. Unless specified, the ‘color’ property (basically) defaults to ‘inherit’, which means “take the value of the parent element”.</p>\n</blockquote>\n<p>So for some text in a cell, the colour is determined by the ‘color’ property of the cell, which is taken from the row, which is taken from the table, which is taken from the table’s parent, and so on.</p>\n<p>What about the column? Well, the column isn’t one of the cell’s ancestors, so it never gets a look-in! And therein lies the problem.</p>\n<h2 id=\"表格样式布局\"><a href=\"#表格样式布局\" class=\"headerlink\" title=\"表格样式布局\"></a>表格样式布局</h2><ul>\n<li>caption-side<br>控制表格标题位置</li>\n<li>border-collapse<br>控制表格边框模型</li>\n<li>table-layout<br>控制表格布局，是否根据单元格内容缩放</li>\n<li>border-spacing<br>控制相邻单元格边框之间的距离，仅用于边框模型为分离模式</li>\n<li>empty-cells<br>控制隐藏表格中空单元格的背景与边框</li>\n<li>rowspan<br>控制单元格所跨行数</li>\n<li>colspan<br>控制单元格所跨列数</li>\n</ul>\n<hr>\n<h2 id=\"实践问题\"><a href=\"#实践问题\" class=\"headerlink\" title=\"实践问题\"></a>实践问题</h2><h3 id=\"奇偶行设置不同背景色\"><a href=\"#奇偶行设置不同背景色\" class=\"headerlink\" title=\"奇偶行设置不同背景色\"></a>奇偶行设置不同背景色</h3><p>1、css 奇偶行伪类选择器</p>\n<p><code>nth-child(n)</code>选择器匹配其父元素的第<code>n</code>个子元素，odd 和 even 是可用于匹配下标是奇数或偶数的子元素的关键词。</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">table</span> <span class=\"selector-tag\">tr</span><span class=\"selector-pseudo\">:nth-child(even)</span> &#123;</span><br><span class=\"line\">  <span class=\"attribute\">background-color</span>: red;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>为<code>tr</code>相对父元素为偶数索引(从1开始)的行设置背景为红色</p>\n</blockquote>\n<h3 id=\"设置第一列为不同背景\"><a href=\"#设置第一列为不同背景\" class=\"headerlink\" title=\"设置第一列为不同背景\"></a>设置第一列为不同背景</h3><p>1、使用<code>first-child</code>伪类选择器</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">table</span> <span class=\"selector-tag\">td</span><span class=\"selector-pseudo\">:first-child</span> &#123;</span><br><span class=\"line\">  <span class=\"attribute\">background-color</span>: red;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>2、使用<code>col</code>元素控制样式</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">table</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">caption</span>&gt;</span>hahah<span class=\"tag\">&lt;/<span class=\"name\">caption</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">col</span> <span class=\"attr\">class</span>=<span class=\"string\">\"col1\"</span>\\&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">tr</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">th</span>&gt;</span>th1<span class=\"tag\">&lt;/<span class=\"name\">th</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">th</span>&gt;</span>th2<span class=\"tag\">&lt;/<span class=\"name\">th</span>&gt;</span></span><br><span class=\"line\">    /...</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">table</span> <span class=\"selector-class\">.col1</span> &#123;</span><br><span class=\"line\">  <span class=\"attribute\">background-color</span>: gray;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"设置单元格边框并合并单元格\"><a href=\"#设置单元格边框并合并单元格\" class=\"headerlink\" title=\"设置单元格边框并合并单元格\"></a>设置单元格边框并合并单元格</h3><p>控制单元格的显示除了<code>盒模型</code>基本属性外还有<code>rowspan</code> <code>colspan</code> <code>empty-cells</code>三个属性。</p>\n<p>需要注意的是<code>rowspan</code>与<code>colspan</code>只能通过<code>html</code>属性设置，而不能通过<code>css</code>样式引用。</p>\n"},{"title":"vscode开发环境配置","date":"2016-03-07T04:37:03.000Z","_content":"\n## 初衷  \n\n一直一来都是`vim`编辑器的忠实用户，说来也没有什么特别的原因，只不过是因为用的久了，习惯罢了。\n改变已有的习惯就跟在学习新知识的时候刻意练习会带来同样的体会，会让你感觉不舒服。之所以想放弃使用多年的`vim`\n(也就3-4年罢了)转投`vscode`名下.\n\n## 前言\n\n> \n学习任何东西都有一个有效的方法论：在了解了一些必要的知识之后，快速开始行动，\n刻意练习！在练习中不断总结提高！\n\n科学研究者把人们应对一件事情分为3个步骤：\n- 1、认知该事件的方式方法。 \n- 2、通过何种方式方法可以完成该事情。\n- 3、实践该方法的步骤以及条件。\n  \n\n## 安装编辑器\n\n在`github`上找到`vscode`仓库，简要的阅读一下`readme`文档，然后再阅读一下\n`How to build and run from source`。`vscode`是基于`electron`开发的，所以再安装过程中需要下载`electron`的平台包，考虑到墙的原因\n我们可以自己下载`electron` [electron](https://npm.taobao.org/mirrors/electron),放到`vscode`根目录的`.build`下的`electron`文件夹\n\n另外一种安装方式更为简便，到`vscode`官网下载安装包并安装。  \n\n## 阅读官方文档\n\n`vscode`官方网站是 `https://code.visualstudio.com`。阅读完`overview`以及`setup`下的平台环境完成安装。\n对于新手来说接下来应该认真阅读`EDITOR`一章。\n\n## vscode cheatsheet\n\n对于 任意一个软件来说，掌握好了快捷键会提升你的效率，让你有更多的时间专注于有价值的事情上。\n`vscode`按下`F1`快捷键，会提示所有的快捷键，还有一种方式：打开`File=>Preferences=>keyboard Shortcuts`\n列出所有的快捷键。另外这一章节的内容必须把它背下来：`https://code.visualstudio.com/docs/editor/editingevolved`。\n\n小结：\n- vscode `EDITOR`一章  \n- vscode cheatsheet  \n","source":"_posts/vscode开发环境配置.md","raw":"---\ntitle: vscode开发环境配置\ncategories: vscode\ndate: 2016-03-07 12:37:03\n---\n\n## 初衷  \n\n一直一来都是`vim`编辑器的忠实用户，说来也没有什么特别的原因，只不过是因为用的久了，习惯罢了。\n改变已有的习惯就跟在学习新知识的时候刻意练习会带来同样的体会，会让你感觉不舒服。之所以想放弃使用多年的`vim`\n(也就3-4年罢了)转投`vscode`名下.\n\n## 前言\n\n> \n学习任何东西都有一个有效的方法论：在了解了一些必要的知识之后，快速开始行动，\n刻意练习！在练习中不断总结提高！\n\n科学研究者把人们应对一件事情分为3个步骤：\n- 1、认知该事件的方式方法。 \n- 2、通过何种方式方法可以完成该事情。\n- 3、实践该方法的步骤以及条件。\n  \n\n## 安装编辑器\n\n在`github`上找到`vscode`仓库，简要的阅读一下`readme`文档，然后再阅读一下\n`How to build and run from source`。`vscode`是基于`electron`开发的，所以再安装过程中需要下载`electron`的平台包，考虑到墙的原因\n我们可以自己下载`electron` [electron](https://npm.taobao.org/mirrors/electron),放到`vscode`根目录的`.build`下的`electron`文件夹\n\n另外一种安装方式更为简便，到`vscode`官网下载安装包并安装。  \n\n## 阅读官方文档\n\n`vscode`官方网站是 `https://code.visualstudio.com`。阅读完`overview`以及`setup`下的平台环境完成安装。\n对于新手来说接下来应该认真阅读`EDITOR`一章。\n\n## vscode cheatsheet\n\n对于 任意一个软件来说，掌握好了快捷键会提升你的效率，让你有更多的时间专注于有价值的事情上。\n`vscode`按下`F1`快捷键，会提示所有的快捷键，还有一种方式：打开`File=>Preferences=>keyboard Shortcuts`\n列出所有的快捷键。另外这一章节的内容必须把它背下来：`https://code.visualstudio.com/docs/editor/editingevolved`。\n\n小结：\n- vscode `EDITOR`一章  \n- vscode cheatsheet  \n","slug":"vscode开发环境配置","published":1,"updated":"2018-12-15T13:16:44.982Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cdx003ay4zv1it9gyl9","content":"<h2 id=\"初衷\"><a href=\"#初衷\" class=\"headerlink\" title=\"初衷\"></a>初衷</h2><p>一直一来都是<code>vim</code>编辑器的忠实用户，说来也没有什么特别的原因，只不过是因为用的久了，习惯罢了。<br>改变已有的习惯就跟在学习新知识的时候刻意练习会带来同样的体会，会让你感觉不舒服。之所以想放弃使用多年的<code>vim</code><br>(也就3-4年罢了)转投<code>vscode</code>名下.</p>\n<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><blockquote>\n</blockquote>\n<p>学习任何东西都有一个有效的方法论：在了解了一些必要的知识之后，快速开始行动，<br>刻意练习！在练习中不断总结提高！</p>\n<p>科学研究者把人们应对一件事情分为3个步骤：</p>\n<ul>\n<li>1、认知该事件的方式方法。 </li>\n<li>2、通过何种方式方法可以完成该事情。</li>\n<li>3、实践该方法的步骤以及条件。</li>\n</ul>\n<h2 id=\"安装编辑器\"><a href=\"#安装编辑器\" class=\"headerlink\" title=\"安装编辑器\"></a>安装编辑器</h2><p>在<code>github</code>上找到<code>vscode</code>仓库，简要的阅读一下<code>readme</code>文档，然后再阅读一下<br><code>How to build and run from source</code>。<code>vscode</code>是基于<code>electron</code>开发的，所以再安装过程中需要下载<code>electron</code>的平台包，考虑到墙的原因<br>我们可以自己下载<code>electron</code> <a href=\"https://npm.taobao.org/mirrors/electron\" target=\"_blank\" rel=\"noopener\">electron</a>,放到<code>vscode</code>根目录的<code>.build</code>下的<code>electron</code>文件夹</p>\n<p>另外一种安装方式更为简便，到<code>vscode</code>官网下载安装包并安装。  </p>\n<h2 id=\"阅读官方文档\"><a href=\"#阅读官方文档\" class=\"headerlink\" title=\"阅读官方文档\"></a>阅读官方文档</h2><p><code>vscode</code>官方网站是 <code>https://code.visualstudio.com</code>。阅读完<code>overview</code>以及<code>setup</code>下的平台环境完成安装。<br>对于新手来说接下来应该认真阅读<code>EDITOR</code>一章。</p>\n<h2 id=\"vscode-cheatsheet\"><a href=\"#vscode-cheatsheet\" class=\"headerlink\" title=\"vscode cheatsheet\"></a>vscode cheatsheet</h2><p>对于 任意一个软件来说，掌握好了快捷键会提升你的效率，让你有更多的时间专注于有价值的事情上。<br><code>vscode</code>按下<code>F1</code>快捷键，会提示所有的快捷键，还有一种方式：打开<code>File=&gt;Preferences=&gt;keyboard Shortcuts</code><br>列出所有的快捷键。另外这一章节的内容必须把它背下来：<code>https://code.visualstudio.com/docs/editor/editingevolved</code>。</p>\n<p>小结：</p>\n<ul>\n<li>vscode <code>EDITOR</code>一章  </li>\n<li>vscode cheatsheet  </li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"初衷\"><a href=\"#初衷\" class=\"headerlink\" title=\"初衷\"></a>初衷</h2><p>一直一来都是<code>vim</code>编辑器的忠实用户，说来也没有什么特别的原因，只不过是因为用的久了，习惯罢了。<br>改变已有的习惯就跟在学习新知识的时候刻意练习会带来同样的体会，会让你感觉不舒服。之所以想放弃使用多年的<code>vim</code><br>(也就3-4年罢了)转投<code>vscode</code>名下.</p>\n<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><blockquote>\n</blockquote>\n<p>学习任何东西都有一个有效的方法论：在了解了一些必要的知识之后，快速开始行动，<br>刻意练习！在练习中不断总结提高！</p>\n<p>科学研究者把人们应对一件事情分为3个步骤：</p>\n<ul>\n<li>1、认知该事件的方式方法。 </li>\n<li>2、通过何种方式方法可以完成该事情。</li>\n<li>3、实践该方法的步骤以及条件。</li>\n</ul>\n<h2 id=\"安装编辑器\"><a href=\"#安装编辑器\" class=\"headerlink\" title=\"安装编辑器\"></a>安装编辑器</h2><p>在<code>github</code>上找到<code>vscode</code>仓库，简要的阅读一下<code>readme</code>文档，然后再阅读一下<br><code>How to build and run from source</code>。<code>vscode</code>是基于<code>electron</code>开发的，所以再安装过程中需要下载<code>electron</code>的平台包，考虑到墙的原因<br>我们可以自己下载<code>electron</code> <a href=\"https://npm.taobao.org/mirrors/electron\" target=\"_blank\" rel=\"noopener\">electron</a>,放到<code>vscode</code>根目录的<code>.build</code>下的<code>electron</code>文件夹</p>\n<p>另外一种安装方式更为简便，到<code>vscode</code>官网下载安装包并安装。  </p>\n<h2 id=\"阅读官方文档\"><a href=\"#阅读官方文档\" class=\"headerlink\" title=\"阅读官方文档\"></a>阅读官方文档</h2><p><code>vscode</code>官方网站是 <code>https://code.visualstudio.com</code>。阅读完<code>overview</code>以及<code>setup</code>下的平台环境完成安装。<br>对于新手来说接下来应该认真阅读<code>EDITOR</code>一章。</p>\n<h2 id=\"vscode-cheatsheet\"><a href=\"#vscode-cheatsheet\" class=\"headerlink\" title=\"vscode cheatsheet\"></a>vscode cheatsheet</h2><p>对于 任意一个软件来说，掌握好了快捷键会提升你的效率，让你有更多的时间专注于有价值的事情上。<br><code>vscode</code>按下<code>F1</code>快捷键，会提示所有的快捷键，还有一种方式：打开<code>File=&gt;Preferences=&gt;keyboard Shortcuts</code><br>列出所有的快捷键。另外这一章节的内容必须把它背下来：<code>https://code.visualstudio.com/docs/editor/editingevolved</code>。</p>\n<p>小结：</p>\n<ul>\n<li>vscode <code>EDITOR</code>一章  </li>\n<li>vscode cheatsheet  </li>\n</ul>\n"},{"title":"vscode编辑器进阶","date":"2016-04-07T02:37:03.000Z","_content":"\n## 前言\n假定你已经阅读完成了`EDITOR`一章。现在开始来定制`vscode`。\n\n两个目的：  \n- 减少重复工作，把时间花费在有意义的事情上  \n- 可定制、可扩展、可积累  \n\n## 主题颜色字体\n`File>>Perfences=>corlor theme`选择一个舒服的主题，当然也可以按下`ctril+p`输入\n`ext install `安装喜欢的主题。字体通过用户配置文件来设置：按下`F1`输入`user`选择第一个条目按下回车。\n左边是默认配置，右边写入自定义配置。\n\n\n颜色字体这类属于无关紧要的细节，不需要在这方面浪费过多的时间，接下来说说`snippets`。\n\n## vscode snippets\n\n`vscode`针对不同的语言有不同的`snippets`。举个例子,新建一个`test.html`,输入：\n> html\n\n按下`ctrl+space`触发`snippets`。有两个选项可供选择，`html`标签以及`html`模板。\n选择`html模板`按下回车你会看到一下子多了很多东西：\n\n``` html\n<!DOCTYPE html>\n<html lang=\"en\">\n    <head>\n        <title></title>\n        <meta charset=\"UTF-8\">\n        <link href=\"css/style.css\" rel=\"stylesheet\">\n    </head>\n    <body>\n    \n    </body>\n</html>\n\n```\n光标默认停留在`en`的位置，按下`TAB`会在en、title、以及body之间切换，能这么做归功于`vscode`的`html snippets`扩展。\n项目地址：  \n>\nhttps://github.com/abusaidm/html-snippets/blob/master/snippets/snippets.json\n\n看看`snippets.json`的实现：  \n```\n\"html5\": {\n    \"prefix\": \"html5\",\n    \"body\": [\n        \"<!DOCTYPE html>\",\n        \"<html lang=\\\"$1en\\\">\",\n        \"\\t<head>\",\n        \"\\t\\t<title>$2</title>\",\n        \"\\t\\t<meta charset=\\\"UTF-8\\\">\",\n        \"\\t\\t<link href=\\\"$3css/style.css\\\" rel=\\\"stylesheet\\\">\",\n        \"\\t</head>\",\n        \"\\t<body>\",\n        \"\\t$4\",\n        \"\\t</body>\",\n        \"</html>\"\n        ],\n    \"description\": \"HTML - Defines a template for a html5 document\",\n    \"scope\": \"text.html\"\n    }\n```\n\n解释一下这个`snippets`:  \n- \"html5\"表示该`snippets`的名称，`prefix`后面的`html5`表示触发条件  \n- `body`表示`snippets`内容，是一个数组，数组元素最终会用换行符号链接起来  \n- `\\t`表示缩进  \n- `$数字`表示光标停留的次序，`$1`表示第一次停留位置，按下`Tab`键移到下一个位置  \n\n\n实在太方便了，工程师们就应该多动动脑子！！！  \n\n当然也可以定义自己的`snippets`，在`File=>Perfences=>User Snippets`选择语言然后会出现以下代码：  \n\n```\n/*\n\t // Place your snippets for Markdown here. Each snippet is defined under a snippet name and has a prefix, body and \n\t // description. The prefix is what is used to trigger the snippet and the body will be expanded and inserted. Possible variables are:\n\t // $1, $2 for tab stops, ${id} and ${id:label} and ${1:label} for variables. Variables with the same id are connected.\n\t // Example:\n\t \"Print to console\": {\n\t\t\"prefix\": \"log\",\n\t\t\"body\": [\n\t\t\t\"console.log('$1');\",\n\t\t\t\"$2\"\n\t\t],\n\t\t\"description\": \"Log output to console\"\n\t}\n*/\n```  \n\n以后你可以把自己的`snippet`放到这里。顺便说一句`vscode``snippet`格式遵循`textmate`,除了：   \n> \n 'regular expression replacements', 'interpolated shell code' and 'transformations'  \n> \nhttps://manual.macromates.com/en/snippets  \n\n你可以按下`ctrl+p`(快速打开)输入`ext install sni`,会列出一系列`snippet`。  \n`enjoy it :) `  \n\n\n## 任务：  \n- 到https://marketplace.visualstudio.com/vscode找最常用的包试一试\n- 学习`snippet`基本语法，学会自己编写 snippet    \n","source":"_posts/vscode编辑器进阶.md","raw":"---\ntitle: vscode编辑器进阶\ncategories: vscode\ndate: 2016-04-07 10:37:03\n---\n\n## 前言\n假定你已经阅读完成了`EDITOR`一章。现在开始来定制`vscode`。\n\n两个目的：  \n- 减少重复工作，把时间花费在有意义的事情上  \n- 可定制、可扩展、可积累  \n\n## 主题颜色字体\n`File>>Perfences=>corlor theme`选择一个舒服的主题，当然也可以按下`ctril+p`输入\n`ext install `安装喜欢的主题。字体通过用户配置文件来设置：按下`F1`输入`user`选择第一个条目按下回车。\n左边是默认配置，右边写入自定义配置。\n\n\n颜色字体这类属于无关紧要的细节，不需要在这方面浪费过多的时间，接下来说说`snippets`。\n\n## vscode snippets\n\n`vscode`针对不同的语言有不同的`snippets`。举个例子,新建一个`test.html`,输入：\n> html\n\n按下`ctrl+space`触发`snippets`。有两个选项可供选择，`html`标签以及`html`模板。\n选择`html模板`按下回车你会看到一下子多了很多东西：\n\n``` html\n<!DOCTYPE html>\n<html lang=\"en\">\n    <head>\n        <title></title>\n        <meta charset=\"UTF-8\">\n        <link href=\"css/style.css\" rel=\"stylesheet\">\n    </head>\n    <body>\n    \n    </body>\n</html>\n\n```\n光标默认停留在`en`的位置，按下`TAB`会在en、title、以及body之间切换，能这么做归功于`vscode`的`html snippets`扩展。\n项目地址：  \n>\nhttps://github.com/abusaidm/html-snippets/blob/master/snippets/snippets.json\n\n看看`snippets.json`的实现：  \n```\n\"html5\": {\n    \"prefix\": \"html5\",\n    \"body\": [\n        \"<!DOCTYPE html>\",\n        \"<html lang=\\\"$1en\\\">\",\n        \"\\t<head>\",\n        \"\\t\\t<title>$2</title>\",\n        \"\\t\\t<meta charset=\\\"UTF-8\\\">\",\n        \"\\t\\t<link href=\\\"$3css/style.css\\\" rel=\\\"stylesheet\\\">\",\n        \"\\t</head>\",\n        \"\\t<body>\",\n        \"\\t$4\",\n        \"\\t</body>\",\n        \"</html>\"\n        ],\n    \"description\": \"HTML - Defines a template for a html5 document\",\n    \"scope\": \"text.html\"\n    }\n```\n\n解释一下这个`snippets`:  \n- \"html5\"表示该`snippets`的名称，`prefix`后面的`html5`表示触发条件  \n- `body`表示`snippets`内容，是一个数组，数组元素最终会用换行符号链接起来  \n- `\\t`表示缩进  \n- `$数字`表示光标停留的次序，`$1`表示第一次停留位置，按下`Tab`键移到下一个位置  \n\n\n实在太方便了，工程师们就应该多动动脑子！！！  \n\n当然也可以定义自己的`snippets`，在`File=>Perfences=>User Snippets`选择语言然后会出现以下代码：  \n\n```\n/*\n\t // Place your snippets for Markdown here. Each snippet is defined under a snippet name and has a prefix, body and \n\t // description. The prefix is what is used to trigger the snippet and the body will be expanded and inserted. Possible variables are:\n\t // $1, $2 for tab stops, ${id} and ${id:label} and ${1:label} for variables. Variables with the same id are connected.\n\t // Example:\n\t \"Print to console\": {\n\t\t\"prefix\": \"log\",\n\t\t\"body\": [\n\t\t\t\"console.log('$1');\",\n\t\t\t\"$2\"\n\t\t],\n\t\t\"description\": \"Log output to console\"\n\t}\n*/\n```  \n\n以后你可以把自己的`snippet`放到这里。顺便说一句`vscode``snippet`格式遵循`textmate`,除了：   \n> \n 'regular expression replacements', 'interpolated shell code' and 'transformations'  \n> \nhttps://manual.macromates.com/en/snippets  \n\n你可以按下`ctrl+p`(快速打开)输入`ext install sni`,会列出一系列`snippet`。  \n`enjoy it :) `  \n\n\n## 任务：  \n- 到https://marketplace.visualstudio.com/vscode找最常用的包试一试\n- 学习`snippet`基本语法，学会自己编写 snippet    \n","slug":"vscode编辑器进阶","published":1,"updated":"2018-12-15T13:16:12.503Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cdy003ey4zv0mbx01hh","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>假定你已经阅读完成了<code>EDITOR</code>一章。现在开始来定制<code>vscode</code>。</p>\n<p>两个目的：  </p>\n<ul>\n<li>减少重复工作，把时间花费在有意义的事情上  </li>\n<li>可定制、可扩展、可积累  </li>\n</ul>\n<h2 id=\"主题颜色字体\"><a href=\"#主题颜色字体\" class=\"headerlink\" title=\"主题颜色字体\"></a>主题颜色字体</h2><p><code>File&gt;&gt;Perfences=&gt;corlor theme</code>选择一个舒服的主题，当然也可以按下<code>ctril+p</code>输入<br><code>ext install</code>安装喜欢的主题。字体通过用户配置文件来设置：按下<code>F1</code>输入<code>user</code>选择第一个条目按下回车。<br>左边是默认配置，右边写入自定义配置。</p>\n<p>颜色字体这类属于无关紧要的细节，不需要在这方面浪费过多的时间，接下来说说<code>snippets</code>。</p>\n<h2 id=\"vscode-snippets\"><a href=\"#vscode-snippets\" class=\"headerlink\" title=\"vscode snippets\"></a>vscode snippets</h2><p><code>vscode</code>针对不同的语言有不同的<code>snippets</code>。举个例子,新建一个<code>test.html</code>,输入：</p>\n<blockquote>\n<p>html</p>\n</blockquote>\n<p>按下<code>ctrl+space</code>触发<code>snippets</code>。有两个选项可供选择，<code>html</code>标签以及<code>html</code>模板。<br>选择<code>html模板</code>按下回车你会看到一下子多了很多东西：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span> <span class=\"attr\">lang</span>=<span class=\"string\">\"en\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">meta</span> <span class=\"attr\">charset</span>=<span class=\"string\">\"UTF-8\"</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">href</span>=<span class=\"string\">\"css/style.css\"</span> <span class=\"attr\">rel</span>=<span class=\"string\">\"stylesheet\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>光标默认停留在<code>en</code>的位置，按下<code>TAB</code>会在en、title、以及body之间切换，能这么做归功于<code>vscode</code>的<code>html snippets</code>扩展。<br>项目地址：  </p>\n<blockquote>\n</blockquote>\n<p><a href=\"https://github.com/abusaidm/html-snippets/blob/master/snippets/snippets.json\" target=\"_blank\" rel=\"noopener\">https://github.com/abusaidm/html-snippets/blob/master/snippets/snippets.json</a></p>\n<p>看看<code>snippets.json</code>的实现：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;html5&quot;: &#123;</span><br><span class=\"line\">    &quot;prefix&quot;: &quot;html5&quot;,</span><br><span class=\"line\">    &quot;body&quot;: [</span><br><span class=\"line\">        &quot;&lt;!DOCTYPE html&gt;&quot;,</span><br><span class=\"line\">        &quot;&lt;html lang=\\&quot;$1en\\&quot;&gt;&quot;,</span><br><span class=\"line\">        &quot;\\t&lt;head&gt;&quot;,</span><br><span class=\"line\">        &quot;\\t\\t&lt;title&gt;$2&lt;/title&gt;&quot;,</span><br><span class=\"line\">        &quot;\\t\\t&lt;meta charset=\\&quot;UTF-8\\&quot;&gt;&quot;,</span><br><span class=\"line\">        &quot;\\t\\t&lt;link href=\\&quot;$3css/style.css\\&quot; rel=\\&quot;stylesheet\\&quot;&gt;&quot;,</span><br><span class=\"line\">        &quot;\\t&lt;/head&gt;&quot;,</span><br><span class=\"line\">        &quot;\\t&lt;body&gt;&quot;,</span><br><span class=\"line\">        &quot;\\t$4&quot;,</span><br><span class=\"line\">        &quot;\\t&lt;/body&gt;&quot;,</span><br><span class=\"line\">        &quot;&lt;/html&gt;&quot;</span><br><span class=\"line\">        ],</span><br><span class=\"line\">    &quot;description&quot;: &quot;HTML - Defines a template for a html5 document&quot;,</span><br><span class=\"line\">    &quot;scope&quot;: &quot;text.html&quot;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure></p>\n<p>解释一下这个<code>snippets</code>:  </p>\n<ul>\n<li>“html5”表示该<code>snippets</code>的名称，<code>prefix</code>后面的<code>html5</code>表示触发条件  </li>\n<li><code>body</code>表示<code>snippets</code>内容，是一个数组，数组元素最终会用换行符号链接起来  </li>\n<li><code>\\t</code>表示缩进  </li>\n<li><code>$数字</code>表示光标停留的次序，<code>$1</code>表示第一次停留位置，按下<code>Tab</code>键移到下一个位置  </li>\n</ul>\n<p>实在太方便了，工程师们就应该多动动脑子！！！  </p>\n<p>当然也可以定义自己的<code>snippets</code>，在<code>File=&gt;Perfences=&gt;User Snippets</code>选择语言然后会出现以下代码：  </p>\n<pre><code>/*\n     // Place your snippets for Markdown here. Each snippet is defined under a snippet name and has a prefix, body and \n     // description. The prefix is what is used to trigger the snippet and the body will be expanded and inserted. Possible variables are:\n     // $1, $2 for tab stops, ${id} and ${id:label} and ${1:label} for variables. Variables with the same id are connected.\n     // Example:\n     &quot;Print to console&quot;: {\n        &quot;prefix&quot;: &quot;log&quot;,\n        &quot;body&quot;: [\n            &quot;console.log(&apos;$1&apos;);&quot;,\n            &quot;$2&quot;\n        ],\n        &quot;description&quot;: &quot;Log output to console&quot;\n    }\n*/\n</code></pre><p>以后你可以把自己的<code>snippet</code>放到这里。顺便说一句<code>vscode`</code>snippet<code>格式遵循</code>textmate`,除了：   </p>\n<blockquote>\n</blockquote>\n<p> ‘regular expression replacements’, ‘interpolated shell code’ and ‘transformations’  </p>\n<blockquote>\n</blockquote>\n<p><a href=\"https://manual.macromates.com/en/snippets\" target=\"_blank\" rel=\"noopener\">https://manual.macromates.com/en/snippets</a>  </p>\n<p>你可以按下<code>ctrl+p</code>(快速打开)输入<code>ext install sni</code>,会列出一系列<code>snippet</code>。<br><code>enjoy it :)</code>  </p>\n<h2 id=\"任务：\"><a href=\"#任务：\" class=\"headerlink\" title=\"任务：\"></a>任务：</h2><ul>\n<li>到<a href=\"https://marketplace.visualstudio.com/vscode找最常用的包试一试\" target=\"_blank\" rel=\"noopener\">https://marketplace.visualstudio.com/vscode找最常用的包试一试</a></li>\n<li>学习<code>snippet</code>基本语法，学会自己编写 snippet    </li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>假定你已经阅读完成了<code>EDITOR</code>一章。现在开始来定制<code>vscode</code>。</p>\n<p>两个目的：  </p>\n<ul>\n<li>减少重复工作，把时间花费在有意义的事情上  </li>\n<li>可定制、可扩展、可积累  </li>\n</ul>\n<h2 id=\"主题颜色字体\"><a href=\"#主题颜色字体\" class=\"headerlink\" title=\"主题颜色字体\"></a>主题颜色字体</h2><p><code>File&gt;&gt;Perfences=&gt;corlor theme</code>选择一个舒服的主题，当然也可以按下<code>ctril+p</code>输入<br><code>ext install</code>安装喜欢的主题。字体通过用户配置文件来设置：按下<code>F1</code>输入<code>user</code>选择第一个条目按下回车。<br>左边是默认配置，右边写入自定义配置。</p>\n<p>颜色字体这类属于无关紧要的细节，不需要在这方面浪费过多的时间，接下来说说<code>snippets</code>。</p>\n<h2 id=\"vscode-snippets\"><a href=\"#vscode-snippets\" class=\"headerlink\" title=\"vscode snippets\"></a>vscode snippets</h2><p><code>vscode</code>针对不同的语言有不同的<code>snippets</code>。举个例子,新建一个<code>test.html</code>,输入：</p>\n<blockquote>\n<p>html</p>\n</blockquote>\n<p>按下<code>ctrl+space</code>触发<code>snippets</code>。有两个选项可供选择，<code>html</code>标签以及<code>html</code>模板。<br>选择<code>html模板</code>按下回车你会看到一下子多了很多东西：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span> <span class=\"attr\">lang</span>=<span class=\"string\">\"en\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">meta</span> <span class=\"attr\">charset</span>=<span class=\"string\">\"UTF-8\"</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">href</span>=<span class=\"string\">\"css/style.css\"</span> <span class=\"attr\">rel</span>=<span class=\"string\">\"stylesheet\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>光标默认停留在<code>en</code>的位置，按下<code>TAB</code>会在en、title、以及body之间切换，能这么做归功于<code>vscode</code>的<code>html snippets</code>扩展。<br>项目地址：  </p>\n<blockquote>\n</blockquote>\n<p><a href=\"https://github.com/abusaidm/html-snippets/blob/master/snippets/snippets.json\" target=\"_blank\" rel=\"noopener\">https://github.com/abusaidm/html-snippets/blob/master/snippets/snippets.json</a></p>\n<p>看看<code>snippets.json</code>的实现：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;html5&quot;: &#123;</span><br><span class=\"line\">    &quot;prefix&quot;: &quot;html5&quot;,</span><br><span class=\"line\">    &quot;body&quot;: [</span><br><span class=\"line\">        &quot;&lt;!DOCTYPE html&gt;&quot;,</span><br><span class=\"line\">        &quot;&lt;html lang=\\&quot;$1en\\&quot;&gt;&quot;,</span><br><span class=\"line\">        &quot;\\t&lt;head&gt;&quot;,</span><br><span class=\"line\">        &quot;\\t\\t&lt;title&gt;$2&lt;/title&gt;&quot;,</span><br><span class=\"line\">        &quot;\\t\\t&lt;meta charset=\\&quot;UTF-8\\&quot;&gt;&quot;,</span><br><span class=\"line\">        &quot;\\t\\t&lt;link href=\\&quot;$3css/style.css\\&quot; rel=\\&quot;stylesheet\\&quot;&gt;&quot;,</span><br><span class=\"line\">        &quot;\\t&lt;/head&gt;&quot;,</span><br><span class=\"line\">        &quot;\\t&lt;body&gt;&quot;,</span><br><span class=\"line\">        &quot;\\t$4&quot;,</span><br><span class=\"line\">        &quot;\\t&lt;/body&gt;&quot;,</span><br><span class=\"line\">        &quot;&lt;/html&gt;&quot;</span><br><span class=\"line\">        ],</span><br><span class=\"line\">    &quot;description&quot;: &quot;HTML - Defines a template for a html5 document&quot;,</span><br><span class=\"line\">    &quot;scope&quot;: &quot;text.html&quot;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure></p>\n<p>解释一下这个<code>snippets</code>:  </p>\n<ul>\n<li>“html5”表示该<code>snippets</code>的名称，<code>prefix</code>后面的<code>html5</code>表示触发条件  </li>\n<li><code>body</code>表示<code>snippets</code>内容，是一个数组，数组元素最终会用换行符号链接起来  </li>\n<li><code>\\t</code>表示缩进  </li>\n<li><code>$数字</code>表示光标停留的次序，<code>$1</code>表示第一次停留位置，按下<code>Tab</code>键移到下一个位置  </li>\n</ul>\n<p>实在太方便了，工程师们就应该多动动脑子！！！  </p>\n<p>当然也可以定义自己的<code>snippets</code>，在<code>File=&gt;Perfences=&gt;User Snippets</code>选择语言然后会出现以下代码：  </p>\n<pre><code>/*\n     // Place your snippets for Markdown here. Each snippet is defined under a snippet name and has a prefix, body and \n     // description. The prefix is what is used to trigger the snippet and the body will be expanded and inserted. Possible variables are:\n     // $1, $2 for tab stops, ${id} and ${id:label} and ${1:label} for variables. Variables with the same id are connected.\n     // Example:\n     &quot;Print to console&quot;: {\n        &quot;prefix&quot;: &quot;log&quot;,\n        &quot;body&quot;: [\n            &quot;console.log(&apos;$1&apos;);&quot;,\n            &quot;$2&quot;\n        ],\n        &quot;description&quot;: &quot;Log output to console&quot;\n    }\n*/\n</code></pre><p>以后你可以把自己的<code>snippet</code>放到这里。顺便说一句<code>vscode`</code>snippet<code>格式遵循</code>textmate`,除了：   </p>\n<blockquote>\n</blockquote>\n<p> ‘regular expression replacements’, ‘interpolated shell code’ and ‘transformations’  </p>\n<blockquote>\n</blockquote>\n<p><a href=\"https://manual.macromates.com/en/snippets\" target=\"_blank\" rel=\"noopener\">https://manual.macromates.com/en/snippets</a>  </p>\n<p>你可以按下<code>ctrl+p</code>(快速打开)输入<code>ext install sni</code>,会列出一系列<code>snippet</code>。<br><code>enjoy it :)</code>  </p>\n<h2 id=\"任务：\"><a href=\"#任务：\" class=\"headerlink\" title=\"任务：\"></a>任务：</h2><ul>\n<li>到<a href=\"https://marketplace.visualstudio.com/vscode找最常用的包试一试\" target=\"_blank\" rel=\"noopener\">https://marketplace.visualstudio.com/vscode找最常用的包试一试</a></li>\n<li>学习<code>snippet</code>基本语法，学会自己编写 snippet    </li>\n</ul>\n"},{"title":"从这个劫持页面我学到了什么?","date":"2016-09-07T11:37:24.000Z","_content":"\n\n## 移动端`input`默认样式\n\n清除样式：\n\n```css\nappearance: none;\n-moz-appearance: none;\n-webkit-appearance: none;\n```\n\n`appearance`属性用于给元素指定平台相关的默认样式。有时候这并不是我们想要的效果。\n\n---\n\n## 垂直居中的`flex`实现\n\n\n```html\n<body>\n  <div class=\"main\">\n  </div>\n</body>\n\n```\n\n```css\n  body {\n    display: flex;\n    min-height: 100vh;\n    align-items: center;\n    flex-direction: column;\n    justify-content: ;\n    background: blue;\n  }\n\n  .main {\n    width: 5em;\n    height: 5em;\n    background: gray;\n  }\n\n```\n\n>`flex-direction: column`把`flex`主轴方向设置在竖直方向，`align-items`控制元素在交叉轴线上(水平方向)的对齐方式。`justify-content`属性控制元素在主轴(竖直方向)的对齐方式。简单的实现了垂直和水平居中。\n\n---\n\n## 控制斜体文本\n\n```css\ninput::-webkit-input-placeholder{\n  font-style: italic;\n}\n```\n\n>输入框的`placeholder`文本是斜体字，根据不同平台，需要把`webkit`、`ms`、`o`、`moz`等前缀的伪元素的样式也一起设置。\n\n---","source":"_posts/从这个劫持页面我学到了什么.md","raw":"---\ntitle: 从这个劫持页面我学到了什么?\ndate: 2016-09-07 19:37:24\ntags: h5\ncategories: web\n---\n\n\n## 移动端`input`默认样式\n\n清除样式：\n\n```css\nappearance: none;\n-moz-appearance: none;\n-webkit-appearance: none;\n```\n\n`appearance`属性用于给元素指定平台相关的默认样式。有时候这并不是我们想要的效果。\n\n---\n\n## 垂直居中的`flex`实现\n\n\n```html\n<body>\n  <div class=\"main\">\n  </div>\n</body>\n\n```\n\n```css\n  body {\n    display: flex;\n    min-height: 100vh;\n    align-items: center;\n    flex-direction: column;\n    justify-content: ;\n    background: blue;\n  }\n\n  .main {\n    width: 5em;\n    height: 5em;\n    background: gray;\n  }\n\n```\n\n>`flex-direction: column`把`flex`主轴方向设置在竖直方向，`align-items`控制元素在交叉轴线上(水平方向)的对齐方式。`justify-content`属性控制元素在主轴(竖直方向)的对齐方式。简单的实现了垂直和水平居中。\n\n---\n\n## 控制斜体文本\n\n```css\ninput::-webkit-input-placeholder{\n  font-style: italic;\n}\n```\n\n>输入框的`placeholder`文本是斜体字，根据不同平台，需要把`webkit`、`ms`、`o`、`moz`等前缀的伪元素的样式也一起设置。\n\n---","slug":"从这个劫持页面我学到了什么","published":1,"updated":"2018-07-01T10:30:46.497Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cdz003hy4zvbnz5qgyc","content":"<h2 id=\"移动端input默认样式\"><a href=\"#移动端input默认样式\" class=\"headerlink\" title=\"移动端input默认样式\"></a>移动端<code>input</code>默认样式</h2><p>清除样式：</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">appearance</span>: <span class=\"selector-tag\">none</span>;</span><br><span class=\"line\"><span class=\"selector-tag\">-moz-appearance</span>: <span class=\"selector-tag\">none</span>;</span><br><span class=\"line\"><span class=\"selector-tag\">-webkit-appearance</span>: <span class=\"selector-tag\">none</span>;</span><br></pre></td></tr></table></figure>\n<p><code>appearance</code>属性用于给元素指定平台相关的默认样式。有时候这并不是我们想要的效果。</p>\n<hr>\n<h2 id=\"垂直居中的flex实现\"><a href=\"#垂直居中的flex实现\" class=\"headerlink\" title=\"垂直居中的flex实现\"></a>垂直居中的<code>flex</code>实现</h2><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">\"main\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">body</span> &#123;</span><br><span class=\"line\">  <span class=\"attribute\">display</span>: flex;</span><br><span class=\"line\">  <span class=\"attribute\">min-height</span>: <span class=\"number\">100vh</span>;</span><br><span class=\"line\">  <span class=\"attribute\">align-items</span>: center;</span><br><span class=\"line\">  <span class=\"attribute\">flex-direction</span>: column;</span><br><span class=\"line\">  <span class=\"attribute\">justify-content</span>: ;</span><br><span class=\"line\">  <span class=\"attribute\">background</span>: blue;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.main</span> &#123;</span><br><span class=\"line\">  <span class=\"attribute\">width</span>: <span class=\"number\">5em</span>;</span><br><span class=\"line\">  <span class=\"attribute\">height</span>: <span class=\"number\">5em</span>;</span><br><span class=\"line\">  <span class=\"attribute\">background</span>: gray;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>flex-direction: column</code>把<code>flex</code>主轴方向设置在竖直方向，<code>align-items</code>控制元素在交叉轴线上(水平方向)的对齐方式。<code>justify-content</code>属性控制元素在主轴(竖直方向)的对齐方式。简单的实现了垂直和水平居中。</p>\n</blockquote>\n<hr>\n<h2 id=\"控制斜体文本\"><a href=\"#控制斜体文本\" class=\"headerlink\" title=\"控制斜体文本\"></a>控制斜体文本</h2><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">input</span><span class=\"selector-pseudo\">::-webkit-input-placeholder</span>&#123;</span><br><span class=\"line\">  <span class=\"attribute\">font-style</span>: italic;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>输入框的<code>placeholder</code>文本是斜体字，根据不同平台，需要把<code>webkit</code>、<code>ms</code>、<code>o</code>、<code>moz</code>等前缀的伪元素的样式也一起设置。</p>\n</blockquote>\n<hr>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"移动端input默认样式\"><a href=\"#移动端input默认样式\" class=\"headerlink\" title=\"移动端input默认样式\"></a>移动端<code>input</code>默认样式</h2><p>清除样式：</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">appearance</span>: <span class=\"selector-tag\">none</span>;</span><br><span class=\"line\"><span class=\"selector-tag\">-moz-appearance</span>: <span class=\"selector-tag\">none</span>;</span><br><span class=\"line\"><span class=\"selector-tag\">-webkit-appearance</span>: <span class=\"selector-tag\">none</span>;</span><br></pre></td></tr></table></figure>\n<p><code>appearance</code>属性用于给元素指定平台相关的默认样式。有时候这并不是我们想要的效果。</p>\n<hr>\n<h2 id=\"垂直居中的flex实现\"><a href=\"#垂直居中的flex实现\" class=\"headerlink\" title=\"垂直居中的flex实现\"></a>垂直居中的<code>flex</code>实现</h2><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">\"main\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">body</span> &#123;</span><br><span class=\"line\">  <span class=\"attribute\">display</span>: flex;</span><br><span class=\"line\">  <span class=\"attribute\">min-height</span>: <span class=\"number\">100vh</span>;</span><br><span class=\"line\">  <span class=\"attribute\">align-items</span>: center;</span><br><span class=\"line\">  <span class=\"attribute\">flex-direction</span>: column;</span><br><span class=\"line\">  <span class=\"attribute\">justify-content</span>: ;</span><br><span class=\"line\">  <span class=\"attribute\">background</span>: blue;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.main</span> &#123;</span><br><span class=\"line\">  <span class=\"attribute\">width</span>: <span class=\"number\">5em</span>;</span><br><span class=\"line\">  <span class=\"attribute\">height</span>: <span class=\"number\">5em</span>;</span><br><span class=\"line\">  <span class=\"attribute\">background</span>: gray;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>flex-direction: column</code>把<code>flex</code>主轴方向设置在竖直方向，<code>align-items</code>控制元素在交叉轴线上(水平方向)的对齐方式。<code>justify-content</code>属性控制元素在主轴(竖直方向)的对齐方式。简单的实现了垂直和水平居中。</p>\n</blockquote>\n<hr>\n<h2 id=\"控制斜体文本\"><a href=\"#控制斜体文本\" class=\"headerlink\" title=\"控制斜体文本\"></a>控制斜体文本</h2><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">input</span><span class=\"selector-pseudo\">::-webkit-input-placeholder</span>&#123;</span><br><span class=\"line\">  <span class=\"attribute\">font-style</span>: italic;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>输入框的<code>placeholder</code>文本是斜体字，根据不同平台，需要把<code>webkit</code>、<code>ms</code>、<code>o</code>、<code>moz</code>等前缀的伪元素的样式也一起设置。</p>\n</blockquote>\n<hr>\n"},{"title":"一款在线秒杀游戏的设计","date":"2018-11-01T11:02:20.000Z","_content":"\n\n秒杀的场景常见于在线商户，12306抢火车票等等。它们的特点都是类似，即：在某一个瞬间并发大量请求。而这个请求量如果不加以防范很可能会超过系统的负载能力，使得系统崩溃，影响公司的其他正常业务。\n\n最近公司在做一个游戏项目，游戏的玩法类似于秒杀活动：\n>\"用户投入金币购买算力帮助AI获得算力，构建美丽新世界。游戏时间是有限的，在某个点投入金币获得额外的奖励。\"\n\n### 预估请求量\n\n秒杀活动顾名思义：物品数量有限，而用户数量庞大。首先要做的是预估请求数量，也就是说：预计有多少个用户能真正获得商品。举个例子：某在线商城要进行一个1元秒杀手机的活动，数量200台，每个用户限一台。那么实际成功的最大请求数量也就是200，其余的请求发送到服务器可以统一返回售罄的错误信息。对于这类需求，瓶颈通常在数据库层面。这个时候需要加一个缓存队列。每次用户发送购买请求，先判定缓存的长度，如果小于预估的请求数量则把购买请求入队列：\n\n![server-game1](/img/server-game.png)\n\n\n### 处理正常请求\n\n通过前面一个缓存队列，已经把绝大多数请求抵挡住了。现在要开始处理正常的购买请求。正常请求的处理逻辑基于解耦考虑通常放置在不同的模块。通过一个消息队列来通信。\n\n![server-game2](/img/server-game2.png)\n\n\n### 查询购买状态\n\n由于用户的请求量比较大，而用户往往会不断的刷新页面，查询是否已经抢购到了商品，所以最好通过缓存队列来查询购买的状态，如果购买记录不在队列中，默认已经售罄。\n\n![server-game3](/img/server-game3.png)\n\n\n### 注意事项：\n\n用户请求入缓存队列之后，会给处理购买的模块发送一条消息。在消息队列的选型要看清是`at least once`还是`at most one`或者`exact once`。通常队列实现的都是`at least once`。这个时候要做到处理逻辑必须是可重入的。","source":"_posts/一款在线秒杀游戏的设计.md","raw":"---\ntitle: 一款在线秒杀游戏的设计\ndate: 2018-11-01 19:02:20\ntags:\ncategories: server\n---\n\n\n秒杀的场景常见于在线商户，12306抢火车票等等。它们的特点都是类似，即：在某一个瞬间并发大量请求。而这个请求量如果不加以防范很可能会超过系统的负载能力，使得系统崩溃，影响公司的其他正常业务。\n\n最近公司在做一个游戏项目，游戏的玩法类似于秒杀活动：\n>\"用户投入金币购买算力帮助AI获得算力，构建美丽新世界。游戏时间是有限的，在某个点投入金币获得额外的奖励。\"\n\n### 预估请求量\n\n秒杀活动顾名思义：物品数量有限，而用户数量庞大。首先要做的是预估请求数量，也就是说：预计有多少个用户能真正获得商品。举个例子：某在线商城要进行一个1元秒杀手机的活动，数量200台，每个用户限一台。那么实际成功的最大请求数量也就是200，其余的请求发送到服务器可以统一返回售罄的错误信息。对于这类需求，瓶颈通常在数据库层面。这个时候需要加一个缓存队列。每次用户发送购买请求，先判定缓存的长度，如果小于预估的请求数量则把购买请求入队列：\n\n![server-game1](/img/server-game.png)\n\n\n### 处理正常请求\n\n通过前面一个缓存队列，已经把绝大多数请求抵挡住了。现在要开始处理正常的购买请求。正常请求的处理逻辑基于解耦考虑通常放置在不同的模块。通过一个消息队列来通信。\n\n![server-game2](/img/server-game2.png)\n\n\n### 查询购买状态\n\n由于用户的请求量比较大，而用户往往会不断的刷新页面，查询是否已经抢购到了商品，所以最好通过缓存队列来查询购买的状态，如果购买记录不在队列中，默认已经售罄。\n\n![server-game3](/img/server-game3.png)\n\n\n### 注意事项：\n\n用户请求入缓存队列之后，会给处理购买的模块发送一条消息。在消息队列的选型要看清是`at least once`还是`at most one`或者`exact once`。通常队列实现的都是`at least once`。这个时候要做到处理逻辑必须是可重入的。","slug":"一款在线秒杀游戏的设计","published":1,"updated":"2018-11-01T11:06:20.438Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9ce0003ky4zvvp0qsuon","content":"<p>秒杀的场景常见于在线商户，12306抢火车票等等。它们的特点都是类似，即：在某一个瞬间并发大量请求。而这个请求量如果不加以防范很可能会超过系统的负载能力，使得系统崩溃，影响公司的其他正常业务。</p>\n<p>最近公司在做一个游戏项目，游戏的玩法类似于秒杀活动：</p>\n<blockquote>\n<p>“用户投入金币购买算力帮助AI获得算力，构建美丽新世界。游戏时间是有限的，在某个点投入金币获得额外的奖励。”</p>\n</blockquote>\n<h3 id=\"预估请求量\"><a href=\"#预估请求量\" class=\"headerlink\" title=\"预估请求量\"></a>预估请求量</h3><p>秒杀活动顾名思义：物品数量有限，而用户数量庞大。首先要做的是预估请求数量，也就是说：预计有多少个用户能真正获得商品。举个例子：某在线商城要进行一个1元秒杀手机的活动，数量200台，每个用户限一台。那么实际成功的最大请求数量也就是200，其余的请求发送到服务器可以统一返回售罄的错误信息。对于这类需求，瓶颈通常在数据库层面。这个时候需要加一个缓存队列。每次用户发送购买请求，先判定缓存的长度，如果小于预估的请求数量则把购买请求入队列：</p>\n<p><img src=\"/img/server-game.png\" alt=\"server-game1\"></p>\n<h3 id=\"处理正常请求\"><a href=\"#处理正常请求\" class=\"headerlink\" title=\"处理正常请求\"></a>处理正常请求</h3><p>通过前面一个缓存队列，已经把绝大多数请求抵挡住了。现在要开始处理正常的购买请求。正常请求的处理逻辑基于解耦考虑通常放置在不同的模块。通过一个消息队列来通信。</p>\n<p><img src=\"/img/server-game2.png\" alt=\"server-game2\"></p>\n<h3 id=\"查询购买状态\"><a href=\"#查询购买状态\" class=\"headerlink\" title=\"查询购买状态\"></a>查询购买状态</h3><p>由于用户的请求量比较大，而用户往往会不断的刷新页面，查询是否已经抢购到了商品，所以最好通过缓存队列来查询购买的状态，如果购买记录不在队列中，默认已经售罄。</p>\n<p><img src=\"/img/server-game3.png\" alt=\"server-game3\"></p>\n<h3 id=\"注意事项：\"><a href=\"#注意事项：\" class=\"headerlink\" title=\"注意事项：\"></a>注意事项：</h3><p>用户请求入缓存队列之后，会给处理购买的模块发送一条消息。在消息队列的选型要看清是<code>at least once</code>还是<code>at most one</code>或者<code>exact once</code>。通常队列实现的都是<code>at least once</code>。这个时候要做到处理逻辑必须是可重入的。</p>\n","site":{"data":{}},"excerpt":"","more":"<p>秒杀的场景常见于在线商户，12306抢火车票等等。它们的特点都是类似，即：在某一个瞬间并发大量请求。而这个请求量如果不加以防范很可能会超过系统的负载能力，使得系统崩溃，影响公司的其他正常业务。</p>\n<p>最近公司在做一个游戏项目，游戏的玩法类似于秒杀活动：</p>\n<blockquote>\n<p>“用户投入金币购买算力帮助AI获得算力，构建美丽新世界。游戏时间是有限的，在某个点投入金币获得额外的奖励。”</p>\n</blockquote>\n<h3 id=\"预估请求量\"><a href=\"#预估请求量\" class=\"headerlink\" title=\"预估请求量\"></a>预估请求量</h3><p>秒杀活动顾名思义：物品数量有限，而用户数量庞大。首先要做的是预估请求数量，也就是说：预计有多少个用户能真正获得商品。举个例子：某在线商城要进行一个1元秒杀手机的活动，数量200台，每个用户限一台。那么实际成功的最大请求数量也就是200，其余的请求发送到服务器可以统一返回售罄的错误信息。对于这类需求，瓶颈通常在数据库层面。这个时候需要加一个缓存队列。每次用户发送购买请求，先判定缓存的长度，如果小于预估的请求数量则把购买请求入队列：</p>\n<p><img src=\"/img/server-game.png\" alt=\"server-game1\"></p>\n<h3 id=\"处理正常请求\"><a href=\"#处理正常请求\" class=\"headerlink\" title=\"处理正常请求\"></a>处理正常请求</h3><p>通过前面一个缓存队列，已经把绝大多数请求抵挡住了。现在要开始处理正常的购买请求。正常请求的处理逻辑基于解耦考虑通常放置在不同的模块。通过一个消息队列来通信。</p>\n<p><img src=\"/img/server-game2.png\" alt=\"server-game2\"></p>\n<h3 id=\"查询购买状态\"><a href=\"#查询购买状态\" class=\"headerlink\" title=\"查询购买状态\"></a>查询购买状态</h3><p>由于用户的请求量比较大，而用户往往会不断的刷新页面，查询是否已经抢购到了商品，所以最好通过缓存队列来查询购买的状态，如果购买记录不在队列中，默认已经售罄。</p>\n<p><img src=\"/img/server-game3.png\" alt=\"server-game3\"></p>\n<h3 id=\"注意事项：\"><a href=\"#注意事项：\" class=\"headerlink\" title=\"注意事项：\"></a>注意事项：</h3><p>用户请求入缓存队列之后，会给处理购买的模块发送一条消息。在消息队列的选型要看清是<code>at least once</code>还是<code>at most one</code>或者<code>exact once</code>。通常队列实现的都是<code>at least once</code>。这个时候要做到处理逻辑必须是可重入的。</p>\n"},{"title":"你不知道的box-shadow","date":"2016-09-03T08:34:18.000Z","_content":"\n# box-shadow\n\n`box-shadow`是`CSS3`提出的一个重要属性用于给元素附加一层阴影。基本格式书写：\n\n>box-shadow: h-offset v-offset blur-radius spread\n\n- h-offset: 阴影距离元素水平方向的偏移,允许为负数\n- v-offset: 阴影距离元素垂直方向的偏移,允许为负数\n- blur-radius: 模糊半径\n- spared: 延展半径,允许为负数\n\n---\n\n## 基本使用\n\n{% jsfiddle nkr9vmzL css,result light 100% 400px %}\n\n>在`div`元素周围生成了黑色的阴影，这里我们只用到了三个参数，水平和垂直方向的偏移以及模糊半径。在这个例子中，四个方向的阴影长度大致为`5px`。\n\n### 加上偏移量\n\n{% jsfiddle yzbzvm15 css,result light 100% 400px %}\n\n>水平偏移`2px`垂直偏移`3px`，模糊半径`10px`，这个时候元素在四周依然有阴影存在，我们如何计算阴影的长度呢？答案在于：\n\n- 在顶部看到`7px`的投影(10px - 3px)\n- 在底部看到`13px`的投影(10px + 3px)\n- 在左边看到`8px`的投影(10px - 2px)\n- 在右边看到`12px`的投影(10px + 2px)\n\n---\n\n## 单个方向的投影\n\n知道了阴影半径的计算，那么如何设计一个单个方向的投影呢？这个时候就需要`spared`属性，`spared`属性用于扩大或者缩小投影的尺寸。\n{% jsfiddle uowdjmfe css,result light 100% 400px %}\n\n利用`spread`，可以把需要隐藏的投影缩小，实现呢单边投影的效果。\n\n---\n\n## 邻边投影\n\n把上面的例子稍微修改一下得到右边和下边都为`5px`的投影。\n\n{% jsfiddle 880t7xs3 css,result light 100% 400px %}\n\n---\n\n## 对边投影\n\n`box-shadow`属性允许指定多个阴影，越往后`z-order`越小。我们利用单边投影的方式轻松实现对边投影的效果。\n{% jsfiddle 2e3rqnL7 css,result light 100% 400px %}\n\n---\n\n## 总结\n\n投影实现步骤：\n\n- 在元素的上面，以元素原大小和指定颜色绘制一个矩形\n- 根据`h-offset`、`v-offset`偏移矩形\n- 根据`blur-radius`对元素模糊处理,在元素两边模糊的大小近似于模糊半径的两倍\n- 根据`spread`裁剪投影\n- 把投影和元素叠加的部分切除掉，完成了投影的过程","source":"_posts/你不知道的box-shadow.md","raw":"---\ntitle: 你不知道的box-shadow\ndate: 2016-09-03 16:34:18\ntags: css\ncategories: web\n---\n\n# box-shadow\n\n`box-shadow`是`CSS3`提出的一个重要属性用于给元素附加一层阴影。基本格式书写：\n\n>box-shadow: h-offset v-offset blur-radius spread\n\n- h-offset: 阴影距离元素水平方向的偏移,允许为负数\n- v-offset: 阴影距离元素垂直方向的偏移,允许为负数\n- blur-radius: 模糊半径\n- spared: 延展半径,允许为负数\n\n---\n\n## 基本使用\n\n{% jsfiddle nkr9vmzL css,result light 100% 400px %}\n\n>在`div`元素周围生成了黑色的阴影，这里我们只用到了三个参数，水平和垂直方向的偏移以及模糊半径。在这个例子中，四个方向的阴影长度大致为`5px`。\n\n### 加上偏移量\n\n{% jsfiddle yzbzvm15 css,result light 100% 400px %}\n\n>水平偏移`2px`垂直偏移`3px`，模糊半径`10px`，这个时候元素在四周依然有阴影存在，我们如何计算阴影的长度呢？答案在于：\n\n- 在顶部看到`7px`的投影(10px - 3px)\n- 在底部看到`13px`的投影(10px + 3px)\n- 在左边看到`8px`的投影(10px - 2px)\n- 在右边看到`12px`的投影(10px + 2px)\n\n---\n\n## 单个方向的投影\n\n知道了阴影半径的计算，那么如何设计一个单个方向的投影呢？这个时候就需要`spared`属性，`spared`属性用于扩大或者缩小投影的尺寸。\n{% jsfiddle uowdjmfe css,result light 100% 400px %}\n\n利用`spread`，可以把需要隐藏的投影缩小，实现呢单边投影的效果。\n\n---\n\n## 邻边投影\n\n把上面的例子稍微修改一下得到右边和下边都为`5px`的投影。\n\n{% jsfiddle 880t7xs3 css,result light 100% 400px %}\n\n---\n\n## 对边投影\n\n`box-shadow`属性允许指定多个阴影，越往后`z-order`越小。我们利用单边投影的方式轻松实现对边投影的效果。\n{% jsfiddle 2e3rqnL7 css,result light 100% 400px %}\n\n---\n\n## 总结\n\n投影实现步骤：\n\n- 在元素的上面，以元素原大小和指定颜色绘制一个矩形\n- 根据`h-offset`、`v-offset`偏移矩形\n- 根据`blur-radius`对元素模糊处理,在元素两边模糊的大小近似于模糊半径的两倍\n- 根据`spread`裁剪投影\n- 把投影和元素叠加的部分切除掉，完成了投影的过程","slug":"你不知道的box-shadow","published":1,"updated":"2018-07-01T10:30:46.497Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9ce1003oy4zvannlomg5","content":"<h1 id=\"box-shadow\"><a href=\"#box-shadow\" class=\"headerlink\" title=\"box-shadow\"></a>box-shadow</h1><p><code>box-shadow</code>是<code>CSS3</code>提出的一个重要属性用于给元素附加一层阴影。基本格式书写：</p>\n<blockquote>\n<p>box-shadow: h-offset v-offset blur-radius spread</p>\n</blockquote>\n<ul>\n<li>h-offset: 阴影距离元素水平方向的偏移,允许为负数</li>\n<li>v-offset: 阴影距离元素垂直方向的偏移,允许为负数</li>\n<li>blur-radius: 模糊半径</li>\n<li>spared: 延展半径,允许为负数</li>\n</ul>\n<hr>\n<h2 id=\"基本使用\"><a href=\"#基本使用\" class=\"headerlink\" title=\"基本使用\"></a>基本使用</h2><iframe scrolling=\"no\" width=\"100%\" height=\"400px\" src=\"//jsfiddle.net/nkr9vmzL/embedded/css,result/light\" frameborder=\"0\" allowfullscreen></iframe>\n<blockquote>\n<p>在<code>div</code>元素周围生成了黑色的阴影，这里我们只用到了三个参数，水平和垂直方向的偏移以及模糊半径。在这个例子中，四个方向的阴影长度大致为<code>5px</code>。</p>\n</blockquote>\n<h3 id=\"加上偏移量\"><a href=\"#加上偏移量\" class=\"headerlink\" title=\"加上偏移量\"></a>加上偏移量</h3><iframe scrolling=\"no\" width=\"100%\" height=\"400px\" src=\"//jsfiddle.net/yzbzvm15/embedded/css,result/light\" frameborder=\"0\" allowfullscreen></iframe>\n<blockquote>\n<p>水平偏移<code>2px</code>垂直偏移<code>3px</code>，模糊半径<code>10px</code>，这个时候元素在四周依然有阴影存在，我们如何计算阴影的长度呢？答案在于：</p>\n</blockquote>\n<ul>\n<li>在顶部看到<code>7px</code>的投影(10px - 3px)</li>\n<li>在底部看到<code>13px</code>的投影(10px + 3px)</li>\n<li>在左边看到<code>8px</code>的投影(10px - 2px)</li>\n<li>在右边看到<code>12px</code>的投影(10px + 2px)</li>\n</ul>\n<hr>\n<h2 id=\"单个方向的投影\"><a href=\"#单个方向的投影\" class=\"headerlink\" title=\"单个方向的投影\"></a>单个方向的投影</h2><p>知道了阴影半径的计算，那么如何设计一个单个方向的投影呢？这个时候就需要<code>spared</code>属性，<code>spared</code>属性用于扩大或者缩小投影的尺寸。<br><iframe scrolling=\"no\" width=\"100%\" height=\"400px\" src=\"//jsfiddle.net/uowdjmfe/embedded/css,result/light\" frameborder=\"0\" allowfullscreen></iframe></p>\n<p>利用<code>spread</code>，可以把需要隐藏的投影缩小，实现呢单边投影的效果。</p>\n<hr>\n<h2 id=\"邻边投影\"><a href=\"#邻边投影\" class=\"headerlink\" title=\"邻边投影\"></a>邻边投影</h2><p>把上面的例子稍微修改一下得到右边和下边都为<code>5px</code>的投影。</p>\n<iframe scrolling=\"no\" width=\"100%\" height=\"400px\" src=\"//jsfiddle.net/880t7xs3/embedded/css,result/light\" frameborder=\"0\" allowfullscreen></iframe>\n<hr>\n<h2 id=\"对边投影\"><a href=\"#对边投影\" class=\"headerlink\" title=\"对边投影\"></a>对边投影</h2><p><code>box-shadow</code>属性允许指定多个阴影，越往后<code>z-order</code>越小。我们利用单边投影的方式轻松实现对边投影的效果。<br><iframe scrolling=\"no\" width=\"100%\" height=\"400px\" src=\"//jsfiddle.net/2e3rqnL7/embedded/css,result/light\" frameborder=\"0\" allowfullscreen></iframe></p>\n<hr>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>投影实现步骤：</p>\n<ul>\n<li>在元素的上面，以元素原大小和指定颜色绘制一个矩形</li>\n<li>根据<code>h-offset</code>、<code>v-offset</code>偏移矩形</li>\n<li>根据<code>blur-radius</code>对元素模糊处理,在元素两边模糊的大小近似于模糊半径的两倍</li>\n<li>根据<code>spread</code>裁剪投影</li>\n<li>把投影和元素叠加的部分切除掉，完成了投影的过程</li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"box-shadow\"><a href=\"#box-shadow\" class=\"headerlink\" title=\"box-shadow\"></a>box-shadow</h1><p><code>box-shadow</code>是<code>CSS3</code>提出的一个重要属性用于给元素附加一层阴影。基本格式书写：</p>\n<blockquote>\n<p>box-shadow: h-offset v-offset blur-radius spread</p>\n</blockquote>\n<ul>\n<li>h-offset: 阴影距离元素水平方向的偏移,允许为负数</li>\n<li>v-offset: 阴影距离元素垂直方向的偏移,允许为负数</li>\n<li>blur-radius: 模糊半径</li>\n<li>spared: 延展半径,允许为负数</li>\n</ul>\n<hr>\n<h2 id=\"基本使用\"><a href=\"#基本使用\" class=\"headerlink\" title=\"基本使用\"></a>基本使用</h2><iframe scrolling=\"no\" width=\"100%\" height=\"400px\" src=\"//jsfiddle.net/nkr9vmzL/embedded/css,result/light\" frameborder=\"0\" allowfullscreen></iframe>\n<blockquote>\n<p>在<code>div</code>元素周围生成了黑色的阴影，这里我们只用到了三个参数，水平和垂直方向的偏移以及模糊半径。在这个例子中，四个方向的阴影长度大致为<code>5px</code>。</p>\n</blockquote>\n<h3 id=\"加上偏移量\"><a href=\"#加上偏移量\" class=\"headerlink\" title=\"加上偏移量\"></a>加上偏移量</h3><iframe scrolling=\"no\" width=\"100%\" height=\"400px\" src=\"//jsfiddle.net/yzbzvm15/embedded/css,result/light\" frameborder=\"0\" allowfullscreen></iframe>\n<blockquote>\n<p>水平偏移<code>2px</code>垂直偏移<code>3px</code>，模糊半径<code>10px</code>，这个时候元素在四周依然有阴影存在，我们如何计算阴影的长度呢？答案在于：</p>\n</blockquote>\n<ul>\n<li>在顶部看到<code>7px</code>的投影(10px - 3px)</li>\n<li>在底部看到<code>13px</code>的投影(10px + 3px)</li>\n<li>在左边看到<code>8px</code>的投影(10px - 2px)</li>\n<li>在右边看到<code>12px</code>的投影(10px + 2px)</li>\n</ul>\n<hr>\n<h2 id=\"单个方向的投影\"><a href=\"#单个方向的投影\" class=\"headerlink\" title=\"单个方向的投影\"></a>单个方向的投影</h2><p>知道了阴影半径的计算，那么如何设计一个单个方向的投影呢？这个时候就需要<code>spared</code>属性，<code>spared</code>属性用于扩大或者缩小投影的尺寸。<br><iframe scrolling=\"no\" width=\"100%\" height=\"400px\" src=\"//jsfiddle.net/uowdjmfe/embedded/css,result/light\" frameborder=\"0\" allowfullscreen></iframe></p>\n<p>利用<code>spread</code>，可以把需要隐藏的投影缩小，实现呢单边投影的效果。</p>\n<hr>\n<h2 id=\"邻边投影\"><a href=\"#邻边投影\" class=\"headerlink\" title=\"邻边投影\"></a>邻边投影</h2><p>把上面的例子稍微修改一下得到右边和下边都为<code>5px</code>的投影。</p>\n<iframe scrolling=\"no\" width=\"100%\" height=\"400px\" src=\"//jsfiddle.net/880t7xs3/embedded/css,result/light\" frameborder=\"0\" allowfullscreen></iframe>\n<hr>\n<h2 id=\"对边投影\"><a href=\"#对边投影\" class=\"headerlink\" title=\"对边投影\"></a>对边投影</h2><p><code>box-shadow</code>属性允许指定多个阴影，越往后<code>z-order</code>越小。我们利用单边投影的方式轻松实现对边投影的效果。<br><iframe scrolling=\"no\" width=\"100%\" height=\"400px\" src=\"//jsfiddle.net/2e3rqnL7/embedded/css,result/light\" frameborder=\"0\" allowfullscreen></iframe></p>\n<hr>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>投影实现步骤：</p>\n<ul>\n<li>在元素的上面，以元素原大小和指定颜色绘制一个矩形</li>\n<li>根据<code>h-offset</code>、<code>v-offset</code>偏移矩形</li>\n<li>根据<code>blur-radius</code>对元素模糊处理,在元素两边模糊的大小近似于模糊半径的两倍</li>\n<li>根据<code>spread</code>裁剪投影</li>\n<li>把投影和元素叠加的部分切除掉，完成了投影的过程</li>\n</ul>\n"},{"title":"你不知道的Javascript上卷-阅读笔记","date":"2016-12-08T06:46:41.000Z","_content":"\n# SCOPE&CLOSURES--THIS&OBJECT-PROTOTYPES\n\n---\n\n## 作用域和闭包\n\n### 作用域是什么？\n\n#### *作用域的定义：*\n\n>需要一套良好的规则存储变量，并且之后可以找到这些变量，这套规则被称为作用域。\n\n编译原理基本步骤：\n\n- 词法分析，把代码块分解为词法单元\n- 语法分析，把词法单元转换为抽象语法树AST\n- 代码生成，将AST转换为可执行的代码(机器指令)\n\n对比传统的编译型语言，javascript编译发生在代码执行前的几微妙。javascript引擎用`JIT`来保证性能最佳。\n\n在代码生成的过程中，需要`引擎`、`编译器`、`作用域`三者协作完成。在编译的过程中，引擎会进行`LHS`,`RHS`操作。`RHS`表示取得变量的值，而`LHS`表示获取赋值操作的目标。\n\n#### *作用域嵌套：*\n\n> 引擎从当前执行作用域开始查找变量，如果找不到就会向上一级继续寻找，直到到达最外层作用域。\n\n作用域操作的异常：\n\n> `RHS`操作失败会抛出`ReferenceError`异常，而`LHS`操作没有找到目标变量，如果非严格模式下会创建一个全局变量，严格模式下会抛出`ReferenceError`。如果对`RHS`操作的变量的值进行不合理操作会抛出`TypeError`。\n\n---\n\n### 词法作用域\n\n词法作用域由书写代码时决定，通过一些方法如`eval`、`with`。可以在词法分析器处理之后修改作用域。\n\n在标示符查找的过程中同名的会发生屏蔽，全局变量会自动成为全局对象的属性，因此可以通过`window.a`的形式访问被屏蔽的全局变量。\n\n---\n\n#### 欺骗词法\n\n- eval\n\n把字符串参数当做代码运行，就好像代码原来就是在那个位置。通过这种方式来修改词法作用域。严格模式下`eval`在运行时有自己的词法作用域，意味着其中的声明无法修改所在的作用域。\n\n\n- with\n\n把一个对象处理为一个词法作用域，对象属性被定义为在这个作用域内的词法标示符。块内部的`var`声明会被添加到`with`所处的函数作用域中。\n\n不推荐使用`eval`和`with`：\n\n- 严格模式下禁止使用\n- 无法优化代码(作用域查找优化)\n\n---\n\n### 函数作用域和块作用域\n\n函数作用域分级的好处：\n\n- 隐藏内部实现\n\n- 避免冲突\n\n函数声明不可以是匿名的，函数表达式可以是匿名的。\n\n匿名函数缺点：\n\n- 匿名函数在栈上不会显示出有意义的函数名，调式困难\n\n- 没有函数名，只能通过`argument.callee`调用自身，在严格模式下不可用\n\n- 匿名函数可读行不高\n\n立即执行的函数表达式\n\n``` javascript\n\n(function foo() {\n  var a = 3;\n  console.log(a);\n})();\n\n```\n\n第一个括号用于把函数变成一个表达式，第二个括号用于执行这个函数。\n\nIIFE的作用：\n\n- 把它当做函数调用，可以传入参数\n\n- 解决`undefined`标示符默认值被覆盖问题\n\n- 倒置代码的运行顺序，`UMD`模式\n\n\n创建块作用域的方法：\n\n- with\n\n\n- try/catch\n\n`catch`分句会创建一个块作用域，其中声明的变量仅仅在`catch`内部有效。\n\n- let\n\n`es6`新语法关键字，`let`定义的变量不会在块作用域中进行提升。\n\n- const\n`es6`新语法关键字，`const`同样可以创建块作用域变量，其值是固定的。\n\n---\n\n### 提升\n\n>包括变量和函数在内的所有声明都会在任何代码被执行前首先被处理（编译阶段）。\n\n规则：\n\n- 只有声明会被提升、赋值不会\n- 函数表达式不会被提升\n- 函数首先被提升，然后才是变量\n- 重复声明被忽略\n\n---\n\n### 闭包\n\n>通过任何手段，将内部函数传递到所在的词法作用域以外，它都会持有对原始定义作用域的引用，无论在何处执行这个函数都会使用闭包。\n\n循环和闭包问题：\n>循环迭代的过程中引用同一个变量。\n\n解决办法：\n\n- 1、IIFE\n\n 新建一个块作用域，并且每次都把变量传递进来。\n\n- 2、let\n \n`for`循环头部的`let`声明有一个特殊行为： `变量在循环过程中不止声明一次。`\n\n\n#### 利用闭包构建模块\n\n模块模式的条件：\n\n- 必须有外部封闭的函数，该函数必须至少调用一次。\n\n- 封闭函数必须至少放回一个内部函数，这样内部函数才能在私有作用域内形成闭包，并且可以访问或者修改私有的状态。\n\n\n#### 箭头函数与词法作用域\n\n好处：\n\n- 用当前的词法作用域覆盖了`this`本来的值。\n\n问题：\n\n- 它是匿名的而非具名\n\n---\n\n## this和对象原型\n\n### `this`是什么\n\n>this既不指向自身，也不指向函数的词法作用域，`this`实际上是在函数调用时发生的绑定。\n\n---\n\n### 全面解析`this`\n\n`this`的绑定规则：\n\n- 默认绑定\n\n`this`指向全局对象。严格模式下无法使用（函数本身是严格模式）。\n\n- 隐式绑定\n\n对象属性引用炼只有最后一层会影响调用位置。\n\n- 显式绑定\n\n通过`apply`、`call`、`bind`来完成。\n\n- new 绑定\n\n`new`调用一个函数发生的操作：\n\n- 1、创建一个全新对象\n- 2、这个新对象会被执行[[原型]]连接\n- 3、这个新对象会绑定到函数调用的`this`\n- 4、如果这个函数没有放回其他对象，那么`new`表达式中的函数调用会自动返回这个新对象。\n\n绑定优先级：\n\n>默认绑定优先级最低，显式绑定优先级别高于隐式绑定。`new`绑定高于显式绑定。\n\n### 对象\n\njs基本类型：\n\n- string\n- number\n- boolean\n- null\n- undefined\n- object\n\n`null`由于语言本身的`BUG`执行`typeof`会返回`object`。\n\n内值对象子类型：\n\n- String\n- Number\n- Function\n- Object\n- Array\n- Boolean\n- Date\n- RegExp\n- Error\n\n#### 属性描述符号：\n\n- writable\n\n决定是否可以修改属性的值\n\n- configurable\n\n决定是否可以用`defineProperty`修改属性。`configurable:false`的属性，禁止删除。\n\n- enumerable\n\n决定是否出现在对象属性的枚举中。\n\n#### 不变性\n\n- 1、结合使用writable和configure\n\n- 2、禁止扩展\n\nObject.preventExtensions\n\n- 3、密封\n\nObject.seal=Object.preventExtensions + configurable:false\n但是可以修改属性\n\n- 4、冻结\n\nObject.freeze=Object.seal + writable:false;\n\n#### 属性的存在性\n\n- 1、in\n\n检查是否在元素本身，以及原型链中。\n\n- 2、hasOwnProperty\n\n检查是否在对象本身。\n\n- 3、peopertyIsEnumerable\n\n检查属性名是否直接存在于对象中，而且`enumerable:true`。\n\n- 4、Object.keys\n\n返回一个对象本身所有可以枚举的属性\n\n- 5、Object.getOwnPropertyNames\n\n返回对象包含的所有属性(不含原型链)，不论是否可以枚举。\n\n\n#### 遍历\n\n- 1、for in\n\n遍历对象可以枚举的属性，包含原型链。\n\n- 2、for\n\n遍历数组\n\n- 3、forEach\\some\\every\n\nES5添加的方法，用于遍历数组。\n\n- 4、for..of\n\n通过迭代器(Symbol.iterator)遍历数组或者对象。\n\n\n### 原型\n\n#### Object.prototype\n\n>所有的[[prototype]]最终指向`Object.prototype`。其提供了一些方法，如`valueOf`等等。\n\n`myObject.foo = \"bar\"`出现的情况：\n\n- 1、[[prototype]]存在`foo`,并且可以写，那么会在myObject新建一个`foo`属性。\n\n- 2、[[prototype]]存在`foo`,并且不可以写，严格模式报出错误。\n\n- 3、[[prototype]]存在`foo`且是一个`setter`,那就一定会调用这个`setter`,`foo`不被添加，而且调用这个`setter`。\n\n\n#### 基本原型关系：\n\n```javascript\n\nfunction Foo() {\n\n}\n\nvar foo = new Foo();\n\nFoo.prototype.__proto__ == Object.prototype\nFunction.prototype.__proto__ == Object.prototype\nArray.__proto__ == Function.prototype\nFoo.__proto__ == Function.prototype\nfoo.__proto__ == Foo.prototype\n\nFoo.constructor == Function\nfoo.constructor == Foo\n\n```\n\n","source":"_posts/你不知道的Javascript上卷-阅读笔记.md","raw":"---\ntitle: 你不知道的Javascript上卷-阅读笔记\ndate: 2016-12-08 14:46:41\ntags: javascript\ncategories: web\n---\n\n# SCOPE&CLOSURES--THIS&OBJECT-PROTOTYPES\n\n---\n\n## 作用域和闭包\n\n### 作用域是什么？\n\n#### *作用域的定义：*\n\n>需要一套良好的规则存储变量，并且之后可以找到这些变量，这套规则被称为作用域。\n\n编译原理基本步骤：\n\n- 词法分析，把代码块分解为词法单元\n- 语法分析，把词法单元转换为抽象语法树AST\n- 代码生成，将AST转换为可执行的代码(机器指令)\n\n对比传统的编译型语言，javascript编译发生在代码执行前的几微妙。javascript引擎用`JIT`来保证性能最佳。\n\n在代码生成的过程中，需要`引擎`、`编译器`、`作用域`三者协作完成。在编译的过程中，引擎会进行`LHS`,`RHS`操作。`RHS`表示取得变量的值，而`LHS`表示获取赋值操作的目标。\n\n#### *作用域嵌套：*\n\n> 引擎从当前执行作用域开始查找变量，如果找不到就会向上一级继续寻找，直到到达最外层作用域。\n\n作用域操作的异常：\n\n> `RHS`操作失败会抛出`ReferenceError`异常，而`LHS`操作没有找到目标变量，如果非严格模式下会创建一个全局变量，严格模式下会抛出`ReferenceError`。如果对`RHS`操作的变量的值进行不合理操作会抛出`TypeError`。\n\n---\n\n### 词法作用域\n\n词法作用域由书写代码时决定，通过一些方法如`eval`、`with`。可以在词法分析器处理之后修改作用域。\n\n在标示符查找的过程中同名的会发生屏蔽，全局变量会自动成为全局对象的属性，因此可以通过`window.a`的形式访问被屏蔽的全局变量。\n\n---\n\n#### 欺骗词法\n\n- eval\n\n把字符串参数当做代码运行，就好像代码原来就是在那个位置。通过这种方式来修改词法作用域。严格模式下`eval`在运行时有自己的词法作用域，意味着其中的声明无法修改所在的作用域。\n\n\n- with\n\n把一个对象处理为一个词法作用域，对象属性被定义为在这个作用域内的词法标示符。块内部的`var`声明会被添加到`with`所处的函数作用域中。\n\n不推荐使用`eval`和`with`：\n\n- 严格模式下禁止使用\n- 无法优化代码(作用域查找优化)\n\n---\n\n### 函数作用域和块作用域\n\n函数作用域分级的好处：\n\n- 隐藏内部实现\n\n- 避免冲突\n\n函数声明不可以是匿名的，函数表达式可以是匿名的。\n\n匿名函数缺点：\n\n- 匿名函数在栈上不会显示出有意义的函数名，调式困难\n\n- 没有函数名，只能通过`argument.callee`调用自身，在严格模式下不可用\n\n- 匿名函数可读行不高\n\n立即执行的函数表达式\n\n``` javascript\n\n(function foo() {\n  var a = 3;\n  console.log(a);\n})();\n\n```\n\n第一个括号用于把函数变成一个表达式，第二个括号用于执行这个函数。\n\nIIFE的作用：\n\n- 把它当做函数调用，可以传入参数\n\n- 解决`undefined`标示符默认值被覆盖问题\n\n- 倒置代码的运行顺序，`UMD`模式\n\n\n创建块作用域的方法：\n\n- with\n\n\n- try/catch\n\n`catch`分句会创建一个块作用域，其中声明的变量仅仅在`catch`内部有效。\n\n- let\n\n`es6`新语法关键字，`let`定义的变量不会在块作用域中进行提升。\n\n- const\n`es6`新语法关键字，`const`同样可以创建块作用域变量，其值是固定的。\n\n---\n\n### 提升\n\n>包括变量和函数在内的所有声明都会在任何代码被执行前首先被处理（编译阶段）。\n\n规则：\n\n- 只有声明会被提升、赋值不会\n- 函数表达式不会被提升\n- 函数首先被提升，然后才是变量\n- 重复声明被忽略\n\n---\n\n### 闭包\n\n>通过任何手段，将内部函数传递到所在的词法作用域以外，它都会持有对原始定义作用域的引用，无论在何处执行这个函数都会使用闭包。\n\n循环和闭包问题：\n>循环迭代的过程中引用同一个变量。\n\n解决办法：\n\n- 1、IIFE\n\n 新建一个块作用域，并且每次都把变量传递进来。\n\n- 2、let\n \n`for`循环头部的`let`声明有一个特殊行为： `变量在循环过程中不止声明一次。`\n\n\n#### 利用闭包构建模块\n\n模块模式的条件：\n\n- 必须有外部封闭的函数，该函数必须至少调用一次。\n\n- 封闭函数必须至少放回一个内部函数，这样内部函数才能在私有作用域内形成闭包，并且可以访问或者修改私有的状态。\n\n\n#### 箭头函数与词法作用域\n\n好处：\n\n- 用当前的词法作用域覆盖了`this`本来的值。\n\n问题：\n\n- 它是匿名的而非具名\n\n---\n\n## this和对象原型\n\n### `this`是什么\n\n>this既不指向自身，也不指向函数的词法作用域，`this`实际上是在函数调用时发生的绑定。\n\n---\n\n### 全面解析`this`\n\n`this`的绑定规则：\n\n- 默认绑定\n\n`this`指向全局对象。严格模式下无法使用（函数本身是严格模式）。\n\n- 隐式绑定\n\n对象属性引用炼只有最后一层会影响调用位置。\n\n- 显式绑定\n\n通过`apply`、`call`、`bind`来完成。\n\n- new 绑定\n\n`new`调用一个函数发生的操作：\n\n- 1、创建一个全新对象\n- 2、这个新对象会被执行[[原型]]连接\n- 3、这个新对象会绑定到函数调用的`this`\n- 4、如果这个函数没有放回其他对象，那么`new`表达式中的函数调用会自动返回这个新对象。\n\n绑定优先级：\n\n>默认绑定优先级最低，显式绑定优先级别高于隐式绑定。`new`绑定高于显式绑定。\n\n### 对象\n\njs基本类型：\n\n- string\n- number\n- boolean\n- null\n- undefined\n- object\n\n`null`由于语言本身的`BUG`执行`typeof`会返回`object`。\n\n内值对象子类型：\n\n- String\n- Number\n- Function\n- Object\n- Array\n- Boolean\n- Date\n- RegExp\n- Error\n\n#### 属性描述符号：\n\n- writable\n\n决定是否可以修改属性的值\n\n- configurable\n\n决定是否可以用`defineProperty`修改属性。`configurable:false`的属性，禁止删除。\n\n- enumerable\n\n决定是否出现在对象属性的枚举中。\n\n#### 不变性\n\n- 1、结合使用writable和configure\n\n- 2、禁止扩展\n\nObject.preventExtensions\n\n- 3、密封\n\nObject.seal=Object.preventExtensions + configurable:false\n但是可以修改属性\n\n- 4、冻结\n\nObject.freeze=Object.seal + writable:false;\n\n#### 属性的存在性\n\n- 1、in\n\n检查是否在元素本身，以及原型链中。\n\n- 2、hasOwnProperty\n\n检查是否在对象本身。\n\n- 3、peopertyIsEnumerable\n\n检查属性名是否直接存在于对象中，而且`enumerable:true`。\n\n- 4、Object.keys\n\n返回一个对象本身所有可以枚举的属性\n\n- 5、Object.getOwnPropertyNames\n\n返回对象包含的所有属性(不含原型链)，不论是否可以枚举。\n\n\n#### 遍历\n\n- 1、for in\n\n遍历对象可以枚举的属性，包含原型链。\n\n- 2、for\n\n遍历数组\n\n- 3、forEach\\some\\every\n\nES5添加的方法，用于遍历数组。\n\n- 4、for..of\n\n通过迭代器(Symbol.iterator)遍历数组或者对象。\n\n\n### 原型\n\n#### Object.prototype\n\n>所有的[[prototype]]最终指向`Object.prototype`。其提供了一些方法，如`valueOf`等等。\n\n`myObject.foo = \"bar\"`出现的情况：\n\n- 1、[[prototype]]存在`foo`,并且可以写，那么会在myObject新建一个`foo`属性。\n\n- 2、[[prototype]]存在`foo`,并且不可以写，严格模式报出错误。\n\n- 3、[[prototype]]存在`foo`且是一个`setter`,那就一定会调用这个`setter`,`foo`不被添加，而且调用这个`setter`。\n\n\n#### 基本原型关系：\n\n```javascript\n\nfunction Foo() {\n\n}\n\nvar foo = new Foo();\n\nFoo.prototype.__proto__ == Object.prototype\nFunction.prototype.__proto__ == Object.prototype\nArray.__proto__ == Function.prototype\nFoo.__proto__ == Function.prototype\nfoo.__proto__ == Foo.prototype\n\nFoo.constructor == Function\nfoo.constructor == Foo\n\n```\n\n","slug":"你不知道的Javascript上卷-阅读笔记","published":1,"updated":"2018-07-01T10:30:46.497Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9ce3003qy4zveyxmf22t","content":"<h1 id=\"SCOPE-amp-CLOSURES–THIS-amp-OBJECT-PROTOTYPES\"><a href=\"#SCOPE-amp-CLOSURES–THIS-amp-OBJECT-PROTOTYPES\" class=\"headerlink\" title=\"SCOPE&amp;CLOSURES–THIS&amp;OBJECT-PROTOTYPES\"></a>SCOPE&amp;CLOSURES–THIS&amp;OBJECT-PROTOTYPES</h1><hr>\n<h2 id=\"作用域和闭包\"><a href=\"#作用域和闭包\" class=\"headerlink\" title=\"作用域和闭包\"></a>作用域和闭包</h2><h3 id=\"作用域是什么？\"><a href=\"#作用域是什么？\" class=\"headerlink\" title=\"作用域是什么？\"></a>作用域是什么？</h3><h4 id=\"作用域的定义：\"><a href=\"#作用域的定义：\" class=\"headerlink\" title=\"作用域的定义：\"></a><em>作用域的定义：</em></h4><blockquote>\n<p>需要一套良好的规则存储变量，并且之后可以找到这些变量，这套规则被称为作用域。</p>\n</blockquote>\n<p>编译原理基本步骤：</p>\n<ul>\n<li>词法分析，把代码块分解为词法单元</li>\n<li>语法分析，把词法单元转换为抽象语法树AST</li>\n<li>代码生成，将AST转换为可执行的代码(机器指令)</li>\n</ul>\n<p>对比传统的编译型语言，javascript编译发生在代码执行前的几微妙。javascript引擎用<code>JIT</code>来保证性能最佳。</p>\n<p>在代码生成的过程中，需要<code>引擎</code>、<code>编译器</code>、<code>作用域</code>三者协作完成。在编译的过程中，引擎会进行<code>LHS</code>,<code>RHS</code>操作。<code>RHS</code>表示取得变量的值，而<code>LHS</code>表示获取赋值操作的目标。</p>\n<h4 id=\"作用域嵌套：\"><a href=\"#作用域嵌套：\" class=\"headerlink\" title=\"作用域嵌套：\"></a><em>作用域嵌套：</em></h4><blockquote>\n<p>引擎从当前执行作用域开始查找变量，如果找不到就会向上一级继续寻找，直到到达最外层作用域。</p>\n</blockquote>\n<p>作用域操作的异常：</p>\n<blockquote>\n<p><code>RHS</code>操作失败会抛出<code>ReferenceError</code>异常，而<code>LHS</code>操作没有找到目标变量，如果非严格模式下会创建一个全局变量，严格模式下会抛出<code>ReferenceError</code>。如果对<code>RHS</code>操作的变量的值进行不合理操作会抛出<code>TypeError</code>。</p>\n</blockquote>\n<hr>\n<h3 id=\"词法作用域\"><a href=\"#词法作用域\" class=\"headerlink\" title=\"词法作用域\"></a>词法作用域</h3><p>词法作用域由书写代码时决定，通过一些方法如<code>eval</code>、<code>with</code>。可以在词法分析器处理之后修改作用域。</p>\n<p>在标示符查找的过程中同名的会发生屏蔽，全局变量会自动成为全局对象的属性，因此可以通过<code>window.a</code>的形式访问被屏蔽的全局变量。</p>\n<hr>\n<h4 id=\"欺骗词法\"><a href=\"#欺骗词法\" class=\"headerlink\" title=\"欺骗词法\"></a>欺骗词法</h4><ul>\n<li>eval</li>\n</ul>\n<p>把字符串参数当做代码运行，就好像代码原来就是在那个位置。通过这种方式来修改词法作用域。严格模式下<code>eval</code>在运行时有自己的词法作用域，意味着其中的声明无法修改所在的作用域。</p>\n<ul>\n<li>with</li>\n</ul>\n<p>把一个对象处理为一个词法作用域，对象属性被定义为在这个作用域内的词法标示符。块内部的<code>var</code>声明会被添加到<code>with</code>所处的函数作用域中。</p>\n<p>不推荐使用<code>eval</code>和<code>with</code>：</p>\n<ul>\n<li>严格模式下禁止使用</li>\n<li>无法优化代码(作用域查找优化)</li>\n</ul>\n<hr>\n<h3 id=\"函数作用域和块作用域\"><a href=\"#函数作用域和块作用域\" class=\"headerlink\" title=\"函数作用域和块作用域\"></a>函数作用域和块作用域</h3><p>函数作用域分级的好处：</p>\n<ul>\n<li><p>隐藏内部实现</p>\n</li>\n<li><p>避免冲突</p>\n</li>\n</ul>\n<p>函数声明不可以是匿名的，函数表达式可以是匿名的。</p>\n<p>匿名函数缺点：</p>\n<ul>\n<li><p>匿名函数在栈上不会显示出有意义的函数名，调式困难</p>\n</li>\n<li><p>没有函数名，只能通过<code>argument.callee</code>调用自身，在严格模式下不可用</p>\n</li>\n<li><p>匿名函数可读行不高</p>\n</li>\n</ul>\n<p>立即执行的函数表达式</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">(<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">foo</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> a = <span class=\"number\">3</span>;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(a);</span><br><span class=\"line\">&#125;)();</span><br></pre></td></tr></table></figure>\n<p>第一个括号用于把函数变成一个表达式，第二个括号用于执行这个函数。</p>\n<p>IIFE的作用：</p>\n<ul>\n<li><p>把它当做函数调用，可以传入参数</p>\n</li>\n<li><p>解决<code>undefined</code>标示符默认值被覆盖问题</p>\n</li>\n<li><p>倒置代码的运行顺序，<code>UMD</code>模式</p>\n</li>\n</ul>\n<p>创建块作用域的方法：</p>\n<ul>\n<li>with</li>\n</ul>\n<ul>\n<li>try/catch</li>\n</ul>\n<p><code>catch</code>分句会创建一个块作用域，其中声明的变量仅仅在<code>catch</code>内部有效。</p>\n<ul>\n<li>let</li>\n</ul>\n<p><code>es6</code>新语法关键字，<code>let</code>定义的变量不会在块作用域中进行提升。</p>\n<ul>\n<li>const<br><code>es6</code>新语法关键字，<code>const</code>同样可以创建块作用域变量，其值是固定的。</li>\n</ul>\n<hr>\n<h3 id=\"提升\"><a href=\"#提升\" class=\"headerlink\" title=\"提升\"></a>提升</h3><blockquote>\n<p>包括变量和函数在内的所有声明都会在任何代码被执行前首先被处理（编译阶段）。</p>\n</blockquote>\n<p>规则：</p>\n<ul>\n<li>只有声明会被提升、赋值不会</li>\n<li>函数表达式不会被提升</li>\n<li>函数首先被提升，然后才是变量</li>\n<li>重复声明被忽略</li>\n</ul>\n<hr>\n<h3 id=\"闭包\"><a href=\"#闭包\" class=\"headerlink\" title=\"闭包\"></a>闭包</h3><blockquote>\n<p>通过任何手段，将内部函数传递到所在的词法作用域以外，它都会持有对原始定义作用域的引用，无论在何处执行这个函数都会使用闭包。</p>\n</blockquote>\n<p>循环和闭包问题：</p>\n<blockquote>\n<p>循环迭代的过程中引用同一个变量。</p>\n</blockquote>\n<p>解决办法：</p>\n<ul>\n<li><p>1、IIFE</p>\n<p>新建一个块作用域，并且每次都把变量传递进来。</p>\n</li>\n<li><p>2、let</p>\n</li>\n</ul>\n<p><code>for</code>循环头部的<code>let</code>声明有一个特殊行为： <code>变量在循环过程中不止声明一次。</code></p>\n<h4 id=\"利用闭包构建模块\"><a href=\"#利用闭包构建模块\" class=\"headerlink\" title=\"利用闭包构建模块\"></a>利用闭包构建模块</h4><p>模块模式的条件：</p>\n<ul>\n<li><p>必须有外部封闭的函数，该函数必须至少调用一次。</p>\n</li>\n<li><p>封闭函数必须至少放回一个内部函数，这样内部函数才能在私有作用域内形成闭包，并且可以访问或者修改私有的状态。</p>\n</li>\n</ul>\n<h4 id=\"箭头函数与词法作用域\"><a href=\"#箭头函数与词法作用域\" class=\"headerlink\" title=\"箭头函数与词法作用域\"></a>箭头函数与词法作用域</h4><p>好处：</p>\n<ul>\n<li>用当前的词法作用域覆盖了<code>this</code>本来的值。</li>\n</ul>\n<p>问题：</p>\n<ul>\n<li>它是匿名的而非具名</li>\n</ul>\n<hr>\n<h2 id=\"this和对象原型\"><a href=\"#this和对象原型\" class=\"headerlink\" title=\"this和对象原型\"></a>this和对象原型</h2><h3 id=\"this是什么\"><a href=\"#this是什么\" class=\"headerlink\" title=\"this是什么\"></a><code>this</code>是什么</h3><blockquote>\n<p>this既不指向自身，也不指向函数的词法作用域，<code>this</code>实际上是在函数调用时发生的绑定。</p>\n</blockquote>\n<hr>\n<h3 id=\"全面解析this\"><a href=\"#全面解析this\" class=\"headerlink\" title=\"全面解析this\"></a>全面解析<code>this</code></h3><p><code>this</code>的绑定规则：</p>\n<ul>\n<li>默认绑定</li>\n</ul>\n<p><code>this</code>指向全局对象。严格模式下无法使用（函数本身是严格模式）。</p>\n<ul>\n<li>隐式绑定</li>\n</ul>\n<p>对象属性引用炼只有最后一层会影响调用位置。</p>\n<ul>\n<li>显式绑定</li>\n</ul>\n<p>通过<code>apply</code>、<code>call</code>、<code>bind</code>来完成。</p>\n<ul>\n<li>new 绑定</li>\n</ul>\n<p><code>new</code>调用一个函数发生的操作：</p>\n<ul>\n<li>1、创建一个全新对象</li>\n<li>2、这个新对象会被执行[[原型]]连接</li>\n<li>3、这个新对象会绑定到函数调用的<code>this</code></li>\n<li>4、如果这个函数没有放回其他对象，那么<code>new</code>表达式中的函数调用会自动返回这个新对象。</li>\n</ul>\n<p>绑定优先级：</p>\n<blockquote>\n<p>默认绑定优先级最低，显式绑定优先级别高于隐式绑定。<code>new</code>绑定高于显式绑定。</p>\n</blockquote>\n<h3 id=\"对象\"><a href=\"#对象\" class=\"headerlink\" title=\"对象\"></a>对象</h3><p>js基本类型：</p>\n<ul>\n<li>string</li>\n<li>number</li>\n<li>boolean</li>\n<li>null</li>\n<li>undefined</li>\n<li>object</li>\n</ul>\n<p><code>null</code>由于语言本身的<code>BUG</code>执行<code>typeof</code>会返回<code>object</code>。</p>\n<p>内值对象子类型：</p>\n<ul>\n<li>String</li>\n<li>Number</li>\n<li>Function</li>\n<li>Object</li>\n<li>Array</li>\n<li>Boolean</li>\n<li>Date</li>\n<li>RegExp</li>\n<li>Error</li>\n</ul>\n<h4 id=\"属性描述符号：\"><a href=\"#属性描述符号：\" class=\"headerlink\" title=\"属性描述符号：\"></a>属性描述符号：</h4><ul>\n<li>writable</li>\n</ul>\n<p>决定是否可以修改属性的值</p>\n<ul>\n<li>configurable</li>\n</ul>\n<p>决定是否可以用<code>defineProperty</code>修改属性。<code>configurable:false</code>的属性，禁止删除。</p>\n<ul>\n<li>enumerable</li>\n</ul>\n<p>决定是否出现在对象属性的枚举中。</p>\n<h4 id=\"不变性\"><a href=\"#不变性\" class=\"headerlink\" title=\"不变性\"></a>不变性</h4><ul>\n<li><p>1、结合使用writable和configure</p>\n</li>\n<li><p>2、禁止扩展</p>\n</li>\n</ul>\n<p>Object.preventExtensions</p>\n<ul>\n<li>3、密封</li>\n</ul>\n<p>Object.seal=Object.preventExtensions + configurable:false<br>但是可以修改属性</p>\n<ul>\n<li>4、冻结</li>\n</ul>\n<p>Object.freeze=Object.seal + writable:false;</p>\n<h4 id=\"属性的存在性\"><a href=\"#属性的存在性\" class=\"headerlink\" title=\"属性的存在性\"></a>属性的存在性</h4><ul>\n<li>1、in</li>\n</ul>\n<p>检查是否在元素本身，以及原型链中。</p>\n<ul>\n<li>2、hasOwnProperty</li>\n</ul>\n<p>检查是否在对象本身。</p>\n<ul>\n<li>3、peopertyIsEnumerable</li>\n</ul>\n<p>检查属性名是否直接存在于对象中，而且<code>enumerable:true</code>。</p>\n<ul>\n<li>4、Object.keys</li>\n</ul>\n<p>返回一个对象本身所有可以枚举的属性</p>\n<ul>\n<li>5、Object.getOwnPropertyNames</li>\n</ul>\n<p>返回对象包含的所有属性(不含原型链)，不论是否可以枚举。</p>\n<h4 id=\"遍历\"><a href=\"#遍历\" class=\"headerlink\" title=\"遍历\"></a>遍历</h4><ul>\n<li>1、for in</li>\n</ul>\n<p>遍历对象可以枚举的属性，包含原型链。</p>\n<ul>\n<li>2、for</li>\n</ul>\n<p>遍历数组</p>\n<ul>\n<li>3、forEach\\some\\every</li>\n</ul>\n<p>ES5添加的方法，用于遍历数组。</p>\n<ul>\n<li>4、for..of</li>\n</ul>\n<p>通过迭代器(Symbol.iterator)遍历数组或者对象。</p>\n<h3 id=\"原型\"><a href=\"#原型\" class=\"headerlink\" title=\"原型\"></a>原型</h3><h4 id=\"Object-prototype\"><a href=\"#Object-prototype\" class=\"headerlink\" title=\"Object.prototype\"></a>Object.prototype</h4><blockquote>\n<p>所有的[[prototype]]最终指向<code>Object.prototype</code>。其提供了一些方法，如<code>valueOf</code>等等。</p>\n</blockquote>\n<p><code>myObject.foo = &quot;bar&quot;</code>出现的情况：</p>\n<ul>\n<li><p>1、[[prototype]]存在<code>foo</code>,并且可以写，那么会在myObject新建一个<code>foo</code>属性。</p>\n</li>\n<li><p>2、[[prototype]]存在<code>foo</code>,并且不可以写，严格模式报出错误。</p>\n</li>\n<li><p>3、[[prototype]]存在<code>foo</code>且是一个<code>setter</code>,那就一定会调用这个<code>setter</code>,<code>foo</code>不被添加，而且调用这个<code>setter</code>。</p>\n</li>\n</ul>\n<h4 id=\"基本原型关系：\"><a href=\"#基本原型关系：\" class=\"headerlink\" title=\"基本原型关系：\"></a>基本原型关系：</h4><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">Foo</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> foo = <span class=\"keyword\">new</span> Foo();</span><br><span class=\"line\"></span><br><span class=\"line\">Foo.prototype.__proto__ == <span class=\"built_in\">Object</span>.prototype</span><br><span class=\"line\"><span class=\"built_in\">Function</span>.prototype.__proto__ == <span class=\"built_in\">Object</span>.prototype</span><br><span class=\"line\"><span class=\"built_in\">Array</span>.__proto__ == <span class=\"built_in\">Function</span>.prototype</span><br><span class=\"line\">Foo.__proto__ == <span class=\"built_in\">Function</span>.prototype</span><br><span class=\"line\">foo.__proto__ == Foo.prototype</span><br><span class=\"line\"></span><br><span class=\"line\">Foo.constructor == <span class=\"built_in\">Function</span></span><br><span class=\"line\">foo.constructor == Foo</span><br></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"SCOPE-amp-CLOSURES–THIS-amp-OBJECT-PROTOTYPES\"><a href=\"#SCOPE-amp-CLOSURES–THIS-amp-OBJECT-PROTOTYPES\" class=\"headerlink\" title=\"SCOPE&amp;CLOSURES–THIS&amp;OBJECT-PROTOTYPES\"></a>SCOPE&amp;CLOSURES–THIS&amp;OBJECT-PROTOTYPES</h1><hr>\n<h2 id=\"作用域和闭包\"><a href=\"#作用域和闭包\" class=\"headerlink\" title=\"作用域和闭包\"></a>作用域和闭包</h2><h3 id=\"作用域是什么？\"><a href=\"#作用域是什么？\" class=\"headerlink\" title=\"作用域是什么？\"></a>作用域是什么？</h3><h4 id=\"作用域的定义：\"><a href=\"#作用域的定义：\" class=\"headerlink\" title=\"作用域的定义：\"></a><em>作用域的定义：</em></h4><blockquote>\n<p>需要一套良好的规则存储变量，并且之后可以找到这些变量，这套规则被称为作用域。</p>\n</blockquote>\n<p>编译原理基本步骤：</p>\n<ul>\n<li>词法分析，把代码块分解为词法单元</li>\n<li>语法分析，把词法单元转换为抽象语法树AST</li>\n<li>代码生成，将AST转换为可执行的代码(机器指令)</li>\n</ul>\n<p>对比传统的编译型语言，javascript编译发生在代码执行前的几微妙。javascript引擎用<code>JIT</code>来保证性能最佳。</p>\n<p>在代码生成的过程中，需要<code>引擎</code>、<code>编译器</code>、<code>作用域</code>三者协作完成。在编译的过程中，引擎会进行<code>LHS</code>,<code>RHS</code>操作。<code>RHS</code>表示取得变量的值，而<code>LHS</code>表示获取赋值操作的目标。</p>\n<h4 id=\"作用域嵌套：\"><a href=\"#作用域嵌套：\" class=\"headerlink\" title=\"作用域嵌套：\"></a><em>作用域嵌套：</em></h4><blockquote>\n<p>引擎从当前执行作用域开始查找变量，如果找不到就会向上一级继续寻找，直到到达最外层作用域。</p>\n</blockquote>\n<p>作用域操作的异常：</p>\n<blockquote>\n<p><code>RHS</code>操作失败会抛出<code>ReferenceError</code>异常，而<code>LHS</code>操作没有找到目标变量，如果非严格模式下会创建一个全局变量，严格模式下会抛出<code>ReferenceError</code>。如果对<code>RHS</code>操作的变量的值进行不合理操作会抛出<code>TypeError</code>。</p>\n</blockquote>\n<hr>\n<h3 id=\"词法作用域\"><a href=\"#词法作用域\" class=\"headerlink\" title=\"词法作用域\"></a>词法作用域</h3><p>词法作用域由书写代码时决定，通过一些方法如<code>eval</code>、<code>with</code>。可以在词法分析器处理之后修改作用域。</p>\n<p>在标示符查找的过程中同名的会发生屏蔽，全局变量会自动成为全局对象的属性，因此可以通过<code>window.a</code>的形式访问被屏蔽的全局变量。</p>\n<hr>\n<h4 id=\"欺骗词法\"><a href=\"#欺骗词法\" class=\"headerlink\" title=\"欺骗词法\"></a>欺骗词法</h4><ul>\n<li>eval</li>\n</ul>\n<p>把字符串参数当做代码运行，就好像代码原来就是在那个位置。通过这种方式来修改词法作用域。严格模式下<code>eval</code>在运行时有自己的词法作用域，意味着其中的声明无法修改所在的作用域。</p>\n<ul>\n<li>with</li>\n</ul>\n<p>把一个对象处理为一个词法作用域，对象属性被定义为在这个作用域内的词法标示符。块内部的<code>var</code>声明会被添加到<code>with</code>所处的函数作用域中。</p>\n<p>不推荐使用<code>eval</code>和<code>with</code>：</p>\n<ul>\n<li>严格模式下禁止使用</li>\n<li>无法优化代码(作用域查找优化)</li>\n</ul>\n<hr>\n<h3 id=\"函数作用域和块作用域\"><a href=\"#函数作用域和块作用域\" class=\"headerlink\" title=\"函数作用域和块作用域\"></a>函数作用域和块作用域</h3><p>函数作用域分级的好处：</p>\n<ul>\n<li><p>隐藏内部实现</p>\n</li>\n<li><p>避免冲突</p>\n</li>\n</ul>\n<p>函数声明不可以是匿名的，函数表达式可以是匿名的。</p>\n<p>匿名函数缺点：</p>\n<ul>\n<li><p>匿名函数在栈上不会显示出有意义的函数名，调式困难</p>\n</li>\n<li><p>没有函数名，只能通过<code>argument.callee</code>调用自身，在严格模式下不可用</p>\n</li>\n<li><p>匿名函数可读行不高</p>\n</li>\n</ul>\n<p>立即执行的函数表达式</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">(<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">foo</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> a = <span class=\"number\">3</span>;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(a);</span><br><span class=\"line\">&#125;)();</span><br></pre></td></tr></table></figure>\n<p>第一个括号用于把函数变成一个表达式，第二个括号用于执行这个函数。</p>\n<p>IIFE的作用：</p>\n<ul>\n<li><p>把它当做函数调用，可以传入参数</p>\n</li>\n<li><p>解决<code>undefined</code>标示符默认值被覆盖问题</p>\n</li>\n<li><p>倒置代码的运行顺序，<code>UMD</code>模式</p>\n</li>\n</ul>\n<p>创建块作用域的方法：</p>\n<ul>\n<li>with</li>\n</ul>\n<ul>\n<li>try/catch</li>\n</ul>\n<p><code>catch</code>分句会创建一个块作用域，其中声明的变量仅仅在<code>catch</code>内部有效。</p>\n<ul>\n<li>let</li>\n</ul>\n<p><code>es6</code>新语法关键字，<code>let</code>定义的变量不会在块作用域中进行提升。</p>\n<ul>\n<li>const<br><code>es6</code>新语法关键字，<code>const</code>同样可以创建块作用域变量，其值是固定的。</li>\n</ul>\n<hr>\n<h3 id=\"提升\"><a href=\"#提升\" class=\"headerlink\" title=\"提升\"></a>提升</h3><blockquote>\n<p>包括变量和函数在内的所有声明都会在任何代码被执行前首先被处理（编译阶段）。</p>\n</blockquote>\n<p>规则：</p>\n<ul>\n<li>只有声明会被提升、赋值不会</li>\n<li>函数表达式不会被提升</li>\n<li>函数首先被提升，然后才是变量</li>\n<li>重复声明被忽略</li>\n</ul>\n<hr>\n<h3 id=\"闭包\"><a href=\"#闭包\" class=\"headerlink\" title=\"闭包\"></a>闭包</h3><blockquote>\n<p>通过任何手段，将内部函数传递到所在的词法作用域以外，它都会持有对原始定义作用域的引用，无论在何处执行这个函数都会使用闭包。</p>\n</blockquote>\n<p>循环和闭包问题：</p>\n<blockquote>\n<p>循环迭代的过程中引用同一个变量。</p>\n</blockquote>\n<p>解决办法：</p>\n<ul>\n<li><p>1、IIFE</p>\n<p>新建一个块作用域，并且每次都把变量传递进来。</p>\n</li>\n<li><p>2、let</p>\n</li>\n</ul>\n<p><code>for</code>循环头部的<code>let</code>声明有一个特殊行为： <code>变量在循环过程中不止声明一次。</code></p>\n<h4 id=\"利用闭包构建模块\"><a href=\"#利用闭包构建模块\" class=\"headerlink\" title=\"利用闭包构建模块\"></a>利用闭包构建模块</h4><p>模块模式的条件：</p>\n<ul>\n<li><p>必须有外部封闭的函数，该函数必须至少调用一次。</p>\n</li>\n<li><p>封闭函数必须至少放回一个内部函数，这样内部函数才能在私有作用域内形成闭包，并且可以访问或者修改私有的状态。</p>\n</li>\n</ul>\n<h4 id=\"箭头函数与词法作用域\"><a href=\"#箭头函数与词法作用域\" class=\"headerlink\" title=\"箭头函数与词法作用域\"></a>箭头函数与词法作用域</h4><p>好处：</p>\n<ul>\n<li>用当前的词法作用域覆盖了<code>this</code>本来的值。</li>\n</ul>\n<p>问题：</p>\n<ul>\n<li>它是匿名的而非具名</li>\n</ul>\n<hr>\n<h2 id=\"this和对象原型\"><a href=\"#this和对象原型\" class=\"headerlink\" title=\"this和对象原型\"></a>this和对象原型</h2><h3 id=\"this是什么\"><a href=\"#this是什么\" class=\"headerlink\" title=\"this是什么\"></a><code>this</code>是什么</h3><blockquote>\n<p>this既不指向自身，也不指向函数的词法作用域，<code>this</code>实际上是在函数调用时发生的绑定。</p>\n</blockquote>\n<hr>\n<h3 id=\"全面解析this\"><a href=\"#全面解析this\" class=\"headerlink\" title=\"全面解析this\"></a>全面解析<code>this</code></h3><p><code>this</code>的绑定规则：</p>\n<ul>\n<li>默认绑定</li>\n</ul>\n<p><code>this</code>指向全局对象。严格模式下无法使用（函数本身是严格模式）。</p>\n<ul>\n<li>隐式绑定</li>\n</ul>\n<p>对象属性引用炼只有最后一层会影响调用位置。</p>\n<ul>\n<li>显式绑定</li>\n</ul>\n<p>通过<code>apply</code>、<code>call</code>、<code>bind</code>来完成。</p>\n<ul>\n<li>new 绑定</li>\n</ul>\n<p><code>new</code>调用一个函数发生的操作：</p>\n<ul>\n<li>1、创建一个全新对象</li>\n<li>2、这个新对象会被执行[[原型]]连接</li>\n<li>3、这个新对象会绑定到函数调用的<code>this</code></li>\n<li>4、如果这个函数没有放回其他对象，那么<code>new</code>表达式中的函数调用会自动返回这个新对象。</li>\n</ul>\n<p>绑定优先级：</p>\n<blockquote>\n<p>默认绑定优先级最低，显式绑定优先级别高于隐式绑定。<code>new</code>绑定高于显式绑定。</p>\n</blockquote>\n<h3 id=\"对象\"><a href=\"#对象\" class=\"headerlink\" title=\"对象\"></a>对象</h3><p>js基本类型：</p>\n<ul>\n<li>string</li>\n<li>number</li>\n<li>boolean</li>\n<li>null</li>\n<li>undefined</li>\n<li>object</li>\n</ul>\n<p><code>null</code>由于语言本身的<code>BUG</code>执行<code>typeof</code>会返回<code>object</code>。</p>\n<p>内值对象子类型：</p>\n<ul>\n<li>String</li>\n<li>Number</li>\n<li>Function</li>\n<li>Object</li>\n<li>Array</li>\n<li>Boolean</li>\n<li>Date</li>\n<li>RegExp</li>\n<li>Error</li>\n</ul>\n<h4 id=\"属性描述符号：\"><a href=\"#属性描述符号：\" class=\"headerlink\" title=\"属性描述符号：\"></a>属性描述符号：</h4><ul>\n<li>writable</li>\n</ul>\n<p>决定是否可以修改属性的值</p>\n<ul>\n<li>configurable</li>\n</ul>\n<p>决定是否可以用<code>defineProperty</code>修改属性。<code>configurable:false</code>的属性，禁止删除。</p>\n<ul>\n<li>enumerable</li>\n</ul>\n<p>决定是否出现在对象属性的枚举中。</p>\n<h4 id=\"不变性\"><a href=\"#不变性\" class=\"headerlink\" title=\"不变性\"></a>不变性</h4><ul>\n<li><p>1、结合使用writable和configure</p>\n</li>\n<li><p>2、禁止扩展</p>\n</li>\n</ul>\n<p>Object.preventExtensions</p>\n<ul>\n<li>3、密封</li>\n</ul>\n<p>Object.seal=Object.preventExtensions + configurable:false<br>但是可以修改属性</p>\n<ul>\n<li>4、冻结</li>\n</ul>\n<p>Object.freeze=Object.seal + writable:false;</p>\n<h4 id=\"属性的存在性\"><a href=\"#属性的存在性\" class=\"headerlink\" title=\"属性的存在性\"></a>属性的存在性</h4><ul>\n<li>1、in</li>\n</ul>\n<p>检查是否在元素本身，以及原型链中。</p>\n<ul>\n<li>2、hasOwnProperty</li>\n</ul>\n<p>检查是否在对象本身。</p>\n<ul>\n<li>3、peopertyIsEnumerable</li>\n</ul>\n<p>检查属性名是否直接存在于对象中，而且<code>enumerable:true</code>。</p>\n<ul>\n<li>4、Object.keys</li>\n</ul>\n<p>返回一个对象本身所有可以枚举的属性</p>\n<ul>\n<li>5、Object.getOwnPropertyNames</li>\n</ul>\n<p>返回对象包含的所有属性(不含原型链)，不论是否可以枚举。</p>\n<h4 id=\"遍历\"><a href=\"#遍历\" class=\"headerlink\" title=\"遍历\"></a>遍历</h4><ul>\n<li>1、for in</li>\n</ul>\n<p>遍历对象可以枚举的属性，包含原型链。</p>\n<ul>\n<li>2、for</li>\n</ul>\n<p>遍历数组</p>\n<ul>\n<li>3、forEach\\some\\every</li>\n</ul>\n<p>ES5添加的方法，用于遍历数组。</p>\n<ul>\n<li>4、for..of</li>\n</ul>\n<p>通过迭代器(Symbol.iterator)遍历数组或者对象。</p>\n<h3 id=\"原型\"><a href=\"#原型\" class=\"headerlink\" title=\"原型\"></a>原型</h3><h4 id=\"Object-prototype\"><a href=\"#Object-prototype\" class=\"headerlink\" title=\"Object.prototype\"></a>Object.prototype</h4><blockquote>\n<p>所有的[[prototype]]最终指向<code>Object.prototype</code>。其提供了一些方法，如<code>valueOf</code>等等。</p>\n</blockquote>\n<p><code>myObject.foo = &quot;bar&quot;</code>出现的情况：</p>\n<ul>\n<li><p>1、[[prototype]]存在<code>foo</code>,并且可以写，那么会在myObject新建一个<code>foo</code>属性。</p>\n</li>\n<li><p>2、[[prototype]]存在<code>foo</code>,并且不可以写，严格模式报出错误。</p>\n</li>\n<li><p>3、[[prototype]]存在<code>foo</code>且是一个<code>setter</code>,那就一定会调用这个<code>setter</code>,<code>foo</code>不被添加，而且调用这个<code>setter</code>。</p>\n</li>\n</ul>\n<h4 id=\"基本原型关系：\"><a href=\"#基本原型关系：\" class=\"headerlink\" title=\"基本原型关系：\"></a>基本原型关系：</h4><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">Foo</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> foo = <span class=\"keyword\">new</span> Foo();</span><br><span class=\"line\"></span><br><span class=\"line\">Foo.prototype.__proto__ == <span class=\"built_in\">Object</span>.prototype</span><br><span class=\"line\"><span class=\"built_in\">Function</span>.prototype.__proto__ == <span class=\"built_in\">Object</span>.prototype</span><br><span class=\"line\"><span class=\"built_in\">Array</span>.__proto__ == <span class=\"built_in\">Function</span>.prototype</span><br><span class=\"line\">Foo.__proto__ == <span class=\"built_in\">Function</span>.prototype</span><br><span class=\"line\">foo.__proto__ == Foo.prototype</span><br><span class=\"line\"></span><br><span class=\"line\">Foo.constructor == <span class=\"built_in\">Function</span></span><br><span class=\"line\">foo.constructor == Foo</span><br></pre></td></tr></table></figure>\n"},{"title":"修复npm安装全局模块权限问题","date":"2015-11-07T02:37:03.000Z","_content":"> **我们曾经可能都遇到过安装某个模块包的过程中提示`EACCESS`的错误问题。这是由于`npm`全局安装模块的默认路径没有权限导致的。**\n\n---  \n有三个方式可以解决该问题：  \n- 修改全局安装路径的权限  \n- 修改默认安装路径  \n- 借助第三方工具安装`node`  \n\n\n#### 修改安装路径的权限  \n\n- 查看默认全局安装路径  \n\n> npm config get prefix  \n\n对于大多数系统显示目录为：`/usr/local`  \n\n**警告：如果默认路径是在/usr/请跳过该步骤，否则你会搞乱系统权限。**  \n\n- 修改路径权限  \n\n> sudo chown -R $(whoami) $(npm config get prefix)/{lib/node_modules,bin,share}\n\n执行完毕将会把`/usr/local`下的`lib/node_modules`、`bin`、`share`所有权更改为当前用户。  \n\n---  \n\n#### 修改默认全局安装路径  \n\n当你不想修改默认安装路径的权限，因为由此可能会带来一些额外问题，譬如说，修改权限后无法跟当前系统其他用户共享。这个时候可以考虑修改默认的安装路径。\n\n在示例下，我把默认全局安装路径修改到当前用户的`home`目录下面：  \n\n- 1、新建一个全局安装的路径  \n\n> mkdir ~/.npm-global  \n\n- 2、配置`npm`使用新的路径  \n\n> npm config set prefix '~/.npm-global'  \n\n- 3、打开或者新建`~/.profile`，加入下面一行  \n\n> export PATH=~/.npm-global/bin:$PATH  \n\n- 4、更新系统环境变量  \n\n> source ~/.profile  \n\n安装一个全局包试一试：  \n\n> npm install -g jshint \n\n``` javascript \n[luncher@localhost aaa]$ ls ~/.npm-global/bin/\njshint\n[luncher@localhost aaa]$ \n```  \n\n---  \n\n#### 借助第三方工具安装`node`  \n\n- mac系统借助brew安装`node`  \n\n> brew install node  \n\n- centos借助yum工具安装`node`  \n\n> yum install node \n","source":"_posts/修复npm安装全局模块权限问题.md","raw":"---\ntitle: 修复npm安装全局模块权限问题\ncategories: server\ndate: 2015-11-07 10:37:03\n---\n> **我们曾经可能都遇到过安装某个模块包的过程中提示`EACCESS`的错误问题。这是由于`npm`全局安装模块的默认路径没有权限导致的。**\n\n---  \n有三个方式可以解决该问题：  \n- 修改全局安装路径的权限  \n- 修改默认安装路径  \n- 借助第三方工具安装`node`  \n\n\n#### 修改安装路径的权限  \n\n- 查看默认全局安装路径  \n\n> npm config get prefix  \n\n对于大多数系统显示目录为：`/usr/local`  \n\n**警告：如果默认路径是在/usr/请跳过该步骤，否则你会搞乱系统权限。**  \n\n- 修改路径权限  \n\n> sudo chown -R $(whoami) $(npm config get prefix)/{lib/node_modules,bin,share}\n\n执行完毕将会把`/usr/local`下的`lib/node_modules`、`bin`、`share`所有权更改为当前用户。  \n\n---  \n\n#### 修改默认全局安装路径  \n\n当你不想修改默认安装路径的权限，因为由此可能会带来一些额外问题，譬如说，修改权限后无法跟当前系统其他用户共享。这个时候可以考虑修改默认的安装路径。\n\n在示例下，我把默认全局安装路径修改到当前用户的`home`目录下面：  \n\n- 1、新建一个全局安装的路径  \n\n> mkdir ~/.npm-global  \n\n- 2、配置`npm`使用新的路径  \n\n> npm config set prefix '~/.npm-global'  \n\n- 3、打开或者新建`~/.profile`，加入下面一行  \n\n> export PATH=~/.npm-global/bin:$PATH  \n\n- 4、更新系统环境变量  \n\n> source ~/.profile  \n\n安装一个全局包试一试：  \n\n> npm install -g jshint \n\n``` javascript \n[luncher@localhost aaa]$ ls ~/.npm-global/bin/\njshint\n[luncher@localhost aaa]$ \n```  \n\n---  \n\n#### 借助第三方工具安装`node`  \n\n- mac系统借助brew安装`node`  \n\n> brew install node  \n\n- centos借助yum工具安装`node`  \n\n> yum install node \n","slug":"修复npm安装全局模块权限问题","published":1,"updated":"2018-07-01T10:30:46.498Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9ce4003ty4zvlgnto782","content":"<blockquote>\n<p><strong>我们曾经可能都遇到过安装某个模块包的过程中提示<code>EACCESS</code>的错误问题。这是由于<code>npm</code>全局安装模块的默认路径没有权限导致的。</strong></p>\n</blockquote>\n<hr>\n<p>有三个方式可以解决该问题：  </p>\n<ul>\n<li>修改全局安装路径的权限  </li>\n<li>修改默认安装路径  </li>\n<li>借助第三方工具安装<code>node</code>  </li>\n</ul>\n<h4 id=\"修改安装路径的权限\"><a href=\"#修改安装路径的权限\" class=\"headerlink\" title=\"修改安装路径的权限\"></a>修改安装路径的权限</h4><ul>\n<li>查看默认全局安装路径  </li>\n</ul>\n<blockquote>\n<p>npm config get prefix  </p>\n</blockquote>\n<p>对于大多数系统显示目录为：<code>/usr/local</code>  </p>\n<p><strong>警告：如果默认路径是在/usr/请跳过该步骤，否则你会搞乱系统权限。</strong>  </p>\n<ul>\n<li>修改路径权限  </li>\n</ul>\n<blockquote>\n<p>sudo chown -R $(whoami) $(npm config get prefix)/{lib/node_modules,bin,share}</p>\n</blockquote>\n<p>执行完毕将会把<code>/usr/local</code>下的<code>lib/node_modules</code>、<code>bin</code>、<code>share</code>所有权更改为当前用户。  </p>\n<hr>\n<h4 id=\"修改默认全局安装路径\"><a href=\"#修改默认全局安装路径\" class=\"headerlink\" title=\"修改默认全局安装路径\"></a>修改默认全局安装路径</h4><p>当你不想修改默认安装路径的权限，因为由此可能会带来一些额外问题，譬如说，修改权限后无法跟当前系统其他用户共享。这个时候可以考虑修改默认的安装路径。</p>\n<p>在示例下，我把默认全局安装路径修改到当前用户的<code>home</code>目录下面：  </p>\n<ul>\n<li>1、新建一个全局安装的路径  </li>\n</ul>\n<blockquote>\n<p>mkdir ~/.npm-global  </p>\n</blockquote>\n<ul>\n<li>2、配置<code>npm</code>使用新的路径  </li>\n</ul>\n<blockquote>\n<p>npm config set prefix ‘~/.npm-global’  </p>\n</blockquote>\n<ul>\n<li>3、打开或者新建<code>~/.profile</code>，加入下面一行  </li>\n</ul>\n<blockquote>\n<p>export PATH=~/.npm-global/bin:$PATH  </p>\n</blockquote>\n<ul>\n<li>4、更新系统环境变量  </li>\n</ul>\n<blockquote>\n<p>source ~/.profile  </p>\n</blockquote>\n<p>安装一个全局包试一试：  </p>\n<blockquote>\n<p>npm install -g jshint </p>\n</blockquote>\n<pre><code class=\"javascript\">[luncher@localhost aaa]$ ls ~<span class=\"regexp\">/.npm-global/</span>bin/\njshint\n[luncher@localhost aaa]$ \n</code></pre>\n<hr>\n<h4 id=\"借助第三方工具安装node\"><a href=\"#借助第三方工具安装node\" class=\"headerlink\" title=\"借助第三方工具安装node\"></a>借助第三方工具安装<code>node</code></h4><ul>\n<li>mac系统借助brew安装<code>node</code>  </li>\n</ul>\n<blockquote>\n<p>brew install node  </p>\n</blockquote>\n<ul>\n<li>centos借助yum工具安装<code>node</code>  </li>\n</ul>\n<blockquote>\n<p>yum install node </p>\n</blockquote>\n","site":{"data":{}},"excerpt":"","more":"<blockquote>\n<p><strong>我们曾经可能都遇到过安装某个模块包的过程中提示<code>EACCESS</code>的错误问题。这是由于<code>npm</code>全局安装模块的默认路径没有权限导致的。</strong></p>\n</blockquote>\n<hr>\n<p>有三个方式可以解决该问题：  </p>\n<ul>\n<li>修改全局安装路径的权限  </li>\n<li>修改默认安装路径  </li>\n<li>借助第三方工具安装<code>node</code>  </li>\n</ul>\n<h4 id=\"修改安装路径的权限\"><a href=\"#修改安装路径的权限\" class=\"headerlink\" title=\"修改安装路径的权限\"></a>修改安装路径的权限</h4><ul>\n<li>查看默认全局安装路径  </li>\n</ul>\n<blockquote>\n<p>npm config get prefix  </p>\n</blockquote>\n<p>对于大多数系统显示目录为：<code>/usr/local</code>  </p>\n<p><strong>警告：如果默认路径是在/usr/请跳过该步骤，否则你会搞乱系统权限。</strong>  </p>\n<ul>\n<li>修改路径权限  </li>\n</ul>\n<blockquote>\n<p>sudo chown -R $(whoami) $(npm config get prefix)/{lib/node_modules,bin,share}</p>\n</blockquote>\n<p>执行完毕将会把<code>/usr/local</code>下的<code>lib/node_modules</code>、<code>bin</code>、<code>share</code>所有权更改为当前用户。  </p>\n<hr>\n<h4 id=\"修改默认全局安装路径\"><a href=\"#修改默认全局安装路径\" class=\"headerlink\" title=\"修改默认全局安装路径\"></a>修改默认全局安装路径</h4><p>当你不想修改默认安装路径的权限，因为由此可能会带来一些额外问题，譬如说，修改权限后无法跟当前系统其他用户共享。这个时候可以考虑修改默认的安装路径。</p>\n<p>在示例下，我把默认全局安装路径修改到当前用户的<code>home</code>目录下面：  </p>\n<ul>\n<li>1、新建一个全局安装的路径  </li>\n</ul>\n<blockquote>\n<p>mkdir ~/.npm-global  </p>\n</blockquote>\n<ul>\n<li>2、配置<code>npm</code>使用新的路径  </li>\n</ul>\n<blockquote>\n<p>npm config set prefix ‘~/.npm-global’  </p>\n</blockquote>\n<ul>\n<li>3、打开或者新建<code>~/.profile</code>，加入下面一行  </li>\n</ul>\n<blockquote>\n<p>export PATH=~/.npm-global/bin:$PATH  </p>\n</blockquote>\n<ul>\n<li>4、更新系统环境变量  </li>\n</ul>\n<blockquote>\n<p>source ~/.profile  </p>\n</blockquote>\n<p>安装一个全局包试一试：  </p>\n<blockquote>\n<p>npm install -g jshint </p>\n</blockquote>\n<pre><code class=\"javascript\">[luncher@localhost aaa]$ ls ~<span class=\"regexp\">/.npm-global/</span>bin/\njshint\n[luncher@localhost aaa]$ \n</code></pre>\n<hr>\n<h4 id=\"借助第三方工具安装node\"><a href=\"#借助第三方工具安装node\" class=\"headerlink\" title=\"借助第三方工具安装node\"></a>借助第三方工具安装<code>node</code></h4><ul>\n<li>mac系统借助brew安装<code>node</code>  </li>\n</ul>\n<blockquote>\n<p>brew install node  </p>\n</blockquote>\n<ul>\n<li>centos借助yum工具安装<code>node</code>  </li>\n</ul>\n<blockquote>\n<p>yum install node </p>\n</blockquote>\n"},{"title":"关于express下session的几个注意事项","date":"2016-10-07T11:30:20.000Z","_content":"\n使用nodejs开发web应用之所以快，其中一个重要原因是非常齐全的第三方模块，你几乎可以找到任何想要的`module`。`express-session`是`express`WEB框架常用的`session`管理包。其主要有如下几个配置选项：  \n- cookie : 用于设置sessionID cookie选项，如过期时间，cookie适用的路径等。  \n- name  : sessionID 对应的cookie名。  \n- resave  :  强制把session写入存储，即使session在整个请求过程中都没有被修改。  \n- saveUninitialized  : 保存新建的但没有被改动的session。  \n- secret : 加密sessionID cookie的密钥。  \n\n\n---  \n\n###1、 session并发问题  \n`resave`选项如果配置为`true`，而实际的运用场景有并发请求并且依赖`session`的情况下就得注意了。因为问题在于，一个请求设置得数据可能被另外一个请求重写覆盖了。 对于一些有并发的服务器，需要把该选项配置为`false`。当然这只能解决`session`信息覆盖的问题。 并不能很好解决`session`数据一致性问题，比如说：用户首先发送一个更新`session`的请求，该请求依赖于其他服务器的应答，而后续的其他请求依赖于最新得`session`信息否则必须给以错误得应答。这个时候我们必须手动更新`session`的信息，把依赖于更新`session`信息的并发请求串行化。  \n\n``` javascript\n    Promise.resolve()\n    .then(function() {\n        req.session.user.gameKey = null;\n        req.session.user.companyId = null;\n        return syncUserSession(req);\n    })\n    .then(function() {\n      //....\n    });\n\n    function updateUserInfo(user) {\n        return new Promise(function(resolve, reject) {\n        user.gameKey = gameKey;\n        user.companyId = user.companyIdSrc;\n        user.save(function() {\n            req.session.user = user;\n        });\n        });\n    }\n\n```  \n\n\n###2、 合理搭配中间件得顺序  \n`express-session`作为几个基础中间件，每次请求都有创建对象，分配内存，保存数据等一系列操作。实际上，服务器上一些资源得应答没有使用到`session`。所以我们可以把它提前。当然也可以把没有使用到`session`得用户中间件提前。  \n\n``` javascript  \n//静态资源\napp.use('/public', express.static(staticDir));  \napp.use(require('cookie-parser')(config.session_secret));\napp.use(session({\n\tsecret: config.session_secret,\n\tstore: new RedisStore({\n\t\tport: config.redis_port,\n\t\thost: config.redis_host\n\t}),\n    resave: false,\n\tsaveUninitialized: true\n}));\n\n```  \n\n`cookie-parser`模块解析`cookie`数据，随后得`session`模块根据`sessionID cookie`管理会话数据。 把静态资源服务提前避免不必要得`session`操作。\n\n\n\n\n\n","source":"_posts/关于express下session的几个注意事项.md","raw":"---\ntitle: 关于express下session的几个注意事项\ncategories: server\ndate: 2016-10-07 19:30:20\n---\n\n使用nodejs开发web应用之所以快，其中一个重要原因是非常齐全的第三方模块，你几乎可以找到任何想要的`module`。`express-session`是`express`WEB框架常用的`session`管理包。其主要有如下几个配置选项：  \n- cookie : 用于设置sessionID cookie选项，如过期时间，cookie适用的路径等。  \n- name  : sessionID 对应的cookie名。  \n- resave  :  强制把session写入存储，即使session在整个请求过程中都没有被修改。  \n- saveUninitialized  : 保存新建的但没有被改动的session。  \n- secret : 加密sessionID cookie的密钥。  \n\n\n---  \n\n###1、 session并发问题  \n`resave`选项如果配置为`true`，而实际的运用场景有并发请求并且依赖`session`的情况下就得注意了。因为问题在于，一个请求设置得数据可能被另外一个请求重写覆盖了。 对于一些有并发的服务器，需要把该选项配置为`false`。当然这只能解决`session`信息覆盖的问题。 并不能很好解决`session`数据一致性问题，比如说：用户首先发送一个更新`session`的请求，该请求依赖于其他服务器的应答，而后续的其他请求依赖于最新得`session`信息否则必须给以错误得应答。这个时候我们必须手动更新`session`的信息，把依赖于更新`session`信息的并发请求串行化。  \n\n``` javascript\n    Promise.resolve()\n    .then(function() {\n        req.session.user.gameKey = null;\n        req.session.user.companyId = null;\n        return syncUserSession(req);\n    })\n    .then(function() {\n      //....\n    });\n\n    function updateUserInfo(user) {\n        return new Promise(function(resolve, reject) {\n        user.gameKey = gameKey;\n        user.companyId = user.companyIdSrc;\n        user.save(function() {\n            req.session.user = user;\n        });\n        });\n    }\n\n```  \n\n\n###2、 合理搭配中间件得顺序  \n`express-session`作为几个基础中间件，每次请求都有创建对象，分配内存，保存数据等一系列操作。实际上，服务器上一些资源得应答没有使用到`session`。所以我们可以把它提前。当然也可以把没有使用到`session`得用户中间件提前。  \n\n``` javascript  \n//静态资源\napp.use('/public', express.static(staticDir));  \napp.use(require('cookie-parser')(config.session_secret));\napp.use(session({\n\tsecret: config.session_secret,\n\tstore: new RedisStore({\n\t\tport: config.redis_port,\n\t\thost: config.redis_host\n\t}),\n    resave: false,\n\tsaveUninitialized: true\n}));\n\n```  \n\n`cookie-parser`模块解析`cookie`数据，随后得`session`模块根据`sessionID cookie`管理会话数据。 把静态资源服务提前避免不必要得`session`操作。\n\n\n\n\n\n","slug":"关于express下session的几个注意事项","published":1,"updated":"2018-07-01T10:30:46.498Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9ce5003wy4zvdw81fiur","content":"<p>使用nodejs开发web应用之所以快，其中一个重要原因是非常齐全的第三方模块，你几乎可以找到任何想要的<code>module</code>。<code>express-session</code>是<code>express</code>WEB框架常用的<code>session</code>管理包。其主要有如下几个配置选项：  </p>\n<ul>\n<li>cookie : 用于设置sessionID cookie选项，如过期时间，cookie适用的路径等。  </li>\n<li>name  : sessionID 对应的cookie名。  </li>\n<li>resave  :  强制把session写入存储，即使session在整个请求过程中都没有被修改。  </li>\n<li>saveUninitialized  : 保存新建的但没有被改动的session。  </li>\n<li>secret : 加密sessionID cookie的密钥。  </li>\n</ul>\n<hr>\n<p>###1、 session并发问题<br><code>resave</code>选项如果配置为<code>true</code>，而实际的运用场景有并发请求并且依赖<code>session</code>的情况下就得注意了。因为问题在于，一个请求设置得数据可能被另外一个请求重写覆盖了。 对于一些有并发的服务器，需要把该选项配置为<code>false</code>。当然这只能解决<code>session</code>信息覆盖的问题。 并不能很好解决<code>session</code>数据一致性问题，比如说：用户首先发送一个更新<code>session</code>的请求，该请求依赖于其他服务器的应答，而后续的其他请求依赖于最新得<code>session</code>信息否则必须给以错误得应答。这个时候我们必须手动更新<code>session</code>的信息，把依赖于更新<code>session</code>信息的并发请求串行化。  </p>\n<pre><code class=\"javascript\"><span class=\"built_in\">Promise</span>.resolve()\n.then(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>{\n    req.session.user.gameKey = <span class=\"literal\">null</span>;\n    req.session.user.companyId = <span class=\"literal\">null</span>;\n    <span class=\"keyword\">return</span> syncUserSession(req);\n})\n.then(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>{\n  <span class=\"comment\">//....</span>\n});\n\n<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">updateUserInfo</span>(<span class=\"params\">user</span>) </span>{\n    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">resolve, reject</span>) </span>{\n    user.gameKey = gameKey;\n    user.companyId = user.companyIdSrc;\n    user.save(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>{\n        req.session.user = user;\n    });\n    });\n}\n\n</code></pre>\n<p>###2、 合理搭配中间件得顺序<br><code>express-session</code>作为几个基础中间件，每次请求都有创建对象，分配内存，保存数据等一系列操作。实际上，服务器上一些资源得应答没有使用到<code>session</code>。所以我们可以把它提前。当然也可以把没有使用到<code>session</code>得用户中间件提前。  </p>\n<pre><code class=\"javascript\"><span class=\"comment\">//静态资源</span>\napp.use(<span class=\"string\">'/public'</span>, express.static(staticDir));  \napp.use(<span class=\"built_in\">require</span>(<span class=\"string\">'cookie-parser'</span>)(config.session_secret));\napp.use(session({\n    secret: config.session_secret,\n    store: <span class=\"keyword\">new</span> RedisStore({\n        port: config.redis_port,\n        host: config.redis_host\n    }),\n    resave: <span class=\"literal\">false</span>,\n    saveUninitialized: <span class=\"literal\">true</span>\n}));\n\n</code></pre>\n<p><code>cookie-parser</code>模块解析<code>cookie</code>数据，随后得<code>session</code>模块根据<code>sessionID cookie</code>管理会话数据。 把静态资源服务提前避免不必要得<code>session</code>操作。</p>\n","site":{"data":{}},"excerpt":"","more":"<p>使用nodejs开发web应用之所以快，其中一个重要原因是非常齐全的第三方模块，你几乎可以找到任何想要的<code>module</code>。<code>express-session</code>是<code>express</code>WEB框架常用的<code>session</code>管理包。其主要有如下几个配置选项：  </p>\n<ul>\n<li>cookie : 用于设置sessionID cookie选项，如过期时间，cookie适用的路径等。  </li>\n<li>name  : sessionID 对应的cookie名。  </li>\n<li>resave  :  强制把session写入存储，即使session在整个请求过程中都没有被修改。  </li>\n<li>saveUninitialized  : 保存新建的但没有被改动的session。  </li>\n<li>secret : 加密sessionID cookie的密钥。  </li>\n</ul>\n<hr>\n<p>###1、 session并发问题<br><code>resave</code>选项如果配置为<code>true</code>，而实际的运用场景有并发请求并且依赖<code>session</code>的情况下就得注意了。因为问题在于，一个请求设置得数据可能被另外一个请求重写覆盖了。 对于一些有并发的服务器，需要把该选项配置为<code>false</code>。当然这只能解决<code>session</code>信息覆盖的问题。 并不能很好解决<code>session</code>数据一致性问题，比如说：用户首先发送一个更新<code>session</code>的请求，该请求依赖于其他服务器的应答，而后续的其他请求依赖于最新得<code>session</code>信息否则必须给以错误得应答。这个时候我们必须手动更新<code>session</code>的信息，把依赖于更新<code>session</code>信息的并发请求串行化。  </p>\n<pre><code class=\"javascript\"><span class=\"built_in\">Promise</span>.resolve()\n.then(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>{\n    req.session.user.gameKey = <span class=\"literal\">null</span>;\n    req.session.user.companyId = <span class=\"literal\">null</span>;\n    <span class=\"keyword\">return</span> syncUserSession(req);\n})\n.then(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>{\n  <span class=\"comment\">//....</span>\n});\n\n<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">updateUserInfo</span>(<span class=\"params\">user</span>) </span>{\n    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">resolve, reject</span>) </span>{\n    user.gameKey = gameKey;\n    user.companyId = user.companyIdSrc;\n    user.save(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>{\n        req.session.user = user;\n    });\n    });\n}\n\n</code></pre>\n<p>###2、 合理搭配中间件得顺序<br><code>express-session</code>作为几个基础中间件，每次请求都有创建对象，分配内存，保存数据等一系列操作。实际上，服务器上一些资源得应答没有使用到<code>session</code>。所以我们可以把它提前。当然也可以把没有使用到<code>session</code>得用户中间件提前。  </p>\n<pre><code class=\"javascript\"><span class=\"comment\">//静态资源</span>\napp.use(<span class=\"string\">'/public'</span>, express.static(staticDir));  \napp.use(<span class=\"built_in\">require</span>(<span class=\"string\">'cookie-parser'</span>)(config.session_secret));\napp.use(session({\n    secret: config.session_secret,\n    store: <span class=\"keyword\">new</span> RedisStore({\n        port: config.redis_port,\n        host: config.redis_host\n    }),\n    resave: <span class=\"literal\">false</span>,\n    saveUninitialized: <span class=\"literal\">true</span>\n}));\n\n</code></pre>\n<p><code>cookie-parser</code>模块解析<code>cookie</code>数据，随后得<code>session</code>模块根据<code>sessionID cookie</code>管理会话数据。 把静态资源服务提前避免不必要得<code>session</code>操作。</p>\n"},{"title":"使用passport管理第三方授权认证","date":"2016-01-07T02:37:03.000Z","_content":"`passport`是一个为`Nodejs`设计的，兼容`Express`的认证中间件。通过第三方插件的形式(以下称为`strategy`)，可以应对各式各样的认证请求。`passport`具有高度的灵活性，并不依赖于任何一个路由，或者指定的数据存储，这样给上层开发者提供的极大的便利性。`passport`提供的接口也相对简单，只需要给它一个认证请求，`passport`会提供一个钩子函数(`hook`)告诉你请求失败了或者成功了。\n\n---\n\n### 1. passport的设计思路\n`passport`基于一个高度灵活的设计结构，主要由四个模块组成：`passport`插件(strategy)管理模块、`执行认证操作的授权模块`、`framewark适配模块`、`session管理模块`。其结构框图如下：\n\n![系统框图](http://www.tangide.com/storage/read.php?path=wechat/o/oSjbMs7GPu-gH9dZ4tsoo52y4gmo/blog/passport%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B.png)\n\n\n授权流程(引用`github oath2.0`来举例)\n\n![授权流程](http://www.tangide.com/storage/read.php?path=wechat/o/oSjbMs7GPu-gH9dZ4tsoo52y4gmo/blog/passport-%E6%8E%88%E6%9D%83%E6%B5%81%E7%A8%8B.png)\n\n+ 1.授权插件体系  \n所有的`passport`插件都继承自`passport-strategy`，紧接着根据不同的授权流程又细分为OAuth2.0授权中间件、OPENID类的授权中间件、以及帐号密码类的授权中间件。这些基本的中间件官方已经有了标准的实现。开发者需要做的是去继承这些授权中间件，针对不同的业务需求，配置特定的部分参数。就可以完成一整个授权的流程。常见的OAth2.0标准的授权插件有：`passport-github`、`passport-twitter`。这些针对不同厂商的第三方`Strategy`体量都非常小，基本在100行代码内可以搞定，因为大部分工作都交给标准的`strategy`来做了。\n\n\n+ 2.framework适配  \n`passport`官方的实现基于标准的`Express`形式的风格，也就是说，中间件的函数风格类似于：\n> function authenticate(req, res, next)\n>//如果需要适配其他的框架需要实现特定风格的`authenticate`函数。 \n\n\n\n+ 3.session管理  \n`passport`提供session的功能，如果开启该功能，则需要提供序列化，以及反序列化接口。`express-session`是一个很好的session管理包，所以还是让`passport`专注于授权认证吧！\n\n--- \n\n### 2. passport使用\n\n+ 1. 注入第三方`strategy`\n\n```javascript\n\nfunction verifyProfile(accessToken, refreshToken, profile, done) {\n  profile.accessToken = accessToken;\n   done(null, profile);\n}\n\npassport.use(new GithubStrategy({\nclientID: '123-456-789',\nclientSecret: 'easdasjdklasjd',\ncallbackURL: 'http://www.example.com/auth/github/callback'\n}), verifyProfile);\n\n```  \npassport提供`use`函数用于注入授权认证的插件、`unuse`用于注销认证插件。`verifyProfile`接口是一个`hook`，用来验证用户信息的有效性。\n\n\n+ 2. 授权认证  \n```javascript  \n\n//请求授权码\napp.get('/user/login/github', passport.authenricate('github', {scope: 'wl_scope'}));\n//获取accessToken以及请求用户信息，关闭session功能\napp.get('/auth/github/callback', passport.authenricate('github', {session: false, failureRedirect: '/'}));\n\n```  \n---\n\n### 3. passport源码分析\n\n+ 1. 授权认证入口函数  \n``` javascript\n\nAuthenticator.prototype.authenticate = function(strategy, options, callback) {\n  return this._framework.authenticate(this, strategy, options, callback);\n};\n\n```\n\n+ 2. express 风格的认证函数\n```javascript\n\nmodule.exports = function authenticate(passport, name, options, callback) {\n  if (typeof options == 'function') {\n    callback = options;\n    options = {};\n  }\n\n  return function authenticate(req, res, next) {\n\n     function allFailed() {\n      if (callback) {\n        if (!multi) {\n          return callback(null, false, failures[0].challenge, failures[0].status);\n        } else {\n          var challenges = failures.map(function(f) { return f.challenge; });\n          var statuses = failures.map(function(f) { return f.status; });\n          return callback(null, false, challenges, statuses);\n        }\n      }\n      ....\n    }\n    (function attempt(i) {\n      var layer = name[i];\n      // If no more strategies exist in the chain, authentication has failed.\n      if (!layer) { return allFailed(); }\n      var prototype = passport._strategy(layer);\n      if (!prototype) { return next(new Error('Unknown authentication strategy \"' + layer + '\"')); }\n    \n      var strategy = Object.create(prototype);\n      strategy.success = function(user, info) {\n        if (callback) {\n          return callback(null, user, info);\n        }\n        ....\n         req.logIn(user, options, function(err) {\n          if (err) { return next(err); }\n          \n          function complete() {\n            if (options.successReturnToOrRedirect) {\n              var url = options.successReturnToOrRedirect;\n              if (req.session && req.session.returnTo) {\n                url = req.session.returnTo;\n                delete req.session.returnTo;\n              }\n              return res.redirect(url);\n            }\n            if (options.successRedirect) {\n              return res.redirect(options.successRedirect);\n            }\n            next();\n          }\n          complete();\n      }\n       ....\n     //调用oauth2.0认证函数\n     strategy.authenticate(req, options);\n  })(0);\n\n\n```\n\n+ 3. Oauth2.0 认证函数\n\n```javascript\n\nOAuth2Strategy.prototype.authenticate = function(req, options) {\n  options = options || {};\n  var self = this;\n  \n  if (req.query && req.query.error) {\n    if (req.query.error == 'access_denied') {\n      return this.fail({ message: req.query.error_description });\n    } else {\n      return this.error(new AuthorizationError(req.query.error_description, req.query.error, req.query.error_uri));\n    }\n  }\n  \n  var callbackURL = options.callbackURL || this._callbackURL;\n  if (callbackURL) {\n    var parsed = url.parse(callbackURL);\n    if (!parsed.protocol) {\n      // The callback URL is relative, resolve a fully qualified URL from the\n      // URL of the originating request.\n      callbackURL = url.resolve(utils.originalURL(req, { proxy: this._trustProxy }), callbackURL);\n    }\n  }\n  \n  if (req.query && req.query.code) {\n   //根据授权码获取accessToken以及用户信息\n    var code = req.query.code;\n\n    var params = this.tokenParams(options);\n    params.grant_type = 'authorization_code';\n    params.redirect_uri = callbackURL;\n\n    this._oauth2.getOAuthAccessToken(code, params,\n      function(err, accessToken, refreshToken, params) {\n        if (err) { return self.error(self._createOAuthError('Failed to obtain access token', err)); }\n        \n        self._loadUserProfile(accessToken, function(err, profile) {\n          if (err) { return self.error(err); }\n          \n          function verified(err, user, info) {\n            if (err) { return self.error(err); }\n            if (!user) { return self.fail(info); }\n            self.success(user, info);\n          }\n          \n          try {\n            //_verify 就是注入插件的时候指定的用户信息校验函数只有通过该函数校验，认证才算完成，用户信息被`success`挂在req.user。\n            if (self._passReqToCallback) {\n              var arity = self._verify.length;\n              if (arity == 6) {\n                self._verify(req, accessToken, refreshToken, params, profile, verified);\n              } else { // arity == 5\n                self._verify(req, accessToken, refreshToken, profile, verified);\n              }\n            } else {\n              var arity = self._verify.length;\n              if (arity == 5) {\n                self._verify(accessToken, refreshToken, params, profile, verified);\n              } else { // arity == 4\n                self._verify(accessToken, refreshToken, profile, verified);\n              }\n            }\n          } catch (ex) {\n            return self.error(ex);\n          }\n        });\n      }\n    );\n  } else {\n   //获取授权码\n    var params = this.authorizationParams(options);\n    params.response_type = 'code';\n    params.redirect_uri = callbackURL;\n    var scope = options.scope || this._scope;\n    if (scope) {\n      if (Array.isArray(scope)) { scope = scope.join(this._scopeSeparator); }\n      params.scope = scope;\n    }\n\n    var location = this._oauth2.getAuthorizeUrl(params);\n    this.redirect(location);\n  }\n};\n\n```\n\n+ 4. 获取用户信息\n```javascript\n\nOAuth2Strategy.prototype._loadUserProfile = function(accessToken, done) {\n  var self = this;\n  \n  function loadIt() {\n    return self.userProfile(accessToken, done);\n  }\n  function skipIt() {\n    return done(null);\n  }\n  //通过_skipUserProfile参数跳过不需要获取用户信息的认证。\n  if (typeof this._skipUserProfile == 'function' && this._skipUserProfile.length > 1) {\n    // async\n    this._skipUserProfile(accessToken, function(err, skip) {\n      if (err) { return done(err); }\n      if (!skip) { return loadIt(); }\n      return skipIt();\n    });\n  } else {\n    var skip = (typeof this._skipUserProfile == 'function') ? this._skipUserProfile() : this._skipUserProfile;\n    if (!skip) { return loadIt(); }\n    return skipIt();\n  }\n};\n\n//第三方插件需要重载该接口实现用户信息的获取，`passport`把该接口完全开放给开发者。\nOAuth2Strategy.prototype.userProfile = function(accessToken, done) {\n  return done(null, {});\n};\n\n```\n\n--- \n\n### 4. 实现自己的`strategy`实现\n\n实现自己的第三方`passport-strategy`主要有三个步骤：\n\n+ 1. 继承`passport-oauth2`\n``` javascript\nfunction Strategy(options, verify) {\n  options = options || {};\n  options.authorizationURL = options.authorizationURL || 'https://github.com/login/oauth/authorize';\n  options.tokenURL = options.tokenURL || 'https://github.com/login/oauth/access_token';\n  options.scopeSeparator = options.scopeSeparator || ',';\n  options.customHeaders = options.customHeaders || {};\n\n  if (!options.customHeaders['User-Agent']) {\n    options.customHeaders['User-Agent'] = options.userAgent || 'passport-github';\n  }\n\n  OAuth2Strategy.call(this, options, verify);\n  this.name = 'github';\n  this._userProfileURL = options.userProfileURL || 'https://api.github.com/user';\n  this._oauth2.useAuthorizationHeaderforGET(true);\n}\n\n/**\n * Inherit from `OAuth2Strategy`.\n */\nutil.inherits(Strategy, OAuth2Strategy);\n```\n\n+ 2. 实现获取用户信息接口\n``` javascript  \nStrategy.prototype.userProfile = function(accessToken, done) {\n  this._oauth2.get(this._userProfileURL, accessToken, function (err, body, res) {\n    var json;\n    \n    if (err) {\n      return done(new InternalOAuthError('Failed to fetch user profile', err));\n    }\n    \n    try {\n      json = JSON.parse(body);\n    } catch (ex) {\n      return done(new Error('Failed to parse user profile'));\n    }\n    \n    var profile = Profile.parse(json);\n    profile.provider  = 'github';\n    profile._raw = body;\n    profile._json = json;\n    \n    done(null, profile);\n  });\n}\n```\n\n+ 3. 解析用户信息函数实现\n``` javascript\nvar parse = function(json) {\n  if ('string' == typeof json) {\n    json = JSON.parse(json);\n  }\n  \n  var profile = {};\n  profile.id = String(json.id);\n  profile.displayName = json.name;\n  profile.username = json.login;\n  profile.profileUrl = json.html_url;\n  if (json.email) {\n    profile.emails = [{ value: json.email }];\n  }\n  \n  return profile;\n};\n```\n\n---\n\n**只需要三步骤，轻松实现授权认证！，`passport`官网已经有非常多的第三方认证实现，为了避免重复造轮子，请先查找是否有你要的插件: [Search Strategy](http://passportjs.org/)**\n\n","source":"_posts/使用passport管理第三方授权认证.md","raw":"---\ntitle: 使用passport管理第三方授权认证\ncategories: server\ndate: 2016-01-07 10:37:03\n---\n`passport`是一个为`Nodejs`设计的，兼容`Express`的认证中间件。通过第三方插件的形式(以下称为`strategy`)，可以应对各式各样的认证请求。`passport`具有高度的灵活性，并不依赖于任何一个路由，或者指定的数据存储，这样给上层开发者提供的极大的便利性。`passport`提供的接口也相对简单，只需要给它一个认证请求，`passport`会提供一个钩子函数(`hook`)告诉你请求失败了或者成功了。\n\n---\n\n### 1. passport的设计思路\n`passport`基于一个高度灵活的设计结构，主要由四个模块组成：`passport`插件(strategy)管理模块、`执行认证操作的授权模块`、`framewark适配模块`、`session管理模块`。其结构框图如下：\n\n![系统框图](http://www.tangide.com/storage/read.php?path=wechat/o/oSjbMs7GPu-gH9dZ4tsoo52y4gmo/blog/passport%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B.png)\n\n\n授权流程(引用`github oath2.0`来举例)\n\n![授权流程](http://www.tangide.com/storage/read.php?path=wechat/o/oSjbMs7GPu-gH9dZ4tsoo52y4gmo/blog/passport-%E6%8E%88%E6%9D%83%E6%B5%81%E7%A8%8B.png)\n\n+ 1.授权插件体系  \n所有的`passport`插件都继承自`passport-strategy`，紧接着根据不同的授权流程又细分为OAuth2.0授权中间件、OPENID类的授权中间件、以及帐号密码类的授权中间件。这些基本的中间件官方已经有了标准的实现。开发者需要做的是去继承这些授权中间件，针对不同的业务需求，配置特定的部分参数。就可以完成一整个授权的流程。常见的OAth2.0标准的授权插件有：`passport-github`、`passport-twitter`。这些针对不同厂商的第三方`Strategy`体量都非常小，基本在100行代码内可以搞定，因为大部分工作都交给标准的`strategy`来做了。\n\n\n+ 2.framework适配  \n`passport`官方的实现基于标准的`Express`形式的风格，也就是说，中间件的函数风格类似于：\n> function authenticate(req, res, next)\n>//如果需要适配其他的框架需要实现特定风格的`authenticate`函数。 \n\n\n\n+ 3.session管理  \n`passport`提供session的功能，如果开启该功能，则需要提供序列化，以及反序列化接口。`express-session`是一个很好的session管理包，所以还是让`passport`专注于授权认证吧！\n\n--- \n\n### 2. passport使用\n\n+ 1. 注入第三方`strategy`\n\n```javascript\n\nfunction verifyProfile(accessToken, refreshToken, profile, done) {\n  profile.accessToken = accessToken;\n   done(null, profile);\n}\n\npassport.use(new GithubStrategy({\nclientID: '123-456-789',\nclientSecret: 'easdasjdklasjd',\ncallbackURL: 'http://www.example.com/auth/github/callback'\n}), verifyProfile);\n\n```  \npassport提供`use`函数用于注入授权认证的插件、`unuse`用于注销认证插件。`verifyProfile`接口是一个`hook`，用来验证用户信息的有效性。\n\n\n+ 2. 授权认证  \n```javascript  \n\n//请求授权码\napp.get('/user/login/github', passport.authenricate('github', {scope: 'wl_scope'}));\n//获取accessToken以及请求用户信息，关闭session功能\napp.get('/auth/github/callback', passport.authenricate('github', {session: false, failureRedirect: '/'}));\n\n```  \n---\n\n### 3. passport源码分析\n\n+ 1. 授权认证入口函数  \n``` javascript\n\nAuthenticator.prototype.authenticate = function(strategy, options, callback) {\n  return this._framework.authenticate(this, strategy, options, callback);\n};\n\n```\n\n+ 2. express 风格的认证函数\n```javascript\n\nmodule.exports = function authenticate(passport, name, options, callback) {\n  if (typeof options == 'function') {\n    callback = options;\n    options = {};\n  }\n\n  return function authenticate(req, res, next) {\n\n     function allFailed() {\n      if (callback) {\n        if (!multi) {\n          return callback(null, false, failures[0].challenge, failures[0].status);\n        } else {\n          var challenges = failures.map(function(f) { return f.challenge; });\n          var statuses = failures.map(function(f) { return f.status; });\n          return callback(null, false, challenges, statuses);\n        }\n      }\n      ....\n    }\n    (function attempt(i) {\n      var layer = name[i];\n      // If no more strategies exist in the chain, authentication has failed.\n      if (!layer) { return allFailed(); }\n      var prototype = passport._strategy(layer);\n      if (!prototype) { return next(new Error('Unknown authentication strategy \"' + layer + '\"')); }\n    \n      var strategy = Object.create(prototype);\n      strategy.success = function(user, info) {\n        if (callback) {\n          return callback(null, user, info);\n        }\n        ....\n         req.logIn(user, options, function(err) {\n          if (err) { return next(err); }\n          \n          function complete() {\n            if (options.successReturnToOrRedirect) {\n              var url = options.successReturnToOrRedirect;\n              if (req.session && req.session.returnTo) {\n                url = req.session.returnTo;\n                delete req.session.returnTo;\n              }\n              return res.redirect(url);\n            }\n            if (options.successRedirect) {\n              return res.redirect(options.successRedirect);\n            }\n            next();\n          }\n          complete();\n      }\n       ....\n     //调用oauth2.0认证函数\n     strategy.authenticate(req, options);\n  })(0);\n\n\n```\n\n+ 3. Oauth2.0 认证函数\n\n```javascript\n\nOAuth2Strategy.prototype.authenticate = function(req, options) {\n  options = options || {};\n  var self = this;\n  \n  if (req.query && req.query.error) {\n    if (req.query.error == 'access_denied') {\n      return this.fail({ message: req.query.error_description });\n    } else {\n      return this.error(new AuthorizationError(req.query.error_description, req.query.error, req.query.error_uri));\n    }\n  }\n  \n  var callbackURL = options.callbackURL || this._callbackURL;\n  if (callbackURL) {\n    var parsed = url.parse(callbackURL);\n    if (!parsed.protocol) {\n      // The callback URL is relative, resolve a fully qualified URL from the\n      // URL of the originating request.\n      callbackURL = url.resolve(utils.originalURL(req, { proxy: this._trustProxy }), callbackURL);\n    }\n  }\n  \n  if (req.query && req.query.code) {\n   //根据授权码获取accessToken以及用户信息\n    var code = req.query.code;\n\n    var params = this.tokenParams(options);\n    params.grant_type = 'authorization_code';\n    params.redirect_uri = callbackURL;\n\n    this._oauth2.getOAuthAccessToken(code, params,\n      function(err, accessToken, refreshToken, params) {\n        if (err) { return self.error(self._createOAuthError('Failed to obtain access token', err)); }\n        \n        self._loadUserProfile(accessToken, function(err, profile) {\n          if (err) { return self.error(err); }\n          \n          function verified(err, user, info) {\n            if (err) { return self.error(err); }\n            if (!user) { return self.fail(info); }\n            self.success(user, info);\n          }\n          \n          try {\n            //_verify 就是注入插件的时候指定的用户信息校验函数只有通过该函数校验，认证才算完成，用户信息被`success`挂在req.user。\n            if (self._passReqToCallback) {\n              var arity = self._verify.length;\n              if (arity == 6) {\n                self._verify(req, accessToken, refreshToken, params, profile, verified);\n              } else { // arity == 5\n                self._verify(req, accessToken, refreshToken, profile, verified);\n              }\n            } else {\n              var arity = self._verify.length;\n              if (arity == 5) {\n                self._verify(accessToken, refreshToken, params, profile, verified);\n              } else { // arity == 4\n                self._verify(accessToken, refreshToken, profile, verified);\n              }\n            }\n          } catch (ex) {\n            return self.error(ex);\n          }\n        });\n      }\n    );\n  } else {\n   //获取授权码\n    var params = this.authorizationParams(options);\n    params.response_type = 'code';\n    params.redirect_uri = callbackURL;\n    var scope = options.scope || this._scope;\n    if (scope) {\n      if (Array.isArray(scope)) { scope = scope.join(this._scopeSeparator); }\n      params.scope = scope;\n    }\n\n    var location = this._oauth2.getAuthorizeUrl(params);\n    this.redirect(location);\n  }\n};\n\n```\n\n+ 4. 获取用户信息\n```javascript\n\nOAuth2Strategy.prototype._loadUserProfile = function(accessToken, done) {\n  var self = this;\n  \n  function loadIt() {\n    return self.userProfile(accessToken, done);\n  }\n  function skipIt() {\n    return done(null);\n  }\n  //通过_skipUserProfile参数跳过不需要获取用户信息的认证。\n  if (typeof this._skipUserProfile == 'function' && this._skipUserProfile.length > 1) {\n    // async\n    this._skipUserProfile(accessToken, function(err, skip) {\n      if (err) { return done(err); }\n      if (!skip) { return loadIt(); }\n      return skipIt();\n    });\n  } else {\n    var skip = (typeof this._skipUserProfile == 'function') ? this._skipUserProfile() : this._skipUserProfile;\n    if (!skip) { return loadIt(); }\n    return skipIt();\n  }\n};\n\n//第三方插件需要重载该接口实现用户信息的获取，`passport`把该接口完全开放给开发者。\nOAuth2Strategy.prototype.userProfile = function(accessToken, done) {\n  return done(null, {});\n};\n\n```\n\n--- \n\n### 4. 实现自己的`strategy`实现\n\n实现自己的第三方`passport-strategy`主要有三个步骤：\n\n+ 1. 继承`passport-oauth2`\n``` javascript\nfunction Strategy(options, verify) {\n  options = options || {};\n  options.authorizationURL = options.authorizationURL || 'https://github.com/login/oauth/authorize';\n  options.tokenURL = options.tokenURL || 'https://github.com/login/oauth/access_token';\n  options.scopeSeparator = options.scopeSeparator || ',';\n  options.customHeaders = options.customHeaders || {};\n\n  if (!options.customHeaders['User-Agent']) {\n    options.customHeaders['User-Agent'] = options.userAgent || 'passport-github';\n  }\n\n  OAuth2Strategy.call(this, options, verify);\n  this.name = 'github';\n  this._userProfileURL = options.userProfileURL || 'https://api.github.com/user';\n  this._oauth2.useAuthorizationHeaderforGET(true);\n}\n\n/**\n * Inherit from `OAuth2Strategy`.\n */\nutil.inherits(Strategy, OAuth2Strategy);\n```\n\n+ 2. 实现获取用户信息接口\n``` javascript  \nStrategy.prototype.userProfile = function(accessToken, done) {\n  this._oauth2.get(this._userProfileURL, accessToken, function (err, body, res) {\n    var json;\n    \n    if (err) {\n      return done(new InternalOAuthError('Failed to fetch user profile', err));\n    }\n    \n    try {\n      json = JSON.parse(body);\n    } catch (ex) {\n      return done(new Error('Failed to parse user profile'));\n    }\n    \n    var profile = Profile.parse(json);\n    profile.provider  = 'github';\n    profile._raw = body;\n    profile._json = json;\n    \n    done(null, profile);\n  });\n}\n```\n\n+ 3. 解析用户信息函数实现\n``` javascript\nvar parse = function(json) {\n  if ('string' == typeof json) {\n    json = JSON.parse(json);\n  }\n  \n  var profile = {};\n  profile.id = String(json.id);\n  profile.displayName = json.name;\n  profile.username = json.login;\n  profile.profileUrl = json.html_url;\n  if (json.email) {\n    profile.emails = [{ value: json.email }];\n  }\n  \n  return profile;\n};\n```\n\n---\n\n**只需要三步骤，轻松实现授权认证！，`passport`官网已经有非常多的第三方认证实现，为了避免重复造轮子，请先查找是否有你要的插件: [Search Strategy](http://passportjs.org/)**\n\n","slug":"使用passport管理第三方授权认证","published":1,"updated":"2018-07-01T10:30:46.498Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9ce6003zy4zvsjyvurll","content":"<p><code>passport</code>是一个为<code>Nodejs</code>设计的，兼容<code>Express</code>的认证中间件。通过第三方插件的形式(以下称为<code>strategy</code>)，可以应对各式各样的认证请求。<code>passport</code>具有高度的灵活性，并不依赖于任何一个路由，或者指定的数据存储，这样给上层开发者提供的极大的便利性。<code>passport</code>提供的接口也相对简单，只需要给它一个认证请求，<code>passport</code>会提供一个钩子函数(<code>hook</code>)告诉你请求失败了或者成功了。</p>\n<hr>\n<h3 id=\"1-passport的设计思路\"><a href=\"#1-passport的设计思路\" class=\"headerlink\" title=\"1. passport的设计思路\"></a>1. passport的设计思路</h3><p><code>passport</code>基于一个高度灵活的设计结构，主要由四个模块组成：<code>passport</code>插件(strategy)管理模块、<code>执行认证操作的授权模块</code>、<code>framewark适配模块</code>、<code>session管理模块</code>。其结构框图如下：</p>\n<p><img src=\"http://www.tangide.com/storage/read.php?path=wechat/o/oSjbMs7GPu-gH9dZ4tsoo52y4gmo/blog/passport%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B.png\" alt=\"系统框图\"></p>\n<p>授权流程(引用<code>github oath2.0</code>来举例)</p>\n<p><img src=\"http://www.tangide.com/storage/read.php?path=wechat/o/oSjbMs7GPu-gH9dZ4tsoo52y4gmo/blog/passport-%E6%8E%88%E6%9D%83%E6%B5%81%E7%A8%8B.png\" alt=\"授权流程\"></p>\n<ul>\n<li>1.授权插件体系<br>所有的<code>passport</code>插件都继承自<code>passport-strategy</code>，紧接着根据不同的授权流程又细分为OAuth2.0授权中间件、OPENID类的授权中间件、以及帐号密码类的授权中间件。这些基本的中间件官方已经有了标准的实现。开发者需要做的是去继承这些授权中间件，针对不同的业务需求，配置特定的部分参数。就可以完成一整个授权的流程。常见的OAth2.0标准的授权插件有：<code>passport-github</code>、<code>passport-twitter</code>。这些针对不同厂商的第三方<code>Strategy</code>体量都非常小，基本在100行代码内可以搞定，因为大部分工作都交给标准的<code>strategy</code>来做了。</li>\n</ul>\n<ul>\n<li>2.framework适配<br><code>passport</code>官方的实现基于标准的<code>Express</code>形式的风格，也就是说，中间件的函数风格类似于：<blockquote>\n<p>function authenticate(req, res, next)<br>//如果需要适配其他的框架需要实现特定风格的<code>authenticate</code>函数。 </p>\n</blockquote>\n</li>\n</ul>\n<ul>\n<li>3.session管理<br><code>passport</code>提供session的功能，如果开启该功能，则需要提供序列化，以及反序列化接口。<code>express-session</code>是一个很好的session管理包，所以还是让<code>passport</code>专注于授权认证吧！</li>\n</ul>\n<hr>\n<h3 id=\"2-passport使用\"><a href=\"#2-passport使用\" class=\"headerlink\" title=\"2. passport使用\"></a>2. passport使用</h3><ul>\n<li><ol>\n<li>注入第三方<code>strategy</code></li>\n</ol>\n</li>\n</ul>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">verifyProfile</span>(<span class=\"params\">accessToken, refreshToken, profile, done</span>) </span>&#123;</span><br><span class=\"line\">  profile.accessToken = accessToken;</span><br><span class=\"line\">   done(<span class=\"literal\">null</span>, profile);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">passport.use(<span class=\"keyword\">new</span> GithubStrategy(&#123;</span><br><span class=\"line\">clientID: <span class=\"string\">'123-456-789'</span>,</span><br><span class=\"line\">clientSecret: <span class=\"string\">'easdasjdklasjd'</span>,</span><br><span class=\"line\">callbackURL: <span class=\"string\">'http://www.example.com/auth/github/callback'</span></span><br><span class=\"line\">&#125;), verifyProfile);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\">passport提供`</span>use<span class=\"string\">`函数用于注入授权认证的插件、`</span>unuse<span class=\"string\">`用于注销认证插件。`</span>verifyProfile<span class=\"string\">`接口是一个`</span>hook<span class=\"string\">`，用来验证用户信息的有效性。</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">+ 2. 授权认证  </span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript  </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//请求授权码</span></span><br><span class=\"line\">app.get(<span class=\"string\">'/user/login/github'</span>, passport.authenricate(<span class=\"string\">'github'</span>, &#123;<span class=\"attr\">scope</span>: <span class=\"string\">'wl_scope'</span>&#125;));</span><br><span class=\"line\"><span class=\"comment\">//获取accessToken以及请求用户信息，关闭session功能</span></span><br><span class=\"line\">app.get(<span class=\"string\">'/auth/github/callback'</span>, passport.authenricate(<span class=\"string\">'github'</span>, &#123;<span class=\"attr\">session</span>: <span class=\"literal\">false</span>, <span class=\"attr\">failureRedirect</span>: <span class=\"string\">'/'</span>&#125;));</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">### 3. passport源码分析</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">+ 1. 授权认证入口函数  </span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span> javascript</span><br><span class=\"line\"></span><br><span class=\"line\">Authenticator.prototype.authenticate = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">strategy, options, callback</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>._framework.authenticate(<span class=\"keyword\">this</span>, strategy, options, callback);</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<ul>\n<li><ol start=\"2\">\n<li>express 风格的认证函数<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">module</span>.exports = <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">authenticate</span>(<span class=\"params\">passport, name, options, callback</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> options == <span class=\"string\">'function'</span>) &#123;</span><br><span class=\"line\">    callback = options;</span><br><span class=\"line\">    options = &#123;&#125;;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">authenticate</span>(<span class=\"params\">req, res, next</span>) </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">     <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">allFailed</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (callback) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!multi) &#123;</span><br><span class=\"line\">          <span class=\"keyword\">return</span> callback(<span class=\"literal\">null</span>, <span class=\"literal\">false</span>, failures[<span class=\"number\">0</span>].challenge, failures[<span class=\"number\">0</span>].status);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">var</span> challenges = failures.map(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">f</span>) </span>&#123; <span class=\"keyword\">return</span> f.challenge; &#125;);</span><br><span class=\"line\">          <span class=\"keyword\">var</span> statuses = failures.map(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">f</span>) </span>&#123; <span class=\"keyword\">return</span> f.status; &#125;);</span><br><span class=\"line\">          <span class=\"keyword\">return</span> callback(<span class=\"literal\">null</span>, <span class=\"literal\">false</span>, challenges, statuses);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      ....</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    (<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">attempt</span>(<span class=\"params\">i</span>) </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">var</span> layer = name[i];</span><br><span class=\"line\">      <span class=\"comment\">// If no more strategies exist in the chain, authentication has failed.</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!layer) &#123; <span class=\"keyword\">return</span> allFailed(); &#125;</span><br><span class=\"line\">      <span class=\"keyword\">var</span> prototype = passport._strategy(layer);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!prototype) &#123; <span class=\"keyword\">return</span> next(<span class=\"keyword\">new</span> <span class=\"built_in\">Error</span>(<span class=\"string\">'Unknown authentication strategy \"'</span> + layer + <span class=\"string\">'\"'</span>)); &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">      <span class=\"keyword\">var</span> strategy = <span class=\"built_in\">Object</span>.create(prototype);</span><br><span class=\"line\">      strategy.success = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">user, info</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (callback) &#123;</span><br><span class=\"line\">          <span class=\"keyword\">return</span> callback(<span class=\"literal\">null</span>, user, info);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        ....</span><br><span class=\"line\">         req.logIn(user, options, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">err</span>) </span>&#123;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (err) &#123; <span class=\"keyword\">return</span> next(err); &#125;</span><br><span class=\"line\">          </span><br><span class=\"line\">          <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">complete</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (options.successReturnToOrRedirect) &#123;</span><br><span class=\"line\">              <span class=\"keyword\">var</span> url = options.successReturnToOrRedirect;</span><br><span class=\"line\">              <span class=\"keyword\">if</span> (req.session &amp;&amp; req.session.returnTo) &#123;</span><br><span class=\"line\">                url = req.session.returnTo;</span><br><span class=\"line\">                <span class=\"keyword\">delete</span> req.session.returnTo;</span><br><span class=\"line\">              &#125;</span><br><span class=\"line\">              <span class=\"keyword\">return</span> res.redirect(url);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (options.successRedirect) &#123;</span><br><span class=\"line\">              <span class=\"keyword\">return</span> res.redirect(options.successRedirect);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            next();</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          complete();</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">       ....</span><br><span class=\"line\">     <span class=\"comment\">//调用oauth2.0认证函数</span></span><br><span class=\"line\">     strategy.authenticate(req, options);</span><br><span class=\"line\">  &#125;)(<span class=\"number\">0</span>);</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</li>\n<li><ol start=\"3\">\n<li>Oauth2.0 认证函数</li>\n</ol>\n</li>\n</ul>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">OAuth2Strategy.prototype.authenticate = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">req, options</span>) </span>&#123;</span><br><span class=\"line\">  options = options || &#123;&#125;;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> self = <span class=\"keyword\">this</span>;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (req.query &amp;&amp; req.query.error) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (req.query.error == <span class=\"string\">'access_denied'</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.fail(&#123; <span class=\"attr\">message</span>: req.query.error_description &#125;);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.error(<span class=\"keyword\">new</span> AuthorizationError(req.query.error_description, req.query.error, req.query.error_uri));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"keyword\">var</span> callbackURL = options.callbackURL || <span class=\"keyword\">this</span>._callbackURL;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (callbackURL) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> parsed = url.parse(callbackURL);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!parsed.protocol) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// The callback URL is relative, resolve a fully qualified URL from the</span></span><br><span class=\"line\">      <span class=\"comment\">// URL of the originating request.</span></span><br><span class=\"line\">      callbackURL = url.resolve(utils.originalURL(req, &#123; <span class=\"attr\">proxy</span>: <span class=\"keyword\">this</span>._trustProxy &#125;), callbackURL);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (req.query &amp;&amp; req.query.code) &#123;</span><br><span class=\"line\">   <span class=\"comment\">//根据授权码获取accessToken以及用户信息</span></span><br><span class=\"line\">    <span class=\"keyword\">var</span> code = req.query.code;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">var</span> params = <span class=\"keyword\">this</span>.tokenParams(options);</span><br><span class=\"line\">    params.grant_type = <span class=\"string\">'authorization_code'</span>;</span><br><span class=\"line\">    params.redirect_uri = callbackURL;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">this</span>._oauth2.getOAuthAccessToken(code, params,</span><br><span class=\"line\">      <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">err, accessToken, refreshToken, params</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (err) &#123; <span class=\"keyword\">return</span> self.error(self._createOAuthError(<span class=\"string\">'Failed to obtain access token'</span>, err)); &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        self._loadUserProfile(accessToken, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">err, profile</span>) </span>&#123;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (err) &#123; <span class=\"keyword\">return</span> self.error(err); &#125;</span><br><span class=\"line\">          </span><br><span class=\"line\">          <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">verified</span>(<span class=\"params\">err, user, info</span>) </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (err) &#123; <span class=\"keyword\">return</span> self.error(err); &#125;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!user) &#123; <span class=\"keyword\">return</span> self.fail(info); &#125;</span><br><span class=\"line\">            self.success(user, info);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          </span><br><span class=\"line\">          <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">//_verify 就是注入插件的时候指定的用户信息校验函数只有通过该函数校验，认证才算完成，用户信息被`success`挂在req.user。</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (self._passReqToCallback) &#123;</span><br><span class=\"line\">              <span class=\"keyword\">var</span> arity = self._verify.length;</span><br><span class=\"line\">              <span class=\"keyword\">if</span> (arity == <span class=\"number\">6</span>) &#123;</span><br><span class=\"line\">                self._verify(req, accessToken, refreshToken, params, profile, verified);</span><br><span class=\"line\">              &#125; <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// arity == 5</span></span><br><span class=\"line\">                self._verify(req, accessToken, refreshToken, profile, verified);</span><br><span class=\"line\">              &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">              <span class=\"keyword\">var</span> arity = self._verify.length;</span><br><span class=\"line\">              <span class=\"keyword\">if</span> (arity == <span class=\"number\">5</span>) &#123;</span><br><span class=\"line\">                self._verify(accessToken, refreshToken, params, profile, verified);</span><br><span class=\"line\">              &#125; <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// arity == 4</span></span><br><span class=\"line\">                self._verify(accessToken, refreshToken, profile, verified);</span><br><span class=\"line\">              &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125; <span class=\"keyword\">catch</span> (ex) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> self.error(ex);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    );</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">   <span class=\"comment\">//获取授权码</span></span><br><span class=\"line\">    <span class=\"keyword\">var</span> params = <span class=\"keyword\">this</span>.authorizationParams(options);</span><br><span class=\"line\">    params.response_type = <span class=\"string\">'code'</span>;</span><br><span class=\"line\">    params.redirect_uri = callbackURL;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> scope = options.scope || <span class=\"keyword\">this</span>._scope;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (scope) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"built_in\">Array</span>.isArray(scope)) &#123; scope = scope.join(<span class=\"keyword\">this</span>._scopeSeparator); &#125;</span><br><span class=\"line\">      params.scope = scope;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">var</span> location = <span class=\"keyword\">this</span>._oauth2.getAuthorizeUrl(params);</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.redirect(location);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<ul>\n<li><ol start=\"4\">\n<li>获取用户信息<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">OAuth2Strategy.prototype._loadUserProfile = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">accessToken, done</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> self = <span class=\"keyword\">this</span>;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">loadIt</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> self.userProfile(accessToken, done);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">skipIt</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> done(<span class=\"literal\">null</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">//通过_skipUserProfile参数跳过不需要获取用户信息的认证。</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> <span class=\"keyword\">this</span>._skipUserProfile == <span class=\"string\">'function'</span> &amp;&amp; <span class=\"keyword\">this</span>._skipUserProfile.length &gt; <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// async</span></span><br><span class=\"line\">    <span class=\"keyword\">this</span>._skipUserProfile(accessToken, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">err, skip</span>) </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (err) &#123; <span class=\"keyword\">return</span> done(err); &#125;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!skip) &#123; <span class=\"keyword\">return</span> loadIt(); &#125;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> skipIt();</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> skip = (<span class=\"keyword\">typeof</span> <span class=\"keyword\">this</span>._skipUserProfile == <span class=\"string\">'function'</span>) ? <span class=\"keyword\">this</span>._skipUserProfile() : <span class=\"keyword\">this</span>._skipUserProfile;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!skip) &#123; <span class=\"keyword\">return</span> loadIt(); &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> skipIt();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//第三方插件需要重载该接口实现用户信息的获取，`passport`把该接口完全开放给开发者。</span></span><br><span class=\"line\">OAuth2Strategy.prototype.userProfile = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">accessToken, done</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> done(<span class=\"literal\">null</span>, &#123;&#125;);</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</li>\n</ul>\n<hr>\n<h3 id=\"4-实现自己的strategy实现\"><a href=\"#4-实现自己的strategy实现\" class=\"headerlink\" title=\"4. 实现自己的strategy实现\"></a>4. 实现自己的<code>strategy</code>实现</h3><p>实现自己的第三方<code>passport-strategy</code>主要有三个步骤：</p>\n<ul>\n<li><ol>\n<li>继承<code>passport-oauth2</code><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">Strategy</span>(<span class=\"params\">options, verify</span>) </span>&#123;</span><br><span class=\"line\">  options = options || &#123;&#125;;</span><br><span class=\"line\">  options.authorizationURL = options.authorizationURL || <span class=\"string\">'https://github.com/login/oauth/authorize'</span>;</span><br><span class=\"line\">  options.tokenURL = options.tokenURL || <span class=\"string\">'https://github.com/login/oauth/access_token'</span>;</span><br><span class=\"line\">  options.scopeSeparator = options.scopeSeparator || <span class=\"string\">','</span>;</span><br><span class=\"line\">  options.customHeaders = options.customHeaders || &#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!options.customHeaders[<span class=\"string\">'User-Agent'</span>]) &#123;</span><br><span class=\"line\">    options.customHeaders[<span class=\"string\">'User-Agent'</span>] = options.userAgent || <span class=\"string\">'passport-github'</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  OAuth2Strategy.call(<span class=\"keyword\">this</span>, options, verify);</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.name = <span class=\"string\">'github'</span>;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>._userProfileURL = options.userProfileURL || <span class=\"string\">'https://api.github.com/user'</span>;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>._oauth2.useAuthorizationHeaderforGET(<span class=\"literal\">true</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Inherit from `OAuth2Strategy`.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\">util.inherits(Strategy, OAuth2Strategy);</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</li>\n<li><ol start=\"2\">\n<li>实现获取用户信息接口<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Strategy.prototype.userProfile = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">accessToken, done</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>._oauth2.get(<span class=\"keyword\">this</span>._userProfileURL, accessToken, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">err, body, res</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> json;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (err) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> done(<span class=\"keyword\">new</span> InternalOAuthError(<span class=\"string\">'Failed to fetch user profile'</span>, err));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">      json = <span class=\"built_in\">JSON</span>.parse(body);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (ex) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> done(<span class=\"keyword\">new</span> <span class=\"built_in\">Error</span>(<span class=\"string\">'Failed to parse user profile'</span>));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">var</span> profile = Profile.parse(json);</span><br><span class=\"line\">    profile.provider  = <span class=\"string\">'github'</span>;</span><br><span class=\"line\">    profile._raw = body;</span><br><span class=\"line\">    profile._json = json;</span><br><span class=\"line\">    </span><br><span class=\"line\">    done(<span class=\"literal\">null</span>, profile);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</li>\n<li><ol start=\"3\">\n<li>解析用户信息函数实现<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> parse = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">json</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"string\">'string'</span> == <span class=\"keyword\">typeof</span> json) &#123;</span><br><span class=\"line\">    json = <span class=\"built_in\">JSON</span>.parse(json);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"keyword\">var</span> profile = &#123;&#125;;</span><br><span class=\"line\">  profile.id = <span class=\"built_in\">String</span>(json.id);</span><br><span class=\"line\">  profile.displayName = json.name;</span><br><span class=\"line\">  profile.username = json.login;</span><br><span class=\"line\">  profile.profileUrl = json.html_url;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (json.email) &#123;</span><br><span class=\"line\">    profile.emails = [&#123; <span class=\"attr\">value</span>: json.email &#125;];</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"keyword\">return</span> profile;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</li>\n</ul>\n<hr>\n<p><strong>只需要三步骤，轻松实现授权认证！，<code>passport</code>官网已经有非常多的第三方认证实现，为了避免重复造轮子，请先查找是否有你要的插件: <a href=\"http://passportjs.org/\" target=\"_blank\" rel=\"noopener\">Search Strategy</a></strong></p>\n","site":{"data":{}},"excerpt":"","more":"<p><code>passport</code>是一个为<code>Nodejs</code>设计的，兼容<code>Express</code>的认证中间件。通过第三方插件的形式(以下称为<code>strategy</code>)，可以应对各式各样的认证请求。<code>passport</code>具有高度的灵活性，并不依赖于任何一个路由，或者指定的数据存储，这样给上层开发者提供的极大的便利性。<code>passport</code>提供的接口也相对简单，只需要给它一个认证请求，<code>passport</code>会提供一个钩子函数(<code>hook</code>)告诉你请求失败了或者成功了。</p>\n<hr>\n<h3 id=\"1-passport的设计思路\"><a href=\"#1-passport的设计思路\" class=\"headerlink\" title=\"1. passport的设计思路\"></a>1. passport的设计思路</h3><p><code>passport</code>基于一个高度灵活的设计结构，主要由四个模块组成：<code>passport</code>插件(strategy)管理模块、<code>执行认证操作的授权模块</code>、<code>framewark适配模块</code>、<code>session管理模块</code>。其结构框图如下：</p>\n<p><img src=\"http://www.tangide.com/storage/read.php?path=wechat/o/oSjbMs7GPu-gH9dZ4tsoo52y4gmo/blog/passport%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B.png\" alt=\"系统框图\"></p>\n<p>授权流程(引用<code>github oath2.0</code>来举例)</p>\n<p><img src=\"http://www.tangide.com/storage/read.php?path=wechat/o/oSjbMs7GPu-gH9dZ4tsoo52y4gmo/blog/passport-%E6%8E%88%E6%9D%83%E6%B5%81%E7%A8%8B.png\" alt=\"授权流程\"></p>\n<ul>\n<li>1.授权插件体系<br>所有的<code>passport</code>插件都继承自<code>passport-strategy</code>，紧接着根据不同的授权流程又细分为OAuth2.0授权中间件、OPENID类的授权中间件、以及帐号密码类的授权中间件。这些基本的中间件官方已经有了标准的实现。开发者需要做的是去继承这些授权中间件，针对不同的业务需求，配置特定的部分参数。就可以完成一整个授权的流程。常见的OAth2.0标准的授权插件有：<code>passport-github</code>、<code>passport-twitter</code>。这些针对不同厂商的第三方<code>Strategy</code>体量都非常小，基本在100行代码内可以搞定，因为大部分工作都交给标准的<code>strategy</code>来做了。</li>\n</ul>\n<ul>\n<li>2.framework适配<br><code>passport</code>官方的实现基于标准的<code>Express</code>形式的风格，也就是说，中间件的函数风格类似于：<blockquote>\n<p>function authenticate(req, res, next)<br>//如果需要适配其他的框架需要实现特定风格的<code>authenticate</code>函数。 </p>\n</blockquote>\n</li>\n</ul>\n<ul>\n<li>3.session管理<br><code>passport</code>提供session的功能，如果开启该功能，则需要提供序列化，以及反序列化接口。<code>express-session</code>是一个很好的session管理包，所以还是让<code>passport</code>专注于授权认证吧！</li>\n</ul>\n<hr>\n<h3 id=\"2-passport使用\"><a href=\"#2-passport使用\" class=\"headerlink\" title=\"2. passport使用\"></a>2. passport使用</h3><ul>\n<li><ol>\n<li>注入第三方<code>strategy</code></li>\n</ol>\n</li>\n</ul>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">verifyProfile</span>(<span class=\"params\">accessToken, refreshToken, profile, done</span>) </span>&#123;</span><br><span class=\"line\">  profile.accessToken = accessToken;</span><br><span class=\"line\">   done(<span class=\"literal\">null</span>, profile);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">passport.use(<span class=\"keyword\">new</span> GithubStrategy(&#123;</span><br><span class=\"line\">clientID: <span class=\"string\">'123-456-789'</span>,</span><br><span class=\"line\">clientSecret: <span class=\"string\">'easdasjdklasjd'</span>,</span><br><span class=\"line\">callbackURL: <span class=\"string\">'http://www.example.com/auth/github/callback'</span></span><br><span class=\"line\">&#125;), verifyProfile);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\">passport提供`</span>use<span class=\"string\">`函数用于注入授权认证的插件、`</span>unuse<span class=\"string\">`用于注销认证插件。`</span>verifyProfile<span class=\"string\">`接口是一个`</span>hook<span class=\"string\">`，用来验证用户信息的有效性。</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">+ 2. 授权认证  </span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript  </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//请求授权码</span></span><br><span class=\"line\">app.get(<span class=\"string\">'/user/login/github'</span>, passport.authenricate(<span class=\"string\">'github'</span>, &#123;<span class=\"attr\">scope</span>: <span class=\"string\">'wl_scope'</span>&#125;));</span><br><span class=\"line\"><span class=\"comment\">//获取accessToken以及请求用户信息，关闭session功能</span></span><br><span class=\"line\">app.get(<span class=\"string\">'/auth/github/callback'</span>, passport.authenricate(<span class=\"string\">'github'</span>, &#123;<span class=\"attr\">session</span>: <span class=\"literal\">false</span>, <span class=\"attr\">failureRedirect</span>: <span class=\"string\">'/'</span>&#125;));</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">### 3. passport源码分析</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">+ 1. 授权认证入口函数  </span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span> javascript</span><br><span class=\"line\"></span><br><span class=\"line\">Authenticator.prototype.authenticate = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">strategy, options, callback</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>._framework.authenticate(<span class=\"keyword\">this</span>, strategy, options, callback);</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<ul>\n<li><ol start=\"2\">\n<li>express 风格的认证函数<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">module</span>.exports = <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">authenticate</span>(<span class=\"params\">passport, name, options, callback</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> options == <span class=\"string\">'function'</span>) &#123;</span><br><span class=\"line\">    callback = options;</span><br><span class=\"line\">    options = &#123;&#125;;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">authenticate</span>(<span class=\"params\">req, res, next</span>) </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">     <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">allFailed</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (callback) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!multi) &#123;</span><br><span class=\"line\">          <span class=\"keyword\">return</span> callback(<span class=\"literal\">null</span>, <span class=\"literal\">false</span>, failures[<span class=\"number\">0</span>].challenge, failures[<span class=\"number\">0</span>].status);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">var</span> challenges = failures.map(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">f</span>) </span>&#123; <span class=\"keyword\">return</span> f.challenge; &#125;);</span><br><span class=\"line\">          <span class=\"keyword\">var</span> statuses = failures.map(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">f</span>) </span>&#123; <span class=\"keyword\">return</span> f.status; &#125;);</span><br><span class=\"line\">          <span class=\"keyword\">return</span> callback(<span class=\"literal\">null</span>, <span class=\"literal\">false</span>, challenges, statuses);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      ....</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    (<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">attempt</span>(<span class=\"params\">i</span>) </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">var</span> layer = name[i];</span><br><span class=\"line\">      <span class=\"comment\">// If no more strategies exist in the chain, authentication has failed.</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!layer) &#123; <span class=\"keyword\">return</span> allFailed(); &#125;</span><br><span class=\"line\">      <span class=\"keyword\">var</span> prototype = passport._strategy(layer);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!prototype) &#123; <span class=\"keyword\">return</span> next(<span class=\"keyword\">new</span> <span class=\"built_in\">Error</span>(<span class=\"string\">'Unknown authentication strategy \"'</span> + layer + <span class=\"string\">'\"'</span>)); &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">      <span class=\"keyword\">var</span> strategy = <span class=\"built_in\">Object</span>.create(prototype);</span><br><span class=\"line\">      strategy.success = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">user, info</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (callback) &#123;</span><br><span class=\"line\">          <span class=\"keyword\">return</span> callback(<span class=\"literal\">null</span>, user, info);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        ....</span><br><span class=\"line\">         req.logIn(user, options, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">err</span>) </span>&#123;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (err) &#123; <span class=\"keyword\">return</span> next(err); &#125;</span><br><span class=\"line\">          </span><br><span class=\"line\">          <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">complete</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (options.successReturnToOrRedirect) &#123;</span><br><span class=\"line\">              <span class=\"keyword\">var</span> url = options.successReturnToOrRedirect;</span><br><span class=\"line\">              <span class=\"keyword\">if</span> (req.session &amp;&amp; req.session.returnTo) &#123;</span><br><span class=\"line\">                url = req.session.returnTo;</span><br><span class=\"line\">                <span class=\"keyword\">delete</span> req.session.returnTo;</span><br><span class=\"line\">              &#125;</span><br><span class=\"line\">              <span class=\"keyword\">return</span> res.redirect(url);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (options.successRedirect) &#123;</span><br><span class=\"line\">              <span class=\"keyword\">return</span> res.redirect(options.successRedirect);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            next();</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          complete();</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">       ....</span><br><span class=\"line\">     <span class=\"comment\">//调用oauth2.0认证函数</span></span><br><span class=\"line\">     strategy.authenticate(req, options);</span><br><span class=\"line\">  &#125;)(<span class=\"number\">0</span>);</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</li>\n<li><ol start=\"3\">\n<li>Oauth2.0 认证函数</li>\n</ol>\n</li>\n</ul>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">OAuth2Strategy.prototype.authenticate = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">req, options</span>) </span>&#123;</span><br><span class=\"line\">  options = options || &#123;&#125;;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> self = <span class=\"keyword\">this</span>;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (req.query &amp;&amp; req.query.error) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (req.query.error == <span class=\"string\">'access_denied'</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.fail(&#123; <span class=\"attr\">message</span>: req.query.error_description &#125;);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.error(<span class=\"keyword\">new</span> AuthorizationError(req.query.error_description, req.query.error, req.query.error_uri));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"keyword\">var</span> callbackURL = options.callbackURL || <span class=\"keyword\">this</span>._callbackURL;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (callbackURL) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> parsed = url.parse(callbackURL);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!parsed.protocol) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// The callback URL is relative, resolve a fully qualified URL from the</span></span><br><span class=\"line\">      <span class=\"comment\">// URL of the originating request.</span></span><br><span class=\"line\">      callbackURL = url.resolve(utils.originalURL(req, &#123; <span class=\"attr\">proxy</span>: <span class=\"keyword\">this</span>._trustProxy &#125;), callbackURL);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (req.query &amp;&amp; req.query.code) &#123;</span><br><span class=\"line\">   <span class=\"comment\">//根据授权码获取accessToken以及用户信息</span></span><br><span class=\"line\">    <span class=\"keyword\">var</span> code = req.query.code;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">var</span> params = <span class=\"keyword\">this</span>.tokenParams(options);</span><br><span class=\"line\">    params.grant_type = <span class=\"string\">'authorization_code'</span>;</span><br><span class=\"line\">    params.redirect_uri = callbackURL;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">this</span>._oauth2.getOAuthAccessToken(code, params,</span><br><span class=\"line\">      <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">err, accessToken, refreshToken, params</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (err) &#123; <span class=\"keyword\">return</span> self.error(self._createOAuthError(<span class=\"string\">'Failed to obtain access token'</span>, err)); &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        self._loadUserProfile(accessToken, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">err, profile</span>) </span>&#123;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (err) &#123; <span class=\"keyword\">return</span> self.error(err); &#125;</span><br><span class=\"line\">          </span><br><span class=\"line\">          <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">verified</span>(<span class=\"params\">err, user, info</span>) </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (err) &#123; <span class=\"keyword\">return</span> self.error(err); &#125;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!user) &#123; <span class=\"keyword\">return</span> self.fail(info); &#125;</span><br><span class=\"line\">            self.success(user, info);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          </span><br><span class=\"line\">          <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">//_verify 就是注入插件的时候指定的用户信息校验函数只有通过该函数校验，认证才算完成，用户信息被`success`挂在req.user。</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (self._passReqToCallback) &#123;</span><br><span class=\"line\">              <span class=\"keyword\">var</span> arity = self._verify.length;</span><br><span class=\"line\">              <span class=\"keyword\">if</span> (arity == <span class=\"number\">6</span>) &#123;</span><br><span class=\"line\">                self._verify(req, accessToken, refreshToken, params, profile, verified);</span><br><span class=\"line\">              &#125; <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// arity == 5</span></span><br><span class=\"line\">                self._verify(req, accessToken, refreshToken, profile, verified);</span><br><span class=\"line\">              &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">              <span class=\"keyword\">var</span> arity = self._verify.length;</span><br><span class=\"line\">              <span class=\"keyword\">if</span> (arity == <span class=\"number\">5</span>) &#123;</span><br><span class=\"line\">                self._verify(accessToken, refreshToken, params, profile, verified);</span><br><span class=\"line\">              &#125; <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// arity == 4</span></span><br><span class=\"line\">                self._verify(accessToken, refreshToken, profile, verified);</span><br><span class=\"line\">              &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125; <span class=\"keyword\">catch</span> (ex) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> self.error(ex);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    );</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">   <span class=\"comment\">//获取授权码</span></span><br><span class=\"line\">    <span class=\"keyword\">var</span> params = <span class=\"keyword\">this</span>.authorizationParams(options);</span><br><span class=\"line\">    params.response_type = <span class=\"string\">'code'</span>;</span><br><span class=\"line\">    params.redirect_uri = callbackURL;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> scope = options.scope || <span class=\"keyword\">this</span>._scope;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (scope) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"built_in\">Array</span>.isArray(scope)) &#123; scope = scope.join(<span class=\"keyword\">this</span>._scopeSeparator); &#125;</span><br><span class=\"line\">      params.scope = scope;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">var</span> location = <span class=\"keyword\">this</span>._oauth2.getAuthorizeUrl(params);</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.redirect(location);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<ul>\n<li><ol start=\"4\">\n<li>获取用户信息<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">OAuth2Strategy.prototype._loadUserProfile = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">accessToken, done</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> self = <span class=\"keyword\">this</span>;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">loadIt</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> self.userProfile(accessToken, done);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">skipIt</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> done(<span class=\"literal\">null</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">//通过_skipUserProfile参数跳过不需要获取用户信息的认证。</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> <span class=\"keyword\">this</span>._skipUserProfile == <span class=\"string\">'function'</span> &amp;&amp; <span class=\"keyword\">this</span>._skipUserProfile.length &gt; <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// async</span></span><br><span class=\"line\">    <span class=\"keyword\">this</span>._skipUserProfile(accessToken, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">err, skip</span>) </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (err) &#123; <span class=\"keyword\">return</span> done(err); &#125;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!skip) &#123; <span class=\"keyword\">return</span> loadIt(); &#125;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> skipIt();</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> skip = (<span class=\"keyword\">typeof</span> <span class=\"keyword\">this</span>._skipUserProfile == <span class=\"string\">'function'</span>) ? <span class=\"keyword\">this</span>._skipUserProfile() : <span class=\"keyword\">this</span>._skipUserProfile;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!skip) &#123; <span class=\"keyword\">return</span> loadIt(); &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> skipIt();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//第三方插件需要重载该接口实现用户信息的获取，`passport`把该接口完全开放给开发者。</span></span><br><span class=\"line\">OAuth2Strategy.prototype.userProfile = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">accessToken, done</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> done(<span class=\"literal\">null</span>, &#123;&#125;);</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</li>\n</ul>\n<hr>\n<h3 id=\"4-实现自己的strategy实现\"><a href=\"#4-实现自己的strategy实现\" class=\"headerlink\" title=\"4. 实现自己的strategy实现\"></a>4. 实现自己的<code>strategy</code>实现</h3><p>实现自己的第三方<code>passport-strategy</code>主要有三个步骤：</p>\n<ul>\n<li><ol>\n<li>继承<code>passport-oauth2</code><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">Strategy</span>(<span class=\"params\">options, verify</span>) </span>&#123;</span><br><span class=\"line\">  options = options || &#123;&#125;;</span><br><span class=\"line\">  options.authorizationURL = options.authorizationURL || <span class=\"string\">'https://github.com/login/oauth/authorize'</span>;</span><br><span class=\"line\">  options.tokenURL = options.tokenURL || <span class=\"string\">'https://github.com/login/oauth/access_token'</span>;</span><br><span class=\"line\">  options.scopeSeparator = options.scopeSeparator || <span class=\"string\">','</span>;</span><br><span class=\"line\">  options.customHeaders = options.customHeaders || &#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!options.customHeaders[<span class=\"string\">'User-Agent'</span>]) &#123;</span><br><span class=\"line\">    options.customHeaders[<span class=\"string\">'User-Agent'</span>] = options.userAgent || <span class=\"string\">'passport-github'</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  OAuth2Strategy.call(<span class=\"keyword\">this</span>, options, verify);</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.name = <span class=\"string\">'github'</span>;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>._userProfileURL = options.userProfileURL || <span class=\"string\">'https://api.github.com/user'</span>;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>._oauth2.useAuthorizationHeaderforGET(<span class=\"literal\">true</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Inherit from `OAuth2Strategy`.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\">util.inherits(Strategy, OAuth2Strategy);</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</li>\n<li><ol start=\"2\">\n<li>实现获取用户信息接口<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Strategy.prototype.userProfile = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">accessToken, done</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>._oauth2.get(<span class=\"keyword\">this</span>._userProfileURL, accessToken, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">err, body, res</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> json;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (err) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> done(<span class=\"keyword\">new</span> InternalOAuthError(<span class=\"string\">'Failed to fetch user profile'</span>, err));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">      json = <span class=\"built_in\">JSON</span>.parse(body);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (ex) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> done(<span class=\"keyword\">new</span> <span class=\"built_in\">Error</span>(<span class=\"string\">'Failed to parse user profile'</span>));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">var</span> profile = Profile.parse(json);</span><br><span class=\"line\">    profile.provider  = <span class=\"string\">'github'</span>;</span><br><span class=\"line\">    profile._raw = body;</span><br><span class=\"line\">    profile._json = json;</span><br><span class=\"line\">    </span><br><span class=\"line\">    done(<span class=\"literal\">null</span>, profile);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</li>\n<li><ol start=\"3\">\n<li>解析用户信息函数实现<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> parse = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">json</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"string\">'string'</span> == <span class=\"keyword\">typeof</span> json) &#123;</span><br><span class=\"line\">    json = <span class=\"built_in\">JSON</span>.parse(json);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"keyword\">var</span> profile = &#123;&#125;;</span><br><span class=\"line\">  profile.id = <span class=\"built_in\">String</span>(json.id);</span><br><span class=\"line\">  profile.displayName = json.name;</span><br><span class=\"line\">  profile.username = json.login;</span><br><span class=\"line\">  profile.profileUrl = json.html_url;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (json.email) &#123;</span><br><span class=\"line\">    profile.emails = [&#123; <span class=\"attr\">value</span>: json.email &#125;];</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"keyword\">return</span> profile;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</li>\n</ul>\n<hr>\n<p><strong>只需要三步骤，轻松实现授权认证！，<code>passport</code>官网已经有非常多的第三方认证实现，为了避免重复造轮子，请先查找是否有你要的插件: <a href=\"http://passportjs.org/\" target=\"_blank\" rel=\"noopener\">Search Strategy</a></strong></p>\n"},{"title":"分布式ID生成","date":"2018-09-26T06:10:35.000Z","_content":"\n在分布式系统的大环境下，传统的自增方式生成唯一ID已经不太适用了，因为等到业务规模大到一定的体量的时候，必须要考虑到分库分表的问题，就不能保证ID的唯一性。所以我们需要一个替代方案来生成唯一ID。\n\n现有的几种全局ID生成方式：\n\n+ 通过redis自增数值\n+ Twitter`snowflake`算法\n+ 美团点评`Leaf`分布式ID生成系统\n  \n\n### 利用redis生成唯一ID\n\nredis是一个单进程单线程的架构（不考虑到快照备份、数据同步等）。其有一个`incr`原子指令，用于对数值加1操作。并返回执行 INCR 命令之后 key 的值。\n\n+ 优点，自增ID天然有序，对于数据库索引写入性能较好。\n+ 缺点，引入redis相当于引入了一个单点的性能瓶颈，同时增加了系统的复杂度和维护成本。\n\n\n### Twitter`snowflake`算法\n\n![snowflake](/img/snowflake)\n\n`snowflake`生成一个64位的数值，前41bit是一个时间戳，精确到毫秒，中间10个bit用于表示机器组，一个集群最多可以表示1024台机器，后12bit表示随机数。2^12=4096，即：每台机器每毫秒最多可以生成4096个ID。\n\n+ 优点，实现简单，不依赖于第三方组件。\n+ 缺点，在并发量大的情况下会出现ID冲突的情况。\n\n\n### 美团点评`Leaf`分布式ID生成系统\n\nLeaf 是美团开源的分布式ID生成器，能保证全局唯一性、趋势递增、单调递增、信息安全，里面也提到了几种分布式方案的对比，但也需要依赖关系数据库、Zookeeper等中间件。\n\n具体可以参考官网说明: [Leaf 分布式ID](https://tech.meituan.com/MT_Leaf.html)\n\n\n","source":"_posts/分布式ID生成.md","raw":"---\ntitle: 分布式ID生成\ndate: 2018-9-26 14:10:35\ntags:\ncategories: 数据库\n---\n\n在分布式系统的大环境下，传统的自增方式生成唯一ID已经不太适用了，因为等到业务规模大到一定的体量的时候，必须要考虑到分库分表的问题，就不能保证ID的唯一性。所以我们需要一个替代方案来生成唯一ID。\n\n现有的几种全局ID生成方式：\n\n+ 通过redis自增数值\n+ Twitter`snowflake`算法\n+ 美团点评`Leaf`分布式ID生成系统\n  \n\n### 利用redis生成唯一ID\n\nredis是一个单进程单线程的架构（不考虑到快照备份、数据同步等）。其有一个`incr`原子指令，用于对数值加1操作。并返回执行 INCR 命令之后 key 的值。\n\n+ 优点，自增ID天然有序，对于数据库索引写入性能较好。\n+ 缺点，引入redis相当于引入了一个单点的性能瓶颈，同时增加了系统的复杂度和维护成本。\n\n\n### Twitter`snowflake`算法\n\n![snowflake](/img/snowflake)\n\n`snowflake`生成一个64位的数值，前41bit是一个时间戳，精确到毫秒，中间10个bit用于表示机器组，一个集群最多可以表示1024台机器，后12bit表示随机数。2^12=4096，即：每台机器每毫秒最多可以生成4096个ID。\n\n+ 优点，实现简单，不依赖于第三方组件。\n+ 缺点，在并发量大的情况下会出现ID冲突的情况。\n\n\n### 美团点评`Leaf`分布式ID生成系统\n\nLeaf 是美团开源的分布式ID生成器，能保证全局唯一性、趋势递增、单调递增、信息安全，里面也提到了几种分布式方案的对比，但也需要依赖关系数据库、Zookeeper等中间件。\n\n具体可以参考官网说明: [Leaf 分布式ID](https://tech.meituan.com/MT_Leaf.html)\n\n\n","slug":"分布式ID生成","published":1,"updated":"2018-10-26T06:51:37.129Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9ce70042y4zvmjqjc404","content":"<p>在分布式系统的大环境下，传统的自增方式生成唯一ID已经不太适用了，因为等到业务规模大到一定的体量的时候，必须要考虑到分库分表的问题，就不能保证ID的唯一性。所以我们需要一个替代方案来生成唯一ID。</p>\n<p>现有的几种全局ID生成方式：</p>\n<ul>\n<li>通过redis自增数值</li>\n<li>Twitter<code>snowflake</code>算法</li>\n<li>美团点评<code>Leaf</code>分布式ID生成系统</li>\n</ul>\n<h3 id=\"利用redis生成唯一ID\"><a href=\"#利用redis生成唯一ID\" class=\"headerlink\" title=\"利用redis生成唯一ID\"></a>利用redis生成唯一ID</h3><p>redis是一个单进程单线程的架构（不考虑到快照备份、数据同步等）。其有一个<code>incr</code>原子指令，用于对数值加1操作。并返回执行 INCR 命令之后 key 的值。</p>\n<ul>\n<li>优点，自增ID天然有序，对于数据库索引写入性能较好。</li>\n<li>缺点，引入redis相当于引入了一个单点的性能瓶颈，同时增加了系统的复杂度和维护成本。</li>\n</ul>\n<h3 id=\"Twittersnowflake算法\"><a href=\"#Twittersnowflake算法\" class=\"headerlink\" title=\"Twittersnowflake算法\"></a>Twitter<code>snowflake</code>算法</h3><p><img src=\"/img/snowflake\" alt=\"snowflake\"></p>\n<p><code>snowflake</code>生成一个64位的数值，前41bit是一个时间戳，精确到毫秒，中间10个bit用于表示机器组，一个集群最多可以表示1024台机器，后12bit表示随机数。2^12=4096，即：每台机器每毫秒最多可以生成4096个ID。</p>\n<ul>\n<li>优点，实现简单，不依赖于第三方组件。</li>\n<li>缺点，在并发量大的情况下会出现ID冲突的情况。</li>\n</ul>\n<h3 id=\"美团点评Leaf分布式ID生成系统\"><a href=\"#美团点评Leaf分布式ID生成系统\" class=\"headerlink\" title=\"美团点评Leaf分布式ID生成系统\"></a>美团点评<code>Leaf</code>分布式ID生成系统</h3><p>Leaf 是美团开源的分布式ID生成器，能保证全局唯一性、趋势递增、单调递增、信息安全，里面也提到了几种分布式方案的对比，但也需要依赖关系数据库、Zookeeper等中间件。</p>\n<p>具体可以参考官网说明: <a href=\"https://tech.meituan.com/MT_Leaf.html\" target=\"_blank\" rel=\"noopener\">Leaf 分布式ID</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p>在分布式系统的大环境下，传统的自增方式生成唯一ID已经不太适用了，因为等到业务规模大到一定的体量的时候，必须要考虑到分库分表的问题，就不能保证ID的唯一性。所以我们需要一个替代方案来生成唯一ID。</p>\n<p>现有的几种全局ID生成方式：</p>\n<ul>\n<li>通过redis自增数值</li>\n<li>Twitter<code>snowflake</code>算法</li>\n<li>美团点评<code>Leaf</code>分布式ID生成系统</li>\n</ul>\n<h3 id=\"利用redis生成唯一ID\"><a href=\"#利用redis生成唯一ID\" class=\"headerlink\" title=\"利用redis生成唯一ID\"></a>利用redis生成唯一ID</h3><p>redis是一个单进程单线程的架构（不考虑到快照备份、数据同步等）。其有一个<code>incr</code>原子指令，用于对数值加1操作。并返回执行 INCR 命令之后 key 的值。</p>\n<ul>\n<li>优点，自增ID天然有序，对于数据库索引写入性能较好。</li>\n<li>缺点，引入redis相当于引入了一个单点的性能瓶颈，同时增加了系统的复杂度和维护成本。</li>\n</ul>\n<h3 id=\"Twittersnowflake算法\"><a href=\"#Twittersnowflake算法\" class=\"headerlink\" title=\"Twittersnowflake算法\"></a>Twitter<code>snowflake</code>算法</h3><p><img src=\"/img/snowflake\" alt=\"snowflake\"></p>\n<p><code>snowflake</code>生成一个64位的数值，前41bit是一个时间戳，精确到毫秒，中间10个bit用于表示机器组，一个集群最多可以表示1024台机器，后12bit表示随机数。2^12=4096，即：每台机器每毫秒最多可以生成4096个ID。</p>\n<ul>\n<li>优点，实现简单，不依赖于第三方组件。</li>\n<li>缺点，在并发量大的情况下会出现ID冲突的情况。</li>\n</ul>\n<h3 id=\"美团点评Leaf分布式ID生成系统\"><a href=\"#美团点评Leaf分布式ID生成系统\" class=\"headerlink\" title=\"美团点评Leaf分布式ID生成系统\"></a>美团点评<code>Leaf</code>分布式ID生成系统</h3><p>Leaf 是美团开源的分布式ID生成器，能保证全局唯一性、趋势递增、单调递增、信息安全，里面也提到了几种分布式方案的对比，但也需要依赖关系数据库、Zookeeper等中间件。</p>\n<p>具体可以参考官网说明: <a href=\"https://tech.meituan.com/MT_Leaf.html\" target=\"_blank\" rel=\"noopener\">Leaf 分布式ID</a></p>\n"},{"title":"Kong网关集成到Prometheus监控","keywords":["prometheus","kong","gateway"],"date":"2017-08-01T06:10:30.000Z","_content":"\nPrometheus作为目前云生态环境下炙手可热的监控报警平台，目前已经得到社区开发者和厂商的广大认可。其灵活的组件设计为编写第三方扩展提供了很大方便。针对不同的应用场景，prometheus包含了大量了`exporter`。如: 各种数据库exporter，硬件信息的exporter，消息系统如`kafka`的exporter等。\n\n在公司项目引入`kong`之后，发现没有一个合适的`exporter`可以用，所以动手实现了一个。\n\n\n首先在Kong后台配置一个[HttpLogPlugin](https://getkong.org/plugins/http-log/?_ga=2.105865475.1226178032.1511256708-1617277625.1509955587)插件。\n\n![kong插件列表](/img/kong-plugin.jpg)\n\nPrometheus要求exporter提供一个`/metrics`的`endPoint`供给Prometheus Main Server调用，定时拉取当前网关的各项指标。而kong网关一端利用一个`HttpLogPlugin`插件定时把数据抛到`exporter`:\n\n```go\nfunc main() {\n\thttp.Handle(\"/metrics\", promhttp.Handler())\n\thttp.Handle(\"/kong\", http.HandlerFunc(handleKong))\n\tlog.Fatal(http.ListenAndServe(\":8080\", nil))\n}\n```\n\n初始化的时候注入各项`metrics label`:\n\n```go\n\nimport (\n\t\"encoding/json\"\n\t\"fmt\"\n\t\"github.com/prometheus/client_golang/prometheus\"\n\t\"github.com/prometheus/client_golang/prometheus/promhttp\"\n\t\"log\"\n\t\"net/http\"\n)\n\nvar (\n\ttotalRequest = prometheus.NewCounterVec(\n\t\tprometheus.CounterOpts{\n\t\t\tName: \"http_total_request_size\",\n\t\t\tHelp: \"total http request size\",\n\t\t}, []string{\"status\", \"module\"})\n\n\tresponseTimeInMs = prometheus.NewSummaryVec(\n\t\tprometheus.SummaryOpts{\n\t\t\tName: \"http_response_time_milliseconds\",\n\t\t\tHelp: \"Request completed time in milliseconds\",\n\t\t}, []string{\"method\", \"module\", \"status\", \"method_type\"})\n)\n\nfunc init() {\n\tprometheus.MustRegister(totalRequest)\n\tprometheus.MustRegister(responseTimeInMs)\n}\n\n```\n\nkong抛过来的log主要包含请求的客户端ip、请求基本数据、请求延迟、\b请求的消费方、以及响应数据等：\n\n```go\ntype KongLog struct {\n\tRequest   Request   `json:\"request\"`\n\tResponse  Response  `json:\"response\"`\n\tApi       API       `json:\"api\"`\n\tConsumer  Consumer  `json:\"consumer\"`\n\tLatencies Latencies `json:\"latencies\"`\n\tClientIp  string    `json:\"client_ip\"`\n}\n```\n\n接收到kong抛过来的数据之后，写入`prometheus`\b缓存：\n\n```go\nfunc handleKong(w http.ResponseWriter, req *http.Request) {\n\tdecoder := json.NewDecoder(req.Body)\n\tvar kongLog KongLog\n\terr := decoder.Decode(&kongLog)\n\tif err != nil {\n\t\tlog.Println(err)\n\t\tlog.Printf(\"handleKong Decode error\\n\")\n\t\treturn\n\t}\n\tdefer req.Body.Close()\n\n\tlog.Printf(\"%#v\\n\", kongLog.Request)\n\tlog.Printf(\"%#v\\n\", kongLog.Response)\n\tlog.Printf(\"%#v\\n\", kongLog.Api)\n\tlog.Printf(\"%#v\\n\", kongLog.Consumer)\n\tlog.Printf(\"%#v\\n\", kongLog.Latencies)\n\tlog.Printf(\"%#v\\n\", kongLog.ClientIp)\n\n\tmethod := kongLog.Request.Uri\n\tmodule := kongLog.Api.Name\n\tstatus := fmt.Sprint(kongLog.Response.Status)\n\tmethodType := kongLog.Request.Method\n\tresponseTimeInMs.With(prometheus.Labels{\"method\": method, \"module\": module, \"status\": status, \"method_type\": methodType}).Observe(float64(kongLog.Latencies.Request))\n\ttotalRequest.With(prometheus.Labels{\"status\": status, \"module\": module})\n\n\treturn\n}\n```\n\n项目代码地址：[kong-prometheus-exporter](https://github.com/Luncher/kong-prometheus-exporter)","source":"_posts/利用prometheus监控Kong网关.md","raw":"---\ntitle: Kong网关集成到Prometheus监控\ncategories: 系统监控\nkeywords: \n  - prometheus\n  - kong\n  - gateway\ndate: 2017-08-01 14:10:30\n---\n\nPrometheus作为目前云生态环境下炙手可热的监控报警平台，目前已经得到社区开发者和厂商的广大认可。其灵活的组件设计为编写第三方扩展提供了很大方便。针对不同的应用场景，prometheus包含了大量了`exporter`。如: 各种数据库exporter，硬件信息的exporter，消息系统如`kafka`的exporter等。\n\n在公司项目引入`kong`之后，发现没有一个合适的`exporter`可以用，所以动手实现了一个。\n\n\n首先在Kong后台配置一个[HttpLogPlugin](https://getkong.org/plugins/http-log/?_ga=2.105865475.1226178032.1511256708-1617277625.1509955587)插件。\n\n![kong插件列表](/img/kong-plugin.jpg)\n\nPrometheus要求exporter提供一个`/metrics`的`endPoint`供给Prometheus Main Server调用，定时拉取当前网关的各项指标。而kong网关一端利用一个`HttpLogPlugin`插件定时把数据抛到`exporter`:\n\n```go\nfunc main() {\n\thttp.Handle(\"/metrics\", promhttp.Handler())\n\thttp.Handle(\"/kong\", http.HandlerFunc(handleKong))\n\tlog.Fatal(http.ListenAndServe(\":8080\", nil))\n}\n```\n\n初始化的时候注入各项`metrics label`:\n\n```go\n\nimport (\n\t\"encoding/json\"\n\t\"fmt\"\n\t\"github.com/prometheus/client_golang/prometheus\"\n\t\"github.com/prometheus/client_golang/prometheus/promhttp\"\n\t\"log\"\n\t\"net/http\"\n)\n\nvar (\n\ttotalRequest = prometheus.NewCounterVec(\n\t\tprometheus.CounterOpts{\n\t\t\tName: \"http_total_request_size\",\n\t\t\tHelp: \"total http request size\",\n\t\t}, []string{\"status\", \"module\"})\n\n\tresponseTimeInMs = prometheus.NewSummaryVec(\n\t\tprometheus.SummaryOpts{\n\t\t\tName: \"http_response_time_milliseconds\",\n\t\t\tHelp: \"Request completed time in milliseconds\",\n\t\t}, []string{\"method\", \"module\", \"status\", \"method_type\"})\n)\n\nfunc init() {\n\tprometheus.MustRegister(totalRequest)\n\tprometheus.MustRegister(responseTimeInMs)\n}\n\n```\n\nkong抛过来的log主要包含请求的客户端ip、请求基本数据、请求延迟、\b请求的消费方、以及响应数据等：\n\n```go\ntype KongLog struct {\n\tRequest   Request   `json:\"request\"`\n\tResponse  Response  `json:\"response\"`\n\tApi       API       `json:\"api\"`\n\tConsumer  Consumer  `json:\"consumer\"`\n\tLatencies Latencies `json:\"latencies\"`\n\tClientIp  string    `json:\"client_ip\"`\n}\n```\n\n接收到kong抛过来的数据之后，写入`prometheus`\b缓存：\n\n```go\nfunc handleKong(w http.ResponseWriter, req *http.Request) {\n\tdecoder := json.NewDecoder(req.Body)\n\tvar kongLog KongLog\n\terr := decoder.Decode(&kongLog)\n\tif err != nil {\n\t\tlog.Println(err)\n\t\tlog.Printf(\"handleKong Decode error\\n\")\n\t\treturn\n\t}\n\tdefer req.Body.Close()\n\n\tlog.Printf(\"%#v\\n\", kongLog.Request)\n\tlog.Printf(\"%#v\\n\", kongLog.Response)\n\tlog.Printf(\"%#v\\n\", kongLog.Api)\n\tlog.Printf(\"%#v\\n\", kongLog.Consumer)\n\tlog.Printf(\"%#v\\n\", kongLog.Latencies)\n\tlog.Printf(\"%#v\\n\", kongLog.ClientIp)\n\n\tmethod := kongLog.Request.Uri\n\tmodule := kongLog.Api.Name\n\tstatus := fmt.Sprint(kongLog.Response.Status)\n\tmethodType := kongLog.Request.Method\n\tresponseTimeInMs.With(prometheus.Labels{\"method\": method, \"module\": module, \"status\": status, \"method_type\": methodType}).Observe(float64(kongLog.Latencies.Request))\n\ttotalRequest.With(prometheus.Labels{\"status\": status, \"module\": module})\n\n\treturn\n}\n```\n\n项目代码地址：[kong-prometheus-exporter](https://github.com/Luncher/kong-prometheus-exporter)","slug":"利用prometheus监控Kong网关","published":1,"updated":"2018-07-01T10:30:46.498Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9ce80045y4zvo3161pvo","content":"<p>Prometheus作为目前云生态环境下炙手可热的监控报警平台，目前已经得到社区开发者和厂商的广大认可。其灵活的组件设计为编写第三方扩展提供了很大方便。针对不同的应用场景，prometheus包含了大量了<code>exporter</code>。如: 各种数据库exporter，硬件信息的exporter，消息系统如<code>kafka</code>的exporter等。</p>\n<p>在公司项目引入<code>kong</code>之后，发现没有一个合适的<code>exporter</code>可以用，所以动手实现了一个。</p>\n<p>首先在Kong后台配置一个<a href=\"https://getkong.org/plugins/http-log/?_ga=2.105865475.1226178032.1511256708-1617277625.1509955587\" target=\"_blank\" rel=\"noopener\">HttpLogPlugin</a>插件。</p>\n<p><img src=\"/img/kong-plugin.jpg\" alt=\"kong插件列表\"></p>\n<p>Prometheus要求exporter提供一个<code>/metrics</code>的<code>endPoint</code>供给Prometheus Main Server调用，定时拉取当前网关的各项指标。而kong网关一端利用一个<code>HttpLogPlugin</code>插件定时把数据抛到<code>exporter</code>:</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\thttp.Handle(<span class=\"string\">\"/metrics\"</span>, promhttp.Handler())</span><br><span class=\"line\">\thttp.Handle(<span class=\"string\">\"/kong\"</span>, http.HandlerFunc(handleKong))</span><br><span class=\"line\">\tlog.Fatal(http.ListenAndServe(<span class=\"string\">\":8080\"</span>, <span class=\"literal\">nil</span>))</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>初始化的时候注入各项<code>metrics label</code>:</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">\"encoding/json\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"fmt\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"github.com/prometheus/client_golang/prometheus\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"github.com/prometheus/client_golang/prometheus/promhttp\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"log\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"net/http\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> (</span><br><span class=\"line\">\ttotalRequest = prometheus.NewCounterVec(</span><br><span class=\"line\">\t\tprometheus.CounterOpts&#123;</span><br><span class=\"line\">\t\t\tName: <span class=\"string\">\"http_total_request_size\"</span>,</span><br><span class=\"line\">\t\t\tHelp: <span class=\"string\">\"total http request size\"</span>,</span><br><span class=\"line\">\t\t&#125;, []<span class=\"keyword\">string</span>&#123;<span class=\"string\">\"status\"</span>, <span class=\"string\">\"module\"</span>&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">\tresponseTimeInMs = prometheus.NewSummaryVec(</span><br><span class=\"line\">\t\tprometheus.SummaryOpts&#123;</span><br><span class=\"line\">\t\t\tName: <span class=\"string\">\"http_response_time_milliseconds\"</span>,</span><br><span class=\"line\">\t\t\tHelp: <span class=\"string\">\"Request completed time in milliseconds\"</span>,</span><br><span class=\"line\">\t\t&#125;, []<span class=\"keyword\">string</span>&#123;<span class=\"string\">\"method\"</span>, <span class=\"string\">\"module\"</span>, <span class=\"string\">\"status\"</span>, <span class=\"string\">\"method_type\"</span>&#125;)</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">init</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tprometheus.MustRegister(totalRequest)</span><br><span class=\"line\">\tprometheus.MustRegister(responseTimeInMs)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>kong抛过来的log主要包含请求的客户端ip、请求基本数据、请求延迟、\b请求的消费方、以及响应数据等：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> KongLog <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tRequest   Request   <span class=\"string\">`json:\"request\"`</span></span><br><span class=\"line\">\tResponse  Response  <span class=\"string\">`json:\"response\"`</span></span><br><span class=\"line\">\tApi       API       <span class=\"string\">`json:\"api\"`</span></span><br><span class=\"line\">\tConsumer  Consumer  <span class=\"string\">`json:\"consumer\"`</span></span><br><span class=\"line\">\tLatencies Latencies <span class=\"string\">`json:\"latencies\"`</span></span><br><span class=\"line\">\tClientIp  <span class=\"keyword\">string</span>    <span class=\"string\">`json:\"client_ip\"`</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>接收到kong抛过来的数据之后，写入<code>prometheus</code>\b缓存：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">handleKong</span><span class=\"params\">(w http.ResponseWriter, req *http.Request)</span></span> &#123;</span><br><span class=\"line\">\tdecoder := json.NewDecoder(req.Body)</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> kongLog KongLog</span><br><span class=\"line\">\terr := decoder.Decode(&amp;kongLog)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tlog.Println(err)</span><br><span class=\"line\">\t\tlog.Printf(<span class=\"string\">\"handleKong Decode error\\n\"</span>)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">defer</span> req.Body.Close()</span><br><span class=\"line\"></span><br><span class=\"line\">\tlog.Printf(<span class=\"string\">\"%#v\\n\"</span>, kongLog.Request)</span><br><span class=\"line\">\tlog.Printf(<span class=\"string\">\"%#v\\n\"</span>, kongLog.Response)</span><br><span class=\"line\">\tlog.Printf(<span class=\"string\">\"%#v\\n\"</span>, kongLog.Api)</span><br><span class=\"line\">\tlog.Printf(<span class=\"string\">\"%#v\\n\"</span>, kongLog.Consumer)</span><br><span class=\"line\">\tlog.Printf(<span class=\"string\">\"%#v\\n\"</span>, kongLog.Latencies)</span><br><span class=\"line\">\tlog.Printf(<span class=\"string\">\"%#v\\n\"</span>, kongLog.ClientIp)</span><br><span class=\"line\"></span><br><span class=\"line\">\tmethod := kongLog.Request.Uri</span><br><span class=\"line\">\tmodule := kongLog.Api.Name</span><br><span class=\"line\">\tstatus := fmt.Sprint(kongLog.Response.Status)</span><br><span class=\"line\">\tmethodType := kongLog.Request.Method</span><br><span class=\"line\">\tresponseTimeInMs.With(prometheus.Labels&#123;<span class=\"string\">\"method\"</span>: method, <span class=\"string\">\"module\"</span>: module, <span class=\"string\">\"status\"</span>: status, <span class=\"string\">\"method_type\"</span>: methodType&#125;).Observe(<span class=\"keyword\">float64</span>(kongLog.Latencies.Request))</span><br><span class=\"line\">\ttotalRequest.With(prometheus.Labels&#123;<span class=\"string\">\"status\"</span>: status, <span class=\"string\">\"module\"</span>: module&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>项目代码地址：<a href=\"https://github.com/Luncher/kong-prometheus-exporter\" target=\"_blank\" rel=\"noopener\">kong-prometheus-exporter</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p>Prometheus作为目前云生态环境下炙手可热的监控报警平台，目前已经得到社区开发者和厂商的广大认可。其灵活的组件设计为编写第三方扩展提供了很大方便。针对不同的应用场景，prometheus包含了大量了<code>exporter</code>。如: 各种数据库exporter，硬件信息的exporter，消息系统如<code>kafka</code>的exporter等。</p>\n<p>在公司项目引入<code>kong</code>之后，发现没有一个合适的<code>exporter</code>可以用，所以动手实现了一个。</p>\n<p>首先在Kong后台配置一个<a href=\"https://getkong.org/plugins/http-log/?_ga=2.105865475.1226178032.1511256708-1617277625.1509955587\" target=\"_blank\" rel=\"noopener\">HttpLogPlugin</a>插件。</p>\n<p><img src=\"/img/kong-plugin.jpg\" alt=\"kong插件列表\"></p>\n<p>Prometheus要求exporter提供一个<code>/metrics</code>的<code>endPoint</code>供给Prometheus Main Server调用，定时拉取当前网关的各项指标。而kong网关一端利用一个<code>HttpLogPlugin</code>插件定时把数据抛到<code>exporter</code>:</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\thttp.Handle(<span class=\"string\">\"/metrics\"</span>, promhttp.Handler())</span><br><span class=\"line\">\thttp.Handle(<span class=\"string\">\"/kong\"</span>, http.HandlerFunc(handleKong))</span><br><span class=\"line\">\tlog.Fatal(http.ListenAndServe(<span class=\"string\">\":8080\"</span>, <span class=\"literal\">nil</span>))</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>初始化的时候注入各项<code>metrics label</code>:</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">\"encoding/json\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"fmt\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"github.com/prometheus/client_golang/prometheus\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"github.com/prometheus/client_golang/prometheus/promhttp\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"log\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"net/http\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> (</span><br><span class=\"line\">\ttotalRequest = prometheus.NewCounterVec(</span><br><span class=\"line\">\t\tprometheus.CounterOpts&#123;</span><br><span class=\"line\">\t\t\tName: <span class=\"string\">\"http_total_request_size\"</span>,</span><br><span class=\"line\">\t\t\tHelp: <span class=\"string\">\"total http request size\"</span>,</span><br><span class=\"line\">\t\t&#125;, []<span class=\"keyword\">string</span>&#123;<span class=\"string\">\"status\"</span>, <span class=\"string\">\"module\"</span>&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">\tresponseTimeInMs = prometheus.NewSummaryVec(</span><br><span class=\"line\">\t\tprometheus.SummaryOpts&#123;</span><br><span class=\"line\">\t\t\tName: <span class=\"string\">\"http_response_time_milliseconds\"</span>,</span><br><span class=\"line\">\t\t\tHelp: <span class=\"string\">\"Request completed time in milliseconds\"</span>,</span><br><span class=\"line\">\t\t&#125;, []<span class=\"keyword\">string</span>&#123;<span class=\"string\">\"method\"</span>, <span class=\"string\">\"module\"</span>, <span class=\"string\">\"status\"</span>, <span class=\"string\">\"method_type\"</span>&#125;)</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">init</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tprometheus.MustRegister(totalRequest)</span><br><span class=\"line\">\tprometheus.MustRegister(responseTimeInMs)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>kong抛过来的log主要包含请求的客户端ip、请求基本数据、请求延迟、\b请求的消费方、以及响应数据等：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> KongLog <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tRequest   Request   <span class=\"string\">`json:\"request\"`</span></span><br><span class=\"line\">\tResponse  Response  <span class=\"string\">`json:\"response\"`</span></span><br><span class=\"line\">\tApi       API       <span class=\"string\">`json:\"api\"`</span></span><br><span class=\"line\">\tConsumer  Consumer  <span class=\"string\">`json:\"consumer\"`</span></span><br><span class=\"line\">\tLatencies Latencies <span class=\"string\">`json:\"latencies\"`</span></span><br><span class=\"line\">\tClientIp  <span class=\"keyword\">string</span>    <span class=\"string\">`json:\"client_ip\"`</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>接收到kong抛过来的数据之后，写入<code>prometheus</code>\b缓存：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">handleKong</span><span class=\"params\">(w http.ResponseWriter, req *http.Request)</span></span> &#123;</span><br><span class=\"line\">\tdecoder := json.NewDecoder(req.Body)</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> kongLog KongLog</span><br><span class=\"line\">\terr := decoder.Decode(&amp;kongLog)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\tlog.Println(err)</span><br><span class=\"line\">\t\tlog.Printf(<span class=\"string\">\"handleKong Decode error\\n\"</span>)</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">defer</span> req.Body.Close()</span><br><span class=\"line\"></span><br><span class=\"line\">\tlog.Printf(<span class=\"string\">\"%#v\\n\"</span>, kongLog.Request)</span><br><span class=\"line\">\tlog.Printf(<span class=\"string\">\"%#v\\n\"</span>, kongLog.Response)</span><br><span class=\"line\">\tlog.Printf(<span class=\"string\">\"%#v\\n\"</span>, kongLog.Api)</span><br><span class=\"line\">\tlog.Printf(<span class=\"string\">\"%#v\\n\"</span>, kongLog.Consumer)</span><br><span class=\"line\">\tlog.Printf(<span class=\"string\">\"%#v\\n\"</span>, kongLog.Latencies)</span><br><span class=\"line\">\tlog.Printf(<span class=\"string\">\"%#v\\n\"</span>, kongLog.ClientIp)</span><br><span class=\"line\"></span><br><span class=\"line\">\tmethod := kongLog.Request.Uri</span><br><span class=\"line\">\tmodule := kongLog.Api.Name</span><br><span class=\"line\">\tstatus := fmt.Sprint(kongLog.Response.Status)</span><br><span class=\"line\">\tmethodType := kongLog.Request.Method</span><br><span class=\"line\">\tresponseTimeInMs.With(prometheus.Labels&#123;<span class=\"string\">\"method\"</span>: method, <span class=\"string\">\"module\"</span>: module, <span class=\"string\">\"status\"</span>: status, <span class=\"string\">\"method_type\"</span>: methodType&#125;).Observe(<span class=\"keyword\">float64</span>(kongLog.Latencies.Request))</span><br><span class=\"line\">\ttotalRequest.With(prometheus.Labels&#123;<span class=\"string\">\"status\"</span>: status, <span class=\"string\">\"module\"</span>: module&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>项目代码地址：<a href=\"https://github.com/Luncher/kong-prometheus-exporter\" target=\"_blank\" rel=\"noopener\">kong-prometheus-exporter</a></p>\n"},{"title":"压力测试","date":"2018-08-24T07:50:05.000Z","_content":"\n在项目上线之前，打算对几个热点`HTTP`请求API做压力测试。首先看一下服务器的基本配置：\n\n物理`CPU`个数:\n>cat /proc/cpuinfo| grep \"physical id\"| sort| uniq| wc -l // 1\n\n每个物理 `CPU` 中 core 的个数:\n>cat /proc/cpuinfo| grep \"cpu cores\"| uniq    //cpu cores\t: 1\n\n查看逻辑`CPU`数:\n>cat /proc/cpuinfo| grep \"processor\"| wc -l //2\n\n**逻辑CPU核心数大于物理CPU的核心数，说明开启了超线程。**\n\n内存:\n\n```shell\n[www@iZj6ce0dbddsjxmfjkt2p0Z ~]$ cat /proc/meminfo\nMemTotal:        3881692 kB\nMemFree:          376924 kB\nMemAvailable:    1839064 kB\nBuffers:          192600 kB\nCached:          1424992 kB\nSwapCached:            0 kB\nActive:          2506732 kB\nInactive:         73235\n...\n\n```\n\n---\n\n看完了服务器的基本配置之后，需要选用一个压力测试工具，这里选用[https://github.com/wg/wrk](wrk)这个功能强大的压力测试工具。先来看几个`wrk`涉及的指标参数：\n\n| 项目        | 名称        | 说明               |\n| --------- | --------- | ---------------- |\n| Avg       | 平均值       | 每次测试的平均值         |\n| Stdev     | 标准偏差      | 结果的离散程度，越高说明越不稳定 |\n| Max       | 最大值       | 最大的一次结果          |\n| +/- Stdev | 正负一个标准差占比 | 结果的离散程度，越大越不稳定   |\n\nLatency:  延迟  \nReq/Sec: 每个线程每秒钟的完成的请求数\n\n`wrk`可以配合lua脚本一起使用。以一个常见的post请求为例：\n\n```lua\nrequire('base')\n\nwrk.method = \"POST\"\nwrk.body = '{\"devId\":7,\"taskType\":\"CPU_TASK\"}'\nwrk.headers[\"Content-Type\"] = \"application/json\"\n```\n\n`base`这个包放置通用的配置，如通用的请求头等：\n```lua\nwrk.headers[\"test\"] = \"true\"\n```\n\n设置好之后执行压力测试：\n\n```shell\nwrk -t10 -c10 -d10s -s ./module/getTask.lua --timeout 5s http://127.0.0.1:4001/feathers/v1/taskOperations\nRunning 10s test @ http://127.0.0.1:4001/feathers/v1/taskOperations\n  10 threads and 10 connections\n  Thread Stats   Avg      Stdev     Max   +/- Stdev\n    Latency     2.01s     4.36ms   2.02s    81.63%\n    Req/Sec     0.00      0.00     0.00    100.00%\n  49 requests in 10.09s, 38.57KB read\nRequests/sec:      4.86\nTransfer/sec:      3.82KB\n```\n\n在本次测试中，我们可以看到：\n+ `wrk`开启10个线程的并发请求，开启10个连接，请求时间10秒，每秒钟可以处理4.86次（也就是说在这种压力下，看到的QPS为4.86）  \n+ 平均每次请求处理的`Latency`为2.01s左右","source":"_posts/压力测试.md","raw":"---\ntitle: 压力测试\ndate: 2018-08-24 15:50:05\ntags: benchmark\ncategories: server\n---\n\n在项目上线之前，打算对几个热点`HTTP`请求API做压力测试。首先看一下服务器的基本配置：\n\n物理`CPU`个数:\n>cat /proc/cpuinfo| grep \"physical id\"| sort| uniq| wc -l // 1\n\n每个物理 `CPU` 中 core 的个数:\n>cat /proc/cpuinfo| grep \"cpu cores\"| uniq    //cpu cores\t: 1\n\n查看逻辑`CPU`数:\n>cat /proc/cpuinfo| grep \"processor\"| wc -l //2\n\n**逻辑CPU核心数大于物理CPU的核心数，说明开启了超线程。**\n\n内存:\n\n```shell\n[www@iZj6ce0dbddsjxmfjkt2p0Z ~]$ cat /proc/meminfo\nMemTotal:        3881692 kB\nMemFree:          376924 kB\nMemAvailable:    1839064 kB\nBuffers:          192600 kB\nCached:          1424992 kB\nSwapCached:            0 kB\nActive:          2506732 kB\nInactive:         73235\n...\n\n```\n\n---\n\n看完了服务器的基本配置之后，需要选用一个压力测试工具，这里选用[https://github.com/wg/wrk](wrk)这个功能强大的压力测试工具。先来看几个`wrk`涉及的指标参数：\n\n| 项目        | 名称        | 说明               |\n| --------- | --------- | ---------------- |\n| Avg       | 平均值       | 每次测试的平均值         |\n| Stdev     | 标准偏差      | 结果的离散程度，越高说明越不稳定 |\n| Max       | 最大值       | 最大的一次结果          |\n| +/- Stdev | 正负一个标准差占比 | 结果的离散程度，越大越不稳定   |\n\nLatency:  延迟  \nReq/Sec: 每个线程每秒钟的完成的请求数\n\n`wrk`可以配合lua脚本一起使用。以一个常见的post请求为例：\n\n```lua\nrequire('base')\n\nwrk.method = \"POST\"\nwrk.body = '{\"devId\":7,\"taskType\":\"CPU_TASK\"}'\nwrk.headers[\"Content-Type\"] = \"application/json\"\n```\n\n`base`这个包放置通用的配置，如通用的请求头等：\n```lua\nwrk.headers[\"test\"] = \"true\"\n```\n\n设置好之后执行压力测试：\n\n```shell\nwrk -t10 -c10 -d10s -s ./module/getTask.lua --timeout 5s http://127.0.0.1:4001/feathers/v1/taskOperations\nRunning 10s test @ http://127.0.0.1:4001/feathers/v1/taskOperations\n  10 threads and 10 connections\n  Thread Stats   Avg      Stdev     Max   +/- Stdev\n    Latency     2.01s     4.36ms   2.02s    81.63%\n    Req/Sec     0.00      0.00     0.00    100.00%\n  49 requests in 10.09s, 38.57KB read\nRequests/sec:      4.86\nTransfer/sec:      3.82KB\n```\n\n在本次测试中，我们可以看到：\n+ `wrk`开启10个线程的并发请求，开启10个连接，请求时间10秒，每秒钟可以处理4.86次（也就是说在这种压力下，看到的QPS为4.86）  \n+ 平均每次请求处理的`Latency`为2.01s左右","slug":"压力测试","published":1,"updated":"2018-10-24T08:12:25.344Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9ce90048y4zvt8sgg59e","content":"<p>在项目上线之前，打算对几个热点<code>HTTP</code>请求API做压力测试。首先看一下服务器的基本配置：</p>\n<p>物理<code>CPU</code>个数:</p>\n<blockquote>\n<p>cat /proc/cpuinfo| grep “physical id”| sort| uniq| wc -l // 1</p>\n</blockquote>\n<p>每个物理 <code>CPU</code> 中 core 的个数:</p>\n<blockquote>\n<p>cat /proc/cpuinfo| grep “cpu cores”| uniq    //cpu cores    : 1</p>\n</blockquote>\n<p>查看逻辑<code>CPU</code>数:</p>\n<blockquote>\n<p>cat /proc/cpuinfo| grep “processor”| wc -l //2</p>\n</blockquote>\n<p><strong>逻辑CPU核心数大于物理CPU的核心数，说明开启了超线程。</strong></p>\n<p>内存:</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[www@iZj6ce0dbddsjxmfjkt2p0Z ~]$ cat /proc/meminfo</span><br><span class=\"line\">MemTotal:        3881692 kB</span><br><span class=\"line\">MemFree:          376924 kB</span><br><span class=\"line\">MemAvailable:    1839064 kB</span><br><span class=\"line\">Buffers:          192600 kB</span><br><span class=\"line\">Cached:          1424992 kB</span><br><span class=\"line\">SwapCached:            0 kB</span><br><span class=\"line\">Active:          2506732 kB</span><br><span class=\"line\">Inactive:         73235</span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure>\n<hr>\n<p>看完了服务器的基本配置之后，需要选用一个压力测试工具，这里选用<a href=\"wrk\">https://github.com/wg/wrk</a>这个功能强大的压力测试工具。先来看几个<code>wrk</code>涉及的指标参数：</p>\n<table>\n<thead>\n<tr>\n<th>项目</th>\n<th>名称</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Avg</td>\n<td>平均值</td>\n<td>每次测试的平均值</td>\n</tr>\n<tr>\n<td>Stdev</td>\n<td>标准偏差</td>\n<td>结果的离散程度，越高说明越不稳定</td>\n</tr>\n<tr>\n<td>Max</td>\n<td>最大值</td>\n<td>最大的一次结果</td>\n</tr>\n<tr>\n<td>+/- Stdev</td>\n<td>正负一个标准差占比</td>\n<td>结果的离散程度，越大越不稳定</td>\n</tr>\n</tbody>\n</table>\n<p>Latency:  延迟<br>Req/Sec: 每个线程每秒钟的完成的请求数</p>\n<p><code>wrk</code>可以配合lua脚本一起使用。以一个常见的post请求为例：</p>\n<figure class=\"highlight lua\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">require</span>(<span class=\"string\">'base'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">wrk.method = <span class=\"string\">\"POST\"</span></span><br><span class=\"line\">wrk.body = <span class=\"string\">'&#123;\"devId\":7,\"taskType\":\"CPU_TASK\"&#125;'</span></span><br><span class=\"line\">wrk.headers[<span class=\"string\">\"Content-Type\"</span>] = <span class=\"string\">\"application/json\"</span></span><br></pre></td></tr></table></figure>\n<p><code>base</code>这个包放置通用的配置，如通用的请求头等：<br><figure class=\"highlight lua\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wrk.headers[<span class=\"string\">\"test\"</span>] = <span class=\"string\">\"true\"</span></span><br></pre></td></tr></table></figure></p>\n<p>设置好之后执行压力测试：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wrk -t10 -c10 -d10s -s ./module/getTask.lua --timeout 5s http://127.0.0.1:4001/feathers/v1/taskOperations</span><br><span class=\"line\">Running 10s test @ http://127.0.0.1:4001/feathers/v1/taskOperations</span><br><span class=\"line\">  10 threads and 10 connections</span><br><span class=\"line\">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class=\"line\">    Latency     2.01s     4.36ms   2.02s    81.63%</span><br><span class=\"line\">    Req/Sec     0.00      0.00     0.00    100.00%</span><br><span class=\"line\">  49 requests in 10.09s, 38.57KB read</span><br><span class=\"line\">Requests/sec:      4.86</span><br><span class=\"line\">Transfer/sec:      3.82KB</span><br></pre></td></tr></table></figure>\n<p>在本次测试中，我们可以看到：</p>\n<ul>\n<li><code>wrk</code>开启10个线程的并发请求，开启10个连接，请求时间10秒，每秒钟可以处理4.86次（也就是说在这种压力下，看到的QPS为4.86）  </li>\n<li>平均每次请求处理的<code>Latency</code>为2.01s左右</li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<p>在项目上线之前，打算对几个热点<code>HTTP</code>请求API做压力测试。首先看一下服务器的基本配置：</p>\n<p>物理<code>CPU</code>个数:</p>\n<blockquote>\n<p>cat /proc/cpuinfo| grep “physical id”| sort| uniq| wc -l // 1</p>\n</blockquote>\n<p>每个物理 <code>CPU</code> 中 core 的个数:</p>\n<blockquote>\n<p>cat /proc/cpuinfo| grep “cpu cores”| uniq    //cpu cores    : 1</p>\n</blockquote>\n<p>查看逻辑<code>CPU</code>数:</p>\n<blockquote>\n<p>cat /proc/cpuinfo| grep “processor”| wc -l //2</p>\n</blockquote>\n<p><strong>逻辑CPU核心数大于物理CPU的核心数，说明开启了超线程。</strong></p>\n<p>内存:</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[www@iZj6ce0dbddsjxmfjkt2p0Z ~]$ cat /proc/meminfo</span><br><span class=\"line\">MemTotal:        3881692 kB</span><br><span class=\"line\">MemFree:          376924 kB</span><br><span class=\"line\">MemAvailable:    1839064 kB</span><br><span class=\"line\">Buffers:          192600 kB</span><br><span class=\"line\">Cached:          1424992 kB</span><br><span class=\"line\">SwapCached:            0 kB</span><br><span class=\"line\">Active:          2506732 kB</span><br><span class=\"line\">Inactive:         73235</span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure>\n<hr>\n<p>看完了服务器的基本配置之后，需要选用一个压力测试工具，这里选用<a href=\"wrk\">https://github.com/wg/wrk</a>这个功能强大的压力测试工具。先来看几个<code>wrk</code>涉及的指标参数：</p>\n<table>\n<thead>\n<tr>\n<th>项目</th>\n<th>名称</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Avg</td>\n<td>平均值</td>\n<td>每次测试的平均值</td>\n</tr>\n<tr>\n<td>Stdev</td>\n<td>标准偏差</td>\n<td>结果的离散程度，越高说明越不稳定</td>\n</tr>\n<tr>\n<td>Max</td>\n<td>最大值</td>\n<td>最大的一次结果</td>\n</tr>\n<tr>\n<td>+/- Stdev</td>\n<td>正负一个标准差占比</td>\n<td>结果的离散程度，越大越不稳定</td>\n</tr>\n</tbody>\n</table>\n<p>Latency:  延迟<br>Req/Sec: 每个线程每秒钟的完成的请求数</p>\n<p><code>wrk</code>可以配合lua脚本一起使用。以一个常见的post请求为例：</p>\n<figure class=\"highlight lua\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">require</span>(<span class=\"string\">'base'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">wrk.method = <span class=\"string\">\"POST\"</span></span><br><span class=\"line\">wrk.body = <span class=\"string\">'&#123;\"devId\":7,\"taskType\":\"CPU_TASK\"&#125;'</span></span><br><span class=\"line\">wrk.headers[<span class=\"string\">\"Content-Type\"</span>] = <span class=\"string\">\"application/json\"</span></span><br></pre></td></tr></table></figure>\n<p><code>base</code>这个包放置通用的配置，如通用的请求头等：<br><figure class=\"highlight lua\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wrk.headers[<span class=\"string\">\"test\"</span>] = <span class=\"string\">\"true\"</span></span><br></pre></td></tr></table></figure></p>\n<p>设置好之后执行压力测试：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wrk -t10 -c10 -d10s -s ./module/getTask.lua --timeout 5s http://127.0.0.1:4001/feathers/v1/taskOperations</span><br><span class=\"line\">Running 10s test @ http://127.0.0.1:4001/feathers/v1/taskOperations</span><br><span class=\"line\">  10 threads and 10 connections</span><br><span class=\"line\">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class=\"line\">    Latency     2.01s     4.36ms   2.02s    81.63%</span><br><span class=\"line\">    Req/Sec     0.00      0.00     0.00    100.00%</span><br><span class=\"line\">  49 requests in 10.09s, 38.57KB read</span><br><span class=\"line\">Requests/sec:      4.86</span><br><span class=\"line\">Transfer/sec:      3.82KB</span><br></pre></td></tr></table></figure>\n<p>在本次测试中，我们可以看到：</p>\n<ul>\n<li><code>wrk</code>开启10个线程的并发请求，开启10个连接，请求时间10秒，每秒钟可以处理4.86次（也就是说在这种压力下，看到的QPS为4.86）  </li>\n<li>平均每次请求处理的<code>Latency</code>为2.01s左右</li>\n</ul>\n"},{"title":"块级元素于行内元素","date":"2016-08-12T10:21:03.000Z","_content":"\n# 块级元素与行内元素区别以及联系\n\n>为了更好的进行`CSS`样式布局，`html`元素可以分为两类：块级元素以及行内元素。按照\n元素内容的显示方式又可以分为替换元素与非替换元素，把这几个概念搞清楚，`CSS`应该算入门了吧！\n\n\n## 块级元素\n\n块级元素汇总(含`HTML5`)：\n>address、 article、aside、blockquote、canvas、\ndd、div、dl、fieldset、figcaption、figure、footer、\nform、h[1-6]、header、hgroup、hr、li、main、nav、\nnoscript、ol、output、p、pre、section、table、tfoot、\nul、video\n\n\n块级元素基本特性：\n\n- 1、如果没有设置宽度将会填充父级控件\n- 2、可以设置内边距、外边距属性\n- 3、在没有浮动定位的情况下，块级元素的高度将会根据子控件的高度做相应的扩展\n- 4、在没有浮动定位的情况下，块级元素将会放置在前一个元素的下边一行,后一个元素也会在新行开始\n- 5、忽略`vertical-align`属性\n- 6、遵从`text-align`属性\n\n所以说，如果希望块级元素水平填充父及控件，没有必要给它设置一个宽度为`100%`。因为这样可能会导致一些\n意想不到的问题。\n\n---\n\n## 行内元素\n\n行内元素汇总(含HTML5)：\n>b, big, i, small, tt\nabbr, acronym, cite, code, dfn, em, kbd, strong, samp, time, var\na, bdo, br, img, map, object, q, script, span, sub, sup\nbutton, input, label, select, textarea\n\n行类元素基本特性：\n\n- 1、跟随文本内容来布局\n- 2、不会类似于块元素换行\n- 3、布局的时候考虑字符间隔宽度设定\n- 4、忽略上下外边距、但可以设置左右外边距以及内边距\n- 5、忽略宽度、高度设置\n- 6、如果被浮动了将会自动变成一个块级元素，遵从块级元素特性\n- 7、遵从`vertical-align`属性设置\n- 8、忽略`text-align`属性\n\n---\n\n## 替换元素\n\n常见替换元素：\n>img,object,input,select,textarea,button\n\n替换元素基本性质：\n\n- 1、可以有自己的固有尺寸(通过元素本身设置)\n- 2、有视觉格式化需求、类似于块级元素\n- 3、可以为`行内替换元素`设置宽、高\n\n替换元素的具体显示以及尺寸通过外部资源来设定。除了替换元素，其他元素都称为非替换元素。\n","source":"_posts/块级元素于行内元素.md","raw":"---\ntitle: 块级元素于行内元素\ndate: 2016-08-12 18:21:03\ntags: \n  - css\ncategories: web\n---\n\n# 块级元素与行内元素区别以及联系\n\n>为了更好的进行`CSS`样式布局，`html`元素可以分为两类：块级元素以及行内元素。按照\n元素内容的显示方式又可以分为替换元素与非替换元素，把这几个概念搞清楚，`CSS`应该算入门了吧！\n\n\n## 块级元素\n\n块级元素汇总(含`HTML5`)：\n>address、 article、aside、blockquote、canvas、\ndd、div、dl、fieldset、figcaption、figure、footer、\nform、h[1-6]、header、hgroup、hr、li、main、nav、\nnoscript、ol、output、p、pre、section、table、tfoot、\nul、video\n\n\n块级元素基本特性：\n\n- 1、如果没有设置宽度将会填充父级控件\n- 2、可以设置内边距、外边距属性\n- 3、在没有浮动定位的情况下，块级元素的高度将会根据子控件的高度做相应的扩展\n- 4、在没有浮动定位的情况下，块级元素将会放置在前一个元素的下边一行,后一个元素也会在新行开始\n- 5、忽略`vertical-align`属性\n- 6、遵从`text-align`属性\n\n所以说，如果希望块级元素水平填充父及控件，没有必要给它设置一个宽度为`100%`。因为这样可能会导致一些\n意想不到的问题。\n\n---\n\n## 行内元素\n\n行内元素汇总(含HTML5)：\n>b, big, i, small, tt\nabbr, acronym, cite, code, dfn, em, kbd, strong, samp, time, var\na, bdo, br, img, map, object, q, script, span, sub, sup\nbutton, input, label, select, textarea\n\n行类元素基本特性：\n\n- 1、跟随文本内容来布局\n- 2、不会类似于块元素换行\n- 3、布局的时候考虑字符间隔宽度设定\n- 4、忽略上下外边距、但可以设置左右外边距以及内边距\n- 5、忽略宽度、高度设置\n- 6、如果被浮动了将会自动变成一个块级元素，遵从块级元素特性\n- 7、遵从`vertical-align`属性设置\n- 8、忽略`text-align`属性\n\n---\n\n## 替换元素\n\n常见替换元素：\n>img,object,input,select,textarea,button\n\n替换元素基本性质：\n\n- 1、可以有自己的固有尺寸(通过元素本身设置)\n- 2、有视觉格式化需求、类似于块级元素\n- 3、可以为`行内替换元素`设置宽、高\n\n替换元素的具体显示以及尺寸通过外部资源来设定。除了替换元素，其他元素都称为非替换元素。\n","slug":"块级元素于行内元素","published":1,"updated":"2018-07-01T10:30:46.498Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cea004ay4zvzlyjw6wb","content":"<h1 id=\"块级元素与行内元素区别以及联系\"><a href=\"#块级元素与行内元素区别以及联系\" class=\"headerlink\" title=\"块级元素与行内元素区别以及联系\"></a>块级元素与行内元素区别以及联系</h1><blockquote>\n<p>为了更好的进行<code>CSS</code>样式布局，<code>html</code>元素可以分为两类：块级元素以及行内元素。按照<br>元素内容的显示方式又可以分为替换元素与非替换元素，把这几个概念搞清楚，<code>CSS</code>应该算入门了吧！</p>\n</blockquote>\n<h2 id=\"块级元素\"><a href=\"#块级元素\" class=\"headerlink\" title=\"块级元素\"></a>块级元素</h2><p>块级元素汇总(含<code>HTML5</code>)：</p>\n<blockquote>\n<p>address、 article、aside、blockquote、canvas、<br>dd、div、dl、fieldset、figcaption、figure、footer、<br>form、h[1-6]、header、hgroup、hr、li、main、nav、<br>noscript、ol、output、p、pre、section、table、tfoot、<br>ul、video</p>\n</blockquote>\n<p>块级元素基本特性：</p>\n<ul>\n<li>1、如果没有设置宽度将会填充父级控件</li>\n<li>2、可以设置内边距、外边距属性</li>\n<li>3、在没有浮动定位的情况下，块级元素的高度将会根据子控件的高度做相应的扩展</li>\n<li>4、在没有浮动定位的情况下，块级元素将会放置在前一个元素的下边一行,后一个元素也会在新行开始</li>\n<li>5、忽略<code>vertical-align</code>属性</li>\n<li>6、遵从<code>text-align</code>属性</li>\n</ul>\n<p>所以说，如果希望块级元素水平填充父及控件，没有必要给它设置一个宽度为<code>100%</code>。因为这样可能会导致一些<br>意想不到的问题。</p>\n<hr>\n<h2 id=\"行内元素\"><a href=\"#行内元素\" class=\"headerlink\" title=\"行内元素\"></a>行内元素</h2><p>行内元素汇总(含HTML5)：</p>\n<blockquote>\n<p>b, big, i, small, tt<br>abbr, acronym, cite, code, dfn, em, kbd, strong, samp, time, var<br>a, bdo, br, img, map, object, q, script, span, sub, sup<br>button, input, label, select, textarea</p>\n</blockquote>\n<p>行类元素基本特性：</p>\n<ul>\n<li>1、跟随文本内容来布局</li>\n<li>2、不会类似于块元素换行</li>\n<li>3、布局的时候考虑字符间隔宽度设定</li>\n<li>4、忽略上下外边距、但可以设置左右外边距以及内边距</li>\n<li>5、忽略宽度、高度设置</li>\n<li>6、如果被浮动了将会自动变成一个块级元素，遵从块级元素特性</li>\n<li>7、遵从<code>vertical-align</code>属性设置</li>\n<li>8、忽略<code>text-align</code>属性</li>\n</ul>\n<hr>\n<h2 id=\"替换元素\"><a href=\"#替换元素\" class=\"headerlink\" title=\"替换元素\"></a>替换元素</h2><p>常见替换元素：</p>\n<blockquote>\n<p>img,object,input,select,textarea,button</p>\n</blockquote>\n<p>替换元素基本性质：</p>\n<ul>\n<li>1、可以有自己的固有尺寸(通过元素本身设置)</li>\n<li>2、有视觉格式化需求、类似于块级元素</li>\n<li>3、可以为<code>行内替换元素</code>设置宽、高</li>\n</ul>\n<p>替换元素的具体显示以及尺寸通过外部资源来设定。除了替换元素，其他元素都称为非替换元素。</p>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"块级元素与行内元素区别以及联系\"><a href=\"#块级元素与行内元素区别以及联系\" class=\"headerlink\" title=\"块级元素与行内元素区别以及联系\"></a>块级元素与行内元素区别以及联系</h1><blockquote>\n<p>为了更好的进行<code>CSS</code>样式布局，<code>html</code>元素可以分为两类：块级元素以及行内元素。按照<br>元素内容的显示方式又可以分为替换元素与非替换元素，把这几个概念搞清楚，<code>CSS</code>应该算入门了吧！</p>\n</blockquote>\n<h2 id=\"块级元素\"><a href=\"#块级元素\" class=\"headerlink\" title=\"块级元素\"></a>块级元素</h2><p>块级元素汇总(含<code>HTML5</code>)：</p>\n<blockquote>\n<p>address、 article、aside、blockquote、canvas、<br>dd、div、dl、fieldset、figcaption、figure、footer、<br>form、h[1-6]、header、hgroup、hr、li、main、nav、<br>noscript、ol、output、p、pre、section、table、tfoot、<br>ul、video</p>\n</blockquote>\n<p>块级元素基本特性：</p>\n<ul>\n<li>1、如果没有设置宽度将会填充父级控件</li>\n<li>2、可以设置内边距、外边距属性</li>\n<li>3、在没有浮动定位的情况下，块级元素的高度将会根据子控件的高度做相应的扩展</li>\n<li>4、在没有浮动定位的情况下，块级元素将会放置在前一个元素的下边一行,后一个元素也会在新行开始</li>\n<li>5、忽略<code>vertical-align</code>属性</li>\n<li>6、遵从<code>text-align</code>属性</li>\n</ul>\n<p>所以说，如果希望块级元素水平填充父及控件，没有必要给它设置一个宽度为<code>100%</code>。因为这样可能会导致一些<br>意想不到的问题。</p>\n<hr>\n<h2 id=\"行内元素\"><a href=\"#行内元素\" class=\"headerlink\" title=\"行内元素\"></a>行内元素</h2><p>行内元素汇总(含HTML5)：</p>\n<blockquote>\n<p>b, big, i, small, tt<br>abbr, acronym, cite, code, dfn, em, kbd, strong, samp, time, var<br>a, bdo, br, img, map, object, q, script, span, sub, sup<br>button, input, label, select, textarea</p>\n</blockquote>\n<p>行类元素基本特性：</p>\n<ul>\n<li>1、跟随文本内容来布局</li>\n<li>2、不会类似于块元素换行</li>\n<li>3、布局的时候考虑字符间隔宽度设定</li>\n<li>4、忽略上下外边距、但可以设置左右外边距以及内边距</li>\n<li>5、忽略宽度、高度设置</li>\n<li>6、如果被浮动了将会自动变成一个块级元素，遵从块级元素特性</li>\n<li>7、遵从<code>vertical-align</code>属性设置</li>\n<li>8、忽略<code>text-align</code>属性</li>\n</ul>\n<hr>\n<h2 id=\"替换元素\"><a href=\"#替换元素\" class=\"headerlink\" title=\"替换元素\"></a>替换元素</h2><p>常见替换元素：</p>\n<blockquote>\n<p>img,object,input,select,textarea,button</p>\n</blockquote>\n<p>替换元素基本性质：</p>\n<ul>\n<li>1、可以有自己的固有尺寸(通过元素本身设置)</li>\n<li>2、有视觉格式化需求、类似于块级元素</li>\n<li>3、可以为<code>行内替换元素</code>设置宽、高</li>\n</ul>\n<p>替换元素的具体显示以及尺寸通过外部资源来设定。除了替换元素，其他元素都称为非替换元素。</p>\n"},{"title":"基于Vuejs和Sailsjs的SSR实践","date":"2017-11-12T10:21:03.000Z","_content":"\n\nSails作为老牌Node.js框架,师从ROR,在Node.js社区也有一定的影响力。我们团队在微服务化之后选中其作为web开发基础框架。最近在做代码下发服务的时候需要一个后台管理页面，所以去了解了一下怎么利用sailsjs做服务器端渲染。\n\n\n服务器端渲染依赖于`webpack`编译出的`server-bundle`文件。为了保证renderer的单例，所以在sailsjs启动的时候创建：\n\n```javascript\n\nmodule.exports.bootstrap = function (cb) {\n  if (isTest) {\n    return cb()\n  }\n  const bundle = require('../assets/vue-ssr-server-bundle.json')\n  const clientManifest = require('../assets/vue-ssr-client-manifest.json')\n  const renderer = createRenderer(bundle, {\n    clientManifest\n  })\n\n  if (sails.config.setupDevServer) {\n    console.log('setup-dev-server')\n    require('../build/setup-dev-server')\n  }\n\n  global.renderer = renderer\n  global.serialize = serialize\n  global.createRenderer = createRenderer\n\n  cb()\n}\n\n```\n\n为了方便本地开发实现`hot reload`功能，所以判断是本地开发环境的时候启动一个服务器，检测bundle文件变化并自动编译更新renderer：\n\n```javascript\n\n//...\n\nlet bundle = fs.readFileSync(serverBundlePath, 'utf8')\nlet clientManifest = fs.readFileSync(clientManifestPath, 'utf8')\n\nfunction update () {\n  if (bundle && clientManifest) {\n    console.log('renderer updated.')\n    global.renderer = createRenderer(JSON.parse(bundle), { clientManifest: JSON.parse(clientManifest) })\n  }\n}\n\nchokidar.watch(clientManifestPath).on('change', () => {\n  clientManifest = fs.readFileSync(clientManifestPath, 'utf8')\n  console.log('clientManifest updated.')\n  update()\n})\n\nchokidar.watch(serverBundlePath).on('change', () => {\n  bundle = fs.readFileSync(serverBundlePath, 'utf8')\n  console.log('serverBundle updated.')\n  update()\n})\n\n```\n\n注意的是，这里只是监测bundle文件的变更，至于其他文件例如`.vue`文件或者前端`js`文件的更新没有能够监测，这可以利用`webpack`的watch功能来实现:\n\n```javascript\n\n  \"scripts\": {\n    //...\n    \"dev\": \"rimraf assets && npm run dev:server && npm run dev:client\",\n    \"dev:client\": \"cross-env NODE_ENV=development webpack --config ./build/webpack.client.config.js --progress --hide-modules --watch &\",\n    \"dev:server\": \"cross-env NODE_ENV=development webpack --config ./build/webpack.server.config.js --progress --hide-modules --watch &\"\n  },\n\n```\n\n在基本配置写完之后，需要写一个视图渲染中间件，因为sailsjs本身是基于express来封装的，所以可以在中间件列表的末尾注入一个`serverRenderer`中间件，作用类似于[connect-history-api-fallback](https://github.com/bripkens/connect-history-api-fallback)：\n\n>config/http.js\n\n```javascript\n\norder: [\n  //...\n  'serverRenderer',\n  '500'\n],\n\n```\n\n>serverRenderer实现：\n\n```javascript\n\nfunction serverRenderer (req, res, next) {\n  if (!global.renderer) {\n    return res.end('waiting for compilation... refresh wait in a moment')\n  }\n\n  res.header('Content-Type', 'text/html')\n\n  const s = Date.now()\n  const context = {\n    url: req.url,\n    cookies: req.headers.cookie\n  }\n  sails.log.info('render context:', context)\n\n  const renderStream = global.renderer.renderToStream(context)\n\n  renderStream.on('data', chunk => {\n    res.write(chunk)\n  })\n\n  renderStream.on('end', () => {\n    sails.log.info(`whole request: ${Date.now() - s}ms`)\n    res.end()\n  })\n\n  renderStream.on('error', err => {\n    if (err && err.code === 404) {\n      return res.status(404).end('404 | Page Not Found')\n    }\n    res.status(500).end('Internal Error 500')\n    sails.log.error(`error during render : ${req.url}`)\n    sails.log.error(err)\n  })\n\n  return\n}\n\n```\n\n在请求进来的时候判断渲染器是否准备好。如果准备好了，则调用渲染器传入请求的url，匹配相应的控件做数据的预加载。在这里我们还把请求的cookies传递过去，这是因为服务器的一些api请求需要鉴权，这样在数据预加载的时候才能成功取到数据：\n\n>axios 请求传入cookies\n\n```javascript\n//...\nconst request = axios.create({\n  baseURL,\n  timeout\n})\n\nconst createAPI = (method, url, config = {}) => {\n  return request({\n    url,\n    method,\n    ...config\n  })\n}\n\nrequest.interceptors.request.use(config => {\n  if (!isClient) {\n    config.headers.Cookie = serverCookies\n  }\n  return config\n}, error => Promise.reject(error))\n\n```\n\n>api/polices/isLogined.js\n\n```javascript\n\nfunction isLogined (req, res, next) {\n  if (!req.session.uid && req.url !== '/signin') {\n    if (req.wantsJSON) {\n      res.serverError(sails.Error(ERROR_CODES.ERR_NEED_LOGIN))\n    } else {\n      res.redirect(sails.config.app.redirectUrls.signin)\n    }\n  } else {\n    next()\n  }\n}\n\n```\n\n对于服务器和客户端的数据预加载的基本写法可以参考`vuejs`的[官方文档](https://ssr.vuejs.org/zh/data.html)。\n\n另外一点需要注意的是，我使用的`iview`框架，而它本身没有针对`ssr`适配所以在渲染的时候，或者数据预加载的时候最好加一个判断: \n\n```javascript\nrequest.interceptors.response.use(res => {\n  const body = res.data\n  const messageDefault = res.config.messageDefault\n  if (body.code !== 0) {\n    if (isClient) {\n      iView.Notice.error({\n        title: 'Error',\n        desc: messageDefault || body.message || '操作失败'\n      })\n    }\n    return Promise.reject(res)\n  }\n\n  return res\n}, ...\n\n```\n\n`isClient`变量依赖于`webpack`编译的时候注入的环境变量`process.env.VUE_ENV`。","source":"_posts/基于Vuejs和Sailsjs的SSR实践.md","raw":"---\ntitle: 基于Vuejs和Sailsjs的SSR实践\ndate: 2017-11-12 18:21:03\ntags: \n  - vuejs\n  - ssr\n  - sailsjs\ncategories: web\n---\n\n\nSails作为老牌Node.js框架,师从ROR,在Node.js社区也有一定的影响力。我们团队在微服务化之后选中其作为web开发基础框架。最近在做代码下发服务的时候需要一个后台管理页面，所以去了解了一下怎么利用sailsjs做服务器端渲染。\n\n\n服务器端渲染依赖于`webpack`编译出的`server-bundle`文件。为了保证renderer的单例，所以在sailsjs启动的时候创建：\n\n```javascript\n\nmodule.exports.bootstrap = function (cb) {\n  if (isTest) {\n    return cb()\n  }\n  const bundle = require('../assets/vue-ssr-server-bundle.json')\n  const clientManifest = require('../assets/vue-ssr-client-manifest.json')\n  const renderer = createRenderer(bundle, {\n    clientManifest\n  })\n\n  if (sails.config.setupDevServer) {\n    console.log('setup-dev-server')\n    require('../build/setup-dev-server')\n  }\n\n  global.renderer = renderer\n  global.serialize = serialize\n  global.createRenderer = createRenderer\n\n  cb()\n}\n\n```\n\n为了方便本地开发实现`hot reload`功能，所以判断是本地开发环境的时候启动一个服务器，检测bundle文件变化并自动编译更新renderer：\n\n```javascript\n\n//...\n\nlet bundle = fs.readFileSync(serverBundlePath, 'utf8')\nlet clientManifest = fs.readFileSync(clientManifestPath, 'utf8')\n\nfunction update () {\n  if (bundle && clientManifest) {\n    console.log('renderer updated.')\n    global.renderer = createRenderer(JSON.parse(bundle), { clientManifest: JSON.parse(clientManifest) })\n  }\n}\n\nchokidar.watch(clientManifestPath).on('change', () => {\n  clientManifest = fs.readFileSync(clientManifestPath, 'utf8')\n  console.log('clientManifest updated.')\n  update()\n})\n\nchokidar.watch(serverBundlePath).on('change', () => {\n  bundle = fs.readFileSync(serverBundlePath, 'utf8')\n  console.log('serverBundle updated.')\n  update()\n})\n\n```\n\n注意的是，这里只是监测bundle文件的变更，至于其他文件例如`.vue`文件或者前端`js`文件的更新没有能够监测，这可以利用`webpack`的watch功能来实现:\n\n```javascript\n\n  \"scripts\": {\n    //...\n    \"dev\": \"rimraf assets && npm run dev:server && npm run dev:client\",\n    \"dev:client\": \"cross-env NODE_ENV=development webpack --config ./build/webpack.client.config.js --progress --hide-modules --watch &\",\n    \"dev:server\": \"cross-env NODE_ENV=development webpack --config ./build/webpack.server.config.js --progress --hide-modules --watch &\"\n  },\n\n```\n\n在基本配置写完之后，需要写一个视图渲染中间件，因为sailsjs本身是基于express来封装的，所以可以在中间件列表的末尾注入一个`serverRenderer`中间件，作用类似于[connect-history-api-fallback](https://github.com/bripkens/connect-history-api-fallback)：\n\n>config/http.js\n\n```javascript\n\norder: [\n  //...\n  'serverRenderer',\n  '500'\n],\n\n```\n\n>serverRenderer实现：\n\n```javascript\n\nfunction serverRenderer (req, res, next) {\n  if (!global.renderer) {\n    return res.end('waiting for compilation... refresh wait in a moment')\n  }\n\n  res.header('Content-Type', 'text/html')\n\n  const s = Date.now()\n  const context = {\n    url: req.url,\n    cookies: req.headers.cookie\n  }\n  sails.log.info('render context:', context)\n\n  const renderStream = global.renderer.renderToStream(context)\n\n  renderStream.on('data', chunk => {\n    res.write(chunk)\n  })\n\n  renderStream.on('end', () => {\n    sails.log.info(`whole request: ${Date.now() - s}ms`)\n    res.end()\n  })\n\n  renderStream.on('error', err => {\n    if (err && err.code === 404) {\n      return res.status(404).end('404 | Page Not Found')\n    }\n    res.status(500).end('Internal Error 500')\n    sails.log.error(`error during render : ${req.url}`)\n    sails.log.error(err)\n  })\n\n  return\n}\n\n```\n\n在请求进来的时候判断渲染器是否准备好。如果准备好了，则调用渲染器传入请求的url，匹配相应的控件做数据的预加载。在这里我们还把请求的cookies传递过去，这是因为服务器的一些api请求需要鉴权，这样在数据预加载的时候才能成功取到数据：\n\n>axios 请求传入cookies\n\n```javascript\n//...\nconst request = axios.create({\n  baseURL,\n  timeout\n})\n\nconst createAPI = (method, url, config = {}) => {\n  return request({\n    url,\n    method,\n    ...config\n  })\n}\n\nrequest.interceptors.request.use(config => {\n  if (!isClient) {\n    config.headers.Cookie = serverCookies\n  }\n  return config\n}, error => Promise.reject(error))\n\n```\n\n>api/polices/isLogined.js\n\n```javascript\n\nfunction isLogined (req, res, next) {\n  if (!req.session.uid && req.url !== '/signin') {\n    if (req.wantsJSON) {\n      res.serverError(sails.Error(ERROR_CODES.ERR_NEED_LOGIN))\n    } else {\n      res.redirect(sails.config.app.redirectUrls.signin)\n    }\n  } else {\n    next()\n  }\n}\n\n```\n\n对于服务器和客户端的数据预加载的基本写法可以参考`vuejs`的[官方文档](https://ssr.vuejs.org/zh/data.html)。\n\n另外一点需要注意的是，我使用的`iview`框架，而它本身没有针对`ssr`适配所以在渲染的时候，或者数据预加载的时候最好加一个判断: \n\n```javascript\nrequest.interceptors.response.use(res => {\n  const body = res.data\n  const messageDefault = res.config.messageDefault\n  if (body.code !== 0) {\n    if (isClient) {\n      iView.Notice.error({\n        title: 'Error',\n        desc: messageDefault || body.message || '操作失败'\n      })\n    }\n    return Promise.reject(res)\n  }\n\n  return res\n}, ...\n\n```\n\n`isClient`变量依赖于`webpack`编译的时候注入的环境变量`process.env.VUE_ENV`。","slug":"基于Vuejs和Sailsjs的SSR实践","published":1,"updated":"2018-07-01T10:30:46.498Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cec004ey4zvivus8wwi","content":"<p>Sails作为老牌Node.js框架,师从ROR,在Node.js社区也有一定的影响力。我们团队在微服务化之后选中其作为web开发基础框架。最近在做代码下发服务的时候需要一个后台管理页面，所以去了解了一下怎么利用sailsjs做服务器端渲染。</p>\n<p>服务器端渲染依赖于<code>webpack</code>编译出的<code>server-bundle</code>文件。为了保证renderer的单例，所以在sailsjs启动的时候创建：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">module</span>.exports.bootstrap = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">cb</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (isTest) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> cb()</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> bundle = <span class=\"built_in\">require</span>(<span class=\"string\">'../assets/vue-ssr-server-bundle.json'</span>)</span><br><span class=\"line\">  <span class=\"keyword\">const</span> clientManifest = <span class=\"built_in\">require</span>(<span class=\"string\">'../assets/vue-ssr-client-manifest.json'</span>)</span><br><span class=\"line\">  <span class=\"keyword\">const</span> renderer = createRenderer(bundle, &#123;</span><br><span class=\"line\">    clientManifest</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (sails.config.setupDevServer) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'setup-dev-server'</span>)</span><br><span class=\"line\">    <span class=\"built_in\">require</span>(<span class=\"string\">'../build/setup-dev-server'</span>)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  global.renderer = renderer</span><br><span class=\"line\">  global.serialize = serialize</span><br><span class=\"line\">  global.createRenderer = createRenderer</span><br><span class=\"line\"></span><br><span class=\"line\">  cb()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>为了方便本地开发实现<code>hot reload</code>功能，所以判断是本地开发环境的时候启动一个服务器，检测bundle文件变化并自动编译更新renderer：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//...</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">let</span> bundle = fs.readFileSync(serverBundlePath, <span class=\"string\">'utf8'</span>)</span><br><span class=\"line\"><span class=\"keyword\">let</span> clientManifest = fs.readFileSync(clientManifestPath, <span class=\"string\">'utf8'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">update</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (bundle &amp;&amp; clientManifest) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'renderer updated.'</span>)</span><br><span class=\"line\">    global.renderer = createRenderer(<span class=\"built_in\">JSON</span>.parse(bundle), &#123; <span class=\"attr\">clientManifest</span>: <span class=\"built_in\">JSON</span>.parse(clientManifest) &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">chokidar.watch(clientManifestPath).on(<span class=\"string\">'change'</span>, () =&gt; &#123;</span><br><span class=\"line\">  clientManifest = fs.readFileSync(clientManifestPath, <span class=\"string\">'utf8'</span>)</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'clientManifest updated.'</span>)</span><br><span class=\"line\">  update()</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">chokidar.watch(serverBundlePath).on(<span class=\"string\">'change'</span>, () =&gt; &#123;</span><br><span class=\"line\">  bundle = fs.readFileSync(serverBundlePath, <span class=\"string\">'utf8'</span>)</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'serverBundle updated.'</span>)</span><br><span class=\"line\">  update()</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n<p>注意的是，这里只是监测bundle文件的变更，至于其他文件例如<code>.vue</code>文件或者前端<code>js</code>文件的更新没有能够监测，这可以利用<code>webpack</code>的watch功能来实现:</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">\"scripts\"</span>: &#123;</span><br><span class=\"line\">  <span class=\"comment\">//...</span></span><br><span class=\"line\">  <span class=\"string\">\"dev\"</span>: <span class=\"string\">\"rimraf assets &amp;&amp; npm run dev:server &amp;&amp; npm run dev:client\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"dev:client\"</span>: <span class=\"string\">\"cross-env NODE_ENV=development webpack --config ./build/webpack.client.config.js --progress --hide-modules --watch &amp;\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"dev:server\"</span>: <span class=\"string\">\"cross-env NODE_ENV=development webpack --config ./build/webpack.server.config.js --progress --hide-modules --watch &amp;\"</span></span><br><span class=\"line\">&#125;,</span><br></pre></td></tr></table></figure>\n<p>在基本配置写完之后，需要写一个视图渲染中间件，因为sailsjs本身是基于express来封装的，所以可以在中间件列表的末尾注入一个<code>serverRenderer</code>中间件，作用类似于<a href=\"https://github.com/bripkens/connect-history-api-fallback\" target=\"_blank\" rel=\"noopener\">connect-history-api-fallback</a>：</p>\n<blockquote>\n<p>config/http.js</p>\n</blockquote>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">order: [</span><br><span class=\"line\">  <span class=\"comment\">//...</span></span><br><span class=\"line\">  <span class=\"string\">'serverRenderer'</span>,</span><br><span class=\"line\">  <span class=\"string\">'500'</span></span><br><span class=\"line\">],</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>serverRenderer实现：</p>\n</blockquote>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">serverRenderer</span> (<span class=\"params\">req, res, next</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!global.renderer) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> res.end(<span class=\"string\">'waiting for compilation... refresh wait in a moment'</span>)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  res.header(<span class=\"string\">'Content-Type'</span>, <span class=\"string\">'text/html'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> s = <span class=\"built_in\">Date</span>.now()</span><br><span class=\"line\">  <span class=\"keyword\">const</span> context = &#123;</span><br><span class=\"line\">    url: req.url,</span><br><span class=\"line\">    cookies: req.headers.cookie</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  sails.log.info(<span class=\"string\">'render context:'</span>, context)</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> renderStream = global.renderer.renderToStream(context)</span><br><span class=\"line\"></span><br><span class=\"line\">  renderStream.on(<span class=\"string\">'data'</span>, chunk =&gt; &#123;</span><br><span class=\"line\">    res.write(chunk)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">  renderStream.on(<span class=\"string\">'end'</span>, () =&gt; &#123;</span><br><span class=\"line\">    sails.log.info(<span class=\"string\">`whole request: <span class=\"subst\">$&#123;<span class=\"built_in\">Date</span>.now() - s&#125;</span>ms`</span>)</span><br><span class=\"line\">    res.end()</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">  renderStream.on(<span class=\"string\">'error'</span>, err =&gt; &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (err &amp;&amp; err.code === <span class=\"number\">404</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> res.status(<span class=\"number\">404</span>).end(<span class=\"string\">'404 | Page Not Found'</span>)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    res.status(<span class=\"number\">500</span>).end(<span class=\"string\">'Internal Error 500'</span>)</span><br><span class=\"line\">    sails.log.error(<span class=\"string\">`error during render : <span class=\"subst\">$&#123;req.url&#125;</span>`</span>)</span><br><span class=\"line\">    sails.log.error(err)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在请求进来的时候判断渲染器是否准备好。如果准备好了，则调用渲染器传入请求的url，匹配相应的控件做数据的预加载。在这里我们还把请求的cookies传递过去，这是因为服务器的一些api请求需要鉴权，这样在数据预加载的时候才能成功取到数据：</p>\n<blockquote>\n<p>axios 请求传入cookies</p>\n</blockquote>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//...</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> request = axios.create(&#123;</span><br><span class=\"line\">  baseURL,</span><br><span class=\"line\">  timeout</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> createAPI = <span class=\"function\">(<span class=\"params\">method, url, config = &#123;&#125;</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> request(&#123;</span><br><span class=\"line\">    url,</span><br><span class=\"line\">    method,</span><br><span class=\"line\">    ...config</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">request.interceptors.request.use(<span class=\"function\"><span class=\"params\">config</span> =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!isClient) &#123;</span><br><span class=\"line\">    config.headers.Cookie = serverCookies</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> config</span><br><span class=\"line\">&#125;, error =&gt; <span class=\"built_in\">Promise</span>.reject(error))</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>api/polices/isLogined.js</p>\n</blockquote>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">isLogined</span> (<span class=\"params\">req, res, next</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!req.session.uid &amp;&amp; req.url !== <span class=\"string\">'/signin'</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (req.wantsJSON) &#123;</span><br><span class=\"line\">      res.serverError(sails.Error(ERROR_CODES.ERR_NEED_LOGIN))</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      res.redirect(sails.config.app.redirectUrls.signin)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    next()</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>对于服务器和客户端的数据预加载的基本写法可以参考<code>vuejs</code>的<a href=\"https://ssr.vuejs.org/zh/data.html\" target=\"_blank\" rel=\"noopener\">官方文档</a>。</p>\n<p>另外一点需要注意的是，我使用的<code>iview</code>框架，而它本身没有针对<code>ssr</code>适配所以在渲染的时候，或者数据预加载的时候最好加一个判断: </p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">request.interceptors.response.use(<span class=\"function\"><span class=\"params\">res</span> =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> body = res.data</span><br><span class=\"line\">  <span class=\"keyword\">const</span> messageDefault = res.config.messageDefault</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (body.code !== <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (isClient) &#123;</span><br><span class=\"line\">      iView.Notice.error(&#123;</span><br><span class=\"line\">        title: <span class=\"string\">'Error'</span>,</span><br><span class=\"line\">        desc: messageDefault || body.message || <span class=\"string\">'操作失败'</span></span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">Promise</span>.reject(res)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> res</span><br><span class=\"line\">&#125;, ...</span><br></pre></td></tr></table></figure>\n<p><code>isClient</code>变量依赖于<code>webpack</code>编译的时候注入的环境变量<code>process.env.VUE_ENV</code>。</p>\n","site":{"data":{}},"excerpt":"","more":"<p>Sails作为老牌Node.js框架,师从ROR,在Node.js社区也有一定的影响力。我们团队在微服务化之后选中其作为web开发基础框架。最近在做代码下发服务的时候需要一个后台管理页面，所以去了解了一下怎么利用sailsjs做服务器端渲染。</p>\n<p>服务器端渲染依赖于<code>webpack</code>编译出的<code>server-bundle</code>文件。为了保证renderer的单例，所以在sailsjs启动的时候创建：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">module</span>.exports.bootstrap = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">cb</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (isTest) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> cb()</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> bundle = <span class=\"built_in\">require</span>(<span class=\"string\">'../assets/vue-ssr-server-bundle.json'</span>)</span><br><span class=\"line\">  <span class=\"keyword\">const</span> clientManifest = <span class=\"built_in\">require</span>(<span class=\"string\">'../assets/vue-ssr-client-manifest.json'</span>)</span><br><span class=\"line\">  <span class=\"keyword\">const</span> renderer = createRenderer(bundle, &#123;</span><br><span class=\"line\">    clientManifest</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (sails.config.setupDevServer) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'setup-dev-server'</span>)</span><br><span class=\"line\">    <span class=\"built_in\">require</span>(<span class=\"string\">'../build/setup-dev-server'</span>)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  global.renderer = renderer</span><br><span class=\"line\">  global.serialize = serialize</span><br><span class=\"line\">  global.createRenderer = createRenderer</span><br><span class=\"line\"></span><br><span class=\"line\">  cb()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>为了方便本地开发实现<code>hot reload</code>功能，所以判断是本地开发环境的时候启动一个服务器，检测bundle文件变化并自动编译更新renderer：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//...</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">let</span> bundle = fs.readFileSync(serverBundlePath, <span class=\"string\">'utf8'</span>)</span><br><span class=\"line\"><span class=\"keyword\">let</span> clientManifest = fs.readFileSync(clientManifestPath, <span class=\"string\">'utf8'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">update</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (bundle &amp;&amp; clientManifest) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'renderer updated.'</span>)</span><br><span class=\"line\">    global.renderer = createRenderer(<span class=\"built_in\">JSON</span>.parse(bundle), &#123; <span class=\"attr\">clientManifest</span>: <span class=\"built_in\">JSON</span>.parse(clientManifest) &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">chokidar.watch(clientManifestPath).on(<span class=\"string\">'change'</span>, () =&gt; &#123;</span><br><span class=\"line\">  clientManifest = fs.readFileSync(clientManifestPath, <span class=\"string\">'utf8'</span>)</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'clientManifest updated.'</span>)</span><br><span class=\"line\">  update()</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">chokidar.watch(serverBundlePath).on(<span class=\"string\">'change'</span>, () =&gt; &#123;</span><br><span class=\"line\">  bundle = fs.readFileSync(serverBundlePath, <span class=\"string\">'utf8'</span>)</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">'serverBundle updated.'</span>)</span><br><span class=\"line\">  update()</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n<p>注意的是，这里只是监测bundle文件的变更，至于其他文件例如<code>.vue</code>文件或者前端<code>js</code>文件的更新没有能够监测，这可以利用<code>webpack</code>的watch功能来实现:</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">\"scripts\"</span>: &#123;</span><br><span class=\"line\">  <span class=\"comment\">//...</span></span><br><span class=\"line\">  <span class=\"string\">\"dev\"</span>: <span class=\"string\">\"rimraf assets &amp;&amp; npm run dev:server &amp;&amp; npm run dev:client\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"dev:client\"</span>: <span class=\"string\">\"cross-env NODE_ENV=development webpack --config ./build/webpack.client.config.js --progress --hide-modules --watch &amp;\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"dev:server\"</span>: <span class=\"string\">\"cross-env NODE_ENV=development webpack --config ./build/webpack.server.config.js --progress --hide-modules --watch &amp;\"</span></span><br><span class=\"line\">&#125;,</span><br></pre></td></tr></table></figure>\n<p>在基本配置写完之后，需要写一个视图渲染中间件，因为sailsjs本身是基于express来封装的，所以可以在中间件列表的末尾注入一个<code>serverRenderer</code>中间件，作用类似于<a href=\"https://github.com/bripkens/connect-history-api-fallback\" target=\"_blank\" rel=\"noopener\">connect-history-api-fallback</a>：</p>\n<blockquote>\n<p>config/http.js</p>\n</blockquote>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">order: [</span><br><span class=\"line\">  <span class=\"comment\">//...</span></span><br><span class=\"line\">  <span class=\"string\">'serverRenderer'</span>,</span><br><span class=\"line\">  <span class=\"string\">'500'</span></span><br><span class=\"line\">],</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>serverRenderer实现：</p>\n</blockquote>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">serverRenderer</span> (<span class=\"params\">req, res, next</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!global.renderer) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> res.end(<span class=\"string\">'waiting for compilation... refresh wait in a moment'</span>)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  res.header(<span class=\"string\">'Content-Type'</span>, <span class=\"string\">'text/html'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> s = <span class=\"built_in\">Date</span>.now()</span><br><span class=\"line\">  <span class=\"keyword\">const</span> context = &#123;</span><br><span class=\"line\">    url: req.url,</span><br><span class=\"line\">    cookies: req.headers.cookie</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  sails.log.info(<span class=\"string\">'render context:'</span>, context)</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> renderStream = global.renderer.renderToStream(context)</span><br><span class=\"line\"></span><br><span class=\"line\">  renderStream.on(<span class=\"string\">'data'</span>, chunk =&gt; &#123;</span><br><span class=\"line\">    res.write(chunk)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">  renderStream.on(<span class=\"string\">'end'</span>, () =&gt; &#123;</span><br><span class=\"line\">    sails.log.info(<span class=\"string\">`whole request: <span class=\"subst\">$&#123;<span class=\"built_in\">Date</span>.now() - s&#125;</span>ms`</span>)</span><br><span class=\"line\">    res.end()</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">  renderStream.on(<span class=\"string\">'error'</span>, err =&gt; &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (err &amp;&amp; err.code === <span class=\"number\">404</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> res.status(<span class=\"number\">404</span>).end(<span class=\"string\">'404 | Page Not Found'</span>)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    res.status(<span class=\"number\">500</span>).end(<span class=\"string\">'Internal Error 500'</span>)</span><br><span class=\"line\">    sails.log.error(<span class=\"string\">`error during render : <span class=\"subst\">$&#123;req.url&#125;</span>`</span>)</span><br><span class=\"line\">    sails.log.error(err)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在请求进来的时候判断渲染器是否准备好。如果准备好了，则调用渲染器传入请求的url，匹配相应的控件做数据的预加载。在这里我们还把请求的cookies传递过去，这是因为服务器的一些api请求需要鉴权，这样在数据预加载的时候才能成功取到数据：</p>\n<blockquote>\n<p>axios 请求传入cookies</p>\n</blockquote>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//...</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> request = axios.create(&#123;</span><br><span class=\"line\">  baseURL,</span><br><span class=\"line\">  timeout</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> createAPI = <span class=\"function\">(<span class=\"params\">method, url, config = &#123;&#125;</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> request(&#123;</span><br><span class=\"line\">    url,</span><br><span class=\"line\">    method,</span><br><span class=\"line\">    ...config</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">request.interceptors.request.use(<span class=\"function\"><span class=\"params\">config</span> =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!isClient) &#123;</span><br><span class=\"line\">    config.headers.Cookie = serverCookies</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> config</span><br><span class=\"line\">&#125;, error =&gt; <span class=\"built_in\">Promise</span>.reject(error))</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>api/polices/isLogined.js</p>\n</blockquote>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">isLogined</span> (<span class=\"params\">req, res, next</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!req.session.uid &amp;&amp; req.url !== <span class=\"string\">'/signin'</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (req.wantsJSON) &#123;</span><br><span class=\"line\">      res.serverError(sails.Error(ERROR_CODES.ERR_NEED_LOGIN))</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      res.redirect(sails.config.app.redirectUrls.signin)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    next()</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>对于服务器和客户端的数据预加载的基本写法可以参考<code>vuejs</code>的<a href=\"https://ssr.vuejs.org/zh/data.html\" target=\"_blank\" rel=\"noopener\">官方文档</a>。</p>\n<p>另外一点需要注意的是，我使用的<code>iview</code>框架，而它本身没有针对<code>ssr</code>适配所以在渲染的时候，或者数据预加载的时候最好加一个判断: </p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">request.interceptors.response.use(<span class=\"function\"><span class=\"params\">res</span> =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> body = res.data</span><br><span class=\"line\">  <span class=\"keyword\">const</span> messageDefault = res.config.messageDefault</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (body.code !== <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (isClient) &#123;</span><br><span class=\"line\">      iView.Notice.error(&#123;</span><br><span class=\"line\">        title: <span class=\"string\">'Error'</span>,</span><br><span class=\"line\">        desc: messageDefault || body.message || <span class=\"string\">'操作失败'</span></span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">Promise</span>.reject(res)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> res</span><br><span class=\"line\">&#125;, ...</span><br></pre></td></tr></table></figure>\n<p><code>isClient</code>变量依赖于<code>webpack</code>编译的时候注入的环境变量<code>process.env.VUE_ENV</code>。</p>\n"},{"title":"如何学习","date":"2018-10-18T07:42:48.000Z","_content":"\n**深度学习的关键点：**\n\n* 高质量的信息源和第一手知识\n* 把知识连成地图，将自己的理解反述出来\n* 不断的反思和思辨，与不同年龄段的人讨论\n* 举一反三，并践行之，把知识转换成技能\n\n---\n\n**学习的三个步骤:**\n\n* 知识采集\n    获取信息的源头、破解表面信息内在的本质、多方的数据验证\n\n* 知识缝合\n    连接记忆，逻辑推理，知识梳理\n    \n* 技能转化\n    举一反三，实践练习，传授教导\n    \n---\n\n### 学习方法论\n\n#### 挑选知识和信息源的原则\n\n* 应该是第一手资料，不是被人理解过、消化过的二手资料\n* 应该有佐证、有数据、有引用的，或者有权威人士或者大公司生产系统背书\n* 应该是加入了一些自己的经验和思考，可以发人深思\n\n\n#### 注重基础和原理\n\n* 基础不行会影响你对事物的理解，甚至会让你不能理解为什么是这样。当你对事物的出现有不理解的东西时，通常来说，是因为你的基础知识没有跟上。\n\n\n* 基础知识和原理性的东西和技术，都是经历长时间的考验的，所以，这些基础技术也有很多人类历史的智慧结晶，会给你很多启示和帮助。\n\n\n#### 使用知识图\n\n* 把一块大知识拆解成知识树，采用联想记忆的方式梳理知识点。\n* 当遇到某个不知道的知识点的时候，就把它挂到这颗知识树上。\n* 学习不是为了要记忆那些知识点，而是为了找到一个知识的地图，在这个地图上能通过关键路径找到你想要的答案。\n\n\n#### 系统地学习\n\n学习某个技术的时候问几个问题：\n+ 1. 这个技术出现的背景、初衷和要达到什么样的目标或者是解决什么样的问题。\n+ 2. 这个技术的优势和劣势分别是什么，或者说，这个技术的trade-off是什么。\n+ 3. 这个技术的适用场景\n+ 4. 技术的组成部分和关键点\n+ 5. 技术的底层原理和关键实现\n+ 6. 已有的实现和它之间的对比\n\n\n#### 举一反三\n\n人与人之间最大的差别就在于举一反三的能力。举一反三的能力包含：\n\n* 联想能力\n    平时需要锻炼同一个事物不同的看法，或者是联想与之有关的别的事物。\n* 抽象能力\n    对问题进行抽象，获得多种表现形式\n* 自省能力\n    当你得到一个解的时候，要站在对立面来找这个解的漏洞。这种自己和自己辩论的能力又叫思辨能力。获得完整全面的问题分析能力。\n\n\n训练方法：\n\n+ 对于一个场景，制造出各种不同的问题或者难题\n+ 对于一个问题，努力寻找尽可能多的解，并比较这些解的优劣\n+ 对于一个解，努力寻找各种不同的测试案例，以图让其健壮\n\n#### 总结和归纳\n\n+ 在学习的开始阶段，可以不急于总结归纳，不急于下判断，做结论，而应该保留部分知识的不确定性，保持对知识的开放状态。\n\n总结和归纳的方法：\n>把你看到和学习到的信息，归整好，排列好，关联好，总之把信息碎片给结构化掉，然后在结构化的信息中，找到规律，找到相通之处，找到共同之处。进行简化、归纳和总结，最终形成一种套路一种模式，一种通用方法。\n\n\n#### 实践出真知\n\n>实践是一件很痛苦的事，但只有痛苦才会让人反思，而反思则是学习和改变自己的动力。\n\n#### 坚持不懈\n\n>一方面你要把你的坚持形成的成果晒出来，让别人来给你点赞，另一方面，你还要把坚持变成一种习惯，就像吃饭喝水一样，你感觉不到太多的付出成本。只有做到这两点，你才能够真正坚持。","source":"_posts/如何学习.md","raw":"---\ntitle: 如何学习\ndate: 2018-10-18 15:42:48\ntags:\ncategories: lerning\n---\n\n**深度学习的关键点：**\n\n* 高质量的信息源和第一手知识\n* 把知识连成地图，将自己的理解反述出来\n* 不断的反思和思辨，与不同年龄段的人讨论\n* 举一反三，并践行之，把知识转换成技能\n\n---\n\n**学习的三个步骤:**\n\n* 知识采集\n    获取信息的源头、破解表面信息内在的本质、多方的数据验证\n\n* 知识缝合\n    连接记忆，逻辑推理，知识梳理\n    \n* 技能转化\n    举一反三，实践练习，传授教导\n    \n---\n\n### 学习方法论\n\n#### 挑选知识和信息源的原则\n\n* 应该是第一手资料，不是被人理解过、消化过的二手资料\n* 应该有佐证、有数据、有引用的，或者有权威人士或者大公司生产系统背书\n* 应该是加入了一些自己的经验和思考，可以发人深思\n\n\n#### 注重基础和原理\n\n* 基础不行会影响你对事物的理解，甚至会让你不能理解为什么是这样。当你对事物的出现有不理解的东西时，通常来说，是因为你的基础知识没有跟上。\n\n\n* 基础知识和原理性的东西和技术，都是经历长时间的考验的，所以，这些基础技术也有很多人类历史的智慧结晶，会给你很多启示和帮助。\n\n\n#### 使用知识图\n\n* 把一块大知识拆解成知识树，采用联想记忆的方式梳理知识点。\n* 当遇到某个不知道的知识点的时候，就把它挂到这颗知识树上。\n* 学习不是为了要记忆那些知识点，而是为了找到一个知识的地图，在这个地图上能通过关键路径找到你想要的答案。\n\n\n#### 系统地学习\n\n学习某个技术的时候问几个问题：\n+ 1. 这个技术出现的背景、初衷和要达到什么样的目标或者是解决什么样的问题。\n+ 2. 这个技术的优势和劣势分别是什么，或者说，这个技术的trade-off是什么。\n+ 3. 这个技术的适用场景\n+ 4. 技术的组成部分和关键点\n+ 5. 技术的底层原理和关键实现\n+ 6. 已有的实现和它之间的对比\n\n\n#### 举一反三\n\n人与人之间最大的差别就在于举一反三的能力。举一反三的能力包含：\n\n* 联想能力\n    平时需要锻炼同一个事物不同的看法，或者是联想与之有关的别的事物。\n* 抽象能力\n    对问题进行抽象，获得多种表现形式\n* 自省能力\n    当你得到一个解的时候，要站在对立面来找这个解的漏洞。这种自己和自己辩论的能力又叫思辨能力。获得完整全面的问题分析能力。\n\n\n训练方法：\n\n+ 对于一个场景，制造出各种不同的问题或者难题\n+ 对于一个问题，努力寻找尽可能多的解，并比较这些解的优劣\n+ 对于一个解，努力寻找各种不同的测试案例，以图让其健壮\n\n#### 总结和归纳\n\n+ 在学习的开始阶段，可以不急于总结归纳，不急于下判断，做结论，而应该保留部分知识的不确定性，保持对知识的开放状态。\n\n总结和归纳的方法：\n>把你看到和学习到的信息，归整好，排列好，关联好，总之把信息碎片给结构化掉，然后在结构化的信息中，找到规律，找到相通之处，找到共同之处。进行简化、归纳和总结，最终形成一种套路一种模式，一种通用方法。\n\n\n#### 实践出真知\n\n>实践是一件很痛苦的事，但只有痛苦才会让人反思，而反思则是学习和改变自己的动力。\n\n#### 坚持不懈\n\n>一方面你要把你的坚持形成的成果晒出来，让别人来给你点赞，另一方面，你还要把坚持变成一种习惯，就像吃饭喝水一样，你感觉不到太多的付出成本。只有做到这两点，你才能够真正坚持。","slug":"如何学习","published":1,"updated":"2018-10-18T07:44:29.849Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9ced004iy4zv628nloz8","content":"<p><strong>深度学习的关键点：</strong></p>\n<ul>\n<li>高质量的信息源和第一手知识</li>\n<li>把知识连成地图，将自己的理解反述出来</li>\n<li>不断的反思和思辨，与不同年龄段的人讨论</li>\n<li>举一反三，并践行之，把知识转换成技能</li>\n</ul>\n<hr>\n<p><strong>学习的三个步骤:</strong></p>\n<ul>\n<li><p>知识采集<br>  获取信息的源头、破解表面信息内在的本质、多方的数据验证</p>\n</li>\n<li><p>知识缝合<br>  连接记忆，逻辑推理，知识梳理</p>\n</li>\n<li><p>技能转化<br>  举一反三，实践练习，传授教导</p>\n</li>\n</ul>\n<hr>\n<h3 id=\"学习方法论\"><a href=\"#学习方法论\" class=\"headerlink\" title=\"学习方法论\"></a>学习方法论</h3><h4 id=\"挑选知识和信息源的原则\"><a href=\"#挑选知识和信息源的原则\" class=\"headerlink\" title=\"挑选知识和信息源的原则\"></a>挑选知识和信息源的原则</h4><ul>\n<li>应该是第一手资料，不是被人理解过、消化过的二手资料</li>\n<li>应该有佐证、有数据、有引用的，或者有权威人士或者大公司生产系统背书</li>\n<li>应该是加入了一些自己的经验和思考，可以发人深思</li>\n</ul>\n<h4 id=\"注重基础和原理\"><a href=\"#注重基础和原理\" class=\"headerlink\" title=\"注重基础和原理\"></a>注重基础和原理</h4><ul>\n<li>基础不行会影响你对事物的理解，甚至会让你不能理解为什么是这样。当你对事物的出现有不理解的东西时，通常来说，是因为你的基础知识没有跟上。</li>\n</ul>\n<ul>\n<li>基础知识和原理性的东西和技术，都是经历长时间的考验的，所以，这些基础技术也有很多人类历史的智慧结晶，会给你很多启示和帮助。</li>\n</ul>\n<h4 id=\"使用知识图\"><a href=\"#使用知识图\" class=\"headerlink\" title=\"使用知识图\"></a>使用知识图</h4><ul>\n<li>把一块大知识拆解成知识树，采用联想记忆的方式梳理知识点。</li>\n<li>当遇到某个不知道的知识点的时候，就把它挂到这颗知识树上。</li>\n<li>学习不是为了要记忆那些知识点，而是为了找到一个知识的地图，在这个地图上能通过关键路径找到你想要的答案。</li>\n</ul>\n<h4 id=\"系统地学习\"><a href=\"#系统地学习\" class=\"headerlink\" title=\"系统地学习\"></a>系统地学习</h4><p>学习某个技术的时候问几个问题：</p>\n<ul>\n<li><ol>\n<li>这个技术出现的背景、初衷和要达到什么样的目标或者是解决什么样的问题。</li>\n</ol>\n</li>\n<li><ol start=\"2\">\n<li>这个技术的优势和劣势分别是什么，或者说，这个技术的trade-off是什么。</li>\n</ol>\n</li>\n<li><ol start=\"3\">\n<li>这个技术的适用场景</li>\n</ol>\n</li>\n<li><ol start=\"4\">\n<li>技术的组成部分和关键点</li>\n</ol>\n</li>\n<li><ol start=\"5\">\n<li>技术的底层原理和关键实现</li>\n</ol>\n</li>\n<li><ol start=\"6\">\n<li>已有的实现和它之间的对比</li>\n</ol>\n</li>\n</ul>\n<h4 id=\"举一反三\"><a href=\"#举一反三\" class=\"headerlink\" title=\"举一反三\"></a>举一反三</h4><p>人与人之间最大的差别就在于举一反三的能力。举一反三的能力包含：</p>\n<ul>\n<li>联想能力<br>  平时需要锻炼同一个事物不同的看法，或者是联想与之有关的别的事物。</li>\n<li>抽象能力<br>  对问题进行抽象，获得多种表现形式</li>\n<li>自省能力<br>  当你得到一个解的时候，要站在对立面来找这个解的漏洞。这种自己和自己辩论的能力又叫思辨能力。获得完整全面的问题分析能力。</li>\n</ul>\n<p>训练方法：</p>\n<ul>\n<li>对于一个场景，制造出各种不同的问题或者难题</li>\n<li>对于一个问题，努力寻找尽可能多的解，并比较这些解的优劣</li>\n<li>对于一个解，努力寻找各种不同的测试案例，以图让其健壮</li>\n</ul>\n<h4 id=\"总结和归纳\"><a href=\"#总结和归纳\" class=\"headerlink\" title=\"总结和归纳\"></a>总结和归纳</h4><ul>\n<li>在学习的开始阶段，可以不急于总结归纳，不急于下判断，做结论，而应该保留部分知识的不确定性，保持对知识的开放状态。</li>\n</ul>\n<p>总结和归纳的方法：</p>\n<blockquote>\n<p>把你看到和学习到的信息，归整好，排列好，关联好，总之把信息碎片给结构化掉，然后在结构化的信息中，找到规律，找到相通之处，找到共同之处。进行简化、归纳和总结，最终形成一种套路一种模式，一种通用方法。</p>\n</blockquote>\n<h4 id=\"实践出真知\"><a href=\"#实践出真知\" class=\"headerlink\" title=\"实践出真知\"></a>实践出真知</h4><blockquote>\n<p>实践是一件很痛苦的事，但只有痛苦才会让人反思，而反思则是学习和改变自己的动力。</p>\n</blockquote>\n<h4 id=\"坚持不懈\"><a href=\"#坚持不懈\" class=\"headerlink\" title=\"坚持不懈\"></a>坚持不懈</h4><blockquote>\n<p>一方面你要把你的坚持形成的成果晒出来，让别人来给你点赞，另一方面，你还要把坚持变成一种习惯，就像吃饭喝水一样，你感觉不到太多的付出成本。只有做到这两点，你才能够真正坚持。</p>\n</blockquote>\n","site":{"data":{}},"excerpt":"","more":"<p><strong>深度学习的关键点：</strong></p>\n<ul>\n<li>高质量的信息源和第一手知识</li>\n<li>把知识连成地图，将自己的理解反述出来</li>\n<li>不断的反思和思辨，与不同年龄段的人讨论</li>\n<li>举一反三，并践行之，把知识转换成技能</li>\n</ul>\n<hr>\n<p><strong>学习的三个步骤:</strong></p>\n<ul>\n<li><p>知识采集<br>  获取信息的源头、破解表面信息内在的本质、多方的数据验证</p>\n</li>\n<li><p>知识缝合<br>  连接记忆，逻辑推理，知识梳理</p>\n</li>\n<li><p>技能转化<br>  举一反三，实践练习，传授教导</p>\n</li>\n</ul>\n<hr>\n<h3 id=\"学习方法论\"><a href=\"#学习方法论\" class=\"headerlink\" title=\"学习方法论\"></a>学习方法论</h3><h4 id=\"挑选知识和信息源的原则\"><a href=\"#挑选知识和信息源的原则\" class=\"headerlink\" title=\"挑选知识和信息源的原则\"></a>挑选知识和信息源的原则</h4><ul>\n<li>应该是第一手资料，不是被人理解过、消化过的二手资料</li>\n<li>应该有佐证、有数据、有引用的，或者有权威人士或者大公司生产系统背书</li>\n<li>应该是加入了一些自己的经验和思考，可以发人深思</li>\n</ul>\n<h4 id=\"注重基础和原理\"><a href=\"#注重基础和原理\" class=\"headerlink\" title=\"注重基础和原理\"></a>注重基础和原理</h4><ul>\n<li>基础不行会影响你对事物的理解，甚至会让你不能理解为什么是这样。当你对事物的出现有不理解的东西时，通常来说，是因为你的基础知识没有跟上。</li>\n</ul>\n<ul>\n<li>基础知识和原理性的东西和技术，都是经历长时间的考验的，所以，这些基础技术也有很多人类历史的智慧结晶，会给你很多启示和帮助。</li>\n</ul>\n<h4 id=\"使用知识图\"><a href=\"#使用知识图\" class=\"headerlink\" title=\"使用知识图\"></a>使用知识图</h4><ul>\n<li>把一块大知识拆解成知识树，采用联想记忆的方式梳理知识点。</li>\n<li>当遇到某个不知道的知识点的时候，就把它挂到这颗知识树上。</li>\n<li>学习不是为了要记忆那些知识点，而是为了找到一个知识的地图，在这个地图上能通过关键路径找到你想要的答案。</li>\n</ul>\n<h4 id=\"系统地学习\"><a href=\"#系统地学习\" class=\"headerlink\" title=\"系统地学习\"></a>系统地学习</h4><p>学习某个技术的时候问几个问题：</p>\n<ul>\n<li><ol>\n<li>这个技术出现的背景、初衷和要达到什么样的目标或者是解决什么样的问题。</li>\n</ol>\n</li>\n<li><ol start=\"2\">\n<li>这个技术的优势和劣势分别是什么，或者说，这个技术的trade-off是什么。</li>\n</ol>\n</li>\n<li><ol start=\"3\">\n<li>这个技术的适用场景</li>\n</ol>\n</li>\n<li><ol start=\"4\">\n<li>技术的组成部分和关键点</li>\n</ol>\n</li>\n<li><ol start=\"5\">\n<li>技术的底层原理和关键实现</li>\n</ol>\n</li>\n<li><ol start=\"6\">\n<li>已有的实现和它之间的对比</li>\n</ol>\n</li>\n</ul>\n<h4 id=\"举一反三\"><a href=\"#举一反三\" class=\"headerlink\" title=\"举一反三\"></a>举一反三</h4><p>人与人之间最大的差别就在于举一反三的能力。举一反三的能力包含：</p>\n<ul>\n<li>联想能力<br>  平时需要锻炼同一个事物不同的看法，或者是联想与之有关的别的事物。</li>\n<li>抽象能力<br>  对问题进行抽象，获得多种表现形式</li>\n<li>自省能力<br>  当你得到一个解的时候，要站在对立面来找这个解的漏洞。这种自己和自己辩论的能力又叫思辨能力。获得完整全面的问题分析能力。</li>\n</ul>\n<p>训练方法：</p>\n<ul>\n<li>对于一个场景，制造出各种不同的问题或者难题</li>\n<li>对于一个问题，努力寻找尽可能多的解，并比较这些解的优劣</li>\n<li>对于一个解，努力寻找各种不同的测试案例，以图让其健壮</li>\n</ul>\n<h4 id=\"总结和归纳\"><a href=\"#总结和归纳\" class=\"headerlink\" title=\"总结和归纳\"></a>总结和归纳</h4><ul>\n<li>在学习的开始阶段，可以不急于总结归纳，不急于下判断，做结论，而应该保留部分知识的不确定性，保持对知识的开放状态。</li>\n</ul>\n<p>总结和归纳的方法：</p>\n<blockquote>\n<p>把你看到和学习到的信息，归整好，排列好，关联好，总之把信息碎片给结构化掉，然后在结构化的信息中，找到规律，找到相通之处，找到共同之处。进行简化、归纳和总结，最终形成一种套路一种模式，一种通用方法。</p>\n</blockquote>\n<h4 id=\"实践出真知\"><a href=\"#实践出真知\" class=\"headerlink\" title=\"实践出真知\"></a>实践出真知</h4><blockquote>\n<p>实践是一件很痛苦的事，但只有痛苦才会让人反思，而反思则是学习和改变自己的动力。</p>\n</blockquote>\n<h4 id=\"坚持不懈\"><a href=\"#坚持不懈\" class=\"headerlink\" title=\"坚持不懈\"></a>坚持不懈</h4><blockquote>\n<p>一方面你要把你的坚持形成的成果晒出来，让别人来给你点赞，另一方面，你还要把坚持变成一种习惯，就像吃饭喝水一样，你感觉不到太多的付出成本。只有做到这两点，你才能够真正坚持。</p>\n</blockquote>\n"},{"title":"如何设计一个数据字典","date":"2016-07-07T02:37:03.000Z","_content":"数据字典在`Javascript`语言里面随处可见，对象本身就可以看成一个数据字典，通过给对象设置属性与方法，达到一个字典的目的。  \n```javascript  \nvar dict = new Dict();\n\nobj.pro1 = \"hello world!!!\";\nobj.pro2 = function () {\n    console.log(\"I'am pro2\");\n};\n\n```  \n\n先来看一个常见的数据字典的设计：  \n\n```javascript\n\nfunction Dict() {\n}\n\nDict.prototype.count = function() {\n    let n = 0;\n    for(let k in this) {\n        n++;\n    };\n    return n;\n};\n\n//\nlet dict = new Dict();\ndict.paul = 3;\ndict.lebron = 23;\n\ndict.count() // 3  \n```   \n\n为什么给设置了两个属性，通过`count`计算得出的结果是`3`呢？这里比较容易看出来，因为`for in`会遍历原型链上的可枚举的属性，例如上面的`count`方法。为了避免这种由于遍历原型链导致的错误结果，实现一个改进版本：  \n\n```javascript  \nvar dict = {};\n\ndict.diwy = 3;\ndict.love = 10;\n\nlet n = 0;\nfor(let k in dict) {\n   n++;\n}\nconsole.log(n)  //2\n```   \n\n通过这种改进虽然能够得出正确的结果，但是我们把这一切能够正常运行的希望寄托于`Object.prototype`原型没有受到`污染`。这种假设通常伴随一定的风险，如果和其他人协同开发产品，你不能保证其他人也和你一样遵循相应的规范。  \n\n了解到潜在的原型污染问题之后，可以想到的做法是，构造一个对象，不依赖于常规的原型对象：  \n\n```javascript\nfunction C() {}\nC.prototype = null;\n```  \n\n来测试一下：  \n```javascript\nvar c = new C();\nObject.getPropertyOf(c) === null;//false\nObject.getPropertyOf(c) === Object.prototype; //true\n```  \n\n遗憾的是`c`对象的原型依然是`Object.prototype`。`ES5`提供了一个方法来创建一个没有原型的对象：  \n```javascript  \nvar dict = Object.create(null);\nObject.getPropertyOf(dict) === null; // true\n```  \n\n通过创建一个没有原型的对象，可以很好的规避原型污染问题。但是如果你既需要对象原型，又想保证字典枚举的安全性，那就得改造一些字典的设计。  \n\n使用`hasOwnProperty`来判断对象的实体属性，而不是原型熟悉。  \n```javascript  \nvar dict = {};\ndict.name = 'lebron';\ndict.hasOwnPropertyOf(\"name\") //true;\ndict.hasOwnPropertyOf(\"valueOf\") //false\n\"valudeOf\" in dict //true\n```  \n\n为了避免设置`hasOwnPropertyOf`这样奇怪的属性，我们需要在任何安全的位置提取出`hasOwnPropertyOf`方法。  \n```javascript\nvar hasOwnProperty = Object.prototype.hasOwnProperty;\n//或者  \nvar hasOwnProperty = {}.hasOwnProperty;  \n\nhasOwnProperty.call(dict, \"name\"); //true\n```  \n\n一个安全的数据字典实现：  \n```javascript  \n\nfunction Dict(elements) {\n  this.elements = elements || {};\n}\n\nDict.property.has = function(key) {\n  return {}.hasOwnPropertyOf(key);\n};\n\nDict.property.get = function(key) {\n  return this.has(key) ? this.elements[key] : undefined;\n};\n\nDict.property.set = function(key, value) {\n  this.elements[key] = value;\n};\n\nDict.property.remove = function(key) {\n  delete this.elements[key];\n};\n\n```  \n\n在一些`javascript`环境中，特殊的属性名`__proto__`可能会导致自身的污染问题(修改对象的原型)。我们必须把它优化掉：  \n\n```javascript\nfunction Dict(elements) {\n  this.elements = elements || {};\n  this.specialPropValue = undefined;\n  this.specialProp = \"__proto__\";\n  this.hasSpecialProp = false;\n}\n\nDict.prototype.has = function(key) {\n  if(key === this.specialProp) {\n    return this.hasSpecialProp;\n  }\n  return {}.hasOwnPropertyOf.call(this.elements, key);\n};\n\nDict.prototype.get = function(key) {\n  if(key === this.specialProp) {\n    return this.specialProp;\n  }\n  return this.has(key) ? this.elements[key] : undefined;\n};\n\nDict.prototype.set = function(key, value) {\n  if(key === this.specialProp) {\n    this.specialPropValue = value;\n  }\n  else {\n    this.elements[key] = value;\n  }\n};\n\n```\n\n这样`javascript`环境是否处理`__proto__`属性，该实现均能保证是可工作的，以上也算是数据字典比较好的一个设计吧！。\n\n\n\n\n\n","source":"_posts/如何设计一个数据字典.md","raw":"---\ntitle: 如何设计一个数据字典\ncategories: server\ndate: 2016-07-07 10:37:03\n---\n数据字典在`Javascript`语言里面随处可见，对象本身就可以看成一个数据字典，通过给对象设置属性与方法，达到一个字典的目的。  \n```javascript  \nvar dict = new Dict();\n\nobj.pro1 = \"hello world!!!\";\nobj.pro2 = function () {\n    console.log(\"I'am pro2\");\n};\n\n```  \n\n先来看一个常见的数据字典的设计：  \n\n```javascript\n\nfunction Dict() {\n}\n\nDict.prototype.count = function() {\n    let n = 0;\n    for(let k in this) {\n        n++;\n    };\n    return n;\n};\n\n//\nlet dict = new Dict();\ndict.paul = 3;\ndict.lebron = 23;\n\ndict.count() // 3  \n```   \n\n为什么给设置了两个属性，通过`count`计算得出的结果是`3`呢？这里比较容易看出来，因为`for in`会遍历原型链上的可枚举的属性，例如上面的`count`方法。为了避免这种由于遍历原型链导致的错误结果，实现一个改进版本：  \n\n```javascript  \nvar dict = {};\n\ndict.diwy = 3;\ndict.love = 10;\n\nlet n = 0;\nfor(let k in dict) {\n   n++;\n}\nconsole.log(n)  //2\n```   \n\n通过这种改进虽然能够得出正确的结果，但是我们把这一切能够正常运行的希望寄托于`Object.prototype`原型没有受到`污染`。这种假设通常伴随一定的风险，如果和其他人协同开发产品，你不能保证其他人也和你一样遵循相应的规范。  \n\n了解到潜在的原型污染问题之后，可以想到的做法是，构造一个对象，不依赖于常规的原型对象：  \n\n```javascript\nfunction C() {}\nC.prototype = null;\n```  \n\n来测试一下：  \n```javascript\nvar c = new C();\nObject.getPropertyOf(c) === null;//false\nObject.getPropertyOf(c) === Object.prototype; //true\n```  \n\n遗憾的是`c`对象的原型依然是`Object.prototype`。`ES5`提供了一个方法来创建一个没有原型的对象：  \n```javascript  \nvar dict = Object.create(null);\nObject.getPropertyOf(dict) === null; // true\n```  \n\n通过创建一个没有原型的对象，可以很好的规避原型污染问题。但是如果你既需要对象原型，又想保证字典枚举的安全性，那就得改造一些字典的设计。  \n\n使用`hasOwnProperty`来判断对象的实体属性，而不是原型熟悉。  \n```javascript  \nvar dict = {};\ndict.name = 'lebron';\ndict.hasOwnPropertyOf(\"name\") //true;\ndict.hasOwnPropertyOf(\"valueOf\") //false\n\"valudeOf\" in dict //true\n```  \n\n为了避免设置`hasOwnPropertyOf`这样奇怪的属性，我们需要在任何安全的位置提取出`hasOwnPropertyOf`方法。  \n```javascript\nvar hasOwnProperty = Object.prototype.hasOwnProperty;\n//或者  \nvar hasOwnProperty = {}.hasOwnProperty;  \n\nhasOwnProperty.call(dict, \"name\"); //true\n```  \n\n一个安全的数据字典实现：  \n```javascript  \n\nfunction Dict(elements) {\n  this.elements = elements || {};\n}\n\nDict.property.has = function(key) {\n  return {}.hasOwnPropertyOf(key);\n};\n\nDict.property.get = function(key) {\n  return this.has(key) ? this.elements[key] : undefined;\n};\n\nDict.property.set = function(key, value) {\n  this.elements[key] = value;\n};\n\nDict.property.remove = function(key) {\n  delete this.elements[key];\n};\n\n```  \n\n在一些`javascript`环境中，特殊的属性名`__proto__`可能会导致自身的污染问题(修改对象的原型)。我们必须把它优化掉：  \n\n```javascript\nfunction Dict(elements) {\n  this.elements = elements || {};\n  this.specialPropValue = undefined;\n  this.specialProp = \"__proto__\";\n  this.hasSpecialProp = false;\n}\n\nDict.prototype.has = function(key) {\n  if(key === this.specialProp) {\n    return this.hasSpecialProp;\n  }\n  return {}.hasOwnPropertyOf.call(this.elements, key);\n};\n\nDict.prototype.get = function(key) {\n  if(key === this.specialProp) {\n    return this.specialProp;\n  }\n  return this.has(key) ? this.elements[key] : undefined;\n};\n\nDict.prototype.set = function(key, value) {\n  if(key === this.specialProp) {\n    this.specialPropValue = value;\n  }\n  else {\n    this.elements[key] = value;\n  }\n};\n\n```\n\n这样`javascript`环境是否处理`__proto__`属性，该实现均能保证是可工作的，以上也算是数据字典比较好的一个设计吧！。\n\n\n\n\n\n","slug":"如何设计一个数据字典","published":1,"updated":"2018-07-01T10:30:46.499Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cee004my4zvm777f6e0","content":"<p>数据字典在<code>Javascript</code>语言里面随处可见，对象本身就可以看成一个数据字典，通过给对象设置属性与方法，达到一个字典的目的。<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> dict = <span class=\"keyword\">new</span> Dict();</span><br><span class=\"line\"></span><br><span class=\"line\">obj.pro1 = <span class=\"string\">\"hello world!!!\"</span>;</span><br><span class=\"line\">obj.pro2 = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">\"I'am pro2\"</span>);</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">先来看一个常见的数据字典的设计：  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">Dict</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">Dict.prototype.count = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> n = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(<span class=\"keyword\">let</span> k <span class=\"keyword\">in</span> <span class=\"keyword\">this</span>) &#123;</span><br><span class=\"line\">        n++;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> n;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"keyword\">let</span> dict = <span class=\"keyword\">new</span> Dict();</span><br><span class=\"line\">dict.paul = <span class=\"number\">3</span>;</span><br><span class=\"line\">dict.lebron = <span class=\"number\">23</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">dict.count() <span class=\"comment\">// 3  </span></span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`   </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">为什么给设置了两个属性，通过`</span>count<span class=\"string\">`计算得出的结果是`</span><span class=\"number\">3</span><span class=\"string\">`呢？这里比较容易看出来，因为`</span><span class=\"keyword\">for</span> <span class=\"keyword\">in</span><span class=\"string\">`会遍历原型链上的可枚举的属性，例如上面的`</span>count<span class=\"string\">`方法。为了避免这种由于遍历原型链导致的错误结果，实现一个改进版本：  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript  </span><br><span class=\"line\"><span class=\"keyword\">var</span> dict = &#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">dict.diwy = <span class=\"number\">3</span>;</span><br><span class=\"line\">dict.love = <span class=\"number\">10</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">let</span> n = <span class=\"number\">0</span>;</span><br><span class=\"line\"><span class=\"keyword\">for</span>(<span class=\"keyword\">let</span> k <span class=\"keyword\">in</span> dict) &#123;</span><br><span class=\"line\">   n++;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"built_in\">console</span>.log(n)  <span class=\"comment\">//2</span></span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`   </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">通过这种改进虽然能够得出正确的结果，但是我们把这一切能够正常运行的希望寄托于`</span><span class=\"built_in\">Object</span>.prototype<span class=\"string\">`原型没有受到`</span>污染<span class=\"string\">`。这种假设通常伴随一定的风险，如果和其他人协同开发产品，你不能保证其他人也和你一样遵循相应的规范。  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">了解到潜在的原型污染问题之后，可以想到的做法是，构造一个对象，不依赖于常规的原型对象：  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">C</span>(<span class=\"params\"></span>) </span>&#123;&#125;</span><br><span class=\"line\">C.prototype = <span class=\"literal\">null</span>;</span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">来测试一下：  </span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript</span><br><span class=\"line\"><span class=\"keyword\">var</span> c = <span class=\"keyword\">new</span> C();</span><br><span class=\"line\"><span class=\"built_in\">Object</span>.getPropertyOf(c) === <span class=\"literal\">null</span>;<span class=\"comment\">//false</span></span><br><span class=\"line\"><span class=\"built_in\">Object</span>.getPropertyOf(c) === <span class=\"built_in\">Object</span>.prototype; <span class=\"comment\">//true</span></span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">遗憾的是`</span>c<span class=\"string\">`对象的原型依然是`</span><span class=\"built_in\">Object</span>.prototype<span class=\"string\">`。`</span>ES5<span class=\"string\">`提供了一个方法来创建一个没有原型的对象：  </span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript  </span><br><span class=\"line\"><span class=\"keyword\">var</span> dict = <span class=\"built_in\">Object</span>.create(<span class=\"literal\">null</span>);</span><br><span class=\"line\"><span class=\"built_in\">Object</span>.getPropertyOf(dict) === <span class=\"literal\">null</span>; <span class=\"comment\">// true</span></span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">通过创建一个没有原型的对象，可以很好的规避原型污染问题。但是如果你既需要对象原型，又想保证字典枚举的安全性，那就得改造一些字典的设计。  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">使用`</span>hasOwnProperty<span class=\"string\">`来判断对象的实体属性，而不是原型熟悉。  </span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript  </span><br><span class=\"line\"><span class=\"keyword\">var</span> dict = &#123;&#125;;</span><br><span class=\"line\">dict.name = <span class=\"string\">'lebron'</span>;</span><br><span class=\"line\">dict.hasOwnPropertyOf(<span class=\"string\">\"name\"</span>) <span class=\"comment\">//true;</span></span><br><span class=\"line\">dict.hasOwnPropertyOf(<span class=\"string\">\"valueOf\"</span>) <span class=\"comment\">//false</span></span><br><span class=\"line\"><span class=\"string\">\"valudeOf\"</span> <span class=\"keyword\">in</span> dict <span class=\"comment\">//true</span></span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">为了避免设置`</span>hasOwnPropertyOf<span class=\"string\">`这样奇怪的属性，我们需要在任何安全的位置提取出`</span>hasOwnPropertyOf<span class=\"string\">`方法。  </span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript</span><br><span class=\"line\"><span class=\"keyword\">var</span> hasOwnProperty = <span class=\"built_in\">Object</span>.prototype.hasOwnProperty;</span><br><span class=\"line\"><span class=\"comment\">//或者  </span></span><br><span class=\"line\"><span class=\"keyword\">var</span> hasOwnProperty = &#123;&#125;.hasOwnProperty;  </span><br><span class=\"line\"></span><br><span class=\"line\">hasOwnProperty.call(dict, <span class=\"string\">\"name\"</span>); <span class=\"comment\">//true</span></span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">一个安全的数据字典实现：  </span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript  </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">Dict</span>(<span class=\"params\">elements</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.elements = elements || &#123;&#125;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">Dict.property.has = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">key</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> &#123;&#125;.hasOwnPropertyOf(key);</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">Dict.property.get = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">key</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.has(key) ? <span class=\"keyword\">this</span>.elements[key] : <span class=\"literal\">undefined</span>;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">Dict.property.set = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">key, value</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.elements[key] = value;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">Dict.property.remove = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">key</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">delete</span> <span class=\"keyword\">this</span>.elements[key];</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">在一些`</span>javascript<span class=\"string\">`环境中，特殊的属性名`</span>__proto__<span class=\"string\">`可能会导致自身的污染问题(修改对象的原型)。我们必须把它优化掉：  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">Dict</span>(<span class=\"params\">elements</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.elements = elements || &#123;&#125;;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.specialPropValue = <span class=\"literal\">undefined</span>;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.specialProp = <span class=\"string\">\"__proto__\"</span>;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.hasSpecialProp = <span class=\"literal\">false</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">Dict.prototype.has = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">key</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(key === <span class=\"keyword\">this</span>.specialProp) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.hasSpecialProp;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> &#123;&#125;.hasOwnPropertyOf.call(<span class=\"keyword\">this</span>.elements, key);</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">Dict.prototype.get = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">key</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(key === <span class=\"keyword\">this</span>.specialProp) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.specialProp;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.has(key) ? <span class=\"keyword\">this</span>.elements[key] : <span class=\"literal\">undefined</span>;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">Dict.prototype.set = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">key, value</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(key === <span class=\"keyword\">this</span>.specialProp) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.specialPropValue = value;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.elements[key] = value;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure></p>\n<p>这样<code>javascript</code>环境是否处理<code>__proto__</code>属性，该实现均能保证是可工作的，以上也算是数据字典比较好的一个设计吧！。</p>\n","site":{"data":{}},"excerpt":"","more":"<p>数据字典在<code>Javascript</code>语言里面随处可见，对象本身就可以看成一个数据字典，通过给对象设置属性与方法，达到一个字典的目的。<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> dict = <span class=\"keyword\">new</span> Dict();</span><br><span class=\"line\"></span><br><span class=\"line\">obj.pro1 = <span class=\"string\">\"hello world!!!\"</span>;</span><br><span class=\"line\">obj.pro2 = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">\"I'am pro2\"</span>);</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">先来看一个常见的数据字典的设计：  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">Dict</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">Dict.prototype.count = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> n = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(<span class=\"keyword\">let</span> k <span class=\"keyword\">in</span> <span class=\"keyword\">this</span>) &#123;</span><br><span class=\"line\">        n++;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> n;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"keyword\">let</span> dict = <span class=\"keyword\">new</span> Dict();</span><br><span class=\"line\">dict.paul = <span class=\"number\">3</span>;</span><br><span class=\"line\">dict.lebron = <span class=\"number\">23</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">dict.count() <span class=\"comment\">// 3  </span></span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`   </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">为什么给设置了两个属性，通过`</span>count<span class=\"string\">`计算得出的结果是`</span><span class=\"number\">3</span><span class=\"string\">`呢？这里比较容易看出来，因为`</span><span class=\"keyword\">for</span> <span class=\"keyword\">in</span><span class=\"string\">`会遍历原型链上的可枚举的属性，例如上面的`</span>count<span class=\"string\">`方法。为了避免这种由于遍历原型链导致的错误结果，实现一个改进版本：  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript  </span><br><span class=\"line\"><span class=\"keyword\">var</span> dict = &#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">dict.diwy = <span class=\"number\">3</span>;</span><br><span class=\"line\">dict.love = <span class=\"number\">10</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">let</span> n = <span class=\"number\">0</span>;</span><br><span class=\"line\"><span class=\"keyword\">for</span>(<span class=\"keyword\">let</span> k <span class=\"keyword\">in</span> dict) &#123;</span><br><span class=\"line\">   n++;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"built_in\">console</span>.log(n)  <span class=\"comment\">//2</span></span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`   </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">通过这种改进虽然能够得出正确的结果，但是我们把这一切能够正常运行的希望寄托于`</span><span class=\"built_in\">Object</span>.prototype<span class=\"string\">`原型没有受到`</span>污染<span class=\"string\">`。这种假设通常伴随一定的风险，如果和其他人协同开发产品，你不能保证其他人也和你一样遵循相应的规范。  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">了解到潜在的原型污染问题之后，可以想到的做法是，构造一个对象，不依赖于常规的原型对象：  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">C</span>(<span class=\"params\"></span>) </span>&#123;&#125;</span><br><span class=\"line\">C.prototype = <span class=\"literal\">null</span>;</span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">来测试一下：  </span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript</span><br><span class=\"line\"><span class=\"keyword\">var</span> c = <span class=\"keyword\">new</span> C();</span><br><span class=\"line\"><span class=\"built_in\">Object</span>.getPropertyOf(c) === <span class=\"literal\">null</span>;<span class=\"comment\">//false</span></span><br><span class=\"line\"><span class=\"built_in\">Object</span>.getPropertyOf(c) === <span class=\"built_in\">Object</span>.prototype; <span class=\"comment\">//true</span></span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">遗憾的是`</span>c<span class=\"string\">`对象的原型依然是`</span><span class=\"built_in\">Object</span>.prototype<span class=\"string\">`。`</span>ES5<span class=\"string\">`提供了一个方法来创建一个没有原型的对象：  </span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript  </span><br><span class=\"line\"><span class=\"keyword\">var</span> dict = <span class=\"built_in\">Object</span>.create(<span class=\"literal\">null</span>);</span><br><span class=\"line\"><span class=\"built_in\">Object</span>.getPropertyOf(dict) === <span class=\"literal\">null</span>; <span class=\"comment\">// true</span></span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">通过创建一个没有原型的对象，可以很好的规避原型污染问题。但是如果你既需要对象原型，又想保证字典枚举的安全性，那就得改造一些字典的设计。  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">使用`</span>hasOwnProperty<span class=\"string\">`来判断对象的实体属性，而不是原型熟悉。  </span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript  </span><br><span class=\"line\"><span class=\"keyword\">var</span> dict = &#123;&#125;;</span><br><span class=\"line\">dict.name = <span class=\"string\">'lebron'</span>;</span><br><span class=\"line\">dict.hasOwnPropertyOf(<span class=\"string\">\"name\"</span>) <span class=\"comment\">//true;</span></span><br><span class=\"line\">dict.hasOwnPropertyOf(<span class=\"string\">\"valueOf\"</span>) <span class=\"comment\">//false</span></span><br><span class=\"line\"><span class=\"string\">\"valudeOf\"</span> <span class=\"keyword\">in</span> dict <span class=\"comment\">//true</span></span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">为了避免设置`</span>hasOwnPropertyOf<span class=\"string\">`这样奇怪的属性，我们需要在任何安全的位置提取出`</span>hasOwnPropertyOf<span class=\"string\">`方法。  </span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript</span><br><span class=\"line\"><span class=\"keyword\">var</span> hasOwnProperty = <span class=\"built_in\">Object</span>.prototype.hasOwnProperty;</span><br><span class=\"line\"><span class=\"comment\">//或者  </span></span><br><span class=\"line\"><span class=\"keyword\">var</span> hasOwnProperty = &#123;&#125;.hasOwnProperty;  </span><br><span class=\"line\"></span><br><span class=\"line\">hasOwnProperty.call(dict, <span class=\"string\">\"name\"</span>); <span class=\"comment\">//true</span></span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">一个安全的数据字典实现：  </span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript  </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">Dict</span>(<span class=\"params\">elements</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.elements = elements || &#123;&#125;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">Dict.property.has = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">key</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> &#123;&#125;.hasOwnPropertyOf(key);</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">Dict.property.get = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">key</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.has(key) ? <span class=\"keyword\">this</span>.elements[key] : <span class=\"literal\">undefined</span>;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">Dict.property.set = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">key, value</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.elements[key] = value;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">Dict.property.remove = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">key</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">delete</span> <span class=\"keyword\">this</span>.elements[key];</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">``</span><span class=\"string\">`  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">在一些`</span>javascript<span class=\"string\">`环境中，特殊的属性名`</span>__proto__<span class=\"string\">`可能会导致自身的污染问题(修改对象的原型)。我们必须把它优化掉：  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">`</span><span class=\"string\">``</span>javascript</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">Dict</span>(<span class=\"params\">elements</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.elements = elements || &#123;&#125;;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.specialPropValue = <span class=\"literal\">undefined</span>;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.specialProp = <span class=\"string\">\"__proto__\"</span>;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.hasSpecialProp = <span class=\"literal\">false</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">Dict.prototype.has = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">key</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(key === <span class=\"keyword\">this</span>.specialProp) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.hasSpecialProp;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> &#123;&#125;.hasOwnPropertyOf.call(<span class=\"keyword\">this</span>.elements, key);</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">Dict.prototype.get = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">key</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(key === <span class=\"keyword\">this</span>.specialProp) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.specialProp;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.has(key) ? <span class=\"keyword\">this</span>.elements[key] : <span class=\"literal\">undefined</span>;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">Dict.prototype.set = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">key, value</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(key === <span class=\"keyword\">this</span>.specialProp) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.specialPropValue = value;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.elements[key] = value;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure></p>\n<p>这样<code>javascript</code>环境是否处理<code>__proto__</code>属性，该实现均能保证是可工作的，以上也算是数据字典比较好的一个设计吧！。</p>\n"},{"title":"微服务系统架构","date":"2017-10-07T05:10:30.000Z","_content":"\n## 一、引入微服务架构需要作出权衡\n\n微服务解决了传统`SOA`项目开发部署的效率问题，大大提升了产品的迭代速度。另一方面通过把需求合理的划分为单一小模块，针对不同业务场景可以采用不同的技术选型。\n\n微服务的优势已经被研究的很透彻，但是在实践的过程中需要作出权衡。在业务规模比较小的时候传统的单一代码库的开发效率远高于微服务。也就是说在项目初期，产品方向不明确，这个时候采用传统的单一代码库来开发是一个更好的选择。随着业务复杂度的上升，微服务模式的开发效率逐渐高于单体代码仓库。\n\n![cat](/img/micro-vs-soa.jpeg)\n\n可以看到在项目前期`SOA`开发效率比较高，随着项目不断迭代，需求复杂度上升，到达某一零界点的时候微服务架构开发效率高于`SOA`模式这个时候微服务的优势才慢慢体现出来。\n\n## 二、微服务架构与组织模块划分\n\n著名的[康威法则](https://en.wikipedia.org/wiki/Conway%27s_law)为团队的组织关系与系统代码架构的划分给出了良好的建议：\n\n>设计系统的组织，其产生的设计和架构等价于组织间的沟通结构。\n\n团队之间是松散的，而单一应用必须让不同团队协同开发测试部署，成本比较高。通过把项目合理划分到不同的团队，互不干扰，系统效率得到了提升。\n\n\n## 三、微服务总体技术架构\n\n![microServices-Layers](/img/微服务系统架构分层模型.png)\n\n\n## 四、微服务网关\n\n网关作为微服务入口主要有以下几个功能：\n\n1. 反向路由\n2. 认证安全\n3. 限流熔断\n4. 日志监控\n\n常见的网关如`zuul`, 和基于`openResty`的`Kong`都有很好的支持。\n\n\n## 五、微服务集中配置中心\n\n随着微服务数量增多集中化配置会慢慢变成一个痛点，集中化配置主要有以下一些优点：\n\n+ 可追溯\n+ 响应快\n+ 集中化管理\n\n常用的集中化配置实现方式：\n\n1. pull模式(定时拉取)\n2. push模式(配置更新推送)\n\n作为业界微服务的楷模`Netflix`开源了一个[archaius](https://github.com/Netflix/archaius)专门负责配置管理。\n\n\n## 六、微服务通信方式RPC vs REST\n\n|       | RPC                          | REST            |\n| ----- | ---------------------------- | --------------- |\n| 耦合性   | 强耦合                          | 松散耦合            |\n| 消息协议  | 二进制、thrift、protobuf          | 文本XML、JSON      |\n| 通信协议  | TCP                          | HTTP／HTTP2      |\n| 性能    | 高                            | 一般低于RPC         |\n| 接口契约  | thrift、protobuf              | swagger、openAPI |\n| 客户端   | 强类型客户端、一般通过工具自动生成            | 普通http请求客户端即可   |\n| 案例    | Dubbo、motan、Tars、grpc、thrift | Jax-rs          |\n| 开发者友好 | 客户端集成方便、二进制消息不可读             | 文本消息可读          |\n| 对外开放  | 一般需要转换成REST/文本协议             | 直接可以对外开放        |\n","source":"_posts/微服务系统架构.md","raw":"---\ntitle: 微服务系统架构\ncategories: server\ndate: 2017-10-07 13:10:30\n---\n\n## 一、引入微服务架构需要作出权衡\n\n微服务解决了传统`SOA`项目开发部署的效率问题，大大提升了产品的迭代速度。另一方面通过把需求合理的划分为单一小模块，针对不同业务场景可以采用不同的技术选型。\n\n微服务的优势已经被研究的很透彻，但是在实践的过程中需要作出权衡。在业务规模比较小的时候传统的单一代码库的开发效率远高于微服务。也就是说在项目初期，产品方向不明确，这个时候采用传统的单一代码库来开发是一个更好的选择。随着业务复杂度的上升，微服务模式的开发效率逐渐高于单体代码仓库。\n\n![cat](/img/micro-vs-soa.jpeg)\n\n可以看到在项目前期`SOA`开发效率比较高，随着项目不断迭代，需求复杂度上升，到达某一零界点的时候微服务架构开发效率高于`SOA`模式这个时候微服务的优势才慢慢体现出来。\n\n## 二、微服务架构与组织模块划分\n\n著名的[康威法则](https://en.wikipedia.org/wiki/Conway%27s_law)为团队的组织关系与系统代码架构的划分给出了良好的建议：\n\n>设计系统的组织，其产生的设计和架构等价于组织间的沟通结构。\n\n团队之间是松散的，而单一应用必须让不同团队协同开发测试部署，成本比较高。通过把项目合理划分到不同的团队，互不干扰，系统效率得到了提升。\n\n\n## 三、微服务总体技术架构\n\n![microServices-Layers](/img/微服务系统架构分层模型.png)\n\n\n## 四、微服务网关\n\n网关作为微服务入口主要有以下几个功能：\n\n1. 反向路由\n2. 认证安全\n3. 限流熔断\n4. 日志监控\n\n常见的网关如`zuul`, 和基于`openResty`的`Kong`都有很好的支持。\n\n\n## 五、微服务集中配置中心\n\n随着微服务数量增多集中化配置会慢慢变成一个痛点，集中化配置主要有以下一些优点：\n\n+ 可追溯\n+ 响应快\n+ 集中化管理\n\n常用的集中化配置实现方式：\n\n1. pull模式(定时拉取)\n2. push模式(配置更新推送)\n\n作为业界微服务的楷模`Netflix`开源了一个[archaius](https://github.com/Netflix/archaius)专门负责配置管理。\n\n\n## 六、微服务通信方式RPC vs REST\n\n|       | RPC                          | REST            |\n| ----- | ---------------------------- | --------------- |\n| 耦合性   | 强耦合                          | 松散耦合            |\n| 消息协议  | 二进制、thrift、protobuf          | 文本XML、JSON      |\n| 通信协议  | TCP                          | HTTP／HTTP2      |\n| 性能    | 高                            | 一般低于RPC         |\n| 接口契约  | thrift、protobuf              | swagger、openAPI |\n| 客户端   | 强类型客户端、一般通过工具自动生成            | 普通http请求客户端即可   |\n| 案例    | Dubbo、motan、Tars、grpc、thrift | Jax-rs          |\n| 开发者友好 | 客户端集成方便、二进制消息不可读             | 文本消息可读          |\n| 对外开放  | 一般需要转换成REST/文本协议             | 直接可以对外开放        |\n","slug":"微服务系统架构","published":1,"updated":"2018-07-01T10:30:46.499Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cef004py4zvdaeefu1g","content":"<h2 id=\"一、引入微服务架构需要作出权衡\"><a href=\"#一、引入微服务架构需要作出权衡\" class=\"headerlink\" title=\"一、引入微服务架构需要作出权衡\"></a>一、引入微服务架构需要作出权衡</h2><p>微服务解决了传统<code>SOA</code>项目开发部署的效率问题，大大提升了产品的迭代速度。另一方面通过把需求合理的划分为单一小模块，针对不同业务场景可以采用不同的技术选型。</p>\n<p>微服务的优势已经被研究的很透彻，但是在实践的过程中需要作出权衡。在业务规模比较小的时候传统的单一代码库的开发效率远高于微服务。也就是说在项目初期，产品方向不明确，这个时候采用传统的单一代码库来开发是一个更好的选择。随着业务复杂度的上升，微服务模式的开发效率逐渐高于单体代码仓库。</p>\n<p><img src=\"/img/micro-vs-soa.jpeg\" alt=\"cat\"></p>\n<p>可以看到在项目前期<code>SOA</code>开发效率比较高，随着项目不断迭代，需求复杂度上升，到达某一零界点的时候微服务架构开发效率高于<code>SOA</code>模式这个时候微服务的优势才慢慢体现出来。</p>\n<h2 id=\"二、微服务架构与组织模块划分\"><a href=\"#二、微服务架构与组织模块划分\" class=\"headerlink\" title=\"二、微服务架构与组织模块划分\"></a>二、微服务架构与组织模块划分</h2><p>著名的<a href=\"https://en.wikipedia.org/wiki/Conway%27s_law\" target=\"_blank\" rel=\"noopener\">康威法则</a>为团队的组织关系与系统代码架构的划分给出了良好的建议：</p>\n<blockquote>\n<p>设计系统的组织，其产生的设计和架构等价于组织间的沟通结构。</p>\n</blockquote>\n<p>团队之间是松散的，而单一应用必须让不同团队协同开发测试部署，成本比较高。通过把项目合理划分到不同的团队，互不干扰，系统效率得到了提升。</p>\n<h2 id=\"三、微服务总体技术架构\"><a href=\"#三、微服务总体技术架构\" class=\"headerlink\" title=\"三、微服务总体技术架构\"></a>三、微服务总体技术架构</h2><p><img src=\"/img/微服务系统架构分层模型.png\" alt=\"microServices-Layers\"></p>\n<h2 id=\"四、微服务网关\"><a href=\"#四、微服务网关\" class=\"headerlink\" title=\"四、微服务网关\"></a>四、微服务网关</h2><p>网关作为微服务入口主要有以下几个功能：</p>\n<ol>\n<li>反向路由</li>\n<li>认证安全</li>\n<li>限流熔断</li>\n<li>日志监控</li>\n</ol>\n<p>常见的网关如<code>zuul</code>, 和基于<code>openResty</code>的<code>Kong</code>都有很好的支持。</p>\n<h2 id=\"五、微服务集中配置中心\"><a href=\"#五、微服务集中配置中心\" class=\"headerlink\" title=\"五、微服务集中配置中心\"></a>五、微服务集中配置中心</h2><p>随着微服务数量增多集中化配置会慢慢变成一个痛点，集中化配置主要有以下一些优点：</p>\n<ul>\n<li>可追溯</li>\n<li>响应快</li>\n<li>集中化管理</li>\n</ul>\n<p>常用的集中化配置实现方式：</p>\n<ol>\n<li>pull模式(定时拉取)</li>\n<li>push模式(配置更新推送)</li>\n</ol>\n<p>作为业界微服务的楷模<code>Netflix</code>开源了一个<a href=\"https://github.com/Netflix/archaius\" target=\"_blank\" rel=\"noopener\">archaius</a>专门负责配置管理。</p>\n<h2 id=\"六、微服务通信方式RPC-vs-REST\"><a href=\"#六、微服务通信方式RPC-vs-REST\" class=\"headerlink\" title=\"六、微服务通信方式RPC vs REST\"></a>六、微服务通信方式RPC vs REST</h2><table>\n<thead>\n<tr>\n<th></th>\n<th>RPC</th>\n<th>REST</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>耦合性</td>\n<td>强耦合</td>\n<td>松散耦合</td>\n</tr>\n<tr>\n<td>消息协议</td>\n<td>二进制、thrift、protobuf</td>\n<td>文本XML、JSON</td>\n</tr>\n<tr>\n<td>通信协议</td>\n<td>TCP</td>\n<td>HTTP／HTTP2</td>\n</tr>\n<tr>\n<td>性能</td>\n<td>高</td>\n<td>一般低于RPC</td>\n</tr>\n<tr>\n<td>接口契约</td>\n<td>thrift、protobuf</td>\n<td>swagger、openAPI</td>\n</tr>\n<tr>\n<td>客户端</td>\n<td>强类型客户端、一般通过工具自动生成</td>\n<td>普通http请求客户端即可</td>\n</tr>\n<tr>\n<td>案例</td>\n<td>Dubbo、motan、Tars、grpc、thrift</td>\n<td>Jax-rs</td>\n</tr>\n<tr>\n<td>开发者友好</td>\n<td>客户端集成方便、二进制消息不可读</td>\n<td>文本消息可读</td>\n</tr>\n<tr>\n<td>对外开放</td>\n<td>一般需要转换成REST/文本协议</td>\n<td>直接可以对外开放</td>\n</tr>\n</tbody>\n</table>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一、引入微服务架构需要作出权衡\"><a href=\"#一、引入微服务架构需要作出权衡\" class=\"headerlink\" title=\"一、引入微服务架构需要作出权衡\"></a>一、引入微服务架构需要作出权衡</h2><p>微服务解决了传统<code>SOA</code>项目开发部署的效率问题，大大提升了产品的迭代速度。另一方面通过把需求合理的划分为单一小模块，针对不同业务场景可以采用不同的技术选型。</p>\n<p>微服务的优势已经被研究的很透彻，但是在实践的过程中需要作出权衡。在业务规模比较小的时候传统的单一代码库的开发效率远高于微服务。也就是说在项目初期，产品方向不明确，这个时候采用传统的单一代码库来开发是一个更好的选择。随着业务复杂度的上升，微服务模式的开发效率逐渐高于单体代码仓库。</p>\n<p><img src=\"/img/micro-vs-soa.jpeg\" alt=\"cat\"></p>\n<p>可以看到在项目前期<code>SOA</code>开发效率比较高，随着项目不断迭代，需求复杂度上升，到达某一零界点的时候微服务架构开发效率高于<code>SOA</code>模式这个时候微服务的优势才慢慢体现出来。</p>\n<h2 id=\"二、微服务架构与组织模块划分\"><a href=\"#二、微服务架构与组织模块划分\" class=\"headerlink\" title=\"二、微服务架构与组织模块划分\"></a>二、微服务架构与组织模块划分</h2><p>著名的<a href=\"https://en.wikipedia.org/wiki/Conway%27s_law\" target=\"_blank\" rel=\"noopener\">康威法则</a>为团队的组织关系与系统代码架构的划分给出了良好的建议：</p>\n<blockquote>\n<p>设计系统的组织，其产生的设计和架构等价于组织间的沟通结构。</p>\n</blockquote>\n<p>团队之间是松散的，而单一应用必须让不同团队协同开发测试部署，成本比较高。通过把项目合理划分到不同的团队，互不干扰，系统效率得到了提升。</p>\n<h2 id=\"三、微服务总体技术架构\"><a href=\"#三、微服务总体技术架构\" class=\"headerlink\" title=\"三、微服务总体技术架构\"></a>三、微服务总体技术架构</h2><p><img src=\"/img/微服务系统架构分层模型.png\" alt=\"microServices-Layers\"></p>\n<h2 id=\"四、微服务网关\"><a href=\"#四、微服务网关\" class=\"headerlink\" title=\"四、微服务网关\"></a>四、微服务网关</h2><p>网关作为微服务入口主要有以下几个功能：</p>\n<ol>\n<li>反向路由</li>\n<li>认证安全</li>\n<li>限流熔断</li>\n<li>日志监控</li>\n</ol>\n<p>常见的网关如<code>zuul</code>, 和基于<code>openResty</code>的<code>Kong</code>都有很好的支持。</p>\n<h2 id=\"五、微服务集中配置中心\"><a href=\"#五、微服务集中配置中心\" class=\"headerlink\" title=\"五、微服务集中配置中心\"></a>五、微服务集中配置中心</h2><p>随着微服务数量增多集中化配置会慢慢变成一个痛点，集中化配置主要有以下一些优点：</p>\n<ul>\n<li>可追溯</li>\n<li>响应快</li>\n<li>集中化管理</li>\n</ul>\n<p>常用的集中化配置实现方式：</p>\n<ol>\n<li>pull模式(定时拉取)</li>\n<li>push模式(配置更新推送)</li>\n</ol>\n<p>作为业界微服务的楷模<code>Netflix</code>开源了一个<a href=\"https://github.com/Netflix/archaius\" target=\"_blank\" rel=\"noopener\">archaius</a>专门负责配置管理。</p>\n<h2 id=\"六、微服务通信方式RPC-vs-REST\"><a href=\"#六、微服务通信方式RPC-vs-REST\" class=\"headerlink\" title=\"六、微服务通信方式RPC vs REST\"></a>六、微服务通信方式RPC vs REST</h2><table>\n<thead>\n<tr>\n<th></th>\n<th>RPC</th>\n<th>REST</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>耦合性</td>\n<td>强耦合</td>\n<td>松散耦合</td>\n</tr>\n<tr>\n<td>消息协议</td>\n<td>二进制、thrift、protobuf</td>\n<td>文本XML、JSON</td>\n</tr>\n<tr>\n<td>通信协议</td>\n<td>TCP</td>\n<td>HTTP／HTTP2</td>\n</tr>\n<tr>\n<td>性能</td>\n<td>高</td>\n<td>一般低于RPC</td>\n</tr>\n<tr>\n<td>接口契约</td>\n<td>thrift、protobuf</td>\n<td>swagger、openAPI</td>\n</tr>\n<tr>\n<td>客户端</td>\n<td>强类型客户端、一般通过工具自动生成</td>\n<td>普通http请求客户端即可</td>\n</tr>\n<tr>\n<td>案例</td>\n<td>Dubbo、motan、Tars、grpc、thrift</td>\n<td>Jax-rs</td>\n</tr>\n<tr>\n<td>开发者友好</td>\n<td>客户端集成方便、二进制消息不可读</td>\n<td>文本消息可读</td>\n</tr>\n<tr>\n<td>对外开放</td>\n<td>一般需要转换成REST/文本协议</td>\n<td>直接可以对外开放</td>\n</tr>\n</tbody>\n</table>\n"},{"title":"数字货币-什么值得挖?","date":"2018-11-08T03:44:38.000Z","_content":"\n现在我们正处于数字货币泛滥的时期，随着一些山寨币的热度的下降，无数的矿工相信都被套牢了：）。当前数字货币市场波动比较大，特别是一些山寨币。矿主为了使得收益最大化，选择适合当前设备的数字货币是关键（这里抛开定制矿机，定制矿机在出厂的时候已经固定了能挖的数字货币种类）。这里主要讨论`GPU`挖矿的场景。\n\n目前市场上常见的`GPU`种类有如下几种：\n\n```shell\n  RX470\n  RX480\n  RX570\n  RX580\n  GTX750\n  GTX750Ti\n  GTX950\n  GTX960 \n  GTX965 \n  GTX970 \n  GTX980\n  GTX980Ti\n  GTX1060_6G\n  GTX1070\n  GTX1080\n  GTX1080Ti\n```\n\n每种型号的`GPU`对应每种数字货币的算法是固定的，比如说对于`RX470`而言其算法如下：\n\n```json\n{\n  \"device\": \"RX470\",\n  \"type\": \"GPU\",\n  \"price\": \"1500\",\n  \"Ethash_h\": \"27500000\",\n  \"Ethash_p\": \"120\",\n  \"Groestl_h\": \"14500000\",\n  \"Groestl_p\": \"120\",\n  \"X11Gost_h\": \"5300000\",\n  \"X11Gost_p\": \"125\",\n  \"CryptoNight_h\": \"660\",\n  \"CryptoNight_p\": \"100\",\n  \"CryptoNightV7_h\": \"660\",\n  \"CryptoNightV7_p\": \"100\",\n  \"Equihash_h\": \"260\",\n  \"Equihash_p\": \"110\",\n  \"Lyra2REv2_h\": \"4400000\",\n  \"Lyra2REv2_p\": \"120\",\n  \"NeoScrypt_h\": \"600000\",\n  \"NeoScrypt_p\": \"140\",\n  \"LBRY_h\": \"80000000\",\n  \"LBRY_p\": \"120\",\n  \"Blake(2b)_h\": \"800000000\",\n  \"Blake(2b)_p\": \"120\",\n  \"Blake(14r)_h\": \"1100000000\",\n  \"Blake(14r)_p\": \"120\",\n  \"Pascal_h\": \"510000000\",\n  \"Pascal_p\": \"120\",\n  \"Skunkhash_h\": \"15000000\",\n  \"Skunkhash_p\": \"105\",\n  \"Myriad-Groestl_h\": \"21315000\",\n  \"Myriad-Groestl_p\": \"120\"\n}\n```\n\n通过这个对照表，我们可以知道当前设备对应每一种挖矿算法的算力值(hashrate)。而每一种数字货币都有固定的挖矿算法，比如，`ETH`的挖矿算法是`Ethash`。这样一来就把设备和数字货币挂钩了。\n\n接下来我们还需要知道当前数字货币的行情数据，这样才能计算出挖哪一个币比较划算。\n\n```json\n{\n  \"tag\": \"ETH\",\n  \"algorithm\": \"Ethash\",\n  \"block_time\": \"14.1923\",\n  \"block_reward\": 2.91,\n  \"block_reward24\": 2.91000000000003,\n  \"last_block\": 6311414,\n  \"difficulty\": 3289197384217730,\n  \"difficulty24\": 3251946013832730,\n  \"nethash\": 231759290898425,\n  \"exchange_rate\": 0.030679,\n  \"exchange_rate24\": 0.030857829846583,\n  \"exchange_rate_vol\": 9535.24681118,\n  \"exchange_rate_curr\": \"BTC\",\n  \"market_cap\": \"$19,833,206,007.40\",\n  \"estimated_rewards\": \"0.00676\",\n  \"estimated_rewards24\": \"0.00684\",\n  \"btc_revenue\": \"0.00020754\",\n  \"btc_revenue24\": \"0.00020992\",\n  \"profitability\": 100,\n  \"profitability24\": 100,\n  \"lagging\": false,\n  \"timestamp\": 1536659576\n}\n```\n\n通过这个对照表的基本信息，结合上面的算力对照表，我们可以计算出，当前设备挖取该数字货币的收益, 具体算法如下：\n\n```javascript\n  //根据出块时间，计算全网24小时出块的个数\n  const awardDay = coin.blockReward / coin.blockTime * 3600 * 24\n  //根据当前设备的算力、全网算力，计算当前设备获得币的数量\n  const myAwardDay = (awardDay * hashRateDict[coin.algorithm] / coin.nethash) || 0\n  coin.hashRate = hashRateDict[coin.algorithm]\n  coin.mining_coin = myAwardDay\n  //根据当前币相对于BTC的交换率，计算得到的BTC个数\n  coin.mining_btc = myAwardDay * (coin.tag === \"BTC\" ? 1 : coin.exchangeRate24)\n  //根据BTC个数以及BTC价格计算收益\n  coin.mining_cny = coin.mining_btc * BTCPrice\n```\n\n一个完整的流程图：\n\n![smzdw](/img/smzdw.png)\n\n参考资料：\n\n[什么值得挖](https://www.smzdw.org)","source":"_posts/数字货币-什么值得挖.md","raw":"---\ntitle: 数字货币-什么值得挖?\ndate: 2018-11-08 11:44:38\ntags:\ncategories:\n---\n\n现在我们正处于数字货币泛滥的时期，随着一些山寨币的热度的下降，无数的矿工相信都被套牢了：）。当前数字货币市场波动比较大，特别是一些山寨币。矿主为了使得收益最大化，选择适合当前设备的数字货币是关键（这里抛开定制矿机，定制矿机在出厂的时候已经固定了能挖的数字货币种类）。这里主要讨论`GPU`挖矿的场景。\n\n目前市场上常见的`GPU`种类有如下几种：\n\n```shell\n  RX470\n  RX480\n  RX570\n  RX580\n  GTX750\n  GTX750Ti\n  GTX950\n  GTX960 \n  GTX965 \n  GTX970 \n  GTX980\n  GTX980Ti\n  GTX1060_6G\n  GTX1070\n  GTX1080\n  GTX1080Ti\n```\n\n每种型号的`GPU`对应每种数字货币的算法是固定的，比如说对于`RX470`而言其算法如下：\n\n```json\n{\n  \"device\": \"RX470\",\n  \"type\": \"GPU\",\n  \"price\": \"1500\",\n  \"Ethash_h\": \"27500000\",\n  \"Ethash_p\": \"120\",\n  \"Groestl_h\": \"14500000\",\n  \"Groestl_p\": \"120\",\n  \"X11Gost_h\": \"5300000\",\n  \"X11Gost_p\": \"125\",\n  \"CryptoNight_h\": \"660\",\n  \"CryptoNight_p\": \"100\",\n  \"CryptoNightV7_h\": \"660\",\n  \"CryptoNightV7_p\": \"100\",\n  \"Equihash_h\": \"260\",\n  \"Equihash_p\": \"110\",\n  \"Lyra2REv2_h\": \"4400000\",\n  \"Lyra2REv2_p\": \"120\",\n  \"NeoScrypt_h\": \"600000\",\n  \"NeoScrypt_p\": \"140\",\n  \"LBRY_h\": \"80000000\",\n  \"LBRY_p\": \"120\",\n  \"Blake(2b)_h\": \"800000000\",\n  \"Blake(2b)_p\": \"120\",\n  \"Blake(14r)_h\": \"1100000000\",\n  \"Blake(14r)_p\": \"120\",\n  \"Pascal_h\": \"510000000\",\n  \"Pascal_p\": \"120\",\n  \"Skunkhash_h\": \"15000000\",\n  \"Skunkhash_p\": \"105\",\n  \"Myriad-Groestl_h\": \"21315000\",\n  \"Myriad-Groestl_p\": \"120\"\n}\n```\n\n通过这个对照表，我们可以知道当前设备对应每一种挖矿算法的算力值(hashrate)。而每一种数字货币都有固定的挖矿算法，比如，`ETH`的挖矿算法是`Ethash`。这样一来就把设备和数字货币挂钩了。\n\n接下来我们还需要知道当前数字货币的行情数据，这样才能计算出挖哪一个币比较划算。\n\n```json\n{\n  \"tag\": \"ETH\",\n  \"algorithm\": \"Ethash\",\n  \"block_time\": \"14.1923\",\n  \"block_reward\": 2.91,\n  \"block_reward24\": 2.91000000000003,\n  \"last_block\": 6311414,\n  \"difficulty\": 3289197384217730,\n  \"difficulty24\": 3251946013832730,\n  \"nethash\": 231759290898425,\n  \"exchange_rate\": 0.030679,\n  \"exchange_rate24\": 0.030857829846583,\n  \"exchange_rate_vol\": 9535.24681118,\n  \"exchange_rate_curr\": \"BTC\",\n  \"market_cap\": \"$19,833,206,007.40\",\n  \"estimated_rewards\": \"0.00676\",\n  \"estimated_rewards24\": \"0.00684\",\n  \"btc_revenue\": \"0.00020754\",\n  \"btc_revenue24\": \"0.00020992\",\n  \"profitability\": 100,\n  \"profitability24\": 100,\n  \"lagging\": false,\n  \"timestamp\": 1536659576\n}\n```\n\n通过这个对照表的基本信息，结合上面的算力对照表，我们可以计算出，当前设备挖取该数字货币的收益, 具体算法如下：\n\n```javascript\n  //根据出块时间，计算全网24小时出块的个数\n  const awardDay = coin.blockReward / coin.blockTime * 3600 * 24\n  //根据当前设备的算力、全网算力，计算当前设备获得币的数量\n  const myAwardDay = (awardDay * hashRateDict[coin.algorithm] / coin.nethash) || 0\n  coin.hashRate = hashRateDict[coin.algorithm]\n  coin.mining_coin = myAwardDay\n  //根据当前币相对于BTC的交换率，计算得到的BTC个数\n  coin.mining_btc = myAwardDay * (coin.tag === \"BTC\" ? 1 : coin.exchangeRate24)\n  //根据BTC个数以及BTC价格计算收益\n  coin.mining_cny = coin.mining_btc * BTCPrice\n```\n\n一个完整的流程图：\n\n![smzdw](/img/smzdw.png)\n\n参考资料：\n\n[什么值得挖](https://www.smzdw.org)","slug":"数字货币-什么值得挖","published":1,"updated":"2018-11-08T05:39:00.249Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9ceg004sy4zvttqn8b06","content":"<p>现在我们正处于数字货币泛滥的时期，随着一些山寨币的热度的下降，无数的矿工相信都被套牢了：）。当前数字货币市场波动比较大，特别是一些山寨币。矿主为了使得收益最大化，选择适合当前设备的数字货币是关键（这里抛开定制矿机，定制矿机在出厂的时候已经固定了能挖的数字货币种类）。这里主要讨论<code>GPU</code>挖矿的场景。</p>\n<p>目前市场上常见的<code>GPU</code>种类有如下几种：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">RX470</span><br><span class=\"line\">RX480</span><br><span class=\"line\">RX570</span><br><span class=\"line\">RX580</span><br><span class=\"line\">GTX750</span><br><span class=\"line\">GTX750Ti</span><br><span class=\"line\">GTX950</span><br><span class=\"line\">GTX960 </span><br><span class=\"line\">GTX965 </span><br><span class=\"line\">GTX970 </span><br><span class=\"line\">GTX980</span><br><span class=\"line\">GTX980Ti</span><br><span class=\"line\">GTX1060_6G</span><br><span class=\"line\">GTX1070</span><br><span class=\"line\">GTX1080</span><br><span class=\"line\">GTX1080Ti</span><br></pre></td></tr></table></figure>\n<p>每种型号的<code>GPU</code>对应每种数字货币的算法是固定的，比如说对于<code>RX470</code>而言其算法如下：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">\"device\"</span>: <span class=\"string\">\"RX470\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"type\"</span>: <span class=\"string\">\"GPU\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"price\"</span>: <span class=\"string\">\"1500\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"Ethash_h\"</span>: <span class=\"string\">\"27500000\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"Ethash_p\"</span>: <span class=\"string\">\"120\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"Groestl_h\"</span>: <span class=\"string\">\"14500000\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"Groestl_p\"</span>: <span class=\"string\">\"120\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"X11Gost_h\"</span>: <span class=\"string\">\"5300000\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"X11Gost_p\"</span>: <span class=\"string\">\"125\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"CryptoNight_h\"</span>: <span class=\"string\">\"660\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"CryptoNight_p\"</span>: <span class=\"string\">\"100\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"CryptoNightV7_h\"</span>: <span class=\"string\">\"660\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"CryptoNightV7_p\"</span>: <span class=\"string\">\"100\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"Equihash_h\"</span>: <span class=\"string\">\"260\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"Equihash_p\"</span>: <span class=\"string\">\"110\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"Lyra2REv2_h\"</span>: <span class=\"string\">\"4400000\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"Lyra2REv2_p\"</span>: <span class=\"string\">\"120\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"NeoScrypt_h\"</span>: <span class=\"string\">\"600000\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"NeoScrypt_p\"</span>: <span class=\"string\">\"140\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"LBRY_h\"</span>: <span class=\"string\">\"80000000\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"LBRY_p\"</span>: <span class=\"string\">\"120\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"Blake(2b)_h\"</span>: <span class=\"string\">\"800000000\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"Blake(2b)_p\"</span>: <span class=\"string\">\"120\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"Blake(14r)_h\"</span>: <span class=\"string\">\"1100000000\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"Blake(14r)_p\"</span>: <span class=\"string\">\"120\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"Pascal_h\"</span>: <span class=\"string\">\"510000000\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"Pascal_p\"</span>: <span class=\"string\">\"120\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"Skunkhash_h\"</span>: <span class=\"string\">\"15000000\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"Skunkhash_p\"</span>: <span class=\"string\">\"105\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"Myriad-Groestl_h\"</span>: <span class=\"string\">\"21315000\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"Myriad-Groestl_p\"</span>: <span class=\"string\">\"120\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>通过这个对照表，我们可以知道当前设备对应每一种挖矿算法的算力值(hashrate)。而每一种数字货币都有固定的挖矿算法，比如，<code>ETH</code>的挖矿算法是<code>Ethash</code>。这样一来就把设备和数字货币挂钩了。</p>\n<p>接下来我们还需要知道当前数字货币的行情数据，这样才能计算出挖哪一个币比较划算。</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">\"tag\"</span>: <span class=\"string\">\"ETH\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"algorithm\"</span>: <span class=\"string\">\"Ethash\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"block_time\"</span>: <span class=\"string\">\"14.1923\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"block_reward\"</span>: <span class=\"number\">2.91</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"block_reward24\"</span>: <span class=\"number\">2.91000000000003</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"last_block\"</span>: <span class=\"number\">6311414</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"difficulty\"</span>: <span class=\"number\">3289197384217730</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"difficulty24\"</span>: <span class=\"number\">3251946013832730</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"nethash\"</span>: <span class=\"number\">231759290898425</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"exchange_rate\"</span>: <span class=\"number\">0.030679</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"exchange_rate24\"</span>: <span class=\"number\">0.030857829846583</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"exchange_rate_vol\"</span>: <span class=\"number\">9535.24681118</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"exchange_rate_curr\"</span>: <span class=\"string\">\"BTC\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"market_cap\"</span>: <span class=\"string\">\"$19,833,206,007.40\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"estimated_rewards\"</span>: <span class=\"string\">\"0.00676\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"estimated_rewards24\"</span>: <span class=\"string\">\"0.00684\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"btc_revenue\"</span>: <span class=\"string\">\"0.00020754\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"btc_revenue24\"</span>: <span class=\"string\">\"0.00020992\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"profitability\"</span>: <span class=\"number\">100</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"profitability24\"</span>: <span class=\"number\">100</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"lagging\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"timestamp\"</span>: <span class=\"number\">1536659576</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>通过这个对照表的基本信息，结合上面的算力对照表，我们可以计算出，当前设备挖取该数字货币的收益, 具体算法如下：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//根据出块时间，计算全网24小时出块的个数</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> awardDay = coin.blockReward / coin.blockTime * <span class=\"number\">3600</span> * <span class=\"number\">24</span></span><br><span class=\"line\"><span class=\"comment\">//根据当前设备的算力、全网算力，计算当前设备获得币的数量</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> myAwardDay = (awardDay * hashRateDict[coin.algorithm] / coin.nethash) || <span class=\"number\">0</span></span><br><span class=\"line\">coin.hashRate = hashRateDict[coin.algorithm]</span><br><span class=\"line\">coin.mining_coin = myAwardDay</span><br><span class=\"line\"><span class=\"comment\">//根据当前币相对于BTC的交换率，计算得到的BTC个数</span></span><br><span class=\"line\">coin.mining_btc = myAwardDay * (coin.tag === <span class=\"string\">\"BTC\"</span> ? <span class=\"number\">1</span> : coin.exchangeRate24)</span><br><span class=\"line\"><span class=\"comment\">//根据BTC个数以及BTC价格计算收益</span></span><br><span class=\"line\">coin.mining_cny = coin.mining_btc * BTCPrice</span><br></pre></td></tr></table></figure>\n<p>一个完整的流程图：</p>\n<p><img src=\"/img/smzdw.png\" alt=\"smzdw\"></p>\n<p>参考资料：</p>\n<p><a href=\"https://www.smzdw.org\" target=\"_blank\" rel=\"noopener\">什么值得挖</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p>现在我们正处于数字货币泛滥的时期，随着一些山寨币的热度的下降，无数的矿工相信都被套牢了：）。当前数字货币市场波动比较大，特别是一些山寨币。矿主为了使得收益最大化，选择适合当前设备的数字货币是关键（这里抛开定制矿机，定制矿机在出厂的时候已经固定了能挖的数字货币种类）。这里主要讨论<code>GPU</code>挖矿的场景。</p>\n<p>目前市场上常见的<code>GPU</code>种类有如下几种：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">RX470</span><br><span class=\"line\">RX480</span><br><span class=\"line\">RX570</span><br><span class=\"line\">RX580</span><br><span class=\"line\">GTX750</span><br><span class=\"line\">GTX750Ti</span><br><span class=\"line\">GTX950</span><br><span class=\"line\">GTX960 </span><br><span class=\"line\">GTX965 </span><br><span class=\"line\">GTX970 </span><br><span class=\"line\">GTX980</span><br><span class=\"line\">GTX980Ti</span><br><span class=\"line\">GTX1060_6G</span><br><span class=\"line\">GTX1070</span><br><span class=\"line\">GTX1080</span><br><span class=\"line\">GTX1080Ti</span><br></pre></td></tr></table></figure>\n<p>每种型号的<code>GPU</code>对应每种数字货币的算法是固定的，比如说对于<code>RX470</code>而言其算法如下：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">\"device\"</span>: <span class=\"string\">\"RX470\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"type\"</span>: <span class=\"string\">\"GPU\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"price\"</span>: <span class=\"string\">\"1500\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"Ethash_h\"</span>: <span class=\"string\">\"27500000\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"Ethash_p\"</span>: <span class=\"string\">\"120\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"Groestl_h\"</span>: <span class=\"string\">\"14500000\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"Groestl_p\"</span>: <span class=\"string\">\"120\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"X11Gost_h\"</span>: <span class=\"string\">\"5300000\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"X11Gost_p\"</span>: <span class=\"string\">\"125\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"CryptoNight_h\"</span>: <span class=\"string\">\"660\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"CryptoNight_p\"</span>: <span class=\"string\">\"100\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"CryptoNightV7_h\"</span>: <span class=\"string\">\"660\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"CryptoNightV7_p\"</span>: <span class=\"string\">\"100\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"Equihash_h\"</span>: <span class=\"string\">\"260\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"Equihash_p\"</span>: <span class=\"string\">\"110\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"Lyra2REv2_h\"</span>: <span class=\"string\">\"4400000\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"Lyra2REv2_p\"</span>: <span class=\"string\">\"120\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"NeoScrypt_h\"</span>: <span class=\"string\">\"600000\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"NeoScrypt_p\"</span>: <span class=\"string\">\"140\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"LBRY_h\"</span>: <span class=\"string\">\"80000000\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"LBRY_p\"</span>: <span class=\"string\">\"120\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"Blake(2b)_h\"</span>: <span class=\"string\">\"800000000\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"Blake(2b)_p\"</span>: <span class=\"string\">\"120\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"Blake(14r)_h\"</span>: <span class=\"string\">\"1100000000\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"Blake(14r)_p\"</span>: <span class=\"string\">\"120\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"Pascal_h\"</span>: <span class=\"string\">\"510000000\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"Pascal_p\"</span>: <span class=\"string\">\"120\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"Skunkhash_h\"</span>: <span class=\"string\">\"15000000\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"Skunkhash_p\"</span>: <span class=\"string\">\"105\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"Myriad-Groestl_h\"</span>: <span class=\"string\">\"21315000\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"Myriad-Groestl_p\"</span>: <span class=\"string\">\"120\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>通过这个对照表，我们可以知道当前设备对应每一种挖矿算法的算力值(hashrate)。而每一种数字货币都有固定的挖矿算法，比如，<code>ETH</code>的挖矿算法是<code>Ethash</code>。这样一来就把设备和数字货币挂钩了。</p>\n<p>接下来我们还需要知道当前数字货币的行情数据，这样才能计算出挖哪一个币比较划算。</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">\"tag\"</span>: <span class=\"string\">\"ETH\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"algorithm\"</span>: <span class=\"string\">\"Ethash\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"block_time\"</span>: <span class=\"string\">\"14.1923\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"block_reward\"</span>: <span class=\"number\">2.91</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"block_reward24\"</span>: <span class=\"number\">2.91000000000003</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"last_block\"</span>: <span class=\"number\">6311414</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"difficulty\"</span>: <span class=\"number\">3289197384217730</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"difficulty24\"</span>: <span class=\"number\">3251946013832730</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"nethash\"</span>: <span class=\"number\">231759290898425</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"exchange_rate\"</span>: <span class=\"number\">0.030679</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"exchange_rate24\"</span>: <span class=\"number\">0.030857829846583</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"exchange_rate_vol\"</span>: <span class=\"number\">9535.24681118</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"exchange_rate_curr\"</span>: <span class=\"string\">\"BTC\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"market_cap\"</span>: <span class=\"string\">\"$19,833,206,007.40\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"estimated_rewards\"</span>: <span class=\"string\">\"0.00676\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"estimated_rewards24\"</span>: <span class=\"string\">\"0.00684\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"btc_revenue\"</span>: <span class=\"string\">\"0.00020754\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"btc_revenue24\"</span>: <span class=\"string\">\"0.00020992\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"profitability\"</span>: <span class=\"number\">100</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"profitability24\"</span>: <span class=\"number\">100</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"lagging\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"timestamp\"</span>: <span class=\"number\">1536659576</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>通过这个对照表的基本信息，结合上面的算力对照表，我们可以计算出，当前设备挖取该数字货币的收益, 具体算法如下：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//根据出块时间，计算全网24小时出块的个数</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> awardDay = coin.blockReward / coin.blockTime * <span class=\"number\">3600</span> * <span class=\"number\">24</span></span><br><span class=\"line\"><span class=\"comment\">//根据当前设备的算力、全网算力，计算当前设备获得币的数量</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> myAwardDay = (awardDay * hashRateDict[coin.algorithm] / coin.nethash) || <span class=\"number\">0</span></span><br><span class=\"line\">coin.hashRate = hashRateDict[coin.algorithm]</span><br><span class=\"line\">coin.mining_coin = myAwardDay</span><br><span class=\"line\"><span class=\"comment\">//根据当前币相对于BTC的交换率，计算得到的BTC个数</span></span><br><span class=\"line\">coin.mining_btc = myAwardDay * (coin.tag === <span class=\"string\">\"BTC\"</span> ? <span class=\"number\">1</span> : coin.exchangeRate24)</span><br><span class=\"line\"><span class=\"comment\">//根据BTC个数以及BTC价格计算收益</span></span><br><span class=\"line\">coin.mining_cny = coin.mining_btc * BTCPrice</span><br></pre></td></tr></table></figure>\n<p>一个完整的流程图：</p>\n<p><img src=\"/img/smzdw.png\" alt=\"smzdw\"></p>\n<p>参考资料：</p>\n<p><a href=\"https://www.smzdw.org\" target=\"_blank\" rel=\"noopener\">什么值得挖</a></p>\n"},{"title":"数据库设计基础","date":"2018-10-19T07:49:54.000Z","_content":"\n### 需求分析\n\n#### 数据库设计简介\n\n#### 数据库设计步骤\n\n+ 需求分析\n    + 了解需要存储的数据\n    + 了解存储的数据的特点(实效性,增长过快需要分库分表)\n    + 了解数据的生命周期(归档、清理规则)\n\n+ 要搞清楚的问题：\n    + 实体之间的关系（1对1，1对多，多对多）\n    + 实体包含的属性有什么\n    + 有哪些属性或属性的组合可以唯一标识一个实体\n\n+ 逻辑分析\n    >使用ER图建模\n \n+ 物理设计\n    >考虑数据库的特点，把逻辑设计转化为物理设计。\n\n+ 维护优化\n    + 新需求建表\n    + 索引优化\n    + 大表拆分\n   \n---\n\n### 逻辑设计\n\n+ 将需求转化为数据库的逻辑模型\n+ 通过ER图的形式对逻辑模型进行展示\n+ 和具体的DBMS无关\n\n#### ER图\n常见的概念：\n\n关系：一个关系对应通常所说的一张表  \n元组：表中的一行即为一个元组  \n属性：表中的一列称之为一个属性；每一个属性都有一个名称，称之为属性名  \n候选码：表中的某个属性组，它可以唯一确定一个元组（唯一索引、主键）  \n主码：主键  \n域：属性的取值范围  \n分量：元组中的一个属性值  \n\n\n#### 数据库设计概要\n\n>数据库范式用于减少数据冗余，减少数据插入更新异常。\n\n#### 数据库设计范式\n\n+ 第一范式：\n> 数据库中所有的字段都是不可分割的单一属性，字段的数据类型都是基本数据类型,如：整形、字符串、浮点数等。\n\n+ 第二范式：\n> 数据库表中不能存在组合关键字的某一字段决定非关键字段的情况。所以第二范式只针对于有组合关键字的情况。\n\n+ 第三范式：\n> 数据库表中不存在非关键字段对任意候选关键字段的传递函数依赖则符合第三范式。\n\n+ BC范式：\n> 数据库表中不存在任何字段对任意候选关键字段的传递函数依赖则符合BC范式。\n\n---\n\n### 物理设计\n\n1. 选择合适的数据库管理系统\n2. 定义数据库、表以及字段的命名规范\n3. 根据所选的DBMS系统选择合适的字段数据类型\n4. 反范式化设计（考虑效率：空间时间等）\n\n#### DBMS选型\n\n+ 版权考量\n    商业数据库：\n    + Oracle\n    + SQLServer\n\n    开源数据库：\n    + MySQL\n    + PgSQL\n\n+ 功能上\n    + 事物的支持\n    + 特殊数据类型的支持\n    + ...\n\n+ 操作系统\n    Windows系统\n    + SQLServer\n\n    Windows/类Linux\n    + SQLServer\n    + MySQL\n    + PgSQL\n\n+ 开发语言\n    .Net首选SQLServer\n    \n+ 使用场景\n    互联网项目\n    + MySQL\n    + PgSQL\n\n    企业级项目\n    + Oracle\n    + SQLServer\n\n\n#### MySQL常用存储引擎\n\n\n| 存储引擎 | 事务支持 | 锁的粒度 | 主要应用 | 忌用 |\n| --- | --- | --- | --- | --- |\n| MyISAM | 不支持 | 表级锁 | insert,select | 读写频繁 |\n| MRG_MYISAM | 不支持 | 表级锁 | 分段归档 | 全局查找过多的场景 |\n| InnoDB | 支持 | 行级锁 | 事务 | 无 |\n| Archive | 不支持 | 行级锁 | 日志记录，只支持insert,select | 需要随机读取，更新，删除  |\n| Ndb Cluster | 支持 | 行级锁 | 高可用 | 大部分应用 |\n\n\n#### 数据库、表以及字段的命名规范\n\n+ 数据库名、表名、字段名的命名规范\n\n    1. 数据库名/表名在Windows/Mac上大小写不敏感，在其他类Unix系统上大小写敏感\n    2. 字段名/索引名在所有系统上都是大小写不敏感(除非加了双引号)\n    3. 定义的时候要望文生义\n\n\n#### 数据库字段类型的选择原则\n\n字段数据类型的选择原则：\n\n1. 存储开销\n\n2. 查询性能: 对数据进行比较操作时，同样的数据，字符处理往往比数字慢。\n\n3. 当一个列可以选择多个数据类型时，优先选择数字类型，其次是日期或二进制类型\n\n4. 同级别的数据类型，应该优先选择占用空间小的数据类型。\n\n5. 数据库数据处理以页为单位(MySQL18k每页)，列的长度越小，一次加载数据约多，数据库IO性能会有所提升\n\n#### 数据库如何具体选择字段类型\n\n+ char和varchar\n    1. 如果列中要存储的数据长度差不多是一致的，则应该考虑用char，否则应该考虑用varchar。\n    2. 如果列中最大数据长度小于50Byte，则一般也考虑用char。\n    3. 一般不宜定义大于50Byte的char类型列。\n\n+ decimal和float\n\n    1. decimal(numeric)用于存储精确数据，而float只能用于存储非精确数据。\n    2. float开销一般比decimal小，所以非精确数据一般选择float\n\n+ 时间类型\n\n    1. 用int存储的优缺点\n    优点：字段长度比datetime小。\n    缺点：使用不方便，要进行函数转换。\n    限制：由于int类型占用4个字节，最多只能存储到2038-1-19\n    \n    2. 需要存储的时间粒度\n    年 月 日 小时 分 秒 周\n    \n    \n#### 数据库设计其它注意事项\n\n   + 如何选择主键\n       1. 区分业务主键和数据库主键\n           1. 业务主键用于标示业务（有可能会更改）\n           2. 数据库主键为了优化数据存储（避免业务的变更带来的影响）\n\n       2. 根据数据库的类型，考虑主键是否需要顺序增长\n       3. 主键的字段类型所占用的空间要尽可能小（提高IO效率）\n\n\n   + 避免使用外键\n       1. 降低数据倒入导入的效率\n       2. 增加维护成本\n       3. 虽然不建议使用外键约束，但是相关联的列上一定要建立索引\n\n\n   + 避免使用触发器\n\n   + 关于预留字段\n       1. 无法准确知道预留字段的类型\n       2. 无法准确知道预留字段中存储的内容\n       3. 后期维护预留字段的成本和增加一个新的字段所需要的成本是相同的\n       4. 严禁使用预留字段\n\n#### 反范式化\n\n   通过一定数据的冗余，空间换取时间的操作，违反数据库的第三范式。提高读取性能。要点：\n   + 减少表的关联数量\n   + 增加数据的读取效率\n   + 反范式化要适度\n   \n   \n---\n\n### 数据库维护\n\n#### 如何维护数据字典\n\n+ 利用第三方工具\n+ 利用`COMMENT`属性，并通过`information_shema`查询数据字段信息\n\n#### 维护索引\n\n如何选择合适的列建立索引：\n\n+ 出现在WHERE从句,GROUP BY从句, ORDER BY从句中的列\n+ 可选择性高的列要放到索引的前面\n+ 索引中不要包含太长的数据类型\n    + Mysql支持对TEXT类型前缀进行索引\n    + 对长类型进行MD5然后索引\n    + 太长影响IO效率(16k/page)问题\n\n注意事项：\n   + 索引不是越多越好，过多的索引不但会降低写的效率(维护索引数据结构),还会影响读的效率(影响索引优化器)。\n   + 定期维护索引碎片\n   + 在SQL中不要使用强制索引关键字\n\n#### 数据库中适合的操作\n\n如何维护表的结构\n   + 使用在线变更表结构根据\n        + MySQL5.5之前可以使用pt-online-schema-change(通过临时表)\n        + MySQL5.6之后本身支持在线表结构的变更(ALTER语句)\n   + 同时对数据字典进行维护\n   + 控制表的宽度和大小\n   \n适合的操作：\n   + 批量操作vs逐条操作\n   + 禁止使用Select * 这样的查询\n   + 控制使用用户自定义函数\n   + 不要使用数据库中的全文索引\n\n#### 在适当的时候进行表的水平和垂直拆分\n\n表的垂直拆分\n   >为了控制表的宽度，可以进行垂直拆分。提高每一页存储的行数。从而提高IO效率。\n\n+ 经常一起查询的列放到一起\n+ text、blob等大字段拆分到附加表中\n\n表的水平拆分\n   >为了控制表的大小(数据量)，可以进行表的水平拆分。把大表数据平均分到小表中。\n\n方法：\n+ 对主键进行hash取模,把大表数据平均分配到小表中。\n","source":"_posts/数据库设计.md","raw":"---\ntitle: 数据库设计基础\ndate: 2018-10-19 15:49:54\ntags: \ncategories: 数据库\n---\n\n### 需求分析\n\n#### 数据库设计简介\n\n#### 数据库设计步骤\n\n+ 需求分析\n    + 了解需要存储的数据\n    + 了解存储的数据的特点(实效性,增长过快需要分库分表)\n    + 了解数据的生命周期(归档、清理规则)\n\n+ 要搞清楚的问题：\n    + 实体之间的关系（1对1，1对多，多对多）\n    + 实体包含的属性有什么\n    + 有哪些属性或属性的组合可以唯一标识一个实体\n\n+ 逻辑分析\n    >使用ER图建模\n \n+ 物理设计\n    >考虑数据库的特点，把逻辑设计转化为物理设计。\n\n+ 维护优化\n    + 新需求建表\n    + 索引优化\n    + 大表拆分\n   \n---\n\n### 逻辑设计\n\n+ 将需求转化为数据库的逻辑模型\n+ 通过ER图的形式对逻辑模型进行展示\n+ 和具体的DBMS无关\n\n#### ER图\n常见的概念：\n\n关系：一个关系对应通常所说的一张表  \n元组：表中的一行即为一个元组  \n属性：表中的一列称之为一个属性；每一个属性都有一个名称，称之为属性名  \n候选码：表中的某个属性组，它可以唯一确定一个元组（唯一索引、主键）  \n主码：主键  \n域：属性的取值范围  \n分量：元组中的一个属性值  \n\n\n#### 数据库设计概要\n\n>数据库范式用于减少数据冗余，减少数据插入更新异常。\n\n#### 数据库设计范式\n\n+ 第一范式：\n> 数据库中所有的字段都是不可分割的单一属性，字段的数据类型都是基本数据类型,如：整形、字符串、浮点数等。\n\n+ 第二范式：\n> 数据库表中不能存在组合关键字的某一字段决定非关键字段的情况。所以第二范式只针对于有组合关键字的情况。\n\n+ 第三范式：\n> 数据库表中不存在非关键字段对任意候选关键字段的传递函数依赖则符合第三范式。\n\n+ BC范式：\n> 数据库表中不存在任何字段对任意候选关键字段的传递函数依赖则符合BC范式。\n\n---\n\n### 物理设计\n\n1. 选择合适的数据库管理系统\n2. 定义数据库、表以及字段的命名规范\n3. 根据所选的DBMS系统选择合适的字段数据类型\n4. 反范式化设计（考虑效率：空间时间等）\n\n#### DBMS选型\n\n+ 版权考量\n    商业数据库：\n    + Oracle\n    + SQLServer\n\n    开源数据库：\n    + MySQL\n    + PgSQL\n\n+ 功能上\n    + 事物的支持\n    + 特殊数据类型的支持\n    + ...\n\n+ 操作系统\n    Windows系统\n    + SQLServer\n\n    Windows/类Linux\n    + SQLServer\n    + MySQL\n    + PgSQL\n\n+ 开发语言\n    .Net首选SQLServer\n    \n+ 使用场景\n    互联网项目\n    + MySQL\n    + PgSQL\n\n    企业级项目\n    + Oracle\n    + SQLServer\n\n\n#### MySQL常用存储引擎\n\n\n| 存储引擎 | 事务支持 | 锁的粒度 | 主要应用 | 忌用 |\n| --- | --- | --- | --- | --- |\n| MyISAM | 不支持 | 表级锁 | insert,select | 读写频繁 |\n| MRG_MYISAM | 不支持 | 表级锁 | 分段归档 | 全局查找过多的场景 |\n| InnoDB | 支持 | 行级锁 | 事务 | 无 |\n| Archive | 不支持 | 行级锁 | 日志记录，只支持insert,select | 需要随机读取，更新，删除  |\n| Ndb Cluster | 支持 | 行级锁 | 高可用 | 大部分应用 |\n\n\n#### 数据库、表以及字段的命名规范\n\n+ 数据库名、表名、字段名的命名规范\n\n    1. 数据库名/表名在Windows/Mac上大小写不敏感，在其他类Unix系统上大小写敏感\n    2. 字段名/索引名在所有系统上都是大小写不敏感(除非加了双引号)\n    3. 定义的时候要望文生义\n\n\n#### 数据库字段类型的选择原则\n\n字段数据类型的选择原则：\n\n1. 存储开销\n\n2. 查询性能: 对数据进行比较操作时，同样的数据，字符处理往往比数字慢。\n\n3. 当一个列可以选择多个数据类型时，优先选择数字类型，其次是日期或二进制类型\n\n4. 同级别的数据类型，应该优先选择占用空间小的数据类型。\n\n5. 数据库数据处理以页为单位(MySQL18k每页)，列的长度越小，一次加载数据约多，数据库IO性能会有所提升\n\n#### 数据库如何具体选择字段类型\n\n+ char和varchar\n    1. 如果列中要存储的数据长度差不多是一致的，则应该考虑用char，否则应该考虑用varchar。\n    2. 如果列中最大数据长度小于50Byte，则一般也考虑用char。\n    3. 一般不宜定义大于50Byte的char类型列。\n\n+ decimal和float\n\n    1. decimal(numeric)用于存储精确数据，而float只能用于存储非精确数据。\n    2. float开销一般比decimal小，所以非精确数据一般选择float\n\n+ 时间类型\n\n    1. 用int存储的优缺点\n    优点：字段长度比datetime小。\n    缺点：使用不方便，要进行函数转换。\n    限制：由于int类型占用4个字节，最多只能存储到2038-1-19\n    \n    2. 需要存储的时间粒度\n    年 月 日 小时 分 秒 周\n    \n    \n#### 数据库设计其它注意事项\n\n   + 如何选择主键\n       1. 区分业务主键和数据库主键\n           1. 业务主键用于标示业务（有可能会更改）\n           2. 数据库主键为了优化数据存储（避免业务的变更带来的影响）\n\n       2. 根据数据库的类型，考虑主键是否需要顺序增长\n       3. 主键的字段类型所占用的空间要尽可能小（提高IO效率）\n\n\n   + 避免使用外键\n       1. 降低数据倒入导入的效率\n       2. 增加维护成本\n       3. 虽然不建议使用外键约束，但是相关联的列上一定要建立索引\n\n\n   + 避免使用触发器\n\n   + 关于预留字段\n       1. 无法准确知道预留字段的类型\n       2. 无法准确知道预留字段中存储的内容\n       3. 后期维护预留字段的成本和增加一个新的字段所需要的成本是相同的\n       4. 严禁使用预留字段\n\n#### 反范式化\n\n   通过一定数据的冗余，空间换取时间的操作，违反数据库的第三范式。提高读取性能。要点：\n   + 减少表的关联数量\n   + 增加数据的读取效率\n   + 反范式化要适度\n   \n   \n---\n\n### 数据库维护\n\n#### 如何维护数据字典\n\n+ 利用第三方工具\n+ 利用`COMMENT`属性，并通过`information_shema`查询数据字段信息\n\n#### 维护索引\n\n如何选择合适的列建立索引：\n\n+ 出现在WHERE从句,GROUP BY从句, ORDER BY从句中的列\n+ 可选择性高的列要放到索引的前面\n+ 索引中不要包含太长的数据类型\n    + Mysql支持对TEXT类型前缀进行索引\n    + 对长类型进行MD5然后索引\n    + 太长影响IO效率(16k/page)问题\n\n注意事项：\n   + 索引不是越多越好，过多的索引不但会降低写的效率(维护索引数据结构),还会影响读的效率(影响索引优化器)。\n   + 定期维护索引碎片\n   + 在SQL中不要使用强制索引关键字\n\n#### 数据库中适合的操作\n\n如何维护表的结构\n   + 使用在线变更表结构根据\n        + MySQL5.5之前可以使用pt-online-schema-change(通过临时表)\n        + MySQL5.6之后本身支持在线表结构的变更(ALTER语句)\n   + 同时对数据字典进行维护\n   + 控制表的宽度和大小\n   \n适合的操作：\n   + 批量操作vs逐条操作\n   + 禁止使用Select * 这样的查询\n   + 控制使用用户自定义函数\n   + 不要使用数据库中的全文索引\n\n#### 在适当的时候进行表的水平和垂直拆分\n\n表的垂直拆分\n   >为了控制表的宽度，可以进行垂直拆分。提高每一页存储的行数。从而提高IO效率。\n\n+ 经常一起查询的列放到一起\n+ text、blob等大字段拆分到附加表中\n\n表的水平拆分\n   >为了控制表的大小(数据量)，可以进行表的水平拆分。把大表数据平均分到小表中。\n\n方法：\n+ 对主键进行hash取模,把大表数据平均分配到小表中。\n","slug":"数据库设计","published":1,"updated":"2018-10-19T10:32:03.859Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9ceh004vy4zvl4elksoz","content":"<h3 id=\"需求分析\"><a href=\"#需求分析\" class=\"headerlink\" title=\"需求分析\"></a>需求分析</h3><h4 id=\"数据库设计简介\"><a href=\"#数据库设计简介\" class=\"headerlink\" title=\"数据库设计简介\"></a>数据库设计简介</h4><h4 id=\"数据库设计步骤\"><a href=\"#数据库设计步骤\" class=\"headerlink\" title=\"数据库设计步骤\"></a>数据库设计步骤</h4><ul>\n<li><p>需求分析</p>\n<ul>\n<li>了解需要存储的数据</li>\n<li>了解存储的数据的特点(实效性,增长过快需要分库分表)</li>\n<li>了解数据的生命周期(归档、清理规则)</li>\n</ul>\n</li>\n<li><p>要搞清楚的问题：</p>\n<ul>\n<li>实体之间的关系（1对1，1对多，多对多）</li>\n<li>实体包含的属性有什么</li>\n<li>有哪些属性或属性的组合可以唯一标识一个实体</li>\n</ul>\n</li>\n<li><p>逻辑分析</p>\n<blockquote>\n<p>使用ER图建模</p>\n</blockquote>\n</li>\n<li><p>物理设计</p>\n<blockquote>\n<p>考虑数据库的特点，把逻辑设计转化为物理设计。</p>\n</blockquote>\n</li>\n<li><p>维护优化</p>\n<ul>\n<li>新需求建表</li>\n<li>索引优化</li>\n<li>大表拆分</li>\n</ul>\n</li>\n</ul>\n<hr>\n<h3 id=\"逻辑设计\"><a href=\"#逻辑设计\" class=\"headerlink\" title=\"逻辑设计\"></a>逻辑设计</h3><ul>\n<li>将需求转化为数据库的逻辑模型</li>\n<li>通过ER图的形式对逻辑模型进行展示</li>\n<li>和具体的DBMS无关</li>\n</ul>\n<h4 id=\"ER图\"><a href=\"#ER图\" class=\"headerlink\" title=\"ER图\"></a>ER图</h4><p>常见的概念：</p>\n<p>关系：一个关系对应通常所说的一张表<br>元组：表中的一行即为一个元组<br>属性：表中的一列称之为一个属性；每一个属性都有一个名称，称之为属性名<br>候选码：表中的某个属性组，它可以唯一确定一个元组（唯一索引、主键）<br>主码：主键<br>域：属性的取值范围<br>分量：元组中的一个属性值  </p>\n<h4 id=\"数据库设计概要\"><a href=\"#数据库设计概要\" class=\"headerlink\" title=\"数据库设计概要\"></a>数据库设计概要</h4><blockquote>\n<p>数据库范式用于减少数据冗余，减少数据插入更新异常。</p>\n</blockquote>\n<h4 id=\"数据库设计范式\"><a href=\"#数据库设计范式\" class=\"headerlink\" title=\"数据库设计范式\"></a>数据库设计范式</h4><ul>\n<li><p>第一范式：</p>\n<blockquote>\n<p>数据库中所有的字段都是不可分割的单一属性，字段的数据类型都是基本数据类型,如：整形、字符串、浮点数等。</p>\n</blockquote>\n</li>\n<li><p>第二范式：</p>\n<blockquote>\n<p>数据库表中不能存在组合关键字的某一字段决定非关键字段的情况。所以第二范式只针对于有组合关键字的情况。</p>\n</blockquote>\n</li>\n<li><p>第三范式：</p>\n<blockquote>\n<p>数据库表中不存在非关键字段对任意候选关键字段的传递函数依赖则符合第三范式。</p>\n</blockquote>\n</li>\n<li><p>BC范式：</p>\n<blockquote>\n<p>数据库表中不存在任何字段对任意候选关键字段的传递函数依赖则符合BC范式。</p>\n</blockquote>\n</li>\n</ul>\n<hr>\n<h3 id=\"物理设计\"><a href=\"#物理设计\" class=\"headerlink\" title=\"物理设计\"></a>物理设计</h3><ol>\n<li>选择合适的数据库管理系统</li>\n<li>定义数据库、表以及字段的命名规范</li>\n<li>根据所选的DBMS系统选择合适的字段数据类型</li>\n<li>反范式化设计（考虑效率：空间时间等）</li>\n</ol>\n<h4 id=\"DBMS选型\"><a href=\"#DBMS选型\" class=\"headerlink\" title=\"DBMS选型\"></a>DBMS选型</h4><ul>\n<li><p>版权考量<br>  商业数据库：</p>\n<ul>\n<li>Oracle</li>\n<li><p>SQLServer</p>\n<p>开源数据库：</p>\n</li>\n<li>MySQL</li>\n<li>PgSQL</li>\n</ul>\n</li>\n<li><p>功能上</p>\n<ul>\n<li>事物的支持</li>\n<li>特殊数据类型的支持</li>\n<li>…</li>\n</ul>\n</li>\n<li><p>操作系统<br>  Windows系统</p>\n<ul>\n<li><p>SQLServer</p>\n<p>Windows/类Linux</p>\n</li>\n<li>SQLServer</li>\n<li>MySQL</li>\n<li>PgSQL</li>\n</ul>\n</li>\n<li><p>开发语言<br>  .Net首选SQLServer</p>\n</li>\n<li><p>使用场景<br>  互联网项目</p>\n<ul>\n<li>MySQL</li>\n<li><p>PgSQL</p>\n<p>企业级项目</p>\n</li>\n<li>Oracle</li>\n<li>SQLServer</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"MySQL常用存储引擎\"><a href=\"#MySQL常用存储引擎\" class=\"headerlink\" title=\"MySQL常用存储引擎\"></a>MySQL常用存储引擎</h4><table>\n<thead>\n<tr>\n<th>存储引擎</th>\n<th>事务支持</th>\n<th>锁的粒度</th>\n<th>主要应用</th>\n<th>忌用</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>MyISAM</td>\n<td>不支持</td>\n<td>表级锁</td>\n<td>insert,select</td>\n<td>读写频繁</td>\n</tr>\n<tr>\n<td>MRG_MYISAM</td>\n<td>不支持</td>\n<td>表级锁</td>\n<td>分段归档</td>\n<td>全局查找过多的场景</td>\n</tr>\n<tr>\n<td>InnoDB</td>\n<td>支持</td>\n<td>行级锁</td>\n<td>事务</td>\n<td>无</td>\n</tr>\n<tr>\n<td>Archive</td>\n<td>不支持</td>\n<td>行级锁</td>\n<td>日志记录，只支持insert,select</td>\n<td>需要随机读取，更新，删除</td>\n</tr>\n<tr>\n<td>Ndb Cluster</td>\n<td>支持</td>\n<td>行级锁</td>\n<td>高可用</td>\n<td>大部分应用</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"数据库、表以及字段的命名规范\"><a href=\"#数据库、表以及字段的命名规范\" class=\"headerlink\" title=\"数据库、表以及字段的命名规范\"></a>数据库、表以及字段的命名规范</h4><ul>\n<li><p>数据库名、表名、字段名的命名规范</p>\n<ol>\n<li>数据库名/表名在Windows/Mac上大小写不敏感，在其他类Unix系统上大小写敏感</li>\n<li>字段名/索引名在所有系统上都是大小写不敏感(除非加了双引号)</li>\n<li>定义的时候要望文生义</li>\n</ol>\n</li>\n</ul>\n<h4 id=\"数据库字段类型的选择原则\"><a href=\"#数据库字段类型的选择原则\" class=\"headerlink\" title=\"数据库字段类型的选择原则\"></a>数据库字段类型的选择原则</h4><p>字段数据类型的选择原则：</p>\n<ol>\n<li><p>存储开销</p>\n</li>\n<li><p>查询性能: 对数据进行比较操作时，同样的数据，字符处理往往比数字慢。</p>\n</li>\n<li><p>当一个列可以选择多个数据类型时，优先选择数字类型，其次是日期或二进制类型</p>\n</li>\n<li><p>同级别的数据类型，应该优先选择占用空间小的数据类型。</p>\n</li>\n<li><p>数据库数据处理以页为单位(MySQL18k每页)，列的长度越小，一次加载数据约多，数据库IO性能会有所提升</p>\n</li>\n</ol>\n<h4 id=\"数据库如何具体选择字段类型\"><a href=\"#数据库如何具体选择字段类型\" class=\"headerlink\" title=\"数据库如何具体选择字段类型\"></a>数据库如何具体选择字段类型</h4><ul>\n<li><p>char和varchar</p>\n<ol>\n<li>如果列中要存储的数据长度差不多是一致的，则应该考虑用char，否则应该考虑用varchar。</li>\n<li>如果列中最大数据长度小于50Byte，则一般也考虑用char。</li>\n<li>一般不宜定义大于50Byte的char类型列。</li>\n</ol>\n</li>\n<li><p>decimal和float</p>\n<ol>\n<li>decimal(numeric)用于存储精确数据，而float只能用于存储非精确数据。</li>\n<li>float开销一般比decimal小，所以非精确数据一般选择float</li>\n</ol>\n</li>\n<li><p>时间类型</p>\n<ol>\n<li><p>用int存储的优缺点<br>优点：字段长度比datetime小。<br>缺点：使用不方便，要进行函数转换。<br>限制：由于int类型占用4个字节，最多只能存储到2038-1-19</p>\n</li>\n<li><p>需要存储的时间粒度<br>年 月 日 小时 分 秒 周</p>\n</li>\n</ol>\n</li>\n</ul>\n<h4 id=\"数据库设计其它注意事项\"><a href=\"#数据库设计其它注意事项\" class=\"headerlink\" title=\"数据库设计其它注意事项\"></a>数据库设计其它注意事项</h4><ul>\n<li><p>如何选择主键</p>\n<ol>\n<li><p>区分业务主键和数据库主键</p>\n<ol>\n<li>业务主键用于标示业务（有可能会更改）</li>\n<li>数据库主键为了优化数据存储（避免业务的变更带来的影响）</li>\n</ol>\n</li>\n<li><p>根据数据库的类型，考虑主键是否需要顺序增长</p>\n</li>\n<li>主键的字段类型所占用的空间要尽可能小（提高IO效率）</li>\n</ol>\n</li>\n</ul>\n<ul>\n<li>避免使用外键<ol>\n<li>降低数据倒入导入的效率</li>\n<li>增加维护成本</li>\n<li>虽然不建议使用外键约束，但是相关联的列上一定要建立索引</li>\n</ol>\n</li>\n</ul>\n<ul>\n<li><p>避免使用触发器</p>\n</li>\n<li><p>关于预留字段</p>\n<ol>\n<li>无法准确知道预留字段的类型</li>\n<li>无法准确知道预留字段中存储的内容</li>\n<li>后期维护预留字段的成本和增加一个新的字段所需要的成本是相同的</li>\n<li>严禁使用预留字段</li>\n</ol>\n</li>\n</ul>\n<h4 id=\"反范式化\"><a href=\"#反范式化\" class=\"headerlink\" title=\"反范式化\"></a>反范式化</h4><p>   通过一定数据的冗余，空间换取时间的操作，违反数据库的第三范式。提高读取性能。要点：</p>\n<ul>\n<li>减少表的关联数量</li>\n<li>增加数据的读取效率</li>\n<li>反范式化要适度</li>\n</ul>\n<hr>\n<h3 id=\"数据库维护\"><a href=\"#数据库维护\" class=\"headerlink\" title=\"数据库维护\"></a>数据库维护</h3><h4 id=\"如何维护数据字典\"><a href=\"#如何维护数据字典\" class=\"headerlink\" title=\"如何维护数据字典\"></a>如何维护数据字典</h4><ul>\n<li>利用第三方工具</li>\n<li>利用<code>COMMENT</code>属性，并通过<code>information_shema</code>查询数据字段信息</li>\n</ul>\n<h4 id=\"维护索引\"><a href=\"#维护索引\" class=\"headerlink\" title=\"维护索引\"></a>维护索引</h4><p>如何选择合适的列建立索引：</p>\n<ul>\n<li>出现在WHERE从句,GROUP BY从句, ORDER BY从句中的列</li>\n<li>可选择性高的列要放到索引的前面</li>\n<li>索引中不要包含太长的数据类型<ul>\n<li>Mysql支持对TEXT类型前缀进行索引</li>\n<li>对长类型进行MD5然后索引</li>\n<li>太长影响IO效率(16k/page)问题</li>\n</ul>\n</li>\n</ul>\n<p>注意事项：</p>\n<ul>\n<li>索引不是越多越好，过多的索引不但会降低写的效率(维护索引数据结构),还会影响读的效率(影响索引优化器)。</li>\n<li>定期维护索引碎片</li>\n<li>在SQL中不要使用强制索引关键字</li>\n</ul>\n<h4 id=\"数据库中适合的操作\"><a href=\"#数据库中适合的操作\" class=\"headerlink\" title=\"数据库中适合的操作\"></a>数据库中适合的操作</h4><p>如何维护表的结构</p>\n<ul>\n<li>使用在线变更表结构根据<ul>\n<li>MySQL5.5之前可以使用pt-online-schema-change(通过临时表)</li>\n<li>MySQL5.6之后本身支持在线表结构的变更(ALTER语句)</li>\n</ul>\n</li>\n<li>同时对数据字典进行维护</li>\n<li>控制表的宽度和大小</li>\n</ul>\n<p>适合的操作：</p>\n<ul>\n<li>批量操作vs逐条操作</li>\n<li>禁止使用Select * 这样的查询</li>\n<li>控制使用用户自定义函数</li>\n<li>不要使用数据库中的全文索引</li>\n</ul>\n<h4 id=\"在适当的时候进行表的水平和垂直拆分\"><a href=\"#在适当的时候进行表的水平和垂直拆分\" class=\"headerlink\" title=\"在适当的时候进行表的水平和垂直拆分\"></a>在适当的时候进行表的水平和垂直拆分</h4><p>表的垂直拆分</p>\n<blockquote>\n<p>为了控制表的宽度，可以进行垂直拆分。提高每一页存储的行数。从而提高IO效率。</p>\n</blockquote>\n<ul>\n<li>经常一起查询的列放到一起</li>\n<li>text、blob等大字段拆分到附加表中</li>\n</ul>\n<p>表的水平拆分</p>\n<blockquote>\n<p>为了控制表的大小(数据量)，可以进行表的水平拆分。把大表数据平均分到小表中。</p>\n</blockquote>\n<p>方法：</p>\n<ul>\n<li>对主键进行hash取模,把大表数据平均分配到小表中。</li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"需求分析\"><a href=\"#需求分析\" class=\"headerlink\" title=\"需求分析\"></a>需求分析</h3><h4 id=\"数据库设计简介\"><a href=\"#数据库设计简介\" class=\"headerlink\" title=\"数据库设计简介\"></a>数据库设计简介</h4><h4 id=\"数据库设计步骤\"><a href=\"#数据库设计步骤\" class=\"headerlink\" title=\"数据库设计步骤\"></a>数据库设计步骤</h4><ul>\n<li><p>需求分析</p>\n<ul>\n<li>了解需要存储的数据</li>\n<li>了解存储的数据的特点(实效性,增长过快需要分库分表)</li>\n<li>了解数据的生命周期(归档、清理规则)</li>\n</ul>\n</li>\n<li><p>要搞清楚的问题：</p>\n<ul>\n<li>实体之间的关系（1对1，1对多，多对多）</li>\n<li>实体包含的属性有什么</li>\n<li>有哪些属性或属性的组合可以唯一标识一个实体</li>\n</ul>\n</li>\n<li><p>逻辑分析</p>\n<blockquote>\n<p>使用ER图建模</p>\n</blockquote>\n</li>\n<li><p>物理设计</p>\n<blockquote>\n<p>考虑数据库的特点，把逻辑设计转化为物理设计。</p>\n</blockquote>\n</li>\n<li><p>维护优化</p>\n<ul>\n<li>新需求建表</li>\n<li>索引优化</li>\n<li>大表拆分</li>\n</ul>\n</li>\n</ul>\n<hr>\n<h3 id=\"逻辑设计\"><a href=\"#逻辑设计\" class=\"headerlink\" title=\"逻辑设计\"></a>逻辑设计</h3><ul>\n<li>将需求转化为数据库的逻辑模型</li>\n<li>通过ER图的形式对逻辑模型进行展示</li>\n<li>和具体的DBMS无关</li>\n</ul>\n<h4 id=\"ER图\"><a href=\"#ER图\" class=\"headerlink\" title=\"ER图\"></a>ER图</h4><p>常见的概念：</p>\n<p>关系：一个关系对应通常所说的一张表<br>元组：表中的一行即为一个元组<br>属性：表中的一列称之为一个属性；每一个属性都有一个名称，称之为属性名<br>候选码：表中的某个属性组，它可以唯一确定一个元组（唯一索引、主键）<br>主码：主键<br>域：属性的取值范围<br>分量：元组中的一个属性值  </p>\n<h4 id=\"数据库设计概要\"><a href=\"#数据库设计概要\" class=\"headerlink\" title=\"数据库设计概要\"></a>数据库设计概要</h4><blockquote>\n<p>数据库范式用于减少数据冗余，减少数据插入更新异常。</p>\n</blockquote>\n<h4 id=\"数据库设计范式\"><a href=\"#数据库设计范式\" class=\"headerlink\" title=\"数据库设计范式\"></a>数据库设计范式</h4><ul>\n<li><p>第一范式：</p>\n<blockquote>\n<p>数据库中所有的字段都是不可分割的单一属性，字段的数据类型都是基本数据类型,如：整形、字符串、浮点数等。</p>\n</blockquote>\n</li>\n<li><p>第二范式：</p>\n<blockquote>\n<p>数据库表中不能存在组合关键字的某一字段决定非关键字段的情况。所以第二范式只针对于有组合关键字的情况。</p>\n</blockquote>\n</li>\n<li><p>第三范式：</p>\n<blockquote>\n<p>数据库表中不存在非关键字段对任意候选关键字段的传递函数依赖则符合第三范式。</p>\n</blockquote>\n</li>\n<li><p>BC范式：</p>\n<blockquote>\n<p>数据库表中不存在任何字段对任意候选关键字段的传递函数依赖则符合BC范式。</p>\n</blockquote>\n</li>\n</ul>\n<hr>\n<h3 id=\"物理设计\"><a href=\"#物理设计\" class=\"headerlink\" title=\"物理设计\"></a>物理设计</h3><ol>\n<li>选择合适的数据库管理系统</li>\n<li>定义数据库、表以及字段的命名规范</li>\n<li>根据所选的DBMS系统选择合适的字段数据类型</li>\n<li>反范式化设计（考虑效率：空间时间等）</li>\n</ol>\n<h4 id=\"DBMS选型\"><a href=\"#DBMS选型\" class=\"headerlink\" title=\"DBMS选型\"></a>DBMS选型</h4><ul>\n<li><p>版权考量<br>  商业数据库：</p>\n<ul>\n<li>Oracle</li>\n<li><p>SQLServer</p>\n<p>开源数据库：</p>\n</li>\n<li>MySQL</li>\n<li>PgSQL</li>\n</ul>\n</li>\n<li><p>功能上</p>\n<ul>\n<li>事物的支持</li>\n<li>特殊数据类型的支持</li>\n<li>…</li>\n</ul>\n</li>\n<li><p>操作系统<br>  Windows系统</p>\n<ul>\n<li><p>SQLServer</p>\n<p>Windows/类Linux</p>\n</li>\n<li>SQLServer</li>\n<li>MySQL</li>\n<li>PgSQL</li>\n</ul>\n</li>\n<li><p>开发语言<br>  .Net首选SQLServer</p>\n</li>\n<li><p>使用场景<br>  互联网项目</p>\n<ul>\n<li>MySQL</li>\n<li><p>PgSQL</p>\n<p>企业级项目</p>\n</li>\n<li>Oracle</li>\n<li>SQLServer</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"MySQL常用存储引擎\"><a href=\"#MySQL常用存储引擎\" class=\"headerlink\" title=\"MySQL常用存储引擎\"></a>MySQL常用存储引擎</h4><table>\n<thead>\n<tr>\n<th>存储引擎</th>\n<th>事务支持</th>\n<th>锁的粒度</th>\n<th>主要应用</th>\n<th>忌用</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>MyISAM</td>\n<td>不支持</td>\n<td>表级锁</td>\n<td>insert,select</td>\n<td>读写频繁</td>\n</tr>\n<tr>\n<td>MRG_MYISAM</td>\n<td>不支持</td>\n<td>表级锁</td>\n<td>分段归档</td>\n<td>全局查找过多的场景</td>\n</tr>\n<tr>\n<td>InnoDB</td>\n<td>支持</td>\n<td>行级锁</td>\n<td>事务</td>\n<td>无</td>\n</tr>\n<tr>\n<td>Archive</td>\n<td>不支持</td>\n<td>行级锁</td>\n<td>日志记录，只支持insert,select</td>\n<td>需要随机读取，更新，删除</td>\n</tr>\n<tr>\n<td>Ndb Cluster</td>\n<td>支持</td>\n<td>行级锁</td>\n<td>高可用</td>\n<td>大部分应用</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"数据库、表以及字段的命名规范\"><a href=\"#数据库、表以及字段的命名规范\" class=\"headerlink\" title=\"数据库、表以及字段的命名规范\"></a>数据库、表以及字段的命名规范</h4><ul>\n<li><p>数据库名、表名、字段名的命名规范</p>\n<ol>\n<li>数据库名/表名在Windows/Mac上大小写不敏感，在其他类Unix系统上大小写敏感</li>\n<li>字段名/索引名在所有系统上都是大小写不敏感(除非加了双引号)</li>\n<li>定义的时候要望文生义</li>\n</ol>\n</li>\n</ul>\n<h4 id=\"数据库字段类型的选择原则\"><a href=\"#数据库字段类型的选择原则\" class=\"headerlink\" title=\"数据库字段类型的选择原则\"></a>数据库字段类型的选择原则</h4><p>字段数据类型的选择原则：</p>\n<ol>\n<li><p>存储开销</p>\n</li>\n<li><p>查询性能: 对数据进行比较操作时，同样的数据，字符处理往往比数字慢。</p>\n</li>\n<li><p>当一个列可以选择多个数据类型时，优先选择数字类型，其次是日期或二进制类型</p>\n</li>\n<li><p>同级别的数据类型，应该优先选择占用空间小的数据类型。</p>\n</li>\n<li><p>数据库数据处理以页为单位(MySQL18k每页)，列的长度越小，一次加载数据约多，数据库IO性能会有所提升</p>\n</li>\n</ol>\n<h4 id=\"数据库如何具体选择字段类型\"><a href=\"#数据库如何具体选择字段类型\" class=\"headerlink\" title=\"数据库如何具体选择字段类型\"></a>数据库如何具体选择字段类型</h4><ul>\n<li><p>char和varchar</p>\n<ol>\n<li>如果列中要存储的数据长度差不多是一致的，则应该考虑用char，否则应该考虑用varchar。</li>\n<li>如果列中最大数据长度小于50Byte，则一般也考虑用char。</li>\n<li>一般不宜定义大于50Byte的char类型列。</li>\n</ol>\n</li>\n<li><p>decimal和float</p>\n<ol>\n<li>decimal(numeric)用于存储精确数据，而float只能用于存储非精确数据。</li>\n<li>float开销一般比decimal小，所以非精确数据一般选择float</li>\n</ol>\n</li>\n<li><p>时间类型</p>\n<ol>\n<li><p>用int存储的优缺点<br>优点：字段长度比datetime小。<br>缺点：使用不方便，要进行函数转换。<br>限制：由于int类型占用4个字节，最多只能存储到2038-1-19</p>\n</li>\n<li><p>需要存储的时间粒度<br>年 月 日 小时 分 秒 周</p>\n</li>\n</ol>\n</li>\n</ul>\n<h4 id=\"数据库设计其它注意事项\"><a href=\"#数据库设计其它注意事项\" class=\"headerlink\" title=\"数据库设计其它注意事项\"></a>数据库设计其它注意事项</h4><ul>\n<li><p>如何选择主键</p>\n<ol>\n<li><p>区分业务主键和数据库主键</p>\n<ol>\n<li>业务主键用于标示业务（有可能会更改）</li>\n<li>数据库主键为了优化数据存储（避免业务的变更带来的影响）</li>\n</ol>\n</li>\n<li><p>根据数据库的类型，考虑主键是否需要顺序增长</p>\n</li>\n<li>主键的字段类型所占用的空间要尽可能小（提高IO效率）</li>\n</ol>\n</li>\n</ul>\n<ul>\n<li>避免使用外键<ol>\n<li>降低数据倒入导入的效率</li>\n<li>增加维护成本</li>\n<li>虽然不建议使用外键约束，但是相关联的列上一定要建立索引</li>\n</ol>\n</li>\n</ul>\n<ul>\n<li><p>避免使用触发器</p>\n</li>\n<li><p>关于预留字段</p>\n<ol>\n<li>无法准确知道预留字段的类型</li>\n<li>无法准确知道预留字段中存储的内容</li>\n<li>后期维护预留字段的成本和增加一个新的字段所需要的成本是相同的</li>\n<li>严禁使用预留字段</li>\n</ol>\n</li>\n</ul>\n<h4 id=\"反范式化\"><a href=\"#反范式化\" class=\"headerlink\" title=\"反范式化\"></a>反范式化</h4><p>   通过一定数据的冗余，空间换取时间的操作，违反数据库的第三范式。提高读取性能。要点：</p>\n<ul>\n<li>减少表的关联数量</li>\n<li>增加数据的读取效率</li>\n<li>反范式化要适度</li>\n</ul>\n<hr>\n<h3 id=\"数据库维护\"><a href=\"#数据库维护\" class=\"headerlink\" title=\"数据库维护\"></a>数据库维护</h3><h4 id=\"如何维护数据字典\"><a href=\"#如何维护数据字典\" class=\"headerlink\" title=\"如何维护数据字典\"></a>如何维护数据字典</h4><ul>\n<li>利用第三方工具</li>\n<li>利用<code>COMMENT</code>属性，并通过<code>information_shema</code>查询数据字段信息</li>\n</ul>\n<h4 id=\"维护索引\"><a href=\"#维护索引\" class=\"headerlink\" title=\"维护索引\"></a>维护索引</h4><p>如何选择合适的列建立索引：</p>\n<ul>\n<li>出现在WHERE从句,GROUP BY从句, ORDER BY从句中的列</li>\n<li>可选择性高的列要放到索引的前面</li>\n<li>索引中不要包含太长的数据类型<ul>\n<li>Mysql支持对TEXT类型前缀进行索引</li>\n<li>对长类型进行MD5然后索引</li>\n<li>太长影响IO效率(16k/page)问题</li>\n</ul>\n</li>\n</ul>\n<p>注意事项：</p>\n<ul>\n<li>索引不是越多越好，过多的索引不但会降低写的效率(维护索引数据结构),还会影响读的效率(影响索引优化器)。</li>\n<li>定期维护索引碎片</li>\n<li>在SQL中不要使用强制索引关键字</li>\n</ul>\n<h4 id=\"数据库中适合的操作\"><a href=\"#数据库中适合的操作\" class=\"headerlink\" title=\"数据库中适合的操作\"></a>数据库中适合的操作</h4><p>如何维护表的结构</p>\n<ul>\n<li>使用在线变更表结构根据<ul>\n<li>MySQL5.5之前可以使用pt-online-schema-change(通过临时表)</li>\n<li>MySQL5.6之后本身支持在线表结构的变更(ALTER语句)</li>\n</ul>\n</li>\n<li>同时对数据字典进行维护</li>\n<li>控制表的宽度和大小</li>\n</ul>\n<p>适合的操作：</p>\n<ul>\n<li>批量操作vs逐条操作</li>\n<li>禁止使用Select * 这样的查询</li>\n<li>控制使用用户自定义函数</li>\n<li>不要使用数据库中的全文索引</li>\n</ul>\n<h4 id=\"在适当的时候进行表的水平和垂直拆分\"><a href=\"#在适当的时候进行表的水平和垂直拆分\" class=\"headerlink\" title=\"在适当的时候进行表的水平和垂直拆分\"></a>在适当的时候进行表的水平和垂直拆分</h4><p>表的垂直拆分</p>\n<blockquote>\n<p>为了控制表的宽度，可以进行垂直拆分。提高每一页存储的行数。从而提高IO效率。</p>\n</blockquote>\n<ul>\n<li>经常一起查询的列放到一起</li>\n<li>text、blob等大字段拆分到附加表中</li>\n</ul>\n<p>表的水平拆分</p>\n<blockquote>\n<p>为了控制表的大小(数据量)，可以进行表的水平拆分。把大表数据平均分到小表中。</p>\n</blockquote>\n<p>方法：</p>\n<ul>\n<li>对主键进行hash取模,把大表数据平均分配到小表中。</li>\n</ul>\n"},{"title":"浅析C语言数据内存布局","date":"2014-01-21T05:22:03.000Z","_content":"\n  对于程序员而言，详细了解数据内存布局十分必要，否则自己常常犯一些错误却不知为什么。只有做到对内存布局心中有数，编写程序才会游刃有余。遇到问题也能想对方向。下面就C语言内存布局做简要分析。\n\n### 一.几个主要的位置段\n+ .bss段，之前看过书上解释其为blocked started by symbol。不去追究具体含义，简单而言bas段放的是未初始化的和初始化为 0 的生命周期为全局性质的变量。先通过一段实例代码来探个究竟。\n\n```shell\n\nlc@lc-Lenovo:~/work/test/demo$ cat test.c \n#include <stdio.h>\n#include <stdlib.h>\nchar anArray1[1024*1024];\nchar anArray2[1024*1024] = {0};\n\nint main(int argc, char* argv[])\n{\n\t\n\tstatic char anArray3[1024*1024];\n\tstatic char anArray4[1024*1024] = {0};\n\n\treturn (0);\n}\nlc@lc-Lenovo:~/work/test/demo$ gcc test.c \nlc@lc-Lenovo:~/work/test/demo$ ls -l a.out \n-rwxrwxr-x 1 lc lc 7438  8月 20 15:42 a.out\n\n```\n\n>可以看到可执行文件7k\n\n```shell\nlc@lc-Lenovo:~/work/test/demo$ objdump -h a.out | grep bss\n 24 .bss          00400020  0804a020  0804a020  0000101c  2**5\n```\n\n>可以看到bss段在4M.\n\n如果我们初始化为1而不是0看结果为：\n\n```shell\nlc@lc-Lenovo:~/work/test/demo$ cat test.c \n#include <stdio.h>\n#include <stdlib.h>\n\nchar anArray1[1024*1024];\nchar anArray2[1024*1024] = {1};\n\nint main(int argc, char* argv[])\n{\n\t\n\tstatic char anArray3[1024*1024];\n//\tstatic char anArray4[1024*1024] = {0};\n\n\treturn (0);\n}\nlc@lc-Lenovo:~/work/test/demo$ vim test.c \nlc@lc-Lenovo:~/work/test/demo$ objdump -h a.out | grep bss\n 24 .bss          00200020  0814a040  0814a040  00101040  2**5\n```\n\n>这里可以验证了我们的想法，bss段只占用运行时候内存空间。\n\n\n  现代大多数操作系统, 在加载程序时,会把所有的 bss 全局变量清零。(在一些嵌入式设备上，我们在编写启动代码的时候，需要手动执行bss段清0.)但为保证程序的可移植性,手工把这些变量初始化为 0 也是一个好习惯,这样这些变量都有个确定的初始值。当然作为全局变量,在整个程序的运行周期内,bss 数据是一直存在的。\n\n\n+ .data段\ndata段主要放的是初始化为非0的生命周期为全局性质的变量。上面的例子上，我们把数组的初始化修改为非0值，可以看到数据从bss转移到data段.\n\n```shell\n\nlc@lc-Lenovo:~/work/test/demo$ cat test.c \n#include <stdio.h>\n#include <stdlib.h>\n\nchar anArray1[1024*1024];\nchar anArray2[1024*1024] = {0};\n\nint main(int argc, char* argv[])\n{\n\t\n\tstatic char anArray3[1024*1024] = {1};\n\tstatic char anArray4[1024*1024] = {0};\n\n\treturn (0);\n}\nlc@lc-Lenovo:~/work/test/demo$ objdump -h a.out |grep bss\n 24 .bss          00300020  0814a040  0814a040  00101040  2**5\nlc@lc-Lenovo:~/work/test/demo$ objdump -h a.out |grep .data\n 14 .rodata       00000008  08048480  08048480  00000480  2**2\n 23 .data         00100020  0804a020  0804a020  00001020  2**5\n\n```\n\n>可以看到data段放置了初始化为非0 的变量。\n\n```shell\nlc@lc-Lenovo:~/work/test/demo$ ls -l a.out \n-rwxrwxr-x 1 lc lc 1056050  8月 20 16:04 a.out\n```\n\n通过观察可执行文件大小我们可以发现data段即占用可执行文件空间，又占用运行时候内存空间。而bss段只占用运行时候内存空间。\n\n+ .rodata段\nrodata 的意义同样明显,ro 代表 read only,rodata 就是用来存放常量数据的。关于 rodata 类型的数据,要注意以下几点:\no 常量不一定就放在 rodata 里,有的立即数直接和指令编码在一起,存放在代码段(.text)中。\no 对于字符串常量,编译器会自动去掉重复的字符串,保证一个字符串在一个可执行文件(EXE/SO)中只存在一份拷贝。o rodata 是在多个进程间是共享的,这样可以提高运行空间利用率。\no 在有的嵌入式系统中,rodata 放在 ROM(或者 norflash)里,运行时直接读取,无需加载到RAM 内存中。\no 在嵌入式 linux 系统中,也可以通过一种叫作 XIP(就地执行)的技术,也可以直接读取,而无需加载到 RAM 内存中。\no 常量是不能修改的,修改常量在 linux 下会出现段错误。由此可见,把在运行过程中不会改变的数据设为 rodata 类型的是有好处的:在多个进程间共享,可以大大提高空间利用率,甚至不占用 RAM 空间。同 时由于 rodata 在只读的内存页面(page)中,是受保护的,任何试图对它的修改都会被及时发现,这可以提高程序的稳定性。字符串会被编译器自动放到 rodata 中,其它数据要放到 rodata 中,只需要加 const 关键字修饰就好了。\n\n```shell\nlc@lc-Lenovo:~/work/test/demo$ cat test.c \n#include <stdio.h>\n#include <stdlib.h>\n\nconst char anArray1[1024*1024] = {1};\nchar anArray2[1024*1024] = {0};\n\nint main(int argc, char* argv[])\n{\n\t\nconst\tstatic char anArray3[1024*1024] = {1};\n\tstatic char anArray4[1024*1024] = {0};\n\n\treturn (0);\n}\nlc@lc-Lenovo:~/work/test/demo$ objdump -h a.out |grep rodata\n 14 .rodata       00200020  08048480  08048480  00000480  2**5\nlc@lc-Lenovo:~/work/test/demo$ ls -l a.out \n-rwxrwxr-x 1 lc lc 2104590  8月 20 16:15 a.out\nlc@lc-Lenovo:~/work/test/demo$ objdump -h a.out |grep bss\n 24 .bss          00200020  0824a020  0824a020  0020101c  2**5\nlc@lc-Lenovo:~/work/test/demo$ objdump -h a.out |grep data\n 14 .rodata       00200020  08048480  08048480  00000480  2**5\n 23 .data         00000008  0824a014  0824a014  00201014  2**2\n\n```\n\n+ text 段\n\ntext 段存放代码(如函数)和部分整数常量,它与 rodata 段很相似,相同的特性我们就不重复了,主要不同在于这个段是可以执行的。\n\n+ stack段  \n\n栈用于存放临时变量和函数参数。栈作为一种基本数据结构,我并不感到惊讶,用来实现函数调用,这也司空见惯的作法。直到我试图找到另外一种方式实现递归操作时,我才感叹于它的巧妙。要实现递归操作,不用栈不是不可能,只是找不出比它更优雅的方式。尽管大多数编译器在优化时,会把常用的参数或者局部变量放入寄存器中。但用栈来管理函数调用时的临时变量(局部变量和参数)是通用做法,前者只是辅助手段,且只在当前函数中使用,一旦调用下一层函数,这些值仍然要存入栈中才行。通常情况下,栈向下(低地址)增长,每向栈中 PUSH 一个元素,栈顶就向低地址扩展,每从栈中 POP 一个元素,栈顶就向高地址回退。一个有兴趣的问 题:在 x86 平台上,栈顶寄存器为 ESP,那么 ESP 的值在是 PUSH 操作之前修改呢,还是在 PUSH 操作之后修改呢?PUSH ESP 这条指令会向栈中存入什么数据呢?据说 x86 系列 CPU 中,除了 286 外,都是先修改 ESP,再压栈的。由于 286 没有 CPUID 指令,有的 OS 用 这种方法检查 286 的型号。要注意的是,存放在栈中的数据只在当前函数及下一层函数中有效,一旦函数返回了,这些数据也自动释放了,继续访问这些变量会造成意想不到的错误。\n\n+ 堆(heap) \n\n堆是最灵活的一种内存,它的生命周期完全由使用者控制。标准 C 提供几个函数: malloc 用来分配一块指定大小的内存。 realloc 用来调整/重分配一块存在的内存。 free 用来释放不再使用的内存。 ... 使用堆内存时请注意两个问题:alloc/free 要配对使用。内存分配了不释放我们称为内存泄露(memory leak),内存泄露多了迟早会出现 Out of memory 的错误,再分配内存就会失败。当然释放时也只能释放分配出来的内存,释放无效的内存,或者重复 free 都是不行的,会造成程序 crash。分配多少用多少。分配了 100 字节就只能用 100 字节,不管是读还是写,都只能在这个范围内,读多了会读到随机的数据,写多了会造成的随机的破坏。这种情况我们称为缓冲区溢出(buffer overflow),这是非常严重的,大部分安全问题都是由缓冲区溢出引起的。手工检查有没有内存泄露或者缓冲区溢出是很困难的,幸好有些工具可以使用,比如 linux下有 valgrind,它的使用方法很简单,大家下去可以试用一下,以后每次写完程序都应该用valgrind 跑一遍.","source":"_posts/浅析C语言数据内存布局.md","raw":"---\ntitle: 浅析C语言数据内存布局\ndate: 2014-01-21 13:22:03\ntags: c\ncategories: server\n---\n\n  对于程序员而言，详细了解数据内存布局十分必要，否则自己常常犯一些错误却不知为什么。只有做到对内存布局心中有数，编写程序才会游刃有余。遇到问题也能想对方向。下面就C语言内存布局做简要分析。\n\n### 一.几个主要的位置段\n+ .bss段，之前看过书上解释其为blocked started by symbol。不去追究具体含义，简单而言bas段放的是未初始化的和初始化为 0 的生命周期为全局性质的变量。先通过一段实例代码来探个究竟。\n\n```shell\n\nlc@lc-Lenovo:~/work/test/demo$ cat test.c \n#include <stdio.h>\n#include <stdlib.h>\nchar anArray1[1024*1024];\nchar anArray2[1024*1024] = {0};\n\nint main(int argc, char* argv[])\n{\n\t\n\tstatic char anArray3[1024*1024];\n\tstatic char anArray4[1024*1024] = {0};\n\n\treturn (0);\n}\nlc@lc-Lenovo:~/work/test/demo$ gcc test.c \nlc@lc-Lenovo:~/work/test/demo$ ls -l a.out \n-rwxrwxr-x 1 lc lc 7438  8月 20 15:42 a.out\n\n```\n\n>可以看到可执行文件7k\n\n```shell\nlc@lc-Lenovo:~/work/test/demo$ objdump -h a.out | grep bss\n 24 .bss          00400020  0804a020  0804a020  0000101c  2**5\n```\n\n>可以看到bss段在4M.\n\n如果我们初始化为1而不是0看结果为：\n\n```shell\nlc@lc-Lenovo:~/work/test/demo$ cat test.c \n#include <stdio.h>\n#include <stdlib.h>\n\nchar anArray1[1024*1024];\nchar anArray2[1024*1024] = {1};\n\nint main(int argc, char* argv[])\n{\n\t\n\tstatic char anArray3[1024*1024];\n//\tstatic char anArray4[1024*1024] = {0};\n\n\treturn (0);\n}\nlc@lc-Lenovo:~/work/test/demo$ vim test.c \nlc@lc-Lenovo:~/work/test/demo$ objdump -h a.out | grep bss\n 24 .bss          00200020  0814a040  0814a040  00101040  2**5\n```\n\n>这里可以验证了我们的想法，bss段只占用运行时候内存空间。\n\n\n  现代大多数操作系统, 在加载程序时,会把所有的 bss 全局变量清零。(在一些嵌入式设备上，我们在编写启动代码的时候，需要手动执行bss段清0.)但为保证程序的可移植性,手工把这些变量初始化为 0 也是一个好习惯,这样这些变量都有个确定的初始值。当然作为全局变量,在整个程序的运行周期内,bss 数据是一直存在的。\n\n\n+ .data段\ndata段主要放的是初始化为非0的生命周期为全局性质的变量。上面的例子上，我们把数组的初始化修改为非0值，可以看到数据从bss转移到data段.\n\n```shell\n\nlc@lc-Lenovo:~/work/test/demo$ cat test.c \n#include <stdio.h>\n#include <stdlib.h>\n\nchar anArray1[1024*1024];\nchar anArray2[1024*1024] = {0};\n\nint main(int argc, char* argv[])\n{\n\t\n\tstatic char anArray3[1024*1024] = {1};\n\tstatic char anArray4[1024*1024] = {0};\n\n\treturn (0);\n}\nlc@lc-Lenovo:~/work/test/demo$ objdump -h a.out |grep bss\n 24 .bss          00300020  0814a040  0814a040  00101040  2**5\nlc@lc-Lenovo:~/work/test/demo$ objdump -h a.out |grep .data\n 14 .rodata       00000008  08048480  08048480  00000480  2**2\n 23 .data         00100020  0804a020  0804a020  00001020  2**5\n\n```\n\n>可以看到data段放置了初始化为非0 的变量。\n\n```shell\nlc@lc-Lenovo:~/work/test/demo$ ls -l a.out \n-rwxrwxr-x 1 lc lc 1056050  8月 20 16:04 a.out\n```\n\n通过观察可执行文件大小我们可以发现data段即占用可执行文件空间，又占用运行时候内存空间。而bss段只占用运行时候内存空间。\n\n+ .rodata段\nrodata 的意义同样明显,ro 代表 read only,rodata 就是用来存放常量数据的。关于 rodata 类型的数据,要注意以下几点:\no 常量不一定就放在 rodata 里,有的立即数直接和指令编码在一起,存放在代码段(.text)中。\no 对于字符串常量,编译器会自动去掉重复的字符串,保证一个字符串在一个可执行文件(EXE/SO)中只存在一份拷贝。o rodata 是在多个进程间是共享的,这样可以提高运行空间利用率。\no 在有的嵌入式系统中,rodata 放在 ROM(或者 norflash)里,运行时直接读取,无需加载到RAM 内存中。\no 在嵌入式 linux 系统中,也可以通过一种叫作 XIP(就地执行)的技术,也可以直接读取,而无需加载到 RAM 内存中。\no 常量是不能修改的,修改常量在 linux 下会出现段错误。由此可见,把在运行过程中不会改变的数据设为 rodata 类型的是有好处的:在多个进程间共享,可以大大提高空间利用率,甚至不占用 RAM 空间。同 时由于 rodata 在只读的内存页面(page)中,是受保护的,任何试图对它的修改都会被及时发现,这可以提高程序的稳定性。字符串会被编译器自动放到 rodata 中,其它数据要放到 rodata 中,只需要加 const 关键字修饰就好了。\n\n```shell\nlc@lc-Lenovo:~/work/test/demo$ cat test.c \n#include <stdio.h>\n#include <stdlib.h>\n\nconst char anArray1[1024*1024] = {1};\nchar anArray2[1024*1024] = {0};\n\nint main(int argc, char* argv[])\n{\n\t\nconst\tstatic char anArray3[1024*1024] = {1};\n\tstatic char anArray4[1024*1024] = {0};\n\n\treturn (0);\n}\nlc@lc-Lenovo:~/work/test/demo$ objdump -h a.out |grep rodata\n 14 .rodata       00200020  08048480  08048480  00000480  2**5\nlc@lc-Lenovo:~/work/test/demo$ ls -l a.out \n-rwxrwxr-x 1 lc lc 2104590  8月 20 16:15 a.out\nlc@lc-Lenovo:~/work/test/demo$ objdump -h a.out |grep bss\n 24 .bss          00200020  0824a020  0824a020  0020101c  2**5\nlc@lc-Lenovo:~/work/test/demo$ objdump -h a.out |grep data\n 14 .rodata       00200020  08048480  08048480  00000480  2**5\n 23 .data         00000008  0824a014  0824a014  00201014  2**2\n\n```\n\n+ text 段\n\ntext 段存放代码(如函数)和部分整数常量,它与 rodata 段很相似,相同的特性我们就不重复了,主要不同在于这个段是可以执行的。\n\n+ stack段  \n\n栈用于存放临时变量和函数参数。栈作为一种基本数据结构,我并不感到惊讶,用来实现函数调用,这也司空见惯的作法。直到我试图找到另外一种方式实现递归操作时,我才感叹于它的巧妙。要实现递归操作,不用栈不是不可能,只是找不出比它更优雅的方式。尽管大多数编译器在优化时,会把常用的参数或者局部变量放入寄存器中。但用栈来管理函数调用时的临时变量(局部变量和参数)是通用做法,前者只是辅助手段,且只在当前函数中使用,一旦调用下一层函数,这些值仍然要存入栈中才行。通常情况下,栈向下(低地址)增长,每向栈中 PUSH 一个元素,栈顶就向低地址扩展,每从栈中 POP 一个元素,栈顶就向高地址回退。一个有兴趣的问 题:在 x86 平台上,栈顶寄存器为 ESP,那么 ESP 的值在是 PUSH 操作之前修改呢,还是在 PUSH 操作之后修改呢?PUSH ESP 这条指令会向栈中存入什么数据呢?据说 x86 系列 CPU 中,除了 286 外,都是先修改 ESP,再压栈的。由于 286 没有 CPUID 指令,有的 OS 用 这种方法检查 286 的型号。要注意的是,存放在栈中的数据只在当前函数及下一层函数中有效,一旦函数返回了,这些数据也自动释放了,继续访问这些变量会造成意想不到的错误。\n\n+ 堆(heap) \n\n堆是最灵活的一种内存,它的生命周期完全由使用者控制。标准 C 提供几个函数: malloc 用来分配一块指定大小的内存。 realloc 用来调整/重分配一块存在的内存。 free 用来释放不再使用的内存。 ... 使用堆内存时请注意两个问题:alloc/free 要配对使用。内存分配了不释放我们称为内存泄露(memory leak),内存泄露多了迟早会出现 Out of memory 的错误,再分配内存就会失败。当然释放时也只能释放分配出来的内存,释放无效的内存,或者重复 free 都是不行的,会造成程序 crash。分配多少用多少。分配了 100 字节就只能用 100 字节,不管是读还是写,都只能在这个范围内,读多了会读到随机的数据,写多了会造成的随机的破坏。这种情况我们称为缓冲区溢出(buffer overflow),这是非常严重的,大部分安全问题都是由缓冲区溢出引起的。手工检查有没有内存泄露或者缓冲区溢出是很困难的,幸好有些工具可以使用,比如 linux下有 valgrind,它的使用方法很简单,大家下去可以试用一下,以后每次写完程序都应该用valgrind 跑一遍.","slug":"浅析C语言数据内存布局","published":1,"updated":"2018-11-21T15:23:55.023Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cei004yy4zvy9reawy4","content":"<p>  对于程序员而言，详细了解数据内存布局十分必要，否则自己常常犯一些错误却不知为什么。只有做到对内存布局心中有数，编写程序才会游刃有余。遇到问题也能想对方向。下面就C语言内存布局做简要分析。</p>\n<h3 id=\"一-几个主要的位置段\"><a href=\"#一-几个主要的位置段\" class=\"headerlink\" title=\"一.几个主要的位置段\"></a>一.几个主要的位置段</h3><ul>\n<li>.bss段，之前看过书上解释其为blocked started by symbol。不去追究具体含义，简单而言bas段放的是未初始化的和初始化为 0 的生命周期为全局性质的变量。先通过一段实例代码来探个究竟。</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">lc@lc-Lenovo:~/work/test/demo$ cat test.c </span><br><span class=\"line\"><span class=\"meta\">#</span>include &lt;stdio.h&gt;</span><br><span class=\"line\"><span class=\"meta\">#</span>include &lt;stdlib.h&gt;</span><br><span class=\"line\">char anArray1[1024*1024];</span><br><span class=\"line\">char anArray2[1024*1024] = &#123;0&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tstatic char anArray3[1024*1024];</span><br><span class=\"line\">\tstatic char anArray4[1024*1024] = &#123;0&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">\treturn (0);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">lc@lc-Lenovo:~/work/test/demo$ gcc test.c </span><br><span class=\"line\">lc@lc-Lenovo:~/work/test/demo$ ls -l a.out </span><br><span class=\"line\">-rwxrwxr-x 1 lc lc 7438  8月 20 15:42 a.out</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>可以看到可执行文件7k</p>\n</blockquote>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lc@lc-Lenovo:~/work/test/demo$ objdump -h a.out | grep bss</span><br><span class=\"line\"> 24 .bss          00400020  0804a020  0804a020  0000101c  2**5</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>可以看到bss段在4M.</p>\n</blockquote>\n<p>如果我们初始化为1而不是0看结果为：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lc@lc-Lenovo:~/work/test/demo$ cat test.c </span><br><span class=\"line\"><span class=\"meta\">#</span>include &lt;stdio.h&gt;</span><br><span class=\"line\"><span class=\"meta\">#</span>include &lt;stdlib.h&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">char anArray1[1024*1024];</span><br><span class=\"line\">char anArray2[1024*1024] = &#123;1&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tstatic char anArray3[1024*1024];</span><br><span class=\"line\">//\tstatic char anArray4[1024*1024] = &#123;0&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">\treturn (0);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">lc@lc-Lenovo:~/work/test/demo$ vim test.c </span><br><span class=\"line\">lc@lc-Lenovo:~/work/test/demo$ objdump -h a.out | grep bss</span><br><span class=\"line\"> 24 .bss          00200020  0814a040  0814a040  00101040  2**5</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>这里可以验证了我们的想法，bss段只占用运行时候内存空间。</p>\n</blockquote>\n<p>  现代大多数操作系统, 在加载程序时,会把所有的 bss 全局变量清零。(在一些嵌入式设备上，我们在编写启动代码的时候，需要手动执行bss段清0.)但为保证程序的可移植性,手工把这些变量初始化为 0 也是一个好习惯,这样这些变量都有个确定的初始值。当然作为全局变量,在整个程序的运行周期内,bss 数据是一直存在的。</p>\n<ul>\n<li>.data段<br>data段主要放的是初始化为非0的生命周期为全局性质的变量。上面的例子上，我们把数组的初始化修改为非0值，可以看到数据从bss转移到data段.</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">lc@lc-Lenovo:~/work/test/demo$ cat test.c </span><br><span class=\"line\"><span class=\"meta\">#</span>include &lt;stdio.h&gt;</span><br><span class=\"line\"><span class=\"meta\">#</span>include &lt;stdlib.h&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">char anArray1[1024*1024];</span><br><span class=\"line\">char anArray2[1024*1024] = &#123;0&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tstatic char anArray3[1024*1024] = &#123;1&#125;;</span><br><span class=\"line\">\tstatic char anArray4[1024*1024] = &#123;0&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">\treturn (0);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">lc@lc-Lenovo:~/work/test/demo$ objdump -h a.out |grep bss</span><br><span class=\"line\"> 24 .bss          00300020  0814a040  0814a040  00101040  2**5</span><br><span class=\"line\">lc@lc-Lenovo:~/work/test/demo$ objdump -h a.out |grep .data</span><br><span class=\"line\"> 14 .rodata       00000008  08048480  08048480  00000480  2**2</span><br><span class=\"line\"> 23 .data         00100020  0804a020  0804a020  00001020  2**5</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>可以看到data段放置了初始化为非0 的变量。</p>\n</blockquote>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lc@lc-Lenovo:~/work/test/demo$ ls -l a.out </span><br><span class=\"line\">-rwxrwxr-x 1 lc lc 1056050  8月 20 16:04 a.out</span><br></pre></td></tr></table></figure>\n<p>通过观察可执行文件大小我们可以发现data段即占用可执行文件空间，又占用运行时候内存空间。而bss段只占用运行时候内存空间。</p>\n<ul>\n<li>.rodata段<br>rodata 的意义同样明显,ro 代表 read only,rodata 就是用来存放常量数据的。关于 rodata 类型的数据,要注意以下几点:<br>o 常量不一定就放在 rodata 里,有的立即数直接和指令编码在一起,存放在代码段(.text)中。<br>o 对于字符串常量,编译器会自动去掉重复的字符串,保证一个字符串在一个可执行文件(EXE/SO)中只存在一份拷贝。o rodata 是在多个进程间是共享的,这样可以提高运行空间利用率。<br>o 在有的嵌入式系统中,rodata 放在 ROM(或者 norflash)里,运行时直接读取,无需加载到RAM 内存中。<br>o 在嵌入式 linux 系统中,也可以通过一种叫作 XIP(就地执行)的技术,也可以直接读取,而无需加载到 RAM 内存中。<br>o 常量是不能修改的,修改常量在 linux 下会出现段错误。由此可见,把在运行过程中不会改变的数据设为 rodata 类型的是有好处的:在多个进程间共享,可以大大提高空间利用率,甚至不占用 RAM 空间。同 时由于 rodata 在只读的内存页面(page)中,是受保护的,任何试图对它的修改都会被及时发现,这可以提高程序的稳定性。字符串会被编译器自动放到 rodata 中,其它数据要放到 rodata 中,只需要加 const 关键字修饰就好了。</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lc@lc-Lenovo:~/work/test/demo$ cat test.c </span><br><span class=\"line\"><span class=\"meta\">#</span>include &lt;stdio.h&gt;</span><br><span class=\"line\"><span class=\"meta\">#</span>include &lt;stdlib.h&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">const char anArray1[1024*1024] = &#123;1&#125;;</span><br><span class=\"line\">char anArray2[1024*1024] = &#123;0&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t</span><br><span class=\"line\">const\tstatic char anArray3[1024*1024] = &#123;1&#125;;</span><br><span class=\"line\">\tstatic char anArray4[1024*1024] = &#123;0&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">\treturn (0);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">lc@lc-Lenovo:~/work/test/demo$ objdump -h a.out |grep rodata</span><br><span class=\"line\"> 14 .rodata       00200020  08048480  08048480  00000480  2**5</span><br><span class=\"line\">lc@lc-Lenovo:~/work/test/demo$ ls -l a.out </span><br><span class=\"line\">-rwxrwxr-x 1 lc lc 2104590  8月 20 16:15 a.out</span><br><span class=\"line\">lc@lc-Lenovo:~/work/test/demo$ objdump -h a.out |grep bss</span><br><span class=\"line\"> 24 .bss          00200020  0824a020  0824a020  0020101c  2**5</span><br><span class=\"line\">lc@lc-Lenovo:~/work/test/demo$ objdump -h a.out |grep data</span><br><span class=\"line\"> 14 .rodata       00200020  08048480  08048480  00000480  2**5</span><br><span class=\"line\"> 23 .data         00000008  0824a014  0824a014  00201014  2**2</span><br></pre></td></tr></table></figure>\n<ul>\n<li>text 段</li>\n</ul>\n<p>text 段存放代码(如函数)和部分整数常量,它与 rodata 段很相似,相同的特性我们就不重复了,主要不同在于这个段是可以执行的。</p>\n<ul>\n<li>stack段  </li>\n</ul>\n<p>栈用于存放临时变量和函数参数。栈作为一种基本数据结构,我并不感到惊讶,用来实现函数调用,这也司空见惯的作法。直到我试图找到另外一种方式实现递归操作时,我才感叹于它的巧妙。要实现递归操作,不用栈不是不可能,只是找不出比它更优雅的方式。尽管大多数编译器在优化时,会把常用的参数或者局部变量放入寄存器中。但用栈来管理函数调用时的临时变量(局部变量和参数)是通用做法,前者只是辅助手段,且只在当前函数中使用,一旦调用下一层函数,这些值仍然要存入栈中才行。通常情况下,栈向下(低地址)增长,每向栈中 PUSH 一个元素,栈顶就向低地址扩展,每从栈中 POP 一个元素,栈顶就向高地址回退。一个有兴趣的问 题:在 x86 平台上,栈顶寄存器为 ESP,那么 ESP 的值在是 PUSH 操作之前修改呢,还是在 PUSH 操作之后修改呢?PUSH ESP 这条指令会向栈中存入什么数据呢?据说 x86 系列 CPU 中,除了 286 外,都是先修改 ESP,再压栈的。由于 286 没有 CPUID 指令,有的 OS 用 这种方法检查 286 的型号。要注意的是,存放在栈中的数据只在当前函数及下一层函数中有效,一旦函数返回了,这些数据也自动释放了,继续访问这些变量会造成意想不到的错误。</p>\n<ul>\n<li>堆(heap) </li>\n</ul>\n<p>堆是最灵活的一种内存,它的生命周期完全由使用者控制。标准 C 提供几个函数: malloc 用来分配一块指定大小的内存。 realloc 用来调整/重分配一块存在的内存。 free 用来释放不再使用的内存。 … 使用堆内存时请注意两个问题:alloc/free 要配对使用。内存分配了不释放我们称为内存泄露(memory leak),内存泄露多了迟早会出现 Out of memory 的错误,再分配内存就会失败。当然释放时也只能释放分配出来的内存,释放无效的内存,或者重复 free 都是不行的,会造成程序 crash。分配多少用多少。分配了 100 字节就只能用 100 字节,不管是读还是写,都只能在这个范围内,读多了会读到随机的数据,写多了会造成的随机的破坏。这种情况我们称为缓冲区溢出(buffer overflow),这是非常严重的,大部分安全问题都是由缓冲区溢出引起的。手工检查有没有内存泄露或者缓冲区溢出是很困难的,幸好有些工具可以使用,比如 linux下有 valgrind,它的使用方法很简单,大家下去可以试用一下,以后每次写完程序都应该用valgrind 跑一遍.</p>\n","site":{"data":{}},"excerpt":"","more":"<p>  对于程序员而言，详细了解数据内存布局十分必要，否则自己常常犯一些错误却不知为什么。只有做到对内存布局心中有数，编写程序才会游刃有余。遇到问题也能想对方向。下面就C语言内存布局做简要分析。</p>\n<h3 id=\"一-几个主要的位置段\"><a href=\"#一-几个主要的位置段\" class=\"headerlink\" title=\"一.几个主要的位置段\"></a>一.几个主要的位置段</h3><ul>\n<li>.bss段，之前看过书上解释其为blocked started by symbol。不去追究具体含义，简单而言bas段放的是未初始化的和初始化为 0 的生命周期为全局性质的变量。先通过一段实例代码来探个究竟。</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">lc@lc-Lenovo:~/work/test/demo$ cat test.c </span><br><span class=\"line\"><span class=\"meta\">#</span>include &lt;stdio.h&gt;</span><br><span class=\"line\"><span class=\"meta\">#</span>include &lt;stdlib.h&gt;</span><br><span class=\"line\">char anArray1[1024*1024];</span><br><span class=\"line\">char anArray2[1024*1024] = &#123;0&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tstatic char anArray3[1024*1024];</span><br><span class=\"line\">\tstatic char anArray4[1024*1024] = &#123;0&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">\treturn (0);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">lc@lc-Lenovo:~/work/test/demo$ gcc test.c </span><br><span class=\"line\">lc@lc-Lenovo:~/work/test/demo$ ls -l a.out </span><br><span class=\"line\">-rwxrwxr-x 1 lc lc 7438  8月 20 15:42 a.out</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>可以看到可执行文件7k</p>\n</blockquote>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lc@lc-Lenovo:~/work/test/demo$ objdump -h a.out | grep bss</span><br><span class=\"line\"> 24 .bss          00400020  0804a020  0804a020  0000101c  2**5</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>可以看到bss段在4M.</p>\n</blockquote>\n<p>如果我们初始化为1而不是0看结果为：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lc@lc-Lenovo:~/work/test/demo$ cat test.c </span><br><span class=\"line\"><span class=\"meta\">#</span>include &lt;stdio.h&gt;</span><br><span class=\"line\"><span class=\"meta\">#</span>include &lt;stdlib.h&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">char anArray1[1024*1024];</span><br><span class=\"line\">char anArray2[1024*1024] = &#123;1&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tstatic char anArray3[1024*1024];</span><br><span class=\"line\">//\tstatic char anArray4[1024*1024] = &#123;0&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">\treturn (0);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">lc@lc-Lenovo:~/work/test/demo$ vim test.c </span><br><span class=\"line\">lc@lc-Lenovo:~/work/test/demo$ objdump -h a.out | grep bss</span><br><span class=\"line\"> 24 .bss          00200020  0814a040  0814a040  00101040  2**5</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>这里可以验证了我们的想法，bss段只占用运行时候内存空间。</p>\n</blockquote>\n<p>  现代大多数操作系统, 在加载程序时,会把所有的 bss 全局变量清零。(在一些嵌入式设备上，我们在编写启动代码的时候，需要手动执行bss段清0.)但为保证程序的可移植性,手工把这些变量初始化为 0 也是一个好习惯,这样这些变量都有个确定的初始值。当然作为全局变量,在整个程序的运行周期内,bss 数据是一直存在的。</p>\n<ul>\n<li>.data段<br>data段主要放的是初始化为非0的生命周期为全局性质的变量。上面的例子上，我们把数组的初始化修改为非0值，可以看到数据从bss转移到data段.</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">lc@lc-Lenovo:~/work/test/demo$ cat test.c </span><br><span class=\"line\"><span class=\"meta\">#</span>include &lt;stdio.h&gt;</span><br><span class=\"line\"><span class=\"meta\">#</span>include &lt;stdlib.h&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">char anArray1[1024*1024];</span><br><span class=\"line\">char anArray2[1024*1024] = &#123;0&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tstatic char anArray3[1024*1024] = &#123;1&#125;;</span><br><span class=\"line\">\tstatic char anArray4[1024*1024] = &#123;0&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">\treturn (0);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">lc@lc-Lenovo:~/work/test/demo$ objdump -h a.out |grep bss</span><br><span class=\"line\"> 24 .bss          00300020  0814a040  0814a040  00101040  2**5</span><br><span class=\"line\">lc@lc-Lenovo:~/work/test/demo$ objdump -h a.out |grep .data</span><br><span class=\"line\"> 14 .rodata       00000008  08048480  08048480  00000480  2**2</span><br><span class=\"line\"> 23 .data         00100020  0804a020  0804a020  00001020  2**5</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>可以看到data段放置了初始化为非0 的变量。</p>\n</blockquote>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lc@lc-Lenovo:~/work/test/demo$ ls -l a.out </span><br><span class=\"line\">-rwxrwxr-x 1 lc lc 1056050  8月 20 16:04 a.out</span><br></pre></td></tr></table></figure>\n<p>通过观察可执行文件大小我们可以发现data段即占用可执行文件空间，又占用运行时候内存空间。而bss段只占用运行时候内存空间。</p>\n<ul>\n<li>.rodata段<br>rodata 的意义同样明显,ro 代表 read only,rodata 就是用来存放常量数据的。关于 rodata 类型的数据,要注意以下几点:<br>o 常量不一定就放在 rodata 里,有的立即数直接和指令编码在一起,存放在代码段(.text)中。<br>o 对于字符串常量,编译器会自动去掉重复的字符串,保证一个字符串在一个可执行文件(EXE/SO)中只存在一份拷贝。o rodata 是在多个进程间是共享的,这样可以提高运行空间利用率。<br>o 在有的嵌入式系统中,rodata 放在 ROM(或者 norflash)里,运行时直接读取,无需加载到RAM 内存中。<br>o 在嵌入式 linux 系统中,也可以通过一种叫作 XIP(就地执行)的技术,也可以直接读取,而无需加载到 RAM 内存中。<br>o 常量是不能修改的,修改常量在 linux 下会出现段错误。由此可见,把在运行过程中不会改变的数据设为 rodata 类型的是有好处的:在多个进程间共享,可以大大提高空间利用率,甚至不占用 RAM 空间。同 时由于 rodata 在只读的内存页面(page)中,是受保护的,任何试图对它的修改都会被及时发现,这可以提高程序的稳定性。字符串会被编译器自动放到 rodata 中,其它数据要放到 rodata 中,只需要加 const 关键字修饰就好了。</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lc@lc-Lenovo:~/work/test/demo$ cat test.c </span><br><span class=\"line\"><span class=\"meta\">#</span>include &lt;stdio.h&gt;</span><br><span class=\"line\"><span class=\"meta\">#</span>include &lt;stdlib.h&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">const char anArray1[1024*1024] = &#123;1&#125;;</span><br><span class=\"line\">char anArray2[1024*1024] = &#123;0&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t</span><br><span class=\"line\">const\tstatic char anArray3[1024*1024] = &#123;1&#125;;</span><br><span class=\"line\">\tstatic char anArray4[1024*1024] = &#123;0&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">\treturn (0);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">lc@lc-Lenovo:~/work/test/demo$ objdump -h a.out |grep rodata</span><br><span class=\"line\"> 14 .rodata       00200020  08048480  08048480  00000480  2**5</span><br><span class=\"line\">lc@lc-Lenovo:~/work/test/demo$ ls -l a.out </span><br><span class=\"line\">-rwxrwxr-x 1 lc lc 2104590  8月 20 16:15 a.out</span><br><span class=\"line\">lc@lc-Lenovo:~/work/test/demo$ objdump -h a.out |grep bss</span><br><span class=\"line\"> 24 .bss          00200020  0824a020  0824a020  0020101c  2**5</span><br><span class=\"line\">lc@lc-Lenovo:~/work/test/demo$ objdump -h a.out |grep data</span><br><span class=\"line\"> 14 .rodata       00200020  08048480  08048480  00000480  2**5</span><br><span class=\"line\"> 23 .data         00000008  0824a014  0824a014  00201014  2**2</span><br></pre></td></tr></table></figure>\n<ul>\n<li>text 段</li>\n</ul>\n<p>text 段存放代码(如函数)和部分整数常量,它与 rodata 段很相似,相同的特性我们就不重复了,主要不同在于这个段是可以执行的。</p>\n<ul>\n<li>stack段  </li>\n</ul>\n<p>栈用于存放临时变量和函数参数。栈作为一种基本数据结构,我并不感到惊讶,用来实现函数调用,这也司空见惯的作法。直到我试图找到另外一种方式实现递归操作时,我才感叹于它的巧妙。要实现递归操作,不用栈不是不可能,只是找不出比它更优雅的方式。尽管大多数编译器在优化时,会把常用的参数或者局部变量放入寄存器中。但用栈来管理函数调用时的临时变量(局部变量和参数)是通用做法,前者只是辅助手段,且只在当前函数中使用,一旦调用下一层函数,这些值仍然要存入栈中才行。通常情况下,栈向下(低地址)增长,每向栈中 PUSH 一个元素,栈顶就向低地址扩展,每从栈中 POP 一个元素,栈顶就向高地址回退。一个有兴趣的问 题:在 x86 平台上,栈顶寄存器为 ESP,那么 ESP 的值在是 PUSH 操作之前修改呢,还是在 PUSH 操作之后修改呢?PUSH ESP 这条指令会向栈中存入什么数据呢?据说 x86 系列 CPU 中,除了 286 外,都是先修改 ESP,再压栈的。由于 286 没有 CPUID 指令,有的 OS 用 这种方法检查 286 的型号。要注意的是,存放在栈中的数据只在当前函数及下一层函数中有效,一旦函数返回了,这些数据也自动释放了,继续访问这些变量会造成意想不到的错误。</p>\n<ul>\n<li>堆(heap) </li>\n</ul>\n<p>堆是最灵活的一种内存,它的生命周期完全由使用者控制。标准 C 提供几个函数: malloc 用来分配一块指定大小的内存。 realloc 用来调整/重分配一块存在的内存。 free 用来释放不再使用的内存。 … 使用堆内存时请注意两个问题:alloc/free 要配对使用。内存分配了不释放我们称为内存泄露(memory leak),内存泄露多了迟早会出现 Out of memory 的错误,再分配内存就会失败。当然释放时也只能释放分配出来的内存,释放无效的内存,或者重复 free 都是不行的,会造成程序 crash。分配多少用多少。分配了 100 字节就只能用 100 字节,不管是读还是写,都只能在这个范围内,读多了会读到随机的数据,写多了会造成的随机的破坏。这种情况我们称为缓冲区溢出(buffer overflow),这是非常严重的,大部分安全问题都是由缓冲区溢出引起的。手工检查有没有内存泄露或者缓冲区溢出是很困难的,幸好有些工具可以使用,比如 linux下有 valgrind,它的使用方法很简单,大家下去可以试用一下,以后每次写完程序都应该用valgrind 跑一遍.</p>\n"},{"title":"浅析C++重载覆盖隐藏以及虚函数","date":"2013-09-21T05:06:10.000Z","_content":"\nC++里面重载覆盖隐藏的概念经常被提及，在很多C++测试题目里面也一直有遇到，每次做这类型的题目总感觉没有彻底搞清楚，故在这里做一个总结，以后遇到类似的问题能够轻易解决。首先来看看<<高质量C/C++编程指南>>作者对几个概念的描述:\n\n重载：\n（1）相同的范围（在同一个类中）；  \n（2）函数名字相同；  \n（3）参数不同；  \n（4）virtual关键字可有可无。  \n覆盖：\n（1）不同的范围（父子类中）  \n（2）函数名称相同  \n（3）参数相同  \n（4）基类必须有virtual关键字  \n隐藏：\n（1）如果派生类的函数与基类的函数同名，但是参数不同。此时，不论有无virtual关键字，基类的函数将被隐藏（注意别与重载混淆）。  \n（2）如果派生类的函数与基类的函数同名，并且参数也相同，但是基类函数没有virtual关键字。此时，基类的函数被隐藏（注意别与覆盖混淆）。  \n\n    重载发生在一个类中，覆盖发生在子类重新实现了父类的虚函数。一般来说，只要记住了重载和覆盖，遇到其他情况只要函数同名基本可以判定为隐藏。隐藏顾名思义就是还可以被找出来，而覆盖就不存在了。重载不能仅仅根据返回值不一致来区分两个重载函数。下面看几个例子。\n\nexample1：\n\n```c++\n\nclass base\n{\n\tpublic:\n\tint test(char x)\t{printf(\"base::test(char) %d \\n\", x);}\n\tvirtual int test(int x)\t{printf(\"base::test(int) %d \\n\", x);}\n\n};\n\n\n\nclass derived: public base\n{\n\tpublic:\n\tint test(char x)\t{printf(\"derived::test(char) %d \\n\", x);}\n\tint test(int x)\t\t{printf(\"derived::test(int) %d \\n\",x);}\n\tvirtual int test(float x){printf(\"derived::test(float) %f \\n\",x);}\n};\n\nint main(void)\n{\n\tderived obj;\n\tbase* \t pobj = &obj;\n\tderived* p2obj = &obj;\n\n\tpobj->test((char)(100));\t    //(1)\n\tp2obj->test((char)(100));\t    //(2)\n\t((derived*)pobj)->test((char)(100));//(5)\n\tpobj->test(100);\t\t    //(3)\n\tp2obj->test(100);\t\t    //(4)\n\n\treturn (0);\n}\n\n```\n\n输出：\n\n```shell\nbase::test(char) 100 \nderived::test(char) 100 \nderived::test(char) 100 \nderived::test(int) 100 \nderived::test(int) 100 \n```\n\n说明：Base类中，因参数类型不相同，两个test的关系为重载。derived类中三个test也为重载关系，其中derived的test(char)隐藏了基类test(char)，test(int)覆盖了基类虚函数virtual int test(int)的实现，也可以说在derived的虚函数表里面用自身的test(int)替换了继承而来的test(int)。\n\n+ 1 pobj->test((char)(100));参数类型为char，pobj类型为base*，基类test(char)与派生类test(char)的关系为派生类隐藏了基类函数。此时pobj指针类型为base*所以此时调用的是基类的test(char)函数，如果此时要调用派生类的test(char)，可以把pobj抢转为derived*类型如（5）所示。同理（2）调用的是derived中的函数。\n\n+ 2 在derived的虚函数表中，derived中test(int)覆盖了继承而来的base中test(int)函数。（3）用基类指针指向派生类，并调用被覆盖的虚函数，发生了动态绑定，显然调用的是派生类中的test(int)。至于（4）指针指向类型为drived*调用的也是test(int)函数。\n\nexample2：\n\n```c++\n\nclass Father  \n{  \npublic:  \n    void name(){cout<<\"Father name\"<<endl;}  \n    virtual void call(){cout<<\"Father call\"<<endl;}  \n};  \nclass Son:public Father  \n{  \npublic:  \n    void name(){cout<<\"Son name\"<<endl;}  \n    virtual void call(){cout<<\"Son call\"<<endl;}  \n};  \nint main()  \n{  \n    Son *s1 = new Son();  \n    Father *f1 = (Father *)s1;  \n    f1->call();  \t\t//son call    (1)\n    f1->name();  \t\t//father name (2)\n    ((Son*)f1)->call(); //son call    (3)\n    ((Son*)f1)->name(); //son name    (4)\n\n    Father *f2 = new Father();  \n    Son *s2 = (Son*)f2;  \n    s2->call();  \t\t//father call (5)\n    s2->name();  \t\t//son name    (6)\n    ((Father*)s2)->call();//father call(7)  \n    ((Father*)s2)->name();//father name(8)\n  \n    return 0;  \n}  \n\n```\n\n输出：\n\n```shell\nSon call\nFather name\nSon call\nSon name\nFather call\nSon name\nFather call\nFather name\n```\n\n说明：son中的name隐藏了father中的name，son中的call覆盖了father中的call。  \n(1)发生了动态绑定输出son call。  \n(2)指针类型是father*因此输出father name。  \n(3)动态绑定与指针实际指向的类型相关而与指针类型无关故输出son call。(4)由于当前指针类型为father*前面(2)输出father name，而这里把指针类型转为son*相当与把隐藏的name函数显式调用，因此输出son name。  \n(5)输出father call。  \n(6)输出son name。  \n(7)输出father call。  \n(8)输出father name。\n\n 小结：如果函数的关系为隐藏，则判别指针(引用)类型(->符号左边的类型)，根据指针类型决定调用的是哪个函数。如果函数关系为隐藏，则判断指针具体指向的类型，根据具体指向来判断调用的函数。","source":"_posts/浅析重载覆盖隐藏以及虚函数.md","raw":"---\ntitle: 浅析C++重载覆盖隐藏以及虚函数\ndate: 2013-09-21 13:06:10\ntags: c++\ncategories: server\n---\n\nC++里面重载覆盖隐藏的概念经常被提及，在很多C++测试题目里面也一直有遇到，每次做这类型的题目总感觉没有彻底搞清楚，故在这里做一个总结，以后遇到类似的问题能够轻易解决。首先来看看<<高质量C/C++编程指南>>作者对几个概念的描述:\n\n重载：\n（1）相同的范围（在同一个类中）；  \n（2）函数名字相同；  \n（3）参数不同；  \n（4）virtual关键字可有可无。  \n覆盖：\n（1）不同的范围（父子类中）  \n（2）函数名称相同  \n（3）参数相同  \n（4）基类必须有virtual关键字  \n隐藏：\n（1）如果派生类的函数与基类的函数同名，但是参数不同。此时，不论有无virtual关键字，基类的函数将被隐藏（注意别与重载混淆）。  \n（2）如果派生类的函数与基类的函数同名，并且参数也相同，但是基类函数没有virtual关键字。此时，基类的函数被隐藏（注意别与覆盖混淆）。  \n\n    重载发生在一个类中，覆盖发生在子类重新实现了父类的虚函数。一般来说，只要记住了重载和覆盖，遇到其他情况只要函数同名基本可以判定为隐藏。隐藏顾名思义就是还可以被找出来，而覆盖就不存在了。重载不能仅仅根据返回值不一致来区分两个重载函数。下面看几个例子。\n\nexample1：\n\n```c++\n\nclass base\n{\n\tpublic:\n\tint test(char x)\t{printf(\"base::test(char) %d \\n\", x);}\n\tvirtual int test(int x)\t{printf(\"base::test(int) %d \\n\", x);}\n\n};\n\n\n\nclass derived: public base\n{\n\tpublic:\n\tint test(char x)\t{printf(\"derived::test(char) %d \\n\", x);}\n\tint test(int x)\t\t{printf(\"derived::test(int) %d \\n\",x);}\n\tvirtual int test(float x){printf(\"derived::test(float) %f \\n\",x);}\n};\n\nint main(void)\n{\n\tderived obj;\n\tbase* \t pobj = &obj;\n\tderived* p2obj = &obj;\n\n\tpobj->test((char)(100));\t    //(1)\n\tp2obj->test((char)(100));\t    //(2)\n\t((derived*)pobj)->test((char)(100));//(5)\n\tpobj->test(100);\t\t    //(3)\n\tp2obj->test(100);\t\t    //(4)\n\n\treturn (0);\n}\n\n```\n\n输出：\n\n```shell\nbase::test(char) 100 \nderived::test(char) 100 \nderived::test(char) 100 \nderived::test(int) 100 \nderived::test(int) 100 \n```\n\n说明：Base类中，因参数类型不相同，两个test的关系为重载。derived类中三个test也为重载关系，其中derived的test(char)隐藏了基类test(char)，test(int)覆盖了基类虚函数virtual int test(int)的实现，也可以说在derived的虚函数表里面用自身的test(int)替换了继承而来的test(int)。\n\n+ 1 pobj->test((char)(100));参数类型为char，pobj类型为base*，基类test(char)与派生类test(char)的关系为派生类隐藏了基类函数。此时pobj指针类型为base*所以此时调用的是基类的test(char)函数，如果此时要调用派生类的test(char)，可以把pobj抢转为derived*类型如（5）所示。同理（2）调用的是derived中的函数。\n\n+ 2 在derived的虚函数表中，derived中test(int)覆盖了继承而来的base中test(int)函数。（3）用基类指针指向派生类，并调用被覆盖的虚函数，发生了动态绑定，显然调用的是派生类中的test(int)。至于（4）指针指向类型为drived*调用的也是test(int)函数。\n\nexample2：\n\n```c++\n\nclass Father  \n{  \npublic:  \n    void name(){cout<<\"Father name\"<<endl;}  \n    virtual void call(){cout<<\"Father call\"<<endl;}  \n};  \nclass Son:public Father  \n{  \npublic:  \n    void name(){cout<<\"Son name\"<<endl;}  \n    virtual void call(){cout<<\"Son call\"<<endl;}  \n};  \nint main()  \n{  \n    Son *s1 = new Son();  \n    Father *f1 = (Father *)s1;  \n    f1->call();  \t\t//son call    (1)\n    f1->name();  \t\t//father name (2)\n    ((Son*)f1)->call(); //son call    (3)\n    ((Son*)f1)->name(); //son name    (4)\n\n    Father *f2 = new Father();  \n    Son *s2 = (Son*)f2;  \n    s2->call();  \t\t//father call (5)\n    s2->name();  \t\t//son name    (6)\n    ((Father*)s2)->call();//father call(7)  \n    ((Father*)s2)->name();//father name(8)\n  \n    return 0;  \n}  \n\n```\n\n输出：\n\n```shell\nSon call\nFather name\nSon call\nSon name\nFather call\nSon name\nFather call\nFather name\n```\n\n说明：son中的name隐藏了father中的name，son中的call覆盖了father中的call。  \n(1)发生了动态绑定输出son call。  \n(2)指针类型是father*因此输出father name。  \n(3)动态绑定与指针实际指向的类型相关而与指针类型无关故输出son call。(4)由于当前指针类型为father*前面(2)输出father name，而这里把指针类型转为son*相当与把隐藏的name函数显式调用，因此输出son name。  \n(5)输出father call。  \n(6)输出son name。  \n(7)输出father call。  \n(8)输出father name。\n\n 小结：如果函数的关系为隐藏，则判别指针(引用)类型(->符号左边的类型)，根据指针类型决定调用的是哪个函数。如果函数关系为隐藏，则判断指针具体指向的类型，根据具体指向来判断调用的函数。","slug":"浅析重载覆盖隐藏以及虚函数","published":1,"updated":"2018-11-21T15:15:15.824Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cej0051y4zv6j3pmkrg","content":"<p>C++里面重载覆盖隐藏的概念经常被提及，在很多C++测试题目里面也一直有遇到，每次做这类型的题目总感觉没有彻底搞清楚，故在这里做一个总结，以后遇到类似的问题能够轻易解决。首先来看看&lt;&lt;高质量C/C++编程指南&gt;&gt;作者对几个概念的描述:</p>\n<p>重载：<br>（1）相同的范围（在同一个类中）；<br>（2）函数名字相同；<br>（3）参数不同；<br>（4）virtual关键字可有可无。<br>覆盖：<br>（1）不同的范围（父子类中）<br>（2）函数名称相同<br>（3）参数相同<br>（4）基类必须有virtual关键字<br>隐藏：<br>（1）如果派生类的函数与基类的函数同名，但是参数不同。此时，不论有无virtual关键字，基类的函数将被隐藏（注意别与重载混淆）。<br>（2）如果派生类的函数与基类的函数同名，并且参数也相同，但是基类函数没有virtual关键字。此时，基类的函数被隐藏（注意别与覆盖混淆）。  </p>\n<pre><code>重载发生在一个类中，覆盖发生在子类重新实现了父类的虚函数。一般来说，只要记住了重载和覆盖，遇到其他情况只要函数同名基本可以判定为隐藏。隐藏顾名思义就是还可以被找出来，而覆盖就不存在了。重载不能仅仅根据返回值不一致来区分两个重载函数。下面看几个例子。\n</code></pre><p>example1：</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">base</span></span></span><br><span class=\"line\"><span class=\"class\">&#123;</span></span><br><span class=\"line\">\t<span class=\"keyword\">public</span>:</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">test</span><span class=\"params\">(<span class=\"keyword\">char</span> x)</span>\t</span>&#123;<span class=\"built_in\">printf</span>(<span class=\"string\">\"base::test(char) %d \\n\"</span>, x);&#125;</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">virtual</span> <span class=\"keyword\">int</span> <span class=\"title\">test</span><span class=\"params\">(<span class=\"keyword\">int</span> x)</span>\t</span>&#123;<span class=\"built_in\">printf</span>(<span class=\"string\">\"base::test(int) %d \\n\"</span>, x);&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">derived</span>:</span> <span class=\"keyword\">public</span> base</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">public</span>:</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">test</span><span class=\"params\">(<span class=\"keyword\">char</span> x)</span>\t</span>&#123;<span class=\"built_in\">printf</span>(<span class=\"string\">\"derived::test(char) %d \\n\"</span>, x);&#125;</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">test</span><span class=\"params\">(<span class=\"keyword\">int</span> x)</span>\t\t</span>&#123;<span class=\"built_in\">printf</span>(<span class=\"string\">\"derived::test(int) %d \\n\"</span>,x);&#125;</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">virtual</span> <span class=\"keyword\">int</span> <span class=\"title\">test</span><span class=\"params\">(<span class=\"keyword\">float</span> x)</span></span>&#123;<span class=\"built_in\">printf</span>(<span class=\"string\">\"derived::test(float) %f \\n\"</span>,x);&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"keyword\">void</span>)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\tderived obj;</span><br><span class=\"line\">\tbase* \t pobj = &amp;obj;</span><br><span class=\"line\">\tderived* p2obj = &amp;obj;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpobj-&gt;test((<span class=\"keyword\">char</span>)(<span class=\"number\">100</span>));\t    <span class=\"comment\">//(1)</span></span><br><span class=\"line\">\tp2obj-&gt;test((<span class=\"keyword\">char</span>)(<span class=\"number\">100</span>));\t    <span class=\"comment\">//(2)</span></span><br><span class=\"line\">\t((derived*)pobj)-&gt;test((<span class=\"keyword\">char</span>)(<span class=\"number\">100</span>));<span class=\"comment\">//(5)</span></span><br><span class=\"line\">\tpobj-&gt;test(<span class=\"number\">100</span>);\t\t    <span class=\"comment\">//(3)</span></span><br><span class=\"line\">\tp2obj-&gt;test(<span class=\"number\">100</span>);\t\t    <span class=\"comment\">//(4)</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> (<span class=\"number\">0</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>输出：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">base::test(char) 100 </span><br><span class=\"line\">derived::test(char) 100 </span><br><span class=\"line\">derived::test(char) 100 </span><br><span class=\"line\">derived::test(int) 100 </span><br><span class=\"line\">derived::test(int) 100</span><br></pre></td></tr></table></figure>\n<p>说明：Base类中，因参数类型不相同，两个test的关系为重载。derived类中三个test也为重载关系，其中derived的test(char)隐藏了基类test(char)，test(int)覆盖了基类虚函数virtual int test(int)的实现，也可以说在derived的虚函数表里面用自身的test(int)替换了继承而来的test(int)。</p>\n<ul>\n<li><p>1 pobj-&gt;test((char)(100));参数类型为char，pobj类型为base<em>，基类test(char)与派生类test(char)的关系为派生类隐藏了基类函数。此时pobj指针类型为base</em>所以此时调用的是基类的test(char)函数，如果此时要调用派生类的test(char)，可以把pobj抢转为derived*类型如（5）所示。同理（2）调用的是derived中的函数。</p>\n</li>\n<li><p>2 在derived的虚函数表中，derived中test(int)覆盖了继承而来的base中test(int)函数。（3）用基类指针指向派生类，并调用被覆盖的虚函数，发生了动态绑定，显然调用的是派生类中的test(int)。至于（4）指针指向类型为drived*调用的也是test(int)函数。</p>\n</li>\n</ul>\n<p>example2：</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Father</span>  </span></span><br><span class=\"line\"><span class=\"class\">&#123;</span>  </span><br><span class=\"line\"><span class=\"keyword\">public</span>:  </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">name</span><span class=\"params\">()</span></span>&#123;<span class=\"built_in\">cout</span>&lt;&lt;<span class=\"string\">\"Father name\"</span>&lt;&lt;<span class=\"built_in\">endl</span>;&#125;  </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">virtual</span> <span class=\"keyword\">void</span> <span class=\"title\">call</span><span class=\"params\">()</span></span>&#123;<span class=\"built_in\">cout</span>&lt;&lt;<span class=\"string\">\"Father call\"</span>&lt;&lt;<span class=\"built_in\">endl</span>;&#125;  </span><br><span class=\"line\">&#125;;  </span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Son</span>:</span><span class=\"keyword\">public</span> Father  </span><br><span class=\"line\">&#123;  </span><br><span class=\"line\"><span class=\"keyword\">public</span>:  </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">name</span><span class=\"params\">()</span></span>&#123;<span class=\"built_in\">cout</span>&lt;&lt;<span class=\"string\">\"Son name\"</span>&lt;&lt;<span class=\"built_in\">endl</span>;&#125;  </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">virtual</span> <span class=\"keyword\">void</span> <span class=\"title\">call</span><span class=\"params\">()</span></span>&#123;<span class=\"built_in\">cout</span>&lt;&lt;<span class=\"string\">\"Son call\"</span>&lt;&lt;<span class=\"built_in\">endl</span>;&#125;  </span><br><span class=\"line\">&#125;;  </span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">main</span><span class=\"params\">()</span>  </span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;  </span><br><span class=\"line\">    Son *s1 = <span class=\"keyword\">new</span> Son();  </span><br><span class=\"line\">    Father *f1 = (Father *)s1;  </span><br><span class=\"line\">    f1-&gt;call();  \t\t<span class=\"comment\">//son call    (1)</span></span><br><span class=\"line\">    f1-&gt;name();  \t\t<span class=\"comment\">//father name (2)</span></span><br><span class=\"line\">    ((Son*)f1)-&gt;call(); <span class=\"comment\">//son call    (3)</span></span><br><span class=\"line\">    ((Son*)f1)-&gt;name(); <span class=\"comment\">//son name    (4)</span></span><br><span class=\"line\"></span><br><span class=\"line\">    Father *f2 = <span class=\"keyword\">new</span> Father();  </span><br><span class=\"line\">    Son *s2 = (Son*)f2;  </span><br><span class=\"line\">    s2-&gt;call();  \t\t<span class=\"comment\">//father call (5)</span></span><br><span class=\"line\">    s2-&gt;name();  \t\t<span class=\"comment\">//son name    (6)</span></span><br><span class=\"line\">    ((Father*)s2)-&gt;call();<span class=\"comment\">//father call(7)  </span></span><br><span class=\"line\">    ((Father*)s2)-&gt;name();<span class=\"comment\">//father name(8)</span></span><br><span class=\"line\">  </span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;  </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>输出：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Son call</span><br><span class=\"line\">Father name</span><br><span class=\"line\">Son call</span><br><span class=\"line\">Son name</span><br><span class=\"line\">Father call</span><br><span class=\"line\">Son name</span><br><span class=\"line\">Father call</span><br><span class=\"line\">Father name</span><br></pre></td></tr></table></figure>\n<p>说明：son中的name隐藏了father中的name，son中的call覆盖了father中的call。<br>(1)发生了动态绑定输出son call。<br>(2)指针类型是father<em>因此输出father name。<br>(3)动态绑定与指针实际指向的类型相关而与指针类型无关故输出son call。(4)由于当前指针类型为father</em>前面(2)输出father name，而这里把指针类型转为son*相当与把隐藏的name函数显式调用，因此输出son name。<br>(5)输出father call。<br>(6)输出son name。<br>(7)输出father call。<br>(8)输出father name。</p>\n<p> 小结：如果函数的关系为隐藏，则判别指针(引用)类型(-&gt;符号左边的类型)，根据指针类型决定调用的是哪个函数。如果函数关系为隐藏，则判断指针具体指向的类型，根据具体指向来判断调用的函数。</p>\n","site":{"data":{}},"excerpt":"","more":"<p>C++里面重载覆盖隐藏的概念经常被提及，在很多C++测试题目里面也一直有遇到，每次做这类型的题目总感觉没有彻底搞清楚，故在这里做一个总结，以后遇到类似的问题能够轻易解决。首先来看看&lt;&lt;高质量C/C++编程指南&gt;&gt;作者对几个概念的描述:</p>\n<p>重载：<br>（1）相同的范围（在同一个类中）；<br>（2）函数名字相同；<br>（3）参数不同；<br>（4）virtual关键字可有可无。<br>覆盖：<br>（1）不同的范围（父子类中）<br>（2）函数名称相同<br>（3）参数相同<br>（4）基类必须有virtual关键字<br>隐藏：<br>（1）如果派生类的函数与基类的函数同名，但是参数不同。此时，不论有无virtual关键字，基类的函数将被隐藏（注意别与重载混淆）。<br>（2）如果派生类的函数与基类的函数同名，并且参数也相同，但是基类函数没有virtual关键字。此时，基类的函数被隐藏（注意别与覆盖混淆）。  </p>\n<pre><code>重载发生在一个类中，覆盖发生在子类重新实现了父类的虚函数。一般来说，只要记住了重载和覆盖，遇到其他情况只要函数同名基本可以判定为隐藏。隐藏顾名思义就是还可以被找出来，而覆盖就不存在了。重载不能仅仅根据返回值不一致来区分两个重载函数。下面看几个例子。\n</code></pre><p>example1：</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">base</span></span></span><br><span class=\"line\"><span class=\"class\">&#123;</span></span><br><span class=\"line\">\t<span class=\"keyword\">public</span>:</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">test</span><span class=\"params\">(<span class=\"keyword\">char</span> x)</span>\t</span>&#123;<span class=\"built_in\">printf</span>(<span class=\"string\">\"base::test(char) %d \\n\"</span>, x);&#125;</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">virtual</span> <span class=\"keyword\">int</span> <span class=\"title\">test</span><span class=\"params\">(<span class=\"keyword\">int</span> x)</span>\t</span>&#123;<span class=\"built_in\">printf</span>(<span class=\"string\">\"base::test(int) %d \\n\"</span>, x);&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">derived</span>:</span> <span class=\"keyword\">public</span> base</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">public</span>:</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">test</span><span class=\"params\">(<span class=\"keyword\">char</span> x)</span>\t</span>&#123;<span class=\"built_in\">printf</span>(<span class=\"string\">\"derived::test(char) %d \\n\"</span>, x);&#125;</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">test</span><span class=\"params\">(<span class=\"keyword\">int</span> x)</span>\t\t</span>&#123;<span class=\"built_in\">printf</span>(<span class=\"string\">\"derived::test(int) %d \\n\"</span>,x);&#125;</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">virtual</span> <span class=\"keyword\">int</span> <span class=\"title\">test</span><span class=\"params\">(<span class=\"keyword\">float</span> x)</span></span>&#123;<span class=\"built_in\">printf</span>(<span class=\"string\">\"derived::test(float) %f \\n\"</span>,x);&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"keyword\">void</span>)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\tderived obj;</span><br><span class=\"line\">\tbase* \t pobj = &amp;obj;</span><br><span class=\"line\">\tderived* p2obj = &amp;obj;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpobj-&gt;test((<span class=\"keyword\">char</span>)(<span class=\"number\">100</span>));\t    <span class=\"comment\">//(1)</span></span><br><span class=\"line\">\tp2obj-&gt;test((<span class=\"keyword\">char</span>)(<span class=\"number\">100</span>));\t    <span class=\"comment\">//(2)</span></span><br><span class=\"line\">\t((derived*)pobj)-&gt;test((<span class=\"keyword\">char</span>)(<span class=\"number\">100</span>));<span class=\"comment\">//(5)</span></span><br><span class=\"line\">\tpobj-&gt;test(<span class=\"number\">100</span>);\t\t    <span class=\"comment\">//(3)</span></span><br><span class=\"line\">\tp2obj-&gt;test(<span class=\"number\">100</span>);\t\t    <span class=\"comment\">//(4)</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> (<span class=\"number\">0</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>输出：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">base::test(char) 100 </span><br><span class=\"line\">derived::test(char) 100 </span><br><span class=\"line\">derived::test(char) 100 </span><br><span class=\"line\">derived::test(int) 100 </span><br><span class=\"line\">derived::test(int) 100</span><br></pre></td></tr></table></figure>\n<p>说明：Base类中，因参数类型不相同，两个test的关系为重载。derived类中三个test也为重载关系，其中derived的test(char)隐藏了基类test(char)，test(int)覆盖了基类虚函数virtual int test(int)的实现，也可以说在derived的虚函数表里面用自身的test(int)替换了继承而来的test(int)。</p>\n<ul>\n<li><p>1 pobj-&gt;test((char)(100));参数类型为char，pobj类型为base<em>，基类test(char)与派生类test(char)的关系为派生类隐藏了基类函数。此时pobj指针类型为base</em>所以此时调用的是基类的test(char)函数，如果此时要调用派生类的test(char)，可以把pobj抢转为derived*类型如（5）所示。同理（2）调用的是derived中的函数。</p>\n</li>\n<li><p>2 在derived的虚函数表中，derived中test(int)覆盖了继承而来的base中test(int)函数。（3）用基类指针指向派生类，并调用被覆盖的虚函数，发生了动态绑定，显然调用的是派生类中的test(int)。至于（4）指针指向类型为drived*调用的也是test(int)函数。</p>\n</li>\n</ul>\n<p>example2：</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Father</span>  </span></span><br><span class=\"line\"><span class=\"class\">&#123;</span>  </span><br><span class=\"line\"><span class=\"keyword\">public</span>:  </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">name</span><span class=\"params\">()</span></span>&#123;<span class=\"built_in\">cout</span>&lt;&lt;<span class=\"string\">\"Father name\"</span>&lt;&lt;<span class=\"built_in\">endl</span>;&#125;  </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">virtual</span> <span class=\"keyword\">void</span> <span class=\"title\">call</span><span class=\"params\">()</span></span>&#123;<span class=\"built_in\">cout</span>&lt;&lt;<span class=\"string\">\"Father call\"</span>&lt;&lt;<span class=\"built_in\">endl</span>;&#125;  </span><br><span class=\"line\">&#125;;  </span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Son</span>:</span><span class=\"keyword\">public</span> Father  </span><br><span class=\"line\">&#123;  </span><br><span class=\"line\"><span class=\"keyword\">public</span>:  </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">name</span><span class=\"params\">()</span></span>&#123;<span class=\"built_in\">cout</span>&lt;&lt;<span class=\"string\">\"Son name\"</span>&lt;&lt;<span class=\"built_in\">endl</span>;&#125;  </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">virtual</span> <span class=\"keyword\">void</span> <span class=\"title\">call</span><span class=\"params\">()</span></span>&#123;<span class=\"built_in\">cout</span>&lt;&lt;<span class=\"string\">\"Son call\"</span>&lt;&lt;<span class=\"built_in\">endl</span>;&#125;  </span><br><span class=\"line\">&#125;;  </span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">main</span><span class=\"params\">()</span>  </span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;  </span><br><span class=\"line\">    Son *s1 = <span class=\"keyword\">new</span> Son();  </span><br><span class=\"line\">    Father *f1 = (Father *)s1;  </span><br><span class=\"line\">    f1-&gt;call();  \t\t<span class=\"comment\">//son call    (1)</span></span><br><span class=\"line\">    f1-&gt;name();  \t\t<span class=\"comment\">//father name (2)</span></span><br><span class=\"line\">    ((Son*)f1)-&gt;call(); <span class=\"comment\">//son call    (3)</span></span><br><span class=\"line\">    ((Son*)f1)-&gt;name(); <span class=\"comment\">//son name    (4)</span></span><br><span class=\"line\"></span><br><span class=\"line\">    Father *f2 = <span class=\"keyword\">new</span> Father();  </span><br><span class=\"line\">    Son *s2 = (Son*)f2;  </span><br><span class=\"line\">    s2-&gt;call();  \t\t<span class=\"comment\">//father call (5)</span></span><br><span class=\"line\">    s2-&gt;name();  \t\t<span class=\"comment\">//son name    (6)</span></span><br><span class=\"line\">    ((Father*)s2)-&gt;call();<span class=\"comment\">//father call(7)  </span></span><br><span class=\"line\">    ((Father*)s2)-&gt;name();<span class=\"comment\">//father name(8)</span></span><br><span class=\"line\">  </span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;  </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>输出：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Son call</span><br><span class=\"line\">Father name</span><br><span class=\"line\">Son call</span><br><span class=\"line\">Son name</span><br><span class=\"line\">Father call</span><br><span class=\"line\">Son name</span><br><span class=\"line\">Father call</span><br><span class=\"line\">Father name</span><br></pre></td></tr></table></figure>\n<p>说明：son中的name隐藏了father中的name，son中的call覆盖了father中的call。<br>(1)发生了动态绑定输出son call。<br>(2)指针类型是father<em>因此输出father name。<br>(3)动态绑定与指针实际指向的类型相关而与指针类型无关故输出son call。(4)由于当前指针类型为father</em>前面(2)输出father name，而这里把指针类型转为son*相当与把隐藏的name函数显式调用，因此输出son name。<br>(5)输出father call。<br>(6)输出son name。<br>(7)输出father call。<br>(8)输出father name。</p>\n<p> 小结：如果函数的关系为隐藏，则判别指针(引用)类型(-&gt;符号左边的类型)，根据指针类型决定调用的是哪个函数。如果函数关系为隐藏，则判断指针具体指向的类型，根据具体指向来判断调用的函数。</p>\n"},{"title":"用户系统密码安全","date":"2018-05-27T05:46:30.000Z","_content":"\n最近闲着没事，看了几篇关于账户安全方面的文章。之前也听说过`CSDN`被脱裤事件。回过头翻开之前写的代码，看看自己设计的账户系统，确实包含了多处安全隐患。对于如何良好的保障用户密码安全，在这里做一个总结，方便日后查阅。\n\n---\n\n>开门见山，保障密码安全方式：哈希和加盐。\n\n## 哈希\n\n哈希算法是一种摘要算法，根据原始数据得出一个摘要信息，这种算法是不可逆的，即：正常情况下，通过摘要信息无法反向得出原始数据。\n\n哈希算法通常分成两类：一、普通散列表使用的哈希算法，也称为快速哈希算法，如：MD5、SHA1、SHA256等。二、用于密码摘要的慢哈希函数`Slow Hash Function`，这种哈希算法主要为了降低常见密码攻击的效率而设计的。终极目标是使哈希函数的速度慢到足以令攻击者放弃，但由此造成的延迟又不至于引起用户的注意。如：Argon2、 bcrypt 、 scrypt 或 PBKDF2。\n\n## 加盐\n\n对原始密码加盐是一种有效的防止常见密码攻击的方式。关于加盐的具体工作原理，请参考[盐](https://zh.wikipedia.org/wiki/%E7%9B%90_(%E5%AF%86%E7%A0%81%E5%AD%A6))。需要注意的是，即使你知道要对密码加盐，还是有几个需要注意的点。\n\n### 不要重复使用盐\n\n使用重复的盐和不使用盐的效果几乎是一样的。使用重复的盐，攻击者一样可以\b轻松的构造出查找表，轻松攻破你的系统。\n\n### 使用安全的盐\n\n既然不能使用相同的盐，那么就需要给每个用户配置不同的盐，这个时候我们会想到随机函数，如：`crypto.getRandomBytes`、`Math.random`等函数。但是这些函数都不是安全可靠的。盐值应该使用加密的安全伪随机数生成器（ Cryptographically Secure Pseudo-Random Number Generator，CSPRNG ）产生。在`Node.js`环境下，可以选择的方案有：\n+ [uuidv4](https://www.npmjs.com/package/uuid)\n\n+ 专用的库\n[csprng](https://www.npmjs.com/package/random-number-csprng)\n\n既然我们了解了密码哈希函数和加盐的基本规则，让我们总结一下账户系统用户注册和登陆的流程：\n\n+ 用户注册\n\n1. 用户输入用户名密码发送到服务器\n2. 服务器对用户密码加盐，哈希之后\n3. 把哈希值同盐一起保存到数据库\n\n+ 用户登陆\n\n1. 从数据库取出用户对应的哈希和盐值\n2. 把用户输入的密码加入数据库取出的盐计算哈希值\n3. 对比第二步计算的哈希值和数据库取出的哈希值，如果相等则认为密码正确，反之认为密码错误。\n\n---\n\n下面了解几个常见的\b密码破解方式，这样对上面的几个保障密码安全的方式有更加深入的理解。\n\n>常见的攻击方式：暴力破解、字典攻击、查找表等。\n\n## 暴力破解\n\n顾名思义就是用穷举的方式一一匹配看看密码是否正确。\n\n## 字典攻击\n\n字典攻击使用包含单词、短语、常用密码和其他可能用做密码的字符串的字典文件。对文件中的每个词都进行哈希加密，将这些哈希值和要破解的密码哈希值比较。如果它们相同，这个词就是密码。字典文件是通过大段文本中提取的单词构成，甚至还包括一些数据库中真实的密码。\n\n## 查找表\n\n对于破解相同类型的哈希值，查表法是一种非常高效的方式。主要理念是预先计算（ pre-compute）出密码字典中的每个密码的哈希值，然后把他们相应的密码存储到一个表里。一个设计良好的查询表结构，即使包含了数十亿个哈希值，仍然可以实现每秒钟查询数百次哈希。\n\n---\n\n>其他安全方面的考量\n\n+ 1. 永远不要告诉用户输错的究竟是用户名还是密码\n>就像通用的提示那样，始终显示：“无效的用户名或密码。”就行了。这样可以防止攻击者在不知道密码的情况下枚举出有效的用户名。\n\n+ 2. 避免明文密码传输\n>避免明文传输的方式一般有：一、非对称加密，客户端用公钥加密，服务器端用私钥解密。二、`HTTPS`，在目前的环境下上`HTTPS`或许是最便捷的方式了。\n\n---\n\n参考文献：\n\n[1][如何正确对用户密码进行加密](http://www.infoq.com/cn/articles/how-to-encrypt-the-user-password-correctly)  \n[2][Secure random values (in Node.js)](https://gist.github.com/joepie91/7105003c3b26e65efcea63f3db82dfba)","source":"_posts/用户系统密码安全.md","raw":"---\ntitle: 用户系统密码安全\ncategories: server\ndate: 2018-05-27 13:46:30\ntags:\n  - password\n  - crypto\n---\n\n最近闲着没事，看了几篇关于账户安全方面的文章。之前也听说过`CSDN`被脱裤事件。回过头翻开之前写的代码，看看自己设计的账户系统，确实包含了多处安全隐患。对于如何良好的保障用户密码安全，在这里做一个总结，方便日后查阅。\n\n---\n\n>开门见山，保障密码安全方式：哈希和加盐。\n\n## 哈希\n\n哈希算法是一种摘要算法，根据原始数据得出一个摘要信息，这种算法是不可逆的，即：正常情况下，通过摘要信息无法反向得出原始数据。\n\n哈希算法通常分成两类：一、普通散列表使用的哈希算法，也称为快速哈希算法，如：MD5、SHA1、SHA256等。二、用于密码摘要的慢哈希函数`Slow Hash Function`，这种哈希算法主要为了降低常见密码攻击的效率而设计的。终极目标是使哈希函数的速度慢到足以令攻击者放弃，但由此造成的延迟又不至于引起用户的注意。如：Argon2、 bcrypt 、 scrypt 或 PBKDF2。\n\n## 加盐\n\n对原始密码加盐是一种有效的防止常见密码攻击的方式。关于加盐的具体工作原理，请参考[盐](https://zh.wikipedia.org/wiki/%E7%9B%90_(%E5%AF%86%E7%A0%81%E5%AD%A6))。需要注意的是，即使你知道要对密码加盐，还是有几个需要注意的点。\n\n### 不要重复使用盐\n\n使用重复的盐和不使用盐的效果几乎是一样的。使用重复的盐，攻击者一样可以\b轻松的构造出查找表，轻松攻破你的系统。\n\n### 使用安全的盐\n\n既然不能使用相同的盐，那么就需要给每个用户配置不同的盐，这个时候我们会想到随机函数，如：`crypto.getRandomBytes`、`Math.random`等函数。但是这些函数都不是安全可靠的。盐值应该使用加密的安全伪随机数生成器（ Cryptographically Secure Pseudo-Random Number Generator，CSPRNG ）产生。在`Node.js`环境下，可以选择的方案有：\n+ [uuidv4](https://www.npmjs.com/package/uuid)\n\n+ 专用的库\n[csprng](https://www.npmjs.com/package/random-number-csprng)\n\n既然我们了解了密码哈希函数和加盐的基本规则，让我们总结一下账户系统用户注册和登陆的流程：\n\n+ 用户注册\n\n1. 用户输入用户名密码发送到服务器\n2. 服务器对用户密码加盐，哈希之后\n3. 把哈希值同盐一起保存到数据库\n\n+ 用户登陆\n\n1. 从数据库取出用户对应的哈希和盐值\n2. 把用户输入的密码加入数据库取出的盐计算哈希值\n3. 对比第二步计算的哈希值和数据库取出的哈希值，如果相等则认为密码正确，反之认为密码错误。\n\n---\n\n下面了解几个常见的\b密码破解方式，这样对上面的几个保障密码安全的方式有更加深入的理解。\n\n>常见的攻击方式：暴力破解、字典攻击、查找表等。\n\n## 暴力破解\n\n顾名思义就是用穷举的方式一一匹配看看密码是否正确。\n\n## 字典攻击\n\n字典攻击使用包含单词、短语、常用密码和其他可能用做密码的字符串的字典文件。对文件中的每个词都进行哈希加密，将这些哈希值和要破解的密码哈希值比较。如果它们相同，这个词就是密码。字典文件是通过大段文本中提取的单词构成，甚至还包括一些数据库中真实的密码。\n\n## 查找表\n\n对于破解相同类型的哈希值，查表法是一种非常高效的方式。主要理念是预先计算（ pre-compute）出密码字典中的每个密码的哈希值，然后把他们相应的密码存储到一个表里。一个设计良好的查询表结构，即使包含了数十亿个哈希值，仍然可以实现每秒钟查询数百次哈希。\n\n---\n\n>其他安全方面的考量\n\n+ 1. 永远不要告诉用户输错的究竟是用户名还是密码\n>就像通用的提示那样，始终显示：“无效的用户名或密码。”就行了。这样可以防止攻击者在不知道密码的情况下枚举出有效的用户名。\n\n+ 2. 避免明文密码传输\n>避免明文传输的方式一般有：一、非对称加密，客户端用公钥加密，服务器端用私钥解密。二、`HTTPS`，在目前的环境下上`HTTPS`或许是最便捷的方式了。\n\n---\n\n参考文献：\n\n[1][如何正确对用户密码进行加密](http://www.infoq.com/cn/articles/how-to-encrypt-the-user-password-correctly)  \n[2][Secure random values (in Node.js)](https://gist.github.com/joepie91/7105003c3b26e65efcea63f3db82dfba)","slug":"用户系统密码安全","published":1,"updated":"2018-07-01T10:30:46.499Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cel0054y4zvhlbulaer","content":"<p>最近闲着没事，看了几篇关于账户安全方面的文章。之前也听说过<code>CSDN</code>被脱裤事件。回过头翻开之前写的代码，看看自己设计的账户系统，确实包含了多处安全隐患。对于如何良好的保障用户密码安全，在这里做一个总结，方便日后查阅。</p>\n<hr>\n<blockquote>\n<p>开门见山，保障密码安全方式：哈希和加盐。</p>\n</blockquote>\n<h2 id=\"哈希\"><a href=\"#哈希\" class=\"headerlink\" title=\"哈希\"></a>哈希</h2><p>哈希算法是一种摘要算法，根据原始数据得出一个摘要信息，这种算法是不可逆的，即：正常情况下，通过摘要信息无法反向得出原始数据。</p>\n<p>哈希算法通常分成两类：一、普通散列表使用的哈希算法，也称为快速哈希算法，如：MD5、SHA1、SHA256等。二、用于密码摘要的慢哈希函数<code>Slow Hash Function</code>，这种哈希算法主要为了降低常见密码攻击的效率而设计的。终极目标是使哈希函数的速度慢到足以令攻击者放弃，但由此造成的延迟又不至于引起用户的注意。如：Argon2、 bcrypt 、 scrypt 或 PBKDF2。</p>\n<h2 id=\"加盐\"><a href=\"#加盐\" class=\"headerlink\" title=\"加盐\"></a>加盐</h2><p>对原始密码加盐是一种有效的防止常见密码攻击的方式。关于加盐的具体工作原理，请参考<a href=\"https://zh.wikipedia.org/wiki/%E7%9B%90_(%E5%AF%86%E7%A0%81%E5%AD%A6\" target=\"_blank\" rel=\"noopener\">盐</a>)。需要注意的是，即使你知道要对密码加盐，还是有几个需要注意的点。</p>\n<h3 id=\"不要重复使用盐\"><a href=\"#不要重复使用盐\" class=\"headerlink\" title=\"不要重复使用盐\"></a>不要重复使用盐</h3><p>使用重复的盐和不使用盐的效果几乎是一样的。使用重复的盐，攻击者一样可以\b轻松的构造出查找表，轻松攻破你的系统。</p>\n<h3 id=\"使用安全的盐\"><a href=\"#使用安全的盐\" class=\"headerlink\" title=\"使用安全的盐\"></a>使用安全的盐</h3><p>既然不能使用相同的盐，那么就需要给每个用户配置不同的盐，这个时候我们会想到随机函数，如：<code>crypto.getRandomBytes</code>、<code>Math.random</code>等函数。但是这些函数都不是安全可靠的。盐值应该使用加密的安全伪随机数生成器（ Cryptographically Secure Pseudo-Random Number Generator，CSPRNG ）产生。在<code>Node.js</code>环境下，可以选择的方案有：</p>\n<ul>\n<li><p><a href=\"https://www.npmjs.com/package/uuid\" target=\"_blank\" rel=\"noopener\">uuidv4</a></p>\n</li>\n<li><p>专用的库<br><a href=\"https://www.npmjs.com/package/random-number-csprng\" target=\"_blank\" rel=\"noopener\">csprng</a></p>\n</li>\n</ul>\n<p>既然我们了解了密码哈希函数和加盐的基本规则，让我们总结一下账户系统用户注册和登陆的流程：</p>\n<ul>\n<li>用户注册</li>\n</ul>\n<ol>\n<li>用户输入用户名密码发送到服务器</li>\n<li>服务器对用户密码加盐，哈希之后</li>\n<li>把哈希值同盐一起保存到数据库</li>\n</ol>\n<ul>\n<li>用户登陆</li>\n</ul>\n<ol>\n<li>从数据库取出用户对应的哈希和盐值</li>\n<li>把用户输入的密码加入数据库取出的盐计算哈希值</li>\n<li>对比第二步计算的哈希值和数据库取出的哈希值，如果相等则认为密码正确，反之认为密码错误。</li>\n</ol>\n<hr>\n<p>下面了解几个常见的\b密码破解方式，这样对上面的几个保障密码安全的方式有更加深入的理解。</p>\n<blockquote>\n<p>常见的攻击方式：暴力破解、字典攻击、查找表等。</p>\n</blockquote>\n<h2 id=\"暴力破解\"><a href=\"#暴力破解\" class=\"headerlink\" title=\"暴力破解\"></a>暴力破解</h2><p>顾名思义就是用穷举的方式一一匹配看看密码是否正确。</p>\n<h2 id=\"字典攻击\"><a href=\"#字典攻击\" class=\"headerlink\" title=\"字典攻击\"></a>字典攻击</h2><p>字典攻击使用包含单词、短语、常用密码和其他可能用做密码的字符串的字典文件。对文件中的每个词都进行哈希加密，将这些哈希值和要破解的密码哈希值比较。如果它们相同，这个词就是密码。字典文件是通过大段文本中提取的单词构成，甚至还包括一些数据库中真实的密码。</p>\n<h2 id=\"查找表\"><a href=\"#查找表\" class=\"headerlink\" title=\"查找表\"></a>查找表</h2><p>对于破解相同类型的哈希值，查表法是一种非常高效的方式。主要理念是预先计算（ pre-compute）出密码字典中的每个密码的哈希值，然后把他们相应的密码存储到一个表里。一个设计良好的查询表结构，即使包含了数十亿个哈希值，仍然可以实现每秒钟查询数百次哈希。</p>\n<hr>\n<blockquote>\n<p>其他安全方面的考量</p>\n</blockquote>\n<ul>\n<li><ol>\n<li>永远不要告诉用户输错的究竟是用户名还是密码<blockquote>\n<p>就像通用的提示那样，始终显示：“无效的用户名或密码。”就行了。这样可以防止攻击者在不知道密码的情况下枚举出有效的用户名。</p>\n</blockquote>\n</li>\n</ol>\n</li>\n<li><ol start=\"2\">\n<li>避免明文密码传输<blockquote>\n<p>避免明文传输的方式一般有：一、非对称加密，客户端用公钥加密，服务器端用私钥解密。二、<code>HTTPS</code>，在目前的环境下上<code>HTTPS</code>或许是最便捷的方式了。</p>\n</blockquote>\n</li>\n</ol>\n</li>\n</ul>\n<hr>\n<p>参考文献：</p>\n<p>[1]<a href=\"http://www.infoq.com/cn/articles/how-to-encrypt-the-user-password-correctly\" target=\"_blank\" rel=\"noopener\">如何正确对用户密码进行加密</a><br>[2]<a href=\"https://gist.github.com/joepie91/7105003c3b26e65efcea63f3db82dfba\" target=\"_blank\" rel=\"noopener\">Secure random values (in Node.js)</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p>最近闲着没事，看了几篇关于账户安全方面的文章。之前也听说过<code>CSDN</code>被脱裤事件。回过头翻开之前写的代码，看看自己设计的账户系统，确实包含了多处安全隐患。对于如何良好的保障用户密码安全，在这里做一个总结，方便日后查阅。</p>\n<hr>\n<blockquote>\n<p>开门见山，保障密码安全方式：哈希和加盐。</p>\n</blockquote>\n<h2 id=\"哈希\"><a href=\"#哈希\" class=\"headerlink\" title=\"哈希\"></a>哈希</h2><p>哈希算法是一种摘要算法，根据原始数据得出一个摘要信息，这种算法是不可逆的，即：正常情况下，通过摘要信息无法反向得出原始数据。</p>\n<p>哈希算法通常分成两类：一、普通散列表使用的哈希算法，也称为快速哈希算法，如：MD5、SHA1、SHA256等。二、用于密码摘要的慢哈希函数<code>Slow Hash Function</code>，这种哈希算法主要为了降低常见密码攻击的效率而设计的。终极目标是使哈希函数的速度慢到足以令攻击者放弃，但由此造成的延迟又不至于引起用户的注意。如：Argon2、 bcrypt 、 scrypt 或 PBKDF2。</p>\n<h2 id=\"加盐\"><a href=\"#加盐\" class=\"headerlink\" title=\"加盐\"></a>加盐</h2><p>对原始密码加盐是一种有效的防止常见密码攻击的方式。关于加盐的具体工作原理，请参考<a href=\"https://zh.wikipedia.org/wiki/%E7%9B%90_(%E5%AF%86%E7%A0%81%E5%AD%A6\" target=\"_blank\" rel=\"noopener\">盐</a>)。需要注意的是，即使你知道要对密码加盐，还是有几个需要注意的点。</p>\n<h3 id=\"不要重复使用盐\"><a href=\"#不要重复使用盐\" class=\"headerlink\" title=\"不要重复使用盐\"></a>不要重复使用盐</h3><p>使用重复的盐和不使用盐的效果几乎是一样的。使用重复的盐，攻击者一样可以\b轻松的构造出查找表，轻松攻破你的系统。</p>\n<h3 id=\"使用安全的盐\"><a href=\"#使用安全的盐\" class=\"headerlink\" title=\"使用安全的盐\"></a>使用安全的盐</h3><p>既然不能使用相同的盐，那么就需要给每个用户配置不同的盐，这个时候我们会想到随机函数，如：<code>crypto.getRandomBytes</code>、<code>Math.random</code>等函数。但是这些函数都不是安全可靠的。盐值应该使用加密的安全伪随机数生成器（ Cryptographically Secure Pseudo-Random Number Generator，CSPRNG ）产生。在<code>Node.js</code>环境下，可以选择的方案有：</p>\n<ul>\n<li><p><a href=\"https://www.npmjs.com/package/uuid\" target=\"_blank\" rel=\"noopener\">uuidv4</a></p>\n</li>\n<li><p>专用的库<br><a href=\"https://www.npmjs.com/package/random-number-csprng\" target=\"_blank\" rel=\"noopener\">csprng</a></p>\n</li>\n</ul>\n<p>既然我们了解了密码哈希函数和加盐的基本规则，让我们总结一下账户系统用户注册和登陆的流程：</p>\n<ul>\n<li>用户注册</li>\n</ul>\n<ol>\n<li>用户输入用户名密码发送到服务器</li>\n<li>服务器对用户密码加盐，哈希之后</li>\n<li>把哈希值同盐一起保存到数据库</li>\n</ol>\n<ul>\n<li>用户登陆</li>\n</ul>\n<ol>\n<li>从数据库取出用户对应的哈希和盐值</li>\n<li>把用户输入的密码加入数据库取出的盐计算哈希值</li>\n<li>对比第二步计算的哈希值和数据库取出的哈希值，如果相等则认为密码正确，反之认为密码错误。</li>\n</ol>\n<hr>\n<p>下面了解几个常见的\b密码破解方式，这样对上面的几个保障密码安全的方式有更加深入的理解。</p>\n<blockquote>\n<p>常见的攻击方式：暴力破解、字典攻击、查找表等。</p>\n</blockquote>\n<h2 id=\"暴力破解\"><a href=\"#暴力破解\" class=\"headerlink\" title=\"暴力破解\"></a>暴力破解</h2><p>顾名思义就是用穷举的方式一一匹配看看密码是否正确。</p>\n<h2 id=\"字典攻击\"><a href=\"#字典攻击\" class=\"headerlink\" title=\"字典攻击\"></a>字典攻击</h2><p>字典攻击使用包含单词、短语、常用密码和其他可能用做密码的字符串的字典文件。对文件中的每个词都进行哈希加密，将这些哈希值和要破解的密码哈希值比较。如果它们相同，这个词就是密码。字典文件是通过大段文本中提取的单词构成，甚至还包括一些数据库中真实的密码。</p>\n<h2 id=\"查找表\"><a href=\"#查找表\" class=\"headerlink\" title=\"查找表\"></a>查找表</h2><p>对于破解相同类型的哈希值，查表法是一种非常高效的方式。主要理念是预先计算（ pre-compute）出密码字典中的每个密码的哈希值，然后把他们相应的密码存储到一个表里。一个设计良好的查询表结构，即使包含了数十亿个哈希值，仍然可以实现每秒钟查询数百次哈希。</p>\n<hr>\n<blockquote>\n<p>其他安全方面的考量</p>\n</blockquote>\n<ul>\n<li><ol>\n<li>永远不要告诉用户输错的究竟是用户名还是密码<blockquote>\n<p>就像通用的提示那样，始终显示：“无效的用户名或密码。”就行了。这样可以防止攻击者在不知道密码的情况下枚举出有效的用户名。</p>\n</blockquote>\n</li>\n</ol>\n</li>\n<li><ol start=\"2\">\n<li>避免明文密码传输<blockquote>\n<p>避免明文传输的方式一般有：一、非对称加密，客户端用公钥加密，服务器端用私钥解密。二、<code>HTTPS</code>，在目前的环境下上<code>HTTPS</code>或许是最便捷的方式了。</p>\n</blockquote>\n</li>\n</ol>\n</li>\n</ul>\n<hr>\n<p>参考文献：</p>\n<p>[1]<a href=\"http://www.infoq.com/cn/articles/how-to-encrypt-the-user-password-correctly\" target=\"_blank\" rel=\"noopener\">如何正确对用户密码进行加密</a><br>[2]<a href=\"https://gist.github.com/joepie91/7105003c3b26e65efcea63f3db82dfba\" target=\"_blank\" rel=\"noopener\">Secure random values (in Node.js)</a></p>\n"},{"title":"译-视觉格式化模型的细节","date":"2016-09-05T05:21:15.000Z","_content":"\n# 123\n\n## 包含块的定义\n\n元素位置以及尺寸的计算有时候涉及到一个固定的矩形，这个矩形称之为元素的`包含块`。元素的包含块定义如下：\n\n- 1、`根元素`所在的包含块是一个矩形，称之为：初始包含块。对于连续介质或页面媒体，有包含尺寸大小的视口，锚定在画布的初始位置。初始包含块的方向属性等同于根元素。\n\n- 2、对于其他元素，如果元素的`position`属性是`relative`或`static`,那么它的包含块被放置在最近的块容器祖先盒子的内容区边缘。\n\n- 3、如果元素的`position`属性设置为`fixed`，那么它的包含块依据在连续介质的情况下或在页面媒体的情况下的页区域的视口来建立。\n\n- 4、如果元素的`position`属性设置为`absolute`，那么它的包含块依据最近的，且`positon`属性被设置为`absolute`、`relative`、`fixed`,的祖先来建立。步骤如下：\n\n  - 1、如果祖先是一个行内元素，那么它的包含块是一个边界盒子包围第一个以及最后一个元素的内边距。在`CSS2.1`,如果行内元素跨多行，那么其包含块是未定义的。\n  - 2、否则，包含块根据其祖先的`padding edge`来格式化。\n  - 3、如果没有找到这样的祖先元素，那么其包含块就是最初的包含块。\n\n在页面媒体下，一个绝对定位元素的位置关联到它的包含块，忽略任何的分页(好像页面是连续的)，元素可能被分到多个页面。\n\n对于绝对定位的内容，被解析到页面的某个位置，而不是页面被布局的位置，或者解析到当前已经被渲染或者打印的页面，打印机或许会放置内容。\n\n- 当前页面的其他位置\n- 在随后的页面，或者\n- 省略它\n\n>注意：一个块级元素超过了多个页或许会在不同的页有不同的宽度，或许会设备自身的限制。\n\n\n\n```html\n<!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01//EN\">\n<HTML>\n   <HEAD>\n      <TITLE>Illustration of containing blocks</TITLE>\n   </HEAD>\n   <BODY id=\"body\">\n      <DIV id=\"div1\">\n      <P id=\"p1\">This is text in the first paragraph...</P>\n      <P id=\"p2\">This is text <EM id=\"em1\"> in the \n      <STRONG id=\"strong1\">second</STRONG> paragraph.</EM></P>\n      </DIV>\n   </BODY>\n</HTML>\n```\n\n没有定位，上面文档将建立如下的包含块：\n\n| For box generated by | C.B is established by      |\n| -------------------- |:---------------------------|\n| html                 |  initial C.B(UA-dependent) |\n| body                 | html                       |\n| div1                 | body                       |\n| p1                   | div1                       |\n| p2                   | div1                       |\n| em1                  | p2                         |\n| strong1              | p2                         |\n\n如果我们修改`div1`的`position`属性：\n\n```css\n  #div {positon: absolute; left: 50px; top: 50px}\n```\n\n那么它的包含块将不再是`body`,而是变成了最初的包含块(因为没有被定位的祖先盒子)。\n\n如果我们把`em1`的`position`属性也修改了：\n\n```css\n  #div {position: absolute; left: 50px; top: 50px}\n  #em1 {position: absolute; left: 100px; top: 100px}\n```\n\n包含块表格现在变成了：\n\n| For box generated by | C.B is established by      |\n| -------------------- |:---------------------------|\n| html                 | initial C.B(UA-dependent)  |\n| body                 | html                       |\n| div1                 | initial C.B                |\n| p1                   | div1                       |\n| p2                   | div1                       |\n| em1                  | div1                       |\n| strong1              | em1                        |\n\n通过修改`em1`的`positon`属性，它的包含块变成了最近的已经定位的祖先盒子(这里是`div1`生成的盒子)。\n\n---\n\n## 内容区的宽度：`width`属性\n\n`width`\n  可选值:  \\<<u>length</u>\\>|\\<<u>percentage</u>\\>|auto|inherit  \n  初始值: auto  \n  适用对像: 所有除了行内非替换元素的对象,包括表格行、和表格行组。\n  百分比: 根据包含块的宽度计算  \n  媒体: 视觉的  \n  计算值: 百分比或者`auto`或者绝对长度\n\n该属性指定了盒子的内容区域宽度。\n\n这个属性不适用于行内非替换元素。行内非替换元素的盒子宽度将由其绘制的内容决定。顺便说一下，行内盒子依照多个盒子的行线摆放。在同一行的多个盒子的宽度通过包含块指定，但是也可以通过浮动来设置。\n\n属性值有如下含义：\n\n- <u>length</u>  \n  指定内容区域长度，使用一个长度单位。\n\n- <u>percentage</u>  \n  指定一个百分比宽度，百分比依照生成元素盒子的包含块的宽度计算。如果包含块宽度依赖于元素宽度，那么布局是未定以的。\n\n- auto \n  宽度依赖于其他属性，下面会讨论。\n\n给`width`属性设置负数是非法的。\n\n---\n\n## 计算宽度以及外边距\n\n元素的`width`、`margin-right`、`margin-left`和`left`、`right`属性用于布局，取决于生成盒子的类型。(属性值用于布局，有时被称之为被使用的值。)原则上，属性值和计算值类似，通过`auto`替换为恰当的值，百分比基于包含块来计算，但是它们是特殊的。以下情况需要被区分开来：\n\n- 1、行内非替换元素\n\n- 2、行内替换元素\n\n- 3、在正常流中的块级非替换元素\n\n- 4、在正常流中的块级替换元素\n\n- 5、浮动非替换元素\n\n- 6、浮动替换元素\n\n- 7、绝对定位，非替换元素\n\n- 8、绝对定位，替换元素\n\n- 9、在正常流中的`inlin-block`,非替换元素\n\n- 10、在正常流中的`inline-block`,替换元素\n\n对于`1-6`和`9-10`,`left`和`right`属性值，如果是相对请为的情况下，由[section 9.4.3.](https://www.w3.org/TR/CSS2/visuren.html#relative-positioning),定义。\n\n---\n\n### 行内非替换元素\n\n`width`属性不起作用，如果给`margin-left`、`margin-right`设置为`auto`,将会计算为`0`.\n\n### 行内替换元素\n\n如果给`margin-left`、`margin-right`设置为`auto`,将会计算为`0`.\n如果`height`和`width`属性都设置为`auto`,并且元素有固有宽度，那么固有宽度作为`width`属性的值。\n\n如果`height`和`width`设置为`auto`,并且元素没有固有宽度，但是元素有固有高度以及固有比率；或者如果`width`属性值设置为`auto`,`height`有其他计算值，并且元素有固有比率，那么元素宽度计算为：\n\n>(used height) * (intrinsic ratio)\n\n如果`height`和`width`属性都设置为`auto`,并且元素有固有比率，但是没有固有的宽度或者高度，`CSS2.1`定义该情况下`width`的值未定义。但是其建议如下：\n如果包含块宽度本身并不依赖于替换元素的宽度，那么`width`的值的计算和正常流中的块级非替换元素类似。\n\n否则，如果`width`的值设置为`auto`,元素有固有宽度，那么固有宽度作为元素宽度。\n\n否则，如果`width`的值设置为`auto`,但是以下情况都不满足，`width`属性值为`300px`,如果`300px`对于设备来说太宽，用户代理将使用最大矩形的宽度：比率为`2:1`，适配设备。\n\n### 正常流中的块级非替换元素\n\n下面的约束必须配置其他属性进行：\n>'margin-left' + 'border-left-width' + 'padding-left' + 'width' + 'padding-right' + 'border-right-width' + 'margin-right' = width of containing block\n\n如果`width`不是`auto`,并且'border-left-width' + 'padding-left' + 'width' + 'padding-right' + 'border-right-width' (加上 不为`auto`的 'margin-left' 或者 'margin-right' 的值)。大于包含块的宽度，那么任何属性值设置为`auto`的`margin-left`或者`margin-right`, 遵循以下规则，设置为`0`.\n\n如果以上属性有一个计算值，而不是`auto`,这被称之为超过限制，那么其中一个属性值必须调整不同于其计算值。如果包含块的方向从左到右，那么指定给`margin-right`的特定值会被忽略，重置一个值，以适配等式成立。反之，如果包含块的方向从右到左，同理。\n\n如果有一个值被指定为`auto`,其值根据等式计算。\n\n如果`width`设置为`auto`,任何其他设置为`auto`的属性值变为`auto`,并且`width`属性值根据等式计算。\n\n如果`margin-left`和`margin-right`设置为`auto`,那么它们实际的值是相等的，用于把元素相对于包含块水平居中。\n\n### 正常流中的块级替换元素\n\n`width`属性的实际值类似于：`行内替换元素`.而外边距的值依据:`非替换块级元素决定`。\n\n### 浮动，非替换元素\n\n如果`margin-left`或者`margin-right`设置为`auto`,那么世纪值计算为`0`.\n如果`width`设置为`auto`,那么实际值将收缩适应元素.\n\n计算收缩适应的宽度类似于计算`table cell`的宽度，使用自动表布局算法。粗略的说：通过格式化内容区不换行，除非遇到换行符，得到一个优选宽度，并且计算一个恰当的最小宽度，例如：尝试任何可能的换行.`CSS2.1`没有定义具体的算法.第三，找到可用的宽度：在这种情况下，宽度为包含块减去另外六个盒模型属性以及可能的滚动条的宽度。\n\n自适应宽度取: min(max(最小宽度，可用宽度)，自适应宽度).\n\n### 浮动，替换元素\n\n如果`margin-left`或者`margin-right`设置为`auto`,实际值为`0`.`width`属性的实际值参照`行内替换元素`。\n\n### 绝对定位，非替换元素\n\n这个章节和下面一个章节的目的，术语`静态位置`参考，粗略的说，一个元素的位置必须在正常流中.清晰的定义：\n\n- 静态位置的包含块是一个假想的盒子，如果`position`属性设置为`static`，并且`float`属性设置为`none`,那么将作为元素的第一个盒子。(由于[section 9.7](https://www.w3.org/TR/CSS2/visuren.html#dis-pos-flo)的限制，这个假想计算或许需要给`display`属性指定一个特殊值.)\n- 如果`position`属性设置为`static`，并且`float`属性设置为`none`, 静态位置的`left`属性计算从包含块的左边缘到假想外边距的左边,这将作为元素的第一个盒子。其值将是负数，如果假想盒位于包含块的左边。\n- 静态位置的`right`属性计算从包含块的右边缘到假想盒的右边缘，同上。如果假想盒子位于包含块的左边，其值将会是正数。\n\n但不是实际的计算假想盒子的尺寸，用户代理会自由猜测其可能的位置。\n\n","source":"_posts/译-视觉格式化模型的细节.md","raw":"---\ntitle: 译-视觉格式化模型的细节\ndate: 2016-09-05 13:21:15\ntags: visual formatting model\ncategories: web\n---\n\n# 123\n\n## 包含块的定义\n\n元素位置以及尺寸的计算有时候涉及到一个固定的矩形，这个矩形称之为元素的`包含块`。元素的包含块定义如下：\n\n- 1、`根元素`所在的包含块是一个矩形，称之为：初始包含块。对于连续介质或页面媒体，有包含尺寸大小的视口，锚定在画布的初始位置。初始包含块的方向属性等同于根元素。\n\n- 2、对于其他元素，如果元素的`position`属性是`relative`或`static`,那么它的包含块被放置在最近的块容器祖先盒子的内容区边缘。\n\n- 3、如果元素的`position`属性设置为`fixed`，那么它的包含块依据在连续介质的情况下或在页面媒体的情况下的页区域的视口来建立。\n\n- 4、如果元素的`position`属性设置为`absolute`，那么它的包含块依据最近的，且`positon`属性被设置为`absolute`、`relative`、`fixed`,的祖先来建立。步骤如下：\n\n  - 1、如果祖先是一个行内元素，那么它的包含块是一个边界盒子包围第一个以及最后一个元素的内边距。在`CSS2.1`,如果行内元素跨多行，那么其包含块是未定义的。\n  - 2、否则，包含块根据其祖先的`padding edge`来格式化。\n  - 3、如果没有找到这样的祖先元素，那么其包含块就是最初的包含块。\n\n在页面媒体下，一个绝对定位元素的位置关联到它的包含块，忽略任何的分页(好像页面是连续的)，元素可能被分到多个页面。\n\n对于绝对定位的内容，被解析到页面的某个位置，而不是页面被布局的位置，或者解析到当前已经被渲染或者打印的页面，打印机或许会放置内容。\n\n- 当前页面的其他位置\n- 在随后的页面，或者\n- 省略它\n\n>注意：一个块级元素超过了多个页或许会在不同的页有不同的宽度，或许会设备自身的限制。\n\n\n\n```html\n<!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01//EN\">\n<HTML>\n   <HEAD>\n      <TITLE>Illustration of containing blocks</TITLE>\n   </HEAD>\n   <BODY id=\"body\">\n      <DIV id=\"div1\">\n      <P id=\"p1\">This is text in the first paragraph...</P>\n      <P id=\"p2\">This is text <EM id=\"em1\"> in the \n      <STRONG id=\"strong1\">second</STRONG> paragraph.</EM></P>\n      </DIV>\n   </BODY>\n</HTML>\n```\n\n没有定位，上面文档将建立如下的包含块：\n\n| For box generated by | C.B is established by      |\n| -------------------- |:---------------------------|\n| html                 |  initial C.B(UA-dependent) |\n| body                 | html                       |\n| div1                 | body                       |\n| p1                   | div1                       |\n| p2                   | div1                       |\n| em1                  | p2                         |\n| strong1              | p2                         |\n\n如果我们修改`div1`的`position`属性：\n\n```css\n  #div {positon: absolute; left: 50px; top: 50px}\n```\n\n那么它的包含块将不再是`body`,而是变成了最初的包含块(因为没有被定位的祖先盒子)。\n\n如果我们把`em1`的`position`属性也修改了：\n\n```css\n  #div {position: absolute; left: 50px; top: 50px}\n  #em1 {position: absolute; left: 100px; top: 100px}\n```\n\n包含块表格现在变成了：\n\n| For box generated by | C.B is established by      |\n| -------------------- |:---------------------------|\n| html                 | initial C.B(UA-dependent)  |\n| body                 | html                       |\n| div1                 | initial C.B                |\n| p1                   | div1                       |\n| p2                   | div1                       |\n| em1                  | div1                       |\n| strong1              | em1                        |\n\n通过修改`em1`的`positon`属性，它的包含块变成了最近的已经定位的祖先盒子(这里是`div1`生成的盒子)。\n\n---\n\n## 内容区的宽度：`width`属性\n\n`width`\n  可选值:  \\<<u>length</u>\\>|\\<<u>percentage</u>\\>|auto|inherit  \n  初始值: auto  \n  适用对像: 所有除了行内非替换元素的对象,包括表格行、和表格行组。\n  百分比: 根据包含块的宽度计算  \n  媒体: 视觉的  \n  计算值: 百分比或者`auto`或者绝对长度\n\n该属性指定了盒子的内容区域宽度。\n\n这个属性不适用于行内非替换元素。行内非替换元素的盒子宽度将由其绘制的内容决定。顺便说一下，行内盒子依照多个盒子的行线摆放。在同一行的多个盒子的宽度通过包含块指定，但是也可以通过浮动来设置。\n\n属性值有如下含义：\n\n- <u>length</u>  \n  指定内容区域长度，使用一个长度单位。\n\n- <u>percentage</u>  \n  指定一个百分比宽度，百分比依照生成元素盒子的包含块的宽度计算。如果包含块宽度依赖于元素宽度，那么布局是未定以的。\n\n- auto \n  宽度依赖于其他属性，下面会讨论。\n\n给`width`属性设置负数是非法的。\n\n---\n\n## 计算宽度以及外边距\n\n元素的`width`、`margin-right`、`margin-left`和`left`、`right`属性用于布局，取决于生成盒子的类型。(属性值用于布局，有时被称之为被使用的值。)原则上，属性值和计算值类似，通过`auto`替换为恰当的值，百分比基于包含块来计算，但是它们是特殊的。以下情况需要被区分开来：\n\n- 1、行内非替换元素\n\n- 2、行内替换元素\n\n- 3、在正常流中的块级非替换元素\n\n- 4、在正常流中的块级替换元素\n\n- 5、浮动非替换元素\n\n- 6、浮动替换元素\n\n- 7、绝对定位，非替换元素\n\n- 8、绝对定位，替换元素\n\n- 9、在正常流中的`inlin-block`,非替换元素\n\n- 10、在正常流中的`inline-block`,替换元素\n\n对于`1-6`和`9-10`,`left`和`right`属性值，如果是相对请为的情况下，由[section 9.4.3.](https://www.w3.org/TR/CSS2/visuren.html#relative-positioning),定义。\n\n---\n\n### 行内非替换元素\n\n`width`属性不起作用，如果给`margin-left`、`margin-right`设置为`auto`,将会计算为`0`.\n\n### 行内替换元素\n\n如果给`margin-left`、`margin-right`设置为`auto`,将会计算为`0`.\n如果`height`和`width`属性都设置为`auto`,并且元素有固有宽度，那么固有宽度作为`width`属性的值。\n\n如果`height`和`width`设置为`auto`,并且元素没有固有宽度，但是元素有固有高度以及固有比率；或者如果`width`属性值设置为`auto`,`height`有其他计算值，并且元素有固有比率，那么元素宽度计算为：\n\n>(used height) * (intrinsic ratio)\n\n如果`height`和`width`属性都设置为`auto`,并且元素有固有比率，但是没有固有的宽度或者高度，`CSS2.1`定义该情况下`width`的值未定义。但是其建议如下：\n如果包含块宽度本身并不依赖于替换元素的宽度，那么`width`的值的计算和正常流中的块级非替换元素类似。\n\n否则，如果`width`的值设置为`auto`,元素有固有宽度，那么固有宽度作为元素宽度。\n\n否则，如果`width`的值设置为`auto`,但是以下情况都不满足，`width`属性值为`300px`,如果`300px`对于设备来说太宽，用户代理将使用最大矩形的宽度：比率为`2:1`，适配设备。\n\n### 正常流中的块级非替换元素\n\n下面的约束必须配置其他属性进行：\n>'margin-left' + 'border-left-width' + 'padding-left' + 'width' + 'padding-right' + 'border-right-width' + 'margin-right' = width of containing block\n\n如果`width`不是`auto`,并且'border-left-width' + 'padding-left' + 'width' + 'padding-right' + 'border-right-width' (加上 不为`auto`的 'margin-left' 或者 'margin-right' 的值)。大于包含块的宽度，那么任何属性值设置为`auto`的`margin-left`或者`margin-right`, 遵循以下规则，设置为`0`.\n\n如果以上属性有一个计算值，而不是`auto`,这被称之为超过限制，那么其中一个属性值必须调整不同于其计算值。如果包含块的方向从左到右，那么指定给`margin-right`的特定值会被忽略，重置一个值，以适配等式成立。反之，如果包含块的方向从右到左，同理。\n\n如果有一个值被指定为`auto`,其值根据等式计算。\n\n如果`width`设置为`auto`,任何其他设置为`auto`的属性值变为`auto`,并且`width`属性值根据等式计算。\n\n如果`margin-left`和`margin-right`设置为`auto`,那么它们实际的值是相等的，用于把元素相对于包含块水平居中。\n\n### 正常流中的块级替换元素\n\n`width`属性的实际值类似于：`行内替换元素`.而外边距的值依据:`非替换块级元素决定`。\n\n### 浮动，非替换元素\n\n如果`margin-left`或者`margin-right`设置为`auto`,那么世纪值计算为`0`.\n如果`width`设置为`auto`,那么实际值将收缩适应元素.\n\n计算收缩适应的宽度类似于计算`table cell`的宽度，使用自动表布局算法。粗略的说：通过格式化内容区不换行，除非遇到换行符，得到一个优选宽度，并且计算一个恰当的最小宽度，例如：尝试任何可能的换行.`CSS2.1`没有定义具体的算法.第三，找到可用的宽度：在这种情况下，宽度为包含块减去另外六个盒模型属性以及可能的滚动条的宽度。\n\n自适应宽度取: min(max(最小宽度，可用宽度)，自适应宽度).\n\n### 浮动，替换元素\n\n如果`margin-left`或者`margin-right`设置为`auto`,实际值为`0`.`width`属性的实际值参照`行内替换元素`。\n\n### 绝对定位，非替换元素\n\n这个章节和下面一个章节的目的，术语`静态位置`参考，粗略的说，一个元素的位置必须在正常流中.清晰的定义：\n\n- 静态位置的包含块是一个假想的盒子，如果`position`属性设置为`static`，并且`float`属性设置为`none`,那么将作为元素的第一个盒子。(由于[section 9.7](https://www.w3.org/TR/CSS2/visuren.html#dis-pos-flo)的限制，这个假想计算或许需要给`display`属性指定一个特殊值.)\n- 如果`position`属性设置为`static`，并且`float`属性设置为`none`, 静态位置的`left`属性计算从包含块的左边缘到假想外边距的左边,这将作为元素的第一个盒子。其值将是负数，如果假想盒位于包含块的左边。\n- 静态位置的`right`属性计算从包含块的右边缘到假想盒的右边缘，同上。如果假想盒子位于包含块的左边，其值将会是正数。\n\n但不是实际的计算假想盒子的尺寸，用户代理会自由猜测其可能的位置。\n\n","slug":"译-视觉格式化模型的细节","published":1,"updated":"2018-07-01T10:30:46.499Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cem0057y4zvubgjhzoa","content":"<h1 id=\"123\"><a href=\"#123\" class=\"headerlink\" title=\"123\"></a>123</h1><h2 id=\"包含块的定义\"><a href=\"#包含块的定义\" class=\"headerlink\" title=\"包含块的定义\"></a>包含块的定义</h2><p>元素位置以及尺寸的计算有时候涉及到一个固定的矩形，这个矩形称之为元素的<code>包含块</code>。元素的包含块定义如下：</p>\n<ul>\n<li><p>1、<code>根元素</code>所在的包含块是一个矩形，称之为：初始包含块。对于连续介质或页面媒体，有包含尺寸大小的视口，锚定在画布的初始位置。初始包含块的方向属性等同于根元素。</p>\n</li>\n<li><p>2、对于其他元素，如果元素的<code>position</code>属性是<code>relative</code>或<code>static</code>,那么它的包含块被放置在最近的块容器祖先盒子的内容区边缘。</p>\n</li>\n<li><p>3、如果元素的<code>position</code>属性设置为<code>fixed</code>，那么它的包含块依据在连续介质的情况下或在页面媒体的情况下的页区域的视口来建立。</p>\n</li>\n<li><p>4、如果元素的<code>position</code>属性设置为<code>absolute</code>，那么它的包含块依据最近的，且<code>positon</code>属性被设置为<code>absolute</code>、<code>relative</code>、<code>fixed</code>,的祖先来建立。步骤如下：</p>\n<ul>\n<li>1、如果祖先是一个行内元素，那么它的包含块是一个边界盒子包围第一个以及最后一个元素的内边距。在<code>CSS2.1</code>,如果行内元素跨多行，那么其包含块是未定义的。</li>\n<li>2、否则，包含块根据其祖先的<code>padding edge</code>来格式化。</li>\n<li>3、如果没有找到这样的祖先元素，那么其包含块就是最初的包含块。</li>\n</ul>\n</li>\n</ul>\n<p>在页面媒体下，一个绝对定位元素的位置关联到它的包含块，忽略任何的分页(好像页面是连续的)，元素可能被分到多个页面。</p>\n<p>对于绝对定位的内容，被解析到页面的某个位置，而不是页面被布局的位置，或者解析到当前已经被渲染或者打印的页面，打印机或许会放置内容。</p>\n<ul>\n<li>当前页面的其他位置</li>\n<li>在随后的页面，或者</li>\n<li>省略它</li>\n</ul>\n<blockquote>\n<p>注意：一个块级元素超过了多个页或许会在不同的页有不同的宽度，或许会设备自身的限制。</p>\n</blockquote>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01//EN\"&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">HTML</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">HEAD</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">TITLE</span>&gt;</span>Illustration of containing blocks<span class=\"tag\">&lt;/<span class=\"name\">TITLE</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;/<span class=\"name\">HEAD</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">BODY</span> <span class=\"attr\">id</span>=<span class=\"string\">\"body\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">DIV</span> <span class=\"attr\">id</span>=<span class=\"string\">\"div1\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">P</span> <span class=\"attr\">id</span>=<span class=\"string\">\"p1\"</span>&gt;</span>This is text in the first paragraph...<span class=\"tag\">&lt;/<span class=\"name\">P</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">P</span> <span class=\"attr\">id</span>=<span class=\"string\">\"p2\"</span>&gt;</span>This is text <span class=\"tag\">&lt;<span class=\"name\">EM</span> <span class=\"attr\">id</span>=<span class=\"string\">\"em1\"</span>&gt;</span> in the </span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">STRONG</span> <span class=\"attr\">id</span>=<span class=\"string\">\"strong1\"</span>&gt;</span>second<span class=\"tag\">&lt;/<span class=\"name\">STRONG</span>&gt;</span> paragraph.<span class=\"tag\">&lt;/<span class=\"name\">EM</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">P</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">DIV</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;/<span class=\"name\">BODY</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">HTML</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>没有定位，上面文档将建立如下的包含块：</p>\n<table>\n<thead>\n<tr>\n<th>For box generated by</th>\n<th style=\"text-align:left\">C.B is established by</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>html</td>\n<td style=\"text-align:left\">initial C.B(UA-dependent)</td>\n</tr>\n<tr>\n<td>body</td>\n<td style=\"text-align:left\">html</td>\n</tr>\n<tr>\n<td>div1</td>\n<td style=\"text-align:left\">body</td>\n</tr>\n<tr>\n<td>p1</td>\n<td style=\"text-align:left\">div1</td>\n</tr>\n<tr>\n<td>p2</td>\n<td style=\"text-align:left\">div1</td>\n</tr>\n<tr>\n<td>em1</td>\n<td style=\"text-align:left\">p2</td>\n</tr>\n<tr>\n<td>strong1</td>\n<td style=\"text-align:left\">p2</td>\n</tr>\n</tbody>\n</table>\n<p>如果我们修改<code>div1</code>的<code>position</code>属性：</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-id\">#div</span> &#123;<span class=\"attribute\">positon</span>: absolute; <span class=\"attribute\">left</span>: <span class=\"number\">50px</span>; <span class=\"attribute\">top</span>: <span class=\"number\">50px</span>&#125;</span><br></pre></td></tr></table></figure>\n<p>那么它的包含块将不再是<code>body</code>,而是变成了最初的包含块(因为没有被定位的祖先盒子)。</p>\n<p>如果我们把<code>em1</code>的<code>position</code>属性也修改了：</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-id\">#div</span> &#123;<span class=\"attribute\">position</span>: absolute; <span class=\"attribute\">left</span>: <span class=\"number\">50px</span>; <span class=\"attribute\">top</span>: <span class=\"number\">50px</span>&#125;</span><br><span class=\"line\"><span class=\"selector-id\">#em1</span> &#123;<span class=\"attribute\">position</span>: absolute; <span class=\"attribute\">left</span>: <span class=\"number\">100px</span>; <span class=\"attribute\">top</span>: <span class=\"number\">100px</span>&#125;</span><br></pre></td></tr></table></figure>\n<p>包含块表格现在变成了：</p>\n<table>\n<thead>\n<tr>\n<th>For box generated by</th>\n<th style=\"text-align:left\">C.B is established by</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>html</td>\n<td style=\"text-align:left\">initial C.B(UA-dependent)</td>\n</tr>\n<tr>\n<td>body</td>\n<td style=\"text-align:left\">html</td>\n</tr>\n<tr>\n<td>div1</td>\n<td style=\"text-align:left\">initial C.B</td>\n</tr>\n<tr>\n<td>p1</td>\n<td style=\"text-align:left\">div1</td>\n</tr>\n<tr>\n<td>p2</td>\n<td style=\"text-align:left\">div1</td>\n</tr>\n<tr>\n<td>em1</td>\n<td style=\"text-align:left\">div1</td>\n</tr>\n<tr>\n<td>strong1</td>\n<td style=\"text-align:left\">em1</td>\n</tr>\n</tbody>\n</table>\n<p>通过修改<code>em1</code>的<code>positon</code>属性，它的包含块变成了最近的已经定位的祖先盒子(这里是<code>div1</code>生成的盒子)。</p>\n<hr>\n<h2 id=\"内容区的宽度：width属性\"><a href=\"#内容区的宽度：width属性\" class=\"headerlink\" title=\"内容区的宽度：width属性\"></a>内容区的宽度：<code>width</code>属性</h2><p><code>width</code><br>  可选值:  \\&lt;<u>length</u>>|\\&lt;<u>percentage</u>>|auto|inherit<br>  初始值: auto<br>  适用对像: 所有除了行内非替换元素的对象,包括表格行、和表格行组。<br>  百分比: 根据包含块的宽度计算<br>  媒体: 视觉的<br>  计算值: 百分比或者<code>auto</code>或者绝对长度</p>\n<p>该属性指定了盒子的内容区域宽度。</p>\n<p>这个属性不适用于行内非替换元素。行内非替换元素的盒子宽度将由其绘制的内容决定。顺便说一下，行内盒子依照多个盒子的行线摆放。在同一行的多个盒子的宽度通过包含块指定，但是也可以通过浮动来设置。</p>\n<p>属性值有如下含义：</p>\n<ul>\n<li><p><u>length</u><br>指定内容区域长度，使用一个长度单位。</p>\n</li>\n<li><p><u>percentage</u><br>指定一个百分比宽度，百分比依照生成元素盒子的包含块的宽度计算。如果包含块宽度依赖于元素宽度，那么布局是未定以的。</p>\n</li>\n<li><p>auto<br>宽度依赖于其他属性，下面会讨论。</p>\n</li>\n</ul>\n<p>给<code>width</code>属性设置负数是非法的。</p>\n<hr>\n<h2 id=\"计算宽度以及外边距\"><a href=\"#计算宽度以及外边距\" class=\"headerlink\" title=\"计算宽度以及外边距\"></a>计算宽度以及外边距</h2><p>元素的<code>width</code>、<code>margin-right</code>、<code>margin-left</code>和<code>left</code>、<code>right</code>属性用于布局，取决于生成盒子的类型。(属性值用于布局，有时被称之为被使用的值。)原则上，属性值和计算值类似，通过<code>auto</code>替换为恰当的值，百分比基于包含块来计算，但是它们是特殊的。以下情况需要被区分开来：</p>\n<ul>\n<li><p>1、行内非替换元素</p>\n</li>\n<li><p>2、行内替换元素</p>\n</li>\n<li><p>3、在正常流中的块级非替换元素</p>\n</li>\n<li><p>4、在正常流中的块级替换元素</p>\n</li>\n<li><p>5、浮动非替换元素</p>\n</li>\n<li><p>6、浮动替换元素</p>\n</li>\n<li><p>7、绝对定位，非替换元素</p>\n</li>\n<li><p>8、绝对定位，替换元素</p>\n</li>\n<li><p>9、在正常流中的<code>inlin-block</code>,非替换元素</p>\n</li>\n<li><p>10、在正常流中的<code>inline-block</code>,替换元素</p>\n</li>\n</ul>\n<p>对于<code>1-6</code>和<code>9-10</code>,<code>left</code>和<code>right</code>属性值，如果是相对请为的情况下，由<a href=\"https://www.w3.org/TR/CSS2/visuren.html#relative-positioning\" target=\"_blank\" rel=\"noopener\">section 9.4.3.</a>,定义。</p>\n<hr>\n<h3 id=\"行内非替换元素\"><a href=\"#行内非替换元素\" class=\"headerlink\" title=\"行内非替换元素\"></a>行内非替换元素</h3><p><code>width</code>属性不起作用，如果给<code>margin-left</code>、<code>margin-right</code>设置为<code>auto</code>,将会计算为<code>0</code>.</p>\n<h3 id=\"行内替换元素\"><a href=\"#行内替换元素\" class=\"headerlink\" title=\"行内替换元素\"></a>行内替换元素</h3><p>如果给<code>margin-left</code>、<code>margin-right</code>设置为<code>auto</code>,将会计算为<code>0</code>.<br>如果<code>height</code>和<code>width</code>属性都设置为<code>auto</code>,并且元素有固有宽度，那么固有宽度作为<code>width</code>属性的值。</p>\n<p>如果<code>height</code>和<code>width</code>设置为<code>auto</code>,并且元素没有固有宽度，但是元素有固有高度以及固有比率；或者如果<code>width</code>属性值设置为<code>auto</code>,<code>height</code>有其他计算值，并且元素有固有比率，那么元素宽度计算为：</p>\n<blockquote>\n<p>(used height) * (intrinsic ratio)</p>\n</blockquote>\n<p>如果<code>height</code>和<code>width</code>属性都设置为<code>auto</code>,并且元素有固有比率，但是没有固有的宽度或者高度，<code>CSS2.1</code>定义该情况下<code>width</code>的值未定义。但是其建议如下：<br>如果包含块宽度本身并不依赖于替换元素的宽度，那么<code>width</code>的值的计算和正常流中的块级非替换元素类似。</p>\n<p>否则，如果<code>width</code>的值设置为<code>auto</code>,元素有固有宽度，那么固有宽度作为元素宽度。</p>\n<p>否则，如果<code>width</code>的值设置为<code>auto</code>,但是以下情况都不满足，<code>width</code>属性值为<code>300px</code>,如果<code>300px</code>对于设备来说太宽，用户代理将使用最大矩形的宽度：比率为<code>2:1</code>，适配设备。</p>\n<h3 id=\"正常流中的块级非替换元素\"><a href=\"#正常流中的块级非替换元素\" class=\"headerlink\" title=\"正常流中的块级非替换元素\"></a>正常流中的块级非替换元素</h3><p>下面的约束必须配置其他属性进行：</p>\n<blockquote>\n<p>‘margin-left’ + ‘border-left-width’ + ‘padding-left’ + ‘width’ + ‘padding-right’ + ‘border-right-width’ + ‘margin-right’ = width of containing block</p>\n</blockquote>\n<p>如果<code>width</code>不是<code>auto</code>,并且’border-left-width’ + ‘padding-left’ + ‘width’ + ‘padding-right’ + ‘border-right-width’ (加上 不为<code>auto</code>的 ‘margin-left’ 或者 ‘margin-right’ 的值)。大于包含块的宽度，那么任何属性值设置为<code>auto</code>的<code>margin-left</code>或者<code>margin-right</code>, 遵循以下规则，设置为<code>0</code>.</p>\n<p>如果以上属性有一个计算值，而不是<code>auto</code>,这被称之为超过限制，那么其中一个属性值必须调整不同于其计算值。如果包含块的方向从左到右，那么指定给<code>margin-right</code>的特定值会被忽略，重置一个值，以适配等式成立。反之，如果包含块的方向从右到左，同理。</p>\n<p>如果有一个值被指定为<code>auto</code>,其值根据等式计算。</p>\n<p>如果<code>width</code>设置为<code>auto</code>,任何其他设置为<code>auto</code>的属性值变为<code>auto</code>,并且<code>width</code>属性值根据等式计算。</p>\n<p>如果<code>margin-left</code>和<code>margin-right</code>设置为<code>auto</code>,那么它们实际的值是相等的，用于把元素相对于包含块水平居中。</p>\n<h3 id=\"正常流中的块级替换元素\"><a href=\"#正常流中的块级替换元素\" class=\"headerlink\" title=\"正常流中的块级替换元素\"></a>正常流中的块级替换元素</h3><p><code>width</code>属性的实际值类似于：<code>行内替换元素</code>.而外边距的值依据:<code>非替换块级元素决定</code>。</p>\n<h3 id=\"浮动，非替换元素\"><a href=\"#浮动，非替换元素\" class=\"headerlink\" title=\"浮动，非替换元素\"></a>浮动，非替换元素</h3><p>如果<code>margin-left</code>或者<code>margin-right</code>设置为<code>auto</code>,那么世纪值计算为<code>0</code>.<br>如果<code>width</code>设置为<code>auto</code>,那么实际值将收缩适应元素.</p>\n<p>计算收缩适应的宽度类似于计算<code>table cell</code>的宽度，使用自动表布局算法。粗略的说：通过格式化内容区不换行，除非遇到换行符，得到一个优选宽度，并且计算一个恰当的最小宽度，例如：尝试任何可能的换行.<code>CSS2.1</code>没有定义具体的算法.第三，找到可用的宽度：在这种情况下，宽度为包含块减去另外六个盒模型属性以及可能的滚动条的宽度。</p>\n<p>自适应宽度取: min(max(最小宽度，可用宽度)，自适应宽度).</p>\n<h3 id=\"浮动，替换元素\"><a href=\"#浮动，替换元素\" class=\"headerlink\" title=\"浮动，替换元素\"></a>浮动，替换元素</h3><p>如果<code>margin-left</code>或者<code>margin-right</code>设置为<code>auto</code>,实际值为<code>0</code>.<code>width</code>属性的实际值参照<code>行内替换元素</code>。</p>\n<h3 id=\"绝对定位，非替换元素\"><a href=\"#绝对定位，非替换元素\" class=\"headerlink\" title=\"绝对定位，非替换元素\"></a>绝对定位，非替换元素</h3><p>这个章节和下面一个章节的目的，术语<code>静态位置</code>参考，粗略的说，一个元素的位置必须在正常流中.清晰的定义：</p>\n<ul>\n<li>静态位置的包含块是一个假想的盒子，如果<code>position</code>属性设置为<code>static</code>，并且<code>float</code>属性设置为<code>none</code>,那么将作为元素的第一个盒子。(由于<a href=\"https://www.w3.org/TR/CSS2/visuren.html#dis-pos-flo\" target=\"_blank\" rel=\"noopener\">section 9.7</a>的限制，这个假想计算或许需要给<code>display</code>属性指定一个特殊值.)</li>\n<li>如果<code>position</code>属性设置为<code>static</code>，并且<code>float</code>属性设置为<code>none</code>, 静态位置的<code>left</code>属性计算从包含块的左边缘到假想外边距的左边,这将作为元素的第一个盒子。其值将是负数，如果假想盒位于包含块的左边。</li>\n<li>静态位置的<code>right</code>属性计算从包含块的右边缘到假想盒的右边缘，同上。如果假想盒子位于包含块的左边，其值将会是正数。</li>\n</ul>\n<p>但不是实际的计算假想盒子的尺寸，用户代理会自由猜测其可能的位置。</p>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"123\"><a href=\"#123\" class=\"headerlink\" title=\"123\"></a>123</h1><h2 id=\"包含块的定义\"><a href=\"#包含块的定义\" class=\"headerlink\" title=\"包含块的定义\"></a>包含块的定义</h2><p>元素位置以及尺寸的计算有时候涉及到一个固定的矩形，这个矩形称之为元素的<code>包含块</code>。元素的包含块定义如下：</p>\n<ul>\n<li><p>1、<code>根元素</code>所在的包含块是一个矩形，称之为：初始包含块。对于连续介质或页面媒体，有包含尺寸大小的视口，锚定在画布的初始位置。初始包含块的方向属性等同于根元素。</p>\n</li>\n<li><p>2、对于其他元素，如果元素的<code>position</code>属性是<code>relative</code>或<code>static</code>,那么它的包含块被放置在最近的块容器祖先盒子的内容区边缘。</p>\n</li>\n<li><p>3、如果元素的<code>position</code>属性设置为<code>fixed</code>，那么它的包含块依据在连续介质的情况下或在页面媒体的情况下的页区域的视口来建立。</p>\n</li>\n<li><p>4、如果元素的<code>position</code>属性设置为<code>absolute</code>，那么它的包含块依据最近的，且<code>positon</code>属性被设置为<code>absolute</code>、<code>relative</code>、<code>fixed</code>,的祖先来建立。步骤如下：</p>\n<ul>\n<li>1、如果祖先是一个行内元素，那么它的包含块是一个边界盒子包围第一个以及最后一个元素的内边距。在<code>CSS2.1</code>,如果行内元素跨多行，那么其包含块是未定义的。</li>\n<li>2、否则，包含块根据其祖先的<code>padding edge</code>来格式化。</li>\n<li>3、如果没有找到这样的祖先元素，那么其包含块就是最初的包含块。</li>\n</ul>\n</li>\n</ul>\n<p>在页面媒体下，一个绝对定位元素的位置关联到它的包含块，忽略任何的分页(好像页面是连续的)，元素可能被分到多个页面。</p>\n<p>对于绝对定位的内容，被解析到页面的某个位置，而不是页面被布局的位置，或者解析到当前已经被渲染或者打印的页面，打印机或许会放置内容。</p>\n<ul>\n<li>当前页面的其他位置</li>\n<li>在随后的页面，或者</li>\n<li>省略它</li>\n</ul>\n<blockquote>\n<p>注意：一个块级元素超过了多个页或许会在不同的页有不同的宽度，或许会设备自身的限制。</p>\n</blockquote>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01//EN\"&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">HTML</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">HEAD</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">TITLE</span>&gt;</span>Illustration of containing blocks<span class=\"tag\">&lt;/<span class=\"name\">TITLE</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;/<span class=\"name\">HEAD</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">BODY</span> <span class=\"attr\">id</span>=<span class=\"string\">\"body\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">DIV</span> <span class=\"attr\">id</span>=<span class=\"string\">\"div1\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">P</span> <span class=\"attr\">id</span>=<span class=\"string\">\"p1\"</span>&gt;</span>This is text in the first paragraph...<span class=\"tag\">&lt;/<span class=\"name\">P</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">P</span> <span class=\"attr\">id</span>=<span class=\"string\">\"p2\"</span>&gt;</span>This is text <span class=\"tag\">&lt;<span class=\"name\">EM</span> <span class=\"attr\">id</span>=<span class=\"string\">\"em1\"</span>&gt;</span> in the </span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">STRONG</span> <span class=\"attr\">id</span>=<span class=\"string\">\"strong1\"</span>&gt;</span>second<span class=\"tag\">&lt;/<span class=\"name\">STRONG</span>&gt;</span> paragraph.<span class=\"tag\">&lt;/<span class=\"name\">EM</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">P</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">DIV</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;/<span class=\"name\">BODY</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">HTML</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>没有定位，上面文档将建立如下的包含块：</p>\n<table>\n<thead>\n<tr>\n<th>For box generated by</th>\n<th style=\"text-align:left\">C.B is established by</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>html</td>\n<td style=\"text-align:left\">initial C.B(UA-dependent)</td>\n</tr>\n<tr>\n<td>body</td>\n<td style=\"text-align:left\">html</td>\n</tr>\n<tr>\n<td>div1</td>\n<td style=\"text-align:left\">body</td>\n</tr>\n<tr>\n<td>p1</td>\n<td style=\"text-align:left\">div1</td>\n</tr>\n<tr>\n<td>p2</td>\n<td style=\"text-align:left\">div1</td>\n</tr>\n<tr>\n<td>em1</td>\n<td style=\"text-align:left\">p2</td>\n</tr>\n<tr>\n<td>strong1</td>\n<td style=\"text-align:left\">p2</td>\n</tr>\n</tbody>\n</table>\n<p>如果我们修改<code>div1</code>的<code>position</code>属性：</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-id\">#div</span> &#123;<span class=\"attribute\">positon</span>: absolute; <span class=\"attribute\">left</span>: <span class=\"number\">50px</span>; <span class=\"attribute\">top</span>: <span class=\"number\">50px</span>&#125;</span><br></pre></td></tr></table></figure>\n<p>那么它的包含块将不再是<code>body</code>,而是变成了最初的包含块(因为没有被定位的祖先盒子)。</p>\n<p>如果我们把<code>em1</code>的<code>position</code>属性也修改了：</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-id\">#div</span> &#123;<span class=\"attribute\">position</span>: absolute; <span class=\"attribute\">left</span>: <span class=\"number\">50px</span>; <span class=\"attribute\">top</span>: <span class=\"number\">50px</span>&#125;</span><br><span class=\"line\"><span class=\"selector-id\">#em1</span> &#123;<span class=\"attribute\">position</span>: absolute; <span class=\"attribute\">left</span>: <span class=\"number\">100px</span>; <span class=\"attribute\">top</span>: <span class=\"number\">100px</span>&#125;</span><br></pre></td></tr></table></figure>\n<p>包含块表格现在变成了：</p>\n<table>\n<thead>\n<tr>\n<th>For box generated by</th>\n<th style=\"text-align:left\">C.B is established by</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>html</td>\n<td style=\"text-align:left\">initial C.B(UA-dependent)</td>\n</tr>\n<tr>\n<td>body</td>\n<td style=\"text-align:left\">html</td>\n</tr>\n<tr>\n<td>div1</td>\n<td style=\"text-align:left\">initial C.B</td>\n</tr>\n<tr>\n<td>p1</td>\n<td style=\"text-align:left\">div1</td>\n</tr>\n<tr>\n<td>p2</td>\n<td style=\"text-align:left\">div1</td>\n</tr>\n<tr>\n<td>em1</td>\n<td style=\"text-align:left\">div1</td>\n</tr>\n<tr>\n<td>strong1</td>\n<td style=\"text-align:left\">em1</td>\n</tr>\n</tbody>\n</table>\n<p>通过修改<code>em1</code>的<code>positon</code>属性，它的包含块变成了最近的已经定位的祖先盒子(这里是<code>div1</code>生成的盒子)。</p>\n<hr>\n<h2 id=\"内容区的宽度：width属性\"><a href=\"#内容区的宽度：width属性\" class=\"headerlink\" title=\"内容区的宽度：width属性\"></a>内容区的宽度：<code>width</code>属性</h2><p><code>width</code><br>  可选值:  \\&lt;<u>length</u>>|\\&lt;<u>percentage</u>>|auto|inherit<br>  初始值: auto<br>  适用对像: 所有除了行内非替换元素的对象,包括表格行、和表格行组。<br>  百分比: 根据包含块的宽度计算<br>  媒体: 视觉的<br>  计算值: 百分比或者<code>auto</code>或者绝对长度</p>\n<p>该属性指定了盒子的内容区域宽度。</p>\n<p>这个属性不适用于行内非替换元素。行内非替换元素的盒子宽度将由其绘制的内容决定。顺便说一下，行内盒子依照多个盒子的行线摆放。在同一行的多个盒子的宽度通过包含块指定，但是也可以通过浮动来设置。</p>\n<p>属性值有如下含义：</p>\n<ul>\n<li><p><u>length</u><br>指定内容区域长度，使用一个长度单位。</p>\n</li>\n<li><p><u>percentage</u><br>指定一个百分比宽度，百分比依照生成元素盒子的包含块的宽度计算。如果包含块宽度依赖于元素宽度，那么布局是未定以的。</p>\n</li>\n<li><p>auto<br>宽度依赖于其他属性，下面会讨论。</p>\n</li>\n</ul>\n<p>给<code>width</code>属性设置负数是非法的。</p>\n<hr>\n<h2 id=\"计算宽度以及外边距\"><a href=\"#计算宽度以及外边距\" class=\"headerlink\" title=\"计算宽度以及外边距\"></a>计算宽度以及外边距</h2><p>元素的<code>width</code>、<code>margin-right</code>、<code>margin-left</code>和<code>left</code>、<code>right</code>属性用于布局，取决于生成盒子的类型。(属性值用于布局，有时被称之为被使用的值。)原则上，属性值和计算值类似，通过<code>auto</code>替换为恰当的值，百分比基于包含块来计算，但是它们是特殊的。以下情况需要被区分开来：</p>\n<ul>\n<li><p>1、行内非替换元素</p>\n</li>\n<li><p>2、行内替换元素</p>\n</li>\n<li><p>3、在正常流中的块级非替换元素</p>\n</li>\n<li><p>4、在正常流中的块级替换元素</p>\n</li>\n<li><p>5、浮动非替换元素</p>\n</li>\n<li><p>6、浮动替换元素</p>\n</li>\n<li><p>7、绝对定位，非替换元素</p>\n</li>\n<li><p>8、绝对定位，替换元素</p>\n</li>\n<li><p>9、在正常流中的<code>inlin-block</code>,非替换元素</p>\n</li>\n<li><p>10、在正常流中的<code>inline-block</code>,替换元素</p>\n</li>\n</ul>\n<p>对于<code>1-6</code>和<code>9-10</code>,<code>left</code>和<code>right</code>属性值，如果是相对请为的情况下，由<a href=\"https://www.w3.org/TR/CSS2/visuren.html#relative-positioning\" target=\"_blank\" rel=\"noopener\">section 9.4.3.</a>,定义。</p>\n<hr>\n<h3 id=\"行内非替换元素\"><a href=\"#行内非替换元素\" class=\"headerlink\" title=\"行内非替换元素\"></a>行内非替换元素</h3><p><code>width</code>属性不起作用，如果给<code>margin-left</code>、<code>margin-right</code>设置为<code>auto</code>,将会计算为<code>0</code>.</p>\n<h3 id=\"行内替换元素\"><a href=\"#行内替换元素\" class=\"headerlink\" title=\"行内替换元素\"></a>行内替换元素</h3><p>如果给<code>margin-left</code>、<code>margin-right</code>设置为<code>auto</code>,将会计算为<code>0</code>.<br>如果<code>height</code>和<code>width</code>属性都设置为<code>auto</code>,并且元素有固有宽度，那么固有宽度作为<code>width</code>属性的值。</p>\n<p>如果<code>height</code>和<code>width</code>设置为<code>auto</code>,并且元素没有固有宽度，但是元素有固有高度以及固有比率；或者如果<code>width</code>属性值设置为<code>auto</code>,<code>height</code>有其他计算值，并且元素有固有比率，那么元素宽度计算为：</p>\n<blockquote>\n<p>(used height) * (intrinsic ratio)</p>\n</blockquote>\n<p>如果<code>height</code>和<code>width</code>属性都设置为<code>auto</code>,并且元素有固有比率，但是没有固有的宽度或者高度，<code>CSS2.1</code>定义该情况下<code>width</code>的值未定义。但是其建议如下：<br>如果包含块宽度本身并不依赖于替换元素的宽度，那么<code>width</code>的值的计算和正常流中的块级非替换元素类似。</p>\n<p>否则，如果<code>width</code>的值设置为<code>auto</code>,元素有固有宽度，那么固有宽度作为元素宽度。</p>\n<p>否则，如果<code>width</code>的值设置为<code>auto</code>,但是以下情况都不满足，<code>width</code>属性值为<code>300px</code>,如果<code>300px</code>对于设备来说太宽，用户代理将使用最大矩形的宽度：比率为<code>2:1</code>，适配设备。</p>\n<h3 id=\"正常流中的块级非替换元素\"><a href=\"#正常流中的块级非替换元素\" class=\"headerlink\" title=\"正常流中的块级非替换元素\"></a>正常流中的块级非替换元素</h3><p>下面的约束必须配置其他属性进行：</p>\n<blockquote>\n<p>‘margin-left’ + ‘border-left-width’ + ‘padding-left’ + ‘width’ + ‘padding-right’ + ‘border-right-width’ + ‘margin-right’ = width of containing block</p>\n</blockquote>\n<p>如果<code>width</code>不是<code>auto</code>,并且’border-left-width’ + ‘padding-left’ + ‘width’ + ‘padding-right’ + ‘border-right-width’ (加上 不为<code>auto</code>的 ‘margin-left’ 或者 ‘margin-right’ 的值)。大于包含块的宽度，那么任何属性值设置为<code>auto</code>的<code>margin-left</code>或者<code>margin-right</code>, 遵循以下规则，设置为<code>0</code>.</p>\n<p>如果以上属性有一个计算值，而不是<code>auto</code>,这被称之为超过限制，那么其中一个属性值必须调整不同于其计算值。如果包含块的方向从左到右，那么指定给<code>margin-right</code>的特定值会被忽略，重置一个值，以适配等式成立。反之，如果包含块的方向从右到左，同理。</p>\n<p>如果有一个值被指定为<code>auto</code>,其值根据等式计算。</p>\n<p>如果<code>width</code>设置为<code>auto</code>,任何其他设置为<code>auto</code>的属性值变为<code>auto</code>,并且<code>width</code>属性值根据等式计算。</p>\n<p>如果<code>margin-left</code>和<code>margin-right</code>设置为<code>auto</code>,那么它们实际的值是相等的，用于把元素相对于包含块水平居中。</p>\n<h3 id=\"正常流中的块级替换元素\"><a href=\"#正常流中的块级替换元素\" class=\"headerlink\" title=\"正常流中的块级替换元素\"></a>正常流中的块级替换元素</h3><p><code>width</code>属性的实际值类似于：<code>行内替换元素</code>.而外边距的值依据:<code>非替换块级元素决定</code>。</p>\n<h3 id=\"浮动，非替换元素\"><a href=\"#浮动，非替换元素\" class=\"headerlink\" title=\"浮动，非替换元素\"></a>浮动，非替换元素</h3><p>如果<code>margin-left</code>或者<code>margin-right</code>设置为<code>auto</code>,那么世纪值计算为<code>0</code>.<br>如果<code>width</code>设置为<code>auto</code>,那么实际值将收缩适应元素.</p>\n<p>计算收缩适应的宽度类似于计算<code>table cell</code>的宽度，使用自动表布局算法。粗略的说：通过格式化内容区不换行，除非遇到换行符，得到一个优选宽度，并且计算一个恰当的最小宽度，例如：尝试任何可能的换行.<code>CSS2.1</code>没有定义具体的算法.第三，找到可用的宽度：在这种情况下，宽度为包含块减去另外六个盒模型属性以及可能的滚动条的宽度。</p>\n<p>自适应宽度取: min(max(最小宽度，可用宽度)，自适应宽度).</p>\n<h3 id=\"浮动，替换元素\"><a href=\"#浮动，替换元素\" class=\"headerlink\" title=\"浮动，替换元素\"></a>浮动，替换元素</h3><p>如果<code>margin-left</code>或者<code>margin-right</code>设置为<code>auto</code>,实际值为<code>0</code>.<code>width</code>属性的实际值参照<code>行内替换元素</code>。</p>\n<h3 id=\"绝对定位，非替换元素\"><a href=\"#绝对定位，非替换元素\" class=\"headerlink\" title=\"绝对定位，非替换元素\"></a>绝对定位，非替换元素</h3><p>这个章节和下面一个章节的目的，术语<code>静态位置</code>参考，粗略的说，一个元素的位置必须在正常流中.清晰的定义：</p>\n<ul>\n<li>静态位置的包含块是一个假想的盒子，如果<code>position</code>属性设置为<code>static</code>，并且<code>float</code>属性设置为<code>none</code>,那么将作为元素的第一个盒子。(由于<a href=\"https://www.w3.org/TR/CSS2/visuren.html#dis-pos-flo\" target=\"_blank\" rel=\"noopener\">section 9.7</a>的限制，这个假想计算或许需要给<code>display</code>属性指定一个特殊值.)</li>\n<li>如果<code>position</code>属性设置为<code>static</code>，并且<code>float</code>属性设置为<code>none</code>, 静态位置的<code>left</code>属性计算从包含块的左边缘到假想外边距的左边,这将作为元素的第一个盒子。其值将是负数，如果假想盒位于包含块的左边。</li>\n<li>静态位置的<code>right</code>属性计算从包含块的右边缘到假想盒的右边缘，同上。如果假想盒子位于包含块的左边，其值将会是正数。</li>\n</ul>\n<p>但不是实际的计算假想盒子的尺寸，用户代理会自由猜测其可能的位置。</p>\n"},{"title":"动态化资源下发","date":"2018-04-22T08:26:23.000Z","_content":"\n近一两年移动端开发领域掀起了一股动态化的浪潮。当然早几年也有诸如phoneGap, cordova等跨平台的方案。但是随着react-native, weex的出现了把这股浪潮推向了高点。动态化的一大优势在于，省去了繁琐的发版流程，避免了只是为了修改几个icon，就得等待好几天的发版审核这样痛苦的过程。通过动态化，开发者自行管理更新包。精准的控制每次迭代的资源和代码，大大的提高了产品迭代速度。\n\n\n代码下发服务主要包含以下几个主要功能点：\n\n\n## 一、静态文件托管\n\n静态文件管理主要是把每次项目迭代的更新包上传到CDN，同时还应该动态计算每次迭代的差异包，这样可以最大限度的减少移动端下载的资源体积。代码下发服务资源主要包含两个部分：1、图片资源, 2、代码。图片资源的增量比较简单，每次计算文件`md5`。同时把之前不存在的图片资源拷贝到新的增量包\n\n```javascript\n\ndoPatchDiff: async function (patchDir, oldPatchDir, diffPatchKey, diffPatchDir) {\n  return new Promise((resolve, reject) => {\n    const walker = new Walker()\n    //创建一个临时目录放置增量包\n    const output = fs.createWriteStream(diffPatchDir)\n    const archive = archiver('zip', {\n      zlib: { level: 9 }\n    })\n    archive.pipe(output)\n    walker.on('error', reject)\n    archive.on('error', reject)\n    archive.on('warning', reject)\n    output.on('close', () => {\n      //上传增量包\n      this.uploadPatchDiff(diffPatchKey, diffPatchDir)\n        .then(res => resolve(res))\n        .catch(reject)\n    })\n    walker.on('end', () => {\n      archive.finalize()\n    })\n    walker.walk(patchDir, (filePath, isDirectory) => {\n      if (isDirectory) return\n      const subFilePath = path.relative(patchDir, filePath)\n      const oldFilePath = path.join(oldPatchDir, subFilePath)\n      //文件不存在则拷贝\n      if (!fs.existsSync(oldFilePath)) {\n        archive.append(fs.createReadStream(filePath), { name: subFilePath })\n      } else {\n        //判断md5\n        const newFileMD5 = md5File.sync(filePath)\n        const oldFileMD5 = md5File.sync(oldFilePath)\n        if (newFileMD5 !== oldFileMD5) {\n          archive.append(fs.createReadStream(filePath), { name: subFilePath })\n        }\n      }\n    })\n  })\n}\n\n```\n\n代码文件做增量更新主要通过Google开源的一个[diff-match-patch](https://github.com/google/diff-match-patch)来实现。感觉对于js体积比较大的场景收益高一些，react-native这种比较适合。我们项目采用weex的方案，weex提倡每个页面一个js文件，通常文件的体积也比较小，在这里没有使用这个方案，而是采用和图片资源同样的处理方式。\n\n\n## 二、语义化版本控制\n\n[语义化版本管理](https://semver.org/lang/zh-CN/)是比较公认的一种项目管理方式。规则如下：\n\n```shell\n版本格式：主版本号.次版本号.修订号，版本号递增规则如下：\n\n主版本号：当你做了不兼容的 API 修改，\n次版本号：当你做了向下兼容的功能性新增，\n修订号：当你做了向下兼容的问题修正。\n先行版本号及版本编译信息可以加到“主版本号.次版本号.修订号”的后面，作为延伸。\n\n```\n\n在代码下发管理后台每次新建app版本信息、上传补丁都必须采用语义化版本来命名。\n\n\n## 三、app渠道管理\n\nIOS开发天生只有一个渠道，而Android开发渠道五花八门。有些时候，譬如说运营的app推广需求，我们可能只希望对某一个渠道做功能迭代。所以代码下发服务应该支持针对某一渠道上传资源包，更新功能。\n\n## 四、下发统计\n\n动态化app之后，需要一个工具去衡量用户下载补丁效果。统计主要包含两个纬度：针对某个版本app的下发统计、针对某个补丁(某个功能点)的下发统计。\n\n## 五、日志收集\n\n移动端开发往往调试，看日志会比较困难，特别是项目发布之后，需要一个方案动态收集移动端产生的日志。日志服务说复杂也复杂，说简单也比较简单。首先为了移动端避免频繁发送请求，移动端应该有一个队列，对于同一种类型的错误，只是间隔的收集一次。其次，服务端需要对客户端发送上来的日志做一些处理，主要包括：\n\n+  利用map文件定位原始出错的位置，方便快速定位问题。\n+  日志入库，方面后续做日志分析。可以使用第三方的日志服务，如阿里云`SLS`，或者AWS `CloudWatch`。也可以利用第三方工具，如Elasticsearch 自行搭建日志分析服务。\n+  日志报警。通过对日志分级，对于等级高于`warning`或者`error`日志的信息。应当及时报警通知开发人员。如果原有项目已经对接了第三方报警系统如`promethues`，这里需要做一个适配。\n\n## 六、管理后台页面\n\n所有的以上功能点，最终都希望有一个可视化的方案能够呈现在用户面前。包括但不限于：项目管理、统计查询、补丁上传等。\n\n\n项目源代码：[assets-push](https://github.com/Luncher/assets-push)\n","source":"_posts/资源下发服务.md","raw":"---\ntitle: 动态化资源下发\ndate: 2018-04-22 16:26:23\ntags:\n  - weex\n  - react\n  - codepush\ncategories: server\n---\n\n近一两年移动端开发领域掀起了一股动态化的浪潮。当然早几年也有诸如phoneGap, cordova等跨平台的方案。但是随着react-native, weex的出现了把这股浪潮推向了高点。动态化的一大优势在于，省去了繁琐的发版流程，避免了只是为了修改几个icon，就得等待好几天的发版审核这样痛苦的过程。通过动态化，开发者自行管理更新包。精准的控制每次迭代的资源和代码，大大的提高了产品迭代速度。\n\n\n代码下发服务主要包含以下几个主要功能点：\n\n\n## 一、静态文件托管\n\n静态文件管理主要是把每次项目迭代的更新包上传到CDN，同时还应该动态计算每次迭代的差异包，这样可以最大限度的减少移动端下载的资源体积。代码下发服务资源主要包含两个部分：1、图片资源, 2、代码。图片资源的增量比较简单，每次计算文件`md5`。同时把之前不存在的图片资源拷贝到新的增量包\n\n```javascript\n\ndoPatchDiff: async function (patchDir, oldPatchDir, diffPatchKey, diffPatchDir) {\n  return new Promise((resolve, reject) => {\n    const walker = new Walker()\n    //创建一个临时目录放置增量包\n    const output = fs.createWriteStream(diffPatchDir)\n    const archive = archiver('zip', {\n      zlib: { level: 9 }\n    })\n    archive.pipe(output)\n    walker.on('error', reject)\n    archive.on('error', reject)\n    archive.on('warning', reject)\n    output.on('close', () => {\n      //上传增量包\n      this.uploadPatchDiff(diffPatchKey, diffPatchDir)\n        .then(res => resolve(res))\n        .catch(reject)\n    })\n    walker.on('end', () => {\n      archive.finalize()\n    })\n    walker.walk(patchDir, (filePath, isDirectory) => {\n      if (isDirectory) return\n      const subFilePath = path.relative(patchDir, filePath)\n      const oldFilePath = path.join(oldPatchDir, subFilePath)\n      //文件不存在则拷贝\n      if (!fs.existsSync(oldFilePath)) {\n        archive.append(fs.createReadStream(filePath), { name: subFilePath })\n      } else {\n        //判断md5\n        const newFileMD5 = md5File.sync(filePath)\n        const oldFileMD5 = md5File.sync(oldFilePath)\n        if (newFileMD5 !== oldFileMD5) {\n          archive.append(fs.createReadStream(filePath), { name: subFilePath })\n        }\n      }\n    })\n  })\n}\n\n```\n\n代码文件做增量更新主要通过Google开源的一个[diff-match-patch](https://github.com/google/diff-match-patch)来实现。感觉对于js体积比较大的场景收益高一些，react-native这种比较适合。我们项目采用weex的方案，weex提倡每个页面一个js文件，通常文件的体积也比较小，在这里没有使用这个方案，而是采用和图片资源同样的处理方式。\n\n\n## 二、语义化版本控制\n\n[语义化版本管理](https://semver.org/lang/zh-CN/)是比较公认的一种项目管理方式。规则如下：\n\n```shell\n版本格式：主版本号.次版本号.修订号，版本号递增规则如下：\n\n主版本号：当你做了不兼容的 API 修改，\n次版本号：当你做了向下兼容的功能性新增，\n修订号：当你做了向下兼容的问题修正。\n先行版本号及版本编译信息可以加到“主版本号.次版本号.修订号”的后面，作为延伸。\n\n```\n\n在代码下发管理后台每次新建app版本信息、上传补丁都必须采用语义化版本来命名。\n\n\n## 三、app渠道管理\n\nIOS开发天生只有一个渠道，而Android开发渠道五花八门。有些时候，譬如说运营的app推广需求，我们可能只希望对某一个渠道做功能迭代。所以代码下发服务应该支持针对某一渠道上传资源包，更新功能。\n\n## 四、下发统计\n\n动态化app之后，需要一个工具去衡量用户下载补丁效果。统计主要包含两个纬度：针对某个版本app的下发统计、针对某个补丁(某个功能点)的下发统计。\n\n## 五、日志收集\n\n移动端开发往往调试，看日志会比较困难，特别是项目发布之后，需要一个方案动态收集移动端产生的日志。日志服务说复杂也复杂，说简单也比较简单。首先为了移动端避免频繁发送请求，移动端应该有一个队列，对于同一种类型的错误，只是间隔的收集一次。其次，服务端需要对客户端发送上来的日志做一些处理，主要包括：\n\n+  利用map文件定位原始出错的位置，方便快速定位问题。\n+  日志入库，方面后续做日志分析。可以使用第三方的日志服务，如阿里云`SLS`，或者AWS `CloudWatch`。也可以利用第三方工具，如Elasticsearch 自行搭建日志分析服务。\n+  日志报警。通过对日志分级，对于等级高于`warning`或者`error`日志的信息。应当及时报警通知开发人员。如果原有项目已经对接了第三方报警系统如`promethues`，这里需要做一个适配。\n\n## 六、管理后台页面\n\n所有的以上功能点，最终都希望有一个可视化的方案能够呈现在用户面前。包括但不限于：项目管理、统计查询、补丁上传等。\n\n\n项目源代码：[assets-push](https://github.com/Luncher/assets-push)\n","slug":"资源下发服务","published":1,"updated":"2018-07-01T10:30:46.500Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9ceo005ay4zvqutne1t0","content":"<p>近一两年移动端开发领域掀起了一股动态化的浪潮。当然早几年也有诸如phoneGap, cordova等跨平台的方案。但是随着react-native, weex的出现了把这股浪潮推向了高点。动态化的一大优势在于，省去了繁琐的发版流程，避免了只是为了修改几个icon，就得等待好几天的发版审核这样痛苦的过程。通过动态化，开发者自行管理更新包。精准的控制每次迭代的资源和代码，大大的提高了产品迭代速度。</p>\n<p>代码下发服务主要包含以下几个主要功能点：</p>\n<h2 id=\"一、静态文件托管\"><a href=\"#一、静态文件托管\" class=\"headerlink\" title=\"一、静态文件托管\"></a>一、静态文件托管</h2><p>静态文件管理主要是把每次项目迭代的更新包上传到CDN，同时还应该动态计算每次迭代的差异包，这样可以最大限度的减少移动端下载的资源体积。代码下发服务资源主要包含两个部分：1、图片资源, 2、代码。图片资源的增量比较简单，每次计算文件<code>md5</code>。同时把之前不存在的图片资源拷贝到新的增量包</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">doPatchDiff: <span class=\"keyword\">async</span> <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">patchDir, oldPatchDir, diffPatchKey, diffPatchDir</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> walker = <span class=\"keyword\">new</span> Walker()</span><br><span class=\"line\">    <span class=\"comment\">//创建一个临时目录放置增量包</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> output = fs.createWriteStream(diffPatchDir)</span><br><span class=\"line\">    <span class=\"keyword\">const</span> archive = archiver(<span class=\"string\">'zip'</span>, &#123;</span><br><span class=\"line\">      zlib: &#123; <span class=\"attr\">level</span>: <span class=\"number\">9</span> &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">    archive.pipe(output)</span><br><span class=\"line\">    walker.on(<span class=\"string\">'error'</span>, reject)</span><br><span class=\"line\">    archive.on(<span class=\"string\">'error'</span>, reject)</span><br><span class=\"line\">    archive.on(<span class=\"string\">'warning'</span>, reject)</span><br><span class=\"line\">    output.on(<span class=\"string\">'close'</span>, () =&gt; &#123;</span><br><span class=\"line\">      <span class=\"comment\">//上传增量包</span></span><br><span class=\"line\">      <span class=\"keyword\">this</span>.uploadPatchDiff(diffPatchKey, diffPatchDir)</span><br><span class=\"line\">        .then(<span class=\"function\"><span class=\"params\">res</span> =&gt;</span> resolve(res))</span><br><span class=\"line\">        .catch(reject)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">    walker.on(<span class=\"string\">'end'</span>, () =&gt; &#123;</span><br><span class=\"line\">      archive.finalize()</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">    walker.walk(patchDir, (filePath, isDirectory) =&gt; &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (isDirectory) <span class=\"keyword\">return</span></span><br><span class=\"line\">      <span class=\"keyword\">const</span> subFilePath = path.relative(patchDir, filePath)</span><br><span class=\"line\">      <span class=\"keyword\">const</span> oldFilePath = path.join(oldPatchDir, subFilePath)</span><br><span class=\"line\">      <span class=\"comment\">//文件不存在则拷贝</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!fs.existsSync(oldFilePath)) &#123;</span><br><span class=\"line\">        archive.append(fs.createReadStream(filePath), &#123; <span class=\"attr\">name</span>: subFilePath &#125;)</span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">//判断md5</span></span><br><span class=\"line\">        <span class=\"keyword\">const</span> newFileMD5 = md5File.sync(filePath)</span><br><span class=\"line\">        <span class=\"keyword\">const</span> oldFileMD5 = md5File.sync(oldFilePath)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (newFileMD5 !== oldFileMD5) &#123;</span><br><span class=\"line\">          archive.append(fs.createReadStream(filePath), &#123; <span class=\"attr\">name</span>: subFilePath &#125;)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>代码文件做增量更新主要通过Google开源的一个<a href=\"https://github.com/google/diff-match-patch\" target=\"_blank\" rel=\"noopener\">diff-match-patch</a>来实现。感觉对于js体积比较大的场景收益高一些，react-native这种比较适合。我们项目采用weex的方案，weex提倡每个页面一个js文件，通常文件的体积也比较小，在这里没有使用这个方案，而是采用和图片资源同样的处理方式。</p>\n<h2 id=\"二、语义化版本控制\"><a href=\"#二、语义化版本控制\" class=\"headerlink\" title=\"二、语义化版本控制\"></a>二、语义化版本控制</h2><p><a href=\"https://semver.org/lang/zh-CN/\" target=\"_blank\" rel=\"noopener\">语义化版本管理</a>是比较公认的一种项目管理方式。规则如下：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">版本格式：主版本号.次版本号.修订号，版本号递增规则如下：</span><br><span class=\"line\"></span><br><span class=\"line\">主版本号：当你做了不兼容的 API 修改，</span><br><span class=\"line\">次版本号：当你做了向下兼容的功能性新增，</span><br><span class=\"line\">修订号：当你做了向下兼容的问题修正。</span><br><span class=\"line\">先行版本号及版本编译信息可以加到“主版本号.次版本号.修订号”的后面，作为延伸。</span><br></pre></td></tr></table></figure>\n<p>在代码下发管理后台每次新建app版本信息、上传补丁都必须采用语义化版本来命名。</p>\n<h2 id=\"三、app渠道管理\"><a href=\"#三、app渠道管理\" class=\"headerlink\" title=\"三、app渠道管理\"></a>三、app渠道管理</h2><p>IOS开发天生只有一个渠道，而Android开发渠道五花八门。有些时候，譬如说运营的app推广需求，我们可能只希望对某一个渠道做功能迭代。所以代码下发服务应该支持针对某一渠道上传资源包，更新功能。</p>\n<h2 id=\"四、下发统计\"><a href=\"#四、下发统计\" class=\"headerlink\" title=\"四、下发统计\"></a>四、下发统计</h2><p>动态化app之后，需要一个工具去衡量用户下载补丁效果。统计主要包含两个纬度：针对某个版本app的下发统计、针对某个补丁(某个功能点)的下发统计。</p>\n<h2 id=\"五、日志收集\"><a href=\"#五、日志收集\" class=\"headerlink\" title=\"五、日志收集\"></a>五、日志收集</h2><p>移动端开发往往调试，看日志会比较困难，特别是项目发布之后，需要一个方案动态收集移动端产生的日志。日志服务说复杂也复杂，说简单也比较简单。首先为了移动端避免频繁发送请求，移动端应该有一个队列，对于同一种类型的错误，只是间隔的收集一次。其次，服务端需要对客户端发送上来的日志做一些处理，主要包括：</p>\n<ul>\n<li>利用map文件定位原始出错的位置，方便快速定位问题。</li>\n<li>日志入库，方面后续做日志分析。可以使用第三方的日志服务，如阿里云<code>SLS</code>，或者AWS <code>CloudWatch</code>。也可以利用第三方工具，如Elasticsearch 自行搭建日志分析服务。</li>\n<li>日志报警。通过对日志分级，对于等级高于<code>warning</code>或者<code>error</code>日志的信息。应当及时报警通知开发人员。如果原有项目已经对接了第三方报警系统如<code>promethues</code>，这里需要做一个适配。</li>\n</ul>\n<h2 id=\"六、管理后台页面\"><a href=\"#六、管理后台页面\" class=\"headerlink\" title=\"六、管理后台页面\"></a>六、管理后台页面</h2><p>所有的以上功能点，最终都希望有一个可视化的方案能够呈现在用户面前。包括但不限于：项目管理、统计查询、补丁上传等。</p>\n<p>项目源代码：<a href=\"https://github.com/Luncher/assets-push\" target=\"_blank\" rel=\"noopener\">assets-push</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p>近一两年移动端开发领域掀起了一股动态化的浪潮。当然早几年也有诸如phoneGap, cordova等跨平台的方案。但是随着react-native, weex的出现了把这股浪潮推向了高点。动态化的一大优势在于，省去了繁琐的发版流程，避免了只是为了修改几个icon，就得等待好几天的发版审核这样痛苦的过程。通过动态化，开发者自行管理更新包。精准的控制每次迭代的资源和代码，大大的提高了产品迭代速度。</p>\n<p>代码下发服务主要包含以下几个主要功能点：</p>\n<h2 id=\"一、静态文件托管\"><a href=\"#一、静态文件托管\" class=\"headerlink\" title=\"一、静态文件托管\"></a>一、静态文件托管</h2><p>静态文件管理主要是把每次项目迭代的更新包上传到CDN，同时还应该动态计算每次迭代的差异包，这样可以最大限度的减少移动端下载的资源体积。代码下发服务资源主要包含两个部分：1、图片资源, 2、代码。图片资源的增量比较简单，每次计算文件<code>md5</code>。同时把之前不存在的图片资源拷贝到新的增量包</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">doPatchDiff: <span class=\"keyword\">async</span> <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">patchDir, oldPatchDir, diffPatchKey, diffPatchDir</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> walker = <span class=\"keyword\">new</span> Walker()</span><br><span class=\"line\">    <span class=\"comment\">//创建一个临时目录放置增量包</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> output = fs.createWriteStream(diffPatchDir)</span><br><span class=\"line\">    <span class=\"keyword\">const</span> archive = archiver(<span class=\"string\">'zip'</span>, &#123;</span><br><span class=\"line\">      zlib: &#123; <span class=\"attr\">level</span>: <span class=\"number\">9</span> &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">    archive.pipe(output)</span><br><span class=\"line\">    walker.on(<span class=\"string\">'error'</span>, reject)</span><br><span class=\"line\">    archive.on(<span class=\"string\">'error'</span>, reject)</span><br><span class=\"line\">    archive.on(<span class=\"string\">'warning'</span>, reject)</span><br><span class=\"line\">    output.on(<span class=\"string\">'close'</span>, () =&gt; &#123;</span><br><span class=\"line\">      <span class=\"comment\">//上传增量包</span></span><br><span class=\"line\">      <span class=\"keyword\">this</span>.uploadPatchDiff(diffPatchKey, diffPatchDir)</span><br><span class=\"line\">        .then(<span class=\"function\"><span class=\"params\">res</span> =&gt;</span> resolve(res))</span><br><span class=\"line\">        .catch(reject)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">    walker.on(<span class=\"string\">'end'</span>, () =&gt; &#123;</span><br><span class=\"line\">      archive.finalize()</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">    walker.walk(patchDir, (filePath, isDirectory) =&gt; &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (isDirectory) <span class=\"keyword\">return</span></span><br><span class=\"line\">      <span class=\"keyword\">const</span> subFilePath = path.relative(patchDir, filePath)</span><br><span class=\"line\">      <span class=\"keyword\">const</span> oldFilePath = path.join(oldPatchDir, subFilePath)</span><br><span class=\"line\">      <span class=\"comment\">//文件不存在则拷贝</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!fs.existsSync(oldFilePath)) &#123;</span><br><span class=\"line\">        archive.append(fs.createReadStream(filePath), &#123; <span class=\"attr\">name</span>: subFilePath &#125;)</span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">//判断md5</span></span><br><span class=\"line\">        <span class=\"keyword\">const</span> newFileMD5 = md5File.sync(filePath)</span><br><span class=\"line\">        <span class=\"keyword\">const</span> oldFileMD5 = md5File.sync(oldFilePath)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (newFileMD5 !== oldFileMD5) &#123;</span><br><span class=\"line\">          archive.append(fs.createReadStream(filePath), &#123; <span class=\"attr\">name</span>: subFilePath &#125;)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>代码文件做增量更新主要通过Google开源的一个<a href=\"https://github.com/google/diff-match-patch\" target=\"_blank\" rel=\"noopener\">diff-match-patch</a>来实现。感觉对于js体积比较大的场景收益高一些，react-native这种比较适合。我们项目采用weex的方案，weex提倡每个页面一个js文件，通常文件的体积也比较小，在这里没有使用这个方案，而是采用和图片资源同样的处理方式。</p>\n<h2 id=\"二、语义化版本控制\"><a href=\"#二、语义化版本控制\" class=\"headerlink\" title=\"二、语义化版本控制\"></a>二、语义化版本控制</h2><p><a href=\"https://semver.org/lang/zh-CN/\" target=\"_blank\" rel=\"noopener\">语义化版本管理</a>是比较公认的一种项目管理方式。规则如下：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">版本格式：主版本号.次版本号.修订号，版本号递增规则如下：</span><br><span class=\"line\"></span><br><span class=\"line\">主版本号：当你做了不兼容的 API 修改，</span><br><span class=\"line\">次版本号：当你做了向下兼容的功能性新增，</span><br><span class=\"line\">修订号：当你做了向下兼容的问题修正。</span><br><span class=\"line\">先行版本号及版本编译信息可以加到“主版本号.次版本号.修订号”的后面，作为延伸。</span><br></pre></td></tr></table></figure>\n<p>在代码下发管理后台每次新建app版本信息、上传补丁都必须采用语义化版本来命名。</p>\n<h2 id=\"三、app渠道管理\"><a href=\"#三、app渠道管理\" class=\"headerlink\" title=\"三、app渠道管理\"></a>三、app渠道管理</h2><p>IOS开发天生只有一个渠道，而Android开发渠道五花八门。有些时候，譬如说运营的app推广需求，我们可能只希望对某一个渠道做功能迭代。所以代码下发服务应该支持针对某一渠道上传资源包，更新功能。</p>\n<h2 id=\"四、下发统计\"><a href=\"#四、下发统计\" class=\"headerlink\" title=\"四、下发统计\"></a>四、下发统计</h2><p>动态化app之后，需要一个工具去衡量用户下载补丁效果。统计主要包含两个纬度：针对某个版本app的下发统计、针对某个补丁(某个功能点)的下发统计。</p>\n<h2 id=\"五、日志收集\"><a href=\"#五、日志收集\" class=\"headerlink\" title=\"五、日志收集\"></a>五、日志收集</h2><p>移动端开发往往调试，看日志会比较困难，特别是项目发布之后，需要一个方案动态收集移动端产生的日志。日志服务说复杂也复杂，说简单也比较简单。首先为了移动端避免频繁发送请求，移动端应该有一个队列，对于同一种类型的错误，只是间隔的收集一次。其次，服务端需要对客户端发送上来的日志做一些处理，主要包括：</p>\n<ul>\n<li>利用map文件定位原始出错的位置，方便快速定位问题。</li>\n<li>日志入库，方面后续做日志分析。可以使用第三方的日志服务，如阿里云<code>SLS</code>，或者AWS <code>CloudWatch</code>。也可以利用第三方工具，如Elasticsearch 自行搭建日志分析服务。</li>\n<li>日志报警。通过对日志分级，对于等级高于<code>warning</code>或者<code>error</code>日志的信息。应当及时报警通知开发人员。如果原有项目已经对接了第三方报警系统如<code>promethues</code>，这里需要做一个适配。</li>\n</ul>\n<h2 id=\"六、管理后台页面\"><a href=\"#六、管理后台页面\" class=\"headerlink\" title=\"六、管理后台页面\"></a>六、管理后台页面</h2><p>所有的以上功能点，最终都希望有一个可视化的方案能够呈现在用户面前。包括但不限于：项目管理、统计查询、补丁上传等。</p>\n<p>项目源代码：<a href=\"https://github.com/Luncher/assets-push\" target=\"_blank\" rel=\"noopener\">assets-push</a></p>\n"},{"title":"通用日志模块设计","date":"2013-12-19T12:53:42.000Z","_content":"\n 在程序设计世界里，大大小小的项目都会有自己的日志模块。网络上有很多开源的Log模块，在这里算是以学习为目的重新造了一次轮子，也方便以后项目过程直接可以用上。\n\n    按照abused老师的说法，设计一个Log模块需要注意以下几点：1.按照重要程度过滤Log信息，在程序设计阶段我们会打印一些调试信息，但是在程序release的时候要把调试信息关闭了。在这里，我把Log信息按照严重程度划分为8个级别：\n\ntypedef enum tagLogLevel\n{\nLC_LOG_PANIC = 0,\nLC_LOG_ALERT = 1,\nLC_LOG_CRIT = 2,\nLC_LOG_ERR = 3,\nLC_LOG_WARN = 4,\nLC_LOG_NOTICE = 5,\nLC_LOG_INFO = 6,\nLC_LOG_DEBUG = 7,\nLC_LOG_MAX = 8\n}LogLevel;\n\n     1. 枚举从小到大严重程度依次递减。DEBUG纯粹是调试的时候打印，INFO答应一些信息，NOTICE提示一些轻微的警告信息，以此类推。\n\n     2.按照模块过滤Log，大的项目由一些小模块组成，按照模块过滤Log利于更快的定位错误信息，系统太大，按照模块关闭一些模块，有利于我们查找错误所在，也节省了Log信息占用的资源。\n\n     3.Log模块可配置，平时写控制台应用程序只需要把Log信息输出到控制台，真正项目过程中，Log信息有可能保存在文件里，也有可能通过串口，或者网络发送给其他模块，因此Log模块输出的可配置性也是关键。\n\n     4.可变参数的支持，现在的编译器一般都支持可变参数，对于GNUC编译器还可以支持可变参数动态的参数检查：\n\nvoid lc_log(LcLog* thiz, int level, const char* format, ...)\n#ifdef __GNUC__\n__attribute__(formate(printf, 2, 3))\n#endif\n\n    按照printf的参数风格对lc_log函数的2，3两个参数规则检查。\n\n    5.编译器定义的一些和调试信息有关的宏。Log信息我们需要知道打印的时候，程序编译的时间，Log出自哪个文件的哪个函数等。编译器相关的一些宏主要有：__DATE__/__TIME__,标识程序编译的时间日期。__FILE__/__LINE__/__func__(GNUC)标识打印Log信息所在的文件位置信息。","source":"_posts/通用日志模块设计.md","raw":"---\ntitle: 通用日志模块设计\ndate: 2013-12-19 20:53:42\ntags: log\ncategories: server\n---\n\n 在程序设计世界里，大大小小的项目都会有自己的日志模块。网络上有很多开源的Log模块，在这里算是以学习为目的重新造了一次轮子，也方便以后项目过程直接可以用上。\n\n    按照abused老师的说法，设计一个Log模块需要注意以下几点：1.按照重要程度过滤Log信息，在程序设计阶段我们会打印一些调试信息，但是在程序release的时候要把调试信息关闭了。在这里，我把Log信息按照严重程度划分为8个级别：\n\ntypedef enum tagLogLevel\n{\nLC_LOG_PANIC = 0,\nLC_LOG_ALERT = 1,\nLC_LOG_CRIT = 2,\nLC_LOG_ERR = 3,\nLC_LOG_WARN = 4,\nLC_LOG_NOTICE = 5,\nLC_LOG_INFO = 6,\nLC_LOG_DEBUG = 7,\nLC_LOG_MAX = 8\n}LogLevel;\n\n     1. 枚举从小到大严重程度依次递减。DEBUG纯粹是调试的时候打印，INFO答应一些信息，NOTICE提示一些轻微的警告信息，以此类推。\n\n     2.按照模块过滤Log，大的项目由一些小模块组成，按照模块过滤Log利于更快的定位错误信息，系统太大，按照模块关闭一些模块，有利于我们查找错误所在，也节省了Log信息占用的资源。\n\n     3.Log模块可配置，平时写控制台应用程序只需要把Log信息输出到控制台，真正项目过程中，Log信息有可能保存在文件里，也有可能通过串口，或者网络发送给其他模块，因此Log模块输出的可配置性也是关键。\n\n     4.可变参数的支持，现在的编译器一般都支持可变参数，对于GNUC编译器还可以支持可变参数动态的参数检查：\n\nvoid lc_log(LcLog* thiz, int level, const char* format, ...)\n#ifdef __GNUC__\n__attribute__(formate(printf, 2, 3))\n#endif\n\n    按照printf的参数风格对lc_log函数的2，3两个参数规则检查。\n\n    5.编译器定义的一些和调试信息有关的宏。Log信息我们需要知道打印的时候，程序编译的时间，Log出自哪个文件的哪个函数等。编译器相关的一些宏主要有：__DATE__/__TIME__,标识程序编译的时间日期。__FILE__/__LINE__/__func__(GNUC)标识打印Log信息所在的文件位置信息。","slug":"通用日志模块设计","published":1,"updated":"2018-11-21T15:05:07.402Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9ceo005dy4zv1dqu81xd","content":"<p> 在程序设计世界里，大大小小的项目都会有自己的日志模块。网络上有很多开源的Log模块，在这里算是以学习为目的重新造了一次轮子，也方便以后项目过程直接可以用上。</p>\n<pre><code>按照abused老师的说法，设计一个Log模块需要注意以下几点：1.按照重要程度过滤Log信息，在程序设计阶段我们会打印一些调试信息，但是在程序release的时候要把调试信息关闭了。在这里，我把Log信息按照严重程度划分为8个级别：\n</code></pre><p>typedef enum tagLogLevel<br>{<br>LC_LOG_PANIC = 0,<br>LC_LOG_ALERT = 1,<br>LC_LOG_CRIT = 2,<br>LC_LOG_ERR = 3,<br>LC_LOG_WARN = 4,<br>LC_LOG_NOTICE = 5,<br>LC_LOG_INFO = 6,<br>LC_LOG_DEBUG = 7,<br>LC_LOG_MAX = 8<br>}LogLevel;</p>\n<pre><code>1. 枚举从小到大严重程度依次递减。DEBUG纯粹是调试的时候打印，INFO答应一些信息，NOTICE提示一些轻微的警告信息，以此类推。\n\n2.按照模块过滤Log，大的项目由一些小模块组成，按照模块过滤Log利于更快的定位错误信息，系统太大，按照模块关闭一些模块，有利于我们查找错误所在，也节省了Log信息占用的资源。\n\n3.Log模块可配置，平时写控制台应用程序只需要把Log信息输出到控制台，真正项目过程中，Log信息有可能保存在文件里，也有可能通过串口，或者网络发送给其他模块，因此Log模块输出的可配置性也是关键。\n\n4.可变参数的支持，现在的编译器一般都支持可变参数，对于GNUC编译器还可以支持可变参数动态的参数检查：\n</code></pre><p>void lc_log(LcLog<em> thiz, int level, const char</em> format, …)</p>\n<p>#ifdef <strong>GNUC</strong><br><strong>attribute</strong>(formate(printf, 2, 3))</p>\n<p>#endif</p>\n<pre><code>按照printf的参数风格对lc_log函数的2，3两个参数规则检查。\n\n5.编译器定义的一些和调试信息有关的宏。Log信息我们需要知道打印的时候，程序编译的时间，Log出自哪个文件的哪个函数等。编译器相关的一些宏主要有：__DATE__/__TIME__,标识程序编译的时间日期。__FILE__/__LINE__/__func__(GNUC)标识打印Log信息所在的文件位置信息。\n</code></pre>","site":{"data":{}},"excerpt":"","more":"<p> 在程序设计世界里，大大小小的项目都会有自己的日志模块。网络上有很多开源的Log模块，在这里算是以学习为目的重新造了一次轮子，也方便以后项目过程直接可以用上。</p>\n<pre><code>按照abused老师的说法，设计一个Log模块需要注意以下几点：1.按照重要程度过滤Log信息，在程序设计阶段我们会打印一些调试信息，但是在程序release的时候要把调试信息关闭了。在这里，我把Log信息按照严重程度划分为8个级别：\n</code></pre><p>typedef enum tagLogLevel<br>{<br>LC_LOG_PANIC = 0,<br>LC_LOG_ALERT = 1,<br>LC_LOG_CRIT = 2,<br>LC_LOG_ERR = 3,<br>LC_LOG_WARN = 4,<br>LC_LOG_NOTICE = 5,<br>LC_LOG_INFO = 6,<br>LC_LOG_DEBUG = 7,<br>LC_LOG_MAX = 8<br>}LogLevel;</p>\n<pre><code>1. 枚举从小到大严重程度依次递减。DEBUG纯粹是调试的时候打印，INFO答应一些信息，NOTICE提示一些轻微的警告信息，以此类推。\n\n2.按照模块过滤Log，大的项目由一些小模块组成，按照模块过滤Log利于更快的定位错误信息，系统太大，按照模块关闭一些模块，有利于我们查找错误所在，也节省了Log信息占用的资源。\n\n3.Log模块可配置，平时写控制台应用程序只需要把Log信息输出到控制台，真正项目过程中，Log信息有可能保存在文件里，也有可能通过串口，或者网络发送给其他模块，因此Log模块输出的可配置性也是关键。\n\n4.可变参数的支持，现在的编译器一般都支持可变参数，对于GNUC编译器还可以支持可变参数动态的参数检查：\n</code></pre><p>void lc_log(LcLog<em> thiz, int level, const char</em> format, …)</p>\n<p>#ifdef <strong>GNUC</strong><br><strong>attribute</strong>(formate(printf, 2, 3))</p>\n<p>#endif</p>\n<pre><code>按照printf的参数风格对lc_log函数的2，3两个参数规则检查。\n\n5.编译器定义的一些和调试信息有关的宏。Log信息我们需要知道打印的时候，程序编译的时间，Log出自哪个文件的哪个函数等。编译器相关的一些宏主要有：__DATE__/__TIME__,标识程序编译的时间日期。__FILE__/__LINE__/__func__(GNUC)标识打印Log信息所在的文件位置信息。\n</code></pre>"},{"title":"nginx服务器完整配置","date":"2018-11-11T09:01:39.000Z","_content":"\n### 基本参数配置\n\n+ `main context`配置:\n\n#### worker进程启动用户、用户组\n\n```shell\nuser nginx nginx;\n```\n\n#### worker进程数量\n\n```shell\nworker_processes  2;\n```\n\n#### master进程id存放的文件位置\n\n```shell\npid /home/www/nginx/nginx.pid;\n```\n\n#### 错误日志\n\n```shell\nerror_log /home/www/nginx/log/error.log warn;\n```\n>前面是文件存放的位置，后面是日志的错误等级。如果要设置为`debug`需要在编译`nginx`的时候加上`--with-debug`选项。\n\n\n#### 设置单个worker进程的最大连接数\n\n```shell\nevents {\n  worker_connections  512;\n}\n```\n>这里的最大连接数\b包括了，和代理服务器的连接、和客户端的连接等。另外需要注意的是，实际同时建立的最大连接数不能超过最大允许打开的文件数量。可以通过`worker_rlimit_nofile`选项来配置。\n\n#### 设置单个worker进程最大允许打开文件数量\n\n```shell\nworker_rlimit_nofile  8192;\n```\n\n`main context`配置预览:\n\n```shell\nuser nginx nginx;\nworker_processes  2;\npid   /home/www/nginx/nginx.pid;\nerror_log /home/www/nginx/log/error.log warn;\nworker_rlimit_nofile  2048;\nevents {\n  worker_connections  1024;\n}\n```\n\n`main context`的配置可以参考[ngx_core_module](https://nginx.org/en/docs/ngx_core_module.html)。\n\n\n+ `http block`配置:\n\n#### 设置http请求日志\n\n```shell\nlog_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                  '$status $body_bytes_sent \"$http_referer\" '\n                  '\"$http_user_agent\" \"$http_x_forwarded_for\"';\naccess_log  /home/www/nginx/log/access.log  main;\n```\n\n#### 定义MIME type 到文件拓展\b名的映射\n\n```shell\ninclude       /etc/nginx/mime.types;\n#默认的MIME type\ndefault_type  application/octet-stream;\n```\n\n#### 优化文件传送\n\n```shell\n#磁盘文件从内核态直接发送到网卡设备，避免了拷贝到用户态的开销。\nsendfile       on;\n\n#开启TCP_CORK选项，当数据包达到固定大小才开始传送。\ntcp_nopush     on;\n```\n\n#### 设置客户端连接超时时间\n\n```shell\nkeepalive_timeout  65s;\n```\n>当时间超过65秒，客户端到服务器的连接将会断开。可以把时间设置的稍微短一些，加快无用连接的回收。\n\n#### 开启基本文件目录功能\n\n```shell\nautoindex on;\n```\n>`autoindex`依赖于[ngx_http_autoindex_module](https://nginx.org/en/docs/http/ngx_http_autoindex_module.html)。\n\n`http block`配置预览：\n\n```shell\nhttp {\n  include       /etc/nginx/mime.types;\n  default_type  application/octet-stream;\n\n  log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                       '$status $body_bytes_sent \"$http_referer\" '\n                       '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n  access_log  /home/www/nginx/log/access.log  main;\n\n  sendfile        on;\n  tcp_nopush      on;\n\n  keepalive_timeout  65s;\n}\n```\n\n---\n\n### 反向代理配置\n\n反向代理相关的配置一般都放置在`nginx/conf.d`目录下，以`hostname`命名。\n\n#### 虚拟主机与请求的分发\n\n```shell\nlisten 443 ssl default_server;\nserver_name bitsum.pro *.bitsum.pro;\n```\n>\b一个`server block`对应一个虚拟主机的配置，`default_server`当请求找不到虚拟主机的时候，该虚拟主机作为默认的虚拟主机接受请求。\n\n\n#### 定义反向代理的`host`、负载均衡\n\n```shell\nupstream backend_hosts {\n  server  47.75.216.4;\n}\n```\n>`upstream`block里面可以配置负载均衡算法、权重等信息。\n\n**几种负载均衡算法：**\n\n+ round robin\n>默认的均衡算法，客户端请求被\b轮流分配到上游服务器。\n+ least_conn\n>新的客户端连接被分配到最少活跃连接数的上游服务器。\n+ ip_hash\n>用客户端ip做为hash的key，前三位8字节决定哪一个服务器处理这个客户端请求。这种算法可以保证`session`一致性。\n+ hash\n>基于客户端传递的数据做hash。\n\n**设置服务器权重:**\n```shell\nupstream backend_hosts {\n  server host1.example.com weight=3;\n  server host2.example.com;\n}\n```\n>默认每一个`host`的权重都是1，`host1`接受的请求量将会是`host2`的三倍。\n\n\n#### 指定上游被代理的服务器、设置额外的请求头\n\n```shell\nlocation / {\n  #所有请求都被转发到`backend_hosts`\n  proxy_pass  http://backend_hosts;\n  #设置客户端请求host\n  proxy_set_header    HOST $host;\n  #设置客户端请求协议(http、https)\n  proxy_set_header    X-Forwarded-Proto $scheme;\n  #把客户端的真实ip通过`X-Real-IP`透传到上游服务器\n  proxy_set_header    X-Real-IP $remote_addr;\n  #代理服务器地址列表、上层代理服务器地址添加到后面\n  proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;\n}\n```\n\n\n### 使用Buffer缓存数据\n\n*为什么`buffer`能优化代理\b请求呢？*\n\n当没有开启`buffer`的时候，被代理的上游服务器的数据立刻被代理服务器转送到客户端。如果客户端处理的足够快，可以关闭\b`buffer`的功能，以便客户端尽可能快的获得数据。当`buffer`功能开启的时候，代理服务器会暂存上游服务器返回的数据，然后再反馈给客户端。如果客户端接受数据的速度过慢，`nginx`会关闭到代理服务器的连接。然后以适合的速度发送数据给客户端。\n\n\n`Buffer`相关配置命令:\n\n+ proxy_buffering\n>控制是否开启`buffering`功能。\n\n+ proxy_buffers\n>控制缓存代理响应的块的个数以及大小。\n\n+ proxy_buffer_size\n>控制缓存代理响应头部的大小, 默认等于proxy_buffers配置的`size`大小，\b由于响应头比较小，可以适当设置小一点。(当proxy_buffering关闭的时候，依然可以使用。)\n\n+ proxy_busy_buffers_size\n>控制发送数据给客户端的缓存的大小。\n\n+ proxy_max_temp_file_size\n>当上游服务器的响应过大的时候，会被缓存在一个临时的磁盘文件里面。该指令配置缓存文件的大小。\n\n+ proxy_temp_file_write_size\n>当上游服务器的响应过大的时候，会被缓存在一个临时的磁盘文件里面。该指令配置一次写入缓存文件的数据大小。\n\n+ proxy_temp_path\n>缓存临时文件存放目录。\n\n\n### 设置`Cache`缓存静态数据\n\n`Cache`相关配置命令:\n\n+ proxy_cache_path  \n基本格式：\n  `proxy_cache_path    /home/www/nginx/cache   levels=1:2  keys_zone=backcache:8m max_size=50m use_temp_path=off;`\n>`/home/www/nginx/cache`作为缓存路径，如果不存在需要新建，并且设置好目录的权限：\n\n```shell\nmkdir -p /home/www/nginx/cache\n#根据启动worker进程的用户, 这里设置为对应的用户\nsudo chown nginx.nginx /home/www/nginx/cache\nsudo chmod 700 /home/www/nginx/cache\n```\n\n`levels`设置缓存的目录结构层次，缓存`key`的最后一个字节作为一级子目录的名称，倒数二三两个字节作为二级缓存子目录的名称。\n\n`keys_zone`定义缓存区域的名称，这里称之为`backcache`。最多有8m的缓存`key`，缓存数据的最大大小为`50m`。\n\n\n+ proxy_cache_key(定义缓存`key`的格式)\n  基本格式：  \n  `proxy_cache_key     \"$scheme$request_method$host$request_uri$is_args$args\";`\n\n\n+ proxy_cache_valid\n  基本格式：  \n  `proxy_cache_valid   404 1m;`\n>根据状态码来控制缓存的有效时间，上例中，缓存404响应的有效时间为1分钟。\n\n**启用Cache**\n上面定义了`cache`的基本配置，现在要告诉`nginx`那里应该开启`cache`。\n\n```shell\nlocation ~ ^/(admin|download|miner-client|mobile|static|website)/ {\n  #使用backcache这个cache zone\n  proxy_cache backcache;\n\n  #允许客户端通过http请求头\b控制跳过缓存请求最新的数据\n  proxy_cache_bypass  $http_cache_control;\n\n  #添加一个头部信息，对于一个请求可以清晰的看到，是被缓存了、缓存失效等状态信息。\n  add_header X-Proxy-Cache $upstream_cache_status;\n\n  proxy_pass  http://backend_hosts;\n}\n```\n\n**开启gzip压缩**\n\n```shell\nserver {\n  #开启gzip压缩功能\n  gzip on;\n\n  #设置启用gzip的http版本信息\n  gzip_http_version   1.0;\n\n  #设置gzip压缩等级\n  gzip_comp_level   5;\n\n  #设置当Content-Length大于256的时候启用gzip配置\n  gzip_min_length   256;\n\n  #对所有的代理请求都启用gzip\n  gzip_proxied  any;\n\n  #添加“Vary: Accept-Encoding”到请求头部告知代理服务器是否支持gzip压缩\n  gzip_vary   on;\n\n  #设置需要压缩的MIME types\n  gzip_types\n    application/atom+xml\n    application/javascript\n    application/json\n    application/rss+xml\n    application/vnd.ms-fontobject\n    application/x-font-ttf\n    application/x-web-app-manifest+json\n    application/xhtml+xml\n    application/xml\n    font/opentype\n    image/svg+xml\n    image/x-icon\n    text/css\n    text/plain\n    text/x-component;\n}\n```\n\n### 给你的网站加上https证书\n\n要给网站开启`https`，那么\b你需要从证书颁发机构(CA)获得一个证书文件，[letsencrypt](https://letsencrypt.org/)是一个免费开放的证书颁发机构。接下来，你需要证明这个域名你实际拥有控制权，这需要通过[ACME protocol](https://ietf-wg-acme.github.io/acme/)协议来保障。\n\n[certbot](https://certbot.eff.org/)是一个`ACME`的客户端，在你的主机运行它自动生成证书文件，与此同时主机不需要停机。\n\nletsencrypt原理图：\n\n![letEncrypt](/img/letEncrypt原理图.png)\n\n>LetEncrypt会发送请求到`ACME`运行的服务器，校验所有权是否合法。\n\n接下来看看如何配置：\n\n因为系统主机安装了`docker`，`certbot`刚好也有对应的镜像文件：\n\n```shell\nsudo docker run -it --name certbot  -p 80:80 \\\n  -v /home/www/nginx/html:/usr/share/nginx/html \\\n  -v /home/www/mycertificate/letsencrypt:/etc/letsencrypt \\\n  -v /home/www/mycertificate/letsencrypt-lib/:/var/lib/letsencrypt \\\n  certbot/certbot certonly\n```\n\n允许上面命令的时候，会出现一系列交互提示出现：\n\n\nHow would you like to authenticate with the ACME CA?\n- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -\n1: Spin up a temporary webserver (standalone)\n2: Place files in webroot directory (webroot)\n- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -\nSelect the appropriate number [1-2] then [enter] (press 'c' to cancel):\n\n因为代理服务器还没有启动起来，这里选择`standalone`模式，就把`ACME`当作一个临时的web服务器。\n\n\nPlugins selected: Authenticator standalone, Installer None\nEnter email address (used for urgent renewal and security notices) (Enter 'c' to\ncancel):\n\n要求填写一个邮箱地址，接受证书过期的提示，以及一些安全提醒等。\n\nPlease read the Terms of Service at\nhttps://letsencrypt.org/documents/LE-SA-v1.2-November-15-2017.pdf. You must\nagree in order to register with the ACME server at\nhttps://acme-v02.api.letsencrypt.org/directory\n- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -\n(A)gree/(C)ancel: A\n\n同意`letsencrypt`这个组织的服务条款。\n\n- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -\nWould you be willing to share your email address with the Electronic Frontier\nFoundation, a founding partner of the Let's Encrypt project and the non-profit\norganization that develops Certbot? We'd like to send you email about our work\nencrypting the web, EFF news, campaigns, and ways to support digital freedom.\n- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -\n(Y)es/(N)o: Y\nPlease enter in your domain name(s) (comma and/or space separated)  (Enter 'c'\nto cancel):\n\n提示输入\b要开启`https`的域名，多个域名用逗号或者空格分开。\n\n>证书生成完毕之后会在`/home/www/mycertificate/letsencrypt`目录下有相应的文件，值得注意的是，多个域名共用一个证书文件。所以如果你在上一步配置了多个域名，这里也只能看到一个证书文件。\n\n*nginx 配置`https`证书*\n\n```shell\nserver {\n  listen 443 ssl default_server;\n  server_name bitsum.pro *.bitsum.pro;\n  #PEM格式的证书文件\n  ssl_certificate     /home/www/mycertificate/letsencrypt/live/dev.bitsum.pro/fullchain.pem;\n  #证书文件的密钥\n  ssl_certificate_key /home/www/mycertificate/letsencrypt/live/dev.bitsum.pro/privkey.pem;\n  #指定https的协议版本\n  ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;\n  # 启用指定的OpenSSL ciphers\n  ssl_ciphers         HIGH:!aNULL:!MD5;\n}\n```\n\n启动`nginx`服务：\n\n```shell\nsudo nginx -c /home/www/nginx/nginx.conf\n```\n\n**完整配置文件**\n\n*nginx.conf:*\n\n```shell\nuser  nginx nginx;\nworker_processes  2;\n\npid        /home/www/nginx/nginx.pid;\nerror_log  /home/www/nginx/log/error.log warn;\n\nworker_rlimit_nofile    2048;\nevents {\n  worker_connections  1024;\n }\n \n http {\n    include       /etc/nginx/mime.types;\n    default_type  application/octet-stream;\n\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n    access_log  /home/www/nginx/log/access.log  main;\n\n    sendfile        on;\n    tcp_nopush     on;\n\n    keepalive_timeout  65s;\n\n    autoindex  on;\n \n    proxy_cache_path    /home/www/nginx/cache   levels=1:2  keys_zone=backcache:8m max_size=50m use_temp_path=off;\n    proxy_cache_key     \"$scheme$request_method$host$request_uri$is_args$args\";\n    proxy_cache_valid   302 10m;\n    proxy_cache_valid   404 1m;\n \n    include /home/www/nginx/conf.d/*.conf;\n }\n```\n*config.d/bitsum.pro.conf:*\n\n```shell\nserver {\n    listen 80;\n    server_name bitsum.pro;\n    return 301 https://bitsum.pro$request_uri;\n}\n\nupstream backend_hosts {\n    server  47.75.216.4;\n}\n\nserver {\n  listen 443 ssl default_server;\n  server_name bitsum.pro *.bitsum.pro;\n  ssl_certificate     /home/www/mycertificate/letsencrypt/live/dev.bitsum.pro/fullchain.pem;\n  ssl_certificate_key /home/www/mycertificate/letsencrypt/live/dev.bitsum.pro/privkey.pem;\n  ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;\n  ssl_ciphers         HIGH:!aNULL:!MD5;\n\n  proxy_buffering on;\n  proxy_buffer_size 2k;\n  proxy_buffers   32 8k;\n  proxy_busy_buffers_size 16k;\n  proxy_max_temp_file_size 2048m;\n  proxy_temp_file_write_size 32k;\n\n  location ~ ^/(admin|download|miner-client|mobile|static|website)/ {\n    proxy_cache backcache;\n    proxy_cache_bypass  $http_cache_control;\n    add_header X-Proxy-Cache $upstream_cache_status;\n\n    proxy_pass  http://backend_hosts;\n  }\n\n  location / {\n    proxy_pass  http://backend_hosts;\n\n    proxy_set_header    HOST $host;\n    proxy_set_header    X-Forwarded-Proto $scheme;\n    proxy_set_header    X-Real-IP $remote_addr;\n    proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;\n  }\n\n  #设置启用gzip的http版本信息\n  gzip_http_version   1.0;\n\n  #设置gzip压缩等级\n  gzip_comp_level   5;\n\n  #设置当Content-Length大于256的时候启用gzip配置\n  gzip_min_length   256;\n\n  #对所有的代理请求都启用gzip\n  gzip_proxied  any;\n\n  #添加“Vary: Accept-Encoding”到请求头部告知代理服务器是否支持gzip压缩\n  gzip_vary   on;\n\n  #设置需要压缩的MIME types\n  gzip_types\n    application/atom+xml\n    application/javascript\n    application/json\n    application/rss+xml\n    application/vnd.ms-fontobject\n    application/x-font-ttf\n    application/x-web-app-manifest+json\n    application/xhtml+xml\n    application/xml\n    font/opentype\n    image/svg+xml\n    image/x-icon\n    text/css\n    text/plain\n    text/x-component;\n}\n```\n\n\n### 参考文献\n\n[Docker NGINX and letsencrypt](https://medium.com/@pierangelo1982/docker-nginx-and-letsencrypt-432397db4a0c)  \n[letsencrypt](https://letsencrypt.org/getting-started/)  \n[certbot](https://certbot.eff.org)  \n[understanding-nginx-http-proxying](https://www.digitalocean.com/community/tutorials/understanding-nginx-http-proxying-load-balancing-buffering-and-caching#configuring-proxy-caching-to-decrease-response-times)  \n[ngx_http_proxy_module](https://nginx.org/en/docs/http/ngx_http_proxy_module.html)  \n[ngx_core_module](https://nginx.org/en/docs/http/ngx_core_module.html)  \n[ngx_http_ssl_module](https://nginx.org/en/docs/http/ngx_http_ssl_module.html)  \n[nginx-caching-guide](https://www.nginx.com/blog/nginx-caching-guide/)  \n","source":"_posts/nginx服务器完整配置.md","raw":"---\ntitle: nginx服务器完整配置\ndate: 2018-11-11 17:01:39\ntags: nginx\ncategories: server\n---\n\n### 基本参数配置\n\n+ `main context`配置:\n\n#### worker进程启动用户、用户组\n\n```shell\nuser nginx nginx;\n```\n\n#### worker进程数量\n\n```shell\nworker_processes  2;\n```\n\n#### master进程id存放的文件位置\n\n```shell\npid /home/www/nginx/nginx.pid;\n```\n\n#### 错误日志\n\n```shell\nerror_log /home/www/nginx/log/error.log warn;\n```\n>前面是文件存放的位置，后面是日志的错误等级。如果要设置为`debug`需要在编译`nginx`的时候加上`--with-debug`选项。\n\n\n#### 设置单个worker进程的最大连接数\n\n```shell\nevents {\n  worker_connections  512;\n}\n```\n>这里的最大连接数\b包括了，和代理服务器的连接、和客户端的连接等。另外需要注意的是，实际同时建立的最大连接数不能超过最大允许打开的文件数量。可以通过`worker_rlimit_nofile`选项来配置。\n\n#### 设置单个worker进程最大允许打开文件数量\n\n```shell\nworker_rlimit_nofile  8192;\n```\n\n`main context`配置预览:\n\n```shell\nuser nginx nginx;\nworker_processes  2;\npid   /home/www/nginx/nginx.pid;\nerror_log /home/www/nginx/log/error.log warn;\nworker_rlimit_nofile  2048;\nevents {\n  worker_connections  1024;\n}\n```\n\n`main context`的配置可以参考[ngx_core_module](https://nginx.org/en/docs/ngx_core_module.html)。\n\n\n+ `http block`配置:\n\n#### 设置http请求日志\n\n```shell\nlog_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                  '$status $body_bytes_sent \"$http_referer\" '\n                  '\"$http_user_agent\" \"$http_x_forwarded_for\"';\naccess_log  /home/www/nginx/log/access.log  main;\n```\n\n#### 定义MIME type 到文件拓展\b名的映射\n\n```shell\ninclude       /etc/nginx/mime.types;\n#默认的MIME type\ndefault_type  application/octet-stream;\n```\n\n#### 优化文件传送\n\n```shell\n#磁盘文件从内核态直接发送到网卡设备，避免了拷贝到用户态的开销。\nsendfile       on;\n\n#开启TCP_CORK选项，当数据包达到固定大小才开始传送。\ntcp_nopush     on;\n```\n\n#### 设置客户端连接超时时间\n\n```shell\nkeepalive_timeout  65s;\n```\n>当时间超过65秒，客户端到服务器的连接将会断开。可以把时间设置的稍微短一些，加快无用连接的回收。\n\n#### 开启基本文件目录功能\n\n```shell\nautoindex on;\n```\n>`autoindex`依赖于[ngx_http_autoindex_module](https://nginx.org/en/docs/http/ngx_http_autoindex_module.html)。\n\n`http block`配置预览：\n\n```shell\nhttp {\n  include       /etc/nginx/mime.types;\n  default_type  application/octet-stream;\n\n  log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                       '$status $body_bytes_sent \"$http_referer\" '\n                       '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n  access_log  /home/www/nginx/log/access.log  main;\n\n  sendfile        on;\n  tcp_nopush      on;\n\n  keepalive_timeout  65s;\n}\n```\n\n---\n\n### 反向代理配置\n\n反向代理相关的配置一般都放置在`nginx/conf.d`目录下，以`hostname`命名。\n\n#### 虚拟主机与请求的分发\n\n```shell\nlisten 443 ssl default_server;\nserver_name bitsum.pro *.bitsum.pro;\n```\n>\b一个`server block`对应一个虚拟主机的配置，`default_server`当请求找不到虚拟主机的时候，该虚拟主机作为默认的虚拟主机接受请求。\n\n\n#### 定义反向代理的`host`、负载均衡\n\n```shell\nupstream backend_hosts {\n  server  47.75.216.4;\n}\n```\n>`upstream`block里面可以配置负载均衡算法、权重等信息。\n\n**几种负载均衡算法：**\n\n+ round robin\n>默认的均衡算法，客户端请求被\b轮流分配到上游服务器。\n+ least_conn\n>新的客户端连接被分配到最少活跃连接数的上游服务器。\n+ ip_hash\n>用客户端ip做为hash的key，前三位8字节决定哪一个服务器处理这个客户端请求。这种算法可以保证`session`一致性。\n+ hash\n>基于客户端传递的数据做hash。\n\n**设置服务器权重:**\n```shell\nupstream backend_hosts {\n  server host1.example.com weight=3;\n  server host2.example.com;\n}\n```\n>默认每一个`host`的权重都是1，`host1`接受的请求量将会是`host2`的三倍。\n\n\n#### 指定上游被代理的服务器、设置额外的请求头\n\n```shell\nlocation / {\n  #所有请求都被转发到`backend_hosts`\n  proxy_pass  http://backend_hosts;\n  #设置客户端请求host\n  proxy_set_header    HOST $host;\n  #设置客户端请求协议(http、https)\n  proxy_set_header    X-Forwarded-Proto $scheme;\n  #把客户端的真实ip通过`X-Real-IP`透传到上游服务器\n  proxy_set_header    X-Real-IP $remote_addr;\n  #代理服务器地址列表、上层代理服务器地址添加到后面\n  proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;\n}\n```\n\n\n### 使用Buffer缓存数据\n\n*为什么`buffer`能优化代理\b请求呢？*\n\n当没有开启`buffer`的时候，被代理的上游服务器的数据立刻被代理服务器转送到客户端。如果客户端处理的足够快，可以关闭\b`buffer`的功能，以便客户端尽可能快的获得数据。当`buffer`功能开启的时候，代理服务器会暂存上游服务器返回的数据，然后再反馈给客户端。如果客户端接受数据的速度过慢，`nginx`会关闭到代理服务器的连接。然后以适合的速度发送数据给客户端。\n\n\n`Buffer`相关配置命令:\n\n+ proxy_buffering\n>控制是否开启`buffering`功能。\n\n+ proxy_buffers\n>控制缓存代理响应的块的个数以及大小。\n\n+ proxy_buffer_size\n>控制缓存代理响应头部的大小, 默认等于proxy_buffers配置的`size`大小，\b由于响应头比较小，可以适当设置小一点。(当proxy_buffering关闭的时候，依然可以使用。)\n\n+ proxy_busy_buffers_size\n>控制发送数据给客户端的缓存的大小。\n\n+ proxy_max_temp_file_size\n>当上游服务器的响应过大的时候，会被缓存在一个临时的磁盘文件里面。该指令配置缓存文件的大小。\n\n+ proxy_temp_file_write_size\n>当上游服务器的响应过大的时候，会被缓存在一个临时的磁盘文件里面。该指令配置一次写入缓存文件的数据大小。\n\n+ proxy_temp_path\n>缓存临时文件存放目录。\n\n\n### 设置`Cache`缓存静态数据\n\n`Cache`相关配置命令:\n\n+ proxy_cache_path  \n基本格式：\n  `proxy_cache_path    /home/www/nginx/cache   levels=1:2  keys_zone=backcache:8m max_size=50m use_temp_path=off;`\n>`/home/www/nginx/cache`作为缓存路径，如果不存在需要新建，并且设置好目录的权限：\n\n```shell\nmkdir -p /home/www/nginx/cache\n#根据启动worker进程的用户, 这里设置为对应的用户\nsudo chown nginx.nginx /home/www/nginx/cache\nsudo chmod 700 /home/www/nginx/cache\n```\n\n`levels`设置缓存的目录结构层次，缓存`key`的最后一个字节作为一级子目录的名称，倒数二三两个字节作为二级缓存子目录的名称。\n\n`keys_zone`定义缓存区域的名称，这里称之为`backcache`。最多有8m的缓存`key`，缓存数据的最大大小为`50m`。\n\n\n+ proxy_cache_key(定义缓存`key`的格式)\n  基本格式：  \n  `proxy_cache_key     \"$scheme$request_method$host$request_uri$is_args$args\";`\n\n\n+ proxy_cache_valid\n  基本格式：  \n  `proxy_cache_valid   404 1m;`\n>根据状态码来控制缓存的有效时间，上例中，缓存404响应的有效时间为1分钟。\n\n**启用Cache**\n上面定义了`cache`的基本配置，现在要告诉`nginx`那里应该开启`cache`。\n\n```shell\nlocation ~ ^/(admin|download|miner-client|mobile|static|website)/ {\n  #使用backcache这个cache zone\n  proxy_cache backcache;\n\n  #允许客户端通过http请求头\b控制跳过缓存请求最新的数据\n  proxy_cache_bypass  $http_cache_control;\n\n  #添加一个头部信息，对于一个请求可以清晰的看到，是被缓存了、缓存失效等状态信息。\n  add_header X-Proxy-Cache $upstream_cache_status;\n\n  proxy_pass  http://backend_hosts;\n}\n```\n\n**开启gzip压缩**\n\n```shell\nserver {\n  #开启gzip压缩功能\n  gzip on;\n\n  #设置启用gzip的http版本信息\n  gzip_http_version   1.0;\n\n  #设置gzip压缩等级\n  gzip_comp_level   5;\n\n  #设置当Content-Length大于256的时候启用gzip配置\n  gzip_min_length   256;\n\n  #对所有的代理请求都启用gzip\n  gzip_proxied  any;\n\n  #添加“Vary: Accept-Encoding”到请求头部告知代理服务器是否支持gzip压缩\n  gzip_vary   on;\n\n  #设置需要压缩的MIME types\n  gzip_types\n    application/atom+xml\n    application/javascript\n    application/json\n    application/rss+xml\n    application/vnd.ms-fontobject\n    application/x-font-ttf\n    application/x-web-app-manifest+json\n    application/xhtml+xml\n    application/xml\n    font/opentype\n    image/svg+xml\n    image/x-icon\n    text/css\n    text/plain\n    text/x-component;\n}\n```\n\n### 给你的网站加上https证书\n\n要给网站开启`https`，那么\b你需要从证书颁发机构(CA)获得一个证书文件，[letsencrypt](https://letsencrypt.org/)是一个免费开放的证书颁发机构。接下来，你需要证明这个域名你实际拥有控制权，这需要通过[ACME protocol](https://ietf-wg-acme.github.io/acme/)协议来保障。\n\n[certbot](https://certbot.eff.org/)是一个`ACME`的客户端，在你的主机运行它自动生成证书文件，与此同时主机不需要停机。\n\nletsencrypt原理图：\n\n![letEncrypt](/img/letEncrypt原理图.png)\n\n>LetEncrypt会发送请求到`ACME`运行的服务器，校验所有权是否合法。\n\n接下来看看如何配置：\n\n因为系统主机安装了`docker`，`certbot`刚好也有对应的镜像文件：\n\n```shell\nsudo docker run -it --name certbot  -p 80:80 \\\n  -v /home/www/nginx/html:/usr/share/nginx/html \\\n  -v /home/www/mycertificate/letsencrypt:/etc/letsencrypt \\\n  -v /home/www/mycertificate/letsencrypt-lib/:/var/lib/letsencrypt \\\n  certbot/certbot certonly\n```\n\n允许上面命令的时候，会出现一系列交互提示出现：\n\n\nHow would you like to authenticate with the ACME CA?\n- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -\n1: Spin up a temporary webserver (standalone)\n2: Place files in webroot directory (webroot)\n- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -\nSelect the appropriate number [1-2] then [enter] (press 'c' to cancel):\n\n因为代理服务器还没有启动起来，这里选择`standalone`模式，就把`ACME`当作一个临时的web服务器。\n\n\nPlugins selected: Authenticator standalone, Installer None\nEnter email address (used for urgent renewal and security notices) (Enter 'c' to\ncancel):\n\n要求填写一个邮箱地址，接受证书过期的提示，以及一些安全提醒等。\n\nPlease read the Terms of Service at\nhttps://letsencrypt.org/documents/LE-SA-v1.2-November-15-2017.pdf. You must\nagree in order to register with the ACME server at\nhttps://acme-v02.api.letsencrypt.org/directory\n- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -\n(A)gree/(C)ancel: A\n\n同意`letsencrypt`这个组织的服务条款。\n\n- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -\nWould you be willing to share your email address with the Electronic Frontier\nFoundation, a founding partner of the Let's Encrypt project and the non-profit\norganization that develops Certbot? We'd like to send you email about our work\nencrypting the web, EFF news, campaigns, and ways to support digital freedom.\n- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -\n(Y)es/(N)o: Y\nPlease enter in your domain name(s) (comma and/or space separated)  (Enter 'c'\nto cancel):\n\n提示输入\b要开启`https`的域名，多个域名用逗号或者空格分开。\n\n>证书生成完毕之后会在`/home/www/mycertificate/letsencrypt`目录下有相应的文件，值得注意的是，多个域名共用一个证书文件。所以如果你在上一步配置了多个域名，这里也只能看到一个证书文件。\n\n*nginx 配置`https`证书*\n\n```shell\nserver {\n  listen 443 ssl default_server;\n  server_name bitsum.pro *.bitsum.pro;\n  #PEM格式的证书文件\n  ssl_certificate     /home/www/mycertificate/letsencrypt/live/dev.bitsum.pro/fullchain.pem;\n  #证书文件的密钥\n  ssl_certificate_key /home/www/mycertificate/letsencrypt/live/dev.bitsum.pro/privkey.pem;\n  #指定https的协议版本\n  ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;\n  # 启用指定的OpenSSL ciphers\n  ssl_ciphers         HIGH:!aNULL:!MD5;\n}\n```\n\n启动`nginx`服务：\n\n```shell\nsudo nginx -c /home/www/nginx/nginx.conf\n```\n\n**完整配置文件**\n\n*nginx.conf:*\n\n```shell\nuser  nginx nginx;\nworker_processes  2;\n\npid        /home/www/nginx/nginx.pid;\nerror_log  /home/www/nginx/log/error.log warn;\n\nworker_rlimit_nofile    2048;\nevents {\n  worker_connections  1024;\n }\n \n http {\n    include       /etc/nginx/mime.types;\n    default_type  application/octet-stream;\n\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n    access_log  /home/www/nginx/log/access.log  main;\n\n    sendfile        on;\n    tcp_nopush     on;\n\n    keepalive_timeout  65s;\n\n    autoindex  on;\n \n    proxy_cache_path    /home/www/nginx/cache   levels=1:2  keys_zone=backcache:8m max_size=50m use_temp_path=off;\n    proxy_cache_key     \"$scheme$request_method$host$request_uri$is_args$args\";\n    proxy_cache_valid   302 10m;\n    proxy_cache_valid   404 1m;\n \n    include /home/www/nginx/conf.d/*.conf;\n }\n```\n*config.d/bitsum.pro.conf:*\n\n```shell\nserver {\n    listen 80;\n    server_name bitsum.pro;\n    return 301 https://bitsum.pro$request_uri;\n}\n\nupstream backend_hosts {\n    server  47.75.216.4;\n}\n\nserver {\n  listen 443 ssl default_server;\n  server_name bitsum.pro *.bitsum.pro;\n  ssl_certificate     /home/www/mycertificate/letsencrypt/live/dev.bitsum.pro/fullchain.pem;\n  ssl_certificate_key /home/www/mycertificate/letsencrypt/live/dev.bitsum.pro/privkey.pem;\n  ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;\n  ssl_ciphers         HIGH:!aNULL:!MD5;\n\n  proxy_buffering on;\n  proxy_buffer_size 2k;\n  proxy_buffers   32 8k;\n  proxy_busy_buffers_size 16k;\n  proxy_max_temp_file_size 2048m;\n  proxy_temp_file_write_size 32k;\n\n  location ~ ^/(admin|download|miner-client|mobile|static|website)/ {\n    proxy_cache backcache;\n    proxy_cache_bypass  $http_cache_control;\n    add_header X-Proxy-Cache $upstream_cache_status;\n\n    proxy_pass  http://backend_hosts;\n  }\n\n  location / {\n    proxy_pass  http://backend_hosts;\n\n    proxy_set_header    HOST $host;\n    proxy_set_header    X-Forwarded-Proto $scheme;\n    proxy_set_header    X-Real-IP $remote_addr;\n    proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;\n  }\n\n  #设置启用gzip的http版本信息\n  gzip_http_version   1.0;\n\n  #设置gzip压缩等级\n  gzip_comp_level   5;\n\n  #设置当Content-Length大于256的时候启用gzip配置\n  gzip_min_length   256;\n\n  #对所有的代理请求都启用gzip\n  gzip_proxied  any;\n\n  #添加“Vary: Accept-Encoding”到请求头部告知代理服务器是否支持gzip压缩\n  gzip_vary   on;\n\n  #设置需要压缩的MIME types\n  gzip_types\n    application/atom+xml\n    application/javascript\n    application/json\n    application/rss+xml\n    application/vnd.ms-fontobject\n    application/x-font-ttf\n    application/x-web-app-manifest+json\n    application/xhtml+xml\n    application/xml\n    font/opentype\n    image/svg+xml\n    image/x-icon\n    text/css\n    text/plain\n    text/x-component;\n}\n```\n\n\n### 参考文献\n\n[Docker NGINX and letsencrypt](https://medium.com/@pierangelo1982/docker-nginx-and-letsencrypt-432397db4a0c)  \n[letsencrypt](https://letsencrypt.org/getting-started/)  \n[certbot](https://certbot.eff.org)  \n[understanding-nginx-http-proxying](https://www.digitalocean.com/community/tutorials/understanding-nginx-http-proxying-load-balancing-buffering-and-caching#configuring-proxy-caching-to-decrease-response-times)  \n[ngx_http_proxy_module](https://nginx.org/en/docs/http/ngx_http_proxy_module.html)  \n[ngx_core_module](https://nginx.org/en/docs/http/ngx_core_module.html)  \n[ngx_http_ssl_module](https://nginx.org/en/docs/http/ngx_http_ssl_module.html)  \n[nginx-caching-guide](https://www.nginx.com/blog/nginx-caching-guide/)  \n","slug":"nginx服务器完整配置","published":1,"updated":"2018-11-19T10:52:24.745Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cfd0077y4zvc5hiq3kn","content":"<h3 id=\"基本参数配置\"><a href=\"#基本参数配置\" class=\"headerlink\" title=\"基本参数配置\"></a>基本参数配置</h3><ul>\n<li><code>main context</code>配置:</li>\n</ul>\n<h4 id=\"worker进程启动用户、用户组\"><a href=\"#worker进程启动用户、用户组\" class=\"headerlink\" title=\"worker进程启动用户、用户组\"></a>worker进程启动用户、用户组</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">user nginx nginx;</span><br></pre></td></tr></table></figure>\n<h4 id=\"worker进程数量\"><a href=\"#worker进程数量\" class=\"headerlink\" title=\"worker进程数量\"></a>worker进程数量</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">worker_processes  2;</span><br></pre></td></tr></table></figure>\n<h4 id=\"master进程id存放的文件位置\"><a href=\"#master进程id存放的文件位置\" class=\"headerlink\" title=\"master进程id存放的文件位置\"></a>master进程id存放的文件位置</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pid /home/www/nginx/nginx.pid;</span><br></pre></td></tr></table></figure>\n<h4 id=\"错误日志\"><a href=\"#错误日志\" class=\"headerlink\" title=\"错误日志\"></a>错误日志</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">error_log /home/www/nginx/log/error.log warn;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>前面是文件存放的位置，后面是日志的错误等级。如果要设置为<code>debug</code>需要在编译<code>nginx</code>的时候加上<code>--with-debug</code>选项。</p>\n</blockquote>\n<h4 id=\"设置单个worker进程的最大连接数\"><a href=\"#设置单个worker进程的最大连接数\" class=\"headerlink\" title=\"设置单个worker进程的最大连接数\"></a>设置单个worker进程的最大连接数</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">events &#123;</span><br><span class=\"line\">  worker_connections  512;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>这里的最大连接数\b包括了，和代理服务器的连接、和客户端的连接等。另外需要注意的是，实际同时建立的最大连接数不能超过最大允许打开的文件数量。可以通过<code>worker_rlimit_nofile</code>选项来配置。</p>\n</blockquote>\n<h4 id=\"设置单个worker进程最大允许打开文件数量\"><a href=\"#设置单个worker进程最大允许打开文件数量\" class=\"headerlink\" title=\"设置单个worker进程最大允许打开文件数量\"></a>设置单个worker进程最大允许打开文件数量</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">worker_rlimit_nofile  8192;</span><br></pre></td></tr></table></figure>\n<p><code>main context</code>配置预览:</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">user nginx nginx;</span><br><span class=\"line\">worker_processes  2;</span><br><span class=\"line\">pid   /home/www/nginx/nginx.pid;</span><br><span class=\"line\">error_log /home/www/nginx/log/error.log warn;</span><br><span class=\"line\">worker_rlimit_nofile  2048;</span><br><span class=\"line\">events &#123;</span><br><span class=\"line\">  worker_connections  1024;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>main context</code>的配置可以参考<a href=\"https://nginx.org/en/docs/ngx_core_module.html\" target=\"_blank\" rel=\"noopener\">ngx_core_module</a>。</p>\n<ul>\n<li><code>http block</code>配置:</li>\n</ul>\n<h4 id=\"设置http请求日志\"><a href=\"#设置http请求日志\" class=\"headerlink\" title=\"设置http请求日志\"></a>设置http请求日志</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '</span><br><span class=\"line\">                  '$status $body_bytes_sent \"$http_referer\" '</span><br><span class=\"line\">                  '\"$http_user_agent\" \"$http_x_forwarded_for\"';</span><br><span class=\"line\">access_log  /home/www/nginx/log/access.log  main;</span><br></pre></td></tr></table></figure>\n<h4 id=\"定义MIME-type-到文件拓展名的映射\"><a href=\"#定义MIME-type-到文件拓展名的映射\" class=\"headerlink\" title=\"定义MIME type 到文件拓展\b名的映射\"></a>定义MIME type 到文件拓展\b名的映射</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">include       /etc/nginx/mime.types;</span><br><span class=\"line\"><span class=\"meta\">#</span>默认的MIME type</span><br><span class=\"line\">default_type  application/octet-stream;</span><br></pre></td></tr></table></figure>\n<h4 id=\"优化文件传送\"><a href=\"#优化文件传送\" class=\"headerlink\" title=\"优化文件传送\"></a>优化文件传送</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span>磁盘文件从内核态直接发送到网卡设备，避免了拷贝到用户态的开销。</span><br><span class=\"line\">sendfile       on;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span>开启TCP_CORK选项，当数据包达到固定大小才开始传送。</span><br><span class=\"line\">tcp_nopush     on;</span><br></pre></td></tr></table></figure>\n<h4 id=\"设置客户端连接超时时间\"><a href=\"#设置客户端连接超时时间\" class=\"headerlink\" title=\"设置客户端连接超时时间\"></a>设置客户端连接超时时间</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">keepalive_timeout  65s;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>当时间超过65秒，客户端到服务器的连接将会断开。可以把时间设置的稍微短一些，加快无用连接的回收。</p>\n</blockquote>\n<h4 id=\"开启基本文件目录功能\"><a href=\"#开启基本文件目录功能\" class=\"headerlink\" title=\"开启基本文件目录功能\"></a>开启基本文件目录功能</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">autoindex on;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>autoindex</code>依赖于<a href=\"https://nginx.org/en/docs/http/ngx_http_autoindex_module.html\" target=\"_blank\" rel=\"noopener\">ngx_http_autoindex_module</a>。</p>\n</blockquote>\n<p><code>http block</code>配置预览：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http &#123;</span><br><span class=\"line\">  include       /etc/nginx/mime.types;</span><br><span class=\"line\">  default_type  application/octet-stream;</span><br><span class=\"line\"></span><br><span class=\"line\">  log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '</span><br><span class=\"line\">                       '$status $body_bytes_sent \"$http_referer\" '</span><br><span class=\"line\">                       '\"$http_user_agent\" \"$http_x_forwarded_for\"';</span><br><span class=\"line\"></span><br><span class=\"line\">  access_log  /home/www/nginx/log/access.log  main;</span><br><span class=\"line\"></span><br><span class=\"line\">  sendfile        on;</span><br><span class=\"line\">  tcp_nopush      on;</span><br><span class=\"line\"></span><br><span class=\"line\">  keepalive_timeout  65s;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<hr>\n<h3 id=\"反向代理配置\"><a href=\"#反向代理配置\" class=\"headerlink\" title=\"反向代理配置\"></a>反向代理配置</h3><p>反向代理相关的配置一般都放置在<code>nginx/conf.d</code>目录下，以<code>hostname</code>命名。</p>\n<h4 id=\"虚拟主机与请求的分发\"><a href=\"#虚拟主机与请求的分发\" class=\"headerlink\" title=\"虚拟主机与请求的分发\"></a>虚拟主机与请求的分发</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">listen 443 ssl default_server;</span><br><span class=\"line\">server_name bitsum.pro *.bitsum.pro;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>\b一个<code>server block</code>对应一个虚拟主机的配置，<code>default_server</code>当请求找不到虚拟主机的时候，该虚拟主机作为默认的虚拟主机接受请求。</p>\n</blockquote>\n<h4 id=\"定义反向代理的host、负载均衡\"><a href=\"#定义反向代理的host、负载均衡\" class=\"headerlink\" title=\"定义反向代理的host、负载均衡\"></a>定义反向代理的<code>host</code>、负载均衡</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">upstream backend_hosts &#123;</span><br><span class=\"line\">  server  47.75.216.4;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>upstream</code>block里面可以配置负载均衡算法、权重等信息。</p>\n</blockquote>\n<p><strong>几种负载均衡算法：</strong></p>\n<ul>\n<li>round robin<blockquote>\n<p>默认的均衡算法，客户端请求被\b轮流分配到上游服务器。</p>\n</blockquote>\n</li>\n<li>least_conn<blockquote>\n<p>新的客户端连接被分配到最少活跃连接数的上游服务器。</p>\n</blockquote>\n</li>\n<li>ip_hash<blockquote>\n<p>用客户端ip做为hash的key，前三位8字节决定哪一个服务器处理这个客户端请求。这种算法可以保证<code>session</code>一致性。</p>\n</blockquote>\n</li>\n<li>hash<blockquote>\n<p>基于客户端传递的数据做hash。</p>\n</blockquote>\n</li>\n</ul>\n<p><strong>设置服务器权重:</strong><br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">upstream backend_hosts &#123;</span><br><span class=\"line\">  server host1.example.com weight=3;</span><br><span class=\"line\">  server host2.example.com;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>默认每一个<code>host</code>的权重都是1，<code>host1</code>接受的请求量将会是<code>host2</code>的三倍。</p>\n</blockquote>\n<h4 id=\"指定上游被代理的服务器、设置额外的请求头\"><a href=\"#指定上游被代理的服务器、设置额外的请求头\" class=\"headerlink\" title=\"指定上游被代理的服务器、设置额外的请求头\"></a>指定上游被代理的服务器、设置额外的请求头</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">location / &#123;</span><br><span class=\"line\"><span class=\"meta\">  #</span>所有请求都被转发到`backend_hosts`</span><br><span class=\"line\">  proxy_pass  http://backend_hosts;</span><br><span class=\"line\"><span class=\"meta\">  #</span>设置客户端请求host</span><br><span class=\"line\">  proxy_set_header    HOST $host;</span><br><span class=\"line\"><span class=\"meta\">  #</span>设置客户端请求协议(http、https)</span><br><span class=\"line\">  proxy_set_header    X-Forwarded-Proto $scheme;</span><br><span class=\"line\"><span class=\"meta\">  #</span>把客户端的真实ip通过`X-Real-IP`透传到上游服务器</span><br><span class=\"line\">  proxy_set_header    X-Real-IP $remote_addr;</span><br><span class=\"line\"><span class=\"meta\">  #</span>代理服务器地址列表、上层代理服务器地址添加到后面</span><br><span class=\"line\">  proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"使用Buffer缓存数据\"><a href=\"#使用Buffer缓存数据\" class=\"headerlink\" title=\"使用Buffer缓存数据\"></a>使用Buffer缓存数据</h3><p><em>为什么<code>buffer</code>能优化代理\b请求呢？</em></p>\n<p>当没有开启<code>buffer</code>的时候，被代理的上游服务器的数据立刻被代理服务器转送到客户端。如果客户端处理的足够快，可以关闭\b<code>buffer</code>的功能，以便客户端尽可能快的获得数据。当<code>buffer</code>功能开启的时候，代理服务器会暂存上游服务器返回的数据，然后再反馈给客户端。如果客户端接受数据的速度过慢，<code>nginx</code>会关闭到代理服务器的连接。然后以适合的速度发送数据给客户端。</p>\n<p><code>Buffer</code>相关配置命令:</p>\n<ul>\n<li><p>proxy_buffering</p>\n<blockquote>\n<p>控制是否开启<code>buffering</code>功能。</p>\n</blockquote>\n</li>\n<li><p>proxy_buffers</p>\n<blockquote>\n<p>控制缓存代理响应的块的个数以及大小。</p>\n</blockquote>\n</li>\n<li><p>proxy_buffer_size</p>\n<blockquote>\n<p>控制缓存代理响应头部的大小, 默认等于proxy_buffers配置的<code>size</code>大小，\b由于响应头比较小，可以适当设置小一点。(当proxy_buffering关闭的时候，依然可以使用。)</p>\n</blockquote>\n</li>\n<li><p>proxy_busy_buffers_size</p>\n<blockquote>\n<p>控制发送数据给客户端的缓存的大小。</p>\n</blockquote>\n</li>\n<li><p>proxy_max_temp_file_size</p>\n<blockquote>\n<p>当上游服务器的响应过大的时候，会被缓存在一个临时的磁盘文件里面。该指令配置缓存文件的大小。</p>\n</blockquote>\n</li>\n<li><p>proxy_temp_file_write_size</p>\n<blockquote>\n<p>当上游服务器的响应过大的时候，会被缓存在一个临时的磁盘文件里面。该指令配置一次写入缓存文件的数据大小。</p>\n</blockquote>\n</li>\n<li><p>proxy_temp_path</p>\n<blockquote>\n<p>缓存临时文件存放目录。</p>\n</blockquote>\n</li>\n</ul>\n<h3 id=\"设置Cache缓存静态数据\"><a href=\"#设置Cache缓存静态数据\" class=\"headerlink\" title=\"设置Cache缓存静态数据\"></a>设置<code>Cache</code>缓存静态数据</h3><p><code>Cache</code>相关配置命令:</p>\n<ul>\n<li>proxy_cache_path<br>基本格式：<br><code>proxy_cache_path    /home/www/nginx/cache   levels=1:2  keys_zone=backcache:8m max_size=50m use_temp_path=off;</code><blockquote>\n<p><code>/home/www/nginx/cache</code>作为缓存路径，如果不存在需要新建，并且设置好目录的权限：</p>\n</blockquote>\n</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir -p /home/www/nginx/cache</span><br><span class=\"line\"><span class=\"meta\">#</span>根据启动worker进程的用户, 这里设置为对应的用户</span><br><span class=\"line\">sudo chown nginx.nginx /home/www/nginx/cache</span><br><span class=\"line\">sudo chmod 700 /home/www/nginx/cache</span><br></pre></td></tr></table></figure>\n<p><code>levels</code>设置缓存的目录结构层次，缓存<code>key</code>的最后一个字节作为一级子目录的名称，倒数二三两个字节作为二级缓存子目录的名称。</p>\n<p><code>keys_zone</code>定义缓存区域的名称，这里称之为<code>backcache</code>。最多有8m的缓存<code>key</code>，缓存数据的最大大小为<code>50m</code>。</p>\n<ul>\n<li>proxy_cache_key(定义缓存<code>key</code>的格式)<br>基本格式：<br><code>proxy_cache_key     &quot;$scheme$request_method$host$request_uri$is_args$args&quot;;</code></li>\n</ul>\n<ul>\n<li>proxy_cache_valid<br>基本格式：<br><code>proxy_cache_valid   404 1m;</code><blockquote>\n<p>根据状态码来控制缓存的有效时间，上例中，缓存404响应的有效时间为1分钟。</p>\n</blockquote>\n</li>\n</ul>\n<p><strong>启用Cache</strong><br>上面定义了<code>cache</code>的基本配置，现在要告诉<code>nginx</code>那里应该开启<code>cache</code>。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">location ~ ^/(admin|download|miner-client|mobile|static|website)/ &#123;</span><br><span class=\"line\"><span class=\"meta\">  #</span>使用backcache这个cache zone</span><br><span class=\"line\">  proxy_cache backcache;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">  #</span>允许客户端通过http请求头\b控制跳过缓存请求最新的数据</span><br><span class=\"line\">  proxy_cache_bypass  $http_cache_control;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">  #</span>添加一个头部信息，对于一个请求可以清晰的看到，是被缓存了、缓存失效等状态信息。</span><br><span class=\"line\">  add_header X-Proxy-Cache $upstream_cache_status;</span><br><span class=\"line\"></span><br><span class=\"line\">  proxy_pass  http://backend_hosts;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>开启gzip压缩</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server &#123;</span><br><span class=\"line\"><span class=\"meta\">  #</span>开启gzip压缩功能</span><br><span class=\"line\">  gzip on;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">  #</span>设置启用gzip的http版本信息</span><br><span class=\"line\">  gzip_http_version   1.0;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">  #</span>设置gzip压缩等级</span><br><span class=\"line\">  gzip_comp_level   5;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">  #</span>设置当Content-Length大于256的时候启用gzip配置</span><br><span class=\"line\">  gzip_min_length   256;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">  #</span>对所有的代理请求都启用gzip</span><br><span class=\"line\">  gzip_proxied  any;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">  #</span>添加“Vary: Accept-Encoding”到请求头部告知代理服务器是否支持gzip压缩</span><br><span class=\"line\">  gzip_vary   on;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">  #</span>设置需要压缩的MIME types</span><br><span class=\"line\">  gzip_types</span><br><span class=\"line\">    application/atom+xml</span><br><span class=\"line\">    application/javascript</span><br><span class=\"line\">    application/json</span><br><span class=\"line\">    application/rss+xml</span><br><span class=\"line\">    application/vnd.ms-fontobject</span><br><span class=\"line\">    application/x-font-ttf</span><br><span class=\"line\">    application/x-web-app-manifest+json</span><br><span class=\"line\">    application/xhtml+xml</span><br><span class=\"line\">    application/xml</span><br><span class=\"line\">    font/opentype</span><br><span class=\"line\">    image/svg+xml</span><br><span class=\"line\">    image/x-icon</span><br><span class=\"line\">    text/css</span><br><span class=\"line\">    text/plain</span><br><span class=\"line\">    text/x-component;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"给你的网站加上https证书\"><a href=\"#给你的网站加上https证书\" class=\"headerlink\" title=\"给你的网站加上https证书\"></a>给你的网站加上https证书</h3><p>要给网站开启<code>https</code>，那么\b你需要从证书颁发机构(CA)获得一个证书文件，<a href=\"https://letsencrypt.org/\" target=\"_blank\" rel=\"noopener\">letsencrypt</a>是一个免费开放的证书颁发机构。接下来，你需要证明这个域名你实际拥有控制权，这需要通过<a href=\"https://ietf-wg-acme.github.io/acme/\" target=\"_blank\" rel=\"noopener\">ACME protocol</a>协议来保障。</p>\n<p><a href=\"https://certbot.eff.org/\" target=\"_blank\" rel=\"noopener\">certbot</a>是一个<code>ACME</code>的客户端，在你的主机运行它自动生成证书文件，与此同时主机不需要停机。</p>\n<p>letsencrypt原理图：</p>\n<p><img src=\"/img/letEncrypt原理图.png\" alt=\"letEncrypt\"></p>\n<blockquote>\n<p>LetEncrypt会发送请求到<code>ACME</code>运行的服务器，校验所有权是否合法。</p>\n</blockquote>\n<p>接下来看看如何配置：</p>\n<p>因为系统主机安装了<code>docker</code>，<code>certbot</code>刚好也有对应的镜像文件：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo docker run -it --name certbot  -p 80:80 \\</span><br><span class=\"line\">  -v /home/www/nginx/html:/usr/share/nginx/html \\</span><br><span class=\"line\">  -v /home/www/mycertificate/letsencrypt:/etc/letsencrypt \\</span><br><span class=\"line\">  -v /home/www/mycertificate/letsencrypt-lib/:/var/lib/letsencrypt \\</span><br><span class=\"line\">  certbot/certbot certonly</span><br></pre></td></tr></table></figure>\n<p>允许上面命令的时候，会出现一系列交互提示出现：</p>\n<p>How would you like to authenticate with the ACME CA?</p>\n<hr>\n<p>1: Spin up a temporary webserver (standalone)<br>2: Place files in webroot directory (webroot)</p>\n<hr>\n<p>Select the appropriate number [1-2] then [enter] (press ‘c’ to cancel):</p>\n<p>因为代理服务器还没有启动起来，这里选择<code>standalone</code>模式，就把<code>ACME</code>当作一个临时的web服务器。</p>\n<p>Plugins selected: Authenticator standalone, Installer None<br>Enter email address (used for urgent renewal and security notices) (Enter ‘c’ to<br>cancel):</p>\n<p>要求填写一个邮箱地址，接受证书过期的提示，以及一些安全提醒等。</p>\n<p>Please read the Terms of Service at<br><a href=\"https://letsencrypt.org/documents/LE-SA-v1.2-November-15-2017.pdf\" target=\"_blank\" rel=\"noopener\">https://letsencrypt.org/documents/LE-SA-v1.2-November-15-2017.pdf</a>. You must<br>agree in order to register with the ACME server at<br><a href=\"https://acme-v02.api.letsencrypt.org/directory\" target=\"_blank\" rel=\"noopener\">https://acme-v02.api.letsencrypt.org/directory</a></p>\n<hr>\n<p>(A)gree/(C)ancel: A</p>\n<p>同意<code>letsencrypt</code>这个组织的服务条款。</p>\n<hr>\n<p>Would you be willing to share your email address with the Electronic Frontier<br>Foundation, a founding partner of the Let’s Encrypt project and the non-profit<br>organization that develops Certbot? We’d like to send you email about our work<br>encrypting the web, EFF news, campaigns, and ways to support digital freedom.</p>\n<hr>\n<p>(Y)es/(N)o: Y<br>Please enter in your domain name(s) (comma and/or space separated)  (Enter ‘c’<br>to cancel):</p>\n<p>提示输入\b要开启<code>https</code>的域名，多个域名用逗号或者空格分开。</p>\n<blockquote>\n<p>证书生成完毕之后会在<code>/home/www/mycertificate/letsencrypt</code>目录下有相应的文件，值得注意的是，多个域名共用一个证书文件。所以如果你在上一步配置了多个域名，这里也只能看到一个证书文件。</p>\n</blockquote>\n<p><em>nginx 配置<code>https</code>证书</em></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server &#123;</span><br><span class=\"line\">  listen 443 ssl default_server;</span><br><span class=\"line\">  server_name bitsum.pro *.bitsum.pro;</span><br><span class=\"line\"><span class=\"meta\">  #</span>PEM格式的证书文件</span><br><span class=\"line\">  ssl_certificate     /home/www/mycertificate/letsencrypt/live/dev.bitsum.pro/fullchain.pem;</span><br><span class=\"line\"><span class=\"meta\">  #</span>证书文件的密钥</span><br><span class=\"line\">  ssl_certificate_key /home/www/mycertificate/letsencrypt/live/dev.bitsum.pro/privkey.pem;</span><br><span class=\"line\"><span class=\"meta\">  #</span>指定https的协议版本</span><br><span class=\"line\">  ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;</span><br><span class=\"line\"><span class=\"meta\">  #</span> 启用指定的OpenSSL ciphers</span><br><span class=\"line\">  ssl_ciphers         HIGH:!aNULL:!MD5;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>启动<code>nginx</code>服务：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo nginx -c /home/www/nginx/nginx.conf</span><br></pre></td></tr></table></figure>\n<p><strong>完整配置文件</strong></p>\n<p><em>nginx.conf:</em></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">user  nginx nginx;</span><br><span class=\"line\">worker_processes  2;</span><br><span class=\"line\"></span><br><span class=\"line\">pid        /home/www/nginx/nginx.pid;</span><br><span class=\"line\">error_log  /home/www/nginx/log/error.log warn;</span><br><span class=\"line\"></span><br><span class=\"line\">worker_rlimit_nofile    2048;</span><br><span class=\"line\">events &#123;</span><br><span class=\"line\">  worker_connections  1024;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"> http &#123;</span><br><span class=\"line\">    include       /etc/nginx/mime.types;</span><br><span class=\"line\">    default_type  application/octet-stream;</span><br><span class=\"line\"></span><br><span class=\"line\">    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '</span><br><span class=\"line\">                      '$status $body_bytes_sent \"$http_referer\" '</span><br><span class=\"line\">                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';</span><br><span class=\"line\"></span><br><span class=\"line\">    access_log  /home/www/nginx/log/access.log  main;</span><br><span class=\"line\"></span><br><span class=\"line\">    sendfile        on;</span><br><span class=\"line\">    tcp_nopush     on;</span><br><span class=\"line\"></span><br><span class=\"line\">    keepalive_timeout  65s;</span><br><span class=\"line\"></span><br><span class=\"line\">    autoindex  on;</span><br><span class=\"line\"> </span><br><span class=\"line\">    proxy_cache_path    /home/www/nginx/cache   levels=1:2  keys_zone=backcache:8m max_size=50m use_temp_path=off;</span><br><span class=\"line\">    proxy_cache_key     \"$scheme$request_method$host$request_uri$is_args$args\";</span><br><span class=\"line\">    proxy_cache_valid   302 10m;</span><br><span class=\"line\">    proxy_cache_valid   404 1m;</span><br><span class=\"line\"> </span><br><span class=\"line\">    include /home/www/nginx/conf.d/*.conf;</span><br><span class=\"line\"> &#125;</span><br></pre></td></tr></table></figure>\n<p><em>config.d/bitsum.pro.conf:</em></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen 80;</span><br><span class=\"line\">    server_name bitsum.pro;</span><br><span class=\"line\">    return 301 https://bitsum.pro$request_uri;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">upstream backend_hosts &#123;</span><br><span class=\"line\">    server  47.75.216.4;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">  listen 443 ssl default_server;</span><br><span class=\"line\">  server_name bitsum.pro *.bitsum.pro;</span><br><span class=\"line\">  ssl_certificate     /home/www/mycertificate/letsencrypt/live/dev.bitsum.pro/fullchain.pem;</span><br><span class=\"line\">  ssl_certificate_key /home/www/mycertificate/letsencrypt/live/dev.bitsum.pro/privkey.pem;</span><br><span class=\"line\">  ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;</span><br><span class=\"line\">  ssl_ciphers         HIGH:!aNULL:!MD5;</span><br><span class=\"line\"></span><br><span class=\"line\">  proxy_buffering on;</span><br><span class=\"line\">  proxy_buffer_size 2k;</span><br><span class=\"line\">  proxy_buffers   32 8k;</span><br><span class=\"line\">  proxy_busy_buffers_size 16k;</span><br><span class=\"line\">  proxy_max_temp_file_size 2048m;</span><br><span class=\"line\">  proxy_temp_file_write_size 32k;</span><br><span class=\"line\"></span><br><span class=\"line\">  location ~ ^/(admin|download|miner-client|mobile|static|website)/ &#123;</span><br><span class=\"line\">    proxy_cache backcache;</span><br><span class=\"line\">    proxy_cache_bypass  $http_cache_control;</span><br><span class=\"line\">    add_header X-Proxy-Cache $upstream_cache_status;</span><br><span class=\"line\"></span><br><span class=\"line\">    proxy_pass  http://backend_hosts;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  location / &#123;</span><br><span class=\"line\">    proxy_pass  http://backend_hosts;</span><br><span class=\"line\"></span><br><span class=\"line\">    proxy_set_header    HOST $host;</span><br><span class=\"line\">    proxy_set_header    X-Forwarded-Proto $scheme;</span><br><span class=\"line\">    proxy_set_header    X-Real-IP $remote_addr;</span><br><span class=\"line\">    proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">  #</span>设置启用gzip的http版本信息</span><br><span class=\"line\">  gzip_http_version   1.0;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">  #</span>设置gzip压缩等级</span><br><span class=\"line\">  gzip_comp_level   5;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">  #</span>设置当Content-Length大于256的时候启用gzip配置</span><br><span class=\"line\">  gzip_min_length   256;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">  #</span>对所有的代理请求都启用gzip</span><br><span class=\"line\">  gzip_proxied  any;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">  #</span>添加“Vary: Accept-Encoding”到请求头部告知代理服务器是否支持gzip压缩</span><br><span class=\"line\">  gzip_vary   on;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">  #</span>设置需要压缩的MIME types</span><br><span class=\"line\">  gzip_types</span><br><span class=\"line\">    application/atom+xml</span><br><span class=\"line\">    application/javascript</span><br><span class=\"line\">    application/json</span><br><span class=\"line\">    application/rss+xml</span><br><span class=\"line\">    application/vnd.ms-fontobject</span><br><span class=\"line\">    application/x-font-ttf</span><br><span class=\"line\">    application/x-web-app-manifest+json</span><br><span class=\"line\">    application/xhtml+xml</span><br><span class=\"line\">    application/xml</span><br><span class=\"line\">    font/opentype</span><br><span class=\"line\">    image/svg+xml</span><br><span class=\"line\">    image/x-icon</span><br><span class=\"line\">    text/css</span><br><span class=\"line\">    text/plain</span><br><span class=\"line\">    text/x-component;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"参考文献\"><a href=\"#参考文献\" class=\"headerlink\" title=\"参考文献\"></a>参考文献</h3><p><a href=\"https://medium.com/@pierangelo1982/docker-nginx-and-letsencrypt-432397db4a0c\" target=\"_blank\" rel=\"noopener\">Docker NGINX and letsencrypt</a><br><a href=\"https://letsencrypt.org/getting-started/\" target=\"_blank\" rel=\"noopener\">letsencrypt</a><br><a href=\"https://certbot.eff.org\" target=\"_blank\" rel=\"noopener\">certbot</a><br><a href=\"https://www.digitalocean.com/community/tutorials/understanding-nginx-http-proxying-load-balancing-buffering-and-caching#configuring-proxy-caching-to-decrease-response-times\" target=\"_blank\" rel=\"noopener\">understanding-nginx-http-proxying</a><br><a href=\"https://nginx.org/en/docs/http/ngx_http_proxy_module.html\" target=\"_blank\" rel=\"noopener\">ngx_http_proxy_module</a><br><a href=\"https://nginx.org/en/docs/http/ngx_core_module.html\" target=\"_blank\" rel=\"noopener\">ngx_core_module</a><br><a href=\"https://nginx.org/en/docs/http/ngx_http_ssl_module.html\" target=\"_blank\" rel=\"noopener\">ngx_http_ssl_module</a><br><a href=\"https://www.nginx.com/blog/nginx-caching-guide/\" target=\"_blank\" rel=\"noopener\">nginx-caching-guide</a>  </p>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"基本参数配置\"><a href=\"#基本参数配置\" class=\"headerlink\" title=\"基本参数配置\"></a>基本参数配置</h3><ul>\n<li><code>main context</code>配置:</li>\n</ul>\n<h4 id=\"worker进程启动用户、用户组\"><a href=\"#worker进程启动用户、用户组\" class=\"headerlink\" title=\"worker进程启动用户、用户组\"></a>worker进程启动用户、用户组</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">user nginx nginx;</span><br></pre></td></tr></table></figure>\n<h4 id=\"worker进程数量\"><a href=\"#worker进程数量\" class=\"headerlink\" title=\"worker进程数量\"></a>worker进程数量</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">worker_processes  2;</span><br></pre></td></tr></table></figure>\n<h4 id=\"master进程id存放的文件位置\"><a href=\"#master进程id存放的文件位置\" class=\"headerlink\" title=\"master进程id存放的文件位置\"></a>master进程id存放的文件位置</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pid /home/www/nginx/nginx.pid;</span><br></pre></td></tr></table></figure>\n<h4 id=\"错误日志\"><a href=\"#错误日志\" class=\"headerlink\" title=\"错误日志\"></a>错误日志</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">error_log /home/www/nginx/log/error.log warn;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>前面是文件存放的位置，后面是日志的错误等级。如果要设置为<code>debug</code>需要在编译<code>nginx</code>的时候加上<code>--with-debug</code>选项。</p>\n</blockquote>\n<h4 id=\"设置单个worker进程的最大连接数\"><a href=\"#设置单个worker进程的最大连接数\" class=\"headerlink\" title=\"设置单个worker进程的最大连接数\"></a>设置单个worker进程的最大连接数</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">events &#123;</span><br><span class=\"line\">  worker_connections  512;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>这里的最大连接数\b包括了，和代理服务器的连接、和客户端的连接等。另外需要注意的是，实际同时建立的最大连接数不能超过最大允许打开的文件数量。可以通过<code>worker_rlimit_nofile</code>选项来配置。</p>\n</blockquote>\n<h4 id=\"设置单个worker进程最大允许打开文件数量\"><a href=\"#设置单个worker进程最大允许打开文件数量\" class=\"headerlink\" title=\"设置单个worker进程最大允许打开文件数量\"></a>设置单个worker进程最大允许打开文件数量</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">worker_rlimit_nofile  8192;</span><br></pre></td></tr></table></figure>\n<p><code>main context</code>配置预览:</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">user nginx nginx;</span><br><span class=\"line\">worker_processes  2;</span><br><span class=\"line\">pid   /home/www/nginx/nginx.pid;</span><br><span class=\"line\">error_log /home/www/nginx/log/error.log warn;</span><br><span class=\"line\">worker_rlimit_nofile  2048;</span><br><span class=\"line\">events &#123;</span><br><span class=\"line\">  worker_connections  1024;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>main context</code>的配置可以参考<a href=\"https://nginx.org/en/docs/ngx_core_module.html\" target=\"_blank\" rel=\"noopener\">ngx_core_module</a>。</p>\n<ul>\n<li><code>http block</code>配置:</li>\n</ul>\n<h4 id=\"设置http请求日志\"><a href=\"#设置http请求日志\" class=\"headerlink\" title=\"设置http请求日志\"></a>设置http请求日志</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '</span><br><span class=\"line\">                  '$status $body_bytes_sent \"$http_referer\" '</span><br><span class=\"line\">                  '\"$http_user_agent\" \"$http_x_forwarded_for\"';</span><br><span class=\"line\">access_log  /home/www/nginx/log/access.log  main;</span><br></pre></td></tr></table></figure>\n<h4 id=\"定义MIME-type-到文件拓展名的映射\"><a href=\"#定义MIME-type-到文件拓展名的映射\" class=\"headerlink\" title=\"定义MIME type 到文件拓展\b名的映射\"></a>定义MIME type 到文件拓展\b名的映射</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">include       /etc/nginx/mime.types;</span><br><span class=\"line\"><span class=\"meta\">#</span>默认的MIME type</span><br><span class=\"line\">default_type  application/octet-stream;</span><br></pre></td></tr></table></figure>\n<h4 id=\"优化文件传送\"><a href=\"#优化文件传送\" class=\"headerlink\" title=\"优化文件传送\"></a>优化文件传送</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span>磁盘文件从内核态直接发送到网卡设备，避免了拷贝到用户态的开销。</span><br><span class=\"line\">sendfile       on;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span>开启TCP_CORK选项，当数据包达到固定大小才开始传送。</span><br><span class=\"line\">tcp_nopush     on;</span><br></pre></td></tr></table></figure>\n<h4 id=\"设置客户端连接超时时间\"><a href=\"#设置客户端连接超时时间\" class=\"headerlink\" title=\"设置客户端连接超时时间\"></a>设置客户端连接超时时间</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">keepalive_timeout  65s;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>当时间超过65秒，客户端到服务器的连接将会断开。可以把时间设置的稍微短一些，加快无用连接的回收。</p>\n</blockquote>\n<h4 id=\"开启基本文件目录功能\"><a href=\"#开启基本文件目录功能\" class=\"headerlink\" title=\"开启基本文件目录功能\"></a>开启基本文件目录功能</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">autoindex on;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>autoindex</code>依赖于<a href=\"https://nginx.org/en/docs/http/ngx_http_autoindex_module.html\" target=\"_blank\" rel=\"noopener\">ngx_http_autoindex_module</a>。</p>\n</blockquote>\n<p><code>http block</code>配置预览：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http &#123;</span><br><span class=\"line\">  include       /etc/nginx/mime.types;</span><br><span class=\"line\">  default_type  application/octet-stream;</span><br><span class=\"line\"></span><br><span class=\"line\">  log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '</span><br><span class=\"line\">                       '$status $body_bytes_sent \"$http_referer\" '</span><br><span class=\"line\">                       '\"$http_user_agent\" \"$http_x_forwarded_for\"';</span><br><span class=\"line\"></span><br><span class=\"line\">  access_log  /home/www/nginx/log/access.log  main;</span><br><span class=\"line\"></span><br><span class=\"line\">  sendfile        on;</span><br><span class=\"line\">  tcp_nopush      on;</span><br><span class=\"line\"></span><br><span class=\"line\">  keepalive_timeout  65s;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<hr>\n<h3 id=\"反向代理配置\"><a href=\"#反向代理配置\" class=\"headerlink\" title=\"反向代理配置\"></a>反向代理配置</h3><p>反向代理相关的配置一般都放置在<code>nginx/conf.d</code>目录下，以<code>hostname</code>命名。</p>\n<h4 id=\"虚拟主机与请求的分发\"><a href=\"#虚拟主机与请求的分发\" class=\"headerlink\" title=\"虚拟主机与请求的分发\"></a>虚拟主机与请求的分发</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">listen 443 ssl default_server;</span><br><span class=\"line\">server_name bitsum.pro *.bitsum.pro;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>\b一个<code>server block</code>对应一个虚拟主机的配置，<code>default_server</code>当请求找不到虚拟主机的时候，该虚拟主机作为默认的虚拟主机接受请求。</p>\n</blockquote>\n<h4 id=\"定义反向代理的host、负载均衡\"><a href=\"#定义反向代理的host、负载均衡\" class=\"headerlink\" title=\"定义反向代理的host、负载均衡\"></a>定义反向代理的<code>host</code>、负载均衡</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">upstream backend_hosts &#123;</span><br><span class=\"line\">  server  47.75.216.4;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><code>upstream</code>block里面可以配置负载均衡算法、权重等信息。</p>\n</blockquote>\n<p><strong>几种负载均衡算法：</strong></p>\n<ul>\n<li>round robin<blockquote>\n<p>默认的均衡算法，客户端请求被\b轮流分配到上游服务器。</p>\n</blockquote>\n</li>\n<li>least_conn<blockquote>\n<p>新的客户端连接被分配到最少活跃连接数的上游服务器。</p>\n</blockquote>\n</li>\n<li>ip_hash<blockquote>\n<p>用客户端ip做为hash的key，前三位8字节决定哪一个服务器处理这个客户端请求。这种算法可以保证<code>session</code>一致性。</p>\n</blockquote>\n</li>\n<li>hash<blockquote>\n<p>基于客户端传递的数据做hash。</p>\n</blockquote>\n</li>\n</ul>\n<p><strong>设置服务器权重:</strong><br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">upstream backend_hosts &#123;</span><br><span class=\"line\">  server host1.example.com weight=3;</span><br><span class=\"line\">  server host2.example.com;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<blockquote>\n<p>默认每一个<code>host</code>的权重都是1，<code>host1</code>接受的请求量将会是<code>host2</code>的三倍。</p>\n</blockquote>\n<h4 id=\"指定上游被代理的服务器、设置额外的请求头\"><a href=\"#指定上游被代理的服务器、设置额外的请求头\" class=\"headerlink\" title=\"指定上游被代理的服务器、设置额外的请求头\"></a>指定上游被代理的服务器、设置额外的请求头</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">location / &#123;</span><br><span class=\"line\"><span class=\"meta\">  #</span>所有请求都被转发到`backend_hosts`</span><br><span class=\"line\">  proxy_pass  http://backend_hosts;</span><br><span class=\"line\"><span class=\"meta\">  #</span>设置客户端请求host</span><br><span class=\"line\">  proxy_set_header    HOST $host;</span><br><span class=\"line\"><span class=\"meta\">  #</span>设置客户端请求协议(http、https)</span><br><span class=\"line\">  proxy_set_header    X-Forwarded-Proto $scheme;</span><br><span class=\"line\"><span class=\"meta\">  #</span>把客户端的真实ip通过`X-Real-IP`透传到上游服务器</span><br><span class=\"line\">  proxy_set_header    X-Real-IP $remote_addr;</span><br><span class=\"line\"><span class=\"meta\">  #</span>代理服务器地址列表、上层代理服务器地址添加到后面</span><br><span class=\"line\">  proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"使用Buffer缓存数据\"><a href=\"#使用Buffer缓存数据\" class=\"headerlink\" title=\"使用Buffer缓存数据\"></a>使用Buffer缓存数据</h3><p><em>为什么<code>buffer</code>能优化代理\b请求呢？</em></p>\n<p>当没有开启<code>buffer</code>的时候，被代理的上游服务器的数据立刻被代理服务器转送到客户端。如果客户端处理的足够快，可以关闭\b<code>buffer</code>的功能，以便客户端尽可能快的获得数据。当<code>buffer</code>功能开启的时候，代理服务器会暂存上游服务器返回的数据，然后再反馈给客户端。如果客户端接受数据的速度过慢，<code>nginx</code>会关闭到代理服务器的连接。然后以适合的速度发送数据给客户端。</p>\n<p><code>Buffer</code>相关配置命令:</p>\n<ul>\n<li><p>proxy_buffering</p>\n<blockquote>\n<p>控制是否开启<code>buffering</code>功能。</p>\n</blockquote>\n</li>\n<li><p>proxy_buffers</p>\n<blockquote>\n<p>控制缓存代理响应的块的个数以及大小。</p>\n</blockquote>\n</li>\n<li><p>proxy_buffer_size</p>\n<blockquote>\n<p>控制缓存代理响应头部的大小, 默认等于proxy_buffers配置的<code>size</code>大小，\b由于响应头比较小，可以适当设置小一点。(当proxy_buffering关闭的时候，依然可以使用。)</p>\n</blockquote>\n</li>\n<li><p>proxy_busy_buffers_size</p>\n<blockquote>\n<p>控制发送数据给客户端的缓存的大小。</p>\n</blockquote>\n</li>\n<li><p>proxy_max_temp_file_size</p>\n<blockquote>\n<p>当上游服务器的响应过大的时候，会被缓存在一个临时的磁盘文件里面。该指令配置缓存文件的大小。</p>\n</blockquote>\n</li>\n<li><p>proxy_temp_file_write_size</p>\n<blockquote>\n<p>当上游服务器的响应过大的时候，会被缓存在一个临时的磁盘文件里面。该指令配置一次写入缓存文件的数据大小。</p>\n</blockquote>\n</li>\n<li><p>proxy_temp_path</p>\n<blockquote>\n<p>缓存临时文件存放目录。</p>\n</blockquote>\n</li>\n</ul>\n<h3 id=\"设置Cache缓存静态数据\"><a href=\"#设置Cache缓存静态数据\" class=\"headerlink\" title=\"设置Cache缓存静态数据\"></a>设置<code>Cache</code>缓存静态数据</h3><p><code>Cache</code>相关配置命令:</p>\n<ul>\n<li>proxy_cache_path<br>基本格式：<br><code>proxy_cache_path    /home/www/nginx/cache   levels=1:2  keys_zone=backcache:8m max_size=50m use_temp_path=off;</code><blockquote>\n<p><code>/home/www/nginx/cache</code>作为缓存路径，如果不存在需要新建，并且设置好目录的权限：</p>\n</blockquote>\n</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir -p /home/www/nginx/cache</span><br><span class=\"line\"><span class=\"meta\">#</span>根据启动worker进程的用户, 这里设置为对应的用户</span><br><span class=\"line\">sudo chown nginx.nginx /home/www/nginx/cache</span><br><span class=\"line\">sudo chmod 700 /home/www/nginx/cache</span><br></pre></td></tr></table></figure>\n<p><code>levels</code>设置缓存的目录结构层次，缓存<code>key</code>的最后一个字节作为一级子目录的名称，倒数二三两个字节作为二级缓存子目录的名称。</p>\n<p><code>keys_zone</code>定义缓存区域的名称，这里称之为<code>backcache</code>。最多有8m的缓存<code>key</code>，缓存数据的最大大小为<code>50m</code>。</p>\n<ul>\n<li>proxy_cache_key(定义缓存<code>key</code>的格式)<br>基本格式：<br><code>proxy_cache_key     &quot;$scheme$request_method$host$request_uri$is_args$args&quot;;</code></li>\n</ul>\n<ul>\n<li>proxy_cache_valid<br>基本格式：<br><code>proxy_cache_valid   404 1m;</code><blockquote>\n<p>根据状态码来控制缓存的有效时间，上例中，缓存404响应的有效时间为1分钟。</p>\n</blockquote>\n</li>\n</ul>\n<p><strong>启用Cache</strong><br>上面定义了<code>cache</code>的基本配置，现在要告诉<code>nginx</code>那里应该开启<code>cache</code>。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">location ~ ^/(admin|download|miner-client|mobile|static|website)/ &#123;</span><br><span class=\"line\"><span class=\"meta\">  #</span>使用backcache这个cache zone</span><br><span class=\"line\">  proxy_cache backcache;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">  #</span>允许客户端通过http请求头\b控制跳过缓存请求最新的数据</span><br><span class=\"line\">  proxy_cache_bypass  $http_cache_control;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">  #</span>添加一个头部信息，对于一个请求可以清晰的看到，是被缓存了、缓存失效等状态信息。</span><br><span class=\"line\">  add_header X-Proxy-Cache $upstream_cache_status;</span><br><span class=\"line\"></span><br><span class=\"line\">  proxy_pass  http://backend_hosts;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>开启gzip压缩</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server &#123;</span><br><span class=\"line\"><span class=\"meta\">  #</span>开启gzip压缩功能</span><br><span class=\"line\">  gzip on;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">  #</span>设置启用gzip的http版本信息</span><br><span class=\"line\">  gzip_http_version   1.0;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">  #</span>设置gzip压缩等级</span><br><span class=\"line\">  gzip_comp_level   5;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">  #</span>设置当Content-Length大于256的时候启用gzip配置</span><br><span class=\"line\">  gzip_min_length   256;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">  #</span>对所有的代理请求都启用gzip</span><br><span class=\"line\">  gzip_proxied  any;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">  #</span>添加“Vary: Accept-Encoding”到请求头部告知代理服务器是否支持gzip压缩</span><br><span class=\"line\">  gzip_vary   on;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">  #</span>设置需要压缩的MIME types</span><br><span class=\"line\">  gzip_types</span><br><span class=\"line\">    application/atom+xml</span><br><span class=\"line\">    application/javascript</span><br><span class=\"line\">    application/json</span><br><span class=\"line\">    application/rss+xml</span><br><span class=\"line\">    application/vnd.ms-fontobject</span><br><span class=\"line\">    application/x-font-ttf</span><br><span class=\"line\">    application/x-web-app-manifest+json</span><br><span class=\"line\">    application/xhtml+xml</span><br><span class=\"line\">    application/xml</span><br><span class=\"line\">    font/opentype</span><br><span class=\"line\">    image/svg+xml</span><br><span class=\"line\">    image/x-icon</span><br><span class=\"line\">    text/css</span><br><span class=\"line\">    text/plain</span><br><span class=\"line\">    text/x-component;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"给你的网站加上https证书\"><a href=\"#给你的网站加上https证书\" class=\"headerlink\" title=\"给你的网站加上https证书\"></a>给你的网站加上https证书</h3><p>要给网站开启<code>https</code>，那么\b你需要从证书颁发机构(CA)获得一个证书文件，<a href=\"https://letsencrypt.org/\" target=\"_blank\" rel=\"noopener\">letsencrypt</a>是一个免费开放的证书颁发机构。接下来，你需要证明这个域名你实际拥有控制权，这需要通过<a href=\"https://ietf-wg-acme.github.io/acme/\" target=\"_blank\" rel=\"noopener\">ACME protocol</a>协议来保障。</p>\n<p><a href=\"https://certbot.eff.org/\" target=\"_blank\" rel=\"noopener\">certbot</a>是一个<code>ACME</code>的客户端，在你的主机运行它自动生成证书文件，与此同时主机不需要停机。</p>\n<p>letsencrypt原理图：</p>\n<p><img src=\"/img/letEncrypt原理图.png\" alt=\"letEncrypt\"></p>\n<blockquote>\n<p>LetEncrypt会发送请求到<code>ACME</code>运行的服务器，校验所有权是否合法。</p>\n</blockquote>\n<p>接下来看看如何配置：</p>\n<p>因为系统主机安装了<code>docker</code>，<code>certbot</code>刚好也有对应的镜像文件：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo docker run -it --name certbot  -p 80:80 \\</span><br><span class=\"line\">  -v /home/www/nginx/html:/usr/share/nginx/html \\</span><br><span class=\"line\">  -v /home/www/mycertificate/letsencrypt:/etc/letsencrypt \\</span><br><span class=\"line\">  -v /home/www/mycertificate/letsencrypt-lib/:/var/lib/letsencrypt \\</span><br><span class=\"line\">  certbot/certbot certonly</span><br></pre></td></tr></table></figure>\n<p>允许上面命令的时候，会出现一系列交互提示出现：</p>\n<p>How would you like to authenticate with the ACME CA?</p>\n<hr>\n<p>1: Spin up a temporary webserver (standalone)<br>2: Place files in webroot directory (webroot)</p>\n<hr>\n<p>Select the appropriate number [1-2] then [enter] (press ‘c’ to cancel):</p>\n<p>因为代理服务器还没有启动起来，这里选择<code>standalone</code>模式，就把<code>ACME</code>当作一个临时的web服务器。</p>\n<p>Plugins selected: Authenticator standalone, Installer None<br>Enter email address (used for urgent renewal and security notices) (Enter ‘c’ to<br>cancel):</p>\n<p>要求填写一个邮箱地址，接受证书过期的提示，以及一些安全提醒等。</p>\n<p>Please read the Terms of Service at<br><a href=\"https://letsencrypt.org/documents/LE-SA-v1.2-November-15-2017.pdf\" target=\"_blank\" rel=\"noopener\">https://letsencrypt.org/documents/LE-SA-v1.2-November-15-2017.pdf</a>. You must<br>agree in order to register with the ACME server at<br><a href=\"https://acme-v02.api.letsencrypt.org/directory\" target=\"_blank\" rel=\"noopener\">https://acme-v02.api.letsencrypt.org/directory</a></p>\n<hr>\n<p>(A)gree/(C)ancel: A</p>\n<p>同意<code>letsencrypt</code>这个组织的服务条款。</p>\n<hr>\n<p>Would you be willing to share your email address with the Electronic Frontier<br>Foundation, a founding partner of the Let’s Encrypt project and the non-profit<br>organization that develops Certbot? We’d like to send you email about our work<br>encrypting the web, EFF news, campaigns, and ways to support digital freedom.</p>\n<hr>\n<p>(Y)es/(N)o: Y<br>Please enter in your domain name(s) (comma and/or space separated)  (Enter ‘c’<br>to cancel):</p>\n<p>提示输入\b要开启<code>https</code>的域名，多个域名用逗号或者空格分开。</p>\n<blockquote>\n<p>证书生成完毕之后会在<code>/home/www/mycertificate/letsencrypt</code>目录下有相应的文件，值得注意的是，多个域名共用一个证书文件。所以如果你在上一步配置了多个域名，这里也只能看到一个证书文件。</p>\n</blockquote>\n<p><em>nginx 配置<code>https</code>证书</em></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server &#123;</span><br><span class=\"line\">  listen 443 ssl default_server;</span><br><span class=\"line\">  server_name bitsum.pro *.bitsum.pro;</span><br><span class=\"line\"><span class=\"meta\">  #</span>PEM格式的证书文件</span><br><span class=\"line\">  ssl_certificate     /home/www/mycertificate/letsencrypt/live/dev.bitsum.pro/fullchain.pem;</span><br><span class=\"line\"><span class=\"meta\">  #</span>证书文件的密钥</span><br><span class=\"line\">  ssl_certificate_key /home/www/mycertificate/letsencrypt/live/dev.bitsum.pro/privkey.pem;</span><br><span class=\"line\"><span class=\"meta\">  #</span>指定https的协议版本</span><br><span class=\"line\">  ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;</span><br><span class=\"line\"><span class=\"meta\">  #</span> 启用指定的OpenSSL ciphers</span><br><span class=\"line\">  ssl_ciphers         HIGH:!aNULL:!MD5;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>启动<code>nginx</code>服务：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo nginx -c /home/www/nginx/nginx.conf</span><br></pre></td></tr></table></figure>\n<p><strong>完整配置文件</strong></p>\n<p><em>nginx.conf:</em></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">user  nginx nginx;</span><br><span class=\"line\">worker_processes  2;</span><br><span class=\"line\"></span><br><span class=\"line\">pid        /home/www/nginx/nginx.pid;</span><br><span class=\"line\">error_log  /home/www/nginx/log/error.log warn;</span><br><span class=\"line\"></span><br><span class=\"line\">worker_rlimit_nofile    2048;</span><br><span class=\"line\">events &#123;</span><br><span class=\"line\">  worker_connections  1024;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"> http &#123;</span><br><span class=\"line\">    include       /etc/nginx/mime.types;</span><br><span class=\"line\">    default_type  application/octet-stream;</span><br><span class=\"line\"></span><br><span class=\"line\">    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '</span><br><span class=\"line\">                      '$status $body_bytes_sent \"$http_referer\" '</span><br><span class=\"line\">                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';</span><br><span class=\"line\"></span><br><span class=\"line\">    access_log  /home/www/nginx/log/access.log  main;</span><br><span class=\"line\"></span><br><span class=\"line\">    sendfile        on;</span><br><span class=\"line\">    tcp_nopush     on;</span><br><span class=\"line\"></span><br><span class=\"line\">    keepalive_timeout  65s;</span><br><span class=\"line\"></span><br><span class=\"line\">    autoindex  on;</span><br><span class=\"line\"> </span><br><span class=\"line\">    proxy_cache_path    /home/www/nginx/cache   levels=1:2  keys_zone=backcache:8m max_size=50m use_temp_path=off;</span><br><span class=\"line\">    proxy_cache_key     \"$scheme$request_method$host$request_uri$is_args$args\";</span><br><span class=\"line\">    proxy_cache_valid   302 10m;</span><br><span class=\"line\">    proxy_cache_valid   404 1m;</span><br><span class=\"line\"> </span><br><span class=\"line\">    include /home/www/nginx/conf.d/*.conf;</span><br><span class=\"line\"> &#125;</span><br></pre></td></tr></table></figure>\n<p><em>config.d/bitsum.pro.conf:</em></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen 80;</span><br><span class=\"line\">    server_name bitsum.pro;</span><br><span class=\"line\">    return 301 https://bitsum.pro$request_uri;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">upstream backend_hosts &#123;</span><br><span class=\"line\">    server  47.75.216.4;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">  listen 443 ssl default_server;</span><br><span class=\"line\">  server_name bitsum.pro *.bitsum.pro;</span><br><span class=\"line\">  ssl_certificate     /home/www/mycertificate/letsencrypt/live/dev.bitsum.pro/fullchain.pem;</span><br><span class=\"line\">  ssl_certificate_key /home/www/mycertificate/letsencrypt/live/dev.bitsum.pro/privkey.pem;</span><br><span class=\"line\">  ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;</span><br><span class=\"line\">  ssl_ciphers         HIGH:!aNULL:!MD5;</span><br><span class=\"line\"></span><br><span class=\"line\">  proxy_buffering on;</span><br><span class=\"line\">  proxy_buffer_size 2k;</span><br><span class=\"line\">  proxy_buffers   32 8k;</span><br><span class=\"line\">  proxy_busy_buffers_size 16k;</span><br><span class=\"line\">  proxy_max_temp_file_size 2048m;</span><br><span class=\"line\">  proxy_temp_file_write_size 32k;</span><br><span class=\"line\"></span><br><span class=\"line\">  location ~ ^/(admin|download|miner-client|mobile|static|website)/ &#123;</span><br><span class=\"line\">    proxy_cache backcache;</span><br><span class=\"line\">    proxy_cache_bypass  $http_cache_control;</span><br><span class=\"line\">    add_header X-Proxy-Cache $upstream_cache_status;</span><br><span class=\"line\"></span><br><span class=\"line\">    proxy_pass  http://backend_hosts;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  location / &#123;</span><br><span class=\"line\">    proxy_pass  http://backend_hosts;</span><br><span class=\"line\"></span><br><span class=\"line\">    proxy_set_header    HOST $host;</span><br><span class=\"line\">    proxy_set_header    X-Forwarded-Proto $scheme;</span><br><span class=\"line\">    proxy_set_header    X-Real-IP $remote_addr;</span><br><span class=\"line\">    proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">  #</span>设置启用gzip的http版本信息</span><br><span class=\"line\">  gzip_http_version   1.0;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">  #</span>设置gzip压缩等级</span><br><span class=\"line\">  gzip_comp_level   5;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">  #</span>设置当Content-Length大于256的时候启用gzip配置</span><br><span class=\"line\">  gzip_min_length   256;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">  #</span>对所有的代理请求都启用gzip</span><br><span class=\"line\">  gzip_proxied  any;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">  #</span>添加“Vary: Accept-Encoding”到请求头部告知代理服务器是否支持gzip压缩</span><br><span class=\"line\">  gzip_vary   on;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">  #</span>设置需要压缩的MIME types</span><br><span class=\"line\">  gzip_types</span><br><span class=\"line\">    application/atom+xml</span><br><span class=\"line\">    application/javascript</span><br><span class=\"line\">    application/json</span><br><span class=\"line\">    application/rss+xml</span><br><span class=\"line\">    application/vnd.ms-fontobject</span><br><span class=\"line\">    application/x-font-ttf</span><br><span class=\"line\">    application/x-web-app-manifest+json</span><br><span class=\"line\">    application/xhtml+xml</span><br><span class=\"line\">    application/xml</span><br><span class=\"line\">    font/opentype</span><br><span class=\"line\">    image/svg+xml</span><br><span class=\"line\">    image/x-icon</span><br><span class=\"line\">    text/css</span><br><span class=\"line\">    text/plain</span><br><span class=\"line\">    text/x-component;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"参考文献\"><a href=\"#参考文献\" class=\"headerlink\" title=\"参考文献\"></a>参考文献</h3><p><a href=\"https://medium.com/@pierangelo1982/docker-nginx-and-letsencrypt-432397db4a0c\" target=\"_blank\" rel=\"noopener\">Docker NGINX and letsencrypt</a><br><a href=\"https://letsencrypt.org/getting-started/\" target=\"_blank\" rel=\"noopener\">letsencrypt</a><br><a href=\"https://certbot.eff.org\" target=\"_blank\" rel=\"noopener\">certbot</a><br><a href=\"https://www.digitalocean.com/community/tutorials/understanding-nginx-http-proxying-load-balancing-buffering-and-caching#configuring-proxy-caching-to-decrease-response-times\" target=\"_blank\" rel=\"noopener\">understanding-nginx-http-proxying</a><br><a href=\"https://nginx.org/en/docs/http/ngx_http_proxy_module.html\" target=\"_blank\" rel=\"noopener\">ngx_http_proxy_module</a><br><a href=\"https://nginx.org/en/docs/http/ngx_core_module.html\" target=\"_blank\" rel=\"noopener\">ngx_core_module</a><br><a href=\"https://nginx.org/en/docs/http/ngx_http_ssl_module.html\" target=\"_blank\" rel=\"noopener\">ngx_http_ssl_module</a><br><a href=\"https://www.nginx.com/blog/nginx-caching-guide/\" target=\"_blank\" rel=\"noopener\">nginx-caching-guide</a>  </p>\n"},{"title":"基于Jaeger的分布式监控系统实践","date":"2017-09-10T12:08:42.000Z","keywords":["jaeger","opentracing","dapper"],"_content":"\n\n# 基于`Jaeger`的分布式监控系统实践\n\n## 为什么要引入监控系统\n\n微服务架构消除了传统`SOA`架构服务之间的耦合性，降低系统的复杂度，单个服务可以独立运行部署也提升了产品迭代速度。但是，衍生出来的问题是如何才能够有效监控每一个服务，多个服务之间互相调用如何被监控，如何更快的发现系统故障，消除系统瓶颈。随着微服务数量增多，系统并发量上升通过传统`log`来定位问题变得比较困难，这个时候分布式监控系统变得非常重要。\n\n---\n\n## 监控系统实现的理论基础\n\n现代流行的监控系统实现的理论依据主要来源于[Google Dapper paper](https://static.googleusercontent.com/media/research.google.com/zh-CN//pubs/archive/36356.pdf)。该论文中提出了`trace`、`span`、`annotations`、`log`、`采样`、`服务依赖分析`等概念。\n\n![TraceSpan](http://owoeej96r.bkt.clouddn.com/o_1btqo9g0i1bul11p61178kk613coa)\n\n一个完整的客户端请求可以被称为一个`trace`, `span`是指调用过程中的一个时间区间, 也就是这个英文名的由来，一般对应一个方法或者代码块的执行。服务端收到请求后需要做相应的处理，可能是调用内部函数，也可能是通过`RPC`调用其他服务的功能。这些调用过程都可以被称为`span`。而这些`span`之间会有依赖关系，从而构成了一条完整的\b`trace tree`。为了方便应用程序开发者追踪调试问题，`trace`系统在实现的还应该提供相应的`API`方便开发者写入数据，也就是给`span`注入一些`annotations`或者`log`。`trace`系统在设计的时候必须考虑到不能影响应用系统的吞吐效率，特别是对于高并发系统需要特别注意，这个时候采样的策略变得尤其关键。在系统并发量小的时候提高采样频率、并发量上升的时候降低采样频率是一个比较好的选择。\n\n现代监控系统的实现都在该论文基础上或多或少做了一定的修改。目前云计算基金会`CNCF`下的`OpenTracing`项目是一个厂商中立语言无关的分布式`trace`标准。而本文后续介绍的`Jaeger`分布式监控系统正是基于该标准来实现。\n\n`OpenTracing`标准明确了三个重要的互相关联的类型：`Tracer`、`Span`、`SpanContext`。`Tracer`主要负责：\n\n*  `Span`创建\n\n`Tracer`创建`Span`的时候需要指定一个名称,表明`Span`的含义,以及该`Span`之间的引用关系。\n\n* `SpanContext`的注入和提取\n\n在跨进程追踪的时候,需要利用注入接口把当前`trace`和`span`的信息传递给目标进程。而目标进程需要调用提取接口取得信息。这中间的可能是通过`HTTP`请求、或者其他`RPC`框架。`OpenTracing`不对通信协议限制，只是提出三个注入和提取的时候需要满足指定的数据格式。\n\n`Span`的实现除了必须支持应用程序设置`tag`、写入调试`log`信息，还必须支持设置用户自定义数据，该数据会随着系统调用而传递。`OpenTracing`标准对`span`常用的`tag`以及`log`信息有规范推荐。应用程序代码在接入的时候，建议遵循该规范。\n\n`SpanContext`存放的是`Span`上下文相关的数据, 如：当前`tracer id`, `span id`, 用户自定义数据等。\n\n关于`OpenTracing`更加详细的描述，可以参考[官方文档](http://opentracing.io/documentation/pages/spec.html)。\n\n---\n\n## Jaeger监控系统介绍\n\n`Jaeger`分布式监控系统由`Uber`设计并实现，现已捐赠给`CNCF`基金会,作为分布式环境下推荐的监控系统。Jaeger系统架构如下：\n\n![Jaeger监控系统架构](http://owoeej96r.bkt.clouddn.com/o_1btr8q4mh1qb3fue1rtq8qq1r3la)\n\n和其他监控系统类似，`Jaeger`主要包含一下几个模块：\n\n* 应用程序探针`SDK`(`jaeger-client`)\n\n`jaeger-client`实现了特定语言相关的`opentracing-api`，应用程序调用`api`写入数据，`client`把`trace`信息按照应用程序指定的采样策略传递给`jaeger-agent`。这里用的是`Thrift`序列化协议,采用`UDP`通信。\n\n* 数据传输代理(`jaeger-agent`)\n\n`agent`作为一个代理，负责把`client`传递上来的数据，批量发送给`jaeger-collector`。如图所示这里采用的是`Uber`自己研发的`TChannal` `RPC`框架。\n\n* 数据处理中心(`jaeger-collector`)\n\n`collector`负责对`agent`发上来的数据进行校验、创建索引、分析、汇总、存储。从图示可以看到`collector`还有一个功能是控制`agent`的`采样频率`。从而降低对应用程序系统的影响。\n\n* `UI`(`jaeger-ui`)\n\n`ui`模块负责从持久化存储中读取数据，在前端页面展示出来。除此之外`jaeger-ui`还能展现系统依赖拓扑图。\n\n---\n\n## Jaeger监控系统部署\n\n`Jaeger`在部署过程中需要用到以下包几个镜像。\n\n| 组件名称                                     | 镜像地址                                     |\n| ---------------------------------------- | ---------------------------------------- |\n| **jaeger-agent**                         | [hub.docker.com/r/jaegertracing/jaeger-agent/](https://hub.docker.com/r/jaegertracing/jaeger-agent/) |\n| **jaeger-collector**                     | [hub.docker.com/r/jaegertracing/jaeger-collector/](https://hub.docker.com/r/jaegertracing/jaeger-collector/) |\n| **jaeger-query**                         | [hub.docker.com/r/jaegertracing/jaeger-query/](https://hub.docker.com/r/jaegertracing/jaeger-query/) |\n| **jaegertracing/jaeger-cassandra-schema** | [hub.docker.com/r/jaegertracing/jaeger-cassandra-schema/](https://hub.docker.com/r/jaegertracing/jaeger-cassandra-schema) |\n| **cassandra**                            | [https://hub.docker.com/r/library/cassandra/](https://hub.docker.com/r/library/cassandra/) |\n\n\n我们可以通过`docker`命令依次启动组件镜像，或者通过`docker-compose`来部署。\n\n#### 通过`docker`命令部署\n\n* 启动`cassandra`数据库\n\n> docker run --rm -it --name cassandra -v /Users/ytx/cassandra/datadir:/var/lib/cassandra -p 9042:9042 cassandra:3.11\n\n* 初始化数据库表结构\n\n> docker run --link cassandra --rm jaegertracing/jaeger-cassandra-schema\n\n* 启动`jaeger-collector`连接到数据库\n\n> docker run --rm -it \\\n  -p 14267:14267/tcp \\\n  -p 14268:14268/tcp \\\n  -p 9411:9411/tcp \\\n  -e CASSANDRA_KEYSPACE=jaeger_v1_dc1 \\\n  -e CASSANDRA_SERVERS=192.168.33.99 jaegertracing/jaeger-collector\n\n这里`14267`端口用于接受`Agent`发送上来的数据。`14268`端口用于接受`Client`直接发送上来的数据。在实际部署的时候`CASSANDRA_SERVERS`配置要做相应修改。\n\n* 启动`Agent`\n\n> docker run --rm -p5775:5775/udp -p6831:6831/udp -p6832:6832/udp -p5778:5778/tcp jaegertracing/jaeger-agent /go/bin/agent-linux --collector.host-port=192.168.33.99:14267\n\n`Agent` `5778`端口用于接受`Collector`控制，如：采样频率变更、配置变更等。`6831`和`6832`端口表示`jaeger.thrift`分别通过`compact thrift protocol`和`binary thrift protocol`协议传输。`5775`端口用于接受`zipkin.thrift`数据结构。\n\n`Client`默认通过`6832`端口发送数据。\n\n* 启动`JaegerUI`\n\n> docker run --rm -e CASSANDRA_KEYSPACE=jaeger_v1_dc1 -e CASSANDRA_SERVERS=192.168.33.99 -it -p 16686:16686/tcp jaegertracing/jaeger-query\n\n`JaegerUI`需要连接到`cassandra`数据查询数据。同时提供提供前端页面展示数据。\n\n`Jaeger`目前支持`cassandra`和`ElasticSearch`作为数据持久化系统，后续会有对`MySQL`等支持。\n\n\n#### 通过`docker-compose`命令部署\n\n```yaml\nversion: '2'\nservices:\n  cassandra:\n    image: cassandra:3.11\n    container_name: cassandra\n    environment:\n      - CASSANDRA_DC=dc1\n      - MAX_HEAP_SIZE=512M\n      - HEAP_NEWSIZE=100M\n    ports:\n      - 9042:9042\n    restart: on-failure\n    volumes:\n      - /Users/ytx/cassandra/logs:/var/log/cassandra    \n      - /Users/ytx/cassandra/data:/var/lib/cassandra\n\n  jaeger-cassandra-schema:\n    image: jaegertracing/jaeger-cassandra-schema:0.9\n    container_name: cassandra-schema\n    links:\n      - cassandra\n    environment:\n      - MODE=test\n      - DATACENTER=dc1\n\n  jaeger-collector:\n    image: jaegertracing/jaeger-collector:0.9\n    container_name: jaeger-collector\n    restart: on-failure\n    links:\n      - cassandra\n    environment:\n      - CASSANDRA_SERVERS=cassandra\n      - CASSANDRA_KEYSPACE=jaeger_v1_dc1\n      - CASSANDRA_PORT=9042\n    ports:\n      - 14267:14267/tcp\n      - 14268:14268/tcp\n      - 9411:9411/tcp\n\n  jaeger-agent:\n    image: jaegertracing/jaeger-agent:0.9\n    container_name: jaeger-agent\n    restart: on-failure\n    links:\n      - jaeger-collector\n    environment:\n      - COLLECTOR_HOST_PORT=jaeger-collector:14267\n    ports:\n      - 5775:5775/udp\n      - 6831:6831/udp\n      - 6832:6832/udp\n      - 5778:5778/tcp\n\n  jaeger-query:\n    image: jaegertracing/jaeger-query:0.9\n    container_name: jaeger-query\n    restart: on-failure\n    links:\n      - cassandra\n    environment:\n      - CASSANDRA_KEYSPACE=jaeger_v1_dc1\n      - CASSANDRA_SERVERS=cassandra\n    ports:\n      - 8003:16686/tcp\n\nnetworks:\n  default:\n    driver: bridge\n\n```\n\n---\n\n## Jaeger集成到应用程序\n\n`jaeger`团队提供了针对`Node.js`环境的工具包[jaeger-client-node](https://github.com/jaegertracing/jaeger-client-node)。如何能够跟团队项目代码更好的契合是接下来要考虑的点。针对现有的项目，在接入`Jaeger`的时候是一个渐进的过程，希望能够做尽量少的修改代码。\n\n针对`Node.js`生态下`web`服务器的路由都是采用类似`connect`风格，我们对常用的`web`框架路由做相应的包装：\n\n```javascript\n\nfunction RouterProxy(router, config) {\n  this.config = config\n  this.proxyInstance = router  \n}\n\nRouterProxy.create = function (config, tracer = null) {\n  if (!config.router) {\n    throw new Error(\"Not Setup Router\")\n  }\n\n  if (!config.proxy) {\n    throw new Error(\"Not Setup Proxy\")    \n  }\n\n  const proxyInstance = RouterCreator(config.proxy)\n  const instance = new RouterProxy(proxyInstance, config)\n  instance.wrap(config.router, tracer)\n\n  return instance\n}\n\nRouterProxy.prototype.wrap = function (router, tracer = null) {\n  if (!tracer) {\n    tracer = opentracing.globalTracer()  \n  }\n\n  constants.PROXY_NAMES.forEach(method => {\n    this.wrapRouterMethod(router, method, tracer)\n  })\n\n  return router\n}\n\nRouterProxy.prototype.wrapRouterMethod = function (router, method, tracer) {\n  if (typeof router[method] !== 'function') {\n    return\n  }\n\n  const that = this\n  const doit = router[method].bind(router)\n  router[method] = function (...args) {\n    const length = args.length\n    if (length <= 1 || typeof args[length-1] !== 'function') {\n      return doit(...args)\n    }\n    const uri = args[0]\n    const handler = that.wrapRouterMethodHandler(args[args.length - 1], uri, tracer)\n    args.splice(length -1, 1, handler)\n    return doit(...args)\n  }\n\n  return\n}\n\nRouterProxy.prototype.wrapRouterMethodHandler = function (handler, uri, tracer) {\n  const that = this\n\n  return function (...args) {\n    const req = that.proxyInstance.request(...args)\n    const res = that.proxyInstance.response(...args)\n    const url = that.proxyInstance.url(...args)\n    const method = that.proxyInstance.method(...args)\n\n    const span = extractOrCreateSpan(req, uri, tracer)\n    span.setTag(opentracing.Tags.HTTP_METHOD, method)\n    span.setTag(opentracing.Tags.HTTP_URL, url)\n    span.setTag(opentracing.Tags.SPAN_KIND, 'server')\n\n    const traceCtx = { span, tracer }\n    if (that.config.customizeTags) {\n      that.config.customizeTags(traceCtx, ...args)\n    }\n\n    args[0].traceCtx = traceCtx\n\n    function spanFinised () {\n      span.finish()\n    }\n\n    onFinished(res, spanFinised)\n\n    return handler(...args)\n  }\n}\n\n```\n\n通过以上方式在每个路由到达正式处理函数之前，[opentracing-connect](http://gitlab.yintech.net/ytx/paprika/nugget/backend/opentracing-connect)类库记录当前的`http`请求基本信息并把数据通过上下文参数暴露给用户处理函数，在处理完毕之后类库自动调用`finish`函数表示一次请求结束。需要注意的是：如果实际过程中希望记录更多的信息\b或者调用关系，需要用户参照`API`自己\b实现。\n\n---\n\n## JaegerUI基本使用\n\n假定现有如下两个服务：\n\n* Service One\n\n```javascript\n\nconst express = require('express')\nconst request = require('request-promise')\nconst { Tracer, RouterProxy } = require('opentracing-connect')\n\nconst app = new express()\n\nconst serviceName = 'One'\nTracer.createGlobalTracer(serviceName, { logger: console })\nconst Router = RouterProxy.create({ router: { type: \"express\" }}).routerProxy(express.Router())\n\nRouter.get('/one',  async (request, response, next) => {\n  const result = await requestServiceTwo(request.traceCtx.span)\n  response.json(result)\n})\n\nasync function requestServiceTwo(span) {\n  const peerServiceName = 'Two'\n  span.setTag(Tracer.opentracing.Tags.PEER_SERVICE, peerServiceName)\n  \n  let result  \n  try {\n    const carrier = {}\n    const uri = 'http://localhost:8020/two'\n    span.tracer().inject(span.context(), \n      Tracer.opentracing.FORMAT_HTTP_HEADERS, carrier)\n    result = await request({ uri, headers: carrier })\n    console.dir(result)\n    span.log({'event': 'request_end'})\n  } catch(err) {\n    span.setTag(Tracer.opentracing.Tags.ERROR, true)\n    span.log({ 'event': 'error', 'message': err.message })\n  }\n\n  return result\n}\n\napp.use(Router)\n\napp.listen(8010)\n\n```\n\n* Service Two\n\n```javascript\n\nconst Koa = require('koa')\nconst KoaRouter = require('koa-router')\nconst request = require('request-promise')\nconst { Tracer, RouterProxy } = require('opentracing-connect')\nconst Redis = require('./redis')\n\nconst app = new Koa()\n\nconst serviceName = 'Two'\nconst tracer = Tracer.createGlobalTracer(serviceName, { logger: console })\nconst Router = RouterProxy.create({ router: { type: \"koa2\" }}).routerProxy(KoaRouter())\n\nRouter.get('/two', async (ctx, next) => {\n  try {\n    const userId = 1\n    const result = await getUserInfo(userId, { span: ctx.traceCtx.span })\n    ctx.traceCtx.span.log({'event': 'request_end'})\n    ctx.body = { a: 1, b: 2, c: 3 }\n  } catch(err) {\n    ctx.traceCtx.span.setTag(Tracer.opentracing.Tags.ERROR, true)\n    ctx.traceCtx.span.logEvent('error', { message: err.message })\n  }\n\n  return \n})\n\nasync function getUserInfo(id, ctx) {\n  const span = tracer.startSpan(\"getUserInfo\", { references: [Tracer.opentracing.childOf(ctx.span.context())] })\n  \n  let result\n  try {\n    result = await Redis.getRedisUser(id, { span })\n  } catch(err) {\n    span.setTag(Tracer.opentracing.Tags.ERROR, true)\n    span.logEvent('error', { message: err.message })\n  }\n\n  span.finish()\n\n  return result\n}\n\napp.use(Router.routes())\n\napp.listen(8020)\n\n```\n\n在两个服务启动的时候，分别创建了一个`tracer`对象，写入当前服务的名称，以及一个`logger`对象用于追踪\b`jaeger-client`的行为。 `ServiceOne`提供了一个请求处理函数，该处理函数接收到请求之后向`ServiceTwo`发起请求，而`ServiceTwo`向`Redis`服务发起请求读取用户信息，并返回给客户端。\n\n\n通过`POSTMAN`向`ServiceOne`发起一个请求：\n\n![postman](http://owoeej96r.bkt.clouddn.com/o_1btt652ft10qb1c8t1csl1h0jovha)\n\n打开`Jaeger-UI`页面：\n\n![jaeger-ui](http://owoeej96r.bkt.clouddn.com/o_1btt65vo21ee34491b2mn0pa6sf)\n\n在`Jaeger-UI`页面左侧可以看到所有的服务列表，以及服务的`endpoint`列表。可以通过我们给应用程序设置的`tag`来搜索指定的`trace`。在`POSTMAN`页面可以看到响应时间为`114ms`,在`Jaeger-UI`看到此次`trace`有三个服务，包含四个`span`, `trace`的持续时间是`78ms`比`POSTMAN`检测到的时间要小，这是因为从服务器到`POSTMAN`客户端有网络延迟的缘故。\n\n点击`trace`条目：\n\n![jaeger-trace](http://owoeej96r.bkt.clouddn.com/o_1btt66ieuur4fd2m591umb1r8ok)\n\n可以看到整个调用链路：\n\n1. `ServiceOne`收到一个`GET`请求，`endpoint`为`/one`  \n2. `ServiceOne`向`ServiceTwo`发送一个请求，`endpoint`为`/two`  \n3. `Servicetwo`调用`getUserInfo`函数\n4. `getUserInfo`函数向`Redis`服务发送一个`get`请求获取用户信息, 用户id为`1`\n5. 最终`Redis`服务返回用户信息,`ServiceTwo`将用户信息返回给`ServiceOne`,`ServiceOne`把数据返回给客户端\n\n单击每个`span`条目，可以看到`tag`、`log`等信息。[opentracing](https://github.com/opentracing/specification/blob/master/semantic_conventions.md)对`span`内常使用的`tag`以及`log`字段有相应的推荐。\n\n\n## 参考文献\n\n1. [Google Dapper paper](https://static.googleusercontent.com/media/research.google.com/zh-CN//pubs/archive/36356.pdf)  \n2. [OpenTracing Best Pratices](http://opentracing.io/documentation/pages/instrumentation/)  \n3. [OpenTraing Specification](https://github.com/opentracing-contrib/opentracing-specification-zh/blob/master/specification.md)\n\n4. [OpenTracing Semantic Conventions](https://github.com/opentracing-contrib/opentracing-specification-zh/blob/master/semantic_conventions.md)\n\n5. [Jaeger, a distributed tracing system](http://jaeger.readthedocs.io/en/latest/)\n\n6. [Jaeger Client Node](https://github.com/jaegertracing/jaeger-client-node)  \n\n7. [OpenTracing API for Javascript](https://github.com/opentracing/opentracing-javascript)\n\n\n*--EOF--*","source":"_posts/jaeger.md","raw":"---\ntitle: 基于Jaeger的分布式监控系统实践\ndate: 2017-09-10 20:08:42\ntags: monitor\nkeywords: \n  - jaeger\n  - opentracing\n  - dapper\ncategories: 系统监控\n---\n\n\n# 基于`Jaeger`的分布式监控系统实践\n\n## 为什么要引入监控系统\n\n微服务架构消除了传统`SOA`架构服务之间的耦合性，降低系统的复杂度，单个服务可以独立运行部署也提升了产品迭代速度。但是，衍生出来的问题是如何才能够有效监控每一个服务，多个服务之间互相调用如何被监控，如何更快的发现系统故障，消除系统瓶颈。随着微服务数量增多，系统并发量上升通过传统`log`来定位问题变得比较困难，这个时候分布式监控系统变得非常重要。\n\n---\n\n## 监控系统实现的理论基础\n\n现代流行的监控系统实现的理论依据主要来源于[Google Dapper paper](https://static.googleusercontent.com/media/research.google.com/zh-CN//pubs/archive/36356.pdf)。该论文中提出了`trace`、`span`、`annotations`、`log`、`采样`、`服务依赖分析`等概念。\n\n![TraceSpan](http://owoeej96r.bkt.clouddn.com/o_1btqo9g0i1bul11p61178kk613coa)\n\n一个完整的客户端请求可以被称为一个`trace`, `span`是指调用过程中的一个时间区间, 也就是这个英文名的由来，一般对应一个方法或者代码块的执行。服务端收到请求后需要做相应的处理，可能是调用内部函数，也可能是通过`RPC`调用其他服务的功能。这些调用过程都可以被称为`span`。而这些`span`之间会有依赖关系，从而构成了一条完整的\b`trace tree`。为了方便应用程序开发者追踪调试问题，`trace`系统在实现的还应该提供相应的`API`方便开发者写入数据，也就是给`span`注入一些`annotations`或者`log`。`trace`系统在设计的时候必须考虑到不能影响应用系统的吞吐效率，特别是对于高并发系统需要特别注意，这个时候采样的策略变得尤其关键。在系统并发量小的时候提高采样频率、并发量上升的时候降低采样频率是一个比较好的选择。\n\n现代监控系统的实现都在该论文基础上或多或少做了一定的修改。目前云计算基金会`CNCF`下的`OpenTracing`项目是一个厂商中立语言无关的分布式`trace`标准。而本文后续介绍的`Jaeger`分布式监控系统正是基于该标准来实现。\n\n`OpenTracing`标准明确了三个重要的互相关联的类型：`Tracer`、`Span`、`SpanContext`。`Tracer`主要负责：\n\n*  `Span`创建\n\n`Tracer`创建`Span`的时候需要指定一个名称,表明`Span`的含义,以及该`Span`之间的引用关系。\n\n* `SpanContext`的注入和提取\n\n在跨进程追踪的时候,需要利用注入接口把当前`trace`和`span`的信息传递给目标进程。而目标进程需要调用提取接口取得信息。这中间的可能是通过`HTTP`请求、或者其他`RPC`框架。`OpenTracing`不对通信协议限制，只是提出三个注入和提取的时候需要满足指定的数据格式。\n\n`Span`的实现除了必须支持应用程序设置`tag`、写入调试`log`信息，还必须支持设置用户自定义数据，该数据会随着系统调用而传递。`OpenTracing`标准对`span`常用的`tag`以及`log`信息有规范推荐。应用程序代码在接入的时候，建议遵循该规范。\n\n`SpanContext`存放的是`Span`上下文相关的数据, 如：当前`tracer id`, `span id`, 用户自定义数据等。\n\n关于`OpenTracing`更加详细的描述，可以参考[官方文档](http://opentracing.io/documentation/pages/spec.html)。\n\n---\n\n## Jaeger监控系统介绍\n\n`Jaeger`分布式监控系统由`Uber`设计并实现，现已捐赠给`CNCF`基金会,作为分布式环境下推荐的监控系统。Jaeger系统架构如下：\n\n![Jaeger监控系统架构](http://owoeej96r.bkt.clouddn.com/o_1btr8q4mh1qb3fue1rtq8qq1r3la)\n\n和其他监控系统类似，`Jaeger`主要包含一下几个模块：\n\n* 应用程序探针`SDK`(`jaeger-client`)\n\n`jaeger-client`实现了特定语言相关的`opentracing-api`，应用程序调用`api`写入数据，`client`把`trace`信息按照应用程序指定的采样策略传递给`jaeger-agent`。这里用的是`Thrift`序列化协议,采用`UDP`通信。\n\n* 数据传输代理(`jaeger-agent`)\n\n`agent`作为一个代理，负责把`client`传递上来的数据，批量发送给`jaeger-collector`。如图所示这里采用的是`Uber`自己研发的`TChannal` `RPC`框架。\n\n* 数据处理中心(`jaeger-collector`)\n\n`collector`负责对`agent`发上来的数据进行校验、创建索引、分析、汇总、存储。从图示可以看到`collector`还有一个功能是控制`agent`的`采样频率`。从而降低对应用程序系统的影响。\n\n* `UI`(`jaeger-ui`)\n\n`ui`模块负责从持久化存储中读取数据，在前端页面展示出来。除此之外`jaeger-ui`还能展现系统依赖拓扑图。\n\n---\n\n## Jaeger监控系统部署\n\n`Jaeger`在部署过程中需要用到以下包几个镜像。\n\n| 组件名称                                     | 镜像地址                                     |\n| ---------------------------------------- | ---------------------------------------- |\n| **jaeger-agent**                         | [hub.docker.com/r/jaegertracing/jaeger-agent/](https://hub.docker.com/r/jaegertracing/jaeger-agent/) |\n| **jaeger-collector**                     | [hub.docker.com/r/jaegertracing/jaeger-collector/](https://hub.docker.com/r/jaegertracing/jaeger-collector/) |\n| **jaeger-query**                         | [hub.docker.com/r/jaegertracing/jaeger-query/](https://hub.docker.com/r/jaegertracing/jaeger-query/) |\n| **jaegertracing/jaeger-cassandra-schema** | [hub.docker.com/r/jaegertracing/jaeger-cassandra-schema/](https://hub.docker.com/r/jaegertracing/jaeger-cassandra-schema) |\n| **cassandra**                            | [https://hub.docker.com/r/library/cassandra/](https://hub.docker.com/r/library/cassandra/) |\n\n\n我们可以通过`docker`命令依次启动组件镜像，或者通过`docker-compose`来部署。\n\n#### 通过`docker`命令部署\n\n* 启动`cassandra`数据库\n\n> docker run --rm -it --name cassandra -v /Users/ytx/cassandra/datadir:/var/lib/cassandra -p 9042:9042 cassandra:3.11\n\n* 初始化数据库表结构\n\n> docker run --link cassandra --rm jaegertracing/jaeger-cassandra-schema\n\n* 启动`jaeger-collector`连接到数据库\n\n> docker run --rm -it \\\n  -p 14267:14267/tcp \\\n  -p 14268:14268/tcp \\\n  -p 9411:9411/tcp \\\n  -e CASSANDRA_KEYSPACE=jaeger_v1_dc1 \\\n  -e CASSANDRA_SERVERS=192.168.33.99 jaegertracing/jaeger-collector\n\n这里`14267`端口用于接受`Agent`发送上来的数据。`14268`端口用于接受`Client`直接发送上来的数据。在实际部署的时候`CASSANDRA_SERVERS`配置要做相应修改。\n\n* 启动`Agent`\n\n> docker run --rm -p5775:5775/udp -p6831:6831/udp -p6832:6832/udp -p5778:5778/tcp jaegertracing/jaeger-agent /go/bin/agent-linux --collector.host-port=192.168.33.99:14267\n\n`Agent` `5778`端口用于接受`Collector`控制，如：采样频率变更、配置变更等。`6831`和`6832`端口表示`jaeger.thrift`分别通过`compact thrift protocol`和`binary thrift protocol`协议传输。`5775`端口用于接受`zipkin.thrift`数据结构。\n\n`Client`默认通过`6832`端口发送数据。\n\n* 启动`JaegerUI`\n\n> docker run --rm -e CASSANDRA_KEYSPACE=jaeger_v1_dc1 -e CASSANDRA_SERVERS=192.168.33.99 -it -p 16686:16686/tcp jaegertracing/jaeger-query\n\n`JaegerUI`需要连接到`cassandra`数据查询数据。同时提供提供前端页面展示数据。\n\n`Jaeger`目前支持`cassandra`和`ElasticSearch`作为数据持久化系统，后续会有对`MySQL`等支持。\n\n\n#### 通过`docker-compose`命令部署\n\n```yaml\nversion: '2'\nservices:\n  cassandra:\n    image: cassandra:3.11\n    container_name: cassandra\n    environment:\n      - CASSANDRA_DC=dc1\n      - MAX_HEAP_SIZE=512M\n      - HEAP_NEWSIZE=100M\n    ports:\n      - 9042:9042\n    restart: on-failure\n    volumes:\n      - /Users/ytx/cassandra/logs:/var/log/cassandra    \n      - /Users/ytx/cassandra/data:/var/lib/cassandra\n\n  jaeger-cassandra-schema:\n    image: jaegertracing/jaeger-cassandra-schema:0.9\n    container_name: cassandra-schema\n    links:\n      - cassandra\n    environment:\n      - MODE=test\n      - DATACENTER=dc1\n\n  jaeger-collector:\n    image: jaegertracing/jaeger-collector:0.9\n    container_name: jaeger-collector\n    restart: on-failure\n    links:\n      - cassandra\n    environment:\n      - CASSANDRA_SERVERS=cassandra\n      - CASSANDRA_KEYSPACE=jaeger_v1_dc1\n      - CASSANDRA_PORT=9042\n    ports:\n      - 14267:14267/tcp\n      - 14268:14268/tcp\n      - 9411:9411/tcp\n\n  jaeger-agent:\n    image: jaegertracing/jaeger-agent:0.9\n    container_name: jaeger-agent\n    restart: on-failure\n    links:\n      - jaeger-collector\n    environment:\n      - COLLECTOR_HOST_PORT=jaeger-collector:14267\n    ports:\n      - 5775:5775/udp\n      - 6831:6831/udp\n      - 6832:6832/udp\n      - 5778:5778/tcp\n\n  jaeger-query:\n    image: jaegertracing/jaeger-query:0.9\n    container_name: jaeger-query\n    restart: on-failure\n    links:\n      - cassandra\n    environment:\n      - CASSANDRA_KEYSPACE=jaeger_v1_dc1\n      - CASSANDRA_SERVERS=cassandra\n    ports:\n      - 8003:16686/tcp\n\nnetworks:\n  default:\n    driver: bridge\n\n```\n\n---\n\n## Jaeger集成到应用程序\n\n`jaeger`团队提供了针对`Node.js`环境的工具包[jaeger-client-node](https://github.com/jaegertracing/jaeger-client-node)。如何能够跟团队项目代码更好的契合是接下来要考虑的点。针对现有的项目，在接入`Jaeger`的时候是一个渐进的过程，希望能够做尽量少的修改代码。\n\n针对`Node.js`生态下`web`服务器的路由都是采用类似`connect`风格，我们对常用的`web`框架路由做相应的包装：\n\n```javascript\n\nfunction RouterProxy(router, config) {\n  this.config = config\n  this.proxyInstance = router  \n}\n\nRouterProxy.create = function (config, tracer = null) {\n  if (!config.router) {\n    throw new Error(\"Not Setup Router\")\n  }\n\n  if (!config.proxy) {\n    throw new Error(\"Not Setup Proxy\")    \n  }\n\n  const proxyInstance = RouterCreator(config.proxy)\n  const instance = new RouterProxy(proxyInstance, config)\n  instance.wrap(config.router, tracer)\n\n  return instance\n}\n\nRouterProxy.prototype.wrap = function (router, tracer = null) {\n  if (!tracer) {\n    tracer = opentracing.globalTracer()  \n  }\n\n  constants.PROXY_NAMES.forEach(method => {\n    this.wrapRouterMethod(router, method, tracer)\n  })\n\n  return router\n}\n\nRouterProxy.prototype.wrapRouterMethod = function (router, method, tracer) {\n  if (typeof router[method] !== 'function') {\n    return\n  }\n\n  const that = this\n  const doit = router[method].bind(router)\n  router[method] = function (...args) {\n    const length = args.length\n    if (length <= 1 || typeof args[length-1] !== 'function') {\n      return doit(...args)\n    }\n    const uri = args[0]\n    const handler = that.wrapRouterMethodHandler(args[args.length - 1], uri, tracer)\n    args.splice(length -1, 1, handler)\n    return doit(...args)\n  }\n\n  return\n}\n\nRouterProxy.prototype.wrapRouterMethodHandler = function (handler, uri, tracer) {\n  const that = this\n\n  return function (...args) {\n    const req = that.proxyInstance.request(...args)\n    const res = that.proxyInstance.response(...args)\n    const url = that.proxyInstance.url(...args)\n    const method = that.proxyInstance.method(...args)\n\n    const span = extractOrCreateSpan(req, uri, tracer)\n    span.setTag(opentracing.Tags.HTTP_METHOD, method)\n    span.setTag(opentracing.Tags.HTTP_URL, url)\n    span.setTag(opentracing.Tags.SPAN_KIND, 'server')\n\n    const traceCtx = { span, tracer }\n    if (that.config.customizeTags) {\n      that.config.customizeTags(traceCtx, ...args)\n    }\n\n    args[0].traceCtx = traceCtx\n\n    function spanFinised () {\n      span.finish()\n    }\n\n    onFinished(res, spanFinised)\n\n    return handler(...args)\n  }\n}\n\n```\n\n通过以上方式在每个路由到达正式处理函数之前，[opentracing-connect](http://gitlab.yintech.net/ytx/paprika/nugget/backend/opentracing-connect)类库记录当前的`http`请求基本信息并把数据通过上下文参数暴露给用户处理函数，在处理完毕之后类库自动调用`finish`函数表示一次请求结束。需要注意的是：如果实际过程中希望记录更多的信息\b或者调用关系，需要用户参照`API`自己\b实现。\n\n---\n\n## JaegerUI基本使用\n\n假定现有如下两个服务：\n\n* Service One\n\n```javascript\n\nconst express = require('express')\nconst request = require('request-promise')\nconst { Tracer, RouterProxy } = require('opentracing-connect')\n\nconst app = new express()\n\nconst serviceName = 'One'\nTracer.createGlobalTracer(serviceName, { logger: console })\nconst Router = RouterProxy.create({ router: { type: \"express\" }}).routerProxy(express.Router())\n\nRouter.get('/one',  async (request, response, next) => {\n  const result = await requestServiceTwo(request.traceCtx.span)\n  response.json(result)\n})\n\nasync function requestServiceTwo(span) {\n  const peerServiceName = 'Two'\n  span.setTag(Tracer.opentracing.Tags.PEER_SERVICE, peerServiceName)\n  \n  let result  \n  try {\n    const carrier = {}\n    const uri = 'http://localhost:8020/two'\n    span.tracer().inject(span.context(), \n      Tracer.opentracing.FORMAT_HTTP_HEADERS, carrier)\n    result = await request({ uri, headers: carrier })\n    console.dir(result)\n    span.log({'event': 'request_end'})\n  } catch(err) {\n    span.setTag(Tracer.opentracing.Tags.ERROR, true)\n    span.log({ 'event': 'error', 'message': err.message })\n  }\n\n  return result\n}\n\napp.use(Router)\n\napp.listen(8010)\n\n```\n\n* Service Two\n\n```javascript\n\nconst Koa = require('koa')\nconst KoaRouter = require('koa-router')\nconst request = require('request-promise')\nconst { Tracer, RouterProxy } = require('opentracing-connect')\nconst Redis = require('./redis')\n\nconst app = new Koa()\n\nconst serviceName = 'Two'\nconst tracer = Tracer.createGlobalTracer(serviceName, { logger: console })\nconst Router = RouterProxy.create({ router: { type: \"koa2\" }}).routerProxy(KoaRouter())\n\nRouter.get('/two', async (ctx, next) => {\n  try {\n    const userId = 1\n    const result = await getUserInfo(userId, { span: ctx.traceCtx.span })\n    ctx.traceCtx.span.log({'event': 'request_end'})\n    ctx.body = { a: 1, b: 2, c: 3 }\n  } catch(err) {\n    ctx.traceCtx.span.setTag(Tracer.opentracing.Tags.ERROR, true)\n    ctx.traceCtx.span.logEvent('error', { message: err.message })\n  }\n\n  return \n})\n\nasync function getUserInfo(id, ctx) {\n  const span = tracer.startSpan(\"getUserInfo\", { references: [Tracer.opentracing.childOf(ctx.span.context())] })\n  \n  let result\n  try {\n    result = await Redis.getRedisUser(id, { span })\n  } catch(err) {\n    span.setTag(Tracer.opentracing.Tags.ERROR, true)\n    span.logEvent('error', { message: err.message })\n  }\n\n  span.finish()\n\n  return result\n}\n\napp.use(Router.routes())\n\napp.listen(8020)\n\n```\n\n在两个服务启动的时候，分别创建了一个`tracer`对象，写入当前服务的名称，以及一个`logger`对象用于追踪\b`jaeger-client`的行为。 `ServiceOne`提供了一个请求处理函数，该处理函数接收到请求之后向`ServiceTwo`发起请求，而`ServiceTwo`向`Redis`服务发起请求读取用户信息，并返回给客户端。\n\n\n通过`POSTMAN`向`ServiceOne`发起一个请求：\n\n![postman](http://owoeej96r.bkt.clouddn.com/o_1btt652ft10qb1c8t1csl1h0jovha)\n\n打开`Jaeger-UI`页面：\n\n![jaeger-ui](http://owoeej96r.bkt.clouddn.com/o_1btt65vo21ee34491b2mn0pa6sf)\n\n在`Jaeger-UI`页面左侧可以看到所有的服务列表，以及服务的`endpoint`列表。可以通过我们给应用程序设置的`tag`来搜索指定的`trace`。在`POSTMAN`页面可以看到响应时间为`114ms`,在`Jaeger-UI`看到此次`trace`有三个服务，包含四个`span`, `trace`的持续时间是`78ms`比`POSTMAN`检测到的时间要小，这是因为从服务器到`POSTMAN`客户端有网络延迟的缘故。\n\n点击`trace`条目：\n\n![jaeger-trace](http://owoeej96r.bkt.clouddn.com/o_1btt66ieuur4fd2m591umb1r8ok)\n\n可以看到整个调用链路：\n\n1. `ServiceOne`收到一个`GET`请求，`endpoint`为`/one`  \n2. `ServiceOne`向`ServiceTwo`发送一个请求，`endpoint`为`/two`  \n3. `Servicetwo`调用`getUserInfo`函数\n4. `getUserInfo`函数向`Redis`服务发送一个`get`请求获取用户信息, 用户id为`1`\n5. 最终`Redis`服务返回用户信息,`ServiceTwo`将用户信息返回给`ServiceOne`,`ServiceOne`把数据返回给客户端\n\n单击每个`span`条目，可以看到`tag`、`log`等信息。[opentracing](https://github.com/opentracing/specification/blob/master/semantic_conventions.md)对`span`内常使用的`tag`以及`log`字段有相应的推荐。\n\n\n## 参考文献\n\n1. [Google Dapper paper](https://static.googleusercontent.com/media/research.google.com/zh-CN//pubs/archive/36356.pdf)  \n2. [OpenTracing Best Pratices](http://opentracing.io/documentation/pages/instrumentation/)  \n3. [OpenTraing Specification](https://github.com/opentracing-contrib/opentracing-specification-zh/blob/master/specification.md)\n\n4. [OpenTracing Semantic Conventions](https://github.com/opentracing-contrib/opentracing-specification-zh/blob/master/semantic_conventions.md)\n\n5. [Jaeger, a distributed tracing system](http://jaeger.readthedocs.io/en/latest/)\n\n6. [Jaeger Client Node](https://github.com/jaegertracing/jaeger-client-node)  \n\n7. [OpenTracing API for Javascript](https://github.com/opentracing/opentracing-javascript)\n\n\n*--EOF--*","slug":"jaeger","published":1,"updated":"2018-07-01T10:30:46.495Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjsuh9cfe0078y4zvwq417nfm","content":"<h1 id=\"基于Jaeger的分布式监控系统实践\"><a href=\"#基于Jaeger的分布式监控系统实践\" class=\"headerlink\" title=\"基于Jaeger的分布式监控系统实践\"></a>基于<code>Jaeger</code>的分布式监控系统实践</h1><h2 id=\"为什么要引入监控系统\"><a href=\"#为什么要引入监控系统\" class=\"headerlink\" title=\"为什么要引入监控系统\"></a>为什么要引入监控系统</h2><p>微服务架构消除了传统<code>SOA</code>架构服务之间的耦合性，降低系统的复杂度，单个服务可以独立运行部署也提升了产品迭代速度。但是，衍生出来的问题是如何才能够有效监控每一个服务，多个服务之间互相调用如何被监控，如何更快的发现系统故障，消除系统瓶颈。随着微服务数量增多，系统并发量上升通过传统<code>log</code>来定位问题变得比较困难，这个时候分布式监控系统变得非常重要。</p>\n<hr>\n<h2 id=\"监控系统实现的理论基础\"><a href=\"#监控系统实现的理论基础\" class=\"headerlink\" title=\"监控系统实现的理论基础\"></a>监控系统实现的理论基础</h2><p>现代流行的监控系统实现的理论依据主要来源于<a href=\"https://static.googleusercontent.com/media/research.google.com/zh-CN//pubs/archive/36356.pdf\" target=\"_blank\" rel=\"noopener\">Google Dapper paper</a>。该论文中提出了<code>trace</code>、<code>span</code>、<code>annotations</code>、<code>log</code>、<code>采样</code>、<code>服务依赖分析</code>等概念。</p>\n<p><img src=\"http://owoeej96r.bkt.clouddn.com/o_1btqo9g0i1bul11p61178kk613coa\" alt=\"TraceSpan\"></p>\n<p>一个完整的客户端请求可以被称为一个<code>trace</code>, <code>span</code>是指调用过程中的一个时间区间, 也就是这个英文名的由来，一般对应一个方法或者代码块的执行。服务端收到请求后需要做相应的处理，可能是调用内部函数，也可能是通过<code>RPC</code>调用其他服务的功能。这些调用过程都可以被称为<code>span</code>。而这些<code>span</code>之间会有依赖关系，从而构成了一条完整的\b<code>trace tree</code>。为了方便应用程序开发者追踪调试问题，<code>trace</code>系统在实现的还应该提供相应的<code>API</code>方便开发者写入数据，也就是给<code>span</code>注入一些<code>annotations</code>或者<code>log</code>。<code>trace</code>系统在设计的时候必须考虑到不能影响应用系统的吞吐效率，特别是对于高并发系统需要特别注意，这个时候采样的策略变得尤其关键。在系统并发量小的时候提高采样频率、并发量上升的时候降低采样频率是一个比较好的选择。</p>\n<p>现代监控系统的实现都在该论文基础上或多或少做了一定的修改。目前云计算基金会<code>CNCF</code>下的<code>OpenTracing</code>项目是一个厂商中立语言无关的分布式<code>trace</code>标准。而本文后续介绍的<code>Jaeger</code>分布式监控系统正是基于该标准来实现。</p>\n<p><code>OpenTracing</code>标准明确了三个重要的互相关联的类型：<code>Tracer</code>、<code>Span</code>、<code>SpanContext</code>。<code>Tracer</code>主要负责：</p>\n<ul>\n<li><code>Span</code>创建</li>\n</ul>\n<p><code>Tracer</code>创建<code>Span</code>的时候需要指定一个名称,表明<code>Span</code>的含义,以及该<code>Span</code>之间的引用关系。</p>\n<ul>\n<li><code>SpanContext</code>的注入和提取</li>\n</ul>\n<p>在跨进程追踪的时候,需要利用注入接口把当前<code>trace</code>和<code>span</code>的信息传递给目标进程。而目标进程需要调用提取接口取得信息。这中间的可能是通过<code>HTTP</code>请求、或者其他<code>RPC</code>框架。<code>OpenTracing</code>不对通信协议限制，只是提出三个注入和提取的时候需要满足指定的数据格式。</p>\n<p><code>Span</code>的实现除了必须支持应用程序设置<code>tag</code>、写入调试<code>log</code>信息，还必须支持设置用户自定义数据，该数据会随着系统调用而传递。<code>OpenTracing</code>标准对<code>span</code>常用的<code>tag</code>以及<code>log</code>信息有规范推荐。应用程序代码在接入的时候，建议遵循该规范。</p>\n<p><code>SpanContext</code>存放的是<code>Span</code>上下文相关的数据, 如：当前<code>tracer id</code>, <code>span id</code>, 用户自定义数据等。</p>\n<p>关于<code>OpenTracing</code>更加详细的描述，可以参考<a href=\"http://opentracing.io/documentation/pages/spec.html\" target=\"_blank\" rel=\"noopener\">官方文档</a>。</p>\n<hr>\n<h2 id=\"Jaeger监控系统介绍\"><a href=\"#Jaeger监控系统介绍\" class=\"headerlink\" title=\"Jaeger监控系统介绍\"></a>Jaeger监控系统介绍</h2><p><code>Jaeger</code>分布式监控系统由<code>Uber</code>设计并实现，现已捐赠给<code>CNCF</code>基金会,作为分布式环境下推荐的监控系统。Jaeger系统架构如下：</p>\n<p><img src=\"http://owoeej96r.bkt.clouddn.com/o_1btr8q4mh1qb3fue1rtq8qq1r3la\" alt=\"Jaeger监控系统架构\"></p>\n<p>和其他监控系统类似，<code>Jaeger</code>主要包含一下几个模块：</p>\n<ul>\n<li>应用程序探针<code>SDK</code>(<code>jaeger-client</code>)</li>\n</ul>\n<p><code>jaeger-client</code>实现了特定语言相关的<code>opentracing-api</code>，应用程序调用<code>api</code>写入数据，<code>client</code>把<code>trace</code>信息按照应用程序指定的采样策略传递给<code>jaeger-agent</code>。这里用的是<code>Thrift</code>序列化协议,采用<code>UDP</code>通信。</p>\n<ul>\n<li>数据传输代理(<code>jaeger-agent</code>)</li>\n</ul>\n<p><code>agent</code>作为一个代理，负责把<code>client</code>传递上来的数据，批量发送给<code>jaeger-collector</code>。如图所示这里采用的是<code>Uber</code>自己研发的<code>TChannal</code> <code>RPC</code>框架。</p>\n<ul>\n<li>数据处理中心(<code>jaeger-collector</code>)</li>\n</ul>\n<p><code>collector</code>负责对<code>agent</code>发上来的数据进行校验、创建索引、分析、汇总、存储。从图示可以看到<code>collector</code>还有一个功能是控制<code>agent</code>的<code>采样频率</code>。从而降低对应用程序系统的影响。</p>\n<ul>\n<li><code>UI</code>(<code>jaeger-ui</code>)</li>\n</ul>\n<p><code>ui</code>模块负责从持久化存储中读取数据，在前端页面展示出来。除此之外<code>jaeger-ui</code>还能展现系统依赖拓扑图。</p>\n<hr>\n<h2 id=\"Jaeger监控系统部署\"><a href=\"#Jaeger监控系统部署\" class=\"headerlink\" title=\"Jaeger监控系统部署\"></a>Jaeger监控系统部署</h2><p><code>Jaeger</code>在部署过程中需要用到以下包几个镜像。</p>\n<table>\n<thead>\n<tr>\n<th>组件名称</th>\n<th>镜像地址</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>jaeger-agent</strong></td>\n<td><a href=\"https://hub.docker.com/r/jaegertracing/jaeger-agent/\" target=\"_blank\" rel=\"noopener\">hub.docker.com/r/jaegertracing/jaeger-agent/</a></td>\n</tr>\n<tr>\n<td><strong>jaeger-collector</strong></td>\n<td><a href=\"https://hub.docker.com/r/jaegertracing/jaeger-collector/\" target=\"_blank\" rel=\"noopener\">hub.docker.com/r/jaegertracing/jaeger-collector/</a></td>\n</tr>\n<tr>\n<td><strong>jaeger-query</strong></td>\n<td><a href=\"https://hub.docker.com/r/jaegertracing/jaeger-query/\" target=\"_blank\" rel=\"noopener\">hub.docker.com/r/jaegertracing/jaeger-query/</a></td>\n</tr>\n<tr>\n<td><strong>jaegertracing/jaeger-cassandra-schema</strong></td>\n<td><a href=\"https://hub.docker.com/r/jaegertracing/jaeger-cassandra-schema\" target=\"_blank\" rel=\"noopener\">hub.docker.com/r/jaegertracing/jaeger-cassandra-schema/</a></td>\n</tr>\n<tr>\n<td><strong>cassandra</strong></td>\n<td><a href=\"https://hub.docker.com/r/library/cassandra/\" target=\"_blank\" rel=\"noopener\">https://hub.docker.com/r/library/cassandra/</a></td>\n</tr>\n</tbody>\n</table>\n<p>我们可以通过<code>docker</code>命令依次启动组件镜像，或者通过<code>docker-compose</code>来部署。</p>\n<h4 id=\"通过docker命令部署\"><a href=\"#通过docker命令部署\" class=\"headerlink\" title=\"通过docker命令部署\"></a>通过<code>docker</code>命令部署</h4><ul>\n<li>启动<code>cassandra</code>数据库</li>\n</ul>\n<blockquote>\n<p>docker run –rm -it –name cassandra -v /Users/ytx/cassandra/datadir:/var/lib/cassandra -p 9042:9042 cassandra:3.11</p>\n</blockquote>\n<ul>\n<li>初始化数据库表结构</li>\n</ul>\n<blockquote>\n<p>docker run –link cassandra –rm jaegertracing/jaeger-cassandra-schema</p>\n</blockquote>\n<ul>\n<li>启动<code>jaeger-collector</code>连接到数据库</li>\n</ul>\n<blockquote>\n<p>docker run –rm -it \\<br>  -p 14267:14267/tcp \\<br>  -p 14268:14268/tcp \\<br>  -p 9411:9411/tcp \\<br>  -e CASSANDRA_KEYSPACE=jaeger_v1_dc1 \\<br>  -e CASSANDRA_SERVERS=192.168.33.99 jaegertracing/jaeger-collector</p>\n</blockquote>\n<p>这里<code>14267</code>端口用于接受<code>Agent</code>发送上来的数据。<code>14268</code>端口用于接受<code>Client</code>直接发送上来的数据。在实际部署的时候<code>CASSANDRA_SERVERS</code>配置要做相应修改。</p>\n<ul>\n<li>启动<code>Agent</code></li>\n</ul>\n<blockquote>\n<p>docker run –rm -p5775:5775/udp -p6831:6831/udp -p6832:6832/udp -p5778:5778/tcp jaegertracing/jaeger-agent /go/bin/agent-linux –collector.host-port=192.168.33.99:14267</p>\n</blockquote>\n<p><code>Agent</code> <code>5778</code>端口用于接受<code>Collector</code>控制，如：采样频率变更、配置变更等。<code>6831</code>和<code>6832</code>端口表示<code>jaeger.thrift</code>分别通过<code>compact thrift protocol</code>和<code>binary thrift protocol</code>协议传输。<code>5775</code>端口用于接受<code>zipkin.thrift</code>数据结构。</p>\n<p><code>Client</code>默认通过<code>6832</code>端口发送数据。</p>\n<ul>\n<li>启动<code>JaegerUI</code></li>\n</ul>\n<blockquote>\n<p>docker run –rm -e CASSANDRA_KEYSPACE=jaeger_v1_dc1 -e CASSANDRA_SERVERS=192.168.33.99 -it -p 16686:16686/tcp jaegertracing/jaeger-query</p>\n</blockquote>\n<p><code>JaegerUI</code>需要连接到<code>cassandra</code>数据查询数据。同时提供提供前端页面展示数据。</p>\n<p><code>Jaeger</code>目前支持<code>cassandra</code>和<code>ElasticSearch</code>作为数据持久化系统，后续会有对<code>MySQL</code>等支持。</p>\n<h4 id=\"通过docker-compose命令部署\"><a href=\"#通过docker-compose命令部署\" class=\"headerlink\" title=\"通过docker-compose命令部署\"></a>通过<code>docker-compose</code>命令部署</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">'2'</span></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\"><span class=\"attr\">  cassandra:</span></span><br><span class=\"line\"><span class=\"attr\">    image:</span> <span class=\"attr\">cassandra:3.11</span></span><br><span class=\"line\"><span class=\"attr\">    container_name:</span> <span class=\"string\">cassandra</span></span><br><span class=\"line\"><span class=\"attr\">    environment:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">CASSANDRA_DC=dc1</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">MAX_HEAP_SIZE=512M</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">HEAP_NEWSIZE=100M</span></span><br><span class=\"line\"><span class=\"attr\">    ports:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"number\">9042</span><span class=\"string\">:9042</span></span><br><span class=\"line\"><span class=\"attr\">    restart:</span> <span class=\"string\">on-failure</span></span><br><span class=\"line\"><span class=\"attr\">    volumes:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">/Users/ytx/cassandra/logs:/var/log/cassandra</span>    </span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">/Users/ytx/cassandra/data:/var/lib/cassandra</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  jaeger-cassandra-schema:</span></span><br><span class=\"line\"><span class=\"attr\">    image:</span> <span class=\"string\">jaegertracing/jaeger-cassandra-schema:0.9</span></span><br><span class=\"line\"><span class=\"attr\">    container_name:</span> <span class=\"string\">cassandra-schema</span></span><br><span class=\"line\"><span class=\"attr\">    links:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">cassandra</span></span><br><span class=\"line\"><span class=\"attr\">    environment:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">MODE=test</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">DATACENTER=dc1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  jaeger-collector:</span></span><br><span class=\"line\"><span class=\"attr\">    image:</span> <span class=\"string\">jaegertracing/jaeger-collector:0.9</span></span><br><span class=\"line\"><span class=\"attr\">    container_name:</span> <span class=\"string\">jaeger-collector</span></span><br><span class=\"line\"><span class=\"attr\">    restart:</span> <span class=\"string\">on-failure</span></span><br><span class=\"line\"><span class=\"attr\">    links:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">cassandra</span></span><br><span class=\"line\"><span class=\"attr\">    environment:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">CASSANDRA_SERVERS=cassandra</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">CASSANDRA_KEYSPACE=jaeger_v1_dc1</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">CASSANDRA_PORT=9042</span></span><br><span class=\"line\"><span class=\"attr\">    ports:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"number\">14267</span><span class=\"string\">:14267/tcp</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"number\">14268</span><span class=\"string\">:14268/tcp</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"number\">9411</span><span class=\"string\">:9411/tcp</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  jaeger-agent:</span></span><br><span class=\"line\"><span class=\"attr\">    image:</span> <span class=\"string\">jaegertracing/jaeger-agent:0.9</span></span><br><span class=\"line\"><span class=\"attr\">    container_name:</span> <span class=\"string\">jaeger-agent</span></span><br><span class=\"line\"><span class=\"attr\">    restart:</span> <span class=\"string\">on-failure</span></span><br><span class=\"line\"><span class=\"attr\">    links:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">jaeger-collector</span></span><br><span class=\"line\"><span class=\"attr\">    environment:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">COLLECTOR_HOST_PORT=jaeger-collector:14267</span></span><br><span class=\"line\"><span class=\"attr\">    ports:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"number\">5775</span><span class=\"string\">:5775/udp</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"number\">6831</span><span class=\"string\">:6831/udp</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"number\">6832</span><span class=\"string\">:6832/udp</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"number\">5778</span><span class=\"string\">:5778/tcp</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  jaeger-query:</span></span><br><span class=\"line\"><span class=\"attr\">    image:</span> <span class=\"string\">jaegertracing/jaeger-query:0.9</span></span><br><span class=\"line\"><span class=\"attr\">    container_name:</span> <span class=\"string\">jaeger-query</span></span><br><span class=\"line\"><span class=\"attr\">    restart:</span> <span class=\"string\">on-failure</span></span><br><span class=\"line\"><span class=\"attr\">    links:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">cassandra</span></span><br><span class=\"line\"><span class=\"attr\">    environment:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">CASSANDRA_KEYSPACE=jaeger_v1_dc1</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">CASSANDRA_SERVERS=cassandra</span></span><br><span class=\"line\"><span class=\"attr\">    ports:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"number\">8003</span><span class=\"string\">:16686/tcp</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">networks:</span></span><br><span class=\"line\"><span class=\"attr\">  default:</span></span><br><span class=\"line\"><span class=\"attr\">    driver:</span> <span class=\"string\">bridge</span></span><br></pre></td></tr></table></figure>\n<hr>\n<h2 id=\"Jaeger集成到应用程序\"><a href=\"#Jaeger集成到应用程序\" class=\"headerlink\" title=\"Jaeger集成到应用程序\"></a>Jaeger集成到应用程序</h2><p><code>jaeger</code>团队提供了针对<code>Node.js</code>环境的工具包<a href=\"https://github.com/jaegertracing/jaeger-client-node\" target=\"_blank\" rel=\"noopener\">jaeger-client-node</a>。如何能够跟团队项目代码更好的契合是接下来要考虑的点。针对现有的项目，在接入<code>Jaeger</code>的时候是一个渐进的过程，希望能够做尽量少的修改代码。</p>\n<p>针对<code>Node.js</code>生态下<code>web</code>服务器的路由都是采用类似<code>connect</code>风格，我们对常用的<code>web</code>框架路由做相应的包装：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">RouterProxy</span>(<span class=\"params\">router, config</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.config = config</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.proxyInstance = router  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">RouterProxy.create = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">config, tracer = null</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!config.router) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Error</span>(<span class=\"string\">\"Not Setup Router\"</span>)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!config.proxy) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Error</span>(<span class=\"string\">\"Not Setup Proxy\"</span>)    </span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> proxyInstance = RouterCreator(config.proxy)</span><br><span class=\"line\">  <span class=\"keyword\">const</span> instance = <span class=\"keyword\">new</span> RouterProxy(proxyInstance, config)</span><br><span class=\"line\">  instance.wrap(config.router, tracer)</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> instance</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">RouterProxy.prototype.wrap = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">router, tracer = null</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!tracer) &#123;</span><br><span class=\"line\">    tracer = opentracing.globalTracer()  </span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  constants.PROXY_NAMES.forEach(<span class=\"function\"><span class=\"params\">method</span> =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.wrapRouterMethod(router, method, tracer)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> router</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">RouterProxy.prototype.wrapRouterMethod = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">router, method, tracer</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> router[method] !== <span class=\"string\">'function'</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> that = <span class=\"keyword\">this</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> doit = router[method].bind(router)</span><br><span class=\"line\">  router[method] = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">...args</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> length = args.length</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (length &lt;= <span class=\"number\">1</span> || <span class=\"keyword\">typeof</span> args[length<span class=\"number\">-1</span>] !== <span class=\"string\">'function'</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> doit(...args)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> uri = args[<span class=\"number\">0</span>]</span><br><span class=\"line\">    <span class=\"keyword\">const</span> handler = that.wrapRouterMethodHandler(args[args.length - <span class=\"number\">1</span>], uri, tracer)</span><br><span class=\"line\">    args.splice(length <span class=\"number\">-1</span>, <span class=\"number\">1</span>, handler)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> doit(...args)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">RouterProxy.prototype.wrapRouterMethodHandler = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">handler, uri, tracer</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> that = <span class=\"keyword\">this</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">...args</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> req = that.proxyInstance.request(...args)</span><br><span class=\"line\">    <span class=\"keyword\">const</span> res = that.proxyInstance.response(...args)</span><br><span class=\"line\">    <span class=\"keyword\">const</span> url = that.proxyInstance.url(...args)</span><br><span class=\"line\">    <span class=\"keyword\">const</span> method = that.proxyInstance.method(...args)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">const</span> span = extractOrCreateSpan(req, uri, tracer)</span><br><span class=\"line\">    span.setTag(opentracing.Tags.HTTP_METHOD, method)</span><br><span class=\"line\">    span.setTag(opentracing.Tags.HTTP_URL, url)</span><br><span class=\"line\">    span.setTag(opentracing.Tags.SPAN_KIND, <span class=\"string\">'server'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">const</span> traceCtx = &#123; span, tracer &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (that.config.customizeTags) &#123;</span><br><span class=\"line\">      that.config.customizeTags(traceCtx, ...args)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    args[<span class=\"number\">0</span>].traceCtx = traceCtx</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">spanFinised</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">      span.finish()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    onFinished(res, spanFinised)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> handler(...args)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>通过以上方式在每个路由到达正式处理函数之前，<a href=\"http://gitlab.yintech.net/ytx/paprika/nugget/backend/opentracing-connect\" target=\"_blank\" rel=\"noopener\">opentracing-connect</a>类库记录当前的<code>http</code>请求基本信息并把数据通过上下文参数暴露给用户处理函数，在处理完毕之后类库自动调用<code>finish</code>函数表示一次请求结束。需要注意的是：如果实际过程中希望记录更多的信息\b或者调用关系，需要用户参照<code>API</code>自己\b实现。</p>\n<hr>\n<h2 id=\"JaegerUI基本使用\"><a href=\"#JaegerUI基本使用\" class=\"headerlink\" title=\"JaegerUI基本使用\"></a>JaegerUI基本使用</h2><p>假定现有如下两个服务：</p>\n<ul>\n<li>Service One</li>\n</ul>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> express = <span class=\"built_in\">require</span>(<span class=\"string\">'express'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> request = <span class=\"built_in\">require</span>(<span class=\"string\">'request-promise'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> &#123; Tracer, RouterProxy &#125; = <span class=\"built_in\">require</span>(<span class=\"string\">'opentracing-connect'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> app = <span class=\"keyword\">new</span> express()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> serviceName = <span class=\"string\">'One'</span></span><br><span class=\"line\">Tracer.createGlobalTracer(serviceName, &#123; <span class=\"attr\">logger</span>: <span class=\"built_in\">console</span> &#125;)</span><br><span class=\"line\"><span class=\"keyword\">const</span> Router = RouterProxy.create(&#123; <span class=\"attr\">router</span>: &#123; <span class=\"attr\">type</span>: <span class=\"string\">\"express\"</span> &#125;&#125;).routerProxy(express.Router())</span><br><span class=\"line\"></span><br><span class=\"line\">Router.get(<span class=\"string\">'/one'</span>,  <span class=\"keyword\">async</span> (request, response, next) =&gt; &#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> result = <span class=\"keyword\">await</span> requestServiceTwo(request.traceCtx.span)</span><br><span class=\"line\">  response.json(result)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">async</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">requestServiceTwo</span>(<span class=\"params\">span</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> peerServiceName = <span class=\"string\">'Two'</span></span><br><span class=\"line\">  span.setTag(Tracer.opentracing.Tags.PEER_SERVICE, peerServiceName)</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"keyword\">let</span> result  </span><br><span class=\"line\">  <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> carrier = &#123;&#125;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> uri = <span class=\"string\">'http://localhost:8020/two'</span></span><br><span class=\"line\">    span.tracer().inject(span.context(), </span><br><span class=\"line\">      Tracer.opentracing.FORMAT_HTTP_HEADERS, carrier)</span><br><span class=\"line\">    result = <span class=\"keyword\">await</span> request(&#123; uri, <span class=\"attr\">headers</span>: carrier &#125;)</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.dir(result)</span><br><span class=\"line\">    span.log(&#123;<span class=\"string\">'event'</span>: <span class=\"string\">'request_end'</span>&#125;)</span><br><span class=\"line\">  &#125; <span class=\"keyword\">catch</span>(err) &#123;</span><br><span class=\"line\">    span.setTag(Tracer.opentracing.Tags.ERROR, <span class=\"literal\">true</span>)</span><br><span class=\"line\">    span.log(&#123; <span class=\"string\">'event'</span>: <span class=\"string\">'error'</span>, <span class=\"string\">'message'</span>: err.message &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> result</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">app.use(Router)</span><br><span class=\"line\"></span><br><span class=\"line\">app.listen(<span class=\"number\">8010</span>)</span><br></pre></td></tr></table></figure>\n<ul>\n<li>Service Two</li>\n</ul>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> Koa = <span class=\"built_in\">require</span>(<span class=\"string\">'koa'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> KoaRouter = <span class=\"built_in\">require</span>(<span class=\"string\">'koa-router'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> request = <span class=\"built_in\">require</span>(<span class=\"string\">'request-promise'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> &#123; Tracer, RouterProxy &#125; = <span class=\"built_in\">require</span>(<span class=\"string\">'opentracing-connect'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> Redis = <span class=\"built_in\">require</span>(<span class=\"string\">'./redis'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> app = <span class=\"keyword\">new</span> Koa()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> serviceName = <span class=\"string\">'Two'</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> tracer = Tracer.createGlobalTracer(serviceName, &#123; <span class=\"attr\">logger</span>: <span class=\"built_in\">console</span> &#125;)</span><br><span class=\"line\"><span class=\"keyword\">const</span> Router = RouterProxy.create(&#123; <span class=\"attr\">router</span>: &#123; <span class=\"attr\">type</span>: <span class=\"string\">\"koa2\"</span> &#125;&#125;).routerProxy(KoaRouter())</span><br><span class=\"line\"></span><br><span class=\"line\">Router.get(<span class=\"string\">'/two'</span>, <span class=\"keyword\">async</span> (ctx, next) =&gt; &#123;</span><br><span class=\"line\">  <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> userId = <span class=\"number\">1</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> result = <span class=\"keyword\">await</span> getUserInfo(userId, &#123; <span class=\"attr\">span</span>: ctx.traceCtx.span &#125;)</span><br><span class=\"line\">    ctx.traceCtx.span.log(&#123;<span class=\"string\">'event'</span>: <span class=\"string\">'request_end'</span>&#125;)</span><br><span class=\"line\">    ctx.body = &#123; <span class=\"attr\">a</span>: <span class=\"number\">1</span>, <span class=\"attr\">b</span>: <span class=\"number\">2</span>, <span class=\"attr\">c</span>: <span class=\"number\">3</span> &#125;</span><br><span class=\"line\">  &#125; <span class=\"keyword\">catch</span>(err) &#123;</span><br><span class=\"line\">    ctx.traceCtx.span.setTag(Tracer.opentracing.Tags.ERROR, <span class=\"literal\">true</span>)</span><br><span class=\"line\">    ctx.traceCtx.span.logEvent(<span class=\"string\">'error'</span>, &#123; <span class=\"attr\">message</span>: err.message &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> </span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">async</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getUserInfo</span>(<span class=\"params\">id, ctx</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> span = tracer.startSpan(<span class=\"string\">\"getUserInfo\"</span>, &#123; <span class=\"attr\">references</span>: [Tracer.opentracing.childOf(ctx.span.context())] &#125;)</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"keyword\">let</span> result</span><br><span class=\"line\">  <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">    result = <span class=\"keyword\">await</span> Redis.getRedisUser(id, &#123; span &#125;)</span><br><span class=\"line\">  &#125; <span class=\"keyword\">catch</span>(err) &#123;</span><br><span class=\"line\">    span.setTag(Tracer.opentracing.Tags.ERROR, <span class=\"literal\">true</span>)</span><br><span class=\"line\">    span.logEvent(<span class=\"string\">'error'</span>, &#123; <span class=\"attr\">message</span>: err.message &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  span.finish()</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> result</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">app.use(Router.routes())</span><br><span class=\"line\"></span><br><span class=\"line\">app.listen(<span class=\"number\">8020</span>)</span><br></pre></td></tr></table></figure>\n<p>在两个服务启动的时候，分别创建了一个<code>tracer</code>对象，写入当前服务的名称，以及一个<code>logger</code>对象用于追踪\b<code>jaeger-client</code>的行为。 <code>ServiceOne</code>提供了一个请求处理函数，该处理函数接收到请求之后向<code>ServiceTwo</code>发起请求，而<code>ServiceTwo</code>向<code>Redis</code>服务发起请求读取用户信息，并返回给客户端。</p>\n<p>通过<code>POSTMAN</code>向<code>ServiceOne</code>发起一个请求：</p>\n<p><img src=\"http://owoeej96r.bkt.clouddn.com/o_1btt652ft10qb1c8t1csl1h0jovha\" alt=\"postman\"></p>\n<p>打开<code>Jaeger-UI</code>页面：</p>\n<p><img src=\"http://owoeej96r.bkt.clouddn.com/o_1btt65vo21ee34491b2mn0pa6sf\" alt=\"jaeger-ui\"></p>\n<p>在<code>Jaeger-UI</code>页面左侧可以看到所有的服务列表，以及服务的<code>endpoint</code>列表。可以通过我们给应用程序设置的<code>tag</code>来搜索指定的<code>trace</code>。在<code>POSTMAN</code>页面可以看到响应时间为<code>114ms</code>,在<code>Jaeger-UI</code>看到此次<code>trace</code>有三个服务，包含四个<code>span</code>, <code>trace</code>的持续时间是<code>78ms</code>比<code>POSTMAN</code>检测到的时间要小，这是因为从服务器到<code>POSTMAN</code>客户端有网络延迟的缘故。</p>\n<p>点击<code>trace</code>条目：</p>\n<p><img src=\"http://owoeej96r.bkt.clouddn.com/o_1btt66ieuur4fd2m591umb1r8ok\" alt=\"jaeger-trace\"></p>\n<p>可以看到整个调用链路：</p>\n<ol>\n<li><code>ServiceOne</code>收到一个<code>GET</code>请求，<code>endpoint</code>为<code>/one</code>  </li>\n<li><code>ServiceOne</code>向<code>ServiceTwo</code>发送一个请求，<code>endpoint</code>为<code>/two</code>  </li>\n<li><code>Servicetwo</code>调用<code>getUserInfo</code>函数</li>\n<li><code>getUserInfo</code>函数向<code>Redis</code>服务发送一个<code>get</code>请求获取用户信息, 用户id为<code>1</code></li>\n<li>最终<code>Redis</code>服务返回用户信息,<code>ServiceTwo</code>将用户信息返回给<code>ServiceOne</code>,<code>ServiceOne</code>把数据返回给客户端</li>\n</ol>\n<p>单击每个<code>span</code>条目，可以看到<code>tag</code>、<code>log</code>等信息。<a href=\"https://github.com/opentracing/specification/blob/master/semantic_conventions.md\" target=\"_blank\" rel=\"noopener\">opentracing</a>对<code>span</code>内常使用的<code>tag</code>以及<code>log</code>字段有相应的推荐。</p>\n<h2 id=\"参考文献\"><a href=\"#参考文献\" class=\"headerlink\" title=\"参考文献\"></a>参考文献</h2><ol>\n<li><a href=\"https://static.googleusercontent.com/media/research.google.com/zh-CN//pubs/archive/36356.pdf\" target=\"_blank\" rel=\"noopener\">Google Dapper paper</a>  </li>\n<li><a href=\"http://opentracing.io/documentation/pages/instrumentation/\" target=\"_blank\" rel=\"noopener\">OpenTracing Best Pratices</a>  </li>\n<li><p><a href=\"https://github.com/opentracing-contrib/opentracing-specification-zh/blob/master/specification.md\" target=\"_blank\" rel=\"noopener\">OpenTraing Specification</a></p>\n</li>\n<li><p><a href=\"https://github.com/opentracing-contrib/opentracing-specification-zh/blob/master/semantic_conventions.md\" target=\"_blank\" rel=\"noopener\">OpenTracing Semantic Conventions</a></p>\n</li>\n<li><p><a href=\"http://jaeger.readthedocs.io/en/latest/\" target=\"_blank\" rel=\"noopener\">Jaeger, a distributed tracing system</a></p>\n</li>\n<li><p><a href=\"https://github.com/jaegertracing/jaeger-client-node\" target=\"_blank\" rel=\"noopener\">Jaeger Client Node</a>  </p>\n</li>\n<li><p><a href=\"https://github.com/opentracing/opentracing-javascript\" target=\"_blank\" rel=\"noopener\">OpenTracing API for Javascript</a></p>\n</li>\n</ol>\n<p><em>–EOF–</em></p>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"基于Jaeger的分布式监控系统实践\"><a href=\"#基于Jaeger的分布式监控系统实践\" class=\"headerlink\" title=\"基于Jaeger的分布式监控系统实践\"></a>基于<code>Jaeger</code>的分布式监控系统实践</h1><h2 id=\"为什么要引入监控系统\"><a href=\"#为什么要引入监控系统\" class=\"headerlink\" title=\"为什么要引入监控系统\"></a>为什么要引入监控系统</h2><p>微服务架构消除了传统<code>SOA</code>架构服务之间的耦合性，降低系统的复杂度，单个服务可以独立运行部署也提升了产品迭代速度。但是，衍生出来的问题是如何才能够有效监控每一个服务，多个服务之间互相调用如何被监控，如何更快的发现系统故障，消除系统瓶颈。随着微服务数量增多，系统并发量上升通过传统<code>log</code>来定位问题变得比较困难，这个时候分布式监控系统变得非常重要。</p>\n<hr>\n<h2 id=\"监控系统实现的理论基础\"><a href=\"#监控系统实现的理论基础\" class=\"headerlink\" title=\"监控系统实现的理论基础\"></a>监控系统实现的理论基础</h2><p>现代流行的监控系统实现的理论依据主要来源于<a href=\"https://static.googleusercontent.com/media/research.google.com/zh-CN//pubs/archive/36356.pdf\" target=\"_blank\" rel=\"noopener\">Google Dapper paper</a>。该论文中提出了<code>trace</code>、<code>span</code>、<code>annotations</code>、<code>log</code>、<code>采样</code>、<code>服务依赖分析</code>等概念。</p>\n<p><img src=\"http://owoeej96r.bkt.clouddn.com/o_1btqo9g0i1bul11p61178kk613coa\" alt=\"TraceSpan\"></p>\n<p>一个完整的客户端请求可以被称为一个<code>trace</code>, <code>span</code>是指调用过程中的一个时间区间, 也就是这个英文名的由来，一般对应一个方法或者代码块的执行。服务端收到请求后需要做相应的处理，可能是调用内部函数，也可能是通过<code>RPC</code>调用其他服务的功能。这些调用过程都可以被称为<code>span</code>。而这些<code>span</code>之间会有依赖关系，从而构成了一条完整的\b<code>trace tree</code>。为了方便应用程序开发者追踪调试问题，<code>trace</code>系统在实现的还应该提供相应的<code>API</code>方便开发者写入数据，也就是给<code>span</code>注入一些<code>annotations</code>或者<code>log</code>。<code>trace</code>系统在设计的时候必须考虑到不能影响应用系统的吞吐效率，特别是对于高并发系统需要特别注意，这个时候采样的策略变得尤其关键。在系统并发量小的时候提高采样频率、并发量上升的时候降低采样频率是一个比较好的选择。</p>\n<p>现代监控系统的实现都在该论文基础上或多或少做了一定的修改。目前云计算基金会<code>CNCF</code>下的<code>OpenTracing</code>项目是一个厂商中立语言无关的分布式<code>trace</code>标准。而本文后续介绍的<code>Jaeger</code>分布式监控系统正是基于该标准来实现。</p>\n<p><code>OpenTracing</code>标准明确了三个重要的互相关联的类型：<code>Tracer</code>、<code>Span</code>、<code>SpanContext</code>。<code>Tracer</code>主要负责：</p>\n<ul>\n<li><code>Span</code>创建</li>\n</ul>\n<p><code>Tracer</code>创建<code>Span</code>的时候需要指定一个名称,表明<code>Span</code>的含义,以及该<code>Span</code>之间的引用关系。</p>\n<ul>\n<li><code>SpanContext</code>的注入和提取</li>\n</ul>\n<p>在跨进程追踪的时候,需要利用注入接口把当前<code>trace</code>和<code>span</code>的信息传递给目标进程。而目标进程需要调用提取接口取得信息。这中间的可能是通过<code>HTTP</code>请求、或者其他<code>RPC</code>框架。<code>OpenTracing</code>不对通信协议限制，只是提出三个注入和提取的时候需要满足指定的数据格式。</p>\n<p><code>Span</code>的实现除了必须支持应用程序设置<code>tag</code>、写入调试<code>log</code>信息，还必须支持设置用户自定义数据，该数据会随着系统调用而传递。<code>OpenTracing</code>标准对<code>span</code>常用的<code>tag</code>以及<code>log</code>信息有规范推荐。应用程序代码在接入的时候，建议遵循该规范。</p>\n<p><code>SpanContext</code>存放的是<code>Span</code>上下文相关的数据, 如：当前<code>tracer id</code>, <code>span id</code>, 用户自定义数据等。</p>\n<p>关于<code>OpenTracing</code>更加详细的描述，可以参考<a href=\"http://opentracing.io/documentation/pages/spec.html\" target=\"_blank\" rel=\"noopener\">官方文档</a>。</p>\n<hr>\n<h2 id=\"Jaeger监控系统介绍\"><a href=\"#Jaeger监控系统介绍\" class=\"headerlink\" title=\"Jaeger监控系统介绍\"></a>Jaeger监控系统介绍</h2><p><code>Jaeger</code>分布式监控系统由<code>Uber</code>设计并实现，现已捐赠给<code>CNCF</code>基金会,作为分布式环境下推荐的监控系统。Jaeger系统架构如下：</p>\n<p><img src=\"http://owoeej96r.bkt.clouddn.com/o_1btr8q4mh1qb3fue1rtq8qq1r3la\" alt=\"Jaeger监控系统架构\"></p>\n<p>和其他监控系统类似，<code>Jaeger</code>主要包含一下几个模块：</p>\n<ul>\n<li>应用程序探针<code>SDK</code>(<code>jaeger-client</code>)</li>\n</ul>\n<p><code>jaeger-client</code>实现了特定语言相关的<code>opentracing-api</code>，应用程序调用<code>api</code>写入数据，<code>client</code>把<code>trace</code>信息按照应用程序指定的采样策略传递给<code>jaeger-agent</code>。这里用的是<code>Thrift</code>序列化协议,采用<code>UDP</code>通信。</p>\n<ul>\n<li>数据传输代理(<code>jaeger-agent</code>)</li>\n</ul>\n<p><code>agent</code>作为一个代理，负责把<code>client</code>传递上来的数据，批量发送给<code>jaeger-collector</code>。如图所示这里采用的是<code>Uber</code>自己研发的<code>TChannal</code> <code>RPC</code>框架。</p>\n<ul>\n<li>数据处理中心(<code>jaeger-collector</code>)</li>\n</ul>\n<p><code>collector</code>负责对<code>agent</code>发上来的数据进行校验、创建索引、分析、汇总、存储。从图示可以看到<code>collector</code>还有一个功能是控制<code>agent</code>的<code>采样频率</code>。从而降低对应用程序系统的影响。</p>\n<ul>\n<li><code>UI</code>(<code>jaeger-ui</code>)</li>\n</ul>\n<p><code>ui</code>模块负责从持久化存储中读取数据，在前端页面展示出来。除此之外<code>jaeger-ui</code>还能展现系统依赖拓扑图。</p>\n<hr>\n<h2 id=\"Jaeger监控系统部署\"><a href=\"#Jaeger监控系统部署\" class=\"headerlink\" title=\"Jaeger监控系统部署\"></a>Jaeger监控系统部署</h2><p><code>Jaeger</code>在部署过程中需要用到以下包几个镜像。</p>\n<table>\n<thead>\n<tr>\n<th>组件名称</th>\n<th>镜像地址</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>jaeger-agent</strong></td>\n<td><a href=\"https://hub.docker.com/r/jaegertracing/jaeger-agent/\" target=\"_blank\" rel=\"noopener\">hub.docker.com/r/jaegertracing/jaeger-agent/</a></td>\n</tr>\n<tr>\n<td><strong>jaeger-collector</strong></td>\n<td><a href=\"https://hub.docker.com/r/jaegertracing/jaeger-collector/\" target=\"_blank\" rel=\"noopener\">hub.docker.com/r/jaegertracing/jaeger-collector/</a></td>\n</tr>\n<tr>\n<td><strong>jaeger-query</strong></td>\n<td><a href=\"https://hub.docker.com/r/jaegertracing/jaeger-query/\" target=\"_blank\" rel=\"noopener\">hub.docker.com/r/jaegertracing/jaeger-query/</a></td>\n</tr>\n<tr>\n<td><strong>jaegertracing/jaeger-cassandra-schema</strong></td>\n<td><a href=\"https://hub.docker.com/r/jaegertracing/jaeger-cassandra-schema\" target=\"_blank\" rel=\"noopener\">hub.docker.com/r/jaegertracing/jaeger-cassandra-schema/</a></td>\n</tr>\n<tr>\n<td><strong>cassandra</strong></td>\n<td><a href=\"https://hub.docker.com/r/library/cassandra/\" target=\"_blank\" rel=\"noopener\">https://hub.docker.com/r/library/cassandra/</a></td>\n</tr>\n</tbody>\n</table>\n<p>我们可以通过<code>docker</code>命令依次启动组件镜像，或者通过<code>docker-compose</code>来部署。</p>\n<h4 id=\"通过docker命令部署\"><a href=\"#通过docker命令部署\" class=\"headerlink\" title=\"通过docker命令部署\"></a>通过<code>docker</code>命令部署</h4><ul>\n<li>启动<code>cassandra</code>数据库</li>\n</ul>\n<blockquote>\n<p>docker run –rm -it –name cassandra -v /Users/ytx/cassandra/datadir:/var/lib/cassandra -p 9042:9042 cassandra:3.11</p>\n</blockquote>\n<ul>\n<li>初始化数据库表结构</li>\n</ul>\n<blockquote>\n<p>docker run –link cassandra –rm jaegertracing/jaeger-cassandra-schema</p>\n</blockquote>\n<ul>\n<li>启动<code>jaeger-collector</code>连接到数据库</li>\n</ul>\n<blockquote>\n<p>docker run –rm -it \\<br>  -p 14267:14267/tcp \\<br>  -p 14268:14268/tcp \\<br>  -p 9411:9411/tcp \\<br>  -e CASSANDRA_KEYSPACE=jaeger_v1_dc1 \\<br>  -e CASSANDRA_SERVERS=192.168.33.99 jaegertracing/jaeger-collector</p>\n</blockquote>\n<p>这里<code>14267</code>端口用于接受<code>Agent</code>发送上来的数据。<code>14268</code>端口用于接受<code>Client</code>直接发送上来的数据。在实际部署的时候<code>CASSANDRA_SERVERS</code>配置要做相应修改。</p>\n<ul>\n<li>启动<code>Agent</code></li>\n</ul>\n<blockquote>\n<p>docker run –rm -p5775:5775/udp -p6831:6831/udp -p6832:6832/udp -p5778:5778/tcp jaegertracing/jaeger-agent /go/bin/agent-linux –collector.host-port=192.168.33.99:14267</p>\n</blockquote>\n<p><code>Agent</code> <code>5778</code>端口用于接受<code>Collector</code>控制，如：采样频率变更、配置变更等。<code>6831</code>和<code>6832</code>端口表示<code>jaeger.thrift</code>分别通过<code>compact thrift protocol</code>和<code>binary thrift protocol</code>协议传输。<code>5775</code>端口用于接受<code>zipkin.thrift</code>数据结构。</p>\n<p><code>Client</code>默认通过<code>6832</code>端口发送数据。</p>\n<ul>\n<li>启动<code>JaegerUI</code></li>\n</ul>\n<blockquote>\n<p>docker run –rm -e CASSANDRA_KEYSPACE=jaeger_v1_dc1 -e CASSANDRA_SERVERS=192.168.33.99 -it -p 16686:16686/tcp jaegertracing/jaeger-query</p>\n</blockquote>\n<p><code>JaegerUI</code>需要连接到<code>cassandra</code>数据查询数据。同时提供提供前端页面展示数据。</p>\n<p><code>Jaeger</code>目前支持<code>cassandra</code>和<code>ElasticSearch</code>作为数据持久化系统，后续会有对<code>MySQL</code>等支持。</p>\n<h4 id=\"通过docker-compose命令部署\"><a href=\"#通过docker-compose命令部署\" class=\"headerlink\" title=\"通过docker-compose命令部署\"></a>通过<code>docker-compose</code>命令部署</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">'2'</span></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\"><span class=\"attr\">  cassandra:</span></span><br><span class=\"line\"><span class=\"attr\">    image:</span> <span class=\"attr\">cassandra:3.11</span></span><br><span class=\"line\"><span class=\"attr\">    container_name:</span> <span class=\"string\">cassandra</span></span><br><span class=\"line\"><span class=\"attr\">    environment:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">CASSANDRA_DC=dc1</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">MAX_HEAP_SIZE=512M</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">HEAP_NEWSIZE=100M</span></span><br><span class=\"line\"><span class=\"attr\">    ports:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"number\">9042</span><span class=\"string\">:9042</span></span><br><span class=\"line\"><span class=\"attr\">    restart:</span> <span class=\"string\">on-failure</span></span><br><span class=\"line\"><span class=\"attr\">    volumes:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">/Users/ytx/cassandra/logs:/var/log/cassandra</span>    </span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">/Users/ytx/cassandra/data:/var/lib/cassandra</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  jaeger-cassandra-schema:</span></span><br><span class=\"line\"><span class=\"attr\">    image:</span> <span class=\"string\">jaegertracing/jaeger-cassandra-schema:0.9</span></span><br><span class=\"line\"><span class=\"attr\">    container_name:</span> <span class=\"string\">cassandra-schema</span></span><br><span class=\"line\"><span class=\"attr\">    links:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">cassandra</span></span><br><span class=\"line\"><span class=\"attr\">    environment:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">MODE=test</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">DATACENTER=dc1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  jaeger-collector:</span></span><br><span class=\"line\"><span class=\"attr\">    image:</span> <span class=\"string\">jaegertracing/jaeger-collector:0.9</span></span><br><span class=\"line\"><span class=\"attr\">    container_name:</span> <span class=\"string\">jaeger-collector</span></span><br><span class=\"line\"><span class=\"attr\">    restart:</span> <span class=\"string\">on-failure</span></span><br><span class=\"line\"><span class=\"attr\">    links:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">cassandra</span></span><br><span class=\"line\"><span class=\"attr\">    environment:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">CASSANDRA_SERVERS=cassandra</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">CASSANDRA_KEYSPACE=jaeger_v1_dc1</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">CASSANDRA_PORT=9042</span></span><br><span class=\"line\"><span class=\"attr\">    ports:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"number\">14267</span><span class=\"string\">:14267/tcp</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"number\">14268</span><span class=\"string\">:14268/tcp</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"number\">9411</span><span class=\"string\">:9411/tcp</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  jaeger-agent:</span></span><br><span class=\"line\"><span class=\"attr\">    image:</span> <span class=\"string\">jaegertracing/jaeger-agent:0.9</span></span><br><span class=\"line\"><span class=\"attr\">    container_name:</span> <span class=\"string\">jaeger-agent</span></span><br><span class=\"line\"><span class=\"attr\">    restart:</span> <span class=\"string\">on-failure</span></span><br><span class=\"line\"><span class=\"attr\">    links:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">jaeger-collector</span></span><br><span class=\"line\"><span class=\"attr\">    environment:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">COLLECTOR_HOST_PORT=jaeger-collector:14267</span></span><br><span class=\"line\"><span class=\"attr\">    ports:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"number\">5775</span><span class=\"string\">:5775/udp</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"number\">6831</span><span class=\"string\">:6831/udp</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"number\">6832</span><span class=\"string\">:6832/udp</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"number\">5778</span><span class=\"string\">:5778/tcp</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">  jaeger-query:</span></span><br><span class=\"line\"><span class=\"attr\">    image:</span> <span class=\"string\">jaegertracing/jaeger-query:0.9</span></span><br><span class=\"line\"><span class=\"attr\">    container_name:</span> <span class=\"string\">jaeger-query</span></span><br><span class=\"line\"><span class=\"attr\">    restart:</span> <span class=\"string\">on-failure</span></span><br><span class=\"line\"><span class=\"attr\">    links:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">cassandra</span></span><br><span class=\"line\"><span class=\"attr\">    environment:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">CASSANDRA_KEYSPACE=jaeger_v1_dc1</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">CASSANDRA_SERVERS=cassandra</span></span><br><span class=\"line\"><span class=\"attr\">    ports:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"number\">8003</span><span class=\"string\">:16686/tcp</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">networks:</span></span><br><span class=\"line\"><span class=\"attr\">  default:</span></span><br><span class=\"line\"><span class=\"attr\">    driver:</span> <span class=\"string\">bridge</span></span><br></pre></td></tr></table></figure>\n<hr>\n<h2 id=\"Jaeger集成到应用程序\"><a href=\"#Jaeger集成到应用程序\" class=\"headerlink\" title=\"Jaeger集成到应用程序\"></a>Jaeger集成到应用程序</h2><p><code>jaeger</code>团队提供了针对<code>Node.js</code>环境的工具包<a href=\"https://github.com/jaegertracing/jaeger-client-node\" target=\"_blank\" rel=\"noopener\">jaeger-client-node</a>。如何能够跟团队项目代码更好的契合是接下来要考虑的点。针对现有的项目，在接入<code>Jaeger</code>的时候是一个渐进的过程，希望能够做尽量少的修改代码。</p>\n<p>针对<code>Node.js</code>生态下<code>web</code>服务器的路由都是采用类似<code>connect</code>风格，我们对常用的<code>web</code>框架路由做相应的包装：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">RouterProxy</span>(<span class=\"params\">router, config</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.config = config</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.proxyInstance = router  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">RouterProxy.create = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">config, tracer = null</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!config.router) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Error</span>(<span class=\"string\">\"Not Setup Router\"</span>)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!config.proxy) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Error</span>(<span class=\"string\">\"Not Setup Proxy\"</span>)    </span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> proxyInstance = RouterCreator(config.proxy)</span><br><span class=\"line\">  <span class=\"keyword\">const</span> instance = <span class=\"keyword\">new</span> RouterProxy(proxyInstance, config)</span><br><span class=\"line\">  instance.wrap(config.router, tracer)</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> instance</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">RouterProxy.prototype.wrap = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">router, tracer = null</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!tracer) &#123;</span><br><span class=\"line\">    tracer = opentracing.globalTracer()  </span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  constants.PROXY_NAMES.forEach(<span class=\"function\"><span class=\"params\">method</span> =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.wrapRouterMethod(router, method, tracer)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> router</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">RouterProxy.prototype.wrapRouterMethod = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">router, method, tracer</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> router[method] !== <span class=\"string\">'function'</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> that = <span class=\"keyword\">this</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> doit = router[method].bind(router)</span><br><span class=\"line\">  router[method] = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">...args</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> length = args.length</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (length &lt;= <span class=\"number\">1</span> || <span class=\"keyword\">typeof</span> args[length<span class=\"number\">-1</span>] !== <span class=\"string\">'function'</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> doit(...args)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> uri = args[<span class=\"number\">0</span>]</span><br><span class=\"line\">    <span class=\"keyword\">const</span> handler = that.wrapRouterMethodHandler(args[args.length - <span class=\"number\">1</span>], uri, tracer)</span><br><span class=\"line\">    args.splice(length <span class=\"number\">-1</span>, <span class=\"number\">1</span>, handler)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> doit(...args)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">RouterProxy.prototype.wrapRouterMethodHandler = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">handler, uri, tracer</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> that = <span class=\"keyword\">this</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">...args</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> req = that.proxyInstance.request(...args)</span><br><span class=\"line\">    <span class=\"keyword\">const</span> res = that.proxyInstance.response(...args)</span><br><span class=\"line\">    <span class=\"keyword\">const</span> url = that.proxyInstance.url(...args)</span><br><span class=\"line\">    <span class=\"keyword\">const</span> method = that.proxyInstance.method(...args)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">const</span> span = extractOrCreateSpan(req, uri, tracer)</span><br><span class=\"line\">    span.setTag(opentracing.Tags.HTTP_METHOD, method)</span><br><span class=\"line\">    span.setTag(opentracing.Tags.HTTP_URL, url)</span><br><span class=\"line\">    span.setTag(opentracing.Tags.SPAN_KIND, <span class=\"string\">'server'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">const</span> traceCtx = &#123; span, tracer &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (that.config.customizeTags) &#123;</span><br><span class=\"line\">      that.config.customizeTags(traceCtx, ...args)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    args[<span class=\"number\">0</span>].traceCtx = traceCtx</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">spanFinised</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">      span.finish()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    onFinished(res, spanFinised)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> handler(...args)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>通过以上方式在每个路由到达正式处理函数之前，<a href=\"http://gitlab.yintech.net/ytx/paprika/nugget/backend/opentracing-connect\" target=\"_blank\" rel=\"noopener\">opentracing-connect</a>类库记录当前的<code>http</code>请求基本信息并把数据通过上下文参数暴露给用户处理函数，在处理完毕之后类库自动调用<code>finish</code>函数表示一次请求结束。需要注意的是：如果实际过程中希望记录更多的信息\b或者调用关系，需要用户参照<code>API</code>自己\b实现。</p>\n<hr>\n<h2 id=\"JaegerUI基本使用\"><a href=\"#JaegerUI基本使用\" class=\"headerlink\" title=\"JaegerUI基本使用\"></a>JaegerUI基本使用</h2><p>假定现有如下两个服务：</p>\n<ul>\n<li>Service One</li>\n</ul>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> express = <span class=\"built_in\">require</span>(<span class=\"string\">'express'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> request = <span class=\"built_in\">require</span>(<span class=\"string\">'request-promise'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> &#123; Tracer, RouterProxy &#125; = <span class=\"built_in\">require</span>(<span class=\"string\">'opentracing-connect'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> app = <span class=\"keyword\">new</span> express()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> serviceName = <span class=\"string\">'One'</span></span><br><span class=\"line\">Tracer.createGlobalTracer(serviceName, &#123; <span class=\"attr\">logger</span>: <span class=\"built_in\">console</span> &#125;)</span><br><span class=\"line\"><span class=\"keyword\">const</span> Router = RouterProxy.create(&#123; <span class=\"attr\">router</span>: &#123; <span class=\"attr\">type</span>: <span class=\"string\">\"express\"</span> &#125;&#125;).routerProxy(express.Router())</span><br><span class=\"line\"></span><br><span class=\"line\">Router.get(<span class=\"string\">'/one'</span>,  <span class=\"keyword\">async</span> (request, response, next) =&gt; &#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> result = <span class=\"keyword\">await</span> requestServiceTwo(request.traceCtx.span)</span><br><span class=\"line\">  response.json(result)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">async</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">requestServiceTwo</span>(<span class=\"params\">span</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> peerServiceName = <span class=\"string\">'Two'</span></span><br><span class=\"line\">  span.setTag(Tracer.opentracing.Tags.PEER_SERVICE, peerServiceName)</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"keyword\">let</span> result  </span><br><span class=\"line\">  <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> carrier = &#123;&#125;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> uri = <span class=\"string\">'http://localhost:8020/two'</span></span><br><span class=\"line\">    span.tracer().inject(span.context(), </span><br><span class=\"line\">      Tracer.opentracing.FORMAT_HTTP_HEADERS, carrier)</span><br><span class=\"line\">    result = <span class=\"keyword\">await</span> request(&#123; uri, <span class=\"attr\">headers</span>: carrier &#125;)</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.dir(result)</span><br><span class=\"line\">    span.log(&#123;<span class=\"string\">'event'</span>: <span class=\"string\">'request_end'</span>&#125;)</span><br><span class=\"line\">  &#125; <span class=\"keyword\">catch</span>(err) &#123;</span><br><span class=\"line\">    span.setTag(Tracer.opentracing.Tags.ERROR, <span class=\"literal\">true</span>)</span><br><span class=\"line\">    span.log(&#123; <span class=\"string\">'event'</span>: <span class=\"string\">'error'</span>, <span class=\"string\">'message'</span>: err.message &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> result</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">app.use(Router)</span><br><span class=\"line\"></span><br><span class=\"line\">app.listen(<span class=\"number\">8010</span>)</span><br></pre></td></tr></table></figure>\n<ul>\n<li>Service Two</li>\n</ul>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> Koa = <span class=\"built_in\">require</span>(<span class=\"string\">'koa'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> KoaRouter = <span class=\"built_in\">require</span>(<span class=\"string\">'koa-router'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> request = <span class=\"built_in\">require</span>(<span class=\"string\">'request-promise'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> &#123; Tracer, RouterProxy &#125; = <span class=\"built_in\">require</span>(<span class=\"string\">'opentracing-connect'</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> Redis = <span class=\"built_in\">require</span>(<span class=\"string\">'./redis'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> app = <span class=\"keyword\">new</span> Koa()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> serviceName = <span class=\"string\">'Two'</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> tracer = Tracer.createGlobalTracer(serviceName, &#123; <span class=\"attr\">logger</span>: <span class=\"built_in\">console</span> &#125;)</span><br><span class=\"line\"><span class=\"keyword\">const</span> Router = RouterProxy.create(&#123; <span class=\"attr\">router</span>: &#123; <span class=\"attr\">type</span>: <span class=\"string\">\"koa2\"</span> &#125;&#125;).routerProxy(KoaRouter())</span><br><span class=\"line\"></span><br><span class=\"line\">Router.get(<span class=\"string\">'/two'</span>, <span class=\"keyword\">async</span> (ctx, next) =&gt; &#123;</span><br><span class=\"line\">  <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> userId = <span class=\"number\">1</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> result = <span class=\"keyword\">await</span> getUserInfo(userId, &#123; <span class=\"attr\">span</span>: ctx.traceCtx.span &#125;)</span><br><span class=\"line\">    ctx.traceCtx.span.log(&#123;<span class=\"string\">'event'</span>: <span class=\"string\">'request_end'</span>&#125;)</span><br><span class=\"line\">    ctx.body = &#123; <span class=\"attr\">a</span>: <span class=\"number\">1</span>, <span class=\"attr\">b</span>: <span class=\"number\">2</span>, <span class=\"attr\">c</span>: <span class=\"number\">3</span> &#125;</span><br><span class=\"line\">  &#125; <span class=\"keyword\">catch</span>(err) &#123;</span><br><span class=\"line\">    ctx.traceCtx.span.setTag(Tracer.opentracing.Tags.ERROR, <span class=\"literal\">true</span>)</span><br><span class=\"line\">    ctx.traceCtx.span.logEvent(<span class=\"string\">'error'</span>, &#123; <span class=\"attr\">message</span>: err.message &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> </span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">async</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getUserInfo</span>(<span class=\"params\">id, ctx</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> span = tracer.startSpan(<span class=\"string\">\"getUserInfo\"</span>, &#123; <span class=\"attr\">references</span>: [Tracer.opentracing.childOf(ctx.span.context())] &#125;)</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"keyword\">let</span> result</span><br><span class=\"line\">  <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">    result = <span class=\"keyword\">await</span> Redis.getRedisUser(id, &#123; span &#125;)</span><br><span class=\"line\">  &#125; <span class=\"keyword\">catch</span>(err) &#123;</span><br><span class=\"line\">    span.setTag(Tracer.opentracing.Tags.ERROR, <span class=\"literal\">true</span>)</span><br><span class=\"line\">    span.logEvent(<span class=\"string\">'error'</span>, &#123; <span class=\"attr\">message</span>: err.message &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  span.finish()</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> result</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">app.use(Router.routes())</span><br><span class=\"line\"></span><br><span class=\"line\">app.listen(<span class=\"number\">8020</span>)</span><br></pre></td></tr></table></figure>\n<p>在两个服务启动的时候，分别创建了一个<code>tracer</code>对象，写入当前服务的名称，以及一个<code>logger</code>对象用于追踪\b<code>jaeger-client</code>的行为。 <code>ServiceOne</code>提供了一个请求处理函数，该处理函数接收到请求之后向<code>ServiceTwo</code>发起请求，而<code>ServiceTwo</code>向<code>Redis</code>服务发起请求读取用户信息，并返回给客户端。</p>\n<p>通过<code>POSTMAN</code>向<code>ServiceOne</code>发起一个请求：</p>\n<p><img src=\"http://owoeej96r.bkt.clouddn.com/o_1btt652ft10qb1c8t1csl1h0jovha\" alt=\"postman\"></p>\n<p>打开<code>Jaeger-UI</code>页面：</p>\n<p><img src=\"http://owoeej96r.bkt.clouddn.com/o_1btt65vo21ee34491b2mn0pa6sf\" alt=\"jaeger-ui\"></p>\n<p>在<code>Jaeger-UI</code>页面左侧可以看到所有的服务列表，以及服务的<code>endpoint</code>列表。可以通过我们给应用程序设置的<code>tag</code>来搜索指定的<code>trace</code>。在<code>POSTMAN</code>页面可以看到响应时间为<code>114ms</code>,在<code>Jaeger-UI</code>看到此次<code>trace</code>有三个服务，包含四个<code>span</code>, <code>trace</code>的持续时间是<code>78ms</code>比<code>POSTMAN</code>检测到的时间要小，这是因为从服务器到<code>POSTMAN</code>客户端有网络延迟的缘故。</p>\n<p>点击<code>trace</code>条目：</p>\n<p><img src=\"http://owoeej96r.bkt.clouddn.com/o_1btt66ieuur4fd2m591umb1r8ok\" alt=\"jaeger-trace\"></p>\n<p>可以看到整个调用链路：</p>\n<ol>\n<li><code>ServiceOne</code>收到一个<code>GET</code>请求，<code>endpoint</code>为<code>/one</code>  </li>\n<li><code>ServiceOne</code>向<code>ServiceTwo</code>发送一个请求，<code>endpoint</code>为<code>/two</code>  </li>\n<li><code>Servicetwo</code>调用<code>getUserInfo</code>函数</li>\n<li><code>getUserInfo</code>函数向<code>Redis</code>服务发送一个<code>get</code>请求获取用户信息, 用户id为<code>1</code></li>\n<li>最终<code>Redis</code>服务返回用户信息,<code>ServiceTwo</code>将用户信息返回给<code>ServiceOne</code>,<code>ServiceOne</code>把数据返回给客户端</li>\n</ol>\n<p>单击每个<code>span</code>条目，可以看到<code>tag</code>、<code>log</code>等信息。<a href=\"https://github.com/opentracing/specification/blob/master/semantic_conventions.md\" target=\"_blank\" rel=\"noopener\">opentracing</a>对<code>span</code>内常使用的<code>tag</code>以及<code>log</code>字段有相应的推荐。</p>\n<h2 id=\"参考文献\"><a href=\"#参考文献\" class=\"headerlink\" title=\"参考文献\"></a>参考文献</h2><ol>\n<li><a href=\"https://static.googleusercontent.com/media/research.google.com/zh-CN//pubs/archive/36356.pdf\" target=\"_blank\" rel=\"noopener\">Google Dapper paper</a>  </li>\n<li><a href=\"http://opentracing.io/documentation/pages/instrumentation/\" target=\"_blank\" rel=\"noopener\">OpenTracing Best Pratices</a>  </li>\n<li><p><a href=\"https://github.com/opentracing-contrib/opentracing-specification-zh/blob/master/specification.md\" target=\"_blank\" rel=\"noopener\">OpenTraing Specification</a></p>\n</li>\n<li><p><a href=\"https://github.com/opentracing-contrib/opentracing-specification-zh/blob/master/semantic_conventions.md\" target=\"_blank\" rel=\"noopener\">OpenTracing Semantic Conventions</a></p>\n</li>\n<li><p><a href=\"http://jaeger.readthedocs.io/en/latest/\" target=\"_blank\" rel=\"noopener\">Jaeger, a distributed tracing system</a></p>\n</li>\n<li><p><a href=\"https://github.com/jaegertracing/jaeger-client-node\" target=\"_blank\" rel=\"noopener\">Jaeger Client Node</a>  </p>\n</li>\n<li><p><a href=\"https://github.com/opentracing/opentracing-javascript\" target=\"_blank\" rel=\"noopener\">OpenTracing API for Javascript</a></p>\n</li>\n</ol>\n<p><em>–EOF–</em></p>\n"}],"PostAsset":[],"PostCategory":[{"post_id":"cjsuh9ccp0007y4zvccyc7k7e","category_id":"cjsuh9ccm0004y4zvmvaq323a","_id":"cjsuh9ccw000dy4zvpexyfmj3"},{"post_id":"cjsuh9ccg0000y4zvfyhtiihp","category_id":"cjsuh9ccm0004y4zvmvaq323a","_id":"cjsuh9ccy000iy4zvmrlnahnm"},{"post_id":"cjsuh9ccr0009y4zvz04m0dva","category_id":"cjsuh9ccm0004y4zvmvaq323a","_id":"cjsuh9ccz000ky4zvmcags6ba"},{"post_id":"cjsuh9ccu000by4zvpqs0k21v","category_id":"cjsuh9ccm0004y4zvmvaq323a","_id":"cjsuh9cd0000oy4zv8ud0cwbd"},{"post_id":"cjsuh9ccj0002y4zvwve3s0pr","category_id":"cjsuh9ccm0004y4zvmvaq323a","_id":"cjsuh9cd1000qy4zvi2ovimbf"},{"post_id":"cjsuh9ccv000cy4zvbajz53gr","category_id":"cjsuh9ccm0004y4zvmvaq323a","_id":"cjsuh9cd2000uy4zvcxwp3t1c"},{"post_id":"cjsuh9ccn0005y4zvga62blsu","category_id":"cjsuh9ccm0004y4zvmvaq323a","_id":"cjsuh9cd3000xy4zvh34ywi4d"},{"post_id":"cjsuh9ccx000hy4zvo3l2mbf1","category_id":"cjsuh9cd0000my4zv4wng83m6","_id":"cjsuh9cd50012y4zvj0vjq11o"},{"post_id":"cjsuh9cd1000sy4zvuzltqoc0","category_id":"cjsuh9ccm0004y4zvmvaq323a","_id":"cjsuh9cd60015y4zvbreadkae"},{"post_id":"cjsuh9cd3000wy4zv6qk23euk","category_id":"cjsuh9cd0000my4zv4wng83m6","_id":"cjsuh9cd70017y4zvgtpfu8ww"},{"post_id":"cjsuh9ccz000jy4zve0ytc02d","category_id":"cjsuh9cd0000my4zv4wng83m6","_id":"cjsuh9cd9001cy4zv72hqqbqx"},{"post_id":"cjsuh9cd40010y4zvezhjn8lt","category_id":"cjsuh9ccm0004y4zvmvaq323a","_id":"cjsuh9cda001ey4zv0jb76qua"},{"post_id":"cjsuh9cd50014y4zv6tijxfmf","category_id":"cjsuh9cd50011y4zv0zonx4vr","_id":"cjsuh9cdb001iy4zvli1hg98i"},{"post_id":"cjsuh9cd0000ny4zv6owmt6de","category_id":"cjsuh9cd50011y4zv0zonx4vr","_id":"cjsuh9cdc001ky4zvtou5iqh4"},{"post_id":"cjsuh9cd60016y4zvh74lsk5h","category_id":"cjsuh9ccm0004y4zvmvaq323a","_id":"cjsuh9cdd001ny4zvuc4uqzmb"},{"post_id":"cjsuh9cd8001by4zvcy9p47ob","category_id":"cjsuh9cd50011y4zv0zonx4vr","_id":"cjsuh9cde001py4zv5qgwejo5"},{"post_id":"cjsuh9cd1000py4zv3xjz028d","category_id":"cjsuh9cd50011y4zv0zonx4vr","_id":"cjsuh9cdf001ty4zvrxa17a4o"},{"post_id":"cjsuh9cd9001dy4zvf76bymvt","category_id":"cjsuh9ccm0004y4zvmvaq323a","_id":"cjsuh9cdg001wy4zvo5xlcbqs"},{"post_id":"cjsuh9cdb001hy4zvyqr885b3","category_id":"cjsuh9cd50011y4zv0zonx4vr","_id":"cjsuh9cdh0020y4zvy5rxs6ky"},{"post_id":"cjsuh9cdb001jy4zvatmkw8hi","category_id":"cjsuh9ccm0004y4zvmvaq323a","_id":"cjsuh9cdi0022y4zvk6hpcsot"},{"post_id":"cjsuh9cde001oy4zvb2v81n5j","category_id":"cjsuh9ccm0004y4zvmvaq323a","_id":"cjsuh9cdj0025y4zvr19d2ilz"},{"post_id":"cjsuh9cdf001sy4zv9t2utis3","category_id":"cjsuh9cd50011y4zv0zonx4vr","_id":"cjsuh9cdk0028y4zvrz5volha"},{"post_id":"cjsuh9cdg001vy4zv11d68ixp","category_id":"cjsuh9ccm0004y4zvmvaq323a","_id":"cjsuh9cdl002cy4zv9h5mb8nw"},{"post_id":"cjsuh9cdd001my4zvssh8s7jw","category_id":"cjsuh9cde001ry4zvoliq6j0w","_id":"cjsuh9cdm002fy4zvan73nzg3"},{"post_id":"cjsuh9cdh001zy4zvguwbarsr","category_id":"cjsuh9ccm0004y4zvmvaq323a","_id":"cjsuh9cdo002iy4zvjw43f93t"},{"post_id":"cjsuh9cdi0021y4zvajg42ktn","category_id":"cjsuh9cd50011y4zv0zonx4vr","_id":"cjsuh9cdp002my4zv3yq3pirw"},{"post_id":"cjsuh9cdj0024y4zvywxclik2","category_id":"cjsuh9ccm0004y4zvmvaq323a","_id":"cjsuh9cdp002oy4zv26a5yzd2"},{"post_id":"cjsuh9cdj0027y4zvwz9bardv","category_id":"cjsuh9ccm0004y4zvmvaq323a","_id":"cjsuh9cdr002ry4zvkt93741e"},{"post_id":"cjsuh9cdm002ey4zvd8rr4v7u","category_id":"cjsuh9ccm0004y4zvmvaq323a","_id":"cjsuh9cds002uy4zver6yr207"},{"post_id":"cjsuh9cdn002hy4zvdseavxwq","category_id":"cjsuh9ccm0004y4zvmvaq323a","_id":"cjsuh9cdt002xy4zv1i8ue09c"},{"post_id":"cjsuh9cdo002ly4zvejdwvsfb","category_id":"cjsuh9ccm0004y4zvmvaq323a","_id":"cjsuh9cdu002zy4zv9magth0q"},{"post_id":"cjsuh9cdl002by4zvn955txck","category_id":"cjsuh9cdn002gy4zvjhxo1h1j","_id":"cjsuh9cdv0032y4zvcp02dm4o"},{"post_id":"cjsuh9cdp002ny4zvduto8u9t","category_id":"cjsuh9ccm0004y4zvmvaq323a","_id":"cjsuh9cdv0034y4zvx3ojygms"},{"post_id":"cjsuh9cdq002qy4zvby3dypec","category_id":"cjsuh9cd50011y4zv0zonx4vr","_id":"cjsuh9cdx0037y4zvyezv0sqi"},{"post_id":"cjsuh9cdr002ty4zvtgevonne","category_id":"cjsuh9cd50011y4zv0zonx4vr","_id":"cjsuh9cdy003by4zvvrtgc9gk"},{"post_id":"cjsuh9cds002wy4zv708ae0lo","category_id":"cjsuh9cd50011y4zv0zonx4vr","_id":"cjsuh9cdz003fy4zvg9rfzhkt"},{"post_id":"cjsuh9cdt002yy4zvjqa3dp1y","category_id":"cjsuh9ccm0004y4zvmvaq323a","_id":"cjsuh9cdz003iy4zv0ovarru8"},{"post_id":"cjsuh9cdu0031y4zvxpb5al10","category_id":"cjsuh9cd50011y4zv0zonx4vr","_id":"cjsuh9ce0003ly4zv5gcmlb38"},{"post_id":"cjsuh9cdw0036y4zv4vli8jb4","category_id":"cjsuh9ccm0004y4zvmvaq323a","_id":"cjsuh9ce2003py4zvdcq6i5j7"},{"post_id":"cjsuh9cdx003ay4zv1it9gyl9","category_id":"cjsuh9cde001ry4zvoliq6j0w","_id":"cjsuh9ce3003ry4zv4uqf5kez"},{"post_id":"cjsuh9cdy003ey4zv0mbx01hh","category_id":"cjsuh9cde001ry4zvoliq6j0w","_id":"cjsuh9ce5003uy4zvf2g2q0j4"},{"post_id":"cjsuh9cdv0033y4zvkh7bmizb","category_id":"cjsuh9cdx0039y4zvmdvuo7kz","_id":"cjsuh9ce6003xy4zvd4y70zan"},{"post_id":"cjsuh9cdz003hy4zvbnz5qgyc","category_id":"cjsuh9ccm0004y4zvmvaq323a","_id":"cjsuh9ce70040y4zvpx4un88v"},{"post_id":"cjsuh9ce0003ky4zvvp0qsuon","category_id":"cjsuh9cd50011y4zv0zonx4vr","_id":"cjsuh9ce80043y4zvziolpmb2"},{"post_id":"cjsuh9ce1003oy4zvannlomg5","category_id":"cjsuh9ccm0004y4zvmvaq323a","_id":"cjsuh9ce90046y4zv90dwce2x"},{"post_id":"cjsuh9ce3003qy4zveyxmf22t","category_id":"cjsuh9ccm0004y4zvmvaq323a","_id":"cjsuh9cea0049y4zvbs2syfae"},{"post_id":"cjsuh9ce4003ty4zvlgnto782","category_id":"cjsuh9cd50011y4zv0zonx4vr","_id":"cjsuh9ceb004by4zvmx67e5gx"},{"post_id":"cjsuh9ce5003wy4zvdw81fiur","category_id":"cjsuh9cd50011y4zv0zonx4vr","_id":"cjsuh9ced004gy4zvlvzxomxn"},{"post_id":"cjsuh9ce6003zy4zvsjyvurll","category_id":"cjsuh9cd50011y4zv0zonx4vr","_id":"cjsuh9cee004jy4zvh91d6g76"},{"post_id":"cjsuh9ce90048y4zvt8sgg59e","category_id":"cjsuh9cd50011y4zv0zonx4vr","_id":"cjsuh9cef004ny4zv8k4o0isi"},{"post_id":"cjsuh9cea004ay4zvzlyjw6wb","category_id":"cjsuh9ccm0004y4zvmvaq323a","_id":"cjsuh9ceg004qy4zvj5jy6hcx"},{"post_id":"cjsuh9ce70042y4zvmjqjc404","category_id":"cjsuh9ce90047y4zvp76qp1hq","_id":"cjsuh9ceh004ty4zvi5ado0eg"},{"post_id":"cjsuh9cec004ey4zvivus8wwi","category_id":"cjsuh9ccm0004y4zvmvaq323a","_id":"cjsuh9cei004wy4zv3ft2thy2"},{"post_id":"cjsuh9ce80045y4zvo3161pvo","category_id":"cjsuh9ced004fy4zvzgl4ncje","_id":"cjsuh9cej004zy4zv3jnkadvf"},{"post_id":"cjsuh9cee004my4zvm777f6e0","category_id":"cjsuh9cd50011y4zv0zonx4vr","_id":"cjsuh9cek0052y4zvr55prut5"},{"post_id":"cjsuh9cef004py4zvdaeefu1g","category_id":"cjsuh9cd50011y4zv0zonx4vr","_id":"cjsuh9cem0055y4zv80to3dk0"},{"post_id":"cjsuh9ced004iy4zv628nloz8","category_id":"cjsuh9cef004oy4zvhzt79ddi","_id":"cjsuh9cen0058y4zvxmw1svyd"},{"post_id":"cjsuh9ceh004vy4zvl4elksoz","category_id":"cjsuh9ce90047y4zvp76qp1hq","_id":"cjsuh9ceo005by4zv2o8p5m0j"},{"post_id":"cjsuh9cei004yy4zvy9reawy4","category_id":"cjsuh9cd50011y4zv0zonx4vr","_id":"cjsuh9cep005ey4zvi58grm71"},{"post_id":"cjsuh9cej0051y4zv6j3pmkrg","category_id":"cjsuh9cd50011y4zv0zonx4vr","_id":"cjsuh9ceq005gy4zv4z3cxj3e"},{"post_id":"cjsuh9cel0054y4zvhlbulaer","category_id":"cjsuh9cd50011y4zv0zonx4vr","_id":"cjsuh9ceq005iy4zvf20sdcob"},{"post_id":"cjsuh9cem0057y4zvubgjhzoa","category_id":"cjsuh9ccm0004y4zvmvaq323a","_id":"cjsuh9cer005jy4zvf8b4oiho"},{"post_id":"cjsuh9ceo005ay4zvqutne1t0","category_id":"cjsuh9cd50011y4zv0zonx4vr","_id":"cjsuh9cer005ly4zvwy1q2wwg"},{"post_id":"cjsuh9ceo005dy4zv1dqu81xd","category_id":"cjsuh9cd50011y4zv0zonx4vr","_id":"cjsuh9cer005my4zve8yx58hv"},{"post_id":"cjsuh9cfd0077y4zvc5hiq3kn","category_id":"cjsuh9cd50011y4zv0zonx4vr","_id":"cjsuh9cfg007by4zvlyj39ba4"},{"post_id":"cjsuh9cfe0078y4zvwq417nfm","category_id":"cjsuh9ced004fy4zvzgl4ncje","_id":"cjsuh9cfg007cy4zvsvh04shl"}],"PostTag":[{"post_id":"cjsuh9ccn0005y4zvga62blsu","tag_id":"cjsuh9ccq0008y4zv4yyw6o0m","_id":"cjsuh9ccx000gy4zvjft22bub"},{"post_id":"cjsuh9ccp0007y4zvccyc7k7e","tag_id":"cjsuh9ccw000ey4zving8ofcq","_id":"cjsuh9cd2000vy4zvx2ylk4bo"},{"post_id":"cjsuh9ccp0007y4zvccyc7k7e","tag_id":"cjsuh9ccz000ly4zvqpw28t89","_id":"cjsuh9cd3000yy4zv9y4hggxn"},{"post_id":"cjsuh9ccr0009y4zvz04m0dva","tag_id":"cjsuh9cd1000ry4zvr9c837l7","_id":"cjsuh9cd50013y4zvr41m06d2"},{"post_id":"cjsuh9ccu000by4zvpqs0k21v","tag_id":"cjsuh9cd4000zy4zv2l5ha6aa","_id":"cjsuh9cd8001ay4zv2o8zjqgt"},{"post_id":"cjsuh9ccv000cy4zvbajz53gr","tag_id":"cjsuh9cd1000ry4zvr9c837l7","_id":"cjsuh9cda001gy4zvu7h8fszt"},{"post_id":"cjsuh9ccx000hy4zvo3l2mbf1","tag_id":"cjsuh9cda001fy4zvwvcax9hm","_id":"cjsuh9cdg001uy4zv87yfyqj0"},{"post_id":"cjsuh9ccx000hy4zvo3l2mbf1","tag_id":"cjsuh9cdc001ly4zv6os1f0yg","_id":"cjsuh9cdg001xy4zvdfpnl9a3"},{"post_id":"cjsuh9ccz000jy4zve0ytc02d","tag_id":"cjsuh9cda001fy4zvwvcax9hm","_id":"cjsuh9cdj0026y4zv73ai3963"},{"post_id":"cjsuh9ccz000jy4zve0ytc02d","tag_id":"cjsuh9cdc001ly4zv6os1f0yg","_id":"cjsuh9cdk0029y4zv3iskyv95"},{"post_id":"cjsuh9cd0000ny4zv6owmt6de","tag_id":"cjsuh9cdi0023y4zvycmdy5jv","_id":"cjsuh9cdm002dy4zvoaycnwsx"},{"post_id":"cjsuh9cd1000py4zv3xjz028d","tag_id":"cjsuh9cdl002ay4zvg580hgjq","_id":"cjsuh9cdo002ky4zv4bi8w0u8"},{"post_id":"cjsuh9cd1000sy4zvuzltqoc0","tag_id":"cjsuh9cdo002jy4zvtubo1t3c","_id":"cjsuh9cdr002sy4zvb4y50ivh"},{"post_id":"cjsuh9cd3000wy4zv6qk23euk","tag_id":"cjsuh9cda001fy4zvwvcax9hm","_id":"cjsuh9cdx0038y4zvtujh8bf9"},{"post_id":"cjsuh9cd3000wy4zv6qk23euk","tag_id":"cjsuh9cdc001ly4zv6os1f0yg","_id":"cjsuh9cdy003cy4zv5afgru5y"},{"post_id":"cjsuh9cd3000wy4zv6qk23euk","tag_id":"cjsuh9cdu0030y4zvkcr8191s","_id":"cjsuh9cdz003gy4zvfc39iog1"},{"post_id":"cjsuh9cd40010y4zvezhjn8lt","tag_id":"cjsuh9cdw0035y4zvp735pa94","_id":"cjsuh9ce0003jy4zvhba37b5r"},{"post_id":"cjsuh9cd50014y4zv6tijxfmf","tag_id":"cjsuh9cdy003dy4zvoncbyu66","_id":"cjsuh9ce1003ny4zvjnrajx5c"},{"post_id":"cjsuh9cd60016y4zvh74lsk5h","tag_id":"cjsuh9ce0003my4zvhtr8dkes","_id":"cjsuh9ce5003vy4zvt69gdglw"},{"post_id":"cjsuh9cd8001by4zvcy9p47ob","tag_id":"cjsuh9ce4003sy4zvzo62xkdt","_id":"cjsuh9ce70041y4zvgjkozpt3"},{"post_id":"cjsuh9cd9001dy4zvf76bymvt","tag_id":"cjsuh9ce6003yy4zv6atfdjnf","_id":"cjsuh9cec004dy4zvjom3hk08"},{"post_id":"cjsuh9cd9001dy4zvf76bymvt","tag_id":"cjsuh9ce80044y4zvy9yztvd4","_id":"cjsuh9ced004hy4zv506d3kb4"},{"post_id":"cjsuh9cdb001hy4zvyqr885b3","tag_id":"cjsuh9ce4003sy4zvzo62xkdt","_id":"cjsuh9cee004ly4zvmyvmchjg"},{"post_id":"cjsuh9cdb001jy4zvatmkw8hi","tag_id":"cjsuh9cee004ky4zv9ffc7liu","_id":"cjsuh9ceh004uy4zvdcrww5dl"},{"post_id":"cjsuh9cde001oy4zvb2v81n5j","tag_id":"cjsuh9cdo002jy4zvtubo1t3c","_id":"cjsuh9cej0050y4zv4m6xe44s"},{"post_id":"cjsuh9cdh001zy4zvguwbarsr","tag_id":"cjsuh9cei004xy4zvtvf0artq","_id":"cjsuh9cem0056y4zvd1ogkzwm"},{"post_id":"cjsuh9cdj0024y4zvywxclik2","tag_id":"cjsuh9cdw0035y4zvp735pa94","_id":"cjsuh9ceo005cy4zvixx4jcqg"},{"post_id":"cjsuh9cdm002ey4zvd8rr4v7u","tag_id":"cjsuh9cen0059y4zv2vk7owz3","_id":"cjsuh9ceq005hy4zvqn42bv4a"},{"post_id":"cjsuh9cdo002ly4zvejdwvsfb","tag_id":"cjsuh9cep005fy4zva27qp1t0","_id":"cjsuh9ces005py4zv2j9bs8n2"},{"post_id":"cjsuh9cdo002ly4zvejdwvsfb","tag_id":"cjsuh9cer005ky4zvzdpldno3","_id":"cjsuh9ces005qy4zv62ja8r3u"},{"post_id":"cjsuh9cdo002ly4zvejdwvsfb","tag_id":"cjsuh9cer005ny4zv9t5yo6vl","_id":"cjsuh9ces005sy4zvovsepbhi"},{"post_id":"cjsuh9cdp002ny4zvduto8u9t","tag_id":"cjsuh9ces005oy4zv5h9redzj","_id":"cjsuh9ces005ty4zvaaf952my"},{"post_id":"cjsuh9cdr002ty4zvtgevonne","tag_id":"cjsuh9ces005ry4zvurz3ki7w","_id":"cjsuh9cet005xy4zvj0s27301"},{"post_id":"cjsuh9cdr002ty4zvtgevonne","tag_id":"cjsuh9cet005uy4zvkwgu4xry","_id":"cjsuh9cet005yy4zv1zqcvtuj"},{"post_id":"cjsuh9cdr002ty4zvtgevonne","tag_id":"cjsuh9cet005vy4zvwb33qt9l","_id":"cjsuh9cet0060y4zva3gb7i4b"},{"post_id":"cjsuh9cdt002yy4zvjqa3dp1y","tag_id":"cjsuh9cet005wy4zv1sgmxysg","_id":"cjsuh9ceu0062y4zv1f3if8gr"},{"post_id":"cjsuh9cdt002yy4zvjqa3dp1y","tag_id":"cjsuh9cet005zy4zv9mk12fso","_id":"cjsuh9ceu0063y4zvzul1u6vc"},{"post_id":"cjsuh9cdv0033y4zvkh7bmizb","tag_id":"cjsuh9ceu0061y4zvm7fipbfx","_id":"cjsuh9ceu0065y4zv1o707tlf"},{"post_id":"cjsuh9cdw0036y4zv4vli8jb4","tag_id":"cjsuh9ceu0064y4zvx9t3bg58","_id":"cjsuh9cev0069y4zv4ncnpe6b"},{"post_id":"cjsuh9cdw0036y4zv4vli8jb4","tag_id":"cjsuh9cev0066y4zv06cvsg2k","_id":"cjsuh9cev006ay4zvnx2pghjx"},{"post_id":"cjsuh9cdw0036y4zv4vli8jb4","tag_id":"cjsuh9cev0067y4zvu7rdct58","_id":"cjsuh9cev006cy4zv88zbi5l0"},{"post_id":"cjsuh9cdz003hy4zvbnz5qgyc","tag_id":"cjsuh9cev0068y4zv2tqkls60","_id":"cjsuh9cew006dy4zvksnlwpuu"},{"post_id":"cjsuh9ce1003oy4zvannlomg5","tag_id":"cjsuh9ceu0064y4zvx9t3bg58","_id":"cjsuh9cew006fy4zv5m69qd6v"},{"post_id":"cjsuh9ce3003qy4zveyxmf22t","tag_id":"cjsuh9cew006ey4zveer2zn51","_id":"cjsuh9cew006hy4zvd20u06jl"},{"post_id":"cjsuh9ce90048y4zvt8sgg59e","tag_id":"cjsuh9cew006gy4zvcglj9e4s","_id":"cjsuh9cex006jy4zvoc5zg9wq"},{"post_id":"cjsuh9cea004ay4zvzlyjw6wb","tag_id":"cjsuh9ceu0064y4zvx9t3bg58","_id":"cjsuh9cex006ly4zvyhiardej"},{"post_id":"cjsuh9cec004ey4zvivus8wwi","tag_id":"cjsuh9cex006ky4zvnnqdbcdv","_id":"cjsuh9cey006oy4zvyb08hr7e"},{"post_id":"cjsuh9cec004ey4zvivus8wwi","tag_id":"cjsuh9cex006my4zv4o7c3j3j","_id":"cjsuh9cey006py4zvwala6pq7"},{"post_id":"cjsuh9cec004ey4zvivus8wwi","tag_id":"cjsuh9ce4003sy4zvzo62xkdt","_id":"cjsuh9cey006ry4zverhd0jnk"},{"post_id":"cjsuh9cei004yy4zvy9reawy4","tag_id":"cjsuh9cey006ny4zvj0e5sla1","_id":"cjsuh9cey006sy4zvqes12h5d"},{"post_id":"cjsuh9cej0051y4zv6j3pmkrg","tag_id":"cjsuh9cey006qy4zvt92njdkw","_id":"cjsuh9cey006uy4zvy0j1qllj"},{"post_id":"cjsuh9cel0054y4zvhlbulaer","tag_id":"cjsuh9cey006ty4zv69xzll1r","_id":"cjsuh9cez006xy4zv56npgisl"},{"post_id":"cjsuh9cel0054y4zvhlbulaer","tag_id":"cjsuh9cey006vy4zvztpemja9","_id":"cjsuh9cez006yy4zvbcogqqm5"},{"post_id":"cjsuh9cem0057y4zvubgjhzoa","tag_id":"cjsuh9cez006wy4zvuoy1khcg","_id":"cjsuh9cez0070y4zv2k4fl5w2"},{"post_id":"cjsuh9ceo005ay4zvqutne1t0","tag_id":"cjsuh9cez006zy4zvst6w0xf6","_id":"cjsuh9cf00073y4zvu7700evc"},{"post_id":"cjsuh9ceo005ay4zvqutne1t0","tag_id":"cjsuh9cdw0035y4zvp735pa94","_id":"cjsuh9cf00074y4zvmexc9mi0"},{"post_id":"cjsuh9ceo005ay4zvqutne1t0","tag_id":"cjsuh9cez0071y4zvknrjvaua","_id":"cjsuh9cf00075y4zvdo6ehkwb"},{"post_id":"cjsuh9ceo005dy4zv1dqu81xd","tag_id":"cjsuh9cez0072y4zv52x8zmyq","_id":"cjsuh9cf00076y4zvgldvbf6j"},{"post_id":"cjsuh9cfd0077y4zvc5hiq3kn","tag_id":"cjsuh9ces005ry4zvurz3ki7w","_id":"cjsuh9cff0079y4zvwcyq8c7r"},{"post_id":"cjsuh9cfe0078y4zvwq417nfm","tag_id":"cjsuh9cfg007ay4zv47z2b8q5","_id":"cjsuh9cfh007dy4zvw9zc8rkc"}],"Tag":[{"name":"css background","_id":"cjsuh9ccq0008y4zv4yyw6o0m"},{"name":"transition","_id":"cjsuh9ccw000ey4zving8ofcq"},{"name":"animation","_id":"cjsuh9ccz000ly4zvqpw28t89"},{"name":"css-mastery","_id":"cjsuh9cd1000ry4zvr9c837l7"},{"name":"css CSSMastery","_id":"cjsuh9cd4000zy4zv2l5ha6aa"},{"name":"es6","_id":"cjsuh9cda001fy4zvwvcax9hm"},{"name":"cheatsheet","_id":"cjsuh9cdc001ly4zv6os1f0yg"},{"name":"http, cheatsheet","_id":"cjsuh9cdi0023y4zvycmdy5jv"},{"name":"linux","_id":"cjsuh9cdl002ay4zvg580hgjq"},{"name":"mobx","_id":"cjsuh9cdo002jy4zvtubo1t3c"},{"name":"propertys","_id":"cjsuh9cdu0030y4zvkcr8191s"},{"name":"react","_id":"cjsuh9cdw0035y4zvp735pa94"},{"name":"ssh","_id":"cjsuh9cdy003dy4zvoncbyu66"},{"name":"SVG","_id":"cjsuh9ce0003my4zvhtr8dkes"},{"name":"sailsjs","_id":"cjsuh9ce4003sy4zvzo62xkdt"},{"name":"Quill","_id":"cjsuh9ce6003yy4zv6atfdjnf"},{"name":"富文本编辑器","_id":"cjsuh9ce80044y4zvy9yztvd4"},{"name":"css scrollTo","_id":"cjsuh9cee004ky4zv9ffc7liu"},{"name":"inline block","_id":"cjsuh9cei004xy4zvtvf0artq"},{"name":"flexbox xmind","_id":"cjsuh9cen0059y4zv2vk7owz3"},{"name":"AMD","_id":"cjsuh9cep005fy4zva27qp1t0"},{"name":"CMD","_id":"cjsuh9cer005ky4zvzdpldno3"},{"name":"commonjs","_id":"cjsuh9cer005ny4zv9t5yo6vl"},{"name":"http, mixed-content","_id":"cjsuh9ces005oy4zv5h9redzj"},{"name":"nginx","_id":"cjsuh9ces005ry4zvurz3ki7w"},{"name":"proxy","_id":"cjsuh9cet005uy4zvkwgu4xry"},{"name":"cache","_id":"cjsuh9cet005vy4zvwb33qt9l"},{"name":"position","_id":"cjsuh9cet005wy4zv1sgmxysg"},{"name":"layout","_id":"cjsuh9cet005zy4zv9mk12fso"},{"name":"重构","_id":"cjsuh9ceu0061y4zvm7fipbfx"},{"name":"css","_id":"cjsuh9ceu0064y4zvx9t3bg58"},{"name":"html","_id":"cjsuh9cev0066y4zv06cvsg2k"},{"name":"table","_id":"cjsuh9cev0067y4zvu7rdct58"},{"name":"h5","_id":"cjsuh9cev0068y4zv2tqkls60"},{"name":"javascript","_id":"cjsuh9cew006ey4zveer2zn51"},{"name":"benchmark","_id":"cjsuh9cew006gy4zvcglj9e4s"},{"name":"vuejs","_id":"cjsuh9cex006ky4zvnnqdbcdv"},{"name":"ssr","_id":"cjsuh9cex006my4zv4o7c3j3j"},{"name":"c","_id":"cjsuh9cey006ny4zvj0e5sla1"},{"name":"c++","_id":"cjsuh9cey006qy4zvt92njdkw"},{"name":"password","_id":"cjsuh9cey006ty4zv69xzll1r"},{"name":"crypto","_id":"cjsuh9cey006vy4zvztpemja9"},{"name":"visual formatting model","_id":"cjsuh9cez006wy4zvuoy1khcg"},{"name":"weex","_id":"cjsuh9cez006zy4zvst6w0xf6"},{"name":"codepush","_id":"cjsuh9cez0071y4zvknrjvaua"},{"name":"log","_id":"cjsuh9cez0072y4zv52x8zmyq"},{"name":"monitor","_id":"cjsuh9cfg007ay4zv47z2b8q5"}]}}