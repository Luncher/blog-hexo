---
title: 数据库设计基础
date: 2018-10-19 15:49:54
tags: [database]
categories: 数据库
---

### 需求分析

#### 数据库设计简介

#### 数据库设计步骤

+ 需求分析
    + 了解需要存储的数据
    + 了解存储的数据的特点(实效性,增长过快需要分库分表)
    + 了解数据的生命周期(归档、清理规则)

+ 要搞清楚的问题：
    + 实体之间的关系（1对1，1对多，多对多）
    + 实体包含的属性有什么
    + 有哪些属性或属性的组合可以唯一标识一个实体

<!-- more -->

+ 逻辑分析
    >使用ER图建模
 
+ 物理设计
    >考虑数据库的特点，把逻辑设计转化为物理设计。

+ 维护优化
    + 新需求建表
    + 索引优化
    + 大表拆分
   
---

### 逻辑设计

+ 将需求转化为数据库的逻辑模型
+ 通过ER图的形式对逻辑模型进行展示
+ 和具体的DBMS无关

#### ER图
常见的概念：

关系：一个关系对应通常所说的一张表  
元组：表中的一行即为一个元组  
属性：表中的一列称之为一个属性；每一个属性都有一个名称，称之为属性名  
候选码：表中的某个属性组，它可以唯一确定一个元组（唯一索引、主键）  
主码：主键  
域：属性的取值范围  
分量：元组中的一个属性值  


#### 数据库设计概要

>数据库范式用于减少数据冗余，减少数据插入更新异常。

#### 数据库设计范式

+ 第一范式：
> 数据库中所有的字段都是不可分割的单一属性，字段的数据类型都是基本数据类型,如：整形、字符串、浮点数等。

+ 第二范式：
> 数据库表中不能存在组合关键字的某一字段决定非关键字段的情况。所以第二范式只针对于有组合关键字的情况。

+ 第三范式：
> 数据库表中不存在非关键字段对任意候选关键字段的传递函数依赖则符合第三范式。

+ BC范式：
> 数据库表中不存在任何字段对任意候选关键字段的传递函数依赖则符合BC范式。

---

### 物理设计

1. 选择合适的数据库管理系统
2. 定义数据库、表以及字段的命名规范
3. 根据所选的DBMS系统选择合适的字段数据类型
4. 反范式化设计（考虑效率：空间时间等）

#### DBMS选型

+ 版权考量
    商业数据库：
    + Oracle
    + SQLServer

    开源数据库：
    + MySQL
    + PgSQL

+ 功能上
    + 事物的支持
    + 特殊数据类型的支持
    + ...

+ 操作系统
    Windows系统
    + SQLServer

    Windows/类Linux
    + SQLServer
    + MySQL
    + PgSQL

+ 开发语言
    .Net首选SQLServer
    
+ 使用场景
    互联网项目
    + MySQL
    + PgSQL

    企业级项目
    + Oracle
    + SQLServer


#### MySQL常用存储引擎


| 存储引擎 | 事务支持 | 锁的粒度 | 主要应用 | 忌用 |
| --- | --- | --- | --- | --- |
| MyISAM | 不支持 | 表级锁 | insert,select | 读写频繁 |
| MRG_MYISAM | 不支持 | 表级锁 | 分段归档 | 全局查找过多的场景 |
| InnoDB | 支持 | 行级锁 | 事务 | 无 |
| Archive | 不支持 | 行级锁 | 日志记录，只支持insert,select | 需要随机读取，更新，删除  |
| Ndb Cluster | 支持 | 行级锁 | 高可用 | 大部分应用 |


#### 数据库、表以及字段的命名规范

+ 数据库名、表名、字段名的命名规范

    1. 数据库名/表名在Windows/Mac上大小写不敏感，在其他类Unix系统上大小写敏感
    2. 字段名/索引名在所有系统上都是大小写不敏感(除非加了双引号)
    3. 定义的时候要望文生义


#### 数据库字段类型的选择原则

字段数据类型的选择原则：

1. 存储开销

2. 查询性能: 对数据进行比较操作时，同样的数据，字符处理往往比数字慢。

3. 当一个列可以选择多个数据类型时，优先选择数字类型，其次是日期或二进制类型

4. 同级别的数据类型，应该优先选择占用空间小的数据类型。

5. 数据库数据处理以页为单位(MySQL18k每页)，列的长度越小，一次加载数据约多，数据库IO性能会有所提升

#### 数据库如何具体选择字段类型

+ char和varchar
    1. 如果列中要存储的数据长度差不多是一致的，则应该考虑用char，否则应该考虑用varchar。
    2. 如果列中最大数据长度小于50Byte，则一般也考虑用char。
    3. 一般不宜定义大于50Byte的char类型列。

+ decimal和float

    1. decimal(numeric)用于存储精确数据，而float只能用于存储非精确数据。
    2. float开销一般比decimal小，所以非精确数据一般选择float

+ 时间类型

    1. 用int存储的优缺点
    优点：字段长度比datetime小。
    缺点：使用不方便，要进行函数转换。
    限制：由于int类型占用4个字节，最多只能存储到2038-1-19
    
    2. 需要存储的时间粒度
    年 月 日 小时 分 秒 周
    
    
#### 数据库设计其它注意事项

   + 如何选择主键
       1. 区分业务主键和数据库主键
           1. 业务主键用于标示业务（有可能会更改）
           2. 数据库主键为了优化数据存储（避免业务的变更带来的影响）

       2. 根据数据库的类型，考虑主键是否需要顺序增长
       3. 主键的字段类型所占用的空间要尽可能小（提高IO效率）


   + 避免使用外键
       1. 降低数据倒入导入的效率
       2. 增加维护成本
       3. 虽然不建议使用外键约束，但是相关联的列上一定要建立索引


   + 避免使用触发器

   + 关于预留字段
       1. 无法准确知道预留字段的类型
       2. 无法准确知道预留字段中存储的内容
       3. 后期维护预留字段的成本和增加一个新的字段所需要的成本是相同的
       4. 严禁使用预留字段

#### 反范式化

   通过一定数据的冗余，空间换取时间的操作，违反数据库的第三范式。提高读取性能。要点：
   + 减少表的关联数量
   + 增加数据的读取效率
   + 反范式化要适度
   
   
---

### 数据库维护

#### 如何维护数据字典

+ 利用第三方工具
+ 利用`COMMENT`属性，并通过`information_shema`查询数据字段信息

#### 维护索引

如何选择合适的列建立索引：

+ 出现在WHERE从句,GROUP BY从句, ORDER BY从句中的列
+ 可选择性高的列要放到索引的前面
+ 索引中不要包含太长的数据类型
    + Mysql支持对TEXT类型前缀进行索引
    + 对长类型进行MD5然后索引
    + 太长影响IO效率(16k/page)问题

注意事项：
   + 索引不是越多越好，过多的索引不但会降低写的效率(维护索引数据结构),还会影响读的效率(影响索引优化器)。
   + 定期维护索引碎片
   + 在SQL中不要使用强制索引关键字

#### 数据库中适合的操作

如何维护表的结构
   + 使用在线变更表结构根据
        + MySQL5.5之前可以使用pt-online-schema-change(通过临时表)
        + MySQL5.6之后本身支持在线表结构的变更(ALTER语句)
   + 同时对数据字典进行维护
   + 控制表的宽度和大小
   
适合的操作：
   + 批量操作vs逐条操作
   + 禁止使用Select * 这样的查询
   + 控制使用用户自定义函数
   + 不要使用数据库中的全文索引

#### 在适当的时候进行表的水平和垂直拆分

表的垂直拆分
   >为了控制表的宽度，可以进行垂直拆分。提高每一页存储的行数。从而提高IO效率。

+ 经常一起查询的列放到一起
+ text、blob等大字段拆分到附加表中

表的水平拆分
   >为了控制表的大小(数据量)，可以进行表的水平拆分。把大表数据平均分到小表中。

方法：
+ 对主键进行hash取模,把大表数据平均分配到小表中。
