---
title: 用户系统密码安全
categories: server
date: 2018-05-27 13:46:30
tags:
  - password
  - crypto
---

最近闲着没事，看了几篇关于账户安全方面的文章。之前也听说过`CSDN`被脱裤事件。回过头翻开之前写的代码，看看自己设计的账户系统，确实包含了多处安全隐患。对于如何良好的保障用户密码安全，在这里做一个总结，方便日后查阅。

---

>开门见山，保障密码安全方式：哈希和加盐。

## 哈希

哈希算法是一种摘要算法，根据原始数据得出一个摘要信息，这种算法是不可逆的，即：正常情况下，通过摘要信息无法反向得出原始数据。

哈希算法通常分成两类：一、普通散列表使用的哈希算法，也称为快速哈希算法，如：MD5、SHA1、SHA256等。二、用于密码摘要的慢哈希函数`Slow Hash Function`，这种哈希算法主要为了降低常见密码攻击的效率而设计的。终极目标是使哈希函数的速度慢到足以令攻击者放弃，但由此造成的延迟又不至于引起用户的注意。如：Argon2、 bcrypt 、 scrypt 或 PBKDF2。

## 加盐

对原始密码加盐是一种有效的防止常见密码攻击的方式。关于加盐的具体工作原理，请参考[盐](https://zh.wikipedia.org/wiki/%E7%9B%90_(%E5%AF%86%E7%A0%81%E5%AD%A6))。需要注意的是，即使你知道要对密码加盐，还是有几个需要注意的点。

### 不要重复使用盐

使用重复的盐和不使用盐的效果几乎是一样的。使用重复的盐，攻击者一样可以轻松的构造出查找表，轻松攻破你的系统。

### 使用安全的盐

既然不能使用相同的盐，那么就需要给每个用户配置不同的盐，这个时候我们会想到随机函数，如：`crypto.getRandomBytes`、`Math.random`等函数。但是这些函数都不是安全可靠的。盐值应该使用加密的安全伪随机数生成器（ Cryptographically Secure Pseudo-Random Number Generator，CSPRNG ）产生。在`Node.js`环境下，可以选择的方案有：
+ [uuidv4](https://www.npmjs.com/package/uuid)

+ 专用的库
[csprng](https://www.npmjs.com/package/random-number-csprng)

既然我们了解了密码哈希函数和加盐的基本规则，让我们总结一下账户系统用户注册和登陆的流程：

+ 用户注册

1. 用户输入用户名密码发送到服务器
2. 服务器对用户密码加盐，哈希之后
3. 把哈希值同盐一起保存到数据库

+ 用户登陆

1. 从数据库取出用户对应的哈希和盐值
2. 把用户输入的密码加入数据库取出的盐计算哈希值
3. 对比第二步计算的哈希值和数据库取出的哈希值，如果相等则认为密码正确，反之认为密码错误。

---

下面了解几个常见的密码破解方式，这样对上面的几个保障密码安全的方式有更加深入的理解。

>常见的攻击方式：暴力破解、字典攻击、查找表等。

## 暴力破解

顾名思义就是用穷举的方式一一匹配看看密码是否正确。

## 字典攻击

字典攻击使用包含单词、短语、常用密码和其他可能用做密码的字符串的字典文件。对文件中的每个词都进行哈希加密，将这些哈希值和要破解的密码哈希值比较。如果它们相同，这个词就是密码。字典文件是通过大段文本中提取的单词构成，甚至还包括一些数据库中真实的密码。

## 查找表

对于破解相同类型的哈希值，查表法是一种非常高效的方式。主要理念是预先计算（ pre-compute）出密码字典中的每个密码的哈希值，然后把他们相应的密码存储到一个表里。一个设计良好的查询表结构，即使包含了数十亿个哈希值，仍然可以实现每秒钟查询数百次哈希。

---

>其他安全方面的考量

+ 1. 永远不要告诉用户输错的究竟是用户名还是密码
>就像通用的提示那样，始终显示：“无效的用户名或密码。”就行了。这样可以防止攻击者在不知道密码的情况下枚举出有效的用户名。

+ 2. 避免明文密码传输
>避免明文传输的方式一般有：一、非对称加密，客户端用公钥加密，服务器端用私钥解密。二、`HTTPS`，在目前的环境下上`HTTPS`或许是最便捷的方式了。

---

参考文献：

[1][如何正确对用户密码进行加密](http://www.infoq.com/cn/articles/how-to-encrypt-the-user-password-correctly)  
[2][Secure random values (in Node.js)](https://gist.github.com/joepie91/7105003c3b26e65efcea63f3db82dfba)