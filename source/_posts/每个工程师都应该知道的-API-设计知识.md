---
title: 每个工程师都应该知道的 API 设计知识
date: 2019-09-20 23:20:47
tags: [api, rest]
categories: web
---

REST 风格是现在使用最广泛的 API 设计规范。全称：Representational State Transfer（表现层状态转移）。

<!-- more -->


#### REST API

REST 核心包含以下几个基本概念：

**基本概念**

+ 资源（Resources）

> 它可以是：一个用户信息、一部电影等。可以用一个URI（统一资源定位符）指向它，每种资源对应一个特定的URI。

+ 表现层（Representation）

> 资源的呈现形式，HTML格式、XML格式、JSON格式表现等。

+ 状态转化（State Transfer）

> 如果客户端想要操作服务器，必须通过某种手段，让服务器端发生"状态转化"（State Transfer）。具体来说就是在 HTTP 协议下通过 `GET` 、`POST`、`DELET`、`PUT`等操作动词来操作资源。

**REST API 主要包含以下几个部分：**

##### 1、协议
> 推荐使用 `HTTPS` 的协议，`HTTPS` 相较于 `HTTP` 提供了更高的安全性，也因为现在在很多环境下有对 `HTTPS` 协议强制的要求：
+ 苹果的应用审核要求
>*苹果在 `iOS 9` 当中首次推出的一项安全功能，它会强制应用通过 HTTPS(而不是 HTTP)连接网络服务，通过 HTTPS 加密来保障用户数据安全*

+ 微信小程序对 API 接口的要求：

![mp-https]](/images/mp-https.jpg)


##### 2、域名
> API 可以使用专有域名，如：`https://api.example.com`。也可以跟随在主域名下通过路径的前缀来区分：`https://example.com/api`。`GitHub` 的 `API Host`：

![github-api-schema](/images/github-api-schema.jpg)


##### 3、版本
> 服务器对外的 API 应该受到版本的控制，通常版本号可以放在：`api host`、请求头、请求 `PATH` 里面。建议不要放到请求头部，因为这样不太直观。`Github API` 的做法是放到了 `PATH` 里面。

##### 4、路径
`endpoint`, 每个`endpoint`代表一种资源。一般来说往往使用和数据库表名的复数形式，如：

`https://example.com/api/v1/users`
`https://example.com/api/v1/employees`

##### HTTP 动词

`GET`/`POST`/`PUT`/`PATCH`/`DELETE`。在这里`PUT`表示全量更新、`PATCH`表示部分的更新。

`RESTFul` 风格的 `API` 是一种规范一种约定，在某些环境可能不能完全按照规范来实施。例如：

1、微信小程序底层的`http`请求没有支持 `PATCH` 这一 `HTTP` 动词，需要使用其他 `HTTP` 动词来规避这个问题。 

2、对于一些 API 比较难以对应到某一种资源，例如：登录类的接口等。

七牛 `portal` 的登录和登出接口：

![qiniu-signin](/images/qiniu-signin.jpg)

![qiniu-signout](/images/qiniu-signout.jpg)



如果脱离这种设计应该反思，一定要再三考虑是不是必要？有没有其他方案可以避免破坏 RESTful 风格。例如：登录接口的 `endpoint` 通常设计成：`/signin`或者 `/login`。但是换个角度，登录也是在请求某一种资源：`session`。完全可以把登录类的接口设计成是对`session`这一资源的操作。而 `Github` 就是这么设计的：`https://github.com/session`。

`Github` 的接口：

![github-signin](/images/github-signin.jpg)

---

#### API 的兼容性

API 系统框图：

![api-overview](/images/api-overview.jpg)


随着需求不断迭代，API 接口也在不断的演化。API 设计应该尽量兼容之前的版本。因为客户端通常包含了：Android、IOS、Web。客户端软件通常安装在用户机器上，当 服务器更新版本，API 接口升级的时候，用户必须升级产品到最新的版本才能正常使用。当然我们可以在老版本的客户端要求用户强制升级，但是这样会带来比较糟糕的用户体验。正确的做法是，服务器尽量兼容最新的 2-3 个版本的 API 接口。同时做好客户端版本用户数量的统计，当低版本的客户端使用量降低到一定程度的时候，服务器再考虑强制用户升级并且废弃老版本的 API 接口。


---

#### API 签名格式

一个上线使用的 API 再想改它的签名，会因为兼容性的问题痛苦不堪。因此，API 签名的设计初期，定要经过反复推敲，尽量避免上线后的改动。如果一个系统出现了多套的 API 签名格式，那么我们就不得不在 `API gateway`、或者客户端写很多冗余的代码来处理这个问题。因此 `API` 设计的时候，就应该做到用最简洁直观的格式去支持所有的需求。

---

#### 幂等性

幂等的定义：*一个操作如果多次任意执行所产生的副作用，均与一次执行的副作用相同。*
幂等机制的核心是为了保证资源唯一性，客户端重复提交或服务端的多次重试只会产生同样的副作用。在一些客户端网络环境比较差或者服务器拥堵的情况下调用方可能会重试接口。

举个例子：
当一笔订单开始支付，在支付请求发出之后，在服务端发生了扣钱操作，接口响应超时了，调用方重试了一次。是否会多扣一次钱？


**幂等实现的步骤**

+ 生成幂等 `Token`

客户端和服务器端通过这个 `Token` 来识别，这实际上是同一个请求还是同一请求的多次尝试。这种在同一个请求上具备唯一标识的元素，可以由客户端生成，也可以由服务器生成。常见的有使用`UUID` ，或者`Snowflake`算法等。

+ 确保唯一性

服务器如何通过 Token 确保唯一性? 最常用的做法是利用数据库。比如把幂等 Token 所在的数据库表的列作为唯一索引。但是对于分布式（分库分表）环境下就不能用唯一索引了。我们可以先查询一次数据库，然后判断是否约束的资源字段存在重复，没有的重复时再进行插入操作。考虑并发的场景我们还需要使用分布式锁。

+ HTTP 的幂等性

`GET`、获取数据，不会产生副作用，所以是幂等的。
`HEAD`、不应用有副作用，也是幂等的
`OPTIONS` 主要用于获取当前 URL 所支持的方法，所以也是幂等的
`DELETE`、调用一次和 N 次对系统产生的副作用是相同的。
`POST`、多次调用会创建多个资源，**不满足幂等性**。
`PUT/PATCH`、同一个资源更新一次和多次产生的副作用是一样的，满足幂等性

**幂等漏洞**
>完全的幂等操作比较难以实现，在一个`API`的请求链路上通常涉及多个服务，其中任意一个服务不满足幂等性就会出现幂等漏洞。

---

#### 安全性

+ 身份验证
> 标示用户的身份：`Session/Cookie`、`JWT`。

+ 接口签名
> 接口签名防止参数被恶意篡改，可以对请求参数进行排序拼接成一个字符串，然后对字符串进行加密。得到一个 `sign` 参数，传递给服务器，服务器拿到客户端请求 `sign` 参数进行解密，然后跟客户端传递的参数进行对比。判定参数的合法性。

+ 重放攻击
> 接口签名用于防止参数被恶意篡改。但是不能阻止你的请求被原封不动地再发送一次，两次...n次。使用`timestamp`和`nonce`来做的防止重放机制。具体做法是：客户端请求服务器的时候会带上时间戳和随机字符串两个参数，服务器和客户端校准时间，服务器对于收到时间戳误差大于`60s`的请求之间拒绝。同时服务器缓存`nonce`在`60s`内，如果期间收到了同样的`nonce`则直接拒绝服务。

+ 权限控制
> 对特定的用户永远只暴露相关的接口和权限。常用的方式如：基于角色的权限访问控制（Role-Based Access Control）。主要包含三个方面：
1、用户与角色的指派；
2、角色与权限的指派；
3、权限控制项的管理；

![rbac.jpg](/images/rbac.jpg)

+ API 层的日志（ Logging ），要保证不记录任何敏感信息
> 例如说：登录的接口把账号密码写到url上，写入了日志。

